Owner s module sparse copy itertools math torch torch nn torch ao pruning _experimental data_sparsifier BaseDataSparsifier DataNormSparsifier torch ao pruning _experimental data_sparsifier quantization_utils post_training_sparse_quantize torch nn utils parametrize is_parametrized torch testing _internal common_utils raise_on_run_directly TestCase ImplementedSparsifier BaseDataSparsifier __init__ kwargs super __init__ kwargs update_mask name data kwargs mask = get_mask name mask = linear_state = state name linear_state step_count = linear_state get step_count + _BaseDataSparsiferTestCase TestCase r This helper test takes any supported type runs some tests The user required pass data needs sparsified runner will run some tests needs passed order data type supported TODO Change structure creating separate test case each member function run_all_checks data_list data_with_config defaults check_constructor data_list data_with_config defaults check_squash_mask data_list data_with_config defaults check_add_data data_list data_with_config defaults check_step data_list data_with_config defaults check_state_dict data_list data_with_config defaults check_memory_reference data_list data_with_config defaults staticmethod _get_name_data_config some_data defaults=None isinstance some_data tuple dealing data_list name data = some_data config = defaults dealing data_with_config name data config = some_data name some_data data some_data config name data config staticmethod _make_sparsifier data_list data_with_config defaults sparsifier_type=None sparsifier_kwargs=None sparsifier_type None sparsifier = ImplementedSparsifier data_list=data_list defaults kwargs = copy deepcopy defaults kwargs update sparsifier_kwargs kwargs data_list = data_list sparsifier = sparsifier_type kwargs assert len sparsifier data_groups == len data_list data_config_dict data_with_config name data config = data_config_dict name data_config_dict data data_config_dict config sparsifier add_data name=name data=data config sparsifier check_constructor data_list data_with_config defaults kwargs sparsifier = _make_sparsifier data_list data_with_config defaults=defaults kwargs assertEqual len sparsifier data_groups len data_list + len data_with_config msg= Sparsifier data groups don t match input f len sparsifier data_groups vs f len data_list + len data_with_config all_data = data_list + data_with_config some_data all_data name _ config = _get_name_data_config some_data defaults=defaults assertIn name sparsifier data_groups assertEqual sparsifier data_groups name config check_step data_list data_with_config defaults kwargs sparsifier = _make_sparsifier data_list data_with_config defaults=defaults kwargs all_data = data_list + data_with_config Check data mask before doing step some_data all_data name data _ = _get_name_data_config some_data data = sparsifier _extract_weight data sparsified_data = sparsifier get_data name=name return_original=False original_data = sparsifier get_data name=name return_original=True mask = sparsifier get_mask name=name assertEqual sparsified_data data assertEqual original_data data assertEqualBroadcasting mask step_count = _ range step_count sparsifier step some_data all_data name data _ = _get_name_data_config some_data data = sparsifier _extract_weight data sparsified_data = sparsifier get_data name=name return_original=False original_data = sparsifier get_data name=name return_original=True mask = sparsifier get_mask name=name assertEqualBroadcasting sparsified_data assertEqual original_data data assertEqualBroadcasting mask assert step_count sparsifier state name assert sparsifier state name step_count == check_squash_mask data_list data_with_config defaults kwargs sparsifier = _make_sparsifier data_list data_with_config defaults=defaults kwargs all_data = data_list + data_with_config some_data all_data name _ _ = _get_name_data_config some_data assert hasattr sparsifier _container name assert is_parametrized sparsifier _container name sparsifier step sparsifier squash_mask some_data all_data name _ _ = _get_name_data_config some_data assert is_parametrized sparsifier _container name parametrized anymore assertRaises ValueError sparsifier get_data name return_original=True check_add_data data_list data_with_config defaults kwargs sparsifier = _make_sparsifier data_list data_with_config defaults=defaults kwargs all_data = data_list + data_with_config some_data all_data name data config = _get_name_data_config some_data defaults=defaults data = sparsifier _extract_weight data data _old = copy deepcopy data assert torch all data == sparsifier get_data name=name sparsifier step mask = sparsifier get_mask name data = torch randn data shape add another data same shape original data sparsifier add_data name=name data=data assert torch all data == sparsifier get_data name=name assert torch all sparsifier get_mask name == mask mask should change assert torch all data _old == data assert sparsifier data_groups name == config replaced old_config should match new config check_state_dict data_list data_with_config defaults kwargs sparsifier = _make_sparsifier data_list data_with_config defaults=defaults kwargs sparsifier = _make_sparsifier data_list= data_list data_with_config= defaults=defaults kwargs sparsifier step state_dict = sparsifier state_dict assert sparsifier state = sparsifier state name _ _ = _get_name_data_config data_list assertNotEqual sparsifier get_mask name sparsifier get_mask name sparsifier load_state_dict state_dict assert len sparsifier state == len sparsifier state assert len sparsifier data_groups == len sparsifier data_groups state = state_dict state name state keys compare mask assert name sparsifier state assert mask sparsifier state name assert mask sparsifier state name mask mask = state name mask sparsifier state name mask assert mask is_sparse mask is_sparse assert torch all mask to_dense == mask mask stored sparse coo now compare data_groups dg dg = sparsifier data_groups sparsifier data_groups assert name dg name dg assert dg name == dg name compare container container container = sparsifier _container sparsifier _container assert torch all getattr container name == getattr container name assert is_parametrized container name == is_parametrized container name is_parametrized container name param = getattr container parametrizations name param = getattr container parametrizations name assert hasattr param mask assert hasattr param mask assertEqual param __dict__ param __dict__ check_memory_reference data_list data_with_config defaults kwargs Checks data truly attached sparsifier Meaning when data changed outside sparsifier changes must reflected data inside data sparsifier well This makes sure sparsifier holding memory reference data copies This test modifies data asserts data sparsifier changed well sparsifier = _make_sparsifier data_list data_with_config defaults=defaults kwargs all_data = data_list + data_with_config some_data all_data name data _ = _get_name_data_config some_data weight = sparsifier _extract_weight data weight data = weight + torch randn weight shape contained_data = sparsifier get_data name=name assert weight data storage data_ptr == contained_data data storage data_ptr assert torch all contained_data == weight _NormDataSparsifierTestCase _BaseDataSparsiferTestCase r This helper test takes any supported type runs some tests This inherits TestBaseDataSparsifierRuner wherein some functions over-ridden take accommodate specific sparsifier TODO Change structure creating separate test case each member function run_all_checks data_list defaults data_with_config norm_type= L assert norm_type L L kwargs = sparsifier_type DataNormSparsifier sparsifier_kwargs norm norm_type check_constructor data_list data_with_config defaults kwargs check_squash_mask data_list data_with_config defaults kwargs check_add_data data_list data_with_config defaults kwargs check_state_dict data_list data_with_config defaults kwargs check_step data_list data_with_config defaults norm_type=norm_type check_step_ _of_ norm_type=norm_type check_sparsity_level data_list data_with_config defaults norm_type=norm_type check_memory_reference data_list data_with_config defaults kwargs staticmethod _get_bounds_on_actual_sparsity config tensor_shape r This function gets bounds actual sparsity Note Although we specify sparsity_level parameter does mean actual sparsity obtained after sparsification same sparsity_level The actual sparsity depends largely shape data itself sparsity_level = config sparsity_level zeros_per_block = config zeros_per_block sparse_block_shape = config sparse_block_shape height width = tensor_shape - tensor_shape - block_height block_width = sparse_block_shape number_blocks = math ceil height block_height math ceil width block_width values_per_block = block_height block_width zeros_per_block == min value assumes zeros_per_block min_values_sparsified = round number_blocks sparsity_level max value assumes actual zeros_per_block max_values_sparsified = min_values_sparsified min values_per_block zeros_per_block lower_bound = min_values_sparsified height width upper_bound = min max_values_sparsified height width lower_bound upper_bound = round lower_bound round upper_bound lower_bound upper_bound check_step data_list data_with_config defaults norm_type= L sparsifier = _make_sparsifier data_list data_with_config defaults sparsifier_type=DataNormSparsifier sparsifier_kwargs= norm norm_type all_data = data_list + data_with_config mask before step should sparsified some_data all_data name _ _ = _get_name_data_config some_data mask = sparsifier get_mask name=name assert - mask mean == checking sparsity level sparsifier step some_data all_data name _ _ = _get_name_data_config some_data mask = sparsifier get_mask name=name config = sparsifier data_groups name lb ub = _get_bounds_on_actual_sparsity config mask shape mask = mask torch float actual_sparsity = round - mask mean item assert actual_sparsity = lb actual_sparsity = ub assert actual_sparsity exact sparsity level cannot achieved due size tensor iters_before_collapse = test_sparsifier = DataNormSparsifier sparsity_level= sparse_block_shape= zeros_per_block= norm=norm_type _ range iters_before_collapse new_data = torch randn test_sparsifier add_data name= test_data data=new_data test_sparsifier step mask = test_sparsifier get_mask name= test_data mask = mask torch float assert - mask mean item some sparsity achieved check_step_ _of_ norm_type overriding default config test purposes default_config = sparsity_level zeros_per_block sparse_block_shape data_list = test_data torch randn sparsifier = DataNormSparsifier data_list=data_list norm=norm_type default_config sparsifier step some_data data_list name _ = some_data mask = sparsifier get_mask name=name mask = mask torch float assertAlmostEqual - mask mean item places= row mask idx range len row block = row idx idx + block _ = block sort assert block == all assert block = all check_sparsity_level data_list data_with_config defaults norm_type= L sparsity_levels = - sparse_block_shapes = zeros_per_blocks = sparsifier = DataNormSparsifier data_list=data_list norm=norm_type testcases = itertools tee itertools product sparsity_levels sparse_block_shapes zeros_per_blocks assert len data_with_config name data_with_config data data_with_config get some data name data = data_with_config name data_with_config data idx sl sbs zpb enumerate testcases new_name = f name _ idx zpb sbs sbs continue current_config = sparsity_level sl sparse_block_shape sbs zeros_per_block zpb sparsifier add_data name=new_name data=data current_config zpb sbs sbs continue sparsifier step sparsifier squash_mask idx sl sbs zpb enumerate testcases new_name = f name _ idx sparsified_data = sparsifier get_data name=new_name original=False sparse mask sparse_mask = sparsified_data == float zpb == assert sparse_mask mean == Ratio individual zeros tensor true_sl = min max sl true_sl = true_sl zpb sbs sbs assert sparse_mask mean == true_sl TestBaseDataSparsifier _BaseDataSparsiferTestCase To add unit tests support new data types BaseDataSparsifier create following data_list List tuples name data added constructor defaults default config above data data_list data_with_config list dictionaries defining name data config look test_tensors Once above done create instance TestBaseDataSparsifierType call all run_tests test_tensors tensor tensor tensor = torch randn torch randn torch randn tensor tensor = torch randn torch randn data_list = tensor tensor tensor tensor tensor tensor defaults = test data_with_config = name tensor data tensor config test name tensor data tensor config test run_all_checks data_list=data_list defaults=defaults data_with_config=data_with_config test_nn_parameters param param param = nn Parameter torch randn nn Parameter torch randn nn Parameter torch randn param param = nn Parameter torch randn nn Parameter torch randn data_list = param param param param param param defaults = test data_with_config = name param data param config test name param data param config test run_all_checks data_list=data_list defaults=defaults data_with_config=data_with_config test_nn_embeddings emb emb = nn Embedding nn Embedding emb _bag emb _bag = nn EmbeddingBag nn EmbeddingBag emb emb _bag = nn Embedding nn EmbeddingBag data_list = emb emb emb _bag emb _bag emb emb emb _bag emb _bag defaults = test data_with_config = name emb data emb config test name emb _bag data emb _bag config test run_all_checks data_list=data_list defaults=defaults data_with_config=data_with_config TestNormDataSparsifiers _NormDataSparsifierTestCase To add unit tests support new data types NormDataSparsifier create following data_list List tuples name data added constructor defaults default config above data data_list data_with_config list dictionaries defining name data config look test_tensors Once above done create instance _NormDataSparsifierTestRunner call run_tests test_tensors tensor tensor tensor = torch randn torch randn torch randn tensor tensor = torch randn torch randn data_list = tensor tensor tensor tensor tensor tensor defaults = sparsity_level sparse_block_shape zeros_per_block data_with_config = name tensor data tensor config sparsity_level sparse_block_shape zeros_per_block name tensor data tensor config sparsity_level sparse_block_shape zeros_per_block run_all_checks data_list=data_list defaults=defaults data_with_config=data_with_config norm_type= L run_all_checks data_list=data_list defaults=defaults data_with_config=data_with_config norm_type= L test_nn_parameters param param param = nn Parameter torch randn nn Parameter torch randn nn Parameter torch randn param param = nn Parameter torch randn nn Parameter torch randn data_list = param param param param param param defaults = sparsity_level sparse_block_shape zeros_per_block data_with_config = name param data param config sparsity_level sparse_block_shape zeros_per_block name param data param config sparsity_level sparse_block_shape zeros_per_block run_all_checks data_list=data_list defaults=defaults data_with_config=data_with_config norm_type= L run_all_checks data_list=data_list defaults=defaults data_with_config=data_with_config norm_type= L test_nn_embeddings emb emb = nn Embedding nn Embedding emb _bag emb _bag = nn EmbeddingBag nn EmbeddingBag emb emb _bag = nn Embedding nn EmbeddingBag data_list = emb emb emb _bag emb _bag emb emb emb _bag emb _bag defaults = sparsity_level sparse_block_shape zeros_per_block data_with_config = name emb data emb config sparsity_level sparse_block_shape zeros_per_block name emb _bag data emb _bag config sparsity_level sparse_block_shape zeros_per_block run_all_checks data_list=data_list defaults=defaults data_with_config=data_with_config norm_type= L run_all_checks data_list=data_list defaults=defaults data_with_config=data_with_config norm_type= L Model nn Module __init__ - None super __init__ emb = nn Embedding embbag = nn EmbeddingBag emb_seq = nn Sequential nn Embedding nn EmbeddingBag linear = nn Linear linear = nn Linear TestQuantizationUtils TestCase test_ptq_sparsify_first The expectation post_training_sparse_quantize function Takes model Sparsifies embeddings Quantize embeddings This unit test checks Embeddings EmbeddingBags sparsified right sparsity levels Embeddings EmbeddingBags quantized Linear modules quantized model = Model sparse_config = sparsity_level sparse_block_shape select_embeddings = model embbag model emb post_training_sparse_quantize model data_sparsifier_class=DataNormSparsifier sparsify_first=True select_embeddings=select_embeddings sparse_config assert type model emb torch ao nn quantized modules embedding_ops Embedding assert type model embbag torch ao nn quantized modules embedding_ops EmbeddingBag assert type model emb_seq nn Embedding assert type model emb_seq nn EmbeddingBag assert type model linear nn Linear assert type model linear nn Linear dequant_emb = torch dequantize model emb weight dequant_embbag = torch dequantize model embbag weight threshold = e- sl_emb = torch abs dequant_emb threshold float mean sl_embbag = torch abs dequant_embbag threshold float mean assert abs sl_emb - = +- leeway assert abs sl_embbag - = +- leeway test_ptq_quantize_first The expectation post_training_sparse_quantize function Takes model Quantize embeddings Sparsifies embeddings This unit test checks Embeddings EmbeddingBags sparsified right sparsity levels Embeddings EmbeddingBags quantized Linear modules quantized model = Model sparse_config = sparsity_level sparse_block_shape post_training_sparse_quantize model DataNormSparsifier sparsify_first=False sparse_config assert type model emb torch ao nn quantized modules embedding_ops Embedding assert type model embbag torch ao nn quantized modules embedding_ops EmbeddingBag assert type model emb_seq torch ao nn quantized modules embedding_ops Embedding assert type model emb_seq torch ao nn quantized modules embedding_ops EmbeddingBag assert type model linear nn Linear quantized assert type model linear nn Linear quantized dequant_emb = torch dequantize model emb weight dequant_embbag = torch dequantize model embbag weight dequant_emb_seq_ = torch dequantize model emb_seq weight dequant_emb_seq_ = torch dequantize model emb_seq weight higher threshold quantization occurs before sparsity threshold = zero points seem have higher magnitude sparsity occurring after sl_emb = torch abs dequant_emb threshold float mean sl_embbag = torch abs dequant_embbag threshold float mean sl_emb_seq_ = torch abs dequant_emb_seq_ threshold float mean sl_emb_seq_ = torch abs dequant_emb_seq_ threshold float mean assert abs sl_emb - = +- leeway assert abs sl_embbag - = +- leeway assert abs sl_emb_seq_ - = +- leeway assert abs sl_emb_seq_ - = +- leeway __name__ == __main__ raise_on_run_directly test test_ao_sparsity py
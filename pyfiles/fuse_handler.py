mypy allow-untyped-defs abc ABC abstractmethod collections abc Callable typing Any Union torch torch ao quantization backend_config BackendConfig torch ao quantization fuser_method_mappings get_fuser_method_new torch ao quantization utils _parent_name NodePattern Pattern torch fx graph Graph Node torch nn utils parametrize type_before_parametrizations custom_config FuseCustomConfig match_utils MatchAllNode __all__ = DefaultFuseHandler FuseHandler ---------------------------- Fusion Pattern Registrations ---------------------------- Base Pattern Handler FuseHandler ABC Base handler fusion patterns abstractmethod __init__ node Node pass abstractmethod fuse load_arg Callable named_modules dict str torch nn Module fused_graph Graph root_node Node extra_inputs list Any matched_node_pattern NodePattern fuse_custom_config FuseCustomConfig fuser_method_mapping dict Pattern Union torch nn Sequential Callable is_qat bool - Node pass DefaultFuseHandler FuseHandler __init__ node Node super __init__ node type ignore safe-super fuse load_arg Callable named_modules dict str torch nn Module fused_graph Graph root_node Node extra_inputs list Any matched_node_pattern NodePattern fuse_custom_config FuseCustomConfig fuser_method_mapping dict Pattern Union torch nn Sequential Callable is_qat bool - Node root_node op = call_module raise AssertionError Expecting module node call_module Node root_module = named_modules str root_node target get_modules pattern Given node pattern extract corresponding modules e g input relu_node bn_node conv_node output relu_module bn_module conv_module isinstance pattern tuple list n args = pattern modules list torch nn Module = modules append get_modules n modules extend get_modules args tuple modules n = pattern n op == call_module named_modules n target n op == call_function n target torch nn functional relu relu = torch nn ReLU relu training = root_module training relu n op == call_function n op == call_method n target MatchAllNode since relu can used multiple times we ll need create relu module each match matched_modules = get_modules matched_node_pattern get_matched_types m isinstance m tuple tuple map get_matched_types m isinstance m torch nn Module type_before_parametrizations m m matched_module_types = get_matched_types matched_modules module_parent_name module_name = _parent_name root_node target fuser_method = get_fuser_method_new matched_module_types fuser_method_mapping TODO change signature fuser_method take matched module patterns input fused_module = fuser_method is_qat matched_modules setattr named_modules module_parent_name module_name fused_module extra_args = load_arg input input extra_inputs node = fused_graph node_copy root_node load_arg args = list node args args extend extra_args node args = tuple args node _get_fusion_pattern_to_fuse_handler_cls backend_config BackendConfig - dict Pattern Callable fusion_pattern_to_fuse_handlers dict Pattern Callable = pattern config backend_config _pattern_complex_format_to_config items config fuser_method None TODO logic right fusion_pattern_to_fuse_handlers pattern = DefaultFuseHandler fusion_pattern_to_fuse_handlers
Owner s module inductor os platform tempfile unittest dataclasses dataclass pathlib Path typing Any Optional torch torch _inductor config torch _environment is_fbcode torch _inductor test_case TestCase torch testing _internal inductor_utils GPU_TYPE HAS_GPU requires_gpu dataclass ModelTestConfig Configuration model test case name str model_class type example_inputs tuple torch Tensor dynamic_shapes Optional dict str Any = None inductor_configs Optional dict str Any = None rtol float = e- atol float = e- WindowsCrossCompilationTestFramework Framework testing cross-compilation Linux Windows Provides reusable logic creating compile load test methods _base_path Optional Path = None _win_torch_libs_path Optional str = None classmethod base_path cls - Path Get create base path package files cls _base_path None cls _base_path = Path tempfile mkdtemp prefix= aoti_cross_compile_ cls _base_path classmethod set_base_path cls path Optional Path &#124; str = None - None Set base path package files cls _base_path = Path path path None classmethod set_win_torch_libs_path cls path Optional str = None - None Set path Windows torch libs cls _win_torch_libs_path = path classmethod get_package_path cls model_name str - str Get path model s pt package file package_dir = cls base_path package_dir mkdir parents=True exist_ok=True str package_dir f model_name _windows pt classmethod get_win_torch_libs_path cls - str Get path Windows torch libs cls _win_torch_libs_path None raise RuntimeError Windows torch libs path set str cls _win_torch_libs_path classmethod create_compile_test cls config ModelTestConfig Create compile test method model configuration compile_test platform system == Windows raise unittest SkipTest This test should run Linux cross-compilation is_fbcode raise unittest SkipTest requires x _ -w -mingw -gcc assertTrue WINDOWS_CUDA_HOME os environ torch no_grad Windows cross-compilation only used GPU AOTI CPU should able work native compilation Windows device = GPU_TYPE model = config model_class device=device example_inputs = config example_inputs Inputs should already GPU_TYPE ensure they example_inputs = tuple inp device inp example_inputs Export model exported = torch export export model example_inputs dynamic_shapes=config dynamic_shapes Prepare inductor configs inductor_configs = aot_inductor cross_target_platform windows aot_inductor precompile_headers False aot_inductor package_constants_on_disk_format binary_blob aot_inductor package_constants_in_so False aot_inductor aoti_shim_library_path cls get_win_torch_libs_path config inductor_configs inductor_configs update config inductor_configs Compile package directly expected location package_path = cls get_package_path config name torch _inductor aoti_compile_and_package exported package_path=package_path inductor_configs=inductor_configs assertTrue os path exists package_path f Package file should exist package_path compile_test classmethod create_load_test cls config ModelTestConfig Create load test method model configuration load_test platform system = Windows raise unittest SkipTest This test should run Windows is_fbcode raise unittest SkipTest requires x _ -w -mingw -gcc HAS_GPU raise unittest SkipTest Test requires GPU package_path = cls get_package_path config name os path exists package_path raise unittest SkipTest f Package file found package_path f Run test_ config name _compile first torch no_grad Windows cross-compilation only used GPU AOTI CPU should able work native compilation Windows device = GPU_TYPE Create original model comparison original_model = config model_class device=device example_inputs = config example_inputs Inputs should already GPU_TYPE ensure they example_inputs = tuple inp device inp example_inputs Load compiled package loaded_model = torch _inductor aoti_load_package package_path Test same inputs original_output = original_model example_inputs loaded_output = loaded_model example_inputs Compare outputs torch testing assert_close original_output loaded_output rtol=config rtol atol=config atol load_test auto_generate_tests test_class Class decorator automatically generate compile load test methods _define_ methods ModelTestConfig Find all _define_ methods ModelTestConfig define_methods = name dir test_class name startswith _define_ callable getattr test_class name method = getattr test_class name Try call method see returns ModelTestConfig try Create temporary instance call method temp_instance = test_class __new__ test_class result = method temp_instance isinstance result ModelTestConfig define_methods name = result except Exception If method fails skip pass Generate compile load methods each discovered definition define_name config define_methods items model_name = define_name Remove _define_ prefix Create compile test method compile_method_name = f test_ model_name _compile compile_method = WindowsCrossCompilationTestFramework create_compile_test config compile_method __name__ = compile_method_name compile_method __doc__ = f Step Cross-compile model_name model Linux compile_method = requires_gpu compile_method setattr test_class compile_method_name compile_method Create load test method load_method_name = f test_ model_name _load load_method = WindowsCrossCompilationTestFramework create_load_test config load_method __name__ = load_method_name load_method __doc__ = f Step Load test model_name model Windows load_method = requires_gpu load_method setattr test_class load_method_name load_method test_class auto_generate_tests TestAOTInductorWindowsCrossCompilation TestCase Test AOT Inductor Windows cross-compilation Define test methods ModelTestConfig decorator will auto-generate compile load test methods _define_simple Define Simple model its test configuration Simple torch nn Module __init__ super __init__ fc = torch nn Linear relu = torch nn ReLU fc = torch nn Linear sigmoid = torch nn Sigmoid forward x x = fc x x = relu x x = fc x x = sigmoid x x ModelTestConfig name= simple model_class=Simple example_inputs= torch randn device=GPU_TYPE dynamic_shapes= x torch export Dim batch min= max= _define_simple_cnn Define SimpleCNN model its test configuration SimpleCNN torch nn Module __init__ super __init__ conv = torch nn Conv d relu = torch nn ReLU pool = torch nn AdaptiveAvgPool d fc = torch nn Linear forward x x = conv x x = relu x x = pool x x = x flatten x = fc x x ModelTestConfig name= simple_cnn model_class=SimpleCNN example_inputs= torch randn device=GPU_TYPE dynamic_shapes= x torch export Dim batch min= max= rtol= e- atol= e- _define_transformer Define SimpleTransformer model its test configuration SimpleTransformer torch nn Module __init__ super __init__ embedding = torch nn Linear attention = torch nn MultiheadAttention batch_first=True norm = torch nn LayerNorm ffn = torch nn Sequential torch nn Linear torch nn ReLU torch nn Linear norm = torch nn LayerNorm output = torch nn Linear forward x x shape batch seq_len input_dim x = embedding x attn_out _ = attention x x x x = norm x + attn_out ffn_out = ffn x x = norm x + ffn_out x = x mean dim= Global average pooling x = output x x ModelTestConfig name= transformer model_class=SimpleTransformer example_inputs= torch randn device=GPU_TYPE dynamic_shapes= x torch export Dim batch min= max= rtol= e- atol= e- __name__ == __main__ sys torch _inductor test_case run_tests Check -- package-dir argument remove before unittest sees package_dir = None win_torch_lib_dir = None filtered_argv = i = while i len sys argv sys argv i == -- package-dir i + len sys argv package_dir = sys argv i + i += Skip both -- package-dir its value print Error -- package-dir requires valid directory path sys exit sys argv i startswith -- package-dir= package_dir = sys argv i split = i += sys argv i == -- win-torch-lib-dir i + len sys argv win_torch_lib_dir = sys argv i + i += Skip both -- win-torch-lib-dir its value print Error -- win-torch-lib-dir requires valid directory path sys exit sys argv i startswith -- win-torch-lib-dir= win_torch_lib_dir = sys argv i split = i += filtered_argv append sys argv i i += Validate set base path package storage package_dir try package_path = Path package_dir package_path mkdir parents=True exist_ok=True Test write access test_file = package_path test_write test_file touch test_file unlink WindowsCrossCompilationTestFramework set_base_path package_path except Exception print Error -- package-dir requires valid directory path sys exit Set Windows torch libs path provided only needed compile tests win_torch_lib_dir WindowsCrossCompilationTestFramework set_win_torch_libs_path win_torch_lib_dir Update sys argv remove our custom arguments sys argv = filtered_argv HAS_GPU run_tests needs= filelock
Owner s oncall distributed os unittest mock patch torch torch distributed checkpoint dcp torch nn nn torch distributed device_mesh init_device_mesh torch distributed fsdp FullyShardedDataParallel FSDP torch testing _internal common_utils run_tests torch testing _internal distributed _tensor common_dtensor DTensorTestBase skip_if_lt_x_gpu with_comms torch testing _internal distributed checkpoint_utils with_temp_dir MyTestModule nn Module __init__ - None super __init__ net = nn Sequential nn Linear nn ReLU net = nn Sequential nn Linear nn ReLU net = nn Linear net = nn Sequential nn ReLU nn Linear forward x net net net net x TestSaveAndLoadAPI DTensorTestBase property world_size - int with_comms skip_if_lt_x_gpu with_temp_dir test_auto_detect model = FSDP MyTestModule device_type device_mesh = init_device_mesh device_type world_size model = FSDP model device_mesh=device_mesh dcp save model state_dict checkpoint_id=os path join temp_dir first dcp load model state_dict checkpoint_id=os path join temp_dir first patch object dcp FileSystemReader validate_checkpoint_id return_value=False patch object dcp FileSystemWriter validate_checkpoint_id return_value=False dcp save model state_dict checkpoint_id=os path join temp_dir second dcp load model state_dict checkpoint_id=os path join temp_dir second assertRaisesRegex RuntimeError Cannot detect dcp save model state_dict checkpoint_id= abc abc abc assertRaisesRegex RuntimeError Cannot detect dcp load model state_dict checkpoint_id= abc abc abc with_comms skip_if_lt_x_gpu test_assert_same_keys Test ` _assert_same_keys ` function model = MyTestModule state_dict = model state_dict Check across ranks expect true dcp utils _assert_same_keys state_dict Introduces difference expect false rank == state_dict abc = torch rand state_dict = torch rand assertRaises AssertionError dcp utils _assert_same_keys state_dict __name__ == __main__ run_tests
Manages CMake __future__ annotations functools json multiprocessing os platform shutil sys sysconfig pathlib Path subprocess CalledProcessError check_call check_output DEVNULL typing cast cmake_utils CMakeValue get_cmake_cache_variables_from_file env BUILD_DIR check_negative_env_flag CMAKE_MINIMUM_VERSION_STRING IS_ BIT IS_DARWIN IS_WINDOWS try packaging version Version except ImportError try setuptools dist Version type ignore attr-defined no-redef except ImportError distutils version type ignore assignment no-redef LooseVersion Version _mkdir_p d str - None try os makedirs d exist_ok=True except OSError e raise RuntimeError f Failed create folder os path abspath d e strerror e Print stderr eprint = functools partial print file=sys stderr flush=True Ninja Use ninja PATH Previous version PyTorch required ninja python package we no longer use so we do have USE_NINJA = bool check_negative_env_flag USE_NINJA shutil which ninja CMAKE_GENERATOR os environ USE_NINJA = os environ CMAKE_GENERATOR lower == ninja CMAKE_MINIMUM_VERSION = Version CMAKE_MINIMUM_VERSION_STRING CMake Manages cmake __init__ build_dir str = BUILD_DIR - None _cmake_command = CMake _get_cmake_command build_dir = build_dir property _cmake_cache_file - str r Returns path CMakeCache txt Returns string The path CMakeCache txt os path join build_dir CMakeCache txt property _ninja_build_file - str r Returns path build ninja Returns string The path build ninja os path join build_dir build ninja staticmethod _get_cmake_command - str Returns cmake command IS_WINDOWS cmake cmake_versions list str = valid_cmake_versions dict str Version = cmd cmake cmake command = shutil which cmd ver = CMake _get_version command ver None eprint f Found cmd command version ver end= cmake_versions append f cmd == ver pyrefly ignore unsupported-operation ver = CMAKE_MINIMUM_VERSION eprint f = CMAKE_MINIMUM_VERSION valid_cmake_versions cmd = ver eprint f CMAKE_MINIMUM_VERSION valid_cmake_versions raise RuntimeError f no cmake cmake version = CMAKE_MINIMUM_VERSION f found cmake_versions max valid_cmake_versions key=valid_cmake_versions get type ignore arg-type staticmethod _get_version cmd str &#124; None - Version &#124; None Returns cmake version cmd None None try cmake_capabilities = json loads check_output cmd -E capabilities stderr=DEVNULL text=True except OSError CalledProcessError json JSONDecodeError cmake_capabilities = cmake_version = cmake_capabilities get version get string cmake_version None Version cmake_version raise RuntimeError f Failed get CMake version command cmd run args list str env dict str str - None Executes cmake arguments environment command = _cmake_command + args eprint join command try check_call command cwd=self build_dir env=env except CalledProcessError KeyboardInterrupt This error indicates there problem cmake Python backtrace adds no signal here so skip over catching error exiting manually sys exit staticmethod defines args list str kwargs CMakeValue - None Adds definitions cmake argument list key value sorted kwargs items value None args append f -D key = value get_cmake_cache_variables - dict str CMakeValue r Gets values CMakeCache txt into dictionary Returns dict A ` ` dict ` ` containing value cached CMake variables open _cmake_cache_file f get_cmake_cache_variables_from_file f generate version str &#124; None cmake_python_library str &#124; None build_python bool build_test bool my_env dict str str rerun bool - None Runs cmake generate native build files rerun os path isfile _cmake_cache_file os remove _cmake_cache_file cmake_cache_file_available = os path exists _cmake_cache_file cmake_cache_file_available cmake_cache_variables = get_cmake_cache_variables make_program str &#124; None = cmake_cache_variables get CMAKE_MAKE_PROGRAM type ignore assignment make_program shutil which make_program CMakeCache txt exists make program e g ninja does See also https github com astral-sh uv issues This can happen building PEP- build isolation where ` ninja ` installed isolated environment previous build run has been removed The ` ninja ` executable old absolute path available anymore eprint WARNING CMakeCache txt exists f CMAKE_MAKE_PROGRAM make_program r does exist Clearing CMake cache clear_cache cmake_cache_file_available = False cmake_cache_file_available USE_NINJA os path exists _ninja_build_file Everything s place Do rerun args = USE_NINJA Avoid conflicts -G ` CMAKE_GENERATOR ` os environ CMAKE_GENERATOR = Ninja args append -GNinja IS_WINDOWS generator = os getenv CMAKE_GENERATOR Visual Studio supported = Visual Studio Visual Studio generator supported eprint Unsupported ` CMAKE_GENERATOR ` + generator eprint Please set one following values eprint \n join supported sys exit args append -G + generator toolset_dict = toolset_version = os getenv CMAKE_GENERATOR_TOOLSET_VERSION toolset_version None toolset_dict version = toolset_version curr_toolset = os getenv VCToolsVersion curr_toolset None eprint When you specify ` CMAKE_GENERATOR_TOOLSET_VERSION ` you must also activate vs environment version Please read notes build steps carefully sys exit IS_ BIT platform machine == ARM args append -A ARM args append -Ax toolset_dict host = x toolset_dict toolset_expr = join f k = v k v toolset_dict items args append -T + toolset_expr base_dir = str Path __file__ absolute parents install_dir = os path join base_dir torch _mkdir_p install_dir _mkdir_p build_dir Store build options directly stored environment variables build_options dict str CMakeValue = Build options do start BUILD_ USE_ CMAKE_ directly controlled env vars This dict maps environment variables corresponding variable name CMake additional_options = Key environment variable name Value Corresponding variable name passed CMake If you adding new build option block Consider making these two names identical adding option block below CUDNN_LIB_DIR CUDNN_LIBRARY USE_CUDA_STATIC_LINK CAFFE _STATIC_LINK_CUDA additional_options update Build options have same environment variable name CMake variable name do start BUILD_ USE_ CMAKE_ If you adding new build option also make sure you add CMakeLists txt var var var UBSAN_FLAGS BLAS WITH_BLAS CUDA_HOST_COMPILER CUDA_NVCC_EXECUTABLE CUDA_SEPARABLE_COMPILATION CUDNN_LIBRARY CUDNN_INCLUDE_DIR CUDNN_ROOT EXPERIMENTAL_SINGLE_THREAD_POOL INSTALL_TEST JAVA_HOME INTEL_MKL_DIR INTEL_OMP_DIR MKL_THREADING MKLDNN_CPU_RUNTIME MSVC_Z _OVERRIDE CAFFE _USE_MSVC_STATIC_RUNTIME Numa_INCLUDE_DIR Numa_LIBRARIES ONNX_ML ONNX_NAMESPACE ATEN_THREADING WERROR OPENSSL_ROOT_DIR STATIC_DISPATCH_BACKEND SELECTED_OP_LIST TORCH_CUDA_ARCH_LIST TORCH_XPU_ARCH_LIST TRACING_BASED PYTHON_LIB_REL_PATH Aliases which lower priority than their canonical option low_priority_aliases = CUDA_HOST_COMPILER CMAKE_CUDA_HOST_COMPILER CUDAHOSTCXX CUDA_HOST_COMPILER CMAKE_CUDA_HOST_COMPILER CUDA_HOST_COMPILER CMAKE_CUDA_COMPILER CUDA_NVCC_EXECUTABLE CUDACXX CUDA_NVCC_EXECUTABLE var val my_env items We currently pass over all environment variables start BUILD_ USE_ CMAKE_ This because we currently have no reliable way get list all build options we have specified CMakeLists txt ` cmake -L ` won t print dependent options when dependency condition met We will possibly change future parsing CMakeLists txt ourselves then additional_options would also needed specified here true_var = additional_options get var true_var None build_options true_var = val var startswith BUILD_ USE_ CMAKE_ var endswith EXITCODE EXITCODE__TRYRUN_OUTPUT build_options var = val var low_priority_aliases key = low_priority_aliases var key build_options build_options key = val The default value cannot easily obtained CMakeLists txt We set here py_lib_path = sysconfig get_path purelib cmake_prefix_path = build_options get CMAKE_PREFIX_PATH cmake_prefix_path build_options CMAKE_PREFIX_PATH = py_lib_path + + cast str cmake_prefix_path build_options CMAKE_PREFIX_PATH = py_lib_path Some options must post-processed Ideally list will shrunk only one two options future CMake can detect many these libraries pretty comfortably We have them here now before CMake integration completed They appear here CMake defines call below because they start either BUILD_ USE_ must overwritten here use_numpy = check_negative_env_flag USE_NUMPY build_options update Note Do add new build options dict directly read environment variable -- you only need add one ` CMakeLists txt ` All build options start BUILD_ USE_ CMAKE_ automatically passed CMake For other options you can add additional_options above BUILD_PYTHON build_python BUILD_TEST build_test Most library detection should go CMake script except one which Python can do much better job due NumPy s inherent Pythonic nature USE_NUMPY use_numpy Detect build dependencies python lib path order set _HOME variables NVSHMEM nvshmem_py_dir = py_lib_path + nvidia nvshmem os path exists nvshmem_py_dir build_options NVSHMEM_PY_DIR = nvshmem_py_dir Options starting CMAKE_ cmake__options = CMAKE_INSTALL_PREFIX install_dir We set some CMAKE_ options our Python build code instead relying user s direct settings Emit error user also attempts set these CMAKE options directly specified_cmake__options = set build_options intersection cmake__options len specified_cmake__options eprint join specified_cmake__options + should specified environment variable They directly set PyTorch build script sys exit build_options update cmake__options use_numpy try This helps CMake find correct include directory NumPy This especially useful cross compiled environments numpy Python_NumPy_INCLUDE_DIR = numpy get_include build_options update dict Python_NumPy_INCLUDE_DIR=Python_NumPy_INCLUDE_DIR except ImportError use_numpy just hint so we can fail silently here pass CMake defines args Python_EXECUTABLE=sys executable TORCH_BUILD_VERSION=version build_options expected_wrapper = usr local opt ccache libexec IS_DARWIN os path exists expected_wrapper CMAKE_C_COMPILER build_options CC os environ CMake defines args CMAKE_C_COMPILER=f expected_wrapper gcc CMAKE_CXX_COMPILER build_options CXX os environ CMake defines args CMAKE_CXX_COMPILER=f expected_wrapper g++ env_var_name my_env env_var_name startswith gh github env vars use utf- windows non-ascii code may cause problem so encode first try my_env env_var_name = str my_env env_var_name encode utf- except UnicodeDecodeError e shex = join f ord c x c my_env env_var_name eprint f Invalid ENV env_var_name = shex eprint e According CMake manual we should pass arguments first put directory last element Otherwise these flags may passed correctly Reference https cmake org cmake help latest manual cmake html#synopsis https stackoverflow com args append base_dir run args env=my_env build my_env dict str str - None Runs cmake build binaries env build_type build_args = -- build -- target install -- config build_type build_type_string Determine parallelism according following priorities MAX_JOBS environment variable If using Ninja build system delegate decision Otherwise fall back number processors Allow user set parallelism explicitly If unset we ll try figure out max_jobs = os getenv MAX_JOBS max_jobs None USE_NINJA Ninja capable figuring out parallelism its own only specify explicitly we using Ninja This lists number processors available machine This may overestimate usable processors CPU scheduling affinity limits further In future we should check os sched_getaffinity platforms support max_jobs = max_jobs str multiprocessing cpu_count CMake provides -j option build_args += -j max_jobs run build_args my_env clear_cache - None Clears CMake cache os path isfile _cmake_cache_file os remove _cmake_cache_file os path isfile _ninja_build_file os remove _ninja_build_file
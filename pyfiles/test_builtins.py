Owner s oncall jit inspect os sys unittest typing Dict List torch torch testing FileCheck Make helper files test importable pytorch_test_dir = os path dirname os path dirname os path realpath __file__ sys path append pytorch_test_dir torch testing _internal common_utils raise_on_run_directly torch testing _internal jit_utils JitTestCase RUN_CUDA TestBuiltins JitTestCase Tests TorchScript support Python builtin functions test_has_attr HasA torch nn Module __init__ - None super __init__ = HasB torch nn Module __init__ - None super __init__ b = Mod torch nn Module __init__ - None super __init__ mods = torch nn ModuleList HasA HasB forward use list encode hasattr results l = torch jit annotate List int mod mods l append int hasattr mod l append int hasattr mod b actually retrieve attr test static refinement hasattr mod l append mod hasattr mod b l append mod b l checkModule Mod test_has_attr_invalid_args Mod torch nn Module __init__ - None super __init__ mod = torch nn Linear forward name allowed ` name ` must static hasattr mod name assertRaisesRegexWithHighlight RuntimeError hasattr name torch jit script Mod Mod torch nn Module forward name allowed ` torch rand ` type hasattr torch rand name assertRaisesRegexWithHighlight RuntimeError hasattr name torch jit script Mod test_del fn x List int - List int = x del x checkScript fn assertRaisesRegexWithHighlight RuntimeError undefined value torch jit script fn x = x del noqa F assertRaisesRegexWithHighlight RuntimeError undefined value torch jit script fn x = x del assertRaisesRegexWithHighlight RuntimeError undefined value b torch jit script fn x = x del b noqa F test_del_multiple_operands fn x List int - List int b c = x x x del b c x checkScript fn del_list_multiple_operands x List int - List int del x x x py_out = del_list_multiple_operands jit_out = torch jit script del_list_multiple_operands assertEqual py_out jit_out del_dict_multiple_operands x Dict str int - Dict str int del x hi x there x py_out = del_dict_multiple_operands hi there jit_out = torch jit script del_dict_multiple_operands hi there assertEqual py_out jit_out test_torch_check Test torch _check functionality flexible argument handling test_check_basic x torch _check x sum item - x test_check_with_message x torch _check x sum item - Tensor sum must reasonable x test_check_with_kwarg_message x torch _check x sum item - message= Tensor sum must reasonable x test_check_cond_kwarg x torch _check cond=x sum item - x test_check_both_kwargs x torch _check cond=x sum item - message= Both kwargs x test_check_kwargs_reversed x torch _check message= Reversed order cond=x sum item - x test_check_in_loop x sizes = torch jit annotate List int x tolist s sizes torch _check s - x test_tensor = torch tensor Test all variations checkScript test_check_basic test_tensor checkScript test_check_with_message test_tensor checkScript test_check_with_kwarg_message test_tensor checkScript test_check_cond_kwarg test_tensor checkScript test_check_both_kwargs test_tensor checkScript test_check_kwargs_reversed test_tensor checkScript test_check_in_loop test_tensor Test compiled functions work correctly scripted_basic = torch jit script test_check_basic scripted_with_message = torch jit script test_check_with_message scripted_with_kwarg = torch jit script test_check_with_kwarg_message scripted_cond_kwarg = torch jit script test_check_cond_kwarg scripted_both_kwargs = torch jit script test_check_both_kwargs scripted_kwargs_reversed = torch jit script test_check_kwargs_reversed scripted_in_loop = torch jit script test_check_in_loop These should all succeed without throwing result = scripted_basic test_tensor result = scripted_with_message test_tensor result = scripted_with_kwarg test_tensor result = scripted_cond_kwarg test_tensor result = scripted_both_kwargs test_tensor result = scripted_kwargs_reversed test_tensor result = scripted_in_loop test_tensor Results should same input result result result result result result result result assertEqual result test_tensor Check message constants present graphs FileCheck check Tensor sum must reasonable run scripted_with_message graph FileCheck check Tensor sum must reasonable run scripted_with_kwarg graph FileCheck check Both kwargs run scripted_both_kwargs graph FileCheck check Reversed order run scripted_kwargs_reversed graph Verify graphs contain some computation just empty basic_graph_str = str scripted_basic graph assertTrue len basic_graph_str Basic graph should contain some computation Verify loop case contains loop FileCheck check prim Loop run scripted_in_loop graph scripted_func scripted_basic scripted_with_message scripted_with_kwarg scripted_cond_kwarg scripted_both_kwargs scripted_kwargs_reversed FileCheck check prim If check prim RaiseException run scripted_func graph test_torch_check_invalid_args Test torch _check invalid arguments Test too many arguments assertRaisesRegex RuntimeError torch _check\\ \\ expects arguments torch jit script too_many_args x torch _check True msg extra x Test invalid keyword argument assertRaisesRegex RuntimeError unexpected keyword argument torch jit script invalid_kwarg x torch _check True invalid_arg= msg x Test duplicate cond argument positional + keyword assertRaisesRegex RuntimeError multiple values argument cond torch jit script duplicate_cond x torch _check True cond=False x Test missing required cond argument assertRaisesRegex RuntimeError missing required argument cond torch jit script missing_cond x torch _check message= msg only x Test no arguments all assertRaisesRegex RuntimeError torch _check\\ \\ expects arguments torch jit script no_args x torch _check x Test too many total arguments positional + keyword assertRaisesRegex RuntimeError torch _check\\ \\ expects arguments torch jit script too_many_total_args x torch _check True msg cond=False x TestTensorBuiltins JitTestCase test_tensor_properties should_keep tensor name inspect isroutine getattr tensor name False name startswith _ False True tensor = torch arange dtype=torch float view keys = dir tensor real imag only implemented complex tensors assertRaises RuntimeError lambda should_keep tensor imag keys remove imag properties = p p keys should_keep tensor p code_template = fn x x EQUALITY_MISMATCH = TorchScript doesn t have real enums so they int instead actual value dtype layout MISSING_PROPERTIES = grad_fn This undocumented property so s included output_nr This has longer implementation maybe worth copying TorchScript named tensors don t work there anyways names We don t plan support grad_dtype TorchScript grad_dtype p properties p MISSING_PROPERTIES continue code = code_template format p cu = torch jit CompilationUnit cu define code p EQUALITY_MISMATCH continue assertEqual getattr tensor p cu fn tensor test_tensor_subscript_assign fn x = torch zeros_like x dtype=torch uint torch tensor = torch tensor dtype=torch uint fn x = torch zeros_like x dtype=torch uint = fn x = torch zeros_like x dtype=torch uint torch tensor = fn x = torch zeros_like x dtype=torch uint = torch tensor dtype=torch uint fn x = torch zeros_like x dtype=torch float torch tensor = fn fn fn fn fn fn checkScript fn torch zeros dtype=torch uint unittest skipIf RUN_CUDA requires CUDA test_tensor_subscript_assign_device fn x = torch zeros_like x dtype=torch float device= cuda torch tensor = checkScript fn torch zeros dtype=torch float device= cuda test_tensor_item test_scalar_cast x scalar = x item int scalar float scalar graph = torch jit script test_scalar_cast graph FileCheck check int float = prim TupleConstruct run graph checkScript test_scalar_cast torch tensor checkScript test_scalar_cast torch tensor test_method_on_number func c = c add assertRaisesRegex RuntimeError object has no attribute method torch jit script func testing implicit conversion tensors scalars match function arguments test_scalar_to_num_conversions torch jit script multiple_defs x c = x = x + c x assertTrue ImplicitTensorToNum str multiple_defs graph torch jit script tensor_to_int_script x tensor x unsqueeze tensor location present error message assertRaisesRegex RuntimeError x unsqueeze tensor_to_int_script torch tensor torch tensor tensor_to_int x tensor x unsqueeze tensor torch jit script tensor_to_float_script x tensor x addcmul tensor tensor value=tensor tensor_to_float x tensor x addcmul tensor tensor value=tensor x = torch zeros float tensor float tensor grad int tensor can t set grad int tensor tensors = torch tensor torch tensor requires_grad=True torch tensor torch tensor script_funs = tensor_to_int_script tensor_to_float_script funs = tensor_to_int tensor_to_float result whether exception thrown test_func func x tensor try result = func x tensor except RuntimeError result = True except TypeError result = True result assert result exception equal each function inputs tensor tensors i range len script_funs assertEqual test_func script_funs i x tensor test_func funs i x tensor __name__ == __main__ raise_on_run_directly test test_jit py
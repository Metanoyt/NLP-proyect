Copyright c Meta Platforms Inc affiliates abc io collections abc Sequence typing cast IO Optional introduced collections abc Buffer Python typing_extensions Buffer torch _utils try_import NOTE everything file experimental subject change Feedback bug fixes always welcome pyzstd_module_name = pyzstd pyzstd = try_import pyzstd_module_name zstandard_module_name = zstandard zstandard = try_import zstandard_module_name __all__ = Extension StreamTransformExtension ZStandard ExtensionRegistry Extension abc ABC Extensions provide modular additions functionality within distributed checkpointing which affect layout format written artifacts Extensions may built into pytorch provided externally When writing caller provides list extension instances appropriate type Each extension can output descriptor which used reconstitute extension read-time staticmethod abc abstractmethod registry_name - str See ExtensionRegistry from_descriptor_list staticmethod abc abstractmethod from_descriptor version str - Extension See ExtensionRegistry from_descriptor_list abc abstractmethod get_descriptor - str Return descriptor name included metadata The form should extension_name local-domain version StreamTransformExtension Extension An extension which performs transformation byte stream such compression encryption Implementations should try memory friendly performant For example don t read whole input then transform write back If all possible do chunks But don t read transform write one byte time either abc abstractmethod transform_to output IO bytes - IO bytes Takes writeable output stream generates new stream which implements output transform Input data written returned stream will transformed written ` output ` argument stream abc abstractmethod transform_from input IO bytes - IO bytes Takes readable input stream generates new stream which implements input transform When returned stream read data will read input stream transformed returned ZStandard StreamTransformExtension staticmethod is_available - bool zstandard None pyzstd None staticmethod pyrefly ignore bad-override from_descriptor version str - ZStandard version partition = raise ValueError f Unknown extension version= ZStandard is_available raise ValueError f Stream ZStandard compression cannot processed because f no module named zstandard_module_name pyzstd_module_name ZStandard staticmethod registry_name - str stream zstd __init__ - None super __init__ ZStandard is_available raise ValueError f ZStandard extension unavailable because no module named zstandard_module_name pyzstd_module_name get_descriptor - str f registry_name transform_to output IO bytes - IO bytes zstandard None compressor = zstandard ZstdCompressor type ignore union-attr compressor stream_writer output Writer io RawIOBase __init__ output IO bytes - None output = output compressor = pyzstd ZstdCompressor type ignore union-attr writeable - bool True write b Buffer - Optional int outdata = compressor compress b outdata output write outdata len memoryview b flush - None outdata = compressor flush outdata output write outdata output flush cast IO bytes Writer output transform_from input IO bytes - IO bytes zstandard None decompressor = zstandard ZstdDecompressor type ignore union-attr decompressor stream_reader input Reader io RawIOBase __init__ input IO bytes - None input = input decompressor = pyzstd EndlessZstdDecompressor type ignore union-attr readable - bool True readinto b Buffer - Optional int This needs read enough so can decompress something so output doesn t look like EOF This means reading least one block The max block size KB so we read plus some overhead sure decompressor needs_input indata = input read + indata = b bview = memoryview b blen = len bview outdata = decompressor decompress indata blen outdata None None count = len outdata bview count = outdata count seekable - bool False cast IO bytes Reader input ExtensionRegistry __init__ - None Populate default registry contents extensions dict str type Extension = cls registry_name cls cls ZStandard register cls type Extension - None extensions cls registry_name = cls from_descriptor_list descriptors Sequence str - Sequence Extension Given seuquence descriptor strings returned Extension get_descriptor save time creates sequence Extension instances The name local-domain preceding version number used look up implementation registry version passed s from_descriptor static method If registry contains no match will throw ValueError If from_descriptor method raises exception will pass through caller from_descriptor desc str - Extension name _ version = desc partition version None version = ext = extensions get name ext raise ValueError f Unknown extension name= pyrefly ignore bad-argument-type ext from_descriptor version from_descriptor desc desc descriptors
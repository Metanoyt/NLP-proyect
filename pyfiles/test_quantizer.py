Owner s oncall quantization torch torch quantize_per_tensor torch ao quantization observer MinMaxObserver torch ao quantization experimental observer APoTObserver torch ao quantization experimental quantizer APoTQuantizer quantize_APoT dequantize_APoT unittest random TestQuantizer unittest TestCase r Tests quantize_APoT result random -dim tensor hardcoded values b k comparing uniform quantization non-uniform quantization reduces uniform k = quantized tensor https pytorch org docs stable generated torch quantize_per_tensor html tensor quantize Tensor b k test_quantize_APoT_rand_k generate random size tensor quantize between - size = random randint generate tensor random fp values between - tensor quantize = torch rand size dtype=torch float apot_observer = APoTObserver b= k= apot_observer tensor quantize alpha gamma quantization_levels level_indices = apot_observer calculate_qparams signed=False get apot quantized tensor result qtensor = quantize_APoT tensor quantize=tensor quantize alpha=alpha gamma=gamma quantization_levels=quantization_levels level_indices=level_indices get uniform quantization quantized tensor result uniform_observer = MinMaxObserver uniform_observer tensor quantize scale zero_point = uniform_observer calculate_qparams uniform_quantized = quantize_per_tensor input=tensor quantize scale=scale zero_point=zero_point dtype=torch quint int_repr qtensor_data = qtensor data int uniform_quantized_tensor = uniform_quantized data int assertTrue torch equal qtensor_data uniform_quantized_tensor r Tests quantize_APoT k = Tests quantize_APoT result random -dim tensor hardcoded values b= k= comparing results hand-calculated results APoT paper https arxiv org pdf pdf tensor quantize Tensor b k test_quantize_APoT_k r given b = k = alpha = we know APoT paper example https arxiv org pdf pdf quantization_levels = tensor level_indices = tensor generate tensor random fp values tensor quantize = torch tensor observer = APoTObserver b= k= observer forward tensor quantize alpha gamma quantization_levels level_indices = observer calculate_qparams signed=False get apot quantized tensor result qtensor = quantize_APoT tensor quantize=tensor quantize alpha=alpha gamma=gamma quantization_levels=quantization_levels level_indices=level_indices qtensor_data = qtensor data int expected qtensor values calculated based corresponding level_indices nearest quantization level each fp value tensor quantize e g tensor quantize nearest quantization_levels - level_indices expected_qtensor = torch tensor dtype=torch int assertTrue torch equal qtensor_data expected_qtensor r Tests dequantize_apot result random -dim tensor hardcoded values b k Dequant - quant input tensor verify result equivalent input tensor quantize Tensor b k test_dequantize_quantize_rand_b make observer observer = APoTObserver generate random size tensor quantize between - size = random randint make tensor quantize random fp values between - tensor quantize = torch rand size dtype=torch float observer forward tensor quantize alpha gamma quantization_levels level_indices = observer calculate_qparams signed=False make mock apot_tensor original_apot = quantize_APoT tensor quantize=tensor quantize alpha=alpha gamma=gamma quantization_levels=quantization_levels level_indices=level_indices original_input = torch clone original_apot data int dequantize apot_tensor dequantize_result = dequantize_APoT apot_tensor=original_apot quantize apot_tensor final_apot = quantize_APoT tensor quantize=dequantize_result alpha=alpha gamma=gamma quantization_levels=quantization_levels level_indices=level_indices result = final_apot data int assertTrue torch equal original_input result r Tests dequantize_apot result random -dim tensor hardcoded values b k Dequant - quant input tensor verify result equivalent input tensor quantize Tensor b k test_dequantize_quantize_rand_b make observer observer = APoTObserver generate random size tensor quantize between - size = random randint make tensor quantize random fp values between - tensor quantize = torch rand size dtype=torch float observer forward tensor quantize alpha gamma quantization_levels level_indices = observer calculate_qparams signed=False make mock apot_tensor original_apot = quantize_APoT tensor quantize=tensor quantize alpha=alpha gamma=gamma quantization_levels=quantization_levels level_indices=level_indices original_input = torch clone original_apot data int dequantize apot_tensor dequantize_result = dequantize_APoT apot_tensor=original_apot quantize apot_tensor final_apot = quantize_APoT tensor quantize=dequantize_result alpha=alpha gamma=gamma quantization_levels=quantization_levels level_indices=level_indices result = final_apot data int assertTrue torch equal original_input result r Tests correct dimensions dequantize_apot result random -dim tensor random dimension sizes hardcoded values b k Dequant input tensor verify dimensions same input tensor quantize Tensor b k test_dequantize_dim make observer observer = APoTObserver generate random size tensor quantize between - size = random randint size = random randint size = random randint make tensor quantize random fp values between - tensor quantize = torch rand size size size dtype=torch float observer forward tensor quantize alpha gamma quantization_levels level_indices = observer calculate_qparams signed=False make mock apot_tensor original_apot = quantize_APoT tensor quantize=tensor quantize alpha=alpha gamma=gamma quantization_levels=quantization_levels level_indices=level_indices dequantize apot_tensor dequantize_result = dequantize_APoT apot_tensor=original_apot assertEqual original_apot data size dequantize_result size test_q_apot_alpha assertRaises NotImplementedError APoTQuantizer q_apot_alpha __name__ == __main__ unittest main
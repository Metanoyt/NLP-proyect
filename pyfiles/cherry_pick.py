usr bin env python json os re typing Any cast Optional urllib error HTTPError github_utils gh_fetch_url gh_post_pr_comment gh_query_issues_by_labels gitutils get_git_remote_name get_git_repo_dir GitRepo trymerge get_pr_commit_sha GitHubPR This only suggestion now strict requirement REQUIRES_ISSUE = regression critical fixnewfeature RELEASE_BRANCH_REGEX = re compile r release P version + parse_args - Any argparse ArgumentParser parser = ArgumentParser cherry pick landed PR onto release branch parser add_argument -- onto-branch type=str required=True help= target release branch parser add_argument -- github-actor type=str required=True help= all world s stage parser add_argument -- classification choices= regression critical fixnewfeature docs release required=True help= cherry pick category parser add_argument pr_num type=int parser add_argument -- fixes type=str default= help= GitHub issue cherry pick fixes parser add_argument -- dry-run action= store_true parser parse_args get_merge_commit_sha repo GitRepo pr GitHubPR - Optional str Return merge commit SHA iff PR has been merged For simplicity we will only cherry pick PRs have been merged into main commit_sha = get_pr_commit_sha repo pr commit_sha pr is_closed None get_release_version onto_branch str - Optional str Return release version target branch release branch m = re match RELEASE_BRANCH_REGEX onto_branch m group version m get_tracker_issues org str project str onto_branch str - list dict str Any Find tracker issue repo The tracker issue needs have title like VERSION Release Tracker following convention PyTorch version = get_release_version onto_branch version tracker_issues = gh_query_issues_by_labels org project labels= release tracker tracker_issues Figure out tracker issue list looking title issue issue tracker_issues version issue get title cherry_pick github_actor str repo GitRepo pr GitHubPR commit_sha str onto_branch str classification str fixes str dry_run bool = False - None Create local branch cherry pick commit submit pull request current_branch = repo current_branch cherry_pick_branch = create_cherry_pick_branch github_actor repo pr commit_sha onto_branch try org project = repo gh_owner_and_name cherry_pick_pr = dry_run cherry_pick_pr = submit_pr repo pr cherry_pick_branch onto_branch tracker_issues_comments = tracker_issues = get_tracker_issues org project onto_branch issue tracker_issues issue_number = int str issue get number issue_number continue res = cast dict str Any post_tracker_issue_comment org project issue_number pr pr_num cherry_pick_pr classification fixes dry_run comment_url = res get html_url comment_url tracker_issues_comments append comment_url msg = f The cherry pick PR cherry_pick_pr fixes msg += f linked issue fixes classification REQUIRES_ISSUE msg += f recommended link classification cherry pick PR issue tracker_issues_comments msg += The following tracker issues updated \n tracker_issues_comment tracker_issues_comments msg += f tracker_issues_comment \n post_pr_comment org project pr pr_num msg dry_run finally current_branch repo checkout branch=current_branch create_cherry_pick_branch github_actor str repo GitRepo pr GitHubPR commit_sha str onto_branch str - str Create local branch cherry pick commit Return name local cherry picking branch repo checkout branch=onto_branch repo _run_git submodule update -- init -- recursive Remove all special characters we want include actor branch name github_actor = re sub ^ - a-zA-Z + _ github_actor cherry_pick_branch = f cherry-pick- pr pr_num -by- github_actor repo create_branch_and_checkout branch=cherry_pick_branch We might want support ghstack later We don t want resolve conflicts here repo _run_git cherry-pick -x commit_sha repo push branch=cherry_pick_branch dry_run=False cherry_pick_branch submit_pr repo GitRepo pr GitHubPR cherry_pick_branch str onto_branch str - str Submit cherry pick PR link PR org project = repo gh_owner_and_name default_msg = f Cherry pick pr pr_num onto onto_branch branch title = pr info get title default_msg body = pr info get body default_msg try response = gh_fetch_url f https api github com repos org project pulls method= POST data= title title body body head cherry_pick_branch base onto_branch headers= Accept application vnd github v +json reader=json load cherry_pick_pr = response get html_url cherry_pick_pr raise RuntimeError f Fail find cherry pick PR json dumps response str cherry_pick_pr except HTTPError error msg = f Fail submit cherry pick PR error raise RuntimeError msg error post_pr_comment org str project str pr_num int msg str dry_run bool = False - list dict str Any Post comment PR itself point cherry picking PR when success print error when failure internal_debugging = run_url = os getenv GH_RUN_URL Post comment tell folks PR being cherry picked run_url None internal_debugging = \n join line line details summary Details Dev Infra team summary f Raised href= run_url workflow job \n details line comment = \n join f ### Cherry picking pr_num f msg f internal_debugging gh_post_pr_comment org project pr_num comment dry_run post_tracker_issue_comment org str project str issue_num int pr_num int cherry_pick_pr str classification str fixes str dry_run bool = False - list dict str Any Post comment tracker issue any record cherry pick comment = \n join Link landed trunk PR applicable f https github com org project pull pr_num Link release branch PR f cherry_pick_pr Criteria Category - join classification capitalize fixes capitalize gh_post_pr_comment org project issue_num comment dry_run main - None args = parse_args pr_num = args pr_num repo = GitRepo get_git_repo_dir get_git_remote_name org project = repo gh_owner_and_name pr = GitHubPR org project pr_num try commit_sha = get_merge_commit_sha repo pr commit_sha raise RuntimeError f Refuse cherry pick pr_num because hasn t been merged yet cherry_pick args github_actor repo pr commit_sha args onto_branch args classification args fixes args dry_run except RuntimeError error args dry_run post_pr_comment org project pr_num str error raise error __name__ == __main__ main
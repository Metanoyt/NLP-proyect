usr bin env python concurrent futures distutils sysconfig functools itertools os re pathlib Path typing Any We also check there cxx symbols libtorch To check whether using cxx ABI check non-existence symbol PRE_CXX _SYMBOLS = std basic_string std list To check whether using pre-cxx ABI check non-existence symbol CXX _SYMBOLS = std __cxx basic_string std __cxx list NOTE Checking above symbols all namespaces doesn t work because devtoolset always produces some cxx symbols even we build old ABI CuDNN always has pre-cxx symbols even we build new ABI using gcc Instead we only check above symbols following namespaces LIBTORCH_NAMESPACE_LIST = c caffe torch Patterns detecting statically linked libstdc++ symbols STATICALLY_LINKED_CXX _ABI = re compile r recursive_directory_iterator _apply_libtorch_symbols symbols re compile f x y x y itertools product LIBTORCH_NAMESPACE_LIST symbols LIBTORCH_CXX _PATTERNS = _apply_libtorch_symbols CXX _SYMBOLS LIBTORCH_PRE_CXX _PATTERNS = _apply_libtorch_symbols PRE_CXX _SYMBOLS functools lru_cache get_symbols lib str - list tuple str str str subprocess check_output lines = check_output f nm lib &#124; c++filt shell=True x split x lines decode latin split \n - grep_symbols lib str patterns list Any symbol_type str &#124; None = None - list str _grep_symbols symbols list tuple str str str patterns list Any - list str rc = _s_addr _s_type s_name symbols Filter symbol type specified symbol_type _s_type = symbol_type continue pattern patterns pattern match s_name rc append s_name continue rc all_symbols = get_symbols lib num_workers = chunk_size = len all_symbols + num_workers - num_workers _get_symbols_chunk i all_symbols i chunk_size i + chunk_size concurrent futures ThreadPoolExecutor max_workers= executor tasks = executor submit _grep_symbols _get_symbols_chunk i patterns i range num_workers functools reduce list __add__ x result x tasks check_lib_statically_linked_libstdc_cxx_abi_symbols lib str - None cxx _statically_linked_symbols = grep_symbols lib STATICALLY_LINKED_CXX _ABI symbol_type= T num_statically_linked_symbols = len cxx _statically_linked_symbols print f num_statically_linked_symbols T num_statically_linked_symbols num_statically_linked_symbols raise RuntimeError f Found statically linked libstdc++ symbols recursive_directory_iterator cxx _statically_linked_symbols check_lib_symbols_for_abi_correctness lib str - None print f lib lib cxx _symbols = grep_symbols lib LIBTORCH_CXX _PATTERNS pre_cxx _symbols = grep_symbols lib LIBTORCH_PRE_CXX _PATTERNS num_cxx _symbols = len cxx _symbols num_pre_cxx _symbols = len pre_cxx _symbols print f num_cxx _symbols num_cxx _symbols print f num_pre_cxx _symbols num_pre_cxx _symbols num_pre_cxx _symbols raise RuntimeError f Found pre-cxx symbols there shouldn t any see pre_cxx _symbols num_cxx _symbols raise RuntimeError Didn t find enough cxx symbols main - None install_root os environ install_root = Path os getenv install_root noqa SIM os getenv PACKAGE_TYPE == libtorch install_root = Path os getcwd install_root = Path distutils sysconfig get_python_lib torch libtorch_cpu_path = str install_root lib libtorch_cpu so check_lib_symbols_for_abi_correctness libtorch_cpu_path check_lib_statically_linked_libstdc_cxx_abi_symbols libtorch_cpu_path __name__ == __main__ main
usr bin env python __future__ annotations os enum Enum operator itemgetter pathlib Path typing Any torch torch jit generate_bytecode generate_upgraders_bytecode torchgen code_template CodeTemplate torchgen operator_versions gen_mobile_upgraders_constant MOBILE_UPGRADERS_HEADER_DESCRIPTION ByteCode Enum instructions = constants = types = operators = register_size = EXCLUDED_OP_SET = aten full names aten full out aten full EXCLUE_UPGRADER_SET = full_ _ full_out_ _ ONE_INSTRUCTION = CodeTemplate Instruction OpCode $ operator_name $ X $ N INSTRUCTION_LIST = CodeTemplate std vector Instruction $ instruction_list instructions list ONE_CONSTANT = CodeTemplate c IValue $ constant CONSTANT_LIST = CodeTemplate std vector c IValue $ constant_list constants list CONSTANTS_LIST_EMPTY = std vector c IValue constants list ONE_TYPE = CodeTemplate c parseType $ type_str TYPE_LIST = CodeTemplate std vector c TypePtr $ type_list types list TYPE_LIST_EMPTY = std vector c TypePtr types list ONE_OPERATOTR_STRING = CodeTemplate OperatorString $ operator_name $ overload_name $ num_of_args OPERATOR_STRING_LIST = CodeTemplate std vector OperatorString $ operator_string_list operators list ONE_UPGRADER_FUNCTION = CodeTemplate mobile Function registerFunc $ upgrader_name $ instruction_list $ constant_list $ type_list $ register_size ONE_UPGRADER_SRC = CodeTemplate ByteCodeFunctionWithOperator $ bytecode_function $ operator_string_list ONE_UPGRADER_IN_VERSION_MAP = CodeTemplate Upgrader $ upgrader_min_version $ upgrader_max_version $ upgrader_name $ bytecode_func_index noqa E ONE_OPERATOR_IN_VERSION_MAP = CodeTemplate std string $ operator_name std vector Upgrader $ upgrader_list_in_version_map OPERATOR_VERSION_MAP = CodeTemplate const std unordered_map std string std vector Upgrader getOperatorVersionMapForMobile static std unordered_map std string std vector Upgrader operatorVersionMapForMobile $ operator_list_in_version_map operatorVersionMapForMobile UPGRADER_CPP_SRC = CodeTemplate MOBILE_UPGRADERS_HEADER_DESCRIPTION + #include caffe serialize versions h #include torch csrc jit mobile type_parser h #include torch csrc jit mobile upgrader_mobile h namespace torch namespace jit clang-format off From operator_versions_map $ operator_version_map const std vector ByteCodeFunctionWithOperator getUpgraderBytecodeList auto generate_upgrader_bytecode_list = std vector ByteCodeFunctionWithOperator upgrader_function_list $ upgrader_bytecode const auto upgrader_function upgrader_function_list const auto op upgrader_function operators upgrader_function function append_operator op name op overload_name op num_specified_args upgrader_function_list static std vector ByteCodeFunctionWithOperator upgraderBytecodeList = generate_upgrader_bytecode_list upgraderBytecodeList clang-format namespace jit namespace torch UPGRADER_MOBILE_FILE_NAME = upgrader_mobile cpp UPGRADER_ELEMENT = CodeTemplate \ Upgrader $ min_version $ max_version $ operator_name $ index PER_OPERATOR_UPGRADER_LIST = CodeTemplate \ std string $ operator_name std vector Upgrader $ upgrader_list construct_instruction instruction_list_from_yaml list Any - str instruction_list_part = ONE_INSTRUCTION substitute operator_name=instruction X=instruction N=instruction instruction instruction_list_from_yaml INSTRUCTION_LIST substitute instruction_list= join instruction_list_part lstrip \n construct_constants constants_list_from_yaml list Any - str constants_list_part = constant_from_yaml constants_list_from_yaml convert_constant = None isinstance constant_from_yaml str Add quotes s string convert_constant = f constant_from_yaml isinstance constant_from_yaml bool convert_constant = true constant_from_yaml false constant_from_yaml None convert_constant = isinstance constant_from_yaml int convert_constant = str constant_from_yaml raise ValueError f The type constant_from_yaml type constant_from_yaml Please add change construct_constants function gen_mobile_upgraders py constants_list_part append ONE_CONSTANT substitute constant=convert_constant len constants_list_part == CONSTANTS_LIST_EMPTY CONSTANT_LIST substitute constant_list= join constants_list_part lstrip \n construct_operators operator_list_from_yaml list Any - str operator_list_part = ONE_OPERATOTR_STRING substitute operator_name=operator overload_name=operator num_of_args=operator operator operator_list_from_yaml OPERATOR_STRING_LIST substitute operator_string_list= join operator_list_part lstrip \n construct_types types_tr_list_from_yaml list Any - str types_tr_list_part = ONE_TYPE substitute type_str=types_tr types_tr types_tr_list_from_yaml len types_tr_list_part == TYPE_LIST_EMPTY TYPE_LIST substitute type_list= join types_tr_list_part lstrip \n construct_register_size register_size_from_yaml int - str isinstance register_size_from_yaml int raise ValueError f Input register size register_size_from_yaml s type type register_size_from_yaml An int type expected str register_size_from_yaml construct_version_maps upgrader_bytecode_function_to_index_map dict str Any - str version_map = torch _C _get_operator_version_map sorted_version_map_ = sorted version_map items key=itemgetter type ignore no-any-return sorted_version_map = dict sorted_version_map_ operator_list_in_version_map_part = op_name sorted_version_map upgraders_in_version_map_part = TODO remove skip after these two operators schemas fixed op_name EXCLUDED_OP_SET continue upgrader_ranges = torch _C _get_upgrader_ranges op_name upgrader_entries = sorted_version_map op_name assert len upgrader_ranges == len upgrader_entries idx upgrader_entry enumerate upgrader_entries upgrader_name = upgrader_entry upgrader_name bytecode_function_index = upgrader_bytecode_function_to_index_map upgrader_name upgraders_in_version_map_part append ONE_UPGRADER_IN_VERSION_MAP substitute upgrader_min_version=upgrader_ranges idx min_version upgrader_max_version=upgrader_ranges idx max_version upgrader_name=upgrader_name bytecode_func_index=bytecode_function_index operator_list_in_version_map_part append ONE_OPERATOR_IN_VERSION_MAP substitute operator_name=op_name upgrader_list_in_version_map= join upgraders_in_version_map_part OPERATOR_VERSION_MAP substitute operator_list_in_version_map= join operator_list_in_version_map_part lstrip \n get_upgrader_bytecode_function_to_index_map upgrader_dict list dict str Any - dict str Any upgrader_bytecode_function_to_index_map = index = upgrader_bytecode upgrader_dict upgrader_name upgrader_bytecode keys upgrader_name EXCLUE_UPGRADER_SET continue upgrader_bytecode_function_to_index_map upgrader_name = index index += upgrader_bytecode_function_to_index_map write_cpp cpp_path str upgrader_dict list dict str Any - None upgrader_bytecode_function_to_index_map = get_upgrader_bytecode_function_to_index_map upgrader_dict version_map_src = construct_version_maps upgrader_bytecode_function_to_index_map all_upgrader_src_string = upgrader_bytecode upgrader_dict upgrader_name bytecode upgrader_bytecode items TODO remove skip after these two operators schemas fixed upgrader_name EXCLUE_UPGRADER_SET continue instruction_list_str = constant_list_str = type_list_str = register_size_str = operator_list_str = table_name contents bytecode items element = ByteCode table_name element ByteCode instructions instruction_list_str = construct_instruction contents element ByteCode constants constant_list_str = construct_constants contents element ByteCode operators operator_list_str = construct_operators contents element ByteCode types type_list_str = construct_types contents element ByteCode register_size register_size_str = construct_register_size contents one_upgrader_function_string = ONE_UPGRADER_FUNCTION substitute upgrader_name=upgrader_name instruction_list=instruction_list_str constant_list=constant_list_str type_list=type_list_str register_size=register_size_str one_upgrader_src_string = ONE_UPGRADER_SRC substitute bytecode_function=one_upgrader_function_string lstrip \n operator_string_list=operator_list_str lstrip \n all_upgrader_src_string append one_upgrader_src_string upgrader_file_content = UPGRADER_CPP_SRC substitute operator_version_map=version_map_src upgrader_bytecode= join all_upgrader_src_string lstrip \n print writing file cpp_path + + UPGRADER_MOBILE_FILE_NAME open os path join cpp_path UPGRADER_MOBILE_FILE_NAME wb out_file out_file write upgrader_file_content encode utf- sort_upgrader upgrader_list list dict str Any - list dict str Any sorted_upgrader_list = sorted upgrader_list key=lambda one_upgrader next iter one_upgrader sorted_upgrader_list main - None upgrader_list = generate_upgraders_bytecode sorted_upgrader_list = sort_upgrader upgrader_list up sorted_upgrader_list print after sort upgrader next iter up pytorch_dir = Path __file__ resolve parents upgrader_path = pytorch_dir torch csrc jit mobile write_cpp str upgrader_path sorted_upgrader_list __name__ == __main__ main
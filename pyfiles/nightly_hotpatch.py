usr bin env python argparse os shutil subprocess sys tempfile urllib request typing cast NoReturn Optional parse_arguments - argparse Namespace Parses command-line arguments using argparse Returns argparse Namespace The parsed arguments containing PR number optional target directory strip count parser = argparse ArgumentParser description= Download apply Pull Request PR patch PyTorch GitHub repository your local PyTorch installation \n\n Best Practice Since script involves hot-patching PyTorch s recommended use disposable environment like Docker container dedicated Python virtual environment venv This ensures patching fails you can easily recover resetting environment epilog= Example \n python nightly_hotpatch py \n python nightly_hotpatch py -- directory path pytorch -- strip \n\n These commands will download patch PR apply your local PyTorch installation formatter_class=argparse RawDescriptionHelpFormatter parser add_argument PR_NUMBER type=int help= The number Pull Request PR PyTorch GitHub repository download apply patch parser add_argument -- directory -d type=str default=None help= Optional Specify target directory apply patch If provided script will use PyTorch installation path parser add_argument -- strip -p type=int default= help= Optional Specify strip count remove leading directories file paths patch Default parser parse_args get_pytorch_path - str Retrieves installation path PyTorch current environment Returns str The directory PyTorch installation Exits If PyTorch installed current Python environment script will exit try torch torch_paths list str = cast list str torch __path__ torch_path str = torch_paths parent_path str = os path dirname torch_path print f PyTorch installed torch_path print f Parent directory patching parent_path parent_path except ImportError handle_import_error handle_import_error - NoReturn Handle case where PyTorch installed exit program Exits NoReturn This function will terminate program print Error PyTorch installed current Python environment sys exit download_patch pr_number int repo_url str download_dir str - str Downloads patch file given PR specified GitHub repository Args pr_number int The pull request number repo_url str The URL repository where PR hosted download_dir str The directory store downloaded patch Returns str The path downloaded patch file Exits If download fails script will exit patch_url = f repo_url pull pr_number diff patch_file = os path join download_dir f pr- pr_number patch print f Downloading PR pr_number patch patch_url try urllib request urlopen patch_url response open patch_file wb out_file pyrefly ignore bad-specialization shutil copyfileobj response out_file os path isfile patch_file print f Failed download patch PR pr_number sys exit print f Patch downloaded patch_file patch_file except urllib error HTTPError e print f HTTP Error e code when downloading patch PR pr_number sys exit except Exception e print f An error occurred while downloading patch e sys exit apply_patch patch_file str target_dir Optional str strip_count int - None Applies downloaded patch specified directory using given strip count Args patch_file str The path patch file target_dir Optional str The directory apply patch If None uses PyTorch installation path strip_count int The number leading directories strip file paths patch Exits If patch command fails patch utility available script will exit target_dir print f Applying patch directory target_dir print No target directory specified Using PyTorch installation path print f Applying patch strip count strip_count try Construct patch command -d -p options patch_command = patch f -p strip_count -i patch_file target_dir patch_command insert f -d target_dir Insert -d option right after patch print f Running command join patch_command result = subprocess run patch_command capture_output=True text=True patch_command insert f -d target_dir print f Running command join patch_command result = subprocess run patch_command capture_output=True text=True Check patch applied successfully result returncode = print Failed apply patch print Patch output print result stdout print result stderr sys exit print Patch applied successfully except FileNotFoundError print Error The patch utility installed found PATH sys exit except Exception e print f An error occurred while applying patch e sys exit main - None Main function orchestrate patch download application process Steps Parse command-line arguments get PR number optional target directory strip count Retrieve local PyTorch installation path use provided target directory Download patch provided PR number Apply patch specified directory given strip count args = parse_arguments pr_number = args PR_NUMBER custom_target_dir = args directory strip_count = args strip custom_target_dir os path isdir custom_target_dir print f Error The specified target directory custom_target_dir does exist sys exit target_dir = custom_target_dir print f Using custom target directory target_dir target_dir = get_pytorch_path repo_url = https github com pytorch pytorch tempfile TemporaryDirectory tmpdirname patch_file = download_patch pr_number repo_url tmpdirname apply_patch patch_file target_dir strip_count __name__ == __main__ main
argparse datetime subprocess sys time torch runner get_nn_runners run_rnn name rnn_creator nloops= seqLength= numLayers= inputSize= hiddenSize= miniBatch= device= cuda seed=None run_iter modeldef Forward forward_output = modeldef forward modeldef inputs loss computation backward modeldef backward_setup None backward_input = modeldef backward_setup forward_output backward_input = forward_output modeldef backward None modeldef backward backward_input Update parameters modeldef backward None torch no_grad param modeldef params param grad zero_ torch cuda synchronize assert device == cuda creator_args = dict seqLength=seqLength numLayers=numLayers inputSize=inputSize hiddenSize=hiddenSize miniBatch=miniBatch device=device seed=seed modeldef = rnn_creator creator_args run_iter modeldef _ range nloops profile rnns sleep_between_seconds= nloops= internal_run=True Unused get rid TODO seqLength= numLayers= inputSize= hiddenSize= miniBatch= device= cuda seed=None params = dict seqLength=seqLength numLayers=numLayers inputSize=inputSize hiddenSize=hiddenSize miniBatch=miniBatch device=device seed=seed name creator context get_nn_runners rnns context run_rnn name creator nloops params time sleep sleep_between_seconds system command Returns return-code stdout stderr print f system command p = subprocess Popen command stdout=subprocess PIPE stderr=subprocess PIPE shell=True output err = p communicate rc = p returncode output = output decode ascii err = err decode ascii rc output err describe_sizes sizes seqLength numLayers inputSize hiddenSize miniBatch s -l -i -h -b format sizes seqLength sizes numLayers sizes inputSize sizes hiddenSize sizes miniBatch OUTPUT_DIR = ~ profout nvprof_output_filename rnns params rnn_tag = - join rnns size_tag = describe_sizes params date_tag = datetime datetime now strftime m d y- H M f OUTPUT_DIR prof_ rnn_tag _ size_tag _ date_tag nvvp nvprof cmd outpath system f nvprof -o outpath cmd full_profile rnns args profile_args = k v args items profile_args append f -- k = v profile_args append f -- rnns join rnns profile_args append -- internal-run outpath = nvprof_output_filename rnns args cmd = f sys executable -m fastrnns profile join profile_args rc stdout stderr = nvprof cmd outpath rc = raise RuntimeError f stderr stderr \nstdout stdout __name__ == __main__ parser = argparse ArgumentParser description= Profile RNNs parser add_argument -- seqLength default= type=int parser add_argument -- numLayers default= type=int parser add_argument -- inputSize default= type=int parser add_argument -- hiddenSize default= type=int parser add_argument -- miniBatch default= type=int parser add_argument -- sleep-between-seconds -- sleep_between_seconds default= type=int parser add_argument -- nloops default= type=int parser add_argument -- rnns nargs= help= What run cudnn aten jit etc internal_run we actually run rnns internal_run we shell out nvprof internal_run=T parser add_argument -- internal-run -- internal_run default=False action= store_true help= Don t use args = parser parse_args args rnns None args rnns = cudnn aten jit print args args internal_run profile vars args full_profile vars args
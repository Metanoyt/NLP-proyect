mypy allow-untyped-defs argparse copy os time zipfile zipfile ZipFile pandas pd type ignore dlrm_utils get_dlrm_model get_valid_name type ignore torch torch ao pruning _experimental data_sparsifier DataNormSparsifier create_attach_sparsifier model sparse_config Create DataNormSparsifier attach model embedding layers Args model nn Module layer model needs attached sparsifier sparse_config Dict Config DataNormSparsifier Should contain following keys - sparse_block_shape - norm - sparsity_level data_norm_sparsifier = DataNormSparsifier sparse_config name parameter model named_parameters emb_l name valid_name = get_valid_name name data_norm_sparsifier add_data name=valid_name data=parameter data_norm_sparsifier save_model_states state_dict sparsified_model_dump_path save_file_name sparse_block_shape norm zip=True Dumps state_dict model Args state_dict Dict The state_dict dumped dlrm_s_pytorch py Only model state will extracted dictionary This corresponds state_dict key state_dict dictionary model_state = state_dict state_dict save_file_name str The filename path when saving model state dictionary sparse_block_shape Tuple The block shape corresponding data norm sparsifier Used creating save directory norm str type norm L L datanorm sparsifier Used creating save directory zip bool True file zip-compressed folder_name = os path join sparsified_model_dump_path str norm save model only states folder_str = f config_ sparse_block_shape model_state = state_dict state_dict model_state_path = os path join folder_name folder_str save_file_name os makedirs os path dirname model_state_path exist_ok=True torch save model_state model_state_path zip zip_path = model_state_path replace ckpt zip ZipFile zip_path w zipfile ZIP_DEFLATED zip zip write model_state_path save_file_name os remove model_state_path store zip remove uncompressed model_state_path = zip_path model_state_path = os path abspath model_state_path file_size = os path getsize model_state_path file_size = file_size size mb model_state_path file_size sparsify_model path_to_model sparsified_model_dump_path Sparsifies embedding layers dlrm model different sparsity levels norms block shapes using DataNormSparsifier The function tracks step time sparsifier size compressed checkpoint collates into csv Note This function dumps csv sparse_model_metadata csv current directory Args path_to_model str path trained criteo model ckpt file sparsity_levels List float list sparsity levels sparsified norms List str list norms sparsified sparse_block_shapes List tuples List sparse block shapes sparsified sparsity_levels = sl sl range sparsity_levels += norms = L L sparse_block_shapes = device = torch device cuda torch cuda is_available torch device cpu print Running sparsity levels - sparsity_levels print Running sparse block shapes - sparse_block_shapes print Running norms - norms orig_model = get_dlrm_model saved_state = torch load path_to_model map_location=device orig_model load_state_dict saved_state state_dict orig_model = orig_model device step_time_dict = stat_dict dict str list = norm sparse_block_shape sparsity_level step_time_sec zip_file_size path norm norms sbs sparse_block_shapes norm == L sbs == continue sl sparsity_levels model = copy deepcopy orig_model sparsifier = create_attach_sparsifier model sparse_block_shape=sbs norm=norm sparsity_level=sl t = time time sparsifier step t = time time step_time = t - t norm_sl = f norm _ sbs _ sl print f Step Time norm_sl = step_time s step_time_dict norm_sl = step_time sparsifier squash_mask saved_state state_dict = model state_dict file_name = f criteo_model_norm= norm _sl= sl ckpt state_path file_size = save_model_states saved_state sparsified_model_dump_path file_name sbs norm=norm stat_dict norm append norm stat_dict sparse_block_shape append sbs stat_dict sparsity_level append sl stat_dict step_time_sec append step_time stat_dict zip_file_size append file_size stat_dict path append state_path df = pd DataFrame stat_dict filename = sparse_model_metadata csv df to_csv filename index=False print f Saved sparsified metadata file filename __name__ == __main__ parser = argparse ArgumentParser parser add_argument -- model-path -- model_path type=str parser add_argument -- sparsified-model-dump-path -- sparsified_model_dump_path type=str args = parser parse_args sparsify_model args model_path args sparsified_model_dump_path
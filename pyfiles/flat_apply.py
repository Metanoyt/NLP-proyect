mypy allow-untyped-defs collections abc Callable dataclasses dataclass torch torch fx node torch utils _pytree pytree torch _ops HigherOrderOperator is_graphable val - bool Definition graphable type type acceptable input output type FX node isinstance val torch fx node base_types is_graphable_type typ - bool Return whether given type graphable issubclass typ torch fx node base_types to_graphable stuff Flattens stuff into flat list graphable types We can consider preserving things like List int improve perf readability right now all flattened out flat_args spec = pytree tree_flatten stuff arg flat_args is_graphable arg raise RuntimeError f Expected all pytree tree_leaves args kwargs graphable types found f non-fx-graphable type type arg If type meant constant mark f via pytree register_constant otherwise register pytree flat_args spec from_graphable flat_args spec The inverse to_graphable stuff = pytree tree_unflatten flat_args spec stuff func_to_graphable func Pack flatten function type into graphable types This useful legalizing function argument ` flat_apply ` pytree tree_flatten _ConstantFunction func dataclass frozen=True _ConstantFunction func Callable __call__ args kwargs func args kwargs pytree register_constant _ConstantFunction _op_types = torch _ops OpOverload torch _ops OpOverloadPacket torch _ops HigherOrderOperator FlatApply HigherOrderOperator __init__ - None super __init__ flat_apply __call__ func in_spec flat_args _unused Functions take non-graphable types cannot directly put into FX graph Given func args kwargs all non-graphable types pytrees then we re able store call flat_apply func in_spec flat_args FX graph The semantics flat_apply func in_spec flat_args roughly equivalent flat_apply_impl func in_spec flat_args args kwargs = pytree tree_unflatten flat_args in_spec output = func args kwargs output flat_apply supports following two cases - input type container type e g tensors registered pytree We ll tree_flatten input type store spec - input type constant type i e torch compile will specialize registered pytree register_constant The constant type goes directly into spec assert isinstance func _op_types pytree _is_constant_holder func assert len _unused == impl func in_spec flat_args impl func in_spec flat_args isinstance func _op_types assume _ConstantFunction func = pytree _retrieve_constant func assert isinstance func _ConstantFunction args kwargs = from_graphable flat_args in_spec out = func args kwargs Right now all outputs must either graphable lists tuples graphables TODO The following can updated support non-graphable outputs pytrees For non-graphable constant outputs assumption would they constant every time function runs those MUST same For pytree outputs I m sure we need flat_output spec just flat_output latter case tracers need carry out output specs they need know how reconstruct object just flat_output is_valid_output x isinstance x tuple list all map is_valid_output x is_graphable x assert is_valid_output out out flat_apply = FlatApply
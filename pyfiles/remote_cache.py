__future__ annotations atexit collections dataclasses functools json logging os sys typing abc abstractmethod typing Any Callable Generic Optional TypeVar Union typing_extensions override TypeAlias torch _dynamo utils dynamo_timed torch _inductor config torch monitor _WaitCounter try redis except ImportError redis = None type ignore assignment log = logging getLogger __name__ config is_fbcode rfe scubadata scubadata_py type ignore import-not-found Sample Sample_ Sample TypeAlias = Sample_ Sample TypeAlias = type object type ignore misc no-redef _T = TypeVar _T _U = TypeVar _U remote_fx_cache_get_timed = functools partial dynamo_timed FbRemoteFxGraphCache get phase_name= remote_fx_graph_cache_get log_pt _compile_event=False dynamo_compile_column_us= remote_fx_graph_cache_get_time_us log_waitcounter=True remote_fx_cache_put_timed = functools partial dynamo_timed FbRemoteFxGraphCache put phase_name= remote_fx_graph_cache_put log_pt _compile_event=False dynamo_compile_column_us= remote_fx_graph_cache_put_time_us log_waitcounter=True RemoteCacheBackend Generic _T A backend implementation accessing remote distributed cache Only works bytes out For structured data use RemoteCache __init__ - None _name = f backend type __name__ abstractmethod _get key str - Optional _T pass abstractmethod _put key str data _T - None pass get key str - Optional _T try value = _get key cache_stats get _name value except Exception cache_stats exception _name raise value put key str data _T - None try _put key data cache_stats put _name except Exception cache_stats exception _name raise Serde encodes _T _U decodes _U _T RemoteCacheSerde Generic _T _U abstractmethod encode data _T - _U pass abstractmethod decode data _U - _T pass JsonDataTy = Optional Union int float str bool dict str JsonDataTy list JsonDataTy RemoteCacheJsonSerde RemoteCacheSerde JsonDataTy bytes encode data JsonDataTy - bytes bytes json dumps data ascii decode data bytes - JsonDataTy json loads data RemoteCachePassthroughSerde RemoteCacheSerde _T _T encode data _T - _T data decode data _T - _T data This top RemoteCache A RemoteCache fundamentally made three parts The controller A serializer deserializer instance RemoteCacheSerde A backend instance RemoteCacheBackend To write ` put ` RemoteCache takes data uses RemoteCacheSerde convert backend passes backend Conversely when reading ` get ` RemoteCache takes data backend uses RemoteCacheSerde convert returns The RemoteCacheBackend generic _U - which type data backend can directly cache usually ` bytes ` The RemoteCacheSerde responsible converting between _T type data RemoteCache accepts ` put ` returns ` get ` _U When instantiating RemoteCache you should override directly create RemoteCache The reason when logging cache use ` TORCH_LOGS=cache ` we use concrete type RemoteCache reported cache See RemoteFxGraphCache below example RemoteCache Generic _T backend_override_cls Optional Callable RemoteCacheBackend Any = None __init__ backend RemoteCacheBackend _U serde RemoteCacheSerde _T _U - None Support testing mock out backend class-by-class basis override_cls = __class__ backend_override_cls None backend = override_cls backend = backend pyrefly ignore invalid-type-var serde = serde See cache contains ` key ` Returns ` None ` value present cache get key str - Optional _T _WaitCounter pytorch remote_cache get guard sample = _create_sample try result = _get key sample cache_stats get type __name__ result except Exception e cache_stats exception type __name__ sample sample fail_reason = str e raise finally _log_sample sample result Add ` value ` cache key ` key ` Note ` None ` valid value even _T supports because you can t tell difference between ` None ` missing cache entry put key str value _T - None _WaitCounter pytorch remote_cache put guard assert value None sample = _create_sample try _put key value sample cache_stats put type __name__ except Exception e cache_stats exception type __name__ sample sample fail_reason = str e raise finally _log_sample sample Used convert data cache into structured data _decode data _U sample Optional Sample - _T type ignore override serde decode data type ignore arg-type Used convert structured data into data cache _encode value _T sample Optional Sample - object returns _U serde encode value Get structured data cache Separate ` get ` so can overridden _get key str sample Optional Sample - Optional _T data = _backend_get key _decode data sample None Get unstructured data cache Separate ` get ` so can overridden Returns _U - we aren t actually generic _U _backend_get key str - object backend get key Put structured data into cache Separate ` put ` so can overridden _put key str value _T sample Optional Sample - None data = _encode value sample _backend_put key data Put unstructured data into cache Separate ` put ` so can overridden Takes data _U - we aren t actually generic _U _backend_put key str data object - None backend put key data Create logging Sample - used internal loggers monitor cache effectiveness _create_sample - Optional Sample None Write logging Sample logger _log_sample sample Optional Sample - None pass RedisRemoteCacheBackend RemoteCacheBackend bytes A Redis implementation remote distributed cache pyrefly ignore missing-attribute _redis Optional redis Redis = None __init__ cache_id str - None super __init__ redis raise RuntimeError redis available required remote cache TORCHINDUCTOR_REDIS_URL os environ _redis = redis Redis from_url os environ TORCHINDUCTOR_REDIS_URL _redis = redis Redis host=os environ get TORCHINDUCTOR_REDIS_HOST localhost port=int os environ get TORCHINDUCTOR_REDIS_PORT override _get key str - Optional bytes _redis Either redis wasn t found we already had some trouble None try pyrefly ignore missing-attribute value = _redis get key pyrefly ignore missing-attribute except redis exceptions ConnectionError Redis lazy doesn t actually attempt connect until first use Mark unavailable now _redis = None None In theory redis get can Awaitable well assert value None isinstance value bytes value override _put key str data bytes - None _redis Either redis wasn t found we already had some trouble try pyrefly ignore missing-attribute _redis set key data pyrefly ignore missing-attribute except redis exceptions ConnectionError Redis lazy doesn t actually attempt connect until first use Mark unavailable now _redis = None RedisRemoteCache RemoteCache JsonDataTy __init__ cache_id str - None Special test handling If we re just going override backend anyway don t require redis __class__ backend_override_cls This totally bogus works now backend = typing cast RemoteCacheBackend bytes None backend = RedisRemoteCacheBackend cache_id serde = RemoteCacheJsonSerde super __init__ backend serde version = consistency between various types keys _key_fmt = f pt cache_id key c version _get_key key str - str _key_fmt format key=key override _get key str sample Optional Sample - Optional JsonDataTy key = _get_key key super _get key sample override _put key str value JsonDataTy sample Optional Sample - None key = _get_key key super _put key value sample RemoteAutotuneCache RedisRemoteCache pass RemoteBundledAutotuneCache RedisRemoteCache pass RemoteFxGraphCache RedisRemoteCache pass RemoteAOTAutogradCache RedisRemoteCache pass RemoteDynamoPGOCache RedisRemoteCache pass create_cache key str is_fbcode bool fb_cache_cls str oss_cache_cls str - Optional RemoteCache JsonDataTy try is_fbcode torch _inductor fb remote_cache cache_cls = getattr torch _inductor fb remote_cache fb_cache_cls cache_cls key this_module = sys modules __name__ cache_cls = getattr this_module oss_cache_cls cache_cls key except Exception log warning Unable create remote cache exc_info=True None Some simple stat capture dataclasses dataclass _CacheStat miss int = hit int = put int = exception int = __str__ - str f hit hit miss miss put put exception exception _CacheStats _stats dict str _CacheStat __init__ - None _stats = collections defaultdict _CacheStat miss name str count int = - None _stats name miss += count hit name str count int = - None _stats name hit += count get name str value Optional object - None value None miss name hit name put name str count int = - None _stats name put += count exception name str count int = - None _stats name exception += count cache_stats = _CacheStats atexit register dump_cache_stats - None log isEnabledFor logging INFO io out = io StringIO cache_stats _stats print None file=out print file=out k v sorted cache_stats _stats items print f k v file=out log info Cache Metrics s out getvalue
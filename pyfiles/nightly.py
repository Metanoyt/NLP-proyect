usr bin env python Much logging code here forked https github com ezyang ghstack Copyright c Edward Z Yang ezyang mit edu r Checks out nightly development version PyTorch installs pre-built binaries into repo You can use script check out new nightly branch following $ tools nightly py checkout -b my-nightly-branch $ source venv bin activate ` \venv\Scripts\activate ` Windows Or you would like check out nightly commit detached HEAD mode $ tools nightly py checkout $ source venv bin activate ` \venv\Scripts\activate ` Windows Or you would like reuse existing virtual environment you can pass prefix argument -- prefix $ tools nightly py checkout -b my-nightly-branch -p my-env $ source my-env bin activate ` \my-env\Scripts\Activate ps ` Windows To install nightly binaries built CUDA you can pass flag -- cuda $ tools nightly py checkout -b my-nightly-branch -- cuda $ source venv bin activate ` \venv\Scripts\activate ` Windows To install nightly binaries built ROCm you can pass flag -- rocm $ tools nightly py checkout -b my-nightly-branch -- rocm $ source venv bin activate ` \venv\Scripts\activate ` Windows You can also use tool pull nightly commits into current branch well This can done $ tools nightly py pull $ source venv bin activate ` \venv\Scripts\activate ` Windows To create virtual environment specific Python interpreter you can pass -- python argument $ tools nightly py -- python path python $ source venv bin activate ` \venv\Scripts\activate ` Windows Pulling will recreate fresh virtual environment reinstall development dependencies well nightly binaries into repo directory __future__ annotations argparse atexit contextlib functools itertools json logging os re shlex shutil subprocess sys tempfile textwrap time uuid ast literal_eval collections abc Callable datetime datetime pathlib Path platform system platform_system typing Any cast NamedTuple TYPE_CHECKING TypeVar TYPE_CHECKING collections abc Generator Iterable Iterator try packaging version Version except ImportError Version = None type ignore assignment misc REPO_ROOT = Path __file__ absolute parent parent GITHUB_REMOTE_URL = https github com pytorch pytorch git PACKAGES_TO_INSTALL = torch numpy cmake ninja packaging ruff mypy pytest hypothesis ipython rich clang-format clang-tidy sphinx DEFAULT_VENV_DIR = REPO_ROOT venv LOGGER logging Logger &#124; None = None VERBOSE bool = False DATETIME_FORMAT = Y- m- d_ Hh Mm Ss SHA _RE = re compile r P sha - a-fA-F USERNAME_PASSWORD_RE = re compile r \ \ \ LOG_DIRNAME_RE = re compile r P datetime \d -\d\d-\d\d_\d\dh\d\dm\d\ds _ r P uuid - a-f - - a-f - - a-f PLATFORM = platform_system replace Darwin macOS LINUX = PLATFORM == Linux MACOS = PLATFORM == macOS WINDOWS = PLATFORM == Windows POSIX = LINUX MACOS PipSource NamedTuple name str index_url str supported_platforms set str accelerator str Generate github scripts nightly_source_matrix json GENERATE_MATRIX_SCRIPT = REPO_ROOT github scripts generate_binary_build_matrix py subprocess check_call sys executable str GENERATE_MATRIX_SCRIPT cwd=GENERATE_MATRIX_SCRIPT parent See github scripts nightly_source_matrix json NIGHTLY_SOURCE_FILE = GENERATE_MATRIX_SCRIPT with_name nightly_source_matrix json NIGHTLY_SOURCE_MATRIX = json loads NIGHTLY_SOURCE_FILE read_text encoding= utf- PIP_SOURCES = name PipSource data name data NIGHTLY_SOURCE_MATRIX items Formatter logging Formatter redactions dict str str __init__ fmt str &#124; None = None datefmt str &#124; None = None - None super __init__ fmt datefmt redactions = Remove sensitive information URLs _filter s str - str s = USERNAME_PASSWORD_RE sub r USERNAME PASSWORD s needle replace redactions items s = s replace needle replace s formatMessage record logging LogRecord - str record levelno == logging INFO record levelno == logging DEBUG Log INFO DEBUG without any adornment record getMessage I m sure why formatMessage doesn t show up even though s typeshed Python super formatMessage record format record logging LogRecord - str _filter super format record redact needle str replace str = REDACTED - None Redact specific strings e g authorization tokens This won t retroactively redact stuff you ve already leaked so make sure you redact things soon possible Don t redact empty strings will lead something looks like s REDACTED t REDACTED r REDACTED needle == redactions needle = replace contextlib contextmanager timer logger logging Logger prefix str - Iterator None Timed context manager start_time = time perf_counter yield logger info s took f s prefix time perf_counter - start_time F = TypeVar F bound=Callable Any timed prefix str - Callable F F Decorator timing functions decorator f F - F functools wraps f wrapper args Any kwargs Any - Any logger = cast logging Logger LOGGER logger info prefix timer logger prefix f args kwargs cast F wrapper decorator Venv Virtual environment manager AGGRESSIVE_UPDATE_PACKAGES = uv pip setuptools packaging wheel build uv __init__ prefix Path &#124; str pip_source PipSource base_executable Path &#124; str &#124; None = None - None base_executable = Path base_executable sys executable base_executable is_absolute base_exec = shutil which str base_executable base_exec None raise RuntimeError f Could find Python executable base_executable base_executable = Path base_exec prefix = Path prefix absolute pip_source = pip_source base_executable = base_executable absolute _executable Path &#124; None = None _bindir Path &#124; None = None _env = PIP_EXTRA_INDEX_URL pip_source index_url UV_INDEX pip_source index_url UV_PYTHON_DOWNLOADS never FORCE_COLOR CLICOLOR_FORCE is_venv - bool Check prefix virtual environment prefix is_dir prefix pyvenv cfg is_file property bindir - Path Get bin directory virtual environment assert is_venv _bindir None WINDOWS _bindir = prefix Scripts _bindir = prefix bin _bindir property executable - Path Get Python executable virtual environment assert is_venv _executable None executable = bindir python exe WINDOWS python assert executable is_file executable is_symlink assert os access executable os X_OK f executable executable _executable = executable _executable site_packages python Path &#124; str &#124; None = None - Path Get site-packages directory virtual environment output = python -c site print p p site getsitepackages python=python capture_output=True stdout pyrefly ignore no-matching-overload candidates = list map Path filter None map str strip output splitlines candidates = p p candidates p is_dir p name == site-packages candidates raise RuntimeError f No site-packages directory found executable python candidates property activate_script - Path Get activation script virtual environment WINDOWS Assume PowerShell prefix Scripts activate Assume POSIX-compliant shell Bash Zsh etc prefix bin activate property activate_command - str Get command activate virtual environment WINDOWS Assume PowerShell f activate_script Assume Bash Zsh etc POSIX standard should use dot ` venv bin activate ` rather than ` source ` f source shlex quote str activate_script timed Creating virtual environment create remove_if_exists bool = False assume_yes bool = False - Path Create virtual environment prefix exists remove_if_exists If venv directory already exists remove first is_venv raise RuntimeError f The path prefix already exists virtual environment Please remove manually choose different prefix any Path p absolute samefile prefix p sys prefix sys exec_prefix sys base_prefix sys base_exec_prefix raise RuntimeError f The path prefix trying remove same interpreter run script Please choose different prefix deactivate current virtual environment any Path base_python -c f os sys print os path abspath p capture_output=True stdout strip absolute samefile prefix p sys prefix sys exec_prefix sys base_prefix sys base_exec_prefix raise RuntimeError f The Python executable base_executable trying remove same interpreter create virtual environment Please choose different prefix different Python interpreter assume_yes answer = input f The virtual environment prefix already exists Do you want remove recreate y N answer lower y yes answer lower n no print f Invalid answer answer r print f Aborting due existing prefix prefix sys exit print f Removing existing venv prefix _remove_existing prefix raise RuntimeError f Path prefix already exists print f Creating venv Python base_python_version prefix base_python -m venv str prefix assert is_venv Failed create virtual environment prefix gitignore write_text \n encoding= utf- LINUX activate_script = activate_script st_mode = activate_script stat st_mode The activate script may read-only we need add write permissions activate_script chmod st_mode &#124; o activate_script open mode= encoding= utf- f f write \n + textwrap dedent f Add NVIDIA PyPI packages LD_LIBRARY_PATH export LD_LIBRARY_PATH= $ executable name - EOS glob itertools os site nvidia_libs = p rstrip p itertools chain from_iterable glob iglob f site_dir pattern recursive=True site_dir site getsitepackages pattern nvidia lib cu lib ld_library_path = os getenv LD_LIBRARY_PATH split os pathsep print os pathsep join dict fromkeys nvidia_libs + ld_library_path EOS strip + \n Change file mode back activate_script chmod st_mode ensure ensure - Path Ensure virtual environment exists is_venv create remove_if_exists=True python_version split = base_python_version split raise RuntimeError f Python version mismatch venv has Python python_version f base Python base_python_version Please recreate virtual environment correct Python version pip_install AGGRESSIVE_UPDATE_PACKAGES upgrade=True prefix python args str python Path &#124; str &#124; None = None popen_kwargs Any - subprocess CompletedProcess str Run Python command virtual environment python None python = executable cmd = str python args env = popen_kwargs pop env None check = popen_kwargs pop check True pyrefly ignore no-matching-overload subprocess run cmd check=check text=True encoding= utf- env= os environ _env env popen_kwargs base_python args str popen_kwargs Any - subprocess CompletedProcess str Run Python command base environment python args python=self base_executable popen_kwargs python_version python Path &#124; str &#124; None = None - str Get Python version virtual environment Return string like t d td etc python -c sys print major minor micro format sys version_info getattr sys abiflags python=python capture_output=True stdout strip base_python_version - str Get Python version base environment Return string like t d td etc python_version python=self base_executable uv args str python Path &#124; str &#124; None = None popen_kwargs Any - subprocess CompletedProcess str Run uv command virtual environment python None python = executable cmd = str bindir uv args env = popen_kwargs pop env None check = popen_kwargs pop check True pyrefly ignore no-matching-overload subprocess run cmd check=check text=True encoding= utf- env= os environ _env env UV_PYTHON str python popen_kwargs timed Installing packages uv_pip_install packages str prerelease bool = False upgrade bool = False no_deps bool = False popen_kwargs Any - subprocess CompletedProcess str Run pip install command virtual environment uv_pip_args = VERBOSE uv_pip_args append -v prerelease uv_pip_args append -- prerelease upgrade uv_pip_args append -- upgrade verb = Upgrading verb = Installing no_deps uv_pip_args append -- no-deps print f verb package s pip_source index_url package packages print f - os path basename package uv pip install uv_pip_args packages popen_kwargs pip args str popen_kwargs Any - subprocess CompletedProcess str Run pip command virtual environment python -m pip args popen_kwargs timed Installing packages pip_install packages str prerelease bool = False upgrade bool = False no_deps bool = False popen_kwargs Any - subprocess CompletedProcess str Run pip install command virtual environment pip_args = VERBOSE pip_args append -v prerelease pip_args append -- pre upgrade pip_args append -- upgrade verb = Upgrading verb = Installing no_deps pip_args append -- no-deps print f verb package s pip_source index_url package packages print f - os path basename package pip install pip_args packages popen_kwargs timed Downloading packages pip_download packages str prerelease bool = False no_deps bool = False popen_kwargs Any - list Path Download package virtual environment tmpdir = tempfile TemporaryDirectory prefix= pip-download- atexit register tmpdir cleanup tempdir = Path tmpdir name absolute print f Downloading package s pip_source index_url f join packages pip_args = VERBOSE pip_args append -v prerelease pip_args append -- pre no_deps pip_args append -- no-deps pip download f -- dest= tempdir pip_args packages popen_kwargs files = list tempdir iterdir print f Downloaded len files file s tempdir file files print f - file name files wheel args str popen_kwargs Any - subprocess CompletedProcess str Run wheel command virtual environment python -m wheel args popen_kwargs timed Unpacking wheel file wheel_unpack wheel Path &#124; str dest Path &#124; str popen_kwargs Any - subprocess CompletedProcess str Unpack wheel into directory wheel = Path wheel absolute dest = Path dest absolute assert wheel is_file wheel suffix lower == whl wheel unpack f -- dest= dest str wheel popen_kwargs contextlib contextmanager extracted_wheel wheel Path &#124; str - Generator Path Download extract wheel into temporary directory tempfile TemporaryDirectory prefix= wheel- tempdir wheel_unpack wheel tempdir subdirs = p p Path tempdir absolute iterdir p is_dir len subdirs = raise RuntimeError f Expected exactly one directory tempdir f got str d d subdirs yield subdirs git args str - list str git -C str REPO_ROOT args functools lru_cache logging_base_dir - Path base_dir = REPO_ROOT nightly log base_dir mkdir parents=True exist_ok=True base_dir functools lru_cache logging_run_dir - Path base_dir = logging_base_dir cur_dir = base_dir f datetime now strftime DATETIME_FORMAT _ uuid uuid cur_dir mkdir parents=True exist_ok=True cur_dir functools lru_cache logging_record_argv - None s = subprocess list cmdline sys argv logging_run_dir argv write_text s encoding= utf- logging_record_exception e BaseException - None text = f type e __name__ e isinstance e subprocess CalledProcessError text += f \n\nstdout e stdout \n\nstderr e stderr logging_run_dir exception write_text text encoding= utf- logging_rotate - None log_base = logging_base_dir old_logs = sorted log_base iterdir reverse=True stale_log old_logs Sanity check looks like log LOG_DIRNAME_RE fullmatch stale_log name None shutil rmtree stale_log contextlib contextmanager logging_manager debug bool = False - Generator logging Logger None None Setup logging If failure starts here we won t able save user reasonable way Logging structure there one logger root logger processes all events There two handlers stderr INFO file handler DEBUG formatter = Formatter fmt= levelname s message s datefmt= root_logger = logging getLogger pytorch-nightly root_logger setLevel logging DEBUG console_handler = logging StreamHandler debug console_handler setLevel logging DEBUG console_handler setLevel logging INFO console_handler setFormatter formatter root_logger addHandler console_handler log_file = logging_run_dir nightly log file_handler = logging FileHandler log_file file_handler setFormatter formatter root_logger addHandler file_handler logging_record_argv try logging_rotate print f log file log_file yield root_logger except Exception e logging exception Fatal exception noqa LOG logging_record_exception e print f log file log_file sys exit except BaseException e noqa B You could logging debug here suppress backtrace entirely there no reason hide technically savvy users logging info exc_info=True noqa LOG logging_record_exception e print f log file log_file sys exit check_branch subcommand str branch str &#124; None - str &#124; None Checks branch name can checked out subcommand = checkout None next check local repo clean cmd = git status -- untracked-files=no -- porcelain stdout = subprocess check_output cmd text=True encoding= utf- stdout strip Need have clean working tree checkout \n\n + stdout next check branch name doesn t already exist branch name provided branch None cmd = git show-ref -- verify -- quiet f refs heads branch p = subprocess run cmd capture_output=True check=False type ignore assignment p returncode f Branch branch r already exists None timed Installing dependencies install_packages venv Venv packages Iterable str - None Install dependencies deps environment install packages packages = list dict fromkeys packages packages venv uv_pip_install packages _ensure_commit git_sha str - None Make sure we actually have commit locally cmd = git cat-file -e git_sha + r ^ commit p = subprocess run cmd capture_output=True check=False p returncode == we have commit locally we don t have commit must fetch cmd = git fetch GITHUB_REMOTE_URL git_sha subprocess check_call cmd _nightly_version site_dir Path - str first get git version installed module version_file = site_dir torch version py version_file open encoding= utf- f line f line startswith git_version continue git_version = literal_eval line partition = strip break raise RuntimeError f Could find git_version version_file print f Found released git version git_version now cross reference nightly version _ensure_commit git_version cmd = git show -- no-patch -- format= s git_version stdout = subprocess check_output cmd text=True encoding= utf- m = SHA _RE search stdout m None raise RuntimeError f Could find nightly release git history \n stdout nightly_version = m group sha print f Found nightly release version nightly_version now checkout nightly version _ensure_commit nightly_version nightly_version timed Checking out nightly PyTorch checkout_nightly_version branch str &#124; None site_dir Path - None Gets nightly version then checks out nightly_version = _nightly_version site_dir branch None Detached mode - explicitly use -- detach flag cmd = git checkout -- detach nightly_version Branch mode cmd = git checkout -b branch nightly_version subprocess check_call cmd timed Pulling nightly PyTorch pull_nightly_version site_dir Path - None Fetches nightly version then merges nightly_version = _nightly_version site_dir cmd = git merge nightly_version subprocess check_call cmd _get_listing_linux source_dir Path - list Path list itertools chain source_dir glob so source_dir lib glob so source_dir lib glob so _get_listing_macos source_dir Path - list Path oddly these so files even Mac list itertools chain source_dir glob so source_dir lib glob dylib _get_listing_windows source_dir Path - list Path list itertools chain source_dir glob pyd source_dir lib glob lib source_dir lib glob dll _glob_pyis d Path - set str p relative_to d as_posix p d rglob pyi _find_missing_pyi source_dir Path target_dir Path - list Path source_pyis = _glob_pyis source_dir target_pyis = _glob_pyis target_dir missing_pyis = sorted source_dir p p source_pyis - target_pyis missing_pyis _get_listing source_dir Path target_dir Path - list Path LINUX listing = _get_listing_linux source_dir MACOS listing = _get_listing_macos source_dir WINDOWS listing = _get_listing_windows source_dir raise RuntimeError f Platform platform_system r recognized listing extend _find_missing_pyi source_dir target_dir listing append source_dir version py listing append source_dir testing _internal generated listing append source_dir bin listing append source_dir include listing _remove_existing path Path - None path exists path is_dir shutil rmtree path path unlink _move_single src Path source_dir Path target_dir Path mover Callable Path Path None verb str - None relpath = src relative_to source_dir trg = target_dir relpath _remove_existing trg move over new files src is_dir trg mkdir parents=True exist_ok=True root dirs files os walk src relroot = Path root relative_to src name files relname = relroot name s = src relname t = trg relname VERBOSE print f verb s - t mover s t name dirs trg relroot name mkdir parents=True exist_ok=True VERBOSE print f verb src - trg mover src trg _copy_files listing list Path source_dir Path target_dir Path - None src listing pyrefly ignore bad-argument-type _move_single src source_dir target_dir shutil copy Copying _link_files listing list Path source_dir Path target_dir Path - None src listing _move_single src source_dir target_dir os link Linking timed Moving nightly files into repo move_nightly_files site_dir Path - None Moves PyTorch files temporary installed location repo get file listing source_dir = site_dir torch target_dir = REPO_ROOT torch listing = _get_listing source_dir target_dir copy link files WINDOWS _copy_files listing source_dir target_dir try _link_files listing source_dir target_dir except Exception _copy_files listing source_dir target_dir timed Writing pytorch-nightly pth write_pth venv Venv - None Writes Python path file dir venv site_packages pytorch-nightly pth write_text This file autogenerated PyTorch s tools nightly py\n Please delete file you no longer need following development\n version PyTorch importable\n f REPO_ROOT \n encoding= utf- parse_dependencies venv Venv wheel_site_dir Path - list str Parse dependencies torch wheel s metadata dist_info_dirs = list wheel_site_dir glob dist-info len dist_info_dirs = raise RuntimeError f Expected exactly one dist-info directory wheel_site_dir f got dist_info_dirs dist_info_dir = dist_info_dirs dist_info_dir METADATA is_file raise RuntimeError f Expected METADATA file dist_info_dir does exist Use Python interpreter virtual environment instead interpreter running script so we can evaluate markers correctly dependencies = venv python -c textwrap dedent packaging metadata Metadata open METADATA encoding= utf- f metadata = Metadata from_email f read req metadata requires_dist req marker None req marker evaluate print req strip cwd=dist_info_dir capture_output=True stdout strip splitlines dep strip dep dependencies install venv Venv packages Iterable str subcommand str = checkout branch str &#124; None = None fresh_venv bool = False assume_yes bool = False - None Development install PyTorch fresh_venv print f Using existing venv venv prefix venv ensure venv create remove_if_exists=True assume_yes=assume_yes packages = p p packages p = torch downloaded_files = venv pip_download torch prerelease=True no_deps=True len downloaded_files = raise RuntimeError f Expected exactly one torch wheel got downloaded_files torch_wheel = downloaded_files torch_wheel name startswith torch- torch_wheel name endswith whl raise RuntimeError f Expected exactly one torch wheel got torch_wheel venv extracted_wheel torch_wheel wheel_site_dir dependencies = parse_dependencies venv wheel_site_dir install_packages venv dependencies packages subcommand == checkout checkout_nightly_version branch wheel_site_dir subcommand == pull pull_nightly_version wheel_site_dir raise ValueError f Subcommand subcommand must one checkout pull move_nightly_files wheel_site_dir write_pth venv cast logging Logger LOGGER info ------- \n PyTorch Development Environment set up \n Please activate enable environment \n\n $ s\n venv activate_command make_parser - argparse ArgumentParser find_executable name str - Path executable = shutil which name executable None raise argparse ArgumentTypeError f Could find executable name PATH Path executable absolute parser = argparse ArgumentParser subcommands subcmd = parser add_subparsers dest= subcmd help= subcommand execute checkout = subcmd add_parser checkout help= checkout new branch checkout add_argument -b -- branch help= Branch name checkout omitted checks out detached HEAD mode dest= branch default=None metavar= NAME pull = subcmd add_parser pull help= pulls nightly commits into current branch general arguments subparsers = checkout pull subparser subparsers subparser add_argument -- python -- base-executable type=find_executable help= Path Python interpreter use creating virtual environment Defaults interpreter running script dest= base_executable default=None metavar= PYTHON subparser add_argument -- prefix -p type=lambda p Path p absolute help= Path virtual environment directory e g venv dest= prefix default=str DEFAULT_VENV_DIR metavar= PATH subparser add_argument -- fresh help= Remove existing virtual environment exists dest= fresh default=False action= store_true subparser add_argument -- yes -y help= Automatic yes prompts assume yes answer all prompts e g removing existing venv dest= yes default=False action= store_true subparser add_argument -- verbose -v help= Provide debugging info dest= verbose default=False action= store_true subparser add_argument -- cuda help= CUDA version install defaults latest version available platform dest= cuda nargs= default=argparse SUPPRESS metavar= VERSION subparser add_argument -- rocm help= ROCm version install defaults latest version available platform dest= rocm nargs= default=argparse SUPPRESS metavar= VERSION parser parse_arguments - argparse Namespace parser = make_parser args = parser parse_args args branch = getattr args branch None hasattr args cuda hasattr args rocm parser error Cannot specify both CUDA ROCm versions args main - None Main entry point global LOGGER VERBOSE args = parse_arguments VERBOSE = args verbose status = check_branch args subcmd args branch status sys exit status pip_source = None toolkit CUDA ROCm accel = toolkit lower hasattr args accel requested = getattr args accel available_sources = src name len f accel - src src PIP_SOURCES values src name startswith f accel - PLATFORM src supported_platforms available_sources print f No toolkit versions available platform PLATFORM sys exit requested None pip_source = available_sources get requested pip_source None print f toolkit requested available platform PLATFORM f Available version s join sorted available_sources key=Version sys exit pip_source = available_sources max available_sources key=Version pip_source None pip_source = PIP_SOURCES cpu always available logging_manager debug=args verbose logger LOGGER = logger venv = Venv prefix=args prefix pip_source=pip_source base_executable=args base_executable install venv=venv packages=PACKAGES_TO_INSTALL subcommand=args subcmd branch=args branch fresh_venv=args fresh assume_yes=args yes __name__ == __main__ main
Owner s oncall r p Copyright c Facebook Inc its affiliates All rights reserved This source code licensed under BSD-style license found LICENSE file root directory source tree os tempfile base b encode collections abc Callable datetime timedelta typing cast ClassVar unittest mock TestCase rendezvous_backend_test RendezvousBackendTestMixin torch distributed FileStore TCPStore torch distributed elastic rendezvous RendezvousConnectionError RendezvousError RendezvousParameters torch distributed elastic rendezvous c d_rendezvous_backend C dRendezvousBackend create_backend torch distributed elastic utils distributed get_free_port TCPStoreBackendTest TestCase RendezvousBackendTestMixin _store ClassVar TCPStore classmethod setUpClass cls - None cls _store = TCPStore localhost is_master=True type ignore call-arg setUp - None Make sure we have clean slate _store delete_key torch rendezvous dummy_run_id _backend = C dRendezvousBackend _store dummy_run_id _corrupt_state - None _store set torch rendezvous dummy_run_id non_base FileStoreBackendTest TestCase RendezvousBackendTestMixin _store ClassVar FileStore setUp - None _ path = tempfile mkstemp _path = path Currently filestore doesn t implement delete_key method so new filestore has initialized every test order have clean slate _store = FileStore path _backend = C dRendezvousBackend _store dummy_run_id tearDown - None os remove _path _corrupt_state - None _store set torch rendezvous dummy_run_id non_base CreateBackendTest TestCase setUp - None For testing default parameters used tcp If test uses parameters file store we set _params _params_filestore port = get_free_port _params = RendezvousParameters backend= dummy_backend endpoint=f localhost port run_id= dummy_run_id min_nodes= max_nodes= is_host= true store_type= tCp read_timeout= _ tmp_path = tempfile mkstemp Parameters filestore testing _params_filestore = RendezvousParameters backend= dummy_backend endpoint=tmp_path run_id= dummy_run_id min_nodes= max_nodes= store_type= fIlE _expected_endpoint_file = tmp_path _expected_temp_dir = tempfile gettempdir _expected_endpoint_host = localhost _expected_endpoint_port = port _expected_store_type = TCPStore _expected_read_timeout = timedelta seconds= tearDown - None os remove _expected_endpoint_file _run_test_with_store store_type str test_to_run Callable Use function specify store type use test If used test will default TCPStore store_type == file _params = _params_filestore _expected_store_type = FileStore _expected_read_timeout = timedelta seconds= test_to_run _assert_create_backend_returns_backend - None backend store = create_backend _params assertEqual backend name c d assertIsInstance store _expected_store_type typecast_store = cast _expected_store_type store assertEqual typecast_store timeout _expected_read_timeout type ignore attr-defined _expected_store_type == TCPStore assertEqual typecast_store host _expected_endpoint_host type ignore attr-defined assertEqual typecast_store port _expected_endpoint_port type ignore attr-defined _expected_store_type == FileStore _params endpoint assertEqual typecast_store path _expected_endpoint_file type ignore attr-defined assertTrue typecast_store path startswith _expected_temp_dir type ignore attr-defined backend set_state b dummy_state state = store get torch rendezvous + _params run_id assertEqual state b encode b dummy_state test_create_backend_returns_backend - None store_type tcp file subTest store_type=store_type _run_test_with_store store_type _assert_create_backend_returns_backend test_create_backend_returns_backend_if_is_host_is_false - None TCPStore type ignore call-arg _expected_endpoint_host _expected_endpoint_port is_master=True _params config is_host = false _assert_create_backend_returns_backend test_create_backend_returns_backend_if_is_host_is_not_specified - None del _params config is_host _assert_create_backend_returns_backend test_create_backend_returns_backend_if_is_host_is_not_specified_and_store_already_exists - None TCPStore type ignore call-arg _expected_endpoint_host _expected_endpoint_port is_master=True del _params config is_host _assert_create_backend_returns_backend test_create_backend_returns_backend_if_endpoint_port_is_not_specified - None patch default port pass endpoint no port specified mock patch torch distributed elastic rendezvous c d_rendezvous_backend DEFAULT_PORT _expected_endpoint_port _params endpoint = _expected_endpoint_host _assert_create_backend_returns_backend test_create_backend_returns_backend_if_endpoint_file_is_not_specified - None _params_filestore endpoint = _run_test_with_store file _assert_create_backend_returns_backend test_create_backend_returns_backend_if_store_type_is_not_specified - None del _params config store_type _expected_store_type = TCPStore _params get read_timeout _expected_read_timeout = timedelta seconds= _assert_create_backend_returns_backend test_create_backend_returns_backend_if_read_timeout_is_not_specified - None del _params config read_timeout _expected_read_timeout = timedelta seconds= _assert_create_backend_returns_backend test_create_backend_raises_error_if_store_is_unreachable - None _params config is_host = false _params config read_timeout = assertRaisesRegex RendezvousConnectionError r ^The connection C d store has failed See inner exception details $ create_backend _params test_create_backend_raises_error_if_endpoint_is_invalid - None is_host True False subTest is_host=is_host _params config is_host = str is_host _params endpoint = dummy_endpoint assertRaisesRegex RendezvousConnectionError r ^The connection C d store has failed See inner exception r details $ create_backend _params test_create_backend_raises_error_if_store_type_is_invalid - None _params config store_type = dummy_store_type assertRaisesRegex ValueError r ^Invalid store type given Currently only supports file tcp $ create_backend _params test_create_backend_raises_error_if_read_timeout_is_invalid - None read_timeout - subTest read_timeout=read_timeout _params config read_timeout = read_timeout assertRaisesRegex ValueError r ^The read timeout must positive integer $ create_backend _params mock patch tempfile mkstemp test_create_backend_raises_error_if_tempfile_creation_fails tempfile_mock - None tempfile_mock side_effect = OSError test error Set endpoint empty so defaults creating temp file _params_filestore endpoint = assertRaisesRegex RendezvousError r The file creation C d store has failed See inner exception details create_backend _params_filestore mock patch torch distributed elastic rendezvous c d_rendezvous_backend FileStore test_create_backend_raises_error_if_file_path_is_invalid filestore_mock - None filestore_mock side_effect = RuntimeError test error _params_filestore endpoint = bad file path assertRaisesRegex RendezvousConnectionError r ^The connection C d store has failed See inner exception r details $ create_backend _params_filestore
mypy allow-untyped-defs This module contains utility method mobile model optimization lint torch enum Enum torch _C _MobileOptimizerType MobileOptimizerType typing Optional AnyStr LintCode Enum BUNDLED_INPUT = REQUIRES_GRAD = DROPOUT = BATCHNORM = optimize_for_mobile script_module torch jit ScriptModule optimization_blocklist Optional set MobileOptimizerType = None preserved_methods Optional list AnyStr = None backend str = CPU - torch jit RecursiveScriptModule Optimize torch script module mobile deployment Args script_module An instance torch script module type ScriptModule optimization_blocklist A set type MobileOptimizerType When set passed optimization method will run all optimizer pass otherwise optimizer method will run optimization pass included inside optimization_blocklist preserved_methods A list methods needed preserved when freeze_module pass invoked backend Device type use running result model CPU default Vulkan Metal Returns A new optimized torch script module isinstance script_module torch jit ScriptModule raise TypeError f Got type script_module ScriptModule expected optimization_blocklist None optimization_blocklist = set preserved_methods None preserved_methods = Convert potential byte arrays into strings there any pass type checking Here we use new name assigning back preserved_methods will invoke mypy errors i e List AnyStr = List str preserved_methods_str list str = str method method preserved_methods bundled_inputs_attributes = _get_bundled_inputs_preserved_attributes script_module preserved_methods_str all hasattr script_module method method bundled_inputs_attributes preserved_methods_str = list set preserved_methods_str + bundled_inputs_attributes non_exist_methods = method method preserved_methods_str hasattr script_module method non_exist_methods raise AttributeError f The following methods preserve do exist script_module join non_exist_methods backend = backend lower backend == cpu optimized_cpp_module = torch _C _jit_pass_optimize_for_mobile script_module _c optimization_blocklist preserved_methods_str backend == vulkan optimized_cpp_module = torch _C _jit_pass_vulkan_optimize_for_mobile script_module _c optimization_blocklist preserved_methods_str backend == metal optimized_cpp_module = torch _C _jit_pass_metal_optimize_for_mobile script_module _c preserved_methods_str raise TypeError Unknown backend must one CPU Vulkan Metal torch jit _recursive wrap_cpp_module optimized_cpp_module generate_mobile_module_lints script_module torch jit ScriptModule Generate list lints given torch script module Args script_module An instance torch script module type ScriptModule Returns lint_map A list dictionary contains modules lints isinstance script_module torch jit ScriptModule raise TypeError f Got type script_module ScriptModule expected lint_list = hasattr script_module _generate_bundled_inputs_for_forward lint_list append name LintCode BUNDLED_INPUT name message No bundled input forward please add bundled inputs before saving module using torch utils bundled_inputs augment_model_with_bundled_inputs name param script_module named_parameters param requires_grad lint_list append name LintCode REQUIRES_GRAD name message f Param name requires grad please set torch no_grad reduce memory usage improve computation speed during inference phase op_names = torch jit export_opnames script_module op_name op_names dropout op_name lint_list append name LintCode DROPOUT name message f Operator op_name exists remember call eval before saving module call torch utils mobile_optimizer optimize_for_mobile drop dropout operator batch_norm op_name lint_list append name LintCode BATCHNORM name message f Operator op_name exists remember call eval before saving module call torch utils mobile_optimizer optimize_for_mobile drop batch_norm operator lint_list _get_bundled_inputs_preserved_attributes script_module torch jit ScriptModule preserved_methods list str - list str bundled_inputs_attributes = Has bundled inputs forward hasattr script_module get_all_bundled_inputs bundled_inputs_attributes append get_all_bundled_inputs bundled_inputs_attributes append get_num_bundled_inputs Bundled inputs module after change introduced bundled inputs multiple functions hasattr script_module get_bundled_inputs_functions_and_info bundled_inputs_attributes append get_bundled_inputs_functions_and_info all_info = script_module get_bundled_inputs_functions_and_info function_name all_info function_name preserved_methods bundled_inputs_attributes append function_name bundled_inputs_attributes append get_all_bundled_inputs_for_ + function_name bundled_inputs_attributes append _bundled_inputs_deflated_ + function_name bundled_inputs_attributes
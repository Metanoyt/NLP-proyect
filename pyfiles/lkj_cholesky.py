mypy allow-untyped-defs This closely follows implementation NumPyro https github com pyro-ppl numpyro Original copyright notice Copyright Contributors Pyro project SPDX-License-Identifier Apache- math typing Optional Union torch torch Tensor torch distributions Beta constraints torch distributions distribution Distribution torch distributions utils broadcast_all __all__ = LKJCholesky LKJCholesky Distribution r LKJ distribution lower Cholesky factor correlation matrices The distribution controlled ` ` concentration ` ` parameter math ` \eta ` make probability correlation matrix math ` M ` generated Cholesky factor proportional math ` \det M ^ \eta - ` Because when ` ` concentration == ` ` we have uniform distribution over Cholesky factors correlation matrices L ~ LKJCholesky dim concentration X = L L ~ LKJCorr dim concentration Note distribution samples Cholesky factor correlation matrices correlation matrices themselves thereby differs slightly derivations ` LKJCorr ` distribution For sampling uses Onion method Section Example xdoctest +IGNORE_WANT non-deterministic l = LKJCholesky l sample l l T sample correlation x matrix tensor - Args dimension dim dimension matrices concentration float Tensor concentration shape parameter distribution often referred eta References ` Generating random correlation matrices based vines extended onion method ` Daniel Lewandowski Dorota Kurowicka Harry Joe Journal Multivariate Analysis j jmva pyrefly ignore bad-override arg_constraints = concentration constraints positive support = constraints corr_cholesky __init__ dim int concentration Union Tensor float = validate_args Optional bool = None - None dim raise ValueError f Expected dim integer greater than equal Found dim= dim dim = dim concentration = broadcast_all concentration batch_shape = concentration size event_shape = torch Size dim dim This used draw vectorized samples beta distribution Sec marginal_conc = concentration + dim - offset = torch arange dim - dtype=self concentration dtype device=self concentration device offset = torch cat offset new_zeros offset beta_conc = offset + beta_conc = marginal_conc unsqueeze - - offset _beta = Beta beta_conc beta_conc super __init__ batch_shape event_shape validate_args expand batch_shape _instance=None new = _get_checked_instance LKJCholesky _instance batch_shape = torch Size batch_shape new dim = dim new concentration = concentration expand batch_shape new _beta = _beta expand batch_shape + dim super LKJCholesky new __init__ batch_shape event_shape validate_args=False new _validate_args = _validate_args new sample sample_shape=torch Size This uses Onion method there few differences Sec - This vectorizes loop also works heterogeneous eta - Same algorithm generalizes n= - The procedure simplified since we sampling cholesky factor correlation matrix instead correlation matrix itself As such we only need generate ` w ` y = _beta sample sample_shape unsqueeze - u_normal = torch randn _extended_shape sample_shape dtype=y dtype device=y device tril - u_hypersphere = u_normal u_normal norm dim=- keepdim=True Replace NaNs first row u_hypersphere fill_ w = torch sqrt y u_hypersphere Fill diagonal elements clamp numerical stability eps = torch finfo w dtype tiny diag_elems = torch clamp - torch sum w dim=- min=eps sqrt w += torch diag_embed diag_elems w log_prob value See https mc-stan org docs _ functions-reference cholesky-lkj-correlation-distribution html The probability correlation matrix proportional determinant concentration - = prod L_ii ^ concentration - Additionally Jacobian transformation Cholesky factor correlation matrix prod L_ii ^ D - i So probability Cholesky factor proportional prod L_ii ^ concentration - + D - i = prod L_ii ^ order_i order_i = concentration - + D - i _validate_args _validate_sample value diag_elems = value diagonal dim =- dim =- order = torch arange dim + device=self concentration device order = concentration - unsqueeze - + dim - order unnormalized_log_pdf = torch sum order diag_elems log dim=- Compute normalization constant page dm = dim - alpha = concentration + dm denominator = torch lgamma alpha dm numerator = torch mvlgamma alpha - dm pi_constant D D - log pi pi_constant multigammaln D - D - log pi hence we need add pi_constant = D - log pi pi_constant = dm math log math pi normalize_term = pi_constant + numerator - denominator unnormalized_log_pdf - normalize_term
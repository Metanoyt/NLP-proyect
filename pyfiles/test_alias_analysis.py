Owner s oncall jit torch torch _C parse_ir torch testing _internal common_utils raise_on_run_directly TemporaryFileName torch testing _internal jit_utils JitTestCase TestAliasAnalysis JitTestCase test_becomes_wildcard_annotations graph_str = graph Tensor b Tensor NoneType = prim Constant int = prim Constant value= int = prim Constant value= x Tensor = aten add b y Tensor = aten split x graph = parse_ir graph_str alias_db = graph alias_db split_node = graph findNode aten split split input enters wildcard set list initialized containing wildcard set assertTrue alias_db may_contain_alias next split_node inputs split_node output because x enters wildcard set now aliases other members wildcard set graph inputs assertTrue alias_db may_contain_alias next split_node inputs next graph inputs test_nested_list_construct_not_wildcard torch jit script foo x y = torch rand y graph = foo graph graph alias_db alias_db = graph alias_db ten_construct = graph findNode aten rand output output = next graph outputs assertTrue alias_db may_contain_alias ten_construct output assertFalse alias_db may_contain_alias next graph inputs ten_construct test_recursive_calls torch jit script foo x y x add_ x + y torch jit script caller = torch rand b = torch ones out = foo b c = torch rand d = torch ones out = foo d c out out isFrozen = False descend_function_calls = True alias_db = caller graph alias_db isFrozen descend_function_calls func_calls = caller graph findAllNodes prim CallFunction assertEqual len func_calls node func_calls inps = list node inputs assertTrue alias_db has_writers inps assertFalse alias_db has_writers inps Mod torch nn Module forward = torch rand b = torch ones out = foo b c = torch rand d = torch ones out = foo d c out out foo x y x add_ x + y mod = torch jit script Mod alias_db = mod graph alias_db isFrozen descend_function_calls func_calls = mod graph findAllNodes prim CallMethod assertEqual len func_calls node func_calls inps = list node inputs assertTrue alias_db has_writers inps assertFalse alias_db has_writers inps test_multiple_compilation_units This repro internal issue we saw Here we have large number modules each same name MyModuleCUTest AliasDB uses some hash tables hash types each these modules identical because they have different compilation units they have same name Therefore we hash only module name which we previously did we will have hash collisions all these module types flat_hash_map has very bad performance exponential hash collision behavior This OOMs prior fix N = MultiTmpFile __init__ N N = N ctxs = TemporaryFileName mode= w suffix= py _ range N __enter__ x __enter__ x ctxs __exit__ exc_type exc_value traceback x __exit__ exc_type exc_value traceback x ctxs ModuleWrapper torch nn Module __init__ module_list super __init__ module_list = module_list forward x mod module_list x = mod x x MultiTmpFile N fnames module_list = torch nn ModuleList global MyModuleCUTest MyModuleCUTest torch nn Module forward x x + fname fnames mod = torch jit script MyModuleCUTest torch jit save mod fname loaded_mod = torch jit load fname module_list append loaded_mod mod = ModuleWrapper module_list mod = torch jit script mod mod torch zeros __name__ == __main__ raise_on_run_directly test test_jit py
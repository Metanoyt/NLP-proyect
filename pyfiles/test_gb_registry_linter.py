mypy ignore-errors json shutil unittest pathlib Path tools linter adapters gb_registry_linter check_registry_sync LINTER_CODE LintMessage LintSeverity TestGraphBreakRegistryLinter unittest TestCase Test graph break registry linter functionality setUp script_dir = Path __file__ resolve test_data_dir = script_dir parent graph_break_registry_linter_testdata test_data_dir mkdir parents=True exist_ok=True registry_path = test_data_dir graph_break_test_registry json open registry_path w f json dump f callsite_file = test_data_dir callsite_test py callsite_content = torch _dynamo exc unimplemented_v test unimplemented_v gb_type= testing context= testing explanation= testing hints= testing open callsite_file w f f write callsite_content tearDown test_data_dir exists shutil rmtree test_data_dir test_case _new_gb_type Test Case Adding completely new gb_type empty registry open registry_path f original_content = f read messages = check_registry_sync test_data_dir registry_path expected_registry = GB Gb_type testing Context testing Explanation testing Hints testing expected_replacement = json dumps expected_registry indent= ensure_ascii=False + \n expected_msg = LintMessage path=str registry_path line=None char=None code=LINTER_CODE severity=LintSeverity WARNING name= Registry sync needed original=original_content replacement=expected_replacement description= Registry sync needed added new gb_types Run ` lintrunner -a ` apply changes assertEqual messages expected_msg messages messages replacement open registry_path w f f write messages replacement messages_after_fix = check_registry_sync test_data_dir registry_path assertEqual len messages_after_fix Should have no messages after applying fix test_case _rename_gb_type Test Case Renaming gb_type while keeping other content same registry_data = GB Gb_type testing Context testing Explanation testing Hints testing open registry_path w f json dump registry_data f indent= renamed_callsite_content = torch _dynamo exc unimplemented_v test unimplemented_v gb_type= renamed_testing context= testing explanation= testing hints= testing open callsite_file w f f write renamed_callsite_content open registry_path f original_content = f read messages = check_registry_sync test_data_dir registry_path expected_registry = GB Gb_type renamed_testing Context testing Explanation testing Hints testing Gb_type testing Context testing Explanation testing Hints testing expected_replacement = json dumps expected_registry indent= ensure_ascii=False + \n expected_msg = LintMessage path=str registry_path line=None char=None code=LINTER_CODE severity=LintSeverity WARNING name= Registry sync needed original=original_content replacement=expected_replacement description= Registry sync needed renamed testing â†’ renamed_testing Run ` lintrunner -a ` apply changes assertEqual messages expected_msg messages messages replacement open registry_path w f f write messages replacement messages_after_fix = check_registry_sync test_data_dir registry_path assertEqual len messages_after_fix Should have no messages after applying fix test_case _content_change Test Case Changing content existing gb_type registry_data = GB Gb_type testing Context old_context Explanation old_explanation Hints old_hint open registry_path w f json dump registry_data f indent= updated_callsite_content = torch _dynamo exc unimplemented_v test unimplemented_v gb_type= testing context= new_context explanation= new_explanation hints= new_hint open callsite_file w f f write updated_callsite_content open registry_path f original_content = f read messages = check_registry_sync test_data_dir registry_path expected_registry = GB Gb_type testing Context new_context Explanation new_explanation Hints new_hint Gb_type testing Context old_context Explanation old_explanation Hints old_hint expected_replacement = json dumps expected_registry indent= ensure_ascii=False + \n expected_msg = LintMessage path=str registry_path line=None char=None code=LINTER_CODE severity=LintSeverity WARNING name= Registry sync needed original=original_content replacement=expected_replacement description= Registry sync needed Run ` lintrunner -a ` apply changes assertEqual messages expected_msg messages messages replacement open registry_path w f f write messages replacement messages_after_fix = check_registry_sync test_data_dir registry_path assertEqual len messages_after_fix Should have no messages after applying fix test_case _no_changes Test Case Ensuring no message produced when registry sync registry_data = GB Gb_type testing Context testing Explanation testing Hints testing open registry_path w f json dump registry_data f indent= messages = check_registry_sync test_data_dir registry_path assertEqual len messages Should have no messages when registry already sync test_case _new_gbid_on_full_change Test Case A completely new entry should get new GB ID registry_data = GB Gb_type original_testing Context original_context Explanation original_explanation Hints original_hint open registry_path w f json dump registry_data f indent= new_callsite_content = torch _dynamo exc unimplemented_v test unimplemented_v gb_type= completely_new_testing context= completely_new_context explanation= completely_new_explanation hints= completely_new_hint open callsite_file w f f write new_callsite_content open registry_path f original_content = f read messages = check_registry_sync test_data_dir registry_path expected_registry = GB Gb_type original_testing Context original_context Explanation original_explanation Hints original_hint GB Gb_type completely_new_testing Context completely_new_context Explanation completely_new_explanation Hints completely_new_hint expected_replacement = json dumps expected_registry indent= ensure_ascii=False + \n expected_msg = LintMessage path=str registry_path line=None char=None code=LINTER_CODE severity=LintSeverity WARNING name= Registry sync needed original=original_content replacement=expected_replacement description= Registry sync needed added new gb_types Run ` lintrunner -a ` apply changes assertEqual messages expected_msg Apply fix verify file s final state messages messages replacement open registry_path w f f write messages replacement messages_after_fix = check_registry_sync test_data_dir registry_path assertEqual len messages_after_fix Should have no messages after applying fix test_case _dynamic_hints_from_variable Test Case Verifies hints can unpacked imported variable mock_hints_file = test_data_dir graph_break_hints py init_py = test_data_dir __init__ py try supportable_string = It may possible write Dynamo tracing rules code Please report issue PyTorch you encounter graph break often causing performance issues mock_hints_content = f SUPPORTABLE = supportable_string open mock_hints_file w f f write mock_hints_content init_py touch dynamic_hints_callsite = torch _dynamo exc unimplemented_v torch _dynamo graph_break_hints test unimplemented_v gb_type= testing_with_graph_break_hints context= testing_with_graph_break_hints explanation= testing_with_graph_break_hints hints= graph_break_hints SUPPORTABLE open callsite_file w f f write dynamic_hints_callsite open registry_path f original_content = f read messages = check_registry_sync test_data_dir registry_path expected_registry = GB Gb_type testing_with_graph_break_hints Context testing_with_graph_break_hints Explanation testing_with_graph_break_hints Hints supportable_string expected_replacement = json dumps expected_registry indent= ensure_ascii=False + \n expected_msg = LintMessage path=str registry_path line=None char=None code=LINTER_CODE severity=LintSeverity WARNING name= Registry sync needed original=original_content replacement=expected_replacement description= Registry sync needed added new gb_types Run ` lintrunner -a ` apply changes assertEqual messages expected_msg messages messages replacement open registry_path w f f write messages replacement messages_after_fix = check_registry_sync test_data_dir registry_path assertEqual len messages_after_fix Should have no messages after applying fix finally mock_hints_file unlink init_py unlink __name__ == __main__ unittest main
Owner s oncall pt torch torch _prims debug_prims load_tensor_reader torch _subclasses fake_tensor FakeTensor FakeTensorMode torch multiprocessing reductions StorageWeakRef torch testing _internal common_device_type instantiate_device_type_tests torch testing _internal common_utils run_tests TemporaryDirectoryName TestCase torch utils _content_store ContentStoreReader ContentStoreWriter hash_storage TestContentStore TestCase test_basic device setup test data x = torch randn device=device y = torch randn device=device z = x view start writing TemporaryDirectoryName loc writer = ContentStoreWriter loc writer write_tensor x x writer write_tensor y y writer write_tensor z z do some mutation VC UNTRACKED x data add_ writer write_tensor x x writer write_tensor y y writer write_tensor z z del writer reader = ContentStoreReader loc n_x = reader read_tensor x n_y = reader read_tensor y n_z = reader read_tensor z assertEqual n_x + x assertEqual n_y y assertEqual n_z + z assertEqual StorageWeakRef n_x untyped_storage StorageWeakRef n_z untyped_storage n_x = reader read_tensor x n_y = reader read_tensor y n_z = reader read_tensor z assertEqual n_x x assertEqual n_y y assertEqual n_z z assertEqual StorageWeakRef n_y untyped_storage StorageWeakRef n_y untyped_storage test_scalar device Should raise error hash_storage torch tensor device=device untyped_storage torch _dynamo config patch recompile_limit= test_repeated_hash device Test repeated hashing doesn t trigger recompile dynamo If does we will execute prims xor_sum eager which fails _ range hash_storage torch tensor device=device untyped_storage test_load_tensor device TemporaryDirectoryName loc writer = ContentStoreWriter loc x = torch randn device=device same_meta_as_x t assertEqual t size x size assertEqual t stride x stride assertEqual t dtype x dtype assertEqual t device x device writer write_tensor x x load_tensor_reader loc x = torch ops debugprims load_tensor default x dtype=torch float device=device assertEqual x x x = torch ops debugprims load_tensor default x dtype=torch float device=device assertEqual x x Must alias assertNotEqual StorageWeakRef x untyped_storage StorageWeakRef x untyped_storage assertNotEqual StorageWeakRef x untyped_storage StorageWeakRef x untyped_storage Check fake tensor mode works too FakeTensorMode x = torch ops debugprims load_tensor default x dtype=torch float device=device assertIsInstance x FakeTensor same_meta_as_x x Check fp works non-MPS platforms since MPS doesn t currently support fp device startswith mps x = torch ops debugprims load_tensor default x dtype=torch float device=device assertEqual x float x assertEqual x dtype torch float x = torch ops debugprims load_tensor default x dtype=torch float device=device same_meta_as_x x instantiate_device_type_tests TestContentStore globals allow_mps=True allow_xpu=True __name__ == __main__ run_tests
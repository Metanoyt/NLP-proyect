__future__ annotations itertools re textwrap typing TYPE_CHECKING TYPE_CHECKING collections abc Mapping Sequence match $ identifier $ identifier replace value env If identifier beginning whitespace line its value list then treated block substitution indenting depth putting each element list its own line identifier line starting non-whitespace list then comma separated $ foo will insert comma before list list empty $ foo will insert one after CodeTemplate substitution_str = r ^ ^\n\S \$ ^\d\W \w &#124; \ ^\d\W \w \ substitution = re compile substitution_str re MULTILINE pattern str filename str staticmethod from_file filename str - CodeTemplate open filename f CodeTemplate f read filename __init__ pattern str filename str = - None pattern = pattern filename = filename substitute env Mapping str object &#124; None = None kwargs object - str env None env = lookup v str - object assert env None kwargs v v kwargs env v indent_lines indent str v Sequence object - str content = \n join itertools chain from_iterable str e splitlines e v content = textwrap indent content prefix=indent Remove trailing whitespace each line \n join map str rstrip content splitlines rstrip replace match re Match str - str indent = match group key = match group comma_before = comma_after = key == key = key - key == comma_before = key = key key - == comma_after = key = key - v = lookup key indent None isinstance v list v = v indent_lines indent v isinstance v list middle = join str x x v len v == middle comma_before + middle + comma_after str v substitution sub replace pattern __name__ == __main__ c = CodeTemplate \ int foo $ args $ bar $ bar $ a+$ b int commatest int a$ stuff int notest int a$ empty print c substitute args= hi bar= what a= b= stuff= things others empty=
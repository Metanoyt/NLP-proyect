Owner s module onnx Unit LLM tests onnx dynamo exporter __future__ annotations typing Any transformers torch torch onnx _internal exporter _testing onnx_testing torch testing _internal common_utils DynamoExporterHfModelsTest common_utils TestCase export model args= kwargs=None options - torch onnx ONNXProgram onnx_program = torch onnx export model args kwargs=kwargs dynamo=True fallback=False verbose=False options assert onnx_program None onnx_program test_onnx_export_huggingface_llm_models_with_kv_cache model kwargs dynamic_axes input_names output_names = _prepare_llm_model_gptj_to_test onnx_program = export model kwargs=kwargs input_names=input_names output_names=output_names dynamic_axes=dynamic_axes onnx_testing assert_onnx_program onnx_program test_onnx_export_with_custom_axis_names_in_dynamic_shapes model kwargs _ input_names output_names = _prepare_llm_model_gptj_to_test dynamic_shapes = input_ids batch_size sequence_length past_key_values batch_size past_sequence_length batch_size past_sequence_length batch_size past_sequence_length batch_size past_sequence_length batch_size past_sequence_length batch_size past_sequence_length batch_size past_sequence_length batch_size past_sequence_length batch_size past_sequence_length batch_size past_sequence_length attention_mask batch_size masked_sequence_length position_ids batch_size sequence_length onnx_program = export model kwargs=kwargs input_names=input_names output_names=output_names dynamic_shapes=dynamic_shapes optimize=False onnx_testing assert_onnx_program onnx_program Check dynamic axes correctly set ONNX model dim custom_name zip onnx_program model graph inputs shape dynamic_shapes input_ids values assertEqual dim value custom_name idx range shape_value = dim isinstance dim int dim value dim onnx_program model graph inputs idx shape assertEqual shape_value batch_size past_sequence_length dim custom_name zip onnx_program model graph inputs shape dynamic_shapes attention_mask values assertEqual dim value custom_name dim custom_name zip onnx_program model graph inputs shape dynamic_shapes position_ids values assertEqual dim value custom_name _prepare_llm_model_gptj_to_test - tuple torch nn Module dict str Any dict str dict int str list str list str model = transformers GPTJForCausalLM from_pretrained hf-internal-testing tiny-random-gptj batch_size = input_seq_len = mask_seq_len = active_prob = vocab_size = Generate random input_ids values between vocab_size- input_ids = torch randint vocab_size batch_size input_seq_len Generate random attention_mask values where indicates active token attention_mask = torch bernoulli torch full batch_size mask_seq_len active_prob int position_ids = torch tensor past_key_values = torch randn torch randn torch randn torch randn torch randn torch randn torch randn torch randn torch randn torch randn kwargs = input_ids input_ids past_key_values past_key_values attention_mask attention_mask position_ids position_ids dynamic_axes = input_ids batch_size sequence_length past_key_values key batch_size past_sequence_length past_key_values value batch_size past_sequence_length past_key_values key batch_size past_sequence_length past_key_values value batch_size past_sequence_length past_key_values key batch_size past_sequence_length past_key_values value batch_size past_sequence_length past_key_values key batch_size past_sequence_length past_key_values value batch_size past_sequence_length past_key_values key batch_size past_sequence_length past_key_values value batch_size past_sequence_length attention_mask batch_size past_sequence_length + sequence_length position_ids batch_size sequence_length logits batch_size sequence_length present key batch_size past_sequence_length + sequence_length present value batch_size past_sequence_length + sequence_length present key batch_size past_sequence_length + sequence_length present value batch_size past_sequence_length + sequence_length present key batch_size past_sequence_length + sequence_length present value batch_size past_sequence_length + sequence_length present key batch_size past_sequence_length + sequence_length present value batch_size past_sequence_length + sequence_length present key batch_size past_sequence_length + sequence_length present value batch_size past_sequence_length + sequence_length input_names = input_ids past_key_values key past_key_values value past_key_values key past_key_values value past_key_values key past_key_values value past_key_values key past_key_values value past_key_values key past_key_values value attention_mask position_ids output_names = logits present key present value present key present value present key present value present key present value present key present value model kwargs dynamic_axes input_names output_names __name__ == __main__ common_utils run_tests
Generates ViewFuncs h cpp NOTE If any changes being made ViewFunc codegen please also check updates needed torch csrc autograd autograd_not_implemented_fallback cpp The fallback expected mimic codegen so we should keep two sync __future__ annotations typing TYPE_CHECKING torchgen api dispatcher dispatcher torchgen api translate translate torchgen api types BaseCType Binding NamedCType SymIntT tensorT VectorCType torchgen code_template CodeTemplate torchgen model Argument NativeFunction OptionalType torchgen utils FileManager gen_inplace_or_view_type CALL_DISPATCH extract_bindings get_view_info modifies_arguments use_derived TYPE_CHECKING torchgen api autograd NativeFunctionWithDifferentiabilityInfo FUNCTION_DECLARATION = CodeTemplate \ #define $ uppercase_op _AVAILABLE struct $ op public $ superclass $ op $ constructor_args $ initializer_list virtual ~$ op override = default virtual std vector c SymInt get_symints const override virtual size_t num_symints const override virtual std vector Tensor get_tensors const override virtual size_t num_tensors const override virtual Tensor operator const Tensor const override virtual std unique_ptr ViewFunc clone_and_set std optional std vector c SymInt = std nullopt std optional std vector Tensor = std nullopt const override protected virtual void set_symints std vector c SymInt override virtual void set_tensors std vector Tensor override private $ state FUNCTION_DEFINITION = CodeTemplate \ std vector c SymInt $ op get_symints const $ get_symints size_t $ op num_symints const static_cast size_t $ num_symints void $ op set_symints std vector c SymInt $ symints_vec TORCH_INTERNAL_ASSERT $ symints_vec size == num_symints $ set_symints std vector Tensor $ op get_tensors const $ get_tensors size_t $ op num_tensors const static_cast size_t $ num_tensors void $ op set_tensors std vector Tensor $ tensors_vec TORCH_INTERNAL_ASSERT $ tensors_vec size == num_tensors $ set_tensors Tensor $ op operator const Tensor $ call_input_name const $ op_call std unique_ptr ViewFunc $ op clone_and_set std optional std vector c SymInt $ symints_vec std optional std vector Tensor $ tensors_vec const auto output = std make_unique $ op $ clone_args $ symints_vec has_value output- set_symints std move $ symints_vec $ tensors_vec has_value output- set_tensors std move $ tensors_vec output e g as_strided - AsStridedViewFunc camel case as_strided_view_func otherwise view_func_name f NativeFunction include_namespace bool = False camel_case bool = True - str name = f func name unambiguous_name view_func_name = f name replace _ _view_func camel_case is_private = view_func_name startswith _ view_func_name = join p title p view_func_name replace _ split _ is_private put leading underscore back view_func_name = f _ view_func_name namespace = torch autograd generated include_namespace f namespace view_func_name is_symint_or_tensor arg Argument - bool arg type is_tensor_like arg type is_symint_like remove_const_ref binding Binding - Binding Binding name=binding name nctype=binding nctype remove_const_ref argument=binding argument default=binding default returns_multi_tensor fn NativeFunction - bool returns = fn func returns assert len returns == returns_list_like = returns type is_list_like None returns_tensor_like = returns type is_tensor_like returns_list_like returns_tensor_like Generates strings logic getting setting state particular type Args bindings list List state bindings interest may empty state_vec_type NamedCType Type vector either copy Returns tuple list getter logic strings list setter logic strings string num items expression generate_state_getter_setter bindings list Binding state_vec_type NamedCType - tuple list str list str str getter_logic = setter_logic = state_vec = state_vec_type name getter_logic append f state_vec_type cpp_type state_vec len bindings setter_logic append auto i = num_exprs = i b enumerate bindings assert isinstance b argument Argument b argument type is_list_like Handle list-likes num_expr = f b name size num_exprs append num_expr getter = f state_vec insert state_vec end b name begin b name end setter = f std copy state_vec begin + i state_vec begin + i + b name size b name begin isinstance b argument type OptionalType Handle optionals num_expr = f b name has_value num_exprs append num_expr conditional = f b name has_value getter = f conditional state_vec insert state_vec end b name setter = f conditional b name = state_vec i num_expr = num_exprs append num_expr getter = f state_vec push_back b name setter = f b name = state_vec i getter_logic append getter setter_logic append setter i len bindings - setter_logic append f i += num_expr Reserve assert based total number items expression num_items = len num_exprs == + join num_exprs len bindings getter_logic insert f state_vec reserve num_items getter_logic append f state_vec getter_logic setter_logic num_items process_function fn NativeFunction template CodeTemplate - str bindings = extract_bindings fn non_self_bindings = b b bindings b name = non_self_args = fn func arguments flat_all non_self_value_bindings = dispatcher argument remove_non_owning_ref_types=True non_self_args Generate constructor clone args generated struct constructor_args = b defn b non_self_bindings clone_args = b name b non_self_bindings Generate state variable declarations generated struct state_variables = f remove_const_ref b defn b non_self_value_bindings Generate initializer list expressions generated struct allow_expensive_conversions=True because we need store e g SymIntArrayRefs vector SymInt s init_exprs = translate non_self_bindings non_self_value_bindings allow_expensive_conversions=True initializers = b init_expr zip non_self_bindings init_exprs name = b nctype name assert isinstance name str initializers append f name init_expr expr Generate call underlying view op call_input_name = input_base op_call_args = call_input_name b name b non_self_bindings op_call = CALL_DISPATCH substitute unambiguous_name=fn func name unambiguous_name unpacked_args=op_call_args Multi-output views additionally require view_idx disambiguation returns_multi_tensor fn view_idx_name = view_idx view_idx_typename = int _t view_idx_decl = f view_idx_typename view_idx_name constructor_args append view_idx_decl clone_args append view_idx_name state_variables append f view_idx_decl initializers append f view_idx_name view_idx_name op_call += f view_idx_name Generate initializer list generated struct initializer_list = f join initializers len initializers Generate getter setter logic any symints symint_bindings = b b non_self_bindings isinstance b argument Argument b argument type is_symint_like symints_vec_type = NamedCType symints VectorCType BaseCType SymIntT get_symints set_symints num_symints = generate_state_getter_setter symint_bindings symints_vec_type Generate getter setter logic any tensors tensor_bindings = b b non_self_bindings isinstance b argument Argument b argument type is_tensor_like tensors_vec_type = NamedCType tensors VectorCType BaseCType tensorT get_tensors set_tensors num_tensors = generate_state_getter_setter tensor_bindings tensors_vec_type template substitute op=view_func_name fn uppercase_op=view_func_name fn camel_case=False upper superclass= torch autograd ViewFunc initializer_list=initializer_list state=state_variables constructor_args=constructor_args clone_args=clone_args symints_vec=symints_vec_type name get_symints=get_symints set_symints=set_symints num_symints=num_symints tensors_vec=tensors_vec_type name get_tensors=get_tensors set_tensors=set_tensors num_tensors=num_tensors call_input_name=call_input_name op_call=op_call gen_view_funcs out str fns_with_infos list NativeFunctionWithDifferentiabilityInfo template_path str - None don t need info parts just function fns = fn func fn fns_with_infos use_derived fn only want out-of-place views view_fns = fn fn fns get_view_info fn None modifies_arguments fn declarations = process_function fn FUNCTION_DECLARATION fn view_fns definitions = process_function fn FUNCTION_DEFINITION fn view_fns ops_headers = f #include ATen ops fn root_name _ops h fn view_fns file_basename = ViewFuncs fm = FileManager install_dir=out template_dir=template_path dry_run=False suffix h cpp fname = file_basename + suffix fm write_with_template fname fname lambda generated_comment + f generated fm template_dir_for_comments fname view_func_declarations declarations view_func_definitions definitions ops_headers ops_headers
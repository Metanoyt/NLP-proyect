mypy allow-untyped-defs ast functools inspect textwrap dedent typing Any NamedTuple Optional torch _C ErrorReport torch _C _jit_tree_views SourceRangeFactory get_source_lines_and_file obj Any error_msg Optional str = None - tuple list str int Optional str Wrapper around inspect getsourcelines inspect getsourcefile Returns sourcelines file_lino filename filename = None case getsourcefile throws try filename = inspect getsourcefile obj sourcelines file_lineno = inspect getsourcelines obj except OSError e msg = f Can t get source obj TorchScript requires source access order carry out compilation make sure original py files available error_msg msg += \n + error_msg raise OSError msg e sourcelines file_lineno filename normalize_source_lines sourcelines list str - list str This helper function accepts list source lines It finds indentation level function definition ` ` then indents all lines function body point greater than level This allows comments continued string literals lower indentation than rest code Args sourcelines function source code separated into lines \n character Returns A list source lines have been correctly aligned remove_prefix text prefix text text startswith prefix len prefix Find line line number containing function definition idx = None i l enumerate sourcelines l lstrip startswith idx = i break This will happen when function lambda- we won t find anywhere source lines case Currently trying JIT compile lambda will throw error up ` parse_def ` we might want handle case future idx None sourcelines Get string representing amount leading whitespace fn_def = sourcelines idx whitespace = fn_def split Add leading whitespace all lines before after ` ` aligned_prefix = whitespace + remove_prefix s whitespace s sourcelines idx aligned_suffix = whitespace + remove_prefix s whitespace s sourcelines idx + Put together again aligned_prefix append fn_def aligned_prefix + aligned_suffix Thin wrapper around SourceRangeFactory store extra metadata about function-to-be-compiled SourceContext SourceRangeFactory __init__ source filename file_lineno leading_whitespace_len uses_true_division=True funcname=None super __init__ source filename file_lineno leading_whitespace_len uses_true_division = uses_true_division filename = filename funcname = funcname functools cache make_source_context args SourceContext args fake_range SourceContext None make_raw_range ParsedDef NamedTuple ast ast Module ctx SourceContext source str filename Optional str file_lineno int parse_def fn sourcelines file_lineno filename = get_source_lines_and_file fn ErrorReport call_stack sourcelines = normalize_source_lines sourcelines source = join sourcelines dedent_src = dedent source py_ast = ast parse dedent_src len py_ast body = isinstance py_ast body ast FunctionDef raise RuntimeError f Expected single top-level function filename file_lineno leading_whitespace_len = len source split \n - len dedent_src split \n ctx = make_source_context source filename file_lineno leading_whitespace_len True fn __name__ ParsedDef py_ast ctx source filename file_lineno
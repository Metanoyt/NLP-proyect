Owner s module onnx __future__ annotations contextlib dataclasses io os unittest collections abc Callable Collection Iterable Mapping Sequence typing Any Optional Union numpy np onnxruntime pytest pytorch_test_common torch torch export torch_export torch onnx _constants torch onnx _internal torchscript_exporter verification torch testing _internal common_utils torch testing _internal opinfo core opinfo_core torch types Number _NumericType = Union Number torch Tensor np ndarray _ModelType = Union torch nn Module Callable torch_export ExportedProgram _InputArgsType = Optional Union torch Tensor int float bool Sequence Any Mapping str Any _OutputsType = Sequence _NumericType onnx_model_dir = os path join os path dirname os path dirname os path realpath __file__ repos onnx onnx backend test data pytorch_converted_dir = os path join onnx_model_dir pytorch-converted pytorch_operator_dir = os path join onnx_model_dir pytorch-operator run_model_test test_suite _TestONNXRuntime args kwargs options = verification VerificationOptions kwargs opset_version = test_suite opset_version kwargs keep_initializers_as_inputs = test_suite keep_initializers_as_inputs hasattr test_suite check_shape options check_shape = test_suite check_shape hasattr test_suite check_dtype options check_dtype = test_suite check_dtype names = f name f dataclasses fields options keywords_to_pop = k v kwargs items k names setattr options k v keywords_to_pop append k k keywords_to_pop kwargs pop k verification verify args options=options kwargs parameterize_class_name cls type idx int input_dicts Mapping Any Any Combine name parameterized arguments This function passed ` parameterized parameterized_class ` ` class_name_func ` argument suffix = _ join f k _ v k v input_dicts items f cls __name__ _ suffix _TestONNXRuntime pytorch_test_common ExportTestCase opset_version = _constants ONNX_DEFAULT_OPSET keep_initializers_as_inputs = True For IR version type export is_script = False check_shape = True check_dtype = True setUp super setUp onnxruntime set_seed torch cuda is_available torch cuda manual_seed_all os environ ALLOW_RELEASED_ONNX_OPSET_ONLY = is_script_test_enabled = True The exported ONNX model may have less inputs than pytorch model because const folding This mostly happens unit test where we widely use torch size torch shape So output only dependent input shape value remained_onnx_input_idx used indicate which pytorch model input idx remained ONNX model run_test model input_args input_kwargs=None rtol= e- atol= e- do_constant_folding=True dynamic_axes=None additional_test_inputs=None input_names=None output_names=None fixed_batch_size=False training=torch onnx TrainingMode EVAL remained_onnx_input_idx=None verbose=False _run_test m remained_onnx_input_idx flatten=True ignore_none=True run_model_test m input_args=input_args input_kwargs=input_kwargs rtol=rtol atol=atol do_constant_folding=do_constant_folding dynamic_axes=dynamic_axes additional_test_inputs=additional_test_inputs input_names=input_names output_names=output_names fixed_batch_size=fixed_batch_size training=training remained_onnx_input_idx=remained_onnx_input_idx flatten=flatten ignore_none=ignore_none verbose=verbose isinstance remained_onnx_input_idx dict scripting_remained_onnx_input_idx = remained_onnx_input_idx scripting tracing_remained_onnx_input_idx = remained_onnx_input_idx tracing scripting_remained_onnx_input_idx = remained_onnx_input_idx tracing_remained_onnx_input_idx = remained_onnx_input_idx is_model_script = isinstance model torch jit ScriptModule torch jit ScriptFunction is_script_test_enabled is_script script_model = model is_model_script torch jit script model _run_test script_model scripting_remained_onnx_input_idx flatten=False ignore_none=False is_model_script is_script _run_test model tracing_remained_onnx_input_idx run_ort onnx_model Union str torch onnx ONNXProgram pytorch_inputs Sequence _InputArgsType - _OutputsType Run ORT given ONNX model inputs Used test_fx_to_onnx_with_onnxruntime py Args onnx_model Union str torch onnx ONNXProgram Converter ONNX model pytorch_inputs Sequence _InputArgsType The given torch inputs Raises AssertionError ONNX PyTorch should have same input sizes Returns _OutputsType ONNX model predictions isinstance onnx_model torch onnx ONNXProgram buffer = io BytesIO onnx_model save buffer ort_model = buffer getvalue ort_model = onnx_model Suppress floods warnings ONNX Runtime session_options = onnxruntime SessionOptions session_options log_severity_level = Error session = onnxruntime InferenceSession ort_model providers= CPUExecutionProvider sess_options=session_options input_names = ort_input name ort_input session get_inputs len input_names = len pytorch_inputs raise AssertionError f Expected len input_names inputs got len pytorch_inputs ort_input = k torch Tensor numpy v force=True k v zip input_names pytorch_inputs session run None ort_input The min onnx opset version test MIN_ONNX_OPSET_VERSION = The max onnx opset version test MAX_ONNX_OPSET_VERSION = _constants ONNX_TORCHSCRIPT_EXPORTER_MAX_OPSET TESTED_OPSETS = range MIN_ONNX_OPSET_VERSION MAX_ONNX_OPSET_VERSION + BOOL_TYPES = torch bool INT_TYPES = torch int torch int torch int torch int torch uint QINT_TYPES = torch qint torch quint FLOAT_TYPES = torch float torch float torch float ORT doesn t support COMPLEX_TYPES = torch complex NOTE torch complex experimental torch torch complex torch complex ORT doesn t support TESTED_DTYPES = Boolean torch bool Integers INT_TYPES Floating types FLOAT_TYPES Complex types COMPLEX_TYPES dataclasses dataclass DecorateMeta Information about test case skip xfail Adapted functorch functorch test common_utils py Attributes op_name The name operator variant_name The name OpInfo variant decorator The decorator apply test case opsets The opsets apply decorator dtypes The dtypes apply decorator reason The reason skipping test_behavior The behavior test case skip xfail matcher The matcher apply test case enabled_if Whether enable test behavior Usually used onnx ort version control model_type The type torch model Defaults None op_name str variant_name str decorator Callable opsets Optional Collection Union int Callable int bool dtypes Optional Collection torch dtype reason str test_behavior str matcher Optional Callable Any bool = None enabled_if bool = True model_type Optional pytorch_test_common TorchModelType = None contains_opset opset int - bool opsets None True any opset == opset_spec isinstance opset_spec int opset_spec opset opset_spec opsets xfail op_name str variant_name str = reason str opsets Optional Collection Union int Callable int bool = None dtypes Optional Collection torch dtype = None matcher Optional Callable Any bool = None enabled_if bool = True model_type Optional pytorch_test_common TorchModelType = None Expects OpInfo test fail Args op_name The name operator variant_name The name variant opsets The opsets expect failure e g opsets_before dtypes The dtypes expect failure reason The reason failure matcher A function matches test sample input It used only when xfail SKIP_XFAIL_SUBTESTS list enabled_if Whether enable xfail Usually used onnx ort version control model_type The type torch model Defaults None DecorateMeta op_name=op_name variant_name=variant_name decorator=unittest expectedFailure opsets=opsets dtypes=dtypes enabled_if=enabled_if matcher=matcher reason=reason test_behavior= xfail model_type=model_type skip op_name str variant_name str = reason str opsets Optional Collection Union int Callable int bool = None dtypes Optional Collection torch dtype = None matcher Optional Callable Any Any = None enabled_if bool = True model_type Optional pytorch_test_common TorchModelType = None Skips test case OpInfo we don t care about Likely because ONNX does support use case design Args op_name The name operator variant_name The name variant opsets The opsets expect failure e g opsets_before dtypes The dtypes expect failure reason The reason failure matcher A function matches test sample input It used only when skip SKIP_XFAIL_SUBTESTS list enabled_if Whether enable skip Usually used onnx ort version control model_type The type torch model Defaults None DecorateMeta op_name=op_name variant_name=variant_name decorator=unittest skip f Skip reason opsets=opsets dtypes=dtypes reason=reason matcher=matcher enabled_if=enabled_if test_behavior= skip model_type=model_type skip_slow op_name str variant_name str = reason str opsets Optional Collection Union int Callable int bool = None dtypes Optional Collection torch dtype = None matcher Optional Callable Any Any = None model_type Optional pytorch_test_common TorchModelType = None Skips test case OpInfo too slow It needs further investigation understand why slow Args op_name The name operator variant_name The name variant opsets The opsets expect failure e g opsets_before dtypes The dtypes expect failure reason The reason failure matcher A function matches test sample input It used only when skip SKIP_XFAIL_SUBTESTS list model_type The type torch model Defaults None DecorateMeta op_name=op_name variant_name=variant_name decorator=common_utils slowTest opsets=opsets dtypes=dtypes reason=reason matcher=matcher enabled_if=not common_utils TEST_WITH_SLOW test_behavior= skip model_type=model_type add_decorate_info all_opinfos Sequence opinfo_core OpInfo test_class_name str base_test_name str opset int skip_or_xfails Iterable DecorateMeta Decorates OpInfo tests decorators based skip_or_xfails list Args all_opinfos All OpInfos test_class_name The name test base_test_name The name test method opset The opset decorate skip_or_xfails DecorateMeta s ops_mapping = info name info variant_test_name info info all_opinfos decorate_meta skip_or_xfails decorate_meta contains_opset opset Skip does apply opset continue opinfo = ops_mapping get decorate_meta op_name decorate_meta variant_name assert opinfo None f Couldn t find OpInfo decorate_meta Did you need specify variant_name assert decorate_meta model_type None f Tested op decorate_meta op_name wrong position If model_type needs specified should put under SKIP_XFAIL_SUBTESTS_WITH_MATCHER_AND_MODEL_TYPE decorators = list opinfo decorators new_decorator = opinfo_core DecorateInfo decorate_meta decorator test_class_name base_test_name dtypes=decorate_meta dtypes active_if=decorate_meta enabled_if decorators append new_decorator opinfo decorators = tuple decorators This decorator doesn t modify fn any way wrapped fn fn wrapped opsets_before opset int - Callable int bool Returns comparison function decides given opset before specified compare other_opset int other_opset opset compare opsets_after opset int - Callable int bool Returns comparison function decides given opset after specified compare other_opset int other_opset opset compare reason_onnx_script_does_not_support operator str dtypes Optional Sequence str = None - str Formats reason ONNX script doesn t support given dtypes f operator dtypes dtypes supported ONNX script reason_onnx_runtime_does_not_support operator str dtypes Optional Sequence str = None - str Formats reason ONNX Runtime doesn t support given dtypes f operator dtypes dtypes supported ONNX Runtime reason_onnx_does_not_support operator str dtypes Optional Sequence str = None - str Formats reason ONNX doesn t support given dtypes f operator dtypes certain dtypes supported ONNX Spec reason_dynamo_does_not_support operator str dtypes Optional Sequence str = None - str Formats reason Dynamo doesn t support given dtypes f operator dtypes certain dtypes supported Dynamo Spec reason_jit_tracer_error info str - str Formats reason JIT tracer errors f JIT tracer error info reason_flaky - str Formats reason test flaky flaky test contextlib contextmanager normal_xfail_skip_test_behaviors test_behavior Optional str = None reason Optional str = None This context manager used handle different behaviors xfail skip Args test_behavior optional str From DecorateMeta name can skip xfail None reason optional str The reason failure skip Raises e Any exception raised test case s expected failure We need skip soon possible SegFault might also case test_behavior == skip pytest skip reason=reason try yield We could use ` except AssertionError RuntimeError e ` needs go over all test cases find right exception type except Exception e pylint disable=broad-exception-caught test_behavior None raise e test_behavior == xfail pytest xfail reason=reason test_behavior == xfail pytest fail Test unexpectedly passed
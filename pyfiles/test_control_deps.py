Owner s module inductor torch torch _inductor config torch _inductor test_case run_tests TestCase InductorTestCase torch _inductor utils run_and_get_code torch testing FileCheck torch testing _internal common_utils IS_LINUX torch testing _internal inductor_utils GPU_TYPE HAS_CUDA_AND_TRITON requires_gpu TestControlDeps InductorTestCase config patch reorder_for_locality=False requires_gpu test_control_deps_prevents_fusion fn b c = + d = b b e = c d e Custom pass add control dependency d - c add_control_deps graph nodes = list graph nodes nodes = n n graph nodes n op == call_function assert len nodes == c_node = nodes d_node = nodes e_node = nodes assert d_node target == torch ops aten mm default torch utils _ordered_set OrderedSet deps_map = d_node OrderedSet c_node e_node OrderedSet d_node torch _inductor fx_passes control_dependencies preserve_node_ordering graph deps_map sub_g = graph find_nodes op= call_function target=torch ops higher_order control_deps assert len sub_g == assert list sub_g meta val shape == assert list sub_g meta val shape == attr graph find_nodes op= get_attr n getattr graph owning_module attr target graph nodes assert list n meta val shape == graph torch _inductor config patch post_grad_custom_post_pass=add_control_deps compiled_fn = torch compile fn = torch rand device=GPU_TYPE b = torch rand device=GPU_TYPE _ code = run_and_get_code torch compile fn b result = compiled_fn b FileCheck check run check extern_kernels mm check run run code expected = fn b torch testing assert_close result expected __name__ == __main__ IS_LINUX HAS_CUDA_AND_TRITON run_tests needs= filelock
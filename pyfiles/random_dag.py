Owner s oncall export random_dag n int Util generate random DAG n nodes The nodes numbered n- The DAG generated randomly choosing subset edges complete graph n nodes such each i j we have i j random edges = i range n edges i = j range i + n random choice True False edges i append j edges Block Util generate block Python-formatted code __init__ _code = __repr__ join _code new_line line str Add new line code The line automatically suffixed newline character _code append line + \n new_block block Block Add new block code All lines new block automatically prefixed tab character _code extend + line line block _code TestGenerator Abstract base generating test code Users should subclass implement test_name test_body methods The test_name method should string uniquely identifies test The test_body method should yield blocks code __init__ _count = _generate_test_name _count += f test_name _ _count generate_test test_name = _generate_test_name code = Block code new_line f test_name block test_body code new_block block code new_line f test_name str code test_name raise NotImplementedError test_body raise NotImplementedError NNModuleGenerator Abstract base generating nn Module Users should subclass implement gen_init_body gen_forward_body methods The gen_init_body method should block code initializes nn Module The gen_forward_body method should block code defines forward nn Module gen_init_body i int raise NotImplementedError gen_forward_body i int raise NotImplementedError gen_nn_module i int gen_nn_module_body code = Block code new_line __init__ code new_block gen_init_body i code new_line forward x code new_block gen_forward_body i code code = Block code new_line f N i torch nn Module code new_block gen_nn_module_body code Unflatten TestGenerator Generates test unflattens model several nn Modules call each other The modules generated calling nn_module_generator method The model exported then unflattened The unflattened model then compared against eager model __init__ n int super __init__ n = n nn_module_generator GenNNModule NNModuleGenerator __init__ n int super __init__ n = n calls = random_dag n gen_init_body i int code = Block code new_line super __init__ i n - code new_line f n i + = N i + code gen_forward_body i int path i j i + == j f n j f n i + path i + j code = Block j calls i code new_line f x = path i j x + code new_line x + code GenNNModule n test_name f __class__ __name__ _ n test_body path i j i + == j f n j f n i + path i + j nn_module_generator = nn_module_generator i range n yield nn_module_generator gen_nn_module n - - i fqns = join f path j j range n gen_main code = Block code new_line inp = torch ones code new_line eager = N inp code new_line f ep = torch export export N inp strict=False preserve_module_call_signature= fqns code new_line epm = ep module code new_line ufm = torch export unflatten ep code new_line assert torch allclose epm inp eager code new_line assert torch allclose ufm inp eager code yield gen_main ConstantUnflatten Unflatten Generates test unflattens model several nn Modules call each other access constants The modules generated calling nn_module_generator method nn_module_generator GenNNModule NNModuleGenerator __init__ n super __init__ n = n accesses = random_dag n calls = random_dag n gen_init_body i int code = Block code new_line super __init__ code new_line const = torch ones i n - code new_line f n i + = N i + code gen_forward_body i int path i j i + == j f n j f n i + path i + j code = Block j accesses i code new_line f x = x + path i j const j calls i code new_line f x = path i j x + code new_line x + code GenNNModule n BufferUnflatten Unflatten Generates test unflattens model several nn Modules call each other access mutate buffers The modules generated calling nn_module_generator method nn_module_generator GenNNModule NNModuleGenerator __init__ n super __init__ n = n accesses = random_dag n mutations = random_dag n calls = random_dag n gen_init_body i int code = Block code new_line super __init__ code new_line buf = torch nn Buffer torch ones i n - code new_line f n i + = N i + code gen_forward_body i int path i j i + == j f n j f n i + path i + j code = Block j accesses i code new_line f x = x + path i j buf j calls i code new_line f x = path i j x + j mutations i code new_line f path i j buf add_ code new_line x + code GenNNModule n
Owner s module sparse itertools re torch torch nn torch ao pruning BaseSparsifier FakeSparsity NearlyDiagonalSparsifier WeightNormSparsifier torch nn utils parametrize is_parametrized torch testing _internal common_pruning ImplementedSparsifier MockSparseLinear SimpleLinear torch testing _internal common_utils raise_on_run_directly TestCase TestBaseSparsifier TestCase test_constructor Cannot instantiate abstract base assertRaises TypeError BaseSparsifier Can instantiate model no configs model = SimpleLinear sparsifier = ImplementedSparsifier test= sparsifier prepare model config=None assert len sparsifier groups == sparsifier step Can instantiate model configs sparsifier = ImplementedSparsifier test= sparsifier prepare model tensor_fqn linear weight assert len sparsifier groups == assert sparsifier groups tensor_fqn == linear weight assert test sparsifier groups assert sparsifier groups test == test_prepare_config model = SimpleLinear sparsifier = ImplementedSparsifier test= Make sure there no parametrizations before ` prepare ` assert hasattr model seq parametrizations assert hasattr model linear parametrizations assert hasattr model linear parametrizations sparsifier prepare model config= tensor_fqn seq weight test No linear make sure will skipped sparsification tensor_fqn linear weight assert len sparsifier groups == Check default argument assigned explicit assert sparsifier groups tensor_fqn == seq weight assert sparsifier groups test == Check FQN module pointing same location assert sparsifier groups tensor_fqn == linear weight assert sparsifier groups module == model linear Check parameterizations attached assert hasattr model seq parametrizations assert hasattr model linear parametrizations assert hasattr model linear parametrizations test_step model = SimpleLinear sparsifier = ImplementedSparsifier test= sparsifier enable_mask_update = True sparsifier prepare model tensor_fqn linear weight sparsifier step assert torch all model linear parametrizations weight mask == test_state_dict step_count = model = SimpleLinear sparsifier = ImplementedSparsifier test= sparsifier prepare model tensor_fqn linear weight mask = model linear parametrizations weight mask mask data = torch arange mask shape mask shape reshape mask shape _ range step_count sparsifier step state_dict = sparsifier state_dict Check expected keys state_dict assert state state_dict assert step_count state_dict state linear weight assert state_dict state linear weight step_count == assert groups state_dict assert test state_dict groups assert tensor_fqn state_dict groups assert state_dict groups tensor_fqn == linear weight Check loading static_dict creates equivalent model model = SimpleLinear sparsifier = ImplementedSparsifier sparsifier prepare model None assert sparsifier state = sparsifier state Make sure masks different beginning mg sparsifier groups mg tensor_fqn == linear weight mask = mg module parametrizations weight mask mg sparsifier groups mg tensor_fqn == linear weight mask = mg module parametrizations weight mask assertNotEqual mask mask sparsifier load_state_dict state_dict Make sure states loaded correct assert sparsifier state == sparsifier state Make sure masks all dicts same after loading assert len sparsifier groups == len sparsifier groups idx range len sparsifier groups mg = sparsifier groups idx mg = sparsifier groups idx key mg keys assert key mg key == module We cannot compare modules they different param = mg key parametrizations weight param = mg key parametrizations weight assert hasattr param mask assert hasattr param mask assertEqual param __dict__ param __dict__ assert mg key == mg key test_convert model = SimpleLinear sparsifier = ImplementedSparsifier test= sparsifier prepare model tensor_fqn linear weight new_model = sparsifier convert model mapping= nn Linear MockSparseLinear inplace=False assert isinstance new_model linear MockSparseLinear assert isinstance new_model seq nn Linear assert isinstance new_model linear nn Linear test_mask_squash model = SimpleLinear sparsifier = ImplementedSparsifier test= sparsifier prepare model tensor_fqn linear weight assert hasattr model linear parametrizations weight mask assert is_parametrized model linear weight assert is_parametrized model seq weight sparsifier squash_mask assert is_parametrized model seq weight assert is_parametrized model linear weight test_mask_squash_with_params model = SimpleLinear sparsifier = ImplementedSparsifier foo= bar= baz= sparsifier prepare model tensor_fqn linear weight tensor_fqn seq weight sparsifier squash_mask params_to_keep_per_layer= linear foo bar seq baz assert is_parametrized model seq weight assert is_parametrized model linear weight assert hasattr model seq sparse_params assert hasattr model linear sparse_params assert model seq sparse_params get foo None None assert model seq sparse_params get bar None None assert model seq sparse_params get baz None == assert model linear sparse_params get foo None == assert model linear sparse_params get bar None == assert model linear sparse_params get baz None None test_mask_squash_with_params model = SimpleLinear sparsifier = ImplementedSparsifier foo= bar= baz= sparsifier prepare model tensor_fqn linear weight tensor_fqn seq weight sparsifier squash_mask params_to_keep= foo bar assert is_parametrized model seq weight assert is_parametrized model linear weight assert hasattr model seq sparse_params assert hasattr model linear sparse_params assert model seq sparse_params get foo None == assert model seq sparse_params get bar None == assert model seq sparse_params get baz None None assert model linear sparse_params get foo None == assert model linear sparse_params get bar None == assert model linear sparse_params get baz None None test_mask_squash_with_params model = SimpleLinear sparsifier = ImplementedSparsifier foo= bar= baz= sparsifier prepare model tensor_fqn linear weight tensor_fqn seq weight sparsifier squash_mask params_to_keep= foo bar params_to_keep_per_layer= seq baz assert is_parametrized model seq weight assert is_parametrized model linear weight assert hasattr model seq sparse_params assert hasattr model linear sparse_params assert model seq sparse_params get foo None == assert model seq sparse_params get bar None == assert model seq sparse_params get baz None == assert model linear sparse_params get foo None == assert model linear sparse_params get bar None == assert model linear sparse_params get baz None None TestWeightNormSparsifier TestCase test_constructor model = SimpleLinear sparsifier = WeightNormSparsifier sparsifier prepare model config=None g sparsifier groups assert isinstance g module nn Linear The groups unordered assert g module_fqn seq seq seq linear linear test_step model = SimpleLinear sparsifier = WeightNormSparsifier sparsity_level= sparsifier prepare model config= tensor_fqn linear weight g sparsifier groups Before step module = g module assert - module parametrizations weight mask mean == checking sparsity level sparsifier enable_mask_update = True sparsifier step assertAlmostEqual model linear parametrizations weight mask mean item places= g sparsifier groups After step module = g module assert - module parametrizations weight mask mean checking sparsity level has increased Test mask collapses all zeros weights randomized iters_before_collapse = _ range iters_before_collapse model linear weight data = torch randn model linear weight shape sparsifier step g sparsifier groups After step module = g module assert - module parametrizations weight mask mean checking sparsity level did collapse test_step_ _of_ model = SimpleLinear sparsifier = WeightNormSparsifier sparsity_level= sparse_block_shape= zeros_per_block= sparsifier prepare model config= tensor_fqn linear weight sparsifier step make sure sparsity level approximately mask = model linear parametrizations weight mask torch float mean works float only assertAlmostEqual mask mean item places= Make sure each block has exactly zeros module = sparsifier groups module mask = module parametrizations weight mask row mask idx range len row block = row idx idx + block _ = block sort assert block == all assert block = all test_prepare model = SimpleLinear sparsifier = WeightNormSparsifier sparsifier prepare model config=None g sparsifier groups module = g module Check mask exists assert hasattr module parametrizations weight mask Check parametrization exists correct assert is_parametrized module weight assert type module parametrizations weight FakeSparsity test_mask_squash model = SimpleLinear sparsifier = WeightNormSparsifier sparsifier prepare model config=None sparsifier squash_mask g sparsifier groups module = g module assert is_parametrized module weight assert hasattr module mask test_sparsity_levels sparsity_levels = - sparse_block_shapes = zeros_per_blocks = testcases = itertools tee itertools product sparsity_levels sparse_block_shapes zeros_per_blocks Create config model all testcases model = nn Sequential sparsifier = WeightNormSparsifier sparsity_per_layer_config = p = re compile r -\ \s sl sbs zpb testcases Make sure number zeros values block zpb sbs sbs continue layer_name = f sl _ sbs _ zpb layer_name = p sub _ layer_name layer = nn Linear bias=False layer weight = nn Parameter torch ones model add_module layer_name layer config = tensor_fqn layer_name + weight sparsity_level sl sparse_block_shape sbs zeros_per_block zpb sparsity_per_layer_config append config sparsifier prepare model sparsity_per_layer_config sparsifier step sparsifier squash_mask model eval sl sbs zpb testcases zpb sbs sbs continue layer_name = f sl _ sbs _ zpb layer_name = p sub _ layer_name layer = getattr model layer_name Level sparsity achieved sparse_mask = layer weight == float zpb == assert sparse_mask mean == Ratio individual zeros tensor true_sl = min max sl true_sl = true_sl zpb sbs sbs assert sparse_mask mean == true_sl TestNearlyDiagonalSparsifier TestCase test_constructor model = SimpleLinear sparsifier = NearlyDiagonalSparsifier nearliness= sparsifier prepare model config=None g sparsifier groups assert isinstance g module nn Linear The groups unordered assert g module_fqn seq seq seq linear linear test_step model = SimpleLinear sparsifier = NearlyDiagonalSparsifier nearliness= sparsifier prepare model config= tensor_fqn linear weight g sparsifier groups Before step module = g module assert - module parametrizations weight mask mean == checking sparsity level sparsifier enable_mask_update = True sparsifier step mask = module parametrizations weight mask height width = mask shape assert torch all mask == torch eye height width g sparsifier groups After step module = g module assert - module parametrizations weight mask mean checking sparsity level has increased Test mask collapses all zeros weights randomized iters_before_collapse = _ range iters_before_collapse model linear weight data = torch randn model linear weight shape sparsifier step g sparsifier groups After step module = g module assert - module parametrizations weight mask mean checking sparsity level did collapse test_prepare model = SimpleLinear sparsifier = NearlyDiagonalSparsifier nearliness= sparsifier prepare model config=None g sparsifier groups module = g module Check mask exists assert hasattr module parametrizations weight mask Check parametrization exists correct assert is_parametrized module weight assert type module parametrizations weight FakeSparsity test_mask_squash model = SimpleLinear sparsifier = NearlyDiagonalSparsifier nearliness= sparsifier prepare model config=None sparsifier step sparsifier squash_mask g sparsifier groups module = g module assert is_parametrized module weight assert hasattr module mask weights = module weight height width = weights shape assert torch all weights == torch eye height width weights only diagonal present test_sparsity_levels nearliness_levels = list range - model = nn Sequential p = re compile r -\ \s nearliness nearliness_levels sparsifier = NearlyDiagonalSparsifier nearliness= layer_name = f nearliness layer_name = p sub _ layer_name layer = nn Linear bias=False layer weight = nn Parameter torch ones width height = layer weight shape model add_module layer_name layer config = tensor_fqn layer_name + weight nearliness nearliness sparsifier prepare model config should raise ValueError when nearliness arg illegal nearliness nearliness == nearliness = min width height assertRaises ValueError sparsifier step sparsifier step sparsifier squash_mask model eval layer = getattr model layer_name verify mask created corresponds nearliness _verify_nearliness layer weight nearliness helper function verify nearliness mask _verify_nearliness mask torch Tensor nearliness int nearliness = assert torch all mask == torch zeros mask shape mask shape height width = mask shape dist_to_diagonal = nearliness row range height col range width abs row - col = dist_to_diagonal assert mask row col == assert mask row col == __name__ == __main__ raise_on_run_directly test test_ao_sparsity py
unittest main TestCase unittest mock Mock patch runner_determinator rd USER_BRANCH = somebranch EXCEPTION_BRANCH = main TestRunnerDeterminatorIssueParser TestCase test_parse_settings - None settings_text = experiments lf rollout_perc otherExp rollout_perc default false --- Users User lf User lf otherExp settings = rd parse_settings settings_text assertTupleEqual rd Experiment rollout_perc= settings experiments lf lf settings parsed correctly assertTupleEqual rd Experiment rollout_perc= default=False settings experiments otherExp otherExp settings parsed correctly test_parse_settings_with_invalid_experiment_name_skips_experiment - None settings_text = experiments lf rollout_perc -badExp rollout_perc default false --- Users User lf User lf -badExp settings = rd parse_settings settings_text assertTupleEqual rd Experiment rollout_perc= settings experiments lf lf settings parsed correctly assertNotIn -badExp settings experiments test_parse_settings_in_code_block - None settings_text = ` ` ` experiments lf rollout_perc otherExp rollout_perc default false ` ` ` --- Users User lf User lf otherExp settings = rd parse_settings settings_text assertTupleEqual rd Experiment rollout_perc= settings experiments lf lf settings parsed correctly assertTupleEqual rd Experiment rollout_perc= default=False settings experiments otherExp otherExp settings parsed correctly test_parse_all_branches_setting - None settings_text = ` ` ` experiments lf rollout_perc all_branches true otherExp all_branches True rollout_perc ` ` ` --- Users User lf User lf otherExp settings = rd parse_settings settings_text assertTupleEqual rd Experiment rollout_perc= all_branches=True settings experiments lf lf settings parsed correctly assertTrue settings experiments otherExp all_branches assertTupleEqual rd Experiment rollout_perc= all_branches=True settings experiments otherExp otherExp settings parsed correctly test_parse_users - None settings_text = experiments lf rollout_perc otherExp rollout_perc --- Users User lf User lf otherExp users = rd parse_users settings_text assertDictEqual User lf User lf otherExp users Users parsed correctly test_parse_users_without_settings - None settings_text = User lf User lf otherExp users = rd parse_users settings_text assertDictEqual User lf User lf otherExp users Users parsed correctly TestRunnerDeterminatorGetRunnerPrefix TestCase test_opted_in_user - None settings_text = experiments lf rollout_perc otherExp rollout_perc --- Users User lf User lf otherExp prefix = rd get_runner_prefix settings_text User USER_BRANCH assertEqual lf prefix Runner prefix correct User test_explicitly_opted_out_user - None settings_text = experiments lf rollout_perc otherExp rollout_perc --- Users User -lf User lf otherExp prefix = rd get_runner_prefix settings_text User USER_BRANCH assertEqual prefix Runner prefix correct User test_explicitly_opted_in_and_out_user_should_opt_out - None settings_text = experiments lf rollout_perc otherExp rollout_perc --- Users User -lf lf User lf otherExp prefix = rd get_runner_prefix settings_text User USER_BRANCH assertEqual prefix Runner prefix correct User test_opted_in_user_two_experiments - None settings_text = experiments lf rollout_perc otherExp rollout_perc --- Users User lf User lf otherExp prefix = rd get_runner_prefix settings_text User USER_BRANCH assertEqual lf otherExp prefix Runner prefix correct User test_opted_in_user_two_experiments_default - None settings_text = experiments lf rollout_perc otherExp rollout_perc default false --- Users User lf User lf otherExp prefix = rd get_runner_prefix settings_text User USER_BRANCH assertEqual lf prefix Runner prefix correct User test_opted_in_user_two_experiments_default_exp - None settings_text = experiments lf rollout_perc otherExp rollout_perc default false --- Users User lf User lf otherExp prefix = rd get_runner_prefix settings_text User USER_BRANCH frozenset lf otherExp assertEqual lf otherExp prefix Runner prefix correct User test_opted_in_user_two_experiments_default_exp_ - None settings_text = experiments lf rollout_perc otherExp rollout_perc default false --- Users User lf User lf otherExp prefix = rd get_runner_prefix settings_text User USER_BRANCH frozenset otherExp assertEqual otherExp prefix Runner prefix correct User patch random uniform return_value= test_opted_out_user mock_uniform Mock - None settings_text = experiments lf rollout_perc otherExp rollout_perc --- Users User lf User lf otherExp prefix = rd get_runner_prefix settings_text User USER_BRANCH assertEqual prefix Runner prefix correct user patch random uniform return_value= test_opted_out_user_was_pulled_in_by_rollout mock_uniform Mock - None settings_text = experiments lf rollout_perc otherExp rollout_perc --- Users User lf User lf otherExp User opted out pulled into both experiments rollout prefix = rd get_runner_prefix settings_text User USER_BRANCH assertEqual lf otherExp prefix Runner prefix correct user patch random uniform return_value= test_opted_out_user_was_pulled_in_by_rollout_excl_nondefault mock_uniform Mock - None settings_text = experiments lf rollout_perc otherExp rollout_perc default false --- Users User lf User lf otherExp User opted out pulled into default experiments rollout prefix = rd get_runner_prefix settings_text User USER_BRANCH assertEqual lf prefix Runner prefix correct user patch random uniform return_value= test_opted_out_user_was_pulled_in_by_rollout_filter_exp mock_uniform Mock - None settings_text = experiments lf rollout_perc otherExp rollout_perc default false --- Users User lf User lf otherExp User opted out pulled into default experiments rollout prefix = rd get_runner_prefix settings_text User USER_BRANCH frozenset otherExp assertEqual otherExp prefix Runner prefix correct user patch random uniform return_value= test_opted_out_user_was_pulled_out_by_rollout_filter_exp mock_uniform Mock - None settings_text = experiments lf rollout_perc otherExp rollout_perc default false --- Users User lf User lf otherExp User opted out pulled into default experiments rollout prefix = rd get_runner_prefix settings_text User USER_BRANCH assertEqual prefix Runner prefix correct user test_lf_prefix_always_comes_first - None settings_text = experiments otherExp rollout_perc lf rollout_perc --- Users User lf User otherExp lf prefix = rd get_runner_prefix settings_text User USER_BRANCH assertEqual lf otherExp prefix Runner prefix correct user test_ignores_commented_users - None settings_text = experiments lf rollout_perc otherExp rollout_perc --- Users User lf User lf otherExp prefix = rd get_runner_prefix settings_text User USER_BRANCH assertEqual prefix Runner prefix correct user test_ignores_extra_experiments - None settings_text = experiments lf rollout_perc otherExp rollout_perc foo rollout_perc --- Users User lf otherExp foo prefix = rd get_runner_prefix settings_text User USER_BRANCH assertEqual lf otherExp prefix Runner prefix correct user test_disables_experiment_on_exception_branches_when_not_explicitly_opted_in - None settings_text = experiments lf rollout_perc --- Users User lf otherExp prefix = rd get_runner_prefix settings_text User EXCEPTION_BRANCH assertEqual prefix Runner prefix correct user test_allows_experiment_on_exception_branches_when_explicitly_opted_in - None settings_text = experiments lf rollout_perc all_branches true --- Users User lf otherExp prefix = rd get_runner_prefix settings_text User EXCEPTION_BRANCH assertEqual lf prefix Runner prefix correct user __name__ == __main__ main
__future__ annotations argparse concurrent futures json logging os sys enum Enum pathlib Path typing NamedTuple packaging specifiers SpecifierSet packaging version Version sys version_info = tomllib tomli tomllib type ignore import-not-found LintSeverity str Enum ERROR = error WARNING = warning ADVICE = advice DISABLED = disabled LintMessage NamedTuple path str &#124; None line int &#124; None char int &#124; None code str severity LintSeverity name str original str &#124; None replacement str &#124; None description str &#124; None format_error_message filename str error Exception &#124; None = None message str &#124; None = None - LintMessage message None error None message = f Failed due error __class__ __name__ \n error LintMessage path=filename line=None char=None code= PYPROJECT severity=LintSeverity ERROR name= pyproject toml consistency original=None replacement=None description=message check_file filename str - list LintMessage path = Path filename absolute try pyproject = tomllib loads path read_text encoding= utf- except tomllib TOMLDecodeError OSError err format_error_message filename err isinstance pyproject dict isinstance pyproject get project dict format_error_message filename message= project section pyproject toml must present table project = pyproject project requires_python = project get requires-python requires_python None isinstance requires_python str format_error_message filename message= project requires-python must string python_major = specifier_set = SpecifierSet requires_python specifier specifier_set Version specifier version major = python_major format_error_message filename message= project requires-python must only specify f Python python_major versions found specifier version large_minor = supported_python_versions = list specifier_set filter f python_major minor minor range large_minor + supported_python_versions format_error_message filename message= project requires-python must specify least one f Python python_major version found requires_python r f python_major supported_python_versions format_error_message filename message= project requires-python must specify minimum version f found requires_python r f python_major large_minor supported_python_versions format_error_message filename message= project requires-python must specify maximum version f found requires_python r classifiers = project get classifiers isinstance classifiers list all isinstance c str c classifiers format_error_message filename message= project classifiers must array strings len set classifiers = len classifiers format_error_message filename message= project classifiers must contain duplicates python_version_classifiers = c c classifiers c startswith Programming Language Python c endswith f python_major f python_major Only python_version_classifiers python_version_classifier_set = set python_version_classifiers supported_python_version_classifier_set = f Programming Language Python v v supported_python_versions python_version_classifier_set = supported_python_version_classifier_set missing_classifiers = sorted supported_python_version_classifier_set - python_version_classifier_set extra_classifiers = sorted python_version_classifier_set - supported_python_version_classifier_set missing_classifiers format_error_message filename message= project classifiers missing following classifier s \n + \n join f c r c missing_classifiers extra_classifiers format_error_message filename message= project classifiers contains extra classifier s \n + \n join f c r c extra_classifiers main - None parser = argparse ArgumentParser description= Check consistency pyproject toml files fromfile_prefix_chars= parser add_argument -- verbose action= store_true help= verbose logging parser add_argument filenames nargs= + help= paths lint args = parser parse_args logging basicConfig format= processName s levelname s message s level=logging NOTSET args verbose logging DEBUG len args filenames logging INFO stream=sys stderr concurrent futures ProcessPoolExecutor max_workers=os cpu_count executor futures = executor submit check_file x x x args filenames future concurrent futures as_completed futures try lint_message future result print json dumps lint_message _asdict flush=True except Exception logging critical Failed s futures future raise __name__ == __main__ main
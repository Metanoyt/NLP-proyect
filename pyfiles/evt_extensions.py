collections abc Callable typing Any Union sympy Expr torch _inductor ir ComputedBuffer InputBuffer is_contiguous_strides_for_shape torch utils _ordered_set OrderedSet cutlass_utils torch_dtype_to_cutlass_type try_import_cutlass EpilogueFunctor = Any EpilogueFunctor local defined _trace Buffer = Union ComputedBuffer InputBuffer CutlassTupleType = Any cutlass backend c_types tuple_factory_ locals TupleType CutlassVisitorType = Any cutlass backend c_types visitor_factory locals VisitorType CutlassArgType = Any Can CutlassTupleType CutlassVisitorType EmptyByte ctype c_void_p try_import_cutlass ast ctypes textwrap typing Union cutlass_cppgen backend c_types type ignore import-not-found EmptyByte cutlass_cppgen backend epilogue type ignore import-not-found dtype ctype cutlass_cppgen backend evt type ignore import-not-found EpilogueFunctorVisitor cutlass_cppgen backend evt backend emitter_base type ignore import-not-found FusionCallbacks cutlass_cppgen backend evt backend sm _emitter type ignore import-not-found CollectiveEpilogue cutlass_cppgen backend evt frontend type ignore import-not-found PythonASTFrontend cutlass_cppgen backend evt ir tensor type ignore import-not-found Tensor CutlassTensor cutlass_library DataType EpilogueScheduleType LayoutType TileDescription torch _inductor codegen cuda cuda_env torch _inductor utils IndentedBuffer _CUTLASS_C_DTYPES = OrderedSet dtype ctype values type ignore var-annotated EVTArgRenames Handles mapping buffer names variable names cpp kernel signature body __init__ - None buf_renames dict str str = new_name name str - str name buf_renames buf_renames name new_name = f ptr_ len buf_renames buf_renames name = new_name new_name get name str - str buf_renames get name name create_example_tensors var_name_to_buffer_name dict str str name_to_buffer dict str Buffer size_hint_fn Callable Union Expr int int - dict str CutlassTensor cutlass_tensor_from_buffer buffer Buffer - CutlassTensor shape = buffer get_layout size stride = buffer get_layout stride shape = tuple size_hint_fn x x shape stride = tuple size_hint_fn x x stride is_row_major = is_contiguous_strides_for_shape stride shape is_column_major = is_contiguous_strides_for_shape stride - shape - is_row_major is_column_major raise RuntimeError f Cannot create example tensor buffer get_name \ non-contiguous layout received stride stride shape shape CutlassTensor shape=shape layout_tag= LayoutType RowMajor is_row_major LayoutType ColumnMajor element=torch_dtype_to_cutlass_type buffer get_layout dtype key cutlass_tensor_from_buffer name_to_buffer name key name var_name_to_buffer_name items trace fn_src str example_tensors dict str CutlassTensor accum_type DataType output_type DataType tile_description TileDescription epilogue_schedule EpilogueScheduleType name_to_buffer dict str Buffer size_hint_fn Callable Union Expr int int kwargs dict str Any - tuple str str str EVTArgRenames cuda_arch = int cuda_env get_cuda_arch type ignore arg-type assert cuda_arch = Only SM + supported EVT epilogue_functor = _trace fn_src example_tensors cuda_arch kwargs visitor = EpilogueFunctorVisitor cuda_arch epilogue_functor fusion_callbacks = FusionCallbacks visitor graph cuda_arch emit_CD=False collective_epilogue = CollectiveEpilogue tile_description epilogue_schedule accum_type output_type fusion_callbacks evt_name evt_code = collective_epilogue emit evt_args arg_renames = _render_argument_type epilogue_functor name_to_buffer size_hint_fn evt_name evt_args evt_code arg_renames Based off https github com NVIDIA cutlass blob df f e f de bed de e c f f ec python cutlass epilogue epilogue py#L This modified enable directly passing source code epilogue vs getting bona-fide python function The reason inspect getsource does work functions defined runtime via exec eval _trace fn_src str example_tensors dict str CutlassTensor cc int kwargs Any - EpilogueFunctor EpilogueFunctor PythonASTFrontend __init__ cc int kwargs Any source = textwrap dedent fn_src super __init__ cc kwargs parse example_inputs dict str CutlassTensor - None example_inputs = example_inputs ast = ast parse source pyrefly ignore missing-attribute visit ast cc = int cuda_env get_cuda_arch epilogue_functor = EpilogueFunctor cc=cc kwargs epilogue_functor trace example_tensors epilogue_functor _render_argument_type epilogue_functor EpilogueFunctor name_to_buffer dict str Buffer size_hint_fn Callable Union Expr int int - tuple str EVTArgRenames epilogue_thread_type = epilogue_functor epilogue_thread_type arg_renames = EVTArgRenames Fragile only way guarantee t expected type because t local is_nested_visitor_type t type - bool join t __module__ t __qualname__ == cutlass_cppgen backend c_types visitor_factory locals VisitorType buffer = IndentedBuffer buffer set_tabwidth render_argument_type name str t CutlassArgType - None issubclass t ctypes c_byte buffer writeline f name fields = fname _get_arg_from_node ty name_to_buffer name size_hint_fn arg_renames fname ty t _fields_ field_strs = f fname str field fname field fields buffer writeline f join field_strs name render_thread_type name str t CutlassArgType - None is_nested_visitor_type t buffer writeline f name buffer indent name inner_t t _fields_ render_thread_type name inner_t buffer writeline render_argument_type name t unroll recursion once address special case formatting namely no ending comma no indentation outermost thread type buffer writeline thread buffer indent is_nested_visitor_type epilogue_thread_type buffer indent name inner_t epilogue_thread_type _fields_ render_thread_type name inner_t render_argument_type thread epilogue_thread_type buffer writeline buffer getvalue arg_renames _get_arg_from_node arg_ty type node Buffer size_hint_fn Callable Union Expr int int arg_renames EVTArgRenames - str cuda_template CUTLASSTemplate Today arguments either pointer node s memory stride tuple datatype Once again need check local type stride tuple str arg_ty == cutlass_cppgen backend c_types tuple_factory_ locals TupleType DEFAULT_STRIDE_LEN = assert len node get_layout stride = DEFAULT_STRIDE_LEN stride = size_hint_fn x x node get_layout stride _ range DEFAULT_STRIDE_LEN - len stride stride append render_stride x int - str Handle EBO x == _ x == _ str x f join render_stride x x stride issubclass arg_ty ctypes c_void_p name = arg_renames new_name node get_name f CUTLASSTemplate _DTYPE_TO_CUTLASS node get_layout dtype name + name _offset arg_ty _CUTLASS_C_DTYPES Assumption element dtype holds all cutlass ir nodes currently f CUTLASSTemplate _DTYPE_TO_CUTLASS node get_layout dtype issubclass arg_ty EmptyByte raise NotImplementedError f Unsupported arg type arg_ty
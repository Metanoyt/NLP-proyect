__future__ annotations argparse concurrent futures json logging os re shutil subprocess sys time enum Enum pathlib Path sysconfig get_paths gp typing NamedTuple PyTorch directory root scm_root - str path = os path abspath os getcwd pyrefly ignore bad-assignment while True os path exists os path join path git path os path isdir os path join path hg path pyrefly ignore bad-argument-type n = len path path = os path dirname path len path == n raise RuntimeError Unable find SCM root PYTORCH_ROOT = scm_root Returns usr local include python version number get_python_include_dir - str gp include LintSeverity str Enum ERROR = error WARNING = warning ADVICE = advice DISABLED = disabled LintMessage NamedTuple path str &#124; None line int &#124; None char int &#124; None code str severity LintSeverity name str original str &#124; None replacement str &#124; None description str &#124; None c core DispatchKey cpp error k used after moved bugprone-use-after-move RESULTS_RE re Pattern str = re compile r mx ^ P file P line \d+ P column - \d+ \s P severity \S+ \s P message \s P code \ \ $ run_command args list str - subprocess CompletedProcess bytes logging debug $ s join args start_time = time monotonic try subprocess run args capture_output=True check=False finally end_time = time monotonic logging debug took dms end_time - start_time Severity either error note https github com python mypy blob b e fb e f b e bf mypy errors py#L -L severities = error LintSeverity ERROR warning LintSeverity WARNING clang_search_dirs - list str Compilers ordered based fallback preference We pick first one available system compilers = clang gcc cpp cc compilers = c c compilers shutil which c None len compilers == raise RuntimeError f None compilers found compiler = compilers result = subprocess run compiler -E -x c++ - -v stdin=subprocess DEVNULL capture_output=True check=True stderr = result stderr decode strip split \n search_start = r #include search starts here search_end = r End search list append_path = False search_paths = line stderr re match search_start line append_path continue append_path = True re match search_end line break append_path search_paths append line strip search_paths include_args = include_dir = usr lib llvm- include openmp get_python_include_dir os path join PYTORCH_ROOT third_party pybind include + clang_search_dirs dir include_dir include_args += -- extra-arg f -I dir check_file filename str binary str build_dir Path - list LintMessage try proc = run_command binary f -p= build_dir include_args filename except OSError err LintMessage path=filename line=None char=None code= CLANGTIDY severity=LintSeverity ERROR name= command-failed original=None replacement=None description= f Failed due err __class__ __name__ \n err lint_messages = try Change current working directory build directory since clang-tidy will report files relative build directory saved_cwd = os getcwd os chdir build_dir match RESULTS_RE finditer proc stdout decode Convert reported path absolute path abs_path = str Path match file resolve abs_path startswith PYTORCH_ROOT continue message = LintMessage path=abs_path name=match code description=match message line=int match line char=int match column match column None match column startswith - None code= CLANGTIDY severity=severities get match severity LintSeverity ERROR original=None replacement=None lint_messages append message finally os chdir saved_cwd lint_messages main - None parser = argparse ArgumentParser description= clang-tidy wrapper linter fromfile_prefix_chars= parser add_argument -- binary required=True help= clang-tidy binary path parser add_argument -- build-dir -- build_dir required=True help= Where compile_commands json file located Gets passed clang-tidy -p parser add_argument -- verbose action= store_true help= verbose logging parser add_argument filenames nargs= + help= paths lint args = parser parse_args logging basicConfig format= threadName s levelname s message s level=logging NOTSET args verbose logging DEBUG len args filenames logging INFO stream=sys stderr os path exists args binary err_msg = LintMessage path= none line=None char=None code= CLANGTIDY severity=LintSeverity ERROR name= command-failed original=None replacement=None description= f Could find clang-tidy binary args binary you may need run ` lintrunner init ` print json dumps err_msg _asdict flush=True sys exit abs_build_dir = Path args build_dir resolve Get absolute path clang-tidy use instead relative path such lintbin clang-tidy The problem here os chdir per process linter uses move between current directory build folder And there no lintbin directory latter When happens race condition linter command will fails following no such file directory error lintbin clang-tidy binary_path = os path abspath args binary concurrent futures ThreadPoolExecutor max_workers=os cpu_count thread_name_prefix= Thread executor futures = executor submit check_file filename binary_path abs_build_dir filename filename args filenames future concurrent futures as_completed futures try lint_message future result print json dumps lint_message _asdict flush=True except Exception logging critical Failed s futures future raise __name__ == __main__ main
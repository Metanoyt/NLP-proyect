usr bin env python Owner s oncall r p Copyright c Facebook Inc its affiliates All rights reserved This source code licensed under BSD-style license found LICENSE file root directory source tree datetime multiprocessing pool ThreadPool unittest mock torch distributed dist torch distributed elastic utils store store_util torch distributed elastic utils logging get_logger torch testing _internal common_utils run_tests TestCase MockStore _TEST_TIMEOUT = __init__ - None ops = set_timeout timeout float - None ops append set_timeout timeout property timeout - datetime timedelta ops append timeout datetime timedelta seconds=self _TEST_TIMEOUT set key str value str - None ops append set key value get key str - str ops append get key value multi_get keys list str - list str ops append multi_get keys value len keys add key str val int - int ops append add key val wait keys list str - None ops append wait keys StoreUtilTest TestCase test_get_all_rank_ world_size = store = MockStore store_util get_all store test store world_size assertListEqual store ops multi_get test store test store test store add test store finished num_members set test store finished last_member val_ignored wait test store finished last_member test_get_all_rank_n store = MockStore world_size = store_util get_all store test store world_size assertListEqual store ops multi_get test store test store test store add test store finished num_members set test store finished last_member val_ignored test_synchronize store = MockStore data = b data store_util synchronize store data key_prefix= test store assertListEqual store ops timeout set_timeout datetime timedelta seconds= set test store data multi_get test store test store test store add test store finished num_members set test store finished last_member val_ignored wait test store finished last_member set_timeout datetime timedelta seconds=store _TEST_TIMEOUT test_synchronize_hash_store - None N = store = dist HashStore f i int store_util synchronize store f data i i N key_prefix= test store ThreadPool N pool out = pool map f range N assertListEqual out f data i encode i range N N test_barrier store = MockStore store_util barrier store key_prefix= test store assertListEqual store ops timeout set_timeout datetime timedelta seconds= add test store num_members set test store last_member val_ignored wait test store last_member set_timeout datetime timedelta seconds=store _TEST_TIMEOUT test_barrier_timeout_rank_tracing N = store = dist HashStore run_barrier_for_rank i int try store_util barrier store N key_prefix= test store barrier_timeout= rank=i rank_tracing_decoder=lambda x f Rank x host trace_timeout= except Exception e str e ThreadPool N - pool outputs list str = pool map run_barrier_for_rank range N - assertTrue any missing_ranks= Rank msg msg outputs assertTrue any check rank Rank host missing rank info msg msg outputs test_barrier_timeout_operations torch DistStoreError = torch _C _DistStoreError N = store = MockStore rank mock patch object store wait wait_mock wait_mock side_effect = DistStoreError test None None assertRaises DistStoreError store_util barrier store N key_prefix= test store barrier_timeout= rank= rank_tracing_decoder=lambda x f Rank x host trace_timeout= assertListEqual store ops timeout set_timeout datetime timedelta seconds= add test store num_members set test store last_member val_ignored wait last member mocked set test store TRACE val_ignored wait each rank mocked set test store TRACING_GATE val_ignored rank mock patch object store wait wait_mock store ops = wait_mock side_effect = DistStoreError test None assertRaises DistStoreError store_util barrier store N key_prefix= test store barrier_timeout= rank= rank_tracing_decoder=lambda x f Rank x host trace_timeout= assertListEqual store ops timeout set_timeout datetime timedelta seconds= add test store num_members set test store last_member val_ignored set test store TRACE val_ignored wait gate mocked test_barrier_hash_store - None N = store = dist HashStore f i int store_util barrier store N key_prefix= test store ThreadPool N pool out = pool map f range N assertEqual out None N UtilTest TestCase test_get_logger_different logger = get_logger name logger = get_logger name assertNotEqual logger name logger name test_get_logger logger = get_logger assertEqual __name__ logger name test_get_logger_none logger = get_logger None assertEqual __name__ logger name test_get_logger_custom_name logger = get_logger test module assertEqual test module logger name __name__ == __main__ run_tests
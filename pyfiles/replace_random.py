mypy allow-untyped-defs collections logging torch torch fx passes graph_transform_observer GraphTransformObserver torch fx passes shape_prop _extract_tensor_metadata config inductor_prims pattern_matcher CallFunctionVarArgs Match PatternMatcherPass register_graph_pattern virtualized V log = logging getLogger __name__ patterns = PatternMatcherPass subsystem= joint_graph_passes aten = torch ops aten replace_random_passes gm torch fx GraphModule Modify given FX graph use backend-native random ops config fallback_random count = patterns apply gm GraphTransformObserver gm fuse_seed_creation_pass joint_graph_passes count += fuse_seed_creation_pass gm graph count fuse_seed_creation_pass graph torch fx Graph Horizontally fuse all seed generation each device = inductor_seed dev b = inductor_seed dev Becomes seeds = inductor_seeds dev = inductor_lookup_seed seeds b = inductor_lookup_seed seeds We do because seed creation entirely launch overhead bound device_seeds = collections defaultdict list node graph nodes CallFunctionVarArgs inductor_prims seed match node device_seeds node args append node device_seeds device seeds device_seeds items graph inserting_before seeds combined = graph call_function inductor_prims seeds len seeds device V fake_mode combined meta val = torch empty len seeds device=device dtype=torch int combined meta tensor_meta = _extract_tensor_metadata combined meta val idx seed enumerate seeds graph inserting_before seed new_seed = graph call_function inductor_prims lookup_seed combined idx seed replace_all_uses_with new_seed new_seed meta update seed meta graph erase_node seed len device_seeds default_kwargs device get_device device device None device torch empty device default device pyrefly ignore bad-argument-type register_graph_pattern CallFunctionVarArgs aten rand default pass_dict=patterns pyrefly ignore bad-argument-type register_graph_pattern CallFunctionVarArgs aten rand generator pass_dict=patterns pyrefly ignore bad-argument-type register_graph_pattern CallFunctionVarArgs aten randn default pass_dict=patterns pyrefly ignore bad-argument-type register_graph_pattern CallFunctionVarArgs aten randn generator pass_dict=patterns replace_random match Match size generator=None dtype=None device=None layout=None pin_memory=None generator None replacement size result = inductor_prims random size inductor_prims seed device mode default_kwargs device dtype None result = result dtype result mode = aten rand rand aten randn randn match output_node target overloadpacket type ignore union-attr type ignore union-attr device = get_device device pyrefly ignore bad-argument-type match replace_by_example replacement size pyrefly ignore bad-argument-type register_graph_pattern CallFunctionVarArgs aten randint low pass_dict=patterns replace_randint match Match low high size dtype=torch int device=None layout=None pin_memory=None replacement low high size result = inductor_prims randint low high size inductor_prims seed device result dtype device = get_device device pyrefly ignore bad-argument-type match replace_by_example replacement low high size
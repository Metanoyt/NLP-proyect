Owner s oncall jit ruff noqa F os sys collections namedtuple typing Dict List NamedTuple Tuple torch torch testing _internal common_utils IS_WINDOWS raise_on_run_directly torch testing _internal jit_utils JitTestCase make_global Make helper files test importable pytorch_test_dir = os path dirname os path dirname os path realpath __file__ sys path append pytorch_test_dir TestTyping JitTestCase test_dict_in_not_in test_in_dict x type Dict str int - bool hi x checkScript test_in_dict hi bye checkScript test_in_dict bye Check evaluation order torch jit script print torch jit script b print b torch jit script fn b capture_stdout captured assertTrue fn IS_WINDOWS no stdout capturing windows assertEqual captured a\nb\n test_not_in_dict type Dict str int - bool hello False True checkScript test_not_in_dict hello world checkScript test_not_in_dict world test_dict_tensor_key t type Dict Tensor int Tensor - bool t True False inp = torch tensor inp = torch tensor dict_a = inp inp checkScript test_dict_tensor_key dict_a torch tensor checkScript test_dict_tensor_key dict_a torch tensor checkScript test_dict_tensor_key dict_a inp checkScript test_dict_tensor_key dict_a inp test_list_type_refinement_annotation_element_mismatch fn l List int = foo l assertRaisesRegex RuntimeError List type annotation r ` List\ int\ ` did match types given list elements torch jit script fn test_dict_type_refinement_annotation_key_mismatch fn l = foo l = foo bar baz qux d Dict int str = dict zip l l d assertRaisesRegex RuntimeError Dicts may only contain homogeneous keys type first generated key r Union\ int str\ torch jit script fn test_dict_type_refinement_annotation_value_mismatch fn l = foo bar baz qux l = foo d Dict str int = dict zip l l d assertRaisesRegex RuntimeError Dict type annotation r ` Dict\ str int\ ` did match type actual value type r ` Union\ int str\ ` torch jit script fn test_dict_invalid_annotations Check invalid value type annotation wrong_value_type dictionary Dict str torch jit ScriptModule assertRaisesRegex ValueError Unknown type annotation torch jit script wrong_value_type Check invalid key type annotation wrong_key_type dictionary Dict torch jit ScriptModule str assertRaisesRegex ValueError Unknown type annotation torch jit script wrong_key_type Check invalid key value type annotation wrong_key_value_type dictionary Dict torch jit ScriptModule torch jit ScriptModule assertRaisesRegex ValueError Unknown type annotation torch jit script wrong_key_value_type test_tuple_specialization torch jit script f t s type Tuple Tensor Tuple int Tensor str - Tensor x t = t _ y = t x + y t = torch randn torch randn f t hi graph = f graph_for t hi input_types = list next graph inputs type elements w = input_types assertEqual input_types kind TensorType assertEqual input_types elements kind TensorType test_tuple_io stuff x type Tuple Tensor Tensor - Tuple Tensor Tensor b = x b = torch rand torch rand checkScript stuff test_tuple_keyword bar f = tuple noqa C f checkScript bar foo tuple checkScriptRaisesRegex foo Exception argument cant_infer_size tuple noqa C assertRaisesRegex Exception cannot statically infer expected torch jit script cant_infer_size test_tuple_create_return stuff x type int - Tuple Tensor Tensor = torch ones x torch zeros x checkScript stuff test_list_io stuff x type List int - Tuple Tensor List int torch ones x x checkScript stuff test_bool_list_io torch jit script stuff x type List bool - Tuple List bool List bool List List bool x True False True li_ li_ li_ = stuff True li_ = li_ li li_ li_ li_ assertTrue type li bool test_nested_list foo z type Tuple int List List int - int x y = z y checkScript foo test_list_sum fn x List int - int sum x fn x List float sum x fn x List bool sum x checkScript fn checkScript fn checkScript fn checkScript fn True False False checkScript fn False False False checkScript fn test_list_unification fn None fn x torch ones None x checkScript fn checkScript fn torch ones avoid defining sum_list multiple tests get_sum_list_fn sum_list type List int - int sum = i sum += i sum sum_list test_sum_list_diff_elms checkScript get_sum_list_fn test_sum_list_empty checkScript get_sum_list_fn test_sum_list_one checkScript get_sum_list_fn test_sum_list_literal sum_list type - int sum = i sum += i sum checkScript sum_list test_sum_list_wrong_type assertRaisesRegex RuntimeError int object iterable torch jit script sum_list type int - int sum = i noqa T sum += i sum sum_list test_list_iterables assertRaisesRegex RuntimeError List iterables supported currently cu = torch jit CompilationUnit list_iterables x i j x += i x += j x test_for_in_string test_strings x type str - str reverse = c x reverse = c + reverse reverse checkScript test_strings hello checkScript test_strings test_list_strings x type List str - str result = sub_str x result += sub_str result checkScript test_list_strings hello world checkScript test_list_strings hello world test_for_in_dict test_dicts x type Dict str int - int sum = key x sum += x key sum checkScript test_dicts b c test_dict_keys_values x type Dict str int - Tuple str int key_str = sum = key x keys key_str += key val x values sum += val key_str sum checkScript test_dicts b c test_for_tuple_unpack for_tuple_unpack x y i j x += i y += j x y checkScript for_tuple_unpack torch tensor torch tensor nested_tuple_unpack x y type List int List int - int sum = i j k v zip x enumerate x y sum += i + j + k + v sum checkScript nested_tuple_unpack test_dict_comprehension fn i chr i + i range checkScript fn test_dict_comprehension_with_type_annotation fn d Dict int str = i chr i + i range d checkScript fn assertRaisesRegex RuntimeError assertRaisesRegex AssertionError Expected Dict type annotation dict comprehension found Tuple int str torch jit script fn d Tuple int str = i chr i + i range d test_dict_comprehension_scope comprehension_can_access_outer_scope_variables lst = foo bar baz l len l l lst checkScript comprehension_can_access_outer_scope_variables assertRaisesRegex RuntimeError undefined value i torch jit script outer_scope_cannot_access_comprehension_variables d = i chr i + i range i = i + noqa F test_for_tuple_assign test_simple_assign x type Tuple int float - float sum = x sum += float sum checkScript test_simple_assign test_tuple_assign x type Tuple Tuple int int Tuple int int - int sum = x sum += sum += sum checkScript test_tuple_assign test_single_starred_lhs assertRaisesRegex RuntimeError A Starred expression may only appear lhs within presence another non-starred expression cu = torch jit CompilationUnit single_starred_lhs x = x x x b = b test_singleton_tuple_unpack foo b = b + checkScript foo torch rand test_tuple_assignments var_tuple_assign x y type Tuple Tensor Tensor Tensor - Tensor b c = x y + b + c tuple_inputs = torch randn torch randn checkScript var_tuple_assign tuple_inputs torch randn nested_tuple_assign x y z type int Tuple int Tuple int int Tuple int int - int b c d e f = x y z + b + c + d + e + f checkScript nested_tuple_assign subscript_tuple_assign x i type List int Tensor int - Tuple int Tensor int i x i b = i + x + b checkScript subscript_tuple_assign torch tensor star_tuple_assign type - Tuple int int Tuple int int Tuple int int b c d = b c d checkScript star_tuple_assign subscript_tuple_augmented_assign type Tuple int int - Tuple int int += assertRaisesRegex RuntimeError does support augmented assign scripted_aug_assign = torch jit script subscript_tuple_augmented_assign test_multiple_assign test = b c = d f = side effect ten = torch tensor ten = ten = ten add_ ordering x = y = x y = y x + y b c d f ten ten ten x y checkScript test test_opt_opt_refinement torch jit script test_unify weight bias type Optional int Optional int - Optional int weight None opt = None bias None opt = opt = None opt test_optional_refinement torch jit script test_if_none_assignment x type Optional int - int x None x = x + assertEqual test_if_none_assignment test_optional_conversion torch jit script other_fn x=None type Optional int - int torch jit _unwrap_optional x torch jit script fn x type int - int other_fn x assertEqual fn torch jit script unify_to_optional x type bool - Optional int x = None = assertEqual unify_to_optional True None assertEqual unify_to_optional False torch jit script opt_list x type Optional List float - int torch jit script broadcast_opt_list x type Optional BroadcastingList float - int torch jit script opt_list_tuple_caller x type Tuple float float - int opt_list x + broadcast_opt_list x assertEqual opt_list_tuple_caller test_optional_tuple fn x=None type Optional Tuple int int - Tuple int int x None new_x = new_x = x new_x checkScript fn checkScript fn test_namedtuple_redefine global _ _ _ = namedtuple GoogLeNetOutputs logits aux_logits aux_logits _ = namedtuple GoogLeNetOutputs different assertRaisesRegex RuntimeError r redefine torch jit script foo x y type _ _ - _ x test_namedtuple_py global _GoogLeNetOutputs see local resolution python _GoogLeNetOutputs = namedtuple GoogLeNetOutputs logits aux_logits aux_logits torch jit script foo x type _GoogLeNetOutputs - _GoogLeNetOutputs x vals = torch rand torch rand torch rand out = foo _GoogLeNetOutputs logits=vals aux_logits =vals aux_logits =vals assertEqual out logits vals assertEqual out aux_logits vals assertEqual out aux_logits vals test_namedtuple_good_error global _GoogLeNetOutputs see local resolution python _GoogLeNetOutputs = namedtuple GoogLeNetOutputs logits aux_logits aux_logits torch jit script foo x type _GoogLeNetOutputs - _GoogLeNetOutputs x assertRaisesRegex RuntimeError r aka NamedTuple\ logits aux_logits aux_logits \ out = foo _GoogLeNetOutputs logits= aux_logits = aux_logits = test_namedtuple_error_source_attribution _NamedTupleBadMemberType NamedTuple f torch Tensor f ABadForwardRefType noqa F make_global _NamedTupleBadMemberType see local resolution python fn x _NamedTupleBadMemberType - torch Tensor x f relu assert has location associated error note + regex i e least one space assertRaisesRegex ValueError +File torch jit script fn test_inherited_annotations_python_ See In python = inspect get_annotations doesn t always same values Sometimes will show all annotations other times will show only annotations show classes inherits fro BaseModule torch nn Module state List int forward x pass do_something_with_list x List int x x - Submodule BaseModule __init__ self_x_value super __init__ x = self_x_value state = forward x x + x + do_something_with_list state LowestModule Submodule __init__ - None super __init__ mod = LowestModule mod = LowestModule mod_s = torch jit script mod mod _s = torch jit script mod __name__ == __main__ raise_on_run_directly test test_jit py
Owner s module inductor functools logging typing Any Callable Optional Union torch torch _inductor codegen subgraph SubgraphTemplate torch _inductor ir Buffer FixedLayout ir_node_to_tensor TensorBox torch _inductor lowering lowerings validate_ir torch _inductor select_algorithm autotune_select_algorithm ExternKernelChoice torch _inductor virtualized V torch utils _ordered_set OrderedSet log = logging getLogger __name__ CustomOpConfig Config custom op autotuning Specifies optional decomposition function parameter values Each config creates exactly one variant Args decomposition Optional functions autotune If provided default will used params Parameters passed function Examples CustomOpConfig attention_impl head_dim= method= chunked CustomOpConfig head_dim= method= chunked __init__ decomposition Optional Callable Any = None params Any decomposition None callable decomposition raise TypeError f decomposition must callable got type decomposition decomposition = decomposition params = params get_decomposition default_impl Optional Callable Any = None - Callable Any Return decomposition function config When decomposition specified default implementation decomposition None decomposition default_impl None callable default_impl default_impl raise TypeError No decomposition specified config no default implementation provided Please provide decomposition function CustomOpConfig __repr__ - str decomp_name = decomposition __name__ decomposition default params params_str = join f k = v k v params items f CustomOpConfig decomp_name params_str f CustomOpConfig decomp_name __all__ = autotune_custom_op register_custom_op_autotuning CustomOpConfig _extract_tensor_inputs args tuple Any kwargs dict str Any - tuple list Any dict str Any Extract tensor inputs mixed args kwargs Separates tensors autotuning input_nodes non-tensor parameters Non-tensor kwargs later functools partial d into decomposition functions Args args Positional arguments mix tensors scalars kwargs Keyword arguments mix tensors scalars Returns Tuple tensor_inputs_list non_tensor_kwargs tensor_inputs = non_tensor_kwargs = Process args kwargs separate tensor inputs non tensor args i arg enumerate args isinstance arg TensorBox Buffer tensor_inputs append arg Add non-tensor positional args kwargs generated names non_tensor_kwargs f arg_ i = arg key value kwargs items isinstance value TensorBox Buffer tensor_inputs append value non_tensor_kwargs key = value tensor_inputs non_tensor_kwargs _merge_config_and_runtime_kwargs config_params dict str Any runtime_kwargs dict str Any - dict str Any Merge config parameters runtime kwargs Runtime kwargs take precedence If there conflicts log warning use runtime value Args config_params Parameters CustomOpConfig runtime_kwargs Runtime non-tensor kwargs _extract_tensor_inputs Returns Merged kwargs dictionary runtime values taking precedence merged_kwargs = config_params copy Check conflicts let runtime kwargs dominate conflicts = OrderedSet config_params keys intersection runtime_kwargs keys key conflicts log warning Parameter s specified both CustomOpConfig s runtime s Using runtime value key config_params key runtime_kwargs key Runtime kwargs override config params merged_kwargs update runtime_kwargs merged_kwargs _adapt_user_input_gen_fns inputs list Any arg_names list str user_input_gen_fns dict str Callable torch Tensor torch Tensor - dict int Callable Any torch Tensor Convert user input generators name-based index-based format Inductor autotune s input_gen_fns expects index arg_names key Uses V graph sizevars size_hints guess best dynamic shapes torch _inductor config name_to_index = name i i name enumerate arg_names index_based_fns = name gen_fn user_input_gen_fns items name name_to_index index_based_fns name_to_index name = gen_fn log warning Unknown argument name s input_gen_fns Available argument names s name list name_to_index keys create_internal_input_gen_fn user_function Callable torch Tensor torch Tensor arg_name str - Callable Any torch Tensor Create internal input generator converts IR buffer user s fake tensor internal_input_gen_fn ir_buffer Any - torch Tensor raw_shape = ir_buffer get_size concrete_shape = V graph sizevars size_hints raw_shape fallback=config unbacked_symint_fallback fake_tensor = torch empty concrete_shape dtype=ir_buffer get_dtype device= meta user_function fake_tensor internal_input_gen_fn i create_internal_input_gen_fn user_gen_fn arg_names i i len arg_names f arg_ i i user_gen_fn index_based_fns items i len inputs _create_fallback_choice name str default_impl Callable Any fake_output torch Tensor kwargs dict str Any - ExternKernelChoice Create fallback choice default implementation fallback_wrapper args Any - Any default_impl args kwargs ExternKernelChoice kernel=fallback_wrapper name=f name _fallback_default has_out_variant=False op_overload=default_impl use_fallback_kernel=True autotune_custom_op name str decompositions list Callable Any inputs list Any non_tensor_args list dict str Any op_overload torch _ops OpOverload user_input_gen_fns Optional dict str Callable torch Tensor torch Tensor = None - Union TensorBox Any Autotune custom operations comparing multiple decomposition implementations Currently supports SINGLE OUTPUT custom ops only TODO Add support multiple output custom ops tuple list returns This function generates multiple implementation choices custom operation uses Inductor s autotuning system select best performing variant runtime Args name Unique identifier autotuning operation decompositions List alternative implementation functions benchmark inputs Input tensor IR nodes compilation TensorBox Buffer objects non_tensor_args List kwargs dicts paired corresponding decompositions arg op_overload OpOverload custom op used fallback implementation user_input_gen_fns Optional custom input generators benchmarking Maps input indices functions take fake tensors real tensors performance measurement Returns IR node representing optimized operation result Raises TypeError If decompositions list tuple RuntimeError If no inputs no valid choices generated isinstance decompositions list tuple raise TypeError f decompositions must list tuple callables got type decompositions inputs raise RuntimeError f Custom op name requires tensor inputs autotuning len decompositions = len non_tensor_args raise ValueError f decompositions non_tensor_args must have same length f got len decompositions decompositions len non_tensor_args kwargs template = SubgraphTemplate name=name choices = template generate_custom_op_choices name=name decompositions=decompositions input_nodes=list inputs non_tensor_args=non_tensor_args Add default implementation fallback op_overload hasattr op_overload _op fallback_name = f name _fallback_default torch _inductor select_algorithm extern_kernels Skip extern_kernel already registered avoid duplicate registration error hasattr extern_kernels fallback_name V fake_mode fake_inputs = ir_node_to_tensor inp inp inputs fallback_kwargs = non_tensor_args non_tensor_args fake_output = op_overload fake_inputs fallback_kwargs fallback_choice = _create_fallback_choice name op_overload fake_output fallback_kwargs fallback_choice maybe_append_choice choices=choices input_nodes=list inputs layout=FixedLayout device=fake_output device dtype=fake_output dtype size=fake_output shape stride=fake_output stride choices raise RuntimeError f No valid choices generated name Convert user input generation functions internal format input_gen_fns = user_input_gen_fns inspect arg_names = list inspect signature decompositions parameters keys decompositions input_gen_fns = _adapt_user_input_gen_fns inputs arg_names user_input_gen_fns autotune_select_algorithm name=name choices=choices input_nodes=list inputs layout=choices layout input_gen_fns=input_gen_fns register_custom_op_autotuning custom_op torch _library custom_ops CustomOpDef configs Union list CustomOpConfig list Callable Any name Optional str = None input_gen_fns Optional dict str Callable torch Tensor torch Tensor = None - None Register custom op autotuning custom_op configs where each config specifies decomposition implementation function its parameter values Args custom_op Custom operation decorated function torch library custom_op configs List CustomOpConfig objects name Operation name default op_name _autotuned input_gen_fns Custom input generators benchmarking Examples torch library custom_op mylib attention mutates_args= my_attention query key value head_dim= register_custom_op_autotuning my_attention configs= CustomOpConfig attention_impl head_dim= method= chunked CustomOpConfig attention_impl head_dim= method= tiled CustomOpConfig head_dim= No decomposition specified use default input_gen_fns= query lambda fake torch randn_like fake device= cuda key lambda fake torch randn_like fake device= cuda value lambda fake torch randn_like fake device= cuda torch _library custom_ops CustomOpDef isinstance custom_op CustomOpDef raise TypeError f custom_op must CustomOpDef decorated function torch library custom_op f got type custom_op op_overload = custom_op _opoverload default_impl = custom_op _init_fn isinstance configs list tuple raise TypeError f configs must list tuple got type configs processed_configs = config configs isinstance config CustomOpConfig processed_configs append config raise TypeError f Each config must CustomOpConfig object got type config processed_configs raise ValueError At least one config must provided name None name = f op_overload _name _autotuned functools wraps op_overload autotuning_lowering args Any kwargs Any - Any Inductor lowering function replaces custom op calls autotuned versions Extract tensor inputs non-tensor parameters runtime kwargs tensor_inputs runtime_kwargs = _extract_tensor_inputs args kwargs Prepare decompositions kwargs merging config params runtime kwargs decompositions = non_tensor_args = config processed_configs decomp = config get_decomposition default_impl=default_impl decompositions append decomp Merge config params runtime kwargs runtime takes precedence merged_kwargs = _merge_config_and_runtime_kwargs config params runtime_kwargs non_tensor_args append merged_kwargs result = autotune_custom_op name=name decompositions=decompositions inputs=tensor_inputs non_tensor_args=non_tensor_args op_overload=op_overload user_input_gen_fns=input_gen_fns validate_ir result result lowerings op_overload = autotuning_lowering
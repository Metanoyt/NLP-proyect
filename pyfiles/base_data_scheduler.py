mypy allow-untyped-defs abc warnings weakref functools wraps torch ao pruning _experimental data_sparsifier BaseDataSparsifier __all__ = BaseDataScheduler BaseDataScheduler r The BaseDataScheduler abstract scheduler specifically BaseDataSparsifier This controls specific hyperparameter sparsifier varies across training process across time Args data_sparsifier instance BaseDataSparsifier Implemented data sparsifier wherein update_mask implemented schedule_param str A specific hyperparameter passed sparsifier needs scheduled varied last_epoch int default=- This specifically passed when training needs resumed particular point verbose bool default=False Verbosity BaseDataScheduler The get_hyperparam function needs implemented user __init__ data_sparsifier schedule_param str last_epoch=- verbose=False Attach sparsifier isinstance data_sparsifier BaseDataSparsifier raise TypeError f type data_sparsifier __name__ instance torch ao pruning BaseDataSparsifier data_sparsifier = data_sparsifier schedule_param = schedule_param Initialize epoch base hyper-params base_param = name config get schedule_param None name config data_sparsifier data_groups items last_epoch = last_epoch Following https github com pytorch pytorch issues We would like ensure ` scheduler step ` called after ` sparsifier step ` with_counter method getattr method _with_counter False ` sparsifier step ` has already been replaced method Keep weak reference sparsifier instance prevent cyclic references instance_ref = weakref ref method __self__ Get unbound method same purpose func = method __func__ cls = instance_ref __class__ del method wraps func wrapper args kwargs instance = instance_ref instance _step_count += type ignore union-attr wrapped = func __get__ instance cls wrapped args kwargs Note returned function here no longer bound method so attributes like ` __func__ ` ` __self__ ` no longer exist wrapper _with_counter = True type ignore attr-defined wrapper data_sparsifier step = with_counter data_sparsifier step type ignore assignment data_sparsifier _step_count = type ignore attr-defined _step_count int = verbose = verbose Housekeeping _get_sp_called_within_step bool = False sp - schedule parameter step abc abstractmethod get_schedule_param r Abstract method needs implemented child The expected type should dictionary name schedule_param value The returned values will updated sparsifier when scheduler step function called Example get_schedule_param new_param = name sparsifier data_groups keys new_param name = sparsifier data_groups name schedule_param new_param When step function called value sparsifier data_groups name schedule_param would halved raise NotImplementedError __repr__ format_string = __class__ __name__ + format_string += \n format_string += f Data Sparsifier data_sparsifier \n format_string += f schedule_param base_param \n format_string += format_string state_dict Returns state scheduler ` dict ` It contains entry every variable __dict__ which sparsifier Note The scheduler does track state data_sparsifier Make sure store state sparsifier before storing state scheduler key value key value __dict__ items key = data_sparsifier load_state_dict state_dict Loads schedulers state Note Remember restore state data_sparsifier before scheduler Args state_dict dict scheduler state Should object returned call meth ` state_dict ` __dict__ update state_dict get_last_param _last_param step Raise warning trying call scheduler step before sparsifier https github com pytorch pytorch issues _step_count == hasattr data_sparsifier step _with_counter warnings warn Seems like ` data_sparsifier step ` has been overridden after sparsity scheduler initialization Please make sure call ` data_sparsifier step ` before ` scheduler step ` UserWarning stacklevel= Just check there two first scheduler step calls before sparsifier step data_sparsifier _step_count type ignore attr-defined warnings warn Detected call ` scheduler step ` before ` data_sparsifier step ` You have make sure you run data_sparsifier step BEFORE any calls scheduler step UserWarning stacklevel= _step_count += _enable_get_sp_call __init__ o o = o __enter__ o _get_sp_called_within_step = True __exit__ type value traceback o _get_sp_called_within_step = False _enable_get_sp_call last_epoch += updated_scheduler_params = get_schedule_param name param updated_scheduler_params items data_sparsifier data_groups name schedule_param = param verbose print f Adjusting schedule_param group name param _last_param = name config get schedule_param None name config data_sparsifier data_groups items data_sparsifier enable_mask_update = True
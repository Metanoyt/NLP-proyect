Owner s module cuda sys unittest torch torch testing _internal common_cuda TEST_CUDA TEST_MULTIGPU torch testing _internal common_utils NoTest run_tests skipIfRocm TestCase NOTE needs run brand new process TEST_CUDA print CUDA available skipping tests file=sys stderr TestCase = NoTest noqa F torch testing _internal common_utils markDynamoStrictTest TestCudaPrimaryCtx TestCase CTX_ALREADY_CREATED_ERR_MSG = Tests defined test_cuda_primary_ctx py must run process where CUDA contexts never created Use either run_test py add -- subprocess run each test different subprocess setUp device range torch cuda device_count Ensure context has been created beforehand assertFalse torch _C _cuda_hasPrimaryContext device TestCudaPrimaryCtx CTX_ALREADY_CREATED_ERR_MSG skipIfRocm msg= last checked ROCm HIP runtime doesn t create context hipSetDevice test_set_device_ In CUDA behavior cudaSetDevice has changed It eagerly creates context target The behavior ` torch cuda set_device ` should also create context device Initially we should have any context device assertFalse torch _C _cuda_hasPrimaryContext torch cuda set_device Now after device set context should present CUDA assertTrue torch _C _cuda_hasPrimaryContext unittest skipIf TEST_MULTIGPU only one GPU detected test_str_repr x = torch randn device= cuda We should have only created context cuda assertFalse torch _C _cuda_hasPrimaryContext assertTrue torch _C _cuda_hasPrimaryContext str x repr x We should still have only created context cuda assertFalse torch _C _cuda_hasPrimaryContext assertTrue torch _C _cuda_hasPrimaryContext unittest skipIf TEST_MULTIGPU only one GPU detected test_copy x = torch randn device= cuda We should have only created context cuda assertFalse torch _C _cuda_hasPrimaryContext assertTrue torch _C _cuda_hasPrimaryContext y = torch randn device= cpu y copy_ x We should still have only created context cuda assertFalse torch _C _cuda_hasPrimaryContext assertTrue torch _C _cuda_hasPrimaryContext unittest skipIf TEST_MULTIGPU only one GPU detected test_pin_memory x = torch randn device= cuda We should have only created context cuda assertFalse torch _C _cuda_hasPrimaryContext assertTrue torch _C _cuda_hasPrimaryContext assertFalse x is_pinned We should still have only created context cuda assertFalse torch _C _cuda_hasPrimaryContext assertTrue torch _C _cuda_hasPrimaryContext x = torch randn device= cpu pin_memory We should still have only created context cuda assertFalse torch _C _cuda_hasPrimaryContext assertTrue torch _C _cuda_hasPrimaryContext assertTrue x is_pinned We should still have only created context cuda assertFalse torch _C _cuda_hasPrimaryContext assertTrue torch _C _cuda_hasPrimaryContext x = torch randn device= cpu pin_memory=True We should still have only created context cuda assertFalse torch _C _cuda_hasPrimaryContext assertTrue torch _C _cuda_hasPrimaryContext x = torch zeros device= cpu pin_memory=True We should still have only created context cuda assertFalse torch _C _cuda_hasPrimaryContext assertTrue torch _C _cuda_hasPrimaryContext x = torch empty device= cpu pin_memory=True We should still have only created context cuda assertFalse torch _C _cuda_hasPrimaryContext assertTrue torch _C _cuda_hasPrimaryContext x = x pin_memory We should still have only created context cuda assertFalse torch _C _cuda_hasPrimaryContext assertTrue torch _C _cuda_hasPrimaryContext __name__ == __main__ run_tests
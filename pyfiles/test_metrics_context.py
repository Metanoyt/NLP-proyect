Owner s module dynamo torch _dynamo metrics_context MetricsContext TopN torch _dynamo test_case run_tests TestCase TestMetricsContext TestCase setUp super setUp metrics = _on_exit start_ns end_ns metrics exc_type exc_value Save away metrics validated test metrics = metrics copy test_context_exists Setting value without entering context should raise context = MetricsContext _on_exit assertRaisesRegex RuntimeError outside MetricsContext context increment m assertRaisesRegex RuntimeError outside MetricsContext context set m assertRaisesRegex RuntimeError outside MetricsContext context update m test_nested_context Only outermost context should get on_exit call should include everything context = MetricsContext _on_exit context context context set m assertEqual metrics context set m assertEqual metrics m m test_set Validate various ways set metrics MetricsContext _on_exit context context set m context set m context update m m assertEqual metrics m m m m test_set_disallow_overwrite Validate set won t overwrite MetricsContext _on_exit context context set m assertRaisesRegex RuntimeError already been set context set m assertEqual metrics m test_update_disallow_overwrite Validate update won t overwrite MetricsContext _on_exit context context update m m assertRaisesRegex RuntimeError already been set context update m m test_update_allow_overwrite Validate update will overwrite when given param MetricsContext _on_exit context context update m m context update m m overwrite=True assertEqual metrics m m m test_add_to_set Validate add_to_set MetricsContext _on_exit context context add_to_set m context add_to_set m context add_to_set m context add_to_set m assertEqual metrics m m assertTrue isinstance metrics m set assertTrue isinstance metrics m set test_set_key_value MetricsContext _on_exit context context set_key_value feature_usage k True Overrides allowed context set_key_value feature_usage k True context set_key_value feature_usage k False assertEqual metrics feature_usage k True k False test_top_n top_n = TopN k v seven four five six eight top_n add k v assertEqual len top_n print list top_n assertEqual list top_n eight seven six __name__ == __main__ run_tests
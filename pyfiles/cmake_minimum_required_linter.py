__future__ annotations argparse concurrent futures fnmatch json logging os re sys enum Enum pathlib Path typing NamedTuple packaging requirements Requirement packaging version Version sys version_info = tomllib tomli tomllib type ignore import-not-found REPO_ROOT = Path __file__ absolute parents sys path insert str REPO_ROOT tools setup_helpers env CMAKE_MINIMUM_VERSION_STRING sys path remove str REPO_ROOT LINTER_CODE = CMAKE_MINIMUM_REQUIRED CMAKE_MINIMUM_VERSION = Version CMAKE_MINIMUM_VERSION_STRING LintSeverity str Enum ERROR = error WARNING = warning ADVICE = advice DISABLED = disabled LintMessage NamedTuple path str &#124; None line int &#124; None char int &#124; None code str severity LintSeverity name str original str &#124; None replacement str &#124; None description str &#124; None format_error_message filename str error Exception &#124; None = None line int &#124; None = None message str &#124; None = None - LintMessage message None error None message = f Failed due error __class__ __name__ \n error LintMessage path=filename line=line char=None code=LINTER_CODE severity=LintSeverity ERROR name= CMake minimum version original=None replacement=None description=message CMAKE_MINIMUM_REQUIRED_PATTERN = re compile r cmake_minimum_required\ VERSION\s+ P version \d+\ \d+ \ \d+ \b \ flags=re IGNORECASE check_cmake path Path - list LintMessage path open encoding= utf- f i line enumerate f start= match = CMAKE_MINIMUM_REQUIRED_PATTERN search line version = match group version path samefile REPO_ROOT CMakeLists txt Version version = CMAKE_MINIMUM_VERSION format_error_message str path line=i message= f CMake minimum version must CMAKE_MINIMUM_VERSION f found version Version version CMAKE_MINIMUM_VERSION format_error_message str path line=i message= f The environment can only provide CMake CMAKE_MINIMUM_VERSION f found requiring version check_requirement requirement Requirement path Path line int &#124; None = None - LintMessage &#124; None requirement name lower = cmake None spec requirement specifier spec operator == = Version spec version removesuffix CMAKE_MINIMUM_VERSION format_error_message str path line=line message= f CMake minimum version must least CMAKE_MINIMUM_VERSION f found spec None check_pyproject path Path - list LintMessage try pyproject = tomllib loads path read_text encoding= utf- except tomllib TOMLDecodeError OSError err format_error_message str path err isinstance pyproject dict isinstance pyproject get build-system dict build_system = pyproject build-system requires = build_system get requires isinstance requires list list filter None check_requirement Requirement req path=path req requires check_requirements path Path - list LintMessage try path open encoding= utf- f lines = f readlines except OSError err format_error_message str path err lint_messages = i line enumerate lines start= line = line strip line line startswith - continue try requirement = Requirement line except Exception continue lint_message = check_requirement requirement path=path line=i lint_message None lint_messages append lint_message lint_messages check_file filename str - list LintMessage path = Path filename absolute basename = path name lower basename cmakelists txt cmakelists txt basename endswith cmake cmake check_cmake path basename == pyproject toml check_pyproject path fnmatch fnmatch basename requirements txt fnmatch fnmatch basename requirements check_requirements path main - None parser = argparse ArgumentParser description= Check consistency cmake minimum version requirement files fromfile_prefix_chars= parser add_argument -- verbose action= store_true help= verbose logging parser add_argument filenames nargs= + help= paths lint args = parser parse_args logging basicConfig format= processName s levelname s message s level=logging NOTSET args verbose logging DEBUG len args filenames logging INFO stream=sys stderr concurrent futures ProcessPoolExecutor max_workers=os cpu_count executor futures = executor submit check_file x x x args filenames future concurrent futures as_completed futures try lint_message future result print json dumps lint_message _asdict flush=True except Exception logging critical Failed s futures future raise __name__ == __main__ main
mypy allow-untyped-defs argparse os re subprocess sys pathlib Path remove_triton_function_declaration source_code str - str remove_head = re sub r \n +\s\ \ \ \n \n source_code remove_tail = re sub r \ \ \ \ + \n remove_head remove_tail remove_async_compile source_code str - str remove_top_level = str replace source_code async_compile = AsyncCompile remove_compile = str replace remove_top_level async_compile wait globals remove_del = str replace remove_compile del async_compile remove_del rename_kernels source_code str - str pattern = r \w+ \s =\s async_compile\ triton\ triton_ \s triton_kernel_decl = triton_ matches = match end match group match re finditer pattern source_code re DOTALL Starting last match avoid issues shifting indices after replacements end_index captured_string reversed matches Find index next B after current match index_of_B = source_code find triton_kernel_decl end_index index_of_B = - Replace triton_kernel_decl captured string source_code = source_code index_of_B + f captured_string + source_code index_of_B + len triton_kernel_decl If triton_kernel_decl found after current match continue next continue source_code merge_params original_params list str new_params list str - list str idx range len new_params new_params idx == T new_params idx = original_params idx new_params add_launch_params original str kernel_to_params dict str tuple str str - str Regex match function call original string pattern = r \w+ \ run\ \ replace match - str Extract parts regex match func_name = match group params = match group new_params grid = kernel_to_params func_name new_params = merge_params params split new_params split Format new function call new_string = f func_name grid join new_params new_string transformed = re sub pattern replace original remove_inductor_wrappers = re sub r triton_heuristics ^ triton jit r triton jit transformed flags=re DOTALL remove_inductor_wrappers process_file input_filename str output_filename str auto_generate_params bool = True - str open input_filename file source_code = file read transformed_code = source_code triton_ source_code raise RuntimeError Need run original Pytorch code generating kernels TORCHINDUCTOR_UNIQUE_KERNEL_NAMES= transformed_code = rename_kernels transformed_code transformed_code = remove_triton_function_declaration transformed_code transformed_code = remove_async_compile transformed_code launch_params_filename = f input_filename launch_params Auto-generate launch_params they don t exist auto_generate_params True os path exists launch_params_filename auto_generate_params print f Launch params file launch_params_filename found Generating try Set environment variable run input file env = os environ copy env TORCHINDUCTOR_DUMP_LAUNCH_PARAMS = result = subprocess run sys executable input_filename env=env capture_output=True text=True cwd=os path dirname input_filename result returncode = print f Error running input_filename print f stdout result stdout print f stderr result stderr raise RuntimeError f Failed generate launch params Command failed code result returncode print f Successfully generated launch_params_filename except Exception e raise RuntimeError f Failed generate launch params running input_filename str e e os path exists launch_params_filename raise RuntimeError f Missing launch_params_filename Run ` TORCHINDUCTOR_DUMP_LAUNCH_PARAMS= python input_filename ` first open launch_params_filename f launch_params_meta = f readlines split_params = i split &#124; i launch_params_meta kernel_args_grid = strip b strip c strip b c split_params transformed_code = add_launch_params transformed_code kernel_args_grid open output_filename w file file write transformed_code print f Successfully generated output_filename transformed_code get_clean_triton input_path Path output_path Path = Path triton_only_repro py auto_generate_params bool = True Run experiments output results file Args input_path Optional Path Path inductor generated output codede output_path Optional Path Path write out new python file auto_generate_params bool Whether automatically generate launch_params missing process_file str input_path str output_path auto_generate_params __name__ == __main__ Sample usage Running sweep python _get_clean_triton py output_code py To disable auto-generation launch params python _get_clean_triton py output_code py -- no-auto-generate parser = argparse ArgumentParser description= Clean Inductor generated code remove Inductor dependencies Add arguments parser add_argument input_path type=Path help= Path inductor generated output code parser add_argument -- output_path type=Path default=Path triton_only_repro py help= Path write out clean triton output parser add_argument -- no-auto-generate action= store_true help= Disable automatic generation launch_params file Parse arguments args = parser parse_args Call function parsed arguments result = get_clean_triton args input_path args output_path args no_auto_generate
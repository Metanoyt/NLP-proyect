Utilities lowering subgraphs used higher order operators functools operator collections abc Generator contextlib contextmanager dataclasses dataclass typing Any Callable Optional TypeVar Union typing_extensions ParamSpec torch torch utils _ordered_set OrderedSet ir exc SubgraphLoweringException graph GraphLowering ops_handler SimpleCSEHandler virtualized ops V WrapperHandler T = TypeVar T _P = ParamSpec _P OpOverload = torch _ops OpOverload LoweringDict = dict Union OpOverload str Callable Any TargetType = Union Callable Any str PointwiseSubgraphLowering torch fx Interpreter Lowers pointwise subgraph single set buffers separate lowering object Errors buffers created unexpectedly graph_outputs Optional list ir IRNode root_graph GraphLowering _current_op Optional TargetType For backwards buffer_grads scatters we allow mutations allowed_mutations Optional OrderedSet OpOverload additional_lowerings Optional LoweringDict buffers list ir Buffer mutated_buffers OrderedSet str __init__ gm torch fx GraphModule root_graph_lowering GraphLowering allowed_mutations Optional OrderedSet OpOverload = None additional_lowerings Optional LoweringDict = None - None super __init__ gm graph_outputs = None root_graph = root_graph_lowering allowed_mutations = allowed_mutations additional_lowerings = additional_lowerings _current_op = None Used track buffers created during lowering mutated_buffers = OrderedSet buffers = contextmanager _op_context op TargetType - Generator None None None Set which op being processed call function know we can mutate buffers previous = _current_op _current_op = op try yield finally _current_op = previous _approved_mutator - bool allowed_mutations None _current_op allowed_mutations mark_buffer_mutated name str - None _approved_mutator mutated_buffers add name raise SubgraphLoweringException f Buffer mutation detected during lowering _current_op Buffer mutations only allowed approved mutation ops This error lowering subgraph please file bug report register_buffer buffer ir Buffer set_name bool = False - str _approved_mutator name = root_graph register_buffer buffer set_name=set_name name raise SubgraphLoweringException Buffers cannot created while lowering pointwise subgraph This could good reason e g you re calling op we can t codegen pointwise op could also bug Please file bug report you think should supportable __getattr__ name str - Any getattr root_graph name call_function target TargetType args Any kwargs dict str Any - Any lowering lowerings _op_context target target operator getitem isinstance args list tuple dict super call_function target args kwargs These takes precedence over main lowerings additional_lowerings None target additional_lowerings assert isinstance target OpOverload additional_lowerings target args kwargs target lowerings raise SubgraphLoweringException f target supported subgraph missing lowering lowerings target args kwargs output target str args tuple Any kwargs dict str Any - None type ignore override assert len args == graph_outputs = args dataclass InputDescriptor dtype torch dtype device torch device TracingOpsHandler WrapperHandler __init__ tracer torch fx Tracer num_inputs int - None parent = tracer create_proxy placeholder ops super __init__ parent tracer = tracer placeholders = tracer create_proxy placeholder f input i i range num_inputs placeholder idx int - torch fx Proxy placeholders idx output args tuple object - None tracer create_node output output tuple tracer create_arg args lower_pointwise_subgraph subgraph ir Subgraph inputs list InputDescriptor - Callable _P Any Lower subgraph ir Pointwise nodes fake_inner_fn loop_idx int input_idx int - Union ir Expr ir TensorBox None ops placeholder input_idx graph_inputs = ir Pointwise create device=desc device dtype=desc dtype inner_fn=functools partial fake_inner_fn input_idx=i ranges= i desc enumerate inputs gm = subgraph graph_module pw_subgraph = PointwiseSubgraphLowering gm root_graph_lowering=V graph V set_graph_handler pw_subgraph type ignore arg-type pw_subgraph run graph_inputs Combine multiple pointwise computations into single graph module Do tracing through each individually doing CSE tracer = torch fx Tracer tracer graph = torch fx Graph tracer_cls=tracer __class__ trace_ops = SimpleCSEHandler TracingOpsHandler tracer len inputs assert pw_subgraph graph_outputs None V set_ops_handler trace_ops output_irs = out_var pw_subgraph graph_outputs assert isinstance out_var ir TensorBox type out_var assert out_var get_size == assert isinstance out_var data ir StorageBox assert isinstance out_var data data ir Pointwise idx = ir_out = out_var data data inner_fn idx output_irs append ir_out ops output output_irs lowered_gm = torch fx GraphModule tracer graph inner_fn args _P args kwargs _P kwargs - Any lowered_gm V get_ops_handler args kwargs inner_fn
Owner s module fx unittest mock torch torch fx passes net_min_base _MinimizerBase _MinimizerSettingBase FxNetMinimizerResultMismatchError torch fx passes tools_common Names torch testing _internal common_utils TestCase TestNetMinBaseBlock TestCase setUp - None Setup test fixtures each test method SimpleModule torch nn Module __init__ - None super __init__ linear = torch nn Linear linear = torch nn Linear relu = torch nn ReLU forward x torch Tensor - torch Tensor x = linear x x = linear x x = relu x x compare_fn = mock MagicMock module = torch fx symbolic_trace SimpleModule sample_input = torch randn settings = _MinimizerSettingBase traverse_method= block minimizer = _MinimizerBase module=self module sample_input=self sample_input settings=self settings compare_fn=self compare_fn report = assert_problematic_nodes culprit_names Names - None Quick helper function assert set nodes when present together subgraph cause discrepancy mock patch torch fx passes net_min_base _MinimizerBase _run_and_compare run_and_compare_side_effect split_module torch fx GraphModule submod_name str output_names Names report_idx int = - - None submodule = getattr split_module submod_name Remove input output layer names = set node name node submodule graph nodes - set culprit_names = names raise FxNetMinimizerResultMismatchError minimizer _run_and_compare side_effect = run_and_compare_side_effect Every single node should discrepancy culprits = minimizer minimize assertEqual node name node culprits set culprit_names test_no_discrepancy - None No discrepancies should handle gracefully empty set mock patch torch fx passes net_min_base _MinimizerBase run_a mock patch torch fx passes net_min_base _MinimizerBase run_b Have both run_a run_b same result return_value = torch zeros minimizer run_a return_value = return_value minimizer run_b return_value = return_value compare_fn return_value = True There should no discrepancy between two thus we should receive empty set culprits = minimizer minimize assertEqual culprits set test_all_nodes_discrepancy - None assert_problematic_nodes linear linear relu test_first_node_discrepancy - None assert_problematic_nodes linear test_last_node_discrepancy - None assert_problematic_nodes relu test_middle_node_discrepancy - None assert_problematic_nodes linear test_contiguous_partial_discrepancy_end - None assert_problematic_nodes linear relu test_continugous_partial_discrepancy_beginning - None assert_problematic_nodes linear linear __name__ == __main__ raise RuntimeError This test currently used should enabled discover_tests py required
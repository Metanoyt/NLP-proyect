functools logging threading weakref torch torch utils _ordered_set OrderedSet log = logging getLogger __name__ local = threading local local memory_tracker = None BufferMemoryTracker Tracks inductor runtime allocations deallocations compare against expected behavior __init__ - None tensor_tracker dict str torch storage UntypedStorage = weakref WeakValueDictionary type ignore assignment died_since_last_step OrderedSet str = OrderedSet added_since_last_step OrderedSet str = OrderedSet error = torch _inductor config test_configs track_memory_lifecycle == assert set_tensor name str tensor torch Tensor - None storage = tensor untyped_storage added_since_last_step add name tensor_tracker name = storage on_tensor_death - None died_since_last_step add name weakref finalize storage on_tensor_death advance_step - None died_since_last_step clear added_since_last_step clear log_or_raise msg str - None error raise RuntimeError msg log info msg check_step_delta expected_allocated list str expected_freed list str is_final_step bool - None Check only delta changes since last step Check expected deaths - we dont currently distinguish between nodes which die last step returned outputs so skip final_step is_final_step missing_deaths = OrderedSet expected_freed - died_since_last_step missing_deaths log_or_raise f Expected tensors die still alive missing_deaths Check unexpected deaths unexpected_deaths = died_since_last_step - OrderedSet expected_freed unexpected_deaths log_or_raise f Unexpected tensor deaths unexpected_deaths Check newly alive tensors - separate messages like deaths actual_allocated = added_since_last_step expected_allocated_set = OrderedSet expected_allocated extra_alive = actual_allocated - expected_allocated_set extra_alive log_or_raise f Unexpected allocated tensors extra_alive missing_alive = expected_allocated_set - actual_allocated missing_alive log_or_raise f Expected allocated tensors missing missing_alive Reset next step advance_step is_final_step local memory_tracker = None get_mem_tracker - BufferMemoryTracker local memory_tracker None local memory_tracker = BufferMemoryTracker local memory_tracker track_tensor tensor torch Tensor name str - None get_mem_tracker set_tensor name tensor tracked_empty_strided size list int stride list int dtype torch dtype device torch device name str - torch Tensor o = torch empty_strided size stride dtype=dtype device=device track_tensor o name o check_memory_step allocated list str freed list str is_final_step bool = False - None tracker = get_mem_tracker tracker check_step_delta allocated freed is_final_step functools lru_cache None register_check_mem_op - None lib = torch library Library _inductor_debug FRAGMENT noqa TOR lib define check_memory_step str allocated str freed bool is_final_step - lib impl check_memory_step check_memory_step BackendSelect torch _higher_order_ops effects _EffectType _register_effectful_op _register_effectful_op torch ops _inductor_debug check_memory_step default _EffectType ORDERED
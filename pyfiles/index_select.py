typing Optional torch torchfuzz operators base Operator torchfuzz tensor_fuzzer Spec TensorSpec IndexSelectOperator Operator Operator selecting elements tensor along dimension using indices __init__ super __init__ index_select property torch_op_name - Optional str Return torch operation name torch index_select can_produce output_spec Spec - bool Index select can produce tensors various shapes -dimensional tensors isinstance output_spec TensorSpec False index_select requires least one dimension select len output_spec size fuzz_inputs_specs output_spec Spec num_inputs int = - list Spec Generate input specs index_select operation torch index_select input dim index returns tensor - output shape dim = len index - output shape other_dims = input shape other_dims isinstance output_spec TensorSpec raise ValueError IndexSelectOperator can only produce TensorSpec outputs For simplicity we ll work D input tensor select along dimension dim = output_size = output_spec size Input tensor - create shape where we can select If output k m input can n m where n = k len output_size == Output D input should least D input_size = output_size + Make input larger input_stride = len output_size == Output D input should D first dim = output first dim input_size = output_size + output_size input_stride = output_size Contiguous For higher dimensions keep simple input_size = tuple s + i == dim s i s enumerate output_size Contiguous stride input_stride = tuple int torch tensor input_size i + prod item i len input_size - i range len input_size input_tensor_spec = TensorSpec size=input_size stride=input_stride dtype=output_spec dtype Index tensor - D tensor long dtype indices index_spec = TensorSpec size= output_size dim len output_size stride= dtype=torch long input_tensor_spec index_spec codegen output_name str input_names list str output_spec Spec - str Generate code index_select Creates appropriate indices select input tensor len input_names = raise ValueError IndexSelectOperator requires exactly two inputs isinstance output_spec TensorSpec raise ValueError IndexSelectOperator requires TensorSpec output Determine dimension number indices needed dim = Select along dimension simplicity num_indices = output_spec size dim len output_spec size Generate code creates valid indices within input tensor s dimension f _input_size_ output_name = input_names size dim \n f _index_ output_name = torch randint _input_size_ output_name num_indices device= input_names device \n f output_name = torch index_select input_names dim _index_ output_name
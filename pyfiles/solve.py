logging typing Optional sympy torch utils _sympy functions FloorDiv log = logging getLogger __name__ _MIRROR_REL_OP dict type sympy Basic type sympy Rel = sympy Eq sympy Eq sympy Ne sympy Ne sympy Ge sympy Le sympy Gt sympy Lt sympy Le sympy Ge sympy Lt sympy Gt INEQUALITY_TYPES = sympy Gt sympy Ge sympy Lt sympy Le mirror_rel_op type type - Optional type sympy Rel _MIRROR_REL_OP get type Tries simplify expr so leave only thing left-hand side Returns tuple The simplified expression The expression right-hand side Returns None can t reach state where only thing left hand side thing trials number times try_solve will try isolate thing left-hand side floordiv_inequality flag enable conversion FloorDiv into inequalities try_solve expr sympy Basic thing sympy Basic trials int = floordiv_inequality bool = True - Optional tuple sympy Rel sympy Expr mirror = mirror_rel_op type expr Ignore unsupported expressions - Those relational operations - Those don t have mirror just avoiding unexpected classes isinstance expr sympy Rel mirror None log debug expression unsupported type s type expr None lhs_has_thing = expr lhs has thing rhs_has_thing = expr rhs has thing Give up when thing appears both sides relational expression That because we assume thing we trying isolate only right-hand side lhs_has_thing rhs_has_thing log debug thing s found both sides expression s thing expr None Try considering both LHS RHS mirroring original expression b == b expressions = Add each version expr thing its left-hand side lhs_has_thing expressions append expr rhs_has_thing expressions append mirror expr rhs expr lhs e expressions e None continue isinstance e sympy Rel raise AssertionError expected sympy Rel _ range trials trial = _try_isolate_lhs e thing floordiv_inequality=floordiv_inequality Stop there no change trial trial == e break e = trial type ignore assignment Return we able isolate thing left-hand side isinstance e sympy Rel e lhs == thing log debug solved s --- s expr e e e rhs None _try_isolate_lhs e sympy Basic thing sympy Basic floordiv_inequality bool - sympy Basic op = type e isinstance e sympy Rel Move any constants left-hand side right-hand side lhs_not_thing = sum e lhs args has thing isinstance e lhs sympy Add e = op e lhs - lhs_not_thing e rhs - lhs_not_thing type ignore attr-defined Divide both sides factors don t contain thing isinstance e sympy Rel isinstance e lhs sympy Mul lhs rhs = e args other = sympy Mul lhs args has thing If we can t tell whether other negative positive we do nothing That because we don t know whether we have mirror operation We also divide only when we know rhs zero isinstance e INEQUALITY_TYPES other is_negative None isinstance e INEQUALITY_TYPES rhs is_zero Divide both sides other lhs = lhs other rhs = rhs other If e inequality other negative we have mirror expression isinstance e INEQUALITY_TYPES other is_negative op = mirror_rel_op op type ignore assignment op None raise AssertionError expected op None e = op lhs rhs ################################################################################ left-hand side FloorDiv ################################################################################ Given expression b op c where op relational operation these rules only work - b - c integer floordiv_inequality isinstance e sympy Rel isinstance e lhs FloorDiv e lhs divisor is_positive e rhs is_integer b == expr = = b expr b expr + isinstance e sympy Eq numerator denominator = e lhs args sympy And sympy Ge numerator e rhs denominator sympy Lt numerator e rhs + denominator b = expr = b expr = b expr + isinstance e sympy Ne numerator denominator = e lhs args sympy Or sympy Lt numerator e rhs denominator sympy Ge numerator e rhs + denominator The transformations below only work b positive Note we only have information constants b expr = = b expr + b = expr = = b expr isinstance e sympy Gt sympy Ge quotient = e rhs isinstance e sympy Ge e rhs + sympy Ge e lhs args quotient e lhs args b expr = b expr b = expr = b expr + isinstance e sympy Lt sympy Le quotient = e rhs isinstance e sympy Lt e rhs + sympy Lt e lhs args quotient e lhs args e
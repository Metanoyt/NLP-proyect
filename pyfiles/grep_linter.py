Generic linter greps pattern optionally suggests replacements __future__ annotations argparse json logging os subprocess sys time enum Enum typing NamedTuple IS_WINDOWS bool = os name == nt MAX_FILE_SIZE int = GB bytes MAX_MATCHES_PER_FILE int = Maximum number matches report per file MAX_ORIGINAL_SIZE int = KB - don t compute replacement original larger LintSeverity str Enum ERROR = error WARNING = warning ADVICE = advice DISABLED = disabled LINTER_NAME str = ERROR_DESCRIPTION str &#124; None = None LintMessage NamedTuple path str &#124; None line int &#124; None char int &#124; None code str severity LintSeverity name str original str &#124; None replacement str &#124; None description str &#124; None as_posix name str - str name replace \\ IS_WINDOWS name run_command args list str - subprocess CompletedProcess bytes logging debug $ s join args start_time = time monotonic try subprocess run args capture_output=True finally end_time = time monotonic logging debug took dms end_time - start_time print_lint_message name str severity LintSeverity = LintSeverity ERROR path str &#124; None = None line int &#124; None = None original str &#124; None = None replacement str &#124; None = None description str &#124; None = None - None Create LintMessage print JSON Accepts same arguments LintMessage constructor char = None code = LINTER_NAME description = description ERROR_DESCRIPTION lint_message = LintMessage path line char code severity name original replacement description print json dumps lint_message _asdict flush=True group_lines_by_file lines list str - dict str list str Group matching lines filename Args lines List grep output lines format filename line content Returns Dictionary mapping filename list line remainders without filename prefix grouped dict str list str = line lines line continue Extract filename remainder filename line content format parts = line split filename = parts remainder = parts len parts filename grouped grouped filename = grouped filename append remainder grouped check_allowlist filename str allowlist_pattern str - bool Check file matches allowlist pattern Args filename Path file check allowlist_pattern Pattern grep file Returns True file should skipped allowlist pattern matched False otherwise Prints error message returns False there error running grep allowlist_pattern False try proc = run_command grep -nEHI allowlist_pattern filename except Exception err print_lint_message name= command-failed description= f Failed due err __class__ __name__ \n err isinstance err subprocess CalledProcessError COMMAND exit code returncode \n command \n\n STDERR\n stderr \n\n STDOUT\n stdout format returncode=err returncode command= join as_posix x x err cmd stderr=err stderr decode utf- strip empty stdout=err stdout decode utf- strip empty False allowlist pattern found abort lint proc returncode == True False lint_file filename str line_remainders list str allowlist_pattern str replace_pattern str error_name str - None Lint file one more pattern matches printing LintMessages they re created Args filename Path file being linted line_remainders List line remainders format line content without filename prefix allowlist_pattern Pattern check allowlisting replace_pattern Pattern sed replacement error_name Human-readable error name line_remainders should_skip = check_allowlist filename allowlist_pattern should_skip Check file too large compute replacement file_size = os path getsize filename compute_replacement = replace_pattern file_size = MAX_ORIGINAL_SIZE Apply replacement entire file pattern specified file too large original = None replacement = None compute_replacement When we have replacement report single message line=None try open filename f original = f read proc = run_command sed -r replace_pattern filename replacement = proc stdout decode utf- except Exception err print_lint_message name= command-failed description= f Failed due err __class__ __name__ \n err isinstance err subprocess CalledProcessError COMMAND exit code returncode \n command \n\n STDERR\n stderr \n\n STDOUT\n stdout format returncode=err returncode command= join as_posix x x err cmd stderr=err stderr decode utf- strip empty stdout=err stdout decode utf- strip empty print_lint_message path=filename name=error_name original=original replacement=replacement When no replacement report each matching line up MAX_MATCHES_PER_FILE total_matches = len line_remainders matches_to_report = min total_matches MAX_MATCHES_PER_FILE line_remainder line_remainders matches_to_report line_remainder format line_number content split = line_remainder split line_number = int split split None print_lint_message path=filename line=line_number name=error_name If there more matches than limit print error total_matches MAX_MATCHES_PER_FILE print_lint_message path=filename name= too-many-matches description=f File has total_matches matches only showing first MAX_MATCHES_PER_FILE main - None parser = argparse ArgumentParser description= grep wrapper linter fromfile_prefix_chars= parser add_argument -- pattern required=True help= pattern grep parser add_argument -- allowlist-pattern help= pattern true file we don t grep pattern parser add_argument -- linter-name required=True help= name linter parser add_argument -- match-first-only action= store_true help= only match first hit file parser add_argument -- error-name required=True help= human-readable description what error parser add_argument -- error-description required=True help= message display when pattern found parser add_argument -- replace-pattern help= form pattern passed ` sed -r ` If specified will become proposed replacement text parser add_argument -- verbose action= store_true help= verbose logging parser add_argument filenames nargs= + help= paths lint Check duplicate arguments before parsing seen_args = set arg sys argv arg startswith -- arg_name = arg split = arg_name seen_args parser error f argument arg_name allowed specified multiple times seen_args add arg_name args = parser parse_args global LINTER_NAME ERROR_DESCRIPTION LINTER_NAME = args linter_name ERROR_DESCRIPTION = args error_description logging basicConfig format= threadName s levelname s message s level=logging NOTSET args verbose logging DEBUG len args filenames logging INFO stream=sys stderr Filter out files too large before running grep filtered_filenames = filename args filenames try file_size = os path getsize filename file_size MAX_FILE_SIZE print_lint_message path=filename severity=LintSeverity WARNING name= file-too-large description=f File size file_size bytes exceeds MAX_FILE_SIZE bytes limit skipping filtered_filenames append filename except OSError err print_lint_message path=filename name= file-access-error description=f Failed get file size err If all files filtered out nothing do filtered_filenames files_with_matches = args match_first_only files_with_matches = -- files-with-matches lines = try Split grep command into multiple batches avoid hitting command line length limit ~ M my machine arg_length = sum len x x filtered_filenames batches = arg_length + batch_size = len filtered_filenames batches i range len filtered_filenames batch_size proc = run_command grep -nEHI files_with_matches args pattern filtered_filenames i i + batch_size lines extend proc stdout decode splitlines except Exception err print_lint_message name= command-failed description= f Failed due err __class__ __name__ \n err isinstance err subprocess CalledProcessError COMMAND exit code returncode \n command \n\n STDERR\n stderr \n\n STDOUT\n stdout format returncode=err returncode command= join as_posix x x err cmd stderr=err stderr decode utf- strip empty stdout=err stdout decode utf- strip empty sys exit Group lines file call lint_file once per file grouped_lines = group_lines_by_file lines filename line_remainders grouped_lines items lint_file filename line_remainders args allowlist_pattern args replace_pattern args error_name __name__ == __main__ main
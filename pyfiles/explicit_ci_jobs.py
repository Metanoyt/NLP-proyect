usr bin env python __future__ annotations argparse fnmatch subprocess textwrap pathlib Path typing Any yaml REPO_ROOT = Path __file__ parents CONFIG_YML = REPO_ROOT circleci config yml WORKFLOWS_DIR = REPO_ROOT github workflows WORKFLOWS_TO_CHECK = binary_builds build master_build These formatted slightly differently skip them scheduled-ci debuggable-scheduled-ci slow-gradcheck-scheduled-ci promote add_job workflows dict str Any workflow_name str type str job dict str Any past_jobs dict str Any - None Add job job under type workflow_name workflow place Also add any dependencies they must already past_jobs workflow_name workflows workflows workflow_name = when always jobs requires = job get requires requires None requirement requires dependency = past_jobs requirement add_job workflows dependency workflow_name dependency type dependency job past_jobs workflows workflow_name jobs append type job get_filtered_circleci_config workflows dict str Any relevant_jobs list str - dict str Any Given existing CircleCI config remove every job s listed relevant_jobs new_workflows dict str Any = past_jobs dict str Any = workflow_name workflow workflows items workflow_name WORKFLOWS_TO_CHECK Don t care about workflow skip entirely continue job_dict workflow jobs type job job_dict items name job Job doesn t have name so can t handled print Skipping type job name relevant_jobs Found job specified CLI add new result add_job new_workflows workflow_name type job past_jobs Record job case s needed dependency later past_jobs job name = workflow_name workflow_name type type job job new_workflows commit_ci files list str message str - None Check there no other modified files than ones edited tool stdout = subprocess run git status -- porcelain stdout=subprocess PIPE stdout decode line stdout split \n line == continue line = raise RuntimeError f Refusing commit while other changes already staged line Make commit subprocess run git add + files subprocess run git commit -m message __name__ == __main__ parser = argparse ArgumentParser description= make circleci config yml only have specific set jobs delete GitHub actions parser add_argument -- job action= append help= job name default= parser add_argument -- filter-gha help= keep only these github actions glob match default= parser add_argument -- make-commit action= store_true help= add change git do-not-merge commit args = parser parse_args touched_files = CONFIG_YML open CONFIG_YML f config_yml = yaml safe_load f read config_yml workflows = get_filtered_circleci_config config_yml workflows args job open CONFIG_YML w f yaml dump config_yml f args filter_gha relative_file WORKFLOWS_DIR iterdir path = REPO_ROOT joinpath relative_file fnmatch fnmatch path name args filter_gha touched_files append path path resolve unlink args make_commit jobs_str = \n join f job job args job message = textwrap dedent f skip ci do merge Edit config yml filter specific jobs Filter CircleCI only run jobs_str See Run Specific CI Jobs https github com pytorch pytorch blob master CONTRIBUTING md#run-specific-ci-jobs details strip commit_ci str f relative_to REPO_ROOT f touched_files message
Matrix multiplication operator implementations random typing Optional torch torchfuzz operators base Operator torchfuzz tensor_fuzzer Spec TensorSpec Type promotion imports removed since we now use explicit casting codegen MatrixMultiplyOperator Operator Base matrix multiplication operations __init__ name str super __init__ name can_produce output_spec Spec - bool Matrix multiply operations can produce float complex tensors dimension = isinstance output_spec TensorSpec False Must have least dimensions matrix multiplication len output_spec size False Matrix multiply doesn t work bool integer types gradients output_spec dtype torch bool torch int torch int torch int torch int False True _get_compatible_dtype output_dtype Get compatible dtype matrix multiplication output_dtype output_dtype MMOperator MatrixMultiplyOperator Operator matrix multiplication torch mm __init__ super __init__ mm weight = property torch_op_name - Optional str Return torch operation name torch mm can_produce output_spec Spec - bool MM requires exactly D tensors isinstance output_spec TensorSpec False Must have exactly dimensions torch mm len output_spec size = False Matrix multiply doesn t work bool integer types gradients output_spec dtype torch bool torch int torch int torch int torch int False True fuzz_inputs_specs output_spec Spec - list Spec Generate input specs matrix multiplication isinstance output_spec TensorSpec raise ValueError MMOperator can only produce TensorSpec outputs len output_spec size = raise ValueError torch mm requires D tensors m n = output_spec size Choose random inner dimension k k = random randint dtypes = _get_compatible_dtype output_spec dtype First tensor m k input _spec = TensorSpec size= m k stride= k Contiguous stride dtype=dtypes Second tensor k n input _spec = TensorSpec size= k n stride= n Contiguous stride dtype=dtypes len dtypes dtypes input _spec input _spec codegen output_name str input_names list str output_spec Spec - str Generate code matrix multiplication len input_names = raise ValueError torch mm requires exactly inputs Get target dtype isinstance output_spec TensorSpec target_dtype_str = f torch output_spec dtype replace torch torch torch Cast inputs ensure compatible types f output_name = torch mm f input_names target_dtype_str f input_names target_dtype_str f output_name = torch mm input_names input_names AddmmOperator MatrixMultiplyOperator Operator additive matrix multiplication torch addmm __init__ super __init__ addmm weight = property torch_op_name - Optional str Return torch operation name torch addmm can_produce output_spec Spec - bool Addmm requires exactly D tensors isinstance output_spec TensorSpec False Must have exactly dimensions torch addmm len output_spec size = False Matrix multiply doesn t work bool integer types gradients output_spec dtype torch bool torch int torch int torch int torch int False True fuzz_inputs_specs output_spec Spec - list Spec Generate input specs additive matrix multiplication isinstance output_spec TensorSpec raise ValueError AddmmOperator can only produce TensorSpec outputs len output_spec size = raise ValueError torch addmm requires D output tensor m n = output_spec size Choose random inner dimension k k = random randint dtypes = _get_compatible_dtype output_spec dtype Bias tensor m n same shape output bias_spec = TensorSpec size= m n stride= n Contiguous stride dtype=dtypes First matrix m k input _spec = TensorSpec size= m k stride= k Contiguous stride dtype=dtypes len dtypes dtypes Second matrix k n input _spec = TensorSpec size= k n stride= n Contiguous stride dtype=dtypes len dtypes dtypes bias_spec input _spec input _spec codegen output_name str input_names list str output_spec Spec - str Generate code additive matrix multiplication len input_names = raise ValueError torch addmm requires exactly inputs Get target dtype isinstance output_spec TensorSpec target_dtype_str = f torch output_spec dtype replace torch torch torch Cast inputs ensure compatible types f output_name = torch addmm f input_names target_dtype_str f input_names target_dtype_str f input_names target_dtype_str f output_name = torch addmm input_names input_names input_names BmmOperator MatrixMultiplyOperator Operator batch matrix multiplication torch bmm __init__ super __init__ bmm weight = property torch_op_name - Optional str Return torch operation name torch bmm can_produce output_spec Spec - bool Batch matrix multiply requires D tensors isinstance output_spec TensorSpec False Must have exactly dimensions batch matrix multiplication len output_spec size = False Matrix multiply doesn t work bool integer types gradients output_spec dtype torch bool torch int torch int torch int torch int False True fuzz_inputs_specs output_spec Spec - list Spec Generate input specs batch matrix multiplication isinstance output_spec TensorSpec raise ValueError BmmOperator can only produce TensorSpec outputs len output_spec size = raise ValueError torch bmm requires D tensors b m n = output_spec size Choose random inner dimension k k = random randint dtypes = _get_compatible_dtype output_spec dtype First tensor b m k input _spec = TensorSpec size= b m k stride= m k k Contiguous stride dtype=dtypes Second tensor b k n input _spec = TensorSpec size= b k n stride= k n n Contiguous stride dtype=dtypes len dtypes dtypes input _spec input _spec codegen output_name str input_names list str output_spec Spec - str Generate code batch matrix multiplication len input_names = raise ValueError torch bmm requires exactly inputs Get target dtype isinstance output_spec TensorSpec target_dtype_str = f torch output_spec dtype replace torch torch torch Cast inputs ensure compatible types f output_name = torch bmm f input_names target_dtype_str f input_names target_dtype_str f output_name = torch bmm input_names input_names MatmulOperator MatrixMultiplyOperator Operator general matrix multiplication torch matmul __init__ super __init__ matmul weight = property torch_op_name - Optional str Return torch operation name torch matmul can_produce output_spec Spec - bool Matmul can handle various tensor dimensions = isinstance output_spec TensorSpec False Must have least dimension len output_spec size False Matrix multiply doesn t work bool integer types gradients output_spec dtype torch bool torch int torch int torch int torch int False True fuzz_inputs_specs output_spec Spec - list Spec Generate input specs general matrix multiplication isinstance output_spec TensorSpec raise ValueError MatmulOperator can only produce TensorSpec outputs output_size = output_spec size output_dims = len output_size dtypes = _get_compatible_dtype output_spec dtype output_dims == Matrix-vector multiplication n = k k n n = n k k n = output_size k = random randint Randomly choose between two valid patterns random choice True False Pattern n = k k n input _spec = TensorSpec size= k stride= dtype=dtypes input _spec = TensorSpec size= k n stride= n dtype=dtypes len dtypes dtypes Pattern n = n k k input _spec = TensorSpec size= n k stride= k dtype=dtypes input _spec = TensorSpec size= k stride= dtype=dtypes len dtypes dtypes output_dims == Matrix multiplication m n = m k k n m n = output_size k = random randint input _spec = TensorSpec size= m k stride= k dtype=dtypes input _spec = TensorSpec size= k n stride= n dtype=dtypes len dtypes dtypes Batched matrix multiplication m n = m k k n batch_dims m n = output_size k = random randint Calculate strides contiguous tensors input _size = tuple batch_dims + m k input _size = tuple batch_dims + k n Contiguous strides input _stride = i reversed range len input _size - input _stride append input _stride - input _size i + input _stride = tuple reversed input _stride input _stride = i reversed range len input _size - input _stride append input _stride - input _size i + input _stride = tuple reversed input _stride input _spec = TensorSpec size=input _size stride=input _stride dtype=dtypes input _spec = TensorSpec size=input _size stride=input _stride dtype=dtypes len dtypes dtypes input _spec input _spec codegen output_name str input_names list str output_spec Spec - str Generate code general matrix multiplication len input_names = raise ValueError torch matmul requires exactly inputs Get target dtype isinstance output_spec TensorSpec target_dtype_str = f torch output_spec dtype replace torch torch torch Cast inputs ensure compatible types f output_name = torch matmul f input_names target_dtype_str f input_names target_dtype_str f output_name = torch matmul input_names input_names
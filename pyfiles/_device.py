mypy allow-untyped-defs functools typing Optional torch torch _C _len_torch_function_stack torch overrides _pop_mode _push_mode TorchFunctionMode torch utils _contextlib context_decorator CURRENT_DEVICE Optional torch device = None functools lru_cache _device_constructors standard ones torch empty torch empty_permuted torch empty_strided torch empty_quantized torch ones torch arange torch bartlett_window torch blackman_window torch eye torch fft fftfreq torch fft rfftfreq torch full torch hamming_window torch hann_window torch kaiser_window torch linspace torch logspace torch nested nested_tensor This function doesn t actually take device argument torch normal torch rand torch randn torch randint torch randperm torch range torch sparse_coo_tensor torch sparse_compressed_tensor torch sparse_csr_tensor torch sparse_csc_tensor torch sparse_bsr_tensor torch sparse_bsc_tensor torch tril_indices torch triu_indices torch zeros torch asarray weird ones torch tensor torch as_tensor torch scalar_tensor NB This directly called C++ torch csrc Device cpp DeviceContext TorchFunctionMode __init__ device pyrefly ignore read-only device = torch device device __enter__ global CURRENT_DEVICE old_device = CURRENT_DEVICE CURRENT_DEVICE = device We need put device bottom stack If we set default device within function mode context exiting context mode will pop device function mode off stack incorrectly cur_stack = _pop_mode _ range _len_torch_function_stack _push_mode mode reversed cur_stack _push_mode mode __exit__ exc_type exc_val exc_tb global CURRENT_DEVICE CURRENT_DEVICE = old_device cur_stack = Invariant there should only one DeviceContext stack any time At bottom pop all modes until we hit bottom assert s DeviceContext someone has popped _ range _len_torch_function_stack - mode = _pop_mode isinstance mode DeviceContext raise AssertionError Found nested DeviceContext mode stack where none expected cur_stack append mode _len_torch_function_stack mode = _pop_mode isinstance mode DeviceContext raise AssertionError Expected DeviceContext bottom mode stack mode reversed cur_stack _push_mode mode __torch_function__ func types args= kwargs=None kwargs = kwargs func _device_constructors kwargs get device None kwargs device = device func args kwargs NB This directly called C++ torch csrc Device cpp device_decorator device func context_decorator lambda device func set_device device Set default device inside wrapped function decorating function If you would like use context manager use device context manager directly e g ` ` torch device device ` ` lambda func device_decorator torch device device func
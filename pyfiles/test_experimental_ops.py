Copyright c Meta Platforms Inc affiliates Owner s oncall distributed torch torch distributed dist torch distributed tensor distribute_tensor Replicate torch testing _internal common_utils run_tests torch testing _internal distributed _tensor common_dtensor create_local_tensor_test_class DTensorTestBase with_comms ITER_TIME = LR = DistOtherOpsTest DTensorTestBase property world_size - int hard code world size with_comms test_slice device_mesh = build_device_mesh shard_spec = Replicate input_list = torch rand ITER_TIME grad_output_list = torch rand ITER_TIME e- i range ITER_TIME inp = input_list i device_type requires_grad_ grad_output = grad_output_list i device_type droppath dtensor inp_dtensor = distribute_tensor inp device_mesh shard_spec grad_output_dtensor = distribute_tensor grad_output device_mesh shard_spec output = inp_dtensor output backward grad_output_dtensor nll plain tensor output_gt = inp output_gt backward grad_output output_diff_abs = output to_local - output_gt output_diff_rel = output_diff_abs torch abs output_gt + e- output_mse_abs = torch mean output_diff_abs output_diff_abs item output_mse_rel = torch mean output_diff_rel output_diff_rel item grad_diff_abs = inp_dtensor grad to_local - inp grad grad_diff_rel = grad_diff_abs torch abs inp grad + e- grad_mse_abs = torch mean grad_diff_abs grad_diff_abs item grad_mse_rel = torch mean grad_diff_rel grad_diff_rel item assertTrue output_mse_abs = e- f Too large absolute mse output expected less equal e- got output_mse_abs assertTrue output_mse_rel = e- f Too large relative mse output expected less equal e- got output_mse_rel assertTrue grad_mse_abs = e- f Too large absolute mse gradient expected less equal e- got grad_mse_abs assertTrue grad_mse_rel = e- f Too large relative mse gradient expected less equal e- got grad_mse_rel with_comms test_bernoulli rank = dist get_rank device_mesh = build_device_mesh shard_spec = Replicate input_list = torch rand ITER_TIME grad_output_list = torch rand ITER_TIME e- i range ITER_TIME inp = input_list i device_type requires_grad_ grad_output = grad_output_list i device_type bernoulli dtensor inp_dtensor = distribute_tensor inp device_mesh shard_spec grad_output_dtensor = distribute_tensor grad_output device_mesh shard_spec output = torch bernoulli inp_dtensor output backward grad_output_dtensor send_output_tensor = output to_local recv_output_tensor = torch zeros_like send_output_tensor send_grad_tensor = inp_dtensor grad to_local recv_grad_tensor = torch zeros_like send_grad_tensor send_op_ = dist P POp dist isend send_output_tensor ^ rank send_op_ = dist P POp dist isend send_grad_tensor ^ rank recv_op_ = dist P POp dist irecv recv_output_tensor ^ rank recv_op_ = dist P POp dist irecv recv_grad_tensor ^ rank reqs = dist batch_isend_irecv send_op_ send_op_ recv_op_ recv_op_ req reqs req wait output_diff_abs = send_output_tensor - recv_output_tensor output_diff_rel = output_diff_abs torch abs recv_output_tensor + e- output_mse_abs = torch mean output_diff_abs output_diff_abs item output_mse_rel = torch mean output_diff_rel output_diff_rel item grad_diff_abs = send_grad_tensor - recv_grad_tensor grad_diff_rel = grad_diff_abs torch abs recv_grad_tensor + e- grad_mse_abs = torch mean grad_diff_abs grad_diff_abs item grad_mse_rel = torch mean grad_diff_rel grad_diff_rel item assertTrue output_mse_abs = e- f Too large absolute mse output expected less equal e- got output_mse_abs assertTrue output_mse_rel = e- f Too large relative mse output expected less equal e- got output_mse_rel assertTrue grad_mse_abs = e- f Too large absolute mse gradient expected less equal e- got grad_mse_abs assertTrue grad_mse_rel = e- f Too large relative mse gradient expected less equal e- got grad_mse_rel with_comms test_nll device_mesh = build_device_mesh shard_spec = Replicate pred_list = torch rand ITER_TIME target_list = torch randint ITER_TIME dtype=torch long criterion = torch nn CrossEntropyLoss i range ITER_TIME pred = pred_list i device_type requires_grad_ target = target_list i device_type nll dtensor pred_dtensor = distribute_tensor pred device_mesh shard_spec target_dtensor = distribute_tensor target device_mesh shard_spec loss = criterion pred_dtensor target_dtensor loss backward nll plain tensor loss_gt = criterion pred target loss_gt backward loss_diff_abs = loss to_local - loss_gt loss_diff_rel = loss_diff_abs torch abs loss_gt + e- loss_mse_abs = torch mean loss_diff_abs loss_diff_abs item loss_mse_rel = torch mean loss_diff_rel loss_diff_rel item grad_diff_abs = pred_dtensor grad to_local - pred grad grad_diff_rel = grad_diff_abs torch abs pred grad + e- grad_mse_abs = torch mean grad_diff_abs grad_diff_abs item grad_mse_rel = torch mean grad_diff_rel grad_diff_rel item assertTrue loss_mse_abs = e- f Too large absolute mse loss expected less equal e- got loss_mse_abs assertTrue loss_mse_rel = e- f Too large relative mse loss expected less equal e- got loss_mse_rel assertTrue grad_mse_abs = e- f Too large absolute mse gradient expected less equal e- got grad_mse_abs assertTrue grad_mse_rel = e- f Too large relative mse gradient expected less equal e- got grad_mse_rel DistOtherOpsTestWithLocalTensor = create_local_tensor_test_class DistOtherOpsTest Send recv ops supported skipped_tests= test_bernoulli __name__ == __main__ run_tests
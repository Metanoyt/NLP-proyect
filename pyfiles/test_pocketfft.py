Owner s module dynamo functools queue threading unittest skipIf skipif SkipTest pytest pytest raises assert_raises torch testing _internal common_utils instantiate_parametrized_tests parametrize run_tests TEST_WITH_TORCHDYNAMO TestCase TEST_WITH_TORCHDYNAMO numpy np numpy random random numpy testing assert_allclose IS_WASM torch _numpy np torch _numpy random random torch _numpy testing assert_allclose IS_WASM skip = functools partial skipif True IS_WASM = False fft x L = len x phase = - j np pi np arange L L phase = np arange L reshape - phase np sum x np exp phase axis= TestFFTShift TestCase test_fft_n assert_raises ValueError RuntimeError np fft fft instantiate_parametrized_tests TestFFT D TestCase setUp super setUp np random seed test_identity maxlen = x = random maxlen + j random maxlen xr = random maxlen i range maxlen assert_allclose np fft ifft np fft fft x i x i atol= e- assert_allclose np fft irfft np fft rfft xr i i xr i atol= e- test_fft np random seed x = random + j random assert_allclose fft x np fft fft x atol= e- assert_allclose fft x np fft fft x norm= backward atol= e- assert_allclose fft x np sqrt np fft fft x norm= ortho atol= e- assert_allclose fft x np fft fft x norm= forward atol= e- parametrize norm None backward ortho forward test_ifft norm x = random + j random assert_allclose x np fft ifft np fft fft x norm=norm norm=norm atol= e- Ensure we get correct error message NB Exact wording differs slightly under Dynamo eager pytest raises ValueError RuntimeError match= Invalid number np fft ifft norm=norm test_fft x = random + j random assert_allclose np fft fft np fft fft x axis= axis= np fft fft x atol= e- assert_allclose np fft fft x np fft fft x norm= backward atol= e- assert_allclose np fft fft x np sqrt np fft fft x norm= ortho atol= e- assert_allclose np fft fft x np fft fft x norm= forward atol= e- test_ifft x = random + j random assert_allclose np fft ifft np fft ifft x axis= axis= np fft ifft x atol= e- assert_allclose np fft ifft x np fft ifft x norm= backward atol= e- assert_allclose np fft ifft x np sqrt np fft ifft x norm= ortho atol= e- assert_allclose np fft ifft x np fft ifft x norm= forward atol= e- test_fftn x = random + j random assert_allclose np fft fft np fft fft np fft fft x axis= axis= axis= np fft fftn x atol= e- assert_allclose np fft fftn x np fft fftn x norm= backward atol= e- assert_allclose np fft fftn x np sqrt np fft fftn x norm= ortho atol= e- assert_allclose np fft fftn x np fft fftn x norm= forward atol= e- test_ifftn x = random + j random assert_allclose np fft ifft np fft ifft np fft ifft x axis= axis= axis= np fft ifftn x atol= e- assert_allclose np fft ifftn x np fft ifftn x norm= backward atol= e- assert_allclose np fft ifftn x np sqrt np fft ifftn x norm= ortho atol= e- assert_allclose np fft ifftn x np fft ifftn x norm= forward atol= e- test_rfft x = random n x size x size norm None backward ortho forward assert_allclose np fft fft x n=n norm=norm n + np fft rfft x n=n norm=norm atol= e- assert_allclose np fft rfft x n=n np fft rfft x n=n norm= backward atol= e- assert_allclose np fft rfft x n=n np sqrt n np fft rfft x n=n norm= ortho atol= e- assert_allclose np fft rfft x n=n n np fft rfft x n=n norm= forward atol= e- test_irfft x = random assert_allclose x np fft irfft np fft rfft x atol= e- assert_allclose x np fft irfft np fft rfft x norm= backward norm= backward atol= e- assert_allclose x np fft irfft np fft rfft x norm= ortho norm= ortho atol= e- assert_allclose x np fft irfft np fft rfft x norm= forward norm= forward atol= e- test_rfft x = random assert_allclose np fft fft x np fft rfft x atol= e- assert_allclose np fft rfft x np fft rfft x norm= backward atol= e- assert_allclose np fft rfft x np sqrt np fft rfft x norm= ortho atol= e- assert_allclose np fft rfft x np fft rfft x norm= forward atol= e- test_irfft x = random assert_allclose x np fft irfft np fft rfft x atol= e- assert_allclose x np fft irfft np fft rfft x norm= backward norm= backward atol= e- assert_allclose x np fft irfft np fft rfft x norm= ortho norm= ortho atol= e- assert_allclose x np fft irfft np fft rfft x norm= forward norm= forward atol= e- test_rfftn x = random assert_allclose np fft fftn x np fft rfftn x atol= e- assert_allclose np fft rfftn x np fft rfftn x norm= backward atol= e- assert_allclose np fft rfftn x np sqrt np fft rfftn x norm= ortho atol= e- assert_allclose np fft rfftn x np fft rfftn x norm= forward atol= e- test_irfftn x = random assert_allclose x np fft irfftn np fft rfftn x atol= e- assert_allclose x np fft irfftn np fft rfftn x norm= backward norm= backward atol= e- assert_allclose x np fft irfftn np fft rfftn x norm= ortho norm= ortho atol= e- assert_allclose x np fft irfftn np fft rfftn x norm= forward norm= forward atol= e- test_hfft x = random + j random x_herm = np concatenate random x random x = np concatenate x_herm np flip x conj assert_allclose np fft fft x np fft hfft x_herm atol= e- assert_allclose np fft hfft x_herm np fft hfft x_herm norm= backward atol= e- assert_allclose np fft hfft x_herm np sqrt np fft hfft x_herm norm= ortho atol= e- assert_allclose np fft hfft x_herm np fft hfft x_herm norm= forward atol= e- test_ihfft x = random + j random x_herm = np concatenate random x random x = np concatenate x_herm np flip x conj assert_allclose x_herm np fft ihfft np fft hfft x_herm atol= e- assert_allclose x_herm np fft ihfft np fft hfft x_herm norm= backward norm= backward atol= e- assert_allclose x_herm np fft ihfft np fft hfft x_herm norm= ortho norm= ortho atol= e- assert_allclose x_herm np fft ihfft np fft hfft x_herm norm= forward norm= forward atol= e- parametrize op np fft fftn np fft ifftn np fft rfftn np fft irfftn test_axes op x = random axes = axes op_tr = op np transpose x tr_op = np transpose op x axes=a assert_allclose op_tr tr_op atol= e- test_all_ d_norm_preserving verify round-trip transforms norm-preserving x = random x_norm = np linalg norm x n = x size func_pairs = np fft fft np fft ifft np fft rfft np fft irfft hfft order so first function takes x size samples necessary comparison x_norm above np fft ihfft np fft hfft forw back func_pairs n x size x size norm None backward ortho forward tmp = forw x n=n norm=norm tmp = back tmp n=n norm=norm assert_allclose x_norm np linalg norm tmp atol= e- parametrize dtype np half np single np double test_dtypes dtype make sure all input precisions accepted internally converted bit x = random astype dtype assert_allclose np fft ifft np fft fft x x atol= e- assert_allclose np fft irfft np fft rfft x x atol= e- parametrize dtype np float np float np complex np complex parametrize order F non-contiguous parametrize fft np fft fft np fft fft np fft fftn np fft ifft np fft ifft np fft ifftn test_fft_with_order dtype order fft Check FFT IFFT produces identical results C Fortran non contiguous arrays rng = np random RandomState rng = np random X = rng rand astype dtype copy=False See discussion pull _tol = float np sqrt np log X size np finfo X dtype eps order == F raise SkipTest Fortran order arrays Y = np asfortranarray X Make non contiguous array Z = np empty dtype=X dtype Z = X Y = Z X = Y copy fft __name__ endswith fft axis range X_res = fft X axis=axis Y_res = fft Y axis=axis assert_allclose X_res Y_res atol=_tol rtol=_tol fft __name__ endswith fft fftn axes = fft __name__ endswith fftn axes extend None ax axes X_res = fft X axes=ax Y_res = fft Y axes=ax assert_allclose X_res Y_res atol=_tol rtol=_tol raise ValueError skipif IS_WASM reason= Cannot start thread TestFFTThreadSafe TestCase threads = input_shape = _test_mtsame func args worker args q q put func args q = queue Queue expected = func args Spin off bunch threads call same function simultaneously t = threading Thread target=worker args= args q i range threads x start x t x join x t Make sure all threads returned correct value _ range threads under torch dynamo ` assert_array_equal ` fails relative errors about e- Hence replace ` assert_allclose rtol= e- ` assert_allclose q get timeout= expected atol= e- msg= Function returned wrong value multithreaded context test_fft = np ones input_shape + j _test_mtsame np fft fft test_ifft = np ones input_shape + j _test_mtsame np fft ifft test_rfft = np ones input_shape _test_mtsame np fft rfft test_irfft = np ones input_shape + j _test_mtsame np fft irfft __name__ == __main__ run_tests
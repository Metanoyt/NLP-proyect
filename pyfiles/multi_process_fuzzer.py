usr bin env python Multi-process fuzzer library uses worker processes execute fuzzer py different seeds multiprocessing mp re subprocess sys time collections defaultdict dataclasses dataclass typing Optional try tqdm tqdm HAS_TQDM = True except ImportError HAS_TQDM = False Create mock tqdm type safety MockTqdm staticmethod write msg file=None print msg file=file flush=True tqdm = MockTqdm persist_print msg Print messages persist tqdm progress bars try HAS_TQDM hasattr tqdm write Keep prints same stream bar tqdm write msg file=sys stderr print msg file=sys stderr flush=True except BrokenPipeError os os makedirs tmp torchfuzz exist_ok=True open tmp torchfuzz crash log f f write f BrokenPipeError msg \n List regex patterns ignore bucket IGNORE_PATTERNS list re Pattern = re compile r Dynamo failed run FX node fake tensors call_method fill_diagonal_ https github com pytorch pytorch issues re compile r TypeError unsupported operand type\ s\ divmod\ \ SymInt int https github com pytorch pytorch issues re compile r RuntimeError self\ stride\ - \ must view ComplexDouble https github com pytorch pytorch issues re compile r BooleanAtom allowed context https github com pytorch pytorch issues re compile r TypeError\ \ unsupported operand type\ s\ \ SymBool FakeTensor \ \ https github com pytorch pytorch issues re compile r KeyError u\d+ https github com pytorch pytorch issues re compile r torch\ _inductor\ exc\ InductorError CppCompileError C\+\+ compile error https github com pytorch pytorch issues re compile r \ item\ \ dtype= https github com pytorch pytorch issues re compile r dimensionality sizes \ \ must match dimensionality strides \ \ https github com pytorch pytorch issues re compile r mat must have same dtype https github com pytorch pytorch issues re compile r free\ \ invalid next size \ fast\ TODO figure out why sometimes heap metadata gets corrupted program exit checks actually pass successfully re compile r assert int str\ indices\ get_dtype\ \ \ https github com pytorch pytorch issues re compile r self\ shape_env\ guard_or_defer_runtime_assert\ expr guard_equals \ https github com pytorch pytorch issues re compile r assert len\ self\ stride\ == len\ order\ https github com pytorch pytorch issues re compile r assert len\ input_size\ == len\ new_size\ https github com pytorch pytorch issues re compile r torch\ _inductor\ exc\ InductorError IndexError list index out range https github com pytorch pytorch issues re compile r assert bool\ static_expr\ https github com pytorch pytorch issues Add more patterns here needed e g re compile r Some other error message dataclass FuzzerResult seed int success bool output str duration float ignored_pattern_idx int operation_stats dict str int New field operation statistics is_ignored_output output str - int Check output matches any ignore pattern Args output The combined stdout stderr string Returns Index matched ignore pattern - none matched idx pattern enumerate IGNORE_PATTERNS pattern search output idx - run_fuzzer_with_seed seed int template str = default supported_ops Optional str = None - FuzzerResult Run fuzzer py specific seed Args seed The seed value pass fuzzer py template The template use code generation supported_ops Comma-separated ops string optional weights Returns FuzzerResult dataclass instance start_time = time time try Run fuzzer py specified seed template cmd = sys executable fuzzer py -- single -- seed str seed -- template template Append supported ops provided supported_ops cmd extend -- supported-ops supported_ops result = subprocess run cmd capture_output=True text=True timeout= minute timeout per seed duration = time time - start_time success = result returncode == Combine stdout stderr output output = result stdout output += f STDOUT \n result stdout \n result stderr output += f STDERR \n result stderr \n output += f Return code result returncode Parse operation statistics output operation_stats = result stdout lines = result stdout split \n in_stats_section = False line lines line strip == OPERATION_STATS in_stats_section = True continue in_stats_section line startswith line Parse line like torch add op_line = line strip op_line op_name count_str = op_line split try count = int count_str operation_stats op_name = count except ValueError pass Skip malformed lines End stats section in_stats_section = False Check output should ignored which pattern matched ignored_pattern_idx = is_ignored_output output ignored_pattern_idx = - Mark ignored could also special flag needed output = IGNORED + output FuzzerResult seed success output duration ignored_pattern_idx operation_stats except subprocess TimeoutExpired duration = time time - start_time FuzzerResult seed False Process timed out after seconds duration - except Exception e duration = time time - start_time FuzzerResult seed False f Exception occurred str e duration - print_output_lines output str write_func Helper print non-empty lines output using provided write_func line output split \n line strip write_func f line hasattr write_func __self__ hasattr write_func __self__ write For tqdm write add empty line separation write_func handle_result_output label str seed int duration float output str ignored bool verbose bool write_func Unified handler result output reducing code repetition ignored_text = IGNORED ignored write_func f label - Seed seed duration duration f s ignored_text output strip label startswith âŒ verbose print_output_lines output write_func run_multi_process_fuzzer num_processes Optional int = None seed_start int = seed_count int = verbose bool = False template str = default supported_ops Optional str = None - None Run multi-process fuzzer Args num_processes Number worker processes use seed_start Starting seed value inclusive seed_count Number seeds run verbose Whether print detailed output template The template use code generation supported_ops Comma-separated ops string optional weights seeds = list range seed_start seed_start + seed_count persist_print f ğŸš€ Starting multi-process fuzzer num_processes processes persist_print f ğŸ“Š Processing seeds seed_start seed_start + seed_count - len seeds total persist_print f ğŸ”§ Command template python fuzzer py -- seed seed -- template template persist_print = start_time = time time results list FuzzerResult = successful_count = failed_count = ignored_count = ignored_seeds = ignored_pattern_counts dict int int = dict fromkeys range len IGNORE_PATTERNS try Use multiprocessing Pool distribute work mp Pool processes=num_processes pool Submit all seeds process pool future_results = seed seeds future = pool apply_async run_fuzzer_with_seed seed template supported_ops future_results append future Set up progress bar HAS_TQDM tqdm tqdm Import real tqdm here pbar = tqdm total=len seeds desc= Processing seeds file=sys stdout bar_format= l_bar bar &#124; n_fmt total_fmt elapsed remaining âœ… âŒ â“= postfix dynamic_ncols=True pbar set_postfix_str f successful_count failed_count ignored_count &#124; throughput seeds hr write_func msg pyrefly ignore missing-attribute pbar write msg persist_print Progress install tqdm better progress bar pbar = None write_func = persist_print Collect results they complete i future enumerate future_results try result FuzzerResult = future get results append result result ignored_pattern_idx = - ignored_seeds append result seed ignored_pattern_counts result ignored_pattern_idx += ignored_count += Only increment failed_count ignored result success successful_count += result ignored_pattern_idx == - failed_count += elapsed = time time - start_time throughput = i + elapsed Update progress bar HAS_TQDM pbar pbar set_postfix_str f successful_count failed_count ignored_count &#124; throughput throughput f seeds hr pbar update status_emoji = âœ… result success âŒ ignored_text = IGNORED result ignored_pattern_idx = - persist_print f Completed i + len seeds - Seed result seed status_emoji ignored_text Unified output handling result success result ignored_pattern_idx == - handle_result_output label= âŒ FAILURE seed=result seed duration=result duration output=result output ignored=False verbose=verbose write_func=write_func result success result ignored_pattern_idx = - verbose handle_result_output label= ğŸš« IGNORED seed=result seed duration=result duration output=result output ignored=True verbose=verbose write_func=write_func verbose handle_result_output label= âœ… SUCCESS seed=result seed duration=result duration output=result output ignored= result ignored_pattern_idx = - verbose=verbose write_func=write_func except Exception e failed_count += HAS_TQDM pbar pbar set_postfix_str f successful_count failed_count pbar update pbar write f âŒ POOL ERROR - Seed seeds i str e persist_print f Completed i + len seeds - Seed seeds i âŒ POOL ERROR persist_print f âŒ POOL ERROR - Seed seeds i str e results append FuzzerResult seeds i False f Pool error str e - Close progress bar HAS_TQDM pbar pbar close except KeyboardInterrupt persist_print \nğŸ›‘ Interrupted user Ctrl+C Print summary up point total_time = time time - start_time persist_print = persist_print ğŸ“ˆ SUMMARY partial interrupted persist_print = successful = res res results res success Only count failed ignored failed = res res results res success res ignored_pattern_idx == - ignored = res res results res ignored_pattern_idx = - persist_print f âœ… Successful len successful len results len successful len results results f persist_print f âŒ Failed len failed len results len failed len results results f persist_print f â±ï¸ Total time total_time f s results persist_print f âš¡ Throughput len results total_time f seeds hr total_time âš¡ Throughput N A failed persist_print f \nâŒ Failed seeds res seed res failed successful persist_print f âœ… Successful seeds res seed res successful avg_success_time = sum res duration res successful len successful persist_print f âš¡ Avg time successful runs avg_success_time f s ignored persist_print f \nğŸš« Ignored seeds res seed res ignored Print ignore pattern stats persist_print \nğŸš« Ignored pattern statistics total_ignored = len ignored idx pattern enumerate IGNORE_PATTERNS count = ignored_pattern_counts idx percent = count total_ignored total_ignored persist_print f Pattern idx pattern pattern r - count percent f Aggregate print operation distribution _print_operation_distribution results sys exit total_time = time time - start_time Print summary persist_print = persist_print ğŸ“ˆ SUMMARY persist_print = successful = res res results res success Only count failed ignored failed = res res results res success res ignored_pattern_idx == - ignored = res res results res ignored_pattern_idx = - persist_print f âœ… Successful len successful len results len successful len results f persist_print f âŒ Failed len failed len results len failed len results f persist_print f â±ï¸ Total time total_time f s persist_print f âš¡ Throughput len results total_time f seeds hr total_time âš¡ Throughput N A failed persist_print f \nâŒ Failed seeds res seed res failed successful persist_print f âœ… Successful seeds res seed res successful avg_success_time = sum res duration res successful len successful persist_print f âš¡ Avg time successful runs avg_success_time f s ignored persist_print f \nğŸš« Ignored seeds res seed res ignored Print ignore pattern stats persist_print \nğŸš« Ignored pattern statistics total_ignored = len ignored idx pattern enumerate IGNORE_PATTERNS count = ignored_pattern_counts idx percent = count total_ignored total_ignored persist_print f Pattern idx pattern pattern r - count percent f Aggregate print operation distribution _print_operation_distribution results _print_operation_distribution results list FuzzerResult - None Helper function print operation distribution statistics total_operation_stats = defaultdict int total_operations = Collect operation stats all successful results result results result success result operation_stats op_name count result operation_stats items total_operation_stats op_name += count total_operations += count total_operation_stats persist_print \nğŸ“Š OPERATION DISTRIBUTION persist_print = persist_print f Total operations executed total_operations persist_print Sort operations count descending better readability sorted_ops = sorted total_operation_stats items key=lambda x x reverse=True op_name count sorted_ops percentage = count total_operations total_operations persist_print f op_name count times percentage f persist_print \nğŸ“Š No operation statistics collected no successful runs stats run_until_failure num_processes Optional int = None verbose bool = False template str = default supported_ops Optional str = None - None Run multi-process fuzzer random starting seed iterating until failure found Args num_processes Number worker processes use verbose Whether print detailed output template The template use code generation supported_ops Comma-separated ops string optional weights Returns Exits non-zero code when failure found random Pick random seed start initial_seed = random randint - persist_print f ğŸ² Starting continuous fuzzing random initial seed initial_seed persist_print f ğŸš€ Using num_processes processes persist_print f ğŸ”§ Command template python fuzzer py -- seed seed -- template template persist_print ğŸ¯ Running until first failure found persist_print = start_time = time time current_seed = initial_seed total_successful = total_ignored = batch_size = Process seeds batches try while True Process batch seeds seeds = list range current_seed current_seed + batch_size mp Pool processes=num_processes pool future_results = seed seeds future = pool apply_async run_fuzzer_with_seed seed template supported_ops future_results append seed future Set up progress bar batch HAS_TQDM tqdm tqdm pbar = tqdm total=len seeds desc=f Batch starting seed current_seed file=sys stdout bar_format= l_bar bar &#124; n_fmt total_fmt elapsed âœ… ğŸš«= postfix dynamic_ncols=True pbar set_postfix_str f total_successful total_ignored write_func msg pyrefly ignore missing-attribute pbar write msg pbar = None Collect results they complete seed future future_results result FuzzerResult = future get result ignored_pattern_idx = - total_ignored += result success total_successful += result ignored_pattern_idx == - Found failure ignored HAS_TQDM pbar pbar close elapsed = time time - start_time persist_print \n + = persist_print ğŸ¯ FAILURE FOUND persist_print = persist_print f âŒ Failing seed result seed persist_print f â±ï¸ Duration seed result duration f s persist_print f â±ï¸ Total time elapsed elapsed f s persist_print f âœ… Successful seeds tested total_successful persist_print f ğŸš« Ignored seeds total_ignored persist_print f ğŸ“Š Total seeds tested total_successful + total_ignored + persist_print \nğŸ’¥ Failure output persist_print - print_output_lines result output persist_print persist_print - persist_print f \nğŸ”„ Reproduce python fuzzer py -- seed result seed -- template template Exit non-zero code sys exit Update progress bar HAS_TQDM pbar pbar set_postfix_str f total_successful total_ignored pbar update verbose status_emoji = âœ… result success ğŸš« persist_print f Seed result seed status_emoji Close progress bar batch HAS_TQDM pbar pbar close Move next batch current_seed += batch_size except KeyboardInterrupt persist_print \nğŸ›‘ Interrupted user Ctrl+C elapsed = time time - start_time persist_print = persist_print ğŸ“ˆ SUMMARY interrupted persist_print = persist_print f â±ï¸ Total time elapsed f s persist_print f âœ… Successful seeds total_successful persist_print f ğŸš« Ignored seeds total_ignored persist_print f ğŸ“Š Total seeds tested total_successful + total_ignored persist_print f âš¡ Throughput total_successful + total_ignored elapsed f seeds hr sys exit
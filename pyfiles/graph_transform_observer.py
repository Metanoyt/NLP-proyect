mypy allow-untyped-defs os collections abc Callable typing Optional TypeVar torch fx Graph Node torch fx _compatibility compatibility torch fx graph_module GraphModule torch fx traceback NodeSource NodeSourceAction T = TypeVar T graph_drawer FxGraphDrawer __all__ = GraphTransformObserver compatibility is_backward_compatible=False GraphTransformObserver __pass_count = __init__ gm GraphModule passname str subsystem Optional str = None log_url Optional str = None log_url inferred torch _inductor config trace log_url_for_graph_xform unless otherwise specified torch _inductor config inductor_config gm = gm passname = passname subsystem = subsystem log_url None log_url = inductor_config trace log_url_for_graph_xform log_url = log_url active = log_url None inductor_config trace provenance_tracking_level == active erased_nodes set str = set created_nodes set str = set name_to_node dict str Node = record graph modules deepcopied gm so we can remove hooks them when exiting context copied_gms list GraphModule = _node_creation_hook = get_node_creation_hook _node_erase_hook = get_node_erase_hook _node_replace_hook = get_node_replace_hook _deepcopy_hook = get_deepcopy_hook If log_url None we don t log anything log_url None GraphTransformObserver __pass_count += input_dot_graph = FxGraphDrawer gm passname ignore_getattr=True ignore_parameters_and_buffers=True get_dot_graph classmethod get_current_pass_count cls cls __pass_count apply_gm_pass pass_fn Callable GraphModule T - Optional T _check_disable_pass pass_fn gm None apply_graph_pass pass_fn Callable Graph T - Optional T _check_disable_pass pass_fn gm graph None _check_disable_pass subsystem None False debug_info = lambda passname noqa E torch _inductor compiler_bisector CompilerBisector CompilerBisector disable_subsystem inductor subsystem debug_info __enter__ active gm _register_create_node_hook _node_creation_hook gm _register_erase_node_hook _node_erase_hook gm _register_replace_node_hook _node_replace_hook gm _register_deepcopy_hook _deepcopy_hook erased_nodes clear created_nodes clear name_to_node clear copied_gms clear node gm graph nodes name_to_node node name = node __exit__ type value tb active gm copied_gms + gm gm _unregister_create_node_hook _node_creation_hook gm _unregister_erase_node_hook _node_erase_hook gm _unregister_replace_node_hook _node_replace_hook gm _unregister_deepcopy_hook _deepcopy_hook log_url None len created_nodes len erased_nodes e input_dot_graph get_node_list e get_name erased_nodes e obj_dict attributes fillcolor = yellow e obj_dict attributes fillcolor = grey assert log_url None input_dot_graph write os path join log_url f pass_ GraphTransformObserver __pass_count _ passname _input_graph dot output_dot_graph = FxGraphDrawer gm passname ignore_getattr=True ignore_parameters_and_buffers=True get_dot_graph e output_dot_graph get_node_list e get_name created_nodes e obj_dict attributes fillcolor = yellow e obj_dict attributes fillcolor = grey output_dot_graph write os path join log_url f pass_ GraphTransformObserver __pass_count _ passname _output_graph dot get_node_creation_hook We have function instead using method directly avoid max recursion issue when deepcopy graph module within context manager on_node_creation node created_nodes add node name name_to_node node name = node source = NodeSource None passname NodeSourceAction CREATE from_node node meta node meta from_node = source node meta from_node append source on_node_creation get_node_erase_hook on_node_erase node erased_nodes add node name name_to_node pop node name None on_node_erase get_node_replace_hook on_node_replace old Node new str user Node Update node meta when replacing old node new node new_node = name_to_node get new None new_node assert isinstance new_node Node replace hook called once each user old avoids adding duplicated source nodes added_nodes = s name s new_node meta get from_node old name added_nodes action = NodeSourceAction REPLACE new_node name created_nodes action append NodeSourceAction CREATE created_this_pass source source pass_name == passname source action == NodeSourceAction CREATE remove redundant source added node creation new_from_node = new_node meta get from_node new_from_node = source source new_from_node created_this_pass source add new source new_node_source = NodeSource old passname action new_from_node append new_node_source new_node meta from_node = new_from_node on_node_replace get_deepcopy_hook on_deepcopy gm copied_gms append gm on_deepcopy
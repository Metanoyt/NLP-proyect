mypy ignore-errors random sys pathlib Path typing Any sys path append str Path __file__ absolute parents benchmark_runner BenchmarkRunner type ignore import-not-found benchmark_utils type ignore import-not-found fits_in_memory get_mm_tensors get_random_between_pow torch torch _inductor utils fresh_cache BenchmarkRunnerMixedMM BenchmarkRunner type ignore misc no-any-unimported BenchmarkRunner mixed mm Used generate collect training data AutoHeuristic learn heuristic Currently we generating inputs following restrictions - m = n k = these inputs one triton kernels wins most cases - k == k multiple block size can have huge negative impact performance - mat transposed - mat transposed This allows us learn heuristic works well e g gpt-fast __init__ - None super __init__ mixed_mm create_input - tuple Any dtype dtype = get_dtypes m k n = get_m_k_n dtype transpose_left transpose_right = False True m k n transpose_left transpose_right dtype dtype run_benchmark m int k int n int transpose_left bool transpose_right bool dtype_left Any dtype_right Any - Any b = get_mm_tensors m k n transpose_left transpose_right dtype_left=dtype_left dtype_right=torch float b = b dtype=dtype_right fresh_cache mixed_mm A B torch mm A B A dtype cf = torch compile mixed_mm mode= max-autotune-no-cudagraphs cf b torch compiler reset random_multiple_of_ min_num= max_num= ran_pow = random randint min_num max_num - start = ran_pow end = ran_pow + random_multiple = random randint start end random_multiple get_random_pow min_power int max_power int random randint min_power max_power get_distr_type - str choose random multiple between ^ ^ choose random power between ^ ^ favoring larger values choose random number between choose random number between ^i ^ i+ i random choices mult_ pow uniform uniform-between-pow get_random_dim distr_type = get_distr_type distr_type == mult_ random_multiple_of_ min_num= max_num= distr_type == pow get_random_pow min_power = max_power = distr_type == uniform-between-pow get_random_between_pow min_power = max_power = distr_type == uniform random randint print f random_type distr_type supported sys exit get_random_num_small - int pow = random choices True False pow random randint get_random_between_pow get_m_k_n dtype Any - tuple int int int numel_max = repeat until tensors fit memory while True m = get_random_num_small k = get_random_dim n = get_random_dim k = continue assert k = n = k n must least m k = numel_max m n = numel_max k n = numel_max autotuning will happen tensors large continue fits_in_memory dtype m k n m k n get_dtypes - Any while True dtype_floats = torch float torch bfloat dtype_ints = torch int torch uint mat _dtype = random choices dtype_floats mat _dtype = random choices dtype_ints mat _dtype == torch bfloat mat _dtype == torch uint combination seems cause issues mixed_mm continue mat _dtype mat _dtype __name__ == __main__ runner = BenchmarkRunnerMixedMM runner run
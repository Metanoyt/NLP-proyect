logging typing Callable torch torch _inductor fx_passes bucketing bucket_all_gather_by_mb bucket_reduce_scatter_by_mb BucketMode merge_all_gather merge_reduce_scatter logger logging Logger = logging getLogger __name__ logger setLevel logging INFO is_graph_input node torch fx Node - bool node op == placeholder is_fsdp_all_gather_wait wait torch fx Node - bool Assume all_gather_into_tensor input either graph input dtype conversion graph input ag_node = wait args type ignore arg-type union-attr is_graph_input ag_node args type ignore arg-type union-attr type ignore arg-type union-attr ag_node args op == call_function type ignore arg-type union-attr ag_node args target type ignore arg-type union-attr == torch ops prims convert_element_type default type ignore arg-type union-attr is_graph_input ag_node args args type ignore arg-type union-attr is_graph_output node torch fx Node - bool all user op == output user node users is_fsdp_reduce_scatter_wait wait torch fx Node - bool is_graph_output wait True len wait users == user = next iter wait users assert user None is_graph_output user user op == call_function user target torch ops prims convert_element_type default False bucket_fsdp_all_gather gm torch fx GraphModule bucket_cap_mb_by_bucket_idx Callable int float &#124; None = None mode BucketMode = default - None Bucketing pass SimpleFSDP all_gather ops Attributes gm torch fx GraphModule Graph module graph bucket_cap_mb_by_bucket_idx Callable int float &#124; None callback function takes bucket id returns size bucket megabytes bucket_cap_mb_by_bucket_idx None torch _inductor fx_passes bucketing bucket_cap_mb_by_bucket_idx_default bucket_cap_mb_by_bucket_idx = bucket_cap_mb_by_bucket_idx_default assert bucket_cap_mb_by_bucket_idx None ag_buckets = bucket_all_gather_by_mb gm bucket_cap_mb_by_bucket_idx filter_wait_node=is_fsdp_all_gather_wait len ag_buckets == merge_all_gather gm ag_buckets mode bucket_fsdp_reduce_scatter gm torch fx GraphModule bucket_cap_mb_by_bucket_idx Callable int float &#124; None = None mode BucketMode = default - None Bucketing pass SimpleFSDP reduce_scatter ops Attributes gm torch fx GraphModule Graph module graph bucket_cap_mb_by_bucket_idx Callable int float &#124; None callback function takes bucket idx returns size bucket megabytes By default torch _inductor fx_passes bucketing bucket_cap_mb_by_bucket_idx_default used bucket_cap_mb_by_bucket_idx None torch _inductor fx_passes bucketing bucket_cap_mb_by_bucket_idx_default bucket_cap_mb_by_bucket_idx = bucket_cap_mb_by_bucket_idx_default rs_buckets = bucket_reduce_scatter_by_mb gm bucket_cap_mb_by_bucket_idx filter_wait_node=is_fsdp_reduce_scatter_wait len rs_buckets == merge_reduce_scatter gm rs_buckets mode
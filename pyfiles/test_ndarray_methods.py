Owner s module dynamo itertools unittest expectedFailure xfail skipIf skipif numpy pytest pytest raises assert_raises torch testing _internal common_utils instantiate_parametrized_tests parametrize run_tests skipIfTorchDynamo subtest TEST_WITH_TORCHDYNAMO TestCase xpassIfTorchDynamo_np TEST_WITH_TORCHDYNAMO numpy np numpy testing assert_equal torch _numpy np torch _numpy testing assert_equal TestIndexing TestCase skipif TEST_WITH_TORCHDYNAMO reason= tensor attr type test_indexing_simple = np array assert isinstance np ndarray assert isinstance np ndarray assert tensor _base tensor test_setitem = np array = assert isinstance np ndarray assert_equal TestReshape TestCase skipif TEST_WITH_TORCHDYNAMO reason= tensor attribute test_reshape_function arr = tgt = assert np all np reshape arr == tgt arr = np asarray arr assert np transpose arr tensor _base arr tensor skipif TEST_WITH_TORCHDYNAMO reason= tensor attribute test_reshape_method arr = np array arr_shape = arr shape tgt = reshape shape_tuple assert np all arr reshape == tgt assert arr reshape tensor _base arr tensor reshape keeps base assert arr shape == arr_shape arr intact XXX move out dedicated test s assert arr reshape tensor _base arr tensor reshape shape_tuple assert np all arr reshape == tgt assert arr reshape tensor _base arr tensor assert arr shape == arr_shape tgt = assert np all arr reshape == tgt assert arr reshape tensor _base arr tensor assert arr shape == arr_shape assert np all arr reshape == tgt assert arr reshape tensor _base arr tensor assert arr shape == arr_shape XXX order= C F tgt = assert np all arr T reshape order= C == tgt tgt = assert_equal arr reshape order= F tgt TestTranspose TestCase skipif TEST_WITH_TORCHDYNAMO reason= tensor attribute test_transpose_function arr = tgt = assert_equal np transpose arr tgt arr = np asarray arr assert np transpose arr tensor _base arr tensor skipif TEST_WITH_TORCHDYNAMO reason= tensor attribute test_transpose_method = np array assert_equal transpose assert_equal transpose None assert_raises RuntimeError ValueError lambda transpose assert_raises RuntimeError ValueError lambda transpose assert_raises RuntimeError ValueError lambda transpose assert transpose tensor _base tensor TestRavel TestCase skipif TEST_WITH_TORCHDYNAMO reason= tensor attribute test_ravel_function = tgt = assert_equal np ravel tgt arr = np asarray assert np ravel arr tensor _base arr tensor skipif TEST_WITH_TORCHDYNAMO reason= tensor attribute test_ravel_method = np array assert_equal ravel assert ravel tensor _base tensor TestNonzero TestCase test_nonzero_trivial assert_equal np nonzero np array assert_equal np array nonzero assert_equal np nonzero np array assert_equal np array nonzero assert_equal np nonzero np array assert_equal np array nonzero test_nonzero_onedim x = np array - assert_equal np nonzero x assert_equal x nonzero test_nonzero_twodim x = np array assert_equal np nonzero x assert_equal x nonzero x = np eye assert_equal np nonzero x assert_equal x nonzero test_sparse test special sparse condition boolean code path i range c = np zeros dtype=bool c i = True assert_equal np nonzero c np arange i + i assert_equal c nonzero np arange i + i c = np zeros dtype=bool c + i + i = True c + i = True assert_equal np nonzero c np concatenate np arange + i + i + i test_array_method Tests array method call nonzero works m = np array tgt = assert_equal m nonzero tgt instantiate_parametrized_tests TestArgmaxArgminCommon TestCase sizes = skipif numpy __version__ reason= NP_VER fails NumPy x parametrize size axis list itertools chain size axis axis list range -len size len size + None size sizes parametrize method np argmax np argmin test_np_argmin_argmax_keepdims size axis method arr = np random normal size=size arr = np empty shape=size contiguous arrays axis None new_shape = _ range len size new_shape = list size new_shape axis = new_shape = tuple new_shape _res_orig = method arr axis=axis res_orig = _res_orig reshape new_shape res = method arr axis=axis keepdims=True assert_equal res res_orig assert res shape == new_shape outarray = np empty res shape dtype=res dtype res = method arr axis=axis out=outarray keepdims=True assert res outarray assert_equal res outarray len size wrong_shape = list new_shape axis None wrong_shape axis = wrong_shape = wrong_outarray = np empty wrong_shape dtype=res dtype pytest raises ValueError method arr T axis=axis out=wrong_outarray keepdims=True non-contiguous arrays axis None new_shape = _ range len size new_shape = list size - new_shape axis = new_shape = tuple new_shape _res_orig = method arr T axis=axis res_orig = _res_orig reshape new_shape res = method arr T axis=axis keepdims=True assert_equal res res_orig assert res shape == new_shape outarray = np empty new_shape - dtype=res dtype outarray = outarray T res = method arr T axis=axis out=outarray keepdims=True assert res outarray assert_equal res outarray len size one dimension lesser non-zero sized array should raise error pytest raises ValueError method arr axis=axis out=outarray keepdims=True len size wrong_shape = list new_shape axis None wrong_shape axis = wrong_shape = wrong_outarray = np empty wrong_shape dtype=res dtype pytest raises ValueError method arr T axis=axis out=wrong_outarray keepdims=True skipif True reason= XXX need ndarray chooses parametrize method max min test_all method = np random normal = np arange reshape arg_method = getattr arg + method val_method = getattr method i range ndim a_maxmin = val_method i aarg_maxmin = arg_method i axes = list range ndim axes remove i assert np all a_maxmin == aarg_maxmin choose transpose i axes parametrize method argmax argmin test_output_shape method see also gh- = np ones arg_method = getattr method Check some simple shape mismatches out = np ones dtype=np int_ assert_raises ValueError arg_method - out=out out = np ones dtype=np int_ assert_raises ValueError arg_method - out=out these could relaxed possibly used allow even previous out = np ones dtype=np int_ assert_raises ValueError arg_method - out=out out = np ones dtype=np int_ arg_method - out=out assert_equal out arg_method - parametrize ndim parametrize method argmax argmin test_ret_is_out ndim method = np ones + ndim arg_method = getattr method out = np empty ndim dtype=np intp ret = arg_method axis= out=out assert ret out parametrize arr_method np_method argmax np argmax argmin np argmin test_np_vs_ndarray arr_method np_method make sure both ndarray argmax argmin numpy argmax argmin support out axis args = np random normal size= = np arange reshape arg_method = getattr arr_method check keyword args out = np zeros dtype=int out = np zeros dtype=int assert_equal arg_method out=out axis= np_method out=out axis= assert_equal out out parametrize arr_method np_method argmax np argmax argmin np argmin test_np_vs_ndarray_positional arr_method np_method = np arange reshape arg_method = getattr arr_method check positional args out = np zeros dtype=int out = np zeros dtype=int assert_equal arg_method out np_method out assert_equal out out instantiate_parametrized_tests TestArgmax TestCase usg_data = sg_data = usg_data + - - - - - - - - darr = np array d dtype=t d d t itertools product usg_data np uint darr += np array d dtype=t d d t itertools product sg_data np int np int np int np int np float np float darr += np array d dtype=t d d t itertools product np nan np nan np nan np nan np nan To hit tail SIMD multi-level x x inner loops variant SIMD widths - + np nan - - + np nan - - + np nan - - + np nan - - + np nan - np float np float nan_arr = darr + subtest complex np nan decorators= xpassIfTorchDynamo_np subtest complex np nan decorators= xpassIfTorchDynamo_np subtest complex np nan decorators= xpassIfTorchDynamo_np subtest complex np nan decorators= xpassIfTorchDynamo_np subtest complex np nan decorators= xpassIfTorchDynamo_np subtest complex np nan np nan decorators= xpassIfTorchDynamo_np subtest complex np nan complex np nan complex np nan decorators= xpassIfTorchDynamo_np subtest complex np nan np nan complex np nan complex np nan decorators= xpassIfTorchDynamo_np subtest complex np nan complex np nan complex np nan np nan decorators= xpassIfTorchDynamo_np subtest complex complex complex decorators= xpassIfTorchDynamo_np subtest complex complex complex decorators= xpassIfTorchDynamo_np subtest complex complex complex decorators= xpassIfTorchDynamo_np False False False False True False False False True False True False False False False True False True False False parametrize data nan_arr test_combinations data arr pos = data suppress_warnings sup sup filter RuntimeWarning invalid value encountered reduce np asarray arr dtype kind c pytest xfail reason= max_values_cpu implemented ComplexDouble val = np max arr assert_equal np argmax arr pos err_msg= r arr assert_equal arr np argmax arr val err_msg= r arr add padding test SIMD loops rarr = np repeat arr rpos = pos assert_equal np argmax rarr rpos err_msg=f rarr r assert_equal rarr np argmax rarr val err_msg=f rarr r padd = np repeat np min arr rarr = np concatenate arr padd rpos = pos assert_equal np argmax rarr rpos err_msg=f rarr r assert_equal rarr np argmax rarr val err_msg=f rarr r test_maximum_signed_integers = np array - - dtype=np int assert_equal np argmax = np array - - dtype=np int assert_equal np argmax = np array - - dtype=np int assert_equal np argmax = np array - - dtype=np int assert_equal np argmax instantiate_parametrized_tests TestArgmin TestCase usg_data = sg_data = usg_data + - - - - - - - - darr = np array d dtype=t d d t itertools product usg_data np uint darr += np array d dtype=t d d t itertools product sg_data np int np int np int np int np float np float darr += np array d dtype=t d d t itertools product np nan np nan np nan np nan np nan To hit tail SIMD multi-level x x inner loops variant SIMD widths - + np nan - - + np nan - - + np nan - - + np nan - - + np nan - np float np float nan_arr = darr + subtest complex np nan decorators= xfail subtest complex np nan decorators= xfail subtest complex np nan decorators= xfail subtest complex np nan decorators= xfail subtest complex np nan decorators= xfail subtest complex np nan np nan decorators= xfail subtest complex np nan complex np nan complex np nan decorators= xfail subtest complex np nan np nan complex np nan complex np nan decorators= xfail subtest complex np nan complex np nan complex np nan np nan decorators= xfail subtest complex complex complex decorators= xfail subtest complex complex complex decorators= xfail subtest complex complex complex decorators= xfail True True True True False True True True False True False True True True True False True False True True parametrize data nan_arr test_combinations data arr pos = data np asarray arr dtype kind c pytest xfail reason= min_values_cpu implemented ComplexDouble suppress_warnings sup sup filter RuntimeWarning invalid value encountered reduce min_val = np min arr assert_equal np argmin arr pos err_msg=f arr r assert_equal arr np argmin arr min_val err_msg=f arr r add padding test SIMD loops rarr = np repeat arr rpos = pos assert_equal np argmin rarr rpos err_msg=f rarr r assert_equal rarr np argmin rarr min_val err_msg=f rarr r padd = np repeat np max arr rarr = np concatenate arr padd rpos = pos assert_equal np argmin rarr rpos err_msg=f rarr r assert_equal rarr np argmin rarr min_val err_msg=f rarr r test_minimum_signed_integers = np array - - + - dtype=np int assert_equal np argmin = np array - - + - dtype=np int assert_equal np argmin = np array - - + - dtype=np int assert_equal np argmin = np array - - + - dtype=np int assert_equal np argmin TestAmax TestCase test_basic = - - assert_equal np amax b = assert_equal np amax b axis= assert_equal np amax b axis= arr = np asarray assert_equal np amax arr arr max TestAmin TestCase test_basic = - - assert_equal np amin - b = assert_equal np amin b axis= assert_equal np amin b axis= arr = np asarray assert_equal np amin arr arr min TestContains TestCase test_contains = np arange reshape assert assert instantiate_parametrized_tests TestNoExtraMethods TestCase make sure ndarray does carry extra methods attributes set dir - set dir tensor numpy parametrize name fn ivar method name plain rvar test_extra_methods name = np ones pytest raises AttributeError getattr name TestIter TestCase skipIfTorchDynamo test_iter_ d numpy generates array scalars we do D arrays = np arange lst = list assert all type x np ndarray x lst f type x x lst assert all x ndim == x lst test_iter_ d numpy iterates over th axis = np arange None lst = list assert len lst == FIXME cannot used here because dynamo fails assert type lst == np ndarray noqa E assert_equal lst np arange __name__ == __main__ run_tests
usr bin env python __future__ annotations argparse os yaml torchgen code_template CodeTemplate torchgen selective_build selector SelectiveBuilder Safely load fast C Yaml loader dumper they available try yaml CSafeLoader Loader except ImportError yaml SafeLoader Loader type ignore assignment misc if_condition_template_str = kernel_tag_sv compare $ kernel_tag_name == $ dtype_checks if_condition_template = CodeTemplate if_condition_template_str selected_kernel_dtypes_h_template_str = #include c core ScalarType h #include c macros Macros h #include string_view namespace inline constexpr bool should_include_kernel_dtype const char kernel_tag_str ScalarType scalar_type maybe_unused auto kernel_tag_sv = std string_view kernel_tag_str $ body false selected_kernel_dtypes_h_template = CodeTemplate selected_kernel_dtypes_h_template_str selected_mobile_ops_preamble = #pragma once Generated gen_selected_mobile_ops_header py extract_root_operators selective_builder SelectiveBuilder - set str ops = op_name op selective_builder operators items op is_root_operator ops append op_name set ops get_selected_kernel_dtypes_code selective_builder SelectiveBuilder - str See https www internalfb com intern paste P example generated code case all kernel dtypes selected case some kernel dtypes selected i e both cases body = true selective_builder include_all_operators False selective_builder include_all_non_op_selectives False body_parts = kernel_tag dtypes selective_builder kernel_metadata items conditions = scalar_type == ScalarType + x x dtypes body_parts append pyrefly ignore bad-argument-type if_condition_template substitute kernel_tag_name=kernel_tag dtype_checks= &#124; &#124; join conditions body = join body_parts header_contents = selected_kernel_dtypes_h_template substitute body=body header_contents Write file selected_mobile_ops h optionally The selected root operators The selected kernel dtypes write_selected_mobile_ops output_file_path str selective_builder SelectiveBuilder - None root_ops = extract_root_operators selective_builder custom_classes = selective_builder custom_classes build_features = selective_builder build_features open output_file_path wb out_file body_parts = selected_mobile_ops_preamble This condition checks we selective build these lists defined corresponding selective build macros trivially item question selected selective_builder include_all_operators body_parts append #define TORCH_OPERATOR_WHITELIST + join sorted root_ops + \n\n This condition checks we tracing based selective build selective_builder include_all_non_op_selectives False body_parts append #define TORCH_CUSTOM_CLASS_ALLOWLIST + join sorted custom_classes + \n\n body_parts append #define TORCH_BUILD_FEATURE_ALLOWLIST + join sorted build_features + \n\n body_parts append get_selected_kernel_dtypes_code selective_builder header_contents = join body_parts out_file write header_contents encode utf- root_ops set selected root operators selective build Write file selected_mobile_ops h optionally The selected root operators root_ops All kernel dtypes write_selected_mobile_ops_with_all_dtypes output_file_path str root_ops set str - None open output_file_path wb out_file body_parts = selected_mobile_ops_preamble body_parts append #define TORCH_OPERATOR_WHITELIST + join sorted root_ops + \n\n selective_builder = SelectiveBuilder get_nop_selector body_parts append get_selected_kernel_dtypes_code selective_builder header_contents = join body_parts out_file write header_contents encode utf- main - None parser = argparse ArgumentParser description= Generate selected_mobile_ops h selective build parser add_argument -p -- yaml-file-path -- yaml_file_path type=str required=True help= Path yaml file list operators used model parser add_argument -o -- output-file-path -- output_file_path type=str required=True help= Path destinationfolder where selected_mobile_ops h will written parsed_args = parser parse_args model_file_name = parsed_args yaml_file_path print Loading yaml file model_file_name loaded_model = open model_file_name rb model_file loaded_model = yaml load model_file Loader=Loader root_operators_set = set loaded_model print Writing header file selected_mobile_ops h parsed_args output_file_path write_selected_mobile_ops_with_all_dtypes os path join parsed_args output_file_path selected_mobile_ops h root_operators_set __name__ == __main__ main
======= BEGIN Dynamo patch ======= Owner s module dynamo ruff noqa flake noqa Test copied https raw githubusercontent com python cpython refs tags v Lib test seq_tests py sys torch torch _dynamo test_case unittest torch _dynamo test_case CPythonTestCase torch testing _internal common_utils run_tests __TestCase = CPythonTestCase redirect statements sys importlib abc redirect_imports = test mapping_tests test typinganndata test test_grammar test test_math test test_iter test typinganndata ann_module RedirectImportFinder importlib abc MetaPathFinder find_spec fullname path target=None Check problematic one fullname redirect_imports try Attempt standalone module name = fullname removeprefix test r = importlib import_module name Redirect module sys modules sys modules fullname = r Return module spec found module importlib util find_spec name except ImportError None None Add custom finder sys meta_path sys meta_path insert RedirectImportFinder ======= END DYNAMO PATCH ======= Tests common tuple list UserList UserList unittest sys pickle test support test support ALWAYS_EQ NEVER_EQ Various iterables This used checking constructor here test_deque py iterfunc seqn Regular generator i seqn yield i Sequence Sequence using __getitem__ __init__ seqn seqn = seqn __getitem__ i seqn i IterFunc Sequence using iterator protocol __init__ seqn seqn = seqn i = __iter__ __next__ i = len seqn raise StopIteration v = seqn i i += v IterGen Sequence using iterator protocol defined generator __init__ seqn seqn = seqn i = __iter__ val seqn yield val IterNextOnly Missing __getitem__ __iter__ __init__ seqn seqn = seqn i = __next__ i = len seqn raise StopIteration v = seqn i i += v IterNoNext Iterator missing __next__ __init__ seqn seqn = seqn i = __iter__ IterGenExc Test propagation exceptions __init__ seqn seqn = seqn i = __iter__ __next__ IterFuncStop Test immediate stop __init__ seqn pass __iter__ __next__ raise StopIteration itertools chain itermulti seqn Test multiple tiers iterators chain map lambda x x iterfunc IterGen Sequence seqn LyingTuple tuple __iter__ yield LyingList list __iter__ yield CommonTest __TestCase The type tested type test = None test_constructors l = l = l = u = type test u = type test l u = type test l u = type test l uu = type test u uu = type test u uu = type test u uu = type test u v = type test tuple u torch _dynamo error_on_graph_break False OtherSeq __init__ initseq __data = initseq __len__ len __data __getitem__ i __data i s = OtherSeq u v = type test s assertEqual len v len s s = also sequence vv = type test s assertEqual len vv len s Create various iteratables s range do range g Sequence IterFunc IterGen itermulti iterfunc assertEqual type test g s type test s assertEqual type test IterFuncStop s type test assertEqual type test c c type test assertRaises TypeError type test IterNextOnly s assertRaises TypeError type test IterNoNext s assertRaises ZeroDivisionError type test IterGenExc s Issue assertEqual type test LyingTuple type test assertEqual type test LyingList type test assertRaises TypeError type test unsupported_arg= test_truth assertFalse type test assertTrue type test test_getitem u = type test i range len u assertEqual u i i assertEqual u int i i i range -len u - assertEqual u i len u +i assertEqual u int i len u +i assertRaises IndexError u __getitem__ -len u - assertRaises IndexError u __getitem__ len u assertRaises ValueError u __getitem__ slice u = type test assertRaises IndexError u __getitem__ assertRaises IndexError u __getitem__ - assertRaises TypeError u __getitem__ = type test assertEqual assertEqual assertEqual - assertEqual - assertRaises IndexError __getitem__ - assertRaises IndexError __getitem__ test_getslice l = u = type test l assertEqual u type test assertEqual u type test assertEqual u - - type test assertEqual u - u assertEqual u - type test assertEqual u u assertEqual u None type test assertEqual u None type test Extended slices assertEqual u u assertEqual u type test assertEqual u type test assertEqual u - type test assertEqual u - type test assertEqual u - type test assertEqual u - type test assertEqual u - type test assertEqual u - type test assertEqual u - type test assertEqual u - type test assertEqual u - type test assertEqual u - u assertEqual u - - u - assertEqual u - - type test assertEqual u - type test Test extreme cases long ints = type test assertEqual -pow type test assertEqual pow type test assertEqual sys maxsize type test test_contains u = type test i u assertIn i u i min u - max u + assertNotIn i u assertRaises TypeError u __contains__ test_contains_fake Sequences must use rich comparison against each item unless true earlier item answered So ALWAYS_EQ must found all non-empty sequences assertNotIn ALWAYS_EQ type test assertIn ALWAYS_EQ type test assertIn type test ALWAYS_EQ assertNotIn NEVER_EQ type test assertNotIn ALWAYS_EQ type test NEVER_EQ assertIn NEVER_EQ type test ALWAYS_EQ test_contains_order Sequences must test in-order If rich comparison has side effects these will visible tests against later members In test side effect short-circuiting raise torch _dynamo error_on_graph_break False DoNotTestEq Exception pass StopCompares __eq__ other raise DoNotTestEq checkfirst = type test StopCompares assertIn checkfirst checklast = type test StopCompares assertRaises DoNotTestEq checklast __contains__ test_len assertEqual len type test assertEqual len type test assertEqual len type test assertEqual len type test test_minmax u = type test assertEqual min u assertEqual max u test_addmul u = type test u = type test assertEqual u u + type test assertEqual u type test + u assertEqual u + type test u assertEqual type test - + u type test - assertEqual type test u assertEqual type test u assertEqual type test u assertEqual type test u assertEqual u u assertEqual u u assertEqual u u assertEqual u u assertEqual u +u u assertEqual u +u u assertEqual u +u u assertEqual u +u u assertEqual u +u +u u assertEqual u +u +u u torch _dynamo error_on_graph_break False subclass type test pass u = subclass assertEqual u u assertIsNot u u test_iadd u = type test u += type test assertEqual u type test u += type test assertEqual u type test u += type test assertEqual u type test u = type test spam u += type test eggs assertEqual u type test spameggs test_imul u = type test u = assertEqual u type test u = assertEqual u type test test_getitemoverwriteiter Verify __getitem__ overrides recognized __iter__ torch _dynamo error_on_graph_break False T type test __getitem__ key str key + assertEqual next iter T test_repeat m range s = tuple range m n range - assertEqual type test s n type test s n assertEqual type test s - type test assertEqual id s id s test_bigrepeat sys maxsize = x = type test x = assertRaises MemoryError x __mul__ hasattr x __imul__ assertRaises MemoryError x __imul__ test_subscript = type test assertEqual __getitem__ assertEqual __getitem__ assertEqual __getitem__ - assertEqual __getitem__ - assertRaises IndexError __getitem__ - assertRaises IndexError __getitem__ assertEqual __getitem__ slice type test assertEqual __getitem__ slice type test assertEqual __getitem__ slice type test assertEqual __getitem__ slice type test assertEqual __getitem__ slice type test assertRaises ValueError __getitem__ slice assertRaises TypeError __getitem__ x test_count = type test assertEqual count assertEqual count assertEqual count assertEqual count ALWAYS_EQ assertEqual type test ALWAYS_EQ ALWAYS_EQ count assertEqual type test ALWAYS_EQ ALWAYS_EQ count NEVER_EQ assertEqual type test NEVER_EQ NEVER_EQ count ALWAYS_EQ assertRaises TypeError count torch _dynamo error_on_graph_break False BadExc Exception pass BadCmp __eq__ other other == raise BadExc False assertRaises BadExc count BadCmp test_index u = type test assertEqual u index assertEqual u index assertRaises ValueError u index u = type test - - assertEqual u count assertEqual u index assertEqual u index assertEqual u index - - assertEqual u index assertEqual u index assertRaises ValueError u index - assertEqual u index ALWAYS_EQ assertEqual type test ALWAYS_EQ ALWAYS_EQ index assertEqual type test ALWAYS_EQ ALWAYS_EQ index NEVER_EQ assertRaises ValueError type test NEVER_EQ NEVER_EQ index ALWAYS_EQ assertRaises TypeError u index torch _dynamo error_on_graph_break False BadExc Exception pass BadCmp __eq__ other other == raise BadExc False = type test assertRaises BadExc index BadCmp = type test - - assertEqual index assertEqual index assertEqual index - assertEqual index - - assertEqual index assertEqual index - assertEqual index assertEqual index - - assertEqual index - sys maxsize sys maxsize assertRaises ValueError index sys maxsize - sys maxsize assertRaises ValueError index - test_pickle lst = type test proto range pickle HIGHEST_PROTOCOL + lst = pickle loads pickle dumps lst proto assertEqual lst lst assertNotEqual id lst id lst support suppress_immortalization test_free_after_iterating support check_free_after_iterating iter type test support check_free_after_iterating reversed type test
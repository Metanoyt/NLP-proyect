usr bin env python os shutil sys pathlib Path subprocess check_call tempfile TemporaryDirectory typing Optional SCRIPT_DIR = Path __file__ parent REPO_DIR = SCRIPT_DIR parent parent read_triton_pin device str = cuda - str triton_file = triton txt device == xpu triton_file = triton-xpu txt open REPO_DIR ci docker ci_commit_pins triton_file f f read strip read_triton_version device str = cuda - str triton_version_file = triton_version txt device == xpu triton_version_file = triton_xpu_version txt open REPO_DIR ci docker triton_version_file f f read strip check_and_replace inp str src str dst str - str Checks ` src ` can found ` input ` replaces ` dst ` src inp raise RuntimeError f Can t find $ src input inp replace src dst patch_init_py path Path version str expected_version Optional str = None - None expected_version expected_version = read_triton_version open path f orig = f read Replace version orig = check_and_replace orig f __version__ = expected_version f __version__ = version open path w f f write orig build_triton version str commit_hash str device str = cuda py_version Optional str = None release bool = False with_clang_ldd bool = False - Path env = os environ copy MAX_JOBS env max_jobs = os cpu_count env MAX_JOBS = str max_jobs TemporaryDirectory tmpdir triton_basedir = Path tmpdir triton triton_pythondir = triton_basedir python triton_repo = https github com openai triton device == rocm triton_pkg_name = pytorch-triton-rocm device == xpu triton_pkg_name = pytorch-triton-xpu triton_repo = https github com intel intel-xpu-backend-for-triton triton_pkg_name = pytorch-triton check_call git clone triton_repo triton cwd=tmpdir release ver rev patch = version split check_call git checkout f release ver rev x cwd=triton_basedir check_call git fetch origin commit_hash cwd=triton_basedir check_call git checkout commit_hash cwd=triton_basedir change built wheel name version env TRITON_WHEEL_NAME = triton_pkg_name with_clang_ldd env TRITON_BUILD_WITH_CLANG_LLD = patch_init_py triton_pythondir triton __init__ py version=f version expected_version=read_triton_version device device == rocm check_call f SCRIPT_DIR amd package_triton_wheel sh cwd=triton_basedir shell=True print ROCm libraries setup triton installation old triton versions have setup py python dir new versions have root dir triton_setupdir = triton_basedir triton_basedir setup py exists triton_pythondir check_call sys executable setup py bdist_wheel cwd=triton_setupdir env=env whl_path = next iter triton_setupdir dist glob whl shutil copy whl_path Path cwd device == rocm check_call f SCRIPT_DIR amd patch_triton_wheel sh Path cwd cwd=triton_basedir Path cwd whl_path name main - None argparse ArgumentParser parser = ArgumentParser Build Triton binaries parser add_argument -- release action= store_true parser add_argument -- device type=str default= cuda choices= cuda rocm xpu aarch parser add_argument -- py-version type=str parser add_argument -- commit-hash type=str parser add_argument -- with-clang-ldd action= store_true parser add_argument -- triton-version type=str default=None args = parser parse_args triton_version = read_triton_version args device args triton_version triton_version = args triton_version build_triton device=args device commit_hash= args commit_hash args commit_hash read_triton_pin args device version=triton_version py_version=args py_version release=args release with_clang_ldd=args with_clang_ldd __name__ == __main__ main
Owner s oncall distributed unittest mock patch torch torch distributed checkpoint dcp torch distributed checkpoint metadata BytesStorageMetadata ChunkStorageMetadata Metadata MetadataIndex TensorProperties TensorStorageMetadata torch testing _internal common_utils run_tests TestCase torch testing _internal distributed checkpoint_utils with_temp_dir TestDCPCompatbility TestCase test_metadata - None Ensure all new fields all metadata have default values so we can always deserialize legacy metadata try tensor = torch zeros chunk_meta = ChunkStorageMetadata torch Size torch Size tensor_meta = TensorStorageMetadata properties=TensorProperties create_from_tensor tensor size=tensor size chunks= chunk_meta b_meta = BytesStorageMetadata _ = Metadata state_dict_metadata= tensor_meta b b_meta _ = MetadataIndex fqn= b c except Exception e raise RuntimeError The change may break BC distributed checkpoint e test_sharded_tensor_dependency - None Ensure we can load existing DCP checkpoints back even metadata contain _shard sharded_tensor metadata torch distributed _shard sharded_tensor metadata TensorProperties stp patch torch distributed checkpoint metadata TensorProperties stp dcp save torch zeros dcp FileSystemWriter tmp dcp_testing dcp load torch zeros dcp FileSystemReader tmp dcp_testing with_temp_dir test_storage_meta - None writer = dcp FileSystemWriter temp_dir dcp save torch zeros storage_writer=writer reader = dcp FileSystemReader temp_dir storage_meta = reader read_metadata storage_meta assertNotEqual storage_meta None assertEqual str storage_meta checkpoint_id temp_dir assertEqual storage_meta save_id writer save_id assertEqual storage_meta load_id reader load_id with_temp_dir test_with_v_ _ - None sd = torch zeros dict dict_a dict_a_ dict_a_ dict_b dict_b_ dict_b_ list load_sd = torch ones dict dict_a dict_a_ dict_a_ dict_b dict_b_ dict_b_ list dcp _version _act_like_version = _ dcp save sd checkpoint_id=self temp_dir dcp _version _act_like_version = None dcp load load_sd checkpoint_id=self temp_dir assertEqual sd load_sd __name__ == __main__ run_tests
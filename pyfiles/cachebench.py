argparse dataclasses json logging os subprocess sys tempfile collections abc Callable torch _inductor utils fresh_cache logger logging Logger = logging getLogger __name__ TIMEOUT int = Keep sync ci pytorch test sh TORCHBENCH_MODELS list str = nanogpt BERT_pytorch resnet moco llama HUGGINGFACE_MODELS list str = AllenaiLongformerBase BertForMaskedLM GPT ForSequenceClassification dataclasses dataclass RunResult model str mode str inference training benchmark str dynamic bool device str cuda cpu cold_compile_s list float warm_compile_s list float speedup_pct float get_compile_time file tempfile _TemporaryFileWrapper - float lines = file readlines Decode byte string remove new lines parse csv lines = line decode utf- strip split line lines compilation_time_idx = lines index compilation_latency compilation_time = lines compilation_time_idx float compilation_time _run_torchbench_from_args cmd_args argparse Namespace model str args list str - tuple list float list float cold_compile_time list float = warm_compile_time list float = _ range cmd_args repeat fresh_cache env = os environ copy tempfile NamedTemporaryFile suffix= csv file args append -- output= + file name logger info f Performing cold-start run model noqa G subprocess check_call args timeout=TIMEOUT env=env cold_compile_time append get_compile_time file args pop tempfile NamedTemporaryFile suffix= csv file args append -- output= + file name logger info f Performing warm-start run model noqa G subprocess check_call args timeout=TIMEOUT env=env warm_compile_time append get_compile_time file cold_compile_time warm_compile_time MODE_ARGS_DICT = inference -- inference -- bfloat training -- training -- amp BENCHMARK_FILE = torchbench torchbench py huggingface huggingface py _run_torchbench_model cmd_args argparse Namespace results list RunResult model str - None cur_file = os path abspath __file__ torchbench_file = os path join os path dirname cur_file BENCHMARK_FILE cmd_args benchmark assert os path exists torchbench_file f Torchbench does exist torchbench_file dynamic = cmd_args dynamic dynamic_args = -- dynamic-shapes -- dynamic-batch-only dynamic args = sys executable torchbench_file f -- only= model -- repeat= -- performance -- backend=inductor f -- device= cmd_args device + MODE_ARGS_DICT cmd_args mode + dynamic_args logger info f Command args noqa G try cold_compile_t warm_compile_t = _run_torchbench_from_args cmd_args model args speedup_pct = - sum warm_compile_t sum cold_compile_t results append RunResult model=model mode=cmd_args mode benchmark=cmd_args benchmark dynamic=dynamic device=cmd_args device cold_compile_s=cold_compile_t warm_compile_s=warm_compile_t speedup_pct=speedup_pct except Exception logger info fail exc_info=True None _write_results_to_json cmd_args argparse Namespace results list RunResult - None len results == do write empty results records = result results metric_name value Cold compile time s result cold_compile_s Warm compile time s result warm_compile_s Speedup result speedup_pct records append benchmark name TorchCache Benchmark mode result mode extra_info is_dynamic result dynamic device result device model name result model backend inductor origins result benchmark metric name metric_name type OSS model benchmark_values value open cmd_args output w f json dump records f parse_cmd_args - argparse Namespace parser = argparse ArgumentParser description= Run TorchCache benchmark parser add_argument -m -- model help= Name model run parser add_argument -- dynamic action= store_true help= Whether run dynamic enabled parser add_argument -- benchmark choices= torchbench huggingface required=True help= Name benchmark suite run parser add_argument -- mode choices= inference training default= training parser add_argument -- device default= cuda choices= cuda cpu parser add_argument -- output required=True help= The output filename json parser add_argument -- repeat type=int default= choices=range help= Number times repeat compilation reduce noise args _ = parser parse_known_args args Dispatch_fn_t = Callable argparse Namespace list RunResult str None main - None cmd_args = parse_cmd_args dispatcher dict str tuple Dispatch_fn_t list str = torchbench _run_torchbench_model TORCHBENCH_MODELS huggingface _run_torchbench_model HUGGINGFACE_MODELS fn models = dispatcher cmd_args benchmark cmd_args model None models = cmd_args model results list RunResult = model models fn cmd_args results model _write_results_to_json cmd_args results __name__ == __main__ main
This example adapted https github com muhrin milad It licensed under GLPv license You can find copy here https www gnu org licenses gpl- en html torch torch nn torch func jacrev vmap torch nn functional mse_loss sigma = epsilon = lennard_jones r epsilon sigma r - sigma r lennard_jones_force r Get magnitude LJ force -epsilon - sigma r + sigma r training_size = r = torch linspace sigma steps=training_size requires_grad=True Create bunch vectors point along positive-x drs = torch outer r torch tensor norms = torch norm drs dim= reshape - Create training energies training_energies = torch stack list map lennard_jones norms reshape - Create forces random direction vectors training_forces = torch stack force dr force dr zip map lennard_jones_force norms drs model = nn Sequential nn Linear nn Tanh nn Linear nn Tanh nn Linear nn Tanh nn Linear nn Tanh nn Linear make_prediction model drs norms = torch norm drs dim= reshape - energies = model norms network_derivs = vmap jacrev model norms squeeze - forces = -network_derivs drs norms energies forces loss_fn energies forces predicted_energies predicted_forces mse_loss energies predicted_energies + mse_loss forces predicted_forces optimiser = torch optim Adam model parameters lr= e- epoch range optimiser zero_grad energies forces = make_prediction model drs loss = loss_fn training_energies training_forces energies forces loss backward retain_graph=True optimiser step epoch == print loss cpu item
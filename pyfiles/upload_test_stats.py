__future__ annotations argparse os sys xml etree ElementTree ET multiprocessing cpu_count Pool pathlib Path tempfile TemporaryDirectory typing Any tools stats test_dashboard upload_additional_info tools stats upload_stats_lib download_s _artifacts get_job_id remove_nan_inf unzip upload_workflow_stats_to_s parse_xml_report tag str report Path workflow_id int workflow_run_attempt int - list dict str Any Convert test report xml file into JSON-serializable list test cases print f Parsing tag s test report report job_id = get_job_id report print f Found job id job_id test_cases list dict str Any = root = ET parse report test_case root iter tag case = process_xml_element test_case case workflow_id = workflow_id case workflow_run_attempt = workflow_run_attempt case job_id = job_id invoking file The name file test located necessarily same name file invoked test For example ` test_jit py ` calls into multiple other test files e g jit test_dce py For sharding test selection purposes we want record file invoked test To do we leverage implementation detail how we write out tests https bit ly ajEV M which reports created under folder same name invoking file case invoking_file = report parent name test_cases append case test_cases process_xml_element element ET Element output_numbers bool = True - dict str Any Convert test suite element into JSON-serializable dict ret dict str Any = Convert attributes directly into dict elements e g testcase name= test_foo classname= test_bar testcase becomes name test_foo classname test_bar ret update element attrib The XML format encodes all values strings Convert ints floats possible make aggregation possible SQL output_numbers k v ret items try ret k = int v except ValueError try ret k = float v except ValueError pass Convert inner outer text into special dict elements e g testcase my_inner_text testcase my_tail becomes text my_inner_text tail my_tail element text element text strip ret text = element text element tail element tail strip ret tail = element tail Convert child elements recursively placing them key e g testcase foo hello foo foo world foo bar another bar testcase becomes foo text hello text world bar text another child element child tag ret ret child tag = process_xml_element child If there multiple tags same name they should coalesced into list isinstance ret child tag list ret child tag = ret child tag ret child tag append process_xml_element child ret get_tests workflow_run_id int workflow_run_attempt int - list dict str Any TemporaryDirectory temp_dir print Using temporary directory temp_dir os chdir temp_dir Download extract all reports both GHA S s _paths = download_s _artifacts test-report workflow_run_id workflow_run_attempt path s _paths unzip path Parse reports transform them JSON test_cases = mp = Pool cpu_count xml_report Path glob xml test_cases append mp apply_async parse_xml_report args= testcase xml_report workflow_run_id workflow_run_attempt mp close mp join test_cases = tc get tc test_cases flattened = item sublist test_cases item sublist flattened get_tests_for_circleci workflow_run_id int workflow_run_attempt int - list dict str Any Parse reports transform them JSON test_cases = xml_report Path glob test test-reports xml test_cases extend parse_xml_report testcase xml_report workflow_run_id workflow_run_attempt test_cases summarize_test_cases test_cases list dict str Any - list dict str Any Group test cases classname file job_id We perform aggregation manually instead using ` test-suite ` XML tag because xmlrunner does produce reliable output get_key test_case dict str Any - Any test_case get file test_case get classname test_case job_id test_case workflow_id test_case workflow_run_attempt see invoking file test_case invoking_file init_value test_case dict str Any - dict str Any file test_case get file classname test_case get classname job_id test_case job_id workflow_id test_case workflow_id workflow_run_attempt test_case workflow_run_attempt see invoking file invoking_file test_case invoking_file tests failures errors skipped successes time ret = test_case test_cases key = get_key test_case key ret ret key = init_value test_case ret key tests += failure test_case ret key failures += error test_case ret key errors += skipped test_case ret key skipped += ret key successes += ret key time += test_case time list ret values __name__ == __main__ parser = argparse ArgumentParser description= Upload test stats s parser add_argument -- workflow-run-id required=True help= id workflow get artifacts parser add_argument -- workflow-run-attempt type=int required=True help= which retry workflow parser add_argument -- head-branch required=True help= Head branch workflow parser add_argument -- head-repository required=True help= Head repository workflow parser add_argument -- circleci action= store_true help= If being run through circleci args = parser parse_args print f Workflow id args workflow_run_id args circleci test_cases = get_tests_for_circleci args workflow_run_id args workflow_run_attempt test_cases = get_tests args workflow_run_id args workflow_run_attempt Flush stdout so any errors upload show up last logs sys stdout flush For PRs only upload summary test_runs This helps lower volume writes we do HUD backend database test_case_summary = summarize_test_cases test_cases upload_workflow_stats_to_s args workflow_run_id args workflow_run_attempt test_run_summary remove_nan_inf test_case_summary Separate out failed test cases Uploading everything too data intensive most time these will just tiny fraction failed_tests_cases = test_case test_cases rerun test_case failure test_case error test_case failed_tests_cases append test_case upload_workflow_stats_to_s args workflow_run_id args workflow_run_attempt failed_test_runs remove_nan_inf failed_tests_cases args head_branch == main args head_repository == pytorch pytorch For jobs main branch upload everything upload_workflow_stats_to_s args workflow_run_id args workflow_run_attempt test_run remove_nan_inf test_cases Part experiment see we can handle all data upload_workflow_stats_to_s args workflow_run_id args workflow_run_attempt all_test_runs remove_nan_inf test_cases upload_additional_info args workflow_run_id args workflow_run_attempt test_cases
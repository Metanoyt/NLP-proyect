__future__ annotations collections deque dataclasses dataclass typing Any Callable Optional TYPE_CHECKING typing_extensions final override torch _inductor async_compile noqa F required warm up AsyncCompile pools torch _inductor output_code CompiledFxGraphConstants OutputCode compile_fx _CompileFxKwargs _InProcessFxCompile FxCompile output_code complex_memory_overlap noqa F When async compile works cache remove disabling below BUG_CACHES_DONT_WORK_WITH_ASYNC = True TYPE_CHECKING collections abc Sequence concurrent futures Future torch _inductor utils InputType torch fx GraphModule compile_fx_ext _OutOfProcessFxCompile _WireProtocolPickledOutput dataclass _PostCompileData example_inputs Sequence InputType constants CompiledFxGraphConstants graph_kwargs _CompileFxKwargs dataclass ProgressiveCompilationState progression_futures deque Future _WireProtocolPickledOutput callback Callable _WireProtocolPickledOutput OutputCode post_compile_data Optional _PostCompileData check_and_get_ready_stage - int Check any progression stage ready its index - none ready progression_futures - stage_index = - post_compile_data i future enumerate progression_futures future done stage_index = i stage_index switch_to_progression_stage stage_index int - tuple OutputCode bool Switch specified progression stage optimized output code Returns tuple optimized_output_code should_clear_compilation_state future = progression_futures stage_index assert future None optimized_output_code = callback future result pcd = post_compile_data optimized_output_code post_compile pcd example_inputs pcd constants pcd graph_kwargs Clear earlier progression futures free memory _ range stage_index + progression_futures popleft Return whether all compilation state should cleared should_clear_state = progression_futures optimized_output_code should_clear_state _AsyncOutputCode handles actual management waiting out-of-process compile finish then switching over final _AsyncOutputCode OutputCode _eager_fn Optional Callable Any _output_code Optional OutputCode _future Optional Future _WireProtocolPickledOutput _callback Callable _WireProtocolPickledOutput OutputCode _post_compile_data Optional _PostCompileData = None _boxed_call bool Copied forward output_code __init__ eager_fn run until future finished eager_fn Callable Any responds result out-of-process compile when s ready future Future _WireProtocolPickledOutput callback gets called turn _WireProtocolPickledOutput into OutputCode callback Callable _WireProtocolPickledOutput OutputCode - None _eager_fn = eager_fn _boxed_call = getattr eager_fn _boxed_call False _output_code = None _future = future _callback = callback override __call__ args Any - Any _future None _future done args = _switch_to_compiled_fn args eager_fn = _eager_fn _AsyncFxCompile _stat_eager_runs += eager_fn args _AsyncFxCompile _stat_compiled_runs += assert _output_code None _output_code __call__ args Takes returns args converted right boxed mode _switch_to_compiled_fn args tuple Any - tuple Any assert _future None TODO If future ended exception do we want continue running eager hit exception now f _future = _future None output_code = _callback f result pcd = _post_compile_data _post_compile_data = None output_code post_compile pcd example_inputs pcd constants pcd graph_kwargs _output_code = output_code _eager_fn = None boxed_call = getattr output_code _boxed_call False _boxed_call = boxed_call _boxed_call Was boxed now unboxed args = args len args Was unboxed now boxed args = args _boxed_call = boxed_call args override post_compile example_inputs Sequence InputType constants CompiledFxGraphConstants graph_kwargs _CompileFxKwargs - None _eager_fn None _post_compile_data = _PostCompileData example_inputs constants graph_kwargs assert _output_code None _output_code post_compile example_inputs constants graph_kwargs Given FxCompile out-of-process compile _AsyncFxCompile will run eager until compiled artifact ready then will automatically switch over using compiled version final _AsyncFxCompile FxCompile _compile _OutOfProcessFxCompile Some debugging stats Number times we started background compile _stat_bg_started int = Number times we finished background compile _stat_bg_finished int = Number times we ran eager _stat_eager_runs int = Number times we ran our compiled out-of-process artifact _stat_compiled_runs int = __init__ compile _OutOfProcessFxCompile - None _compile = compile classmethod _reset_stats cls - None cls _stat_bg_started = cls _stat_bg_finished = cls _stat_eager_runs = cls _stat_compiled_runs = override codegen_and_compile gm GraphModule example_inputs Sequence InputType inputs_to_check Sequence int graph_kwargs _CompileFxKwargs - OutputCode eager_output_code = _InProcessFxCompile codegen_and_compile gm example_inputs inputs_to_check graph_kwargs This similar _SerializedFxCompile codegen_and_compile handles async routing serialized = _compile serialize_compile gm example_inputs inputs_to_check graph_kwargs serialized We can t serialize - just eager OutputCode eager_output_code inputs constants = serialized _AsyncFxCompile _stat_bg_started += f = _compile _send_to_child_async inputs This called _switch_to_compiled_fn when f has result callback pickled_output _WireProtocolPickledOutput - OutputCode _AsyncFxCompile _stat_bg_finished += output = pickled_output deserialize constants _compile _postprocess output output graph _AsyncOutputCode eager_output_code f callback _ProgressiveOutputCode handles running fast compile first then hot-swapping more optimized version when expensive compile finishes final _ProgressiveOutputCode OutputCode _fast_output_code Optional OutputCode _optimized_output_code Optional OutputCode _compilation_state Optional ProgressiveCompilationState _boxed_call state effectively cached we sometimes wrap unboxed w lambdas box them so we can t change mid-way Since _boxed_call=True more common let s default we ll convert necessary _boxed_call bool = True __init__ Fast compile runs faster than progressive compiles fast_output_code OutputCode Futures progressive optimized compiles progression_futures Sequence Future _WireProtocolPickledOutput Callback convert optimized result OutputCode callback Callable _WireProtocolPickledOutput OutputCode - None _fast_output_code = fast_output_code _optimized_output_code = None _compilation_state = ProgressiveCompilationState progression_futures=deque progression_futures callback=callback post_compile_data=None override __call__ args Sequence Any - Any Check any newer progression stage ready switch _check_and_switch_progression _optimized_output_code None _ProgressiveFxCompile _stat_optimized_runs += output_code = _optimized_output_code _ProgressiveFxCompile _stat_fast_runs += assert _fast_output_code None output_code = _fast_output_code boxed_call = getattr output_code _boxed_call False boxed_call res = output_code __call__ args res = output_code __call__ args res _check_and_switch_progression - None _compilation_state stage_index = _compilation_state check_and_get_ready_stage stage_index == - no futures ready _switch_to_progression_stage stage_index _switch_to_progression_stage stage_index int - None assert _compilation_state None optimized_output_code should_clear_state = _compilation_state switch_to_progression_stage stage_index _optimized_output_code = optimized_output_code _fast_output_code = None Clear all compilation state no more progression futures left should_clear_state _compilation_state = None override post_compile example_inputs Sequence InputType constants CompiledFxGraphConstants graph_kwargs _CompileFxKwargs - None assert _fast_output_code None _fast_output_code post_compile example_inputs constants graph_kwargs assert _compilation_state None Store later when optimized version ready _compilation_state post_compile_data = _PostCompileData example_inputs constants graph_kwargs _ProgressiveFxCompile runs fast compile immediately then kicks off progressive compiles background hot-swaps when they re ready final _ProgressiveFxCompile FxCompile _fast_compile FxCompile _optimized_compile _OutOfProcessFxCompile _progression_configs list dict str Any Debugging stats _stat_bg_started int = _stat_bg_finished int = _stat_fast_runs int = _stat_optimized_runs int = __init__ fast_compile FxCompile optimized_compile _OutOfProcessFxCompile progression_configs list dict str Any - None _fast_compile = fast_compile _optimized_compile = optimized_compile _progression_configs = progression_configs classmethod _reset_stats cls - None cls _stat_bg_started = cls _stat_bg_finished = cls _stat_fast_runs = cls _stat_optimized_runs = override codegen_and_compile gm GraphModule example_inputs Sequence InputType inputs_to_check Sequence int graph_kwargs _CompileFxKwargs - OutputCode torch _inductor config inductor_config progression_futures list Future _WireProtocolPickledOutput = config _progression_configs inductor_config patch config _ProgressiveFxCompile _stat_bg_started += Start progressive compiles background serialized = _optimized_compile serialize_compile gm example_inputs inputs_to_check graph_kwargs serialized continue inputs constants = serialized future = _optimized_compile _send_to_child_async inputs progression_futures append future fast_output_code = _fast_compile codegen_and_compile gm example_inputs inputs_to_check graph_kwargs progression_futures All async compile attempts failed - just fast version fast_output_code Callback handle optimized result This callback may called multiple times once each progressive level completed may skipped level either never completes more optimal level completes before less optimal one switched callback pickled_output _WireProtocolPickledOutput - OutputCode _ProgressiveFxCompile _stat_bg_finished += output = pickled_output deserialize constants _optimized_compile _postprocess output output graph _ProgressiveOutputCode fast_output_code progression_futures callback
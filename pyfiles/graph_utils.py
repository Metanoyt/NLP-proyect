collections deque typing Any Optional torch torch fx Graph map_arg Node torch utils _ordered_set OrderedSet torch utils _pytree tree_flatten flattens support slices Note better way do would register unregister slices pytree nodes there no unregister API pytorch pytree impl _get_flat_args node Node node_to_additional_deps dict Node OrderedSet Node - list Node args = list Any map_arg node args node kwargs args append node node_to_additional_deps args extend node_to_additional_deps node args _get_flat_args_unique node Node node_to_additional_deps dict Node OrderedSet Node - OrderedSet Node args = OrderedSet Node map_arg node args node kwargs args add node node_to_additional_deps args update node_to_additional_deps node args _detect_cycles graph Graph node_to_additional_deps dict Node OrderedSet Node - str current_path deque Node = deque current_path_set set Node = set pending deque tuple Node Node = deque add_to_current_path node Node - None current_path append node current_path_set add node pop_current_path - None node = current_path pop current_path_set remove node current_path_head - Node current_path - origin graph find_nodes op= output current_path clear current_path_set clear add_to_current_path origin child _get_flat_args_unique origin node_to_additional_deps pending append child origin while pending cur_node parent = pending pop handle backtracking while current_path current_path_head = parent pop_current_path isinstance cur_node Node continue cur_node current_path_set current_path append cur_node f cycle detected path current_path add_to_current_path cur_node child _get_flat_args_unique cur_node node_to_additional_deps pending append child cur_node no cycle detected _graph_device_type graph Optional Graph - str graph None cpu _device_type x Any - str isinstance x torch device x type isinstance x torch Tensor x device type cpu _flatten_meta node Node key str - list Any key node meta flat _ = tree_flatten node meta key flat node graph nodes key val example_value obj _flatten_meta node key _device_type obj Check device conversions node op == call_method gpu cuda xpu node target == gpu gpu node target == gpu node args gpu Check args kwargs non-CPU device specs flat_args _ = tree_flatten node args node kwargs obj flat_args _device_type obj cpu
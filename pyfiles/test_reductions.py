Owner s module dynamo unittest skipIf SkipTest numpy pytest pytest raises assert_raises torch testing _internal common_utils instantiate_parametrized_tests parametrize run_tests TEST_WITH_TORCHDYNAMO TestCase xpassIfTorchDynamo_np If we going trace through these we should use NumPy If testing eager mode we use torch _numpy TEST_WITH_TORCHDYNAMO numpy np numpy core numeric _util normalize_axis_tuple numpy testing assert_allclose assert_almost_equal assert_array_equal assert_equal torch _numpy np torch _numpy _util torch _numpy testing assert_allclose assert_almost_equal assert_array_equal assert_equal TestFlatnonzero TestCase test_basic x = np arange - assert_equal np flatnonzero x TestAny TestCase test_basic y = y = y = assert np any y assert np any y assert np any y test_nd y = assert np any y assert_equal np any y axis= assert_equal np any y axis= assert_equal np any y True assert isinstance np any y axis= np ndarray YYY deduplicate test_method_vs_function y = np array assert_equal np any y y any TestAll TestCase test_basic y = y = y = assert np all y assert np all y assert np all y assert np all ~np array y test_nd y = assert np all y assert_equal np all y axis= assert_equal np all y axis= assert_equal np all y False test_method_vs_function y = np array assert_equal np all y y all TestMean TestCase test_mean A = assert np mean A == assert np all np mean A == np array assert np all np mean A == np array XXX numpy emits warning empty slice assert np isnan np mean m = np asarray A assert np mean A == m mean test_mean_values rmat = np random random rmat = np arange dtype=float reshape cmat = rmat + j rmat warnings warnings catch_warnings warnings simplefilter error mat rmat cmat axis tgt = mat sum axis=axis res = np mean mat axis=axis mat shape axis assert_allclose res tgt axis None tgt = mat sum axis=axis res = np mean mat axis=axis mat size assert_allclose res tgt test_mean_float This fail sum inside mean done float instead float assert np mean np ones dtype= float == xpassIfTorchDynamo_np reason= XXX mean where= implemented test_mean_where = np arange reshape wh_full = np array False True False True True False True False True True False False False False True True wh_partial = np array False True True False _cases = True wh_full wh_full wh_partial _ax _wh _res _cases assert_allclose mean axis=_ax where=_wh np array _res assert_allclose np mean axis=_ax where=_wh np array _res d = np arange reshape _wh_partial = np array False True True False _res = assert_allclose d mean axis= where=_wh_partial np array _res assert_allclose np mean d axis= where=_wh_partial np array _res pytest warns RuntimeWarning assert_allclose mean axis= where=wh_partial np array np nan np nan pytest warns RuntimeWarning assert_equal mean where=False np nan pytest warns RuntimeWarning assert_equal np mean where=False np nan instantiate_parametrized_tests TestSum TestCase test_sum m = tgt = out = np sum m axis= keepdims=True assert_equal tgt out am = np asarray m assert_equal np sum m am sum test_sum_stability = np ones dtype=np float zero = np zeros dtype= float assert_allclose sum - size zero atol= e- = np ones dtype=np float assert_allclose sum - size atol= e- test_sum_boolean = np arange == res = sum assert_equal res res_float = sum dtype=np float assert_allclose res_float atol= e- assert res_float dtype == float skipIf numpy __version__ reason= NP_VER fails NumPy x xpassIfTorchDynamo_np reason= sum does warn overflow test_sum_dtypes_warnings dt int np float np float np float v warning sum overflows which does float warnings warnings catch_warnings record=True w warnings simplefilter always RuntimeWarning tgt = dt v v + overflow = np isfinite tgt assert_equal len w overflow d = np arange v + dtype=dt assert_almost_equal np sum d tgt assert_equal len w overflow assert_almost_equal np sum np flip d tgt assert_equal len w overflow test_sum_dtypes_ dt int np float np float np float d = np ones dtype=dt assert_almost_equal np sum d assert_almost_equal np sum d assert_almost_equal np sum d assert_almost_equal np sum d assert_almost_equal np sum np flip d assert_almost_equal np sum np flip d assert_almost_equal np sum np flip d assert_almost_equal np sum np flip d sum first reduction entry = d = np ones dtype=dt d += d assert_almost_equal d parametrize dt np complex np complex test_sum_complex_ dt v tgt = dt v v + - dt v v + j d = np empty v dtype=dt d real = np arange v + d imag = -np arange v + assert_allclose np sum d tgt atol= e- assert_allclose np sum np flip d tgt atol= e- parametrize dt np complex np complex test_sum_complex_ dt d = np ones dtype=dt + j assert_allclose np sum d + j atol= e- assert_allclose np sum d + j atol= e- assert_allclose np sum d + j atol= e- assert_allclose np sum d + j atol= e- assert_allclose np sum np flip d + j atol= e- assert_allclose np sum np flip d + j atol= e- assert_allclose np sum np flip d + j atol= e- assert_allclose np sum np flip d + j atol= e- sum first reduction entry = d = np ones dtype=dt + j d += d assert_allclose d + j atol= e- xpassIfTorchDynamo_np reason= initial= need implementing test_sum_initial Integer single axis assert_equal np sum initial= Floating point assert_almost_equal np sum initial= Multiple non-adjacent axes assert_equal np sum np ones dtype=np int axis= initial= xpassIfTorchDynamo_np reason= where= need implementing test_sum_where More extensive tests done test_reduction_with_where assert_equal np sum where= True False assert_equal np sum axis= initial= where= True False parametrize_axis = parametrize axis - - - parametrize_func = parametrize func np any np all np argmin np argmax np min np max np mean np sum np prod np std np var np count_nonzero fails_axes_tuples = np any np all np argmin np argmax np prod fails_out_arg = np count_nonzero restricts_dtype_casts = np var np std fails_empty_tuple = np argmin np argmax instantiate_parametrized_tests TestGenericReductions TestCase Run set generic tests verify func acts like reduction operation Specifically checks axis= keepdims= parameters To check out= parameter see _GenericHasOutTestMixin below To use subclass define func allowed_axes parametrize_func test_bad_axis func Basic check functionality m = np array assert_raises TypeError func m axis= foo assert_raises np AxisError func m axis= assert_raises TypeError func m axis=np array assert_raises TypeError func m axis= TODO add tests np int etc when implemented parametrize_func test_array_axis func = np array assert_equal func axis=np array - func axis=- assert_raises TypeError func axis=np array parametrize_func test_axis_empty_generic func func fails_empty_tuple raise SkipTest func axis= valid = np array assert_array_equal func axis= func np expand_dims axis= axis= parametrize_func test_axis_bad_tuple func Basic check functionality m = np array func fails_axes_tuples raise SkipTest f func __name__ does allow tuple axis assert_raises ValueError func m axis= parametrize_axis parametrize_func test_keepdims_generic axis func func fails_axes_tuples raise SkipTest f func __name__ does allow tuple axis = np arange reshape with_keepdims = func axis keepdims=True expanded = np expand_dims func axis=axis axis=axis assert_array_equal with_keepdims expanded skipIf numpy __version__ reason= NP_VER fails CI w old numpy parametrize_func test_keepdims_generic_axis_none func = np arange reshape with_keepdims = func axis=None keepdims=True scalar = func axis=None expanded = np full ndim fill_value=scalar assert_array_equal with_keepdims expanded parametrize_func test_out_scalar func out no axis scalar func fails_out_arg raise SkipTest f func __name__ does have out= arg = np arange reshape result = func out = np empty_like result result_with_out = func out=out assert result_with_out out assert_array_equal result result_with_out _check_out_axis axis dtype keepdims out axis = np arange reshape result = func axis=axis keepdims=keepdims astype dtype out = np empty_like result dtype=dtype result_with_out = func axis=axis keepdims=keepdims out=out assert result_with_out out assert result_with_out dtype == dtype assert_array_equal result result_with_out TODO what result dtype = out dtype does out typecast result out wrong shape any out does broadcast np any m out=np empty_like m raises ValueError wrong number dimensions pytorch any emits warning resizes out array Here we follow pytorch since result superset numpy functionality parametrize keepdims True False parametrize dtype bool int float parametrize_func parametrize_axis test_out_axis func axis dtype keepdims out axis func fails_out_arg raise SkipTest f func __name__ does have out= arg func fails_axes_tuples raise SkipTest f func __name__ does hangle tuple axis func restricts_dtype_casts raise SkipTest f func __name__ test implies float- int casts = np arange reshape result = func axis=axis keepdims=keepdims astype dtype out = np empty_like result dtype=dtype result_with_out = func axis=axis keepdims=keepdims out=out assert result_with_out out assert result_with_out dtype == dtype assert_array_equal result result_with_out TODO what result dtype = out dtype does out typecast result out wrong shape any out does broadcast np any m out=np empty_like m raises ValueError wrong number dimensions pytorch any emits warning resizes out array Here we follow pytorch since result superset numpy functionality parametrize_func parametrize_axis test_keepdims_out func axis func fails_out_arg raise SkipTest f func __name__ does have out= arg func fails_axes_tuples raise SkipTest f func __name__ does hangle tuple axis d = np ones axis None shape_out = d ndim axis_norm = _util normalize_axis_tuple axis d ndim shape_out = tuple i axis_norm d shape i i range d ndim out = np empty shape_out result = func d axis=axis keepdims=True out=out assert result out assert_equal result shape shape_out instantiate_parametrized_tests TestGenericCumSumProd TestCase Run set generic tests verify cumsum cumprod sane parametrize func np cumsum np cumprod test_bad_axis func Basic check functionality m = np array assert_raises TypeError func m axis= foo assert_raises np AxisError func m axis= assert_raises TypeError func m axis=np array assert_raises TypeError func m axis= TODO add tests np int etc when implemented parametrize func np cumsum np cumprod test_array_axis func = np array assert_equal func axis=np array - func axis=- assert_raises TypeError func axis=np array parametrize func np cumsum np cumprod test_axis_empty_generic func = np array assert_array_equal func axis=None func ravel axis= parametrize func np cumsum np cumprod test_axis_bad_tuple func Basic check functionality m = np array assert_raises TypeError func m axis= __name__ == __main__ run_tests
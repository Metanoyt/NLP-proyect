Owner s module inductor torch torch _inductor codegen aoti_hipify_utils maybe_hipify_code_wrapper torch _inductor codegen common get_device_op_overrides torch _inductor test_case run_tests TestCase TEST_CODES = CUresult code = EXPR CUfunction kernel = nullptr static CUfunction kernel = nullptr CUdeviceptr var = reinterpret_cast CUdeviceptr arg data_ptr cuda CUDAStreamGuard guard cuda getStreamFromExternal Hipification should idempotent hipifying should no-op already hipified files hip HIPStreamGuardMasqueradingAsCUDA guard hip getStreamFromExternalMasqueradingAsCUDA HIP_CODES = hipError_t code = EXPR hipFunction_t kernel = nullptr static hipFunction_t kernel = nullptr hipDeviceptr_t var = reinterpret_cast hipDeviceptr_t arg data_ptr hip HIPStreamGuardMasqueradingAsCUDA guard hip getStreamFromExternalMasqueradingAsCUDA hip HIPStreamGuardMasqueradingAsCUDA guard hip getStreamFromExternalMasqueradingAsCUDA TestCppWrapperHipify TestCase test_hipify_basic_declaration - None assert len TEST_CODES == len HIP_CODES i range len TEST_CODES result = maybe_hipify_code_wrapper TEST_CODES i True expected = HIP_CODES i assertEqual result expected test_hipify_aoti_driver_header - None cuda_codegen = get_device_op_overrides cuda header = cuda_codegen kernel_driver expected = #define CUDA_DRIVER_CHECK EXPR \\ do \\ hipError_t code = EXPR \\ const char msg \\ hipError_t code_get_error = hipDrvGetErrorString code msg \\ code_get_error = hipSuccess \\ throw std runtime_error \\ std string CUDA driver error + \\ std string invalid error code \\ \\ code = hipSuccess \\ throw std runtime_error \\ std string CUDA driver error + \\ std string msg \\ \\ while static inline hipFunction_t loadKernel std string filePath const std string funcName uint _t sharedMemBytes const std optional std string cubinDir = std nullopt cubinDir std filesystem path p cubinDir std filesystem path p filePath filePath = p p filename string hipModule_t mod hipFunction_t func CUDA_DRIVER_CHECK hipModuleLoad mod filePath c_str CUDA_DRIVER_CHECK hipModuleGetFunction func mod funcName c_str sharedMemBytes CUDA_DRIVER_CHECK hipFuncSetAttribute func hipFuncAttributeMaxDynamicSharedMemorySize sharedMemBytes func static inline hipFunction_t loadKernel const void start const std string funcName uint _t sharedMemBytes hipModule_t mod hipFunction_t func CUDA_DRIVER_CHECK hipModuleLoadData mod start CUDA_DRIVER_CHECK hipModuleGetFunction func mod funcName c_str sharedMemBytes CUDA_DRIVER_CHECK hipFuncSetAttribute func hipFuncAttributeMaxDynamicSharedMemorySize sharedMemBytes func static inline void launchKernel hipFunction_t func uint _t gridX uint _t gridY uint _t gridZ uint _t numWarps uint _t sharedMemBytes void args hipStream_t stream CUDA_DRIVER_CHECK hipModuleLaunchKernel func gridX gridY gridZ numWarps sharedMemBytes stream args nullptr torch version hip None Adjusting warp size GPU supported wavefront size AMD GPU prop = torch cuda get_device_properties torch cuda current_device expected = expected replace numWarps str prop warp_size + numWarps result = maybe_hipify_code_wrapper header True assertEqual result rstrip expected rstrip test_hipify_cross_platform - None assert len TEST_CODES == len HIP_CODES i range len TEST_CODES hip_result = maybe_hipify_code_wrapper TEST_CODES i True result = maybe_hipify_code_wrapper TEST_CODES i torch version hip None assertEqual result hip_result assertEqual result TEST_CODES i __name__ == __main__ run_tests
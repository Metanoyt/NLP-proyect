mypy ignore-errors __future__ annotations contextlib dataclasses sys threading typing Any Callable Optional TYPE_CHECKING typing_extensions override Self unittest mock patch torch _inductor config torch _inductor remote_cache RemoteCacheBackend TYPE_CHECKING types TracebackType dataclasses dataclass Stats num_put int = num_get_hit int = num_get_miss int = __iadd__ other Stats - Self num_put += other num_put num_get_hit += other num_get_hit num_get_miss += other num_get_miss reset - None num_put = num_get_hit = num_get_miss = __str__ - str join f puts num_put f misses num_get_miss f hits num_get_hit __eq__ other object - bool Dataclass s default __eq__ checks types same so can t used _GlobalItemStats isinstance other Stats _GlobalItemStats num_put == other num_put num_get_hit == other num_get_hit num_get_miss == other num_get_miss _GlobalItemStats Stats cache dict str object __init__ - None super __init__ cache = reset - None super reset cache = The cache states thread-local so we re running multiple tests once they won t cross contaminate However - needs global because we allow code create new cache clients which refer same cache because s remote cache _GlobalStats threading local __init__ - None autotune_local = _GlobalItemStats autotune_remote = _GlobalItemStats bundled_autotune = _GlobalItemStats fx_graph = _GlobalItemStats triton = _GlobalItemStats aot_autograd = _GlobalItemStats dynamo_pgo = _GlobalItemStats reset - None autotune_local reset autotune_remote reset bundled_autotune reset fx_graph reset triton reset aot_autograd reset dynamo_pgo reset get_stat name str - _GlobalItemStats getattr name report subs = autotune_local autotune_local autotune_remote autotune_remote bundled_autotune bundled_autotune fx_graph fx_graph triton triton aot_autograd aot_autograd dynamo_pgo dynamo_pgo print Cache Stats file=sys stderr name sub subs print f name sub file=sys stderr print Cache Entries file=sys stderr name sub subs sub cache print f name file=sys stderr k v sorted sub cache items v = repr v len v v = v + print f k r v file=sys stderr global_stats = _GlobalStats MockBackend RemoteCacheBackend Any __init__ name str - None _name = name staticmethod with_name name str - Callable MockBackend wrapper - MockBackend MockBackend name wrapper override _get key str - Optional Any stat = global_stats get_stat _name key stat cache stat += Stats num_get_hit= stat cache get key stat += Stats num_get_miss= None override _put key str data Any - None stat = global_stats get_stat _name stat += Stats num_put= stat cache key = data List configs each cache _CACHE_CONFIG_EN = fx_graph_cache fx_graph_remote_cache autotune_local_cache autotune_remote_cache bundled_autotune_remote_cache PatchCaches contextlib AbstractContextManager classmethod setUp cls If test using PatchCaches then disable all caches default letting tests turn them explicitly This because tests using PatchCaches will often want check stats explicitly cls _savedCacheState = name _CACHE_CONFIG_EN hasattr config name cls _savedCacheState name = getattr config name setattr config name False classmethod tearDown cls Restore cache defaults name _CACHE_CONFIG_EN delattr config name name cls _savedCacheState setattr config name cls _savedCacheState name __init__ - None _stack = contextlib ExitStack __enter__ - Self global_stats reset _stack __enter__ ctx = patch torch _inductor runtime autotune_cache LocalAutotuneCache backend_override_cls MockBackend with_name autotune_local _stack enter_context ctx ctx = patch torch _inductor remote_cache RemoteAutotuneCache backend_override_cls MockBackend with_name autotune_remote _stack enter_context ctx ctx = patch torch _inductor remote_cache RemoteBundledAutotuneCache backend_override_cls MockBackend with_name bundled_autotune _stack enter_context ctx ctx = patch torch _inductor remote_cache RemoteFxGraphCache backend_override_cls MockBackend with_name fx_graph _stack enter_context ctx ctx = patch torch _inductor remote_cache RemoteAOTAutogradCache backend_override_cls MockBackend with_name aot_autograd _stack enter_context ctx ctx = patch torch _inductor remote_cache RemoteDynamoPGOCache backend_override_cls MockBackend with_name dynamo_pgo _stack enter_context ctx config is_fbcode ctx = patch torch _inductor fb remote_cache FbRemoteAutotuneCache backend_override_cls MockBackend with_name autotune_remote _stack enter_context ctx ctx = patch torch _inductor fb remote_cache FbRemoteBundledAutotuneCache backend_override_cls MockBackend with_name bundled_autotune _stack enter_context ctx ctx = patch torch _inductor fb remote_cache FbRemoteFxGraphCache backend_override_cls MockBackend with_name fx_graph _stack enter_context ctx ctx = patch triton fb fb_memcache FbMemcacheRemoteKernelCache backend_override_cls MockBackend with_name triton _stack enter_context ctx ctx = patch torch _inductor fb remote_cache FbRemoteAOTAutogradCache backend_override_cls MockBackend with_name aot_autograd _stack enter_context ctx ctx = patch torch _inductor fb remote_cache FbRemoteDynamoPGOCache backend_override_cls MockBackend with_name dynamo_pgo _stack enter_context ctx __exit__ exc_type Optional type BaseException exc_value Optional BaseException traceback Optional TracebackType - None _stack __exit__ exc_type exc_value traceback
mypy allow-untyped-defs try halide hl type ignore import-untyped import-not-found except ImportError hl = None PHILOX_N_ROUNDS_DEFAULT = Default number rounds philox hl None PHILOX_KEY_A_U = hl u x E B PHILOX_KEY_B_U = hl u xBB AE PHILOX_ROUND_A_U = hl u xD F PHILOX_ROUND_B_U = hl u xCD E D PHILOX_KEY_A_U = None PHILOX_KEY_B_U = None PHILOX_ROUND_A_U = None PHILOX_ROUND_B_U = None _pair_uniform_to_normal u u Box-Muller transform u = hl max hl f e- u th = hl f u r = hl sqrt hl f - hl log u r hl cos th r hl sin th _uint_to_uniform_float x Numerically stable function convert random uint into random float uniformly sampled TODO conditions can simplified scale - N_BITS - https github com triton-lang triton blob e d ff c d eeebbcd ed e b f python triton language random py#L -L assert x type == hl UInt x type == hl Int x = hl cast hl Int x scale = hl f e- x = hl select x -x - x x scale philox_impl c c c c k k n_rounds umulhi b = hl cast hl UInt b = hl cast hl UInt b hl cast hl UInt b hl u xFFFFFFFF _ range n_rounds _c _c = c c c = umulhi PHILOX_ROUND_B_U _c ^ c ^ k c = umulhi PHILOX_ROUND_A_U _c ^ c ^ k c = PHILOX_ROUND_B_U _c c = PHILOX_ROUND_A_U _c raise key k = k + PHILOX_KEY_A_U k = k + PHILOX_KEY_B_U c c c c halide_philox seed c c c c n_rounds seed = hl cast hl UInt seed assert c type bits == seed_hi = hl cast hl UInt seed hl u xFFFFFFFF seed_lo = hl cast hl UInt seed hl u xFFFFFFFF philox_impl c c c c seed_lo seed_hi n_rounds randint x seed offset n_rounds offset = hl cast hl UInt offset _ = hl u halide_philox seed offset _ _ _ n_rounds rand x seed offset n_rounds=PHILOX_N_ROUNDS_DEFAULT i i i i = randint x seed offset n_rounds u = _uint_to_uniform_float i u = _uint_to_uniform_float i u = _uint_to_uniform_float i u = _uint_to_uniform_float i u u u u randint seed offset n_rounds=PHILOX_N_ROUNDS_DEFAULT ret _ _ _ = randint x seed offset n_rounds ret rand seed offset n_rounds=PHILOX_N_ROUNDS_DEFAULT source = randint seed offset n_rounds _uint_to_uniform_float source randn seed offset i i _ _ = randint x seed offset PHILOX_N_ROUNDS_DEFAULT u = _uint_to_uniform_float i u = _uint_to_uniform_float i n _ = _pair_uniform_to_normal u u n randint seed offset low high r r _r _r = randint x seed offset PHILOX_N_ROUNDS_DEFAULT r = hl cast hl UInt r r = hl cast hl UInt r result = r &#124; r size = high - low result = result hl cast hl UInt size result = hl cast hl Int result + low result
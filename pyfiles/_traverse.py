Copyright c Meta Platforms Inc affiliates collections abc Callable Collection Mapping MutableMapping typing cast Optional TypeVar Union torch torch distributed _shard sharded_tensor api ShardedTensor torch distributed checkpoint metadata STATE_DICT_TYPE torch distributed tensor DTensor PATH_ITEM = Union str int OBJ_PATH = tuple PATH_ITEM T = TypeVar T STATE_DICT_ITEM = object CONTAINER_TYPE = MutableMapping PATH_ITEM STATE_DICT_ITEM __all__ = traverse_state_dict set_element get_element print_tensor _keep_visiting_tensors value STATE_DICT_ITEM - bool isinstance value torch Tensor TODO update docstring traverse py traverse_state_dict state_dict STATE_DICT_TYPE visitor Callable OBJ_PATH STATE_DICT_ITEM None keep_traversing Callable STATE_DICT_ITEM bool = _keep_visiting_tensors - None Invoke ` ` visitor ` ` each value recursively ` ` state_dict ` ` Mapping will traversed ` ` visitor ` ` will applied leaf elements ` ` visitor ` ` will only applied elements list tuple container contains tensors mappings _is_terminal value STATE_DICT_ITEM - bool values Collection STATE_DICT_ITEM isinstance value Mapping False isinstance value list values = value True entry values isinstance entry Mapping list _is_terminal entry False keep_traversing None keep_traversing entry False True _traverse_obj path OBJ_PATH value STATE_DICT_ITEM - None isinstance value Mapping k v value items _traverse_obj path + str k v _is_terminal value visitor path value isinstance value list tuple i v enumerate value _traverse_obj path + i v key value state_dict items _traverse_obj str key value traverse_state_dict_v_ _ state_dict STATE_DICT_TYPE visitor Callable OBJ_PATH STATE_DICT_ITEM None keep_traversing Callable STATE_DICT_ITEM bool = _keep_visiting_tensors - None Traversal short-circuited when finds collection which ` ` keep_visiting_tensors ` ` evaluates false all elements By default all collections least one ` ` torch Tensor ` ` element traversed Visitor takes path argument tuple keys used reach value terminal has no other containers values inside _is_terminal value STATE_DICT_ITEM - bool values Collection STATE_DICT_ITEM isinstance value Mapping values = value values isinstance value list values = value True entry values isinstance entry Mapping list _is_terminal entry False keep_traversing None keep_traversing entry False True _traverse_obj path OBJ_PATH value STATE_DICT_ITEM - None _is_terminal value visitor path value isinstance value Mapping k v value items _traverse_obj path + str k v isinstance value list i v enumerate value _traverse_obj path + i v key value state_dict items _traverse_obj str key value set_element root_dict STATE_DICT_TYPE path OBJ_PATH value STATE_DICT_ITEM - None Set ` ` value ` ` ` ` root_dict ` ` along ` ` path ` ` object path cur_container = cast CONTAINER_TYPE root_dict extend_list lst list STATE_DICT_ITEM idx int - None while len lst = idx lst append None i range len path prev_key = path i - key = path i def_val = cast STATE_DICT_ITEM type key str isinstance cur_container Mapping cur_container = cast CONTAINER_TYPE cur_container setdefault prev_key def_val pyrefly ignore bad-argument-type extend_list cur_container prev_key cur_container prev_key None cur_container prev_key = def_val cur_container = cur_container prev_key key = path - type key int extend_list cast list STATE_DICT_ITEM cur_container key cur_container key = value get_element root_dict STATE_DICT_TYPE path OBJ_PATH default_value Optional T = None - Optional T Retrieve value ` ` path ` ` ` ` root_dict ` ` returning ` ` default_value ` ` found cur_value = cast CONTAINER_TYPE root_dict part path type part int isinstance cur_value list len cur_value part default_value isinstance cur_value Mapping part cur_value default_value pyrefly ignore index-error cur_value = cast CONTAINER_TYPE cur_value part cast Optional T cur_value _print_nested value STATE_DICT_ITEM prefix str = print_fun Callable str None = print - None type value ShardedTensor print_fun f prefix ShardedTensor size value size shard value local_shards _print_nested shard tensor f shard metadata shard_offsets print_fun=print_fun type value DTensor print_fun f prefix DistributedTensor size value size TODO add local offset _local_tensor print_nested _print_nested value _local_tensor print_fun=print_fun isinstance value torch Tensor print_fun f prefix Tensor size value size print_fun f prefix Type type value print_tensor path OBJ_PATH value STATE_DICT_ITEM print_fun Callable str None = print - None Use callback traverse_state_dict print its content By default content printed using builtin ` ` print ` ` can change passing different ` ` print_fun ` callable _print_nested value prefix=str path print_fun=print_fun
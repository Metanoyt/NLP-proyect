mypy allow-untyped-defs re torch _C C PythonDispatcher thin python-binding C++ dispatcher designed show how dispatcher precompute works In particular shows certain op ` foo ` what computed dispatch table looks like after user register their kernels certains dispatch keys In real C++ dispatcher we support many dispatch keys different functionalities For simplicity PythonDispatcher only supports dispatch keys single example each use case These use cases listed below - CPU AutogradCPU represents in-tree backends which we usually have dedicated inference autograd kernel pytorch core library E g CPU CUDA - FPGA AutogradOther represents in-tree backends which we usually have backend specific inference kernels they share same autograd kernel specified AutogradOther E g FPGA SparseCsrCPU - XLA AutogradXLA represents out-of-tree backends which we don t have either inference autograd kernel defined pytorch core library Backend owner responsible registering both inference autograd kernels their extensions e g torch-xla operators they support E g XLA XPU MPS - CompositeExplicitAutograd alias key mapped inference kernels all backends like CPU CUDA XLA etc Kernels registered key MUST work inference all backends - Autograd alias key mapped autograd all backends like AutogradCPU AutogradXLA AutogradOther Kernels registered key MUST work autograd all backends - CompositeImplicitAutograd alias key CompositeImplicitAutograd = CompositeExplicitAutograd + Autograd Kernels registered key MUST work both inference + autograd all backends Note we only allow registrations alias keys inside pytorch core library E g you shouldn t register CompositeImplicitAutograd CompositeExplicitAutograd kernel torch-xla extension instead you should upstream kernel into pytorch pytorch repo so s available all backends continuously tested even without extension Usage dispatcher = PythonDispatcher dispatcher register CPU XLA CompositeImplicitAutograd print dispatcher dispatchTable This tells you exactly which kernel used certain backend For more debugging information print dispatcher keys print dispatcher registrations print dispatcher rawRegistrations print dispatcher rawDispatchTable PythonDispatcher calls C++ dispatcher under hood precompute dispatch table This file only provides simplified API developers relevant test code located test test_dispatch py PythonDispatcher namespace = __test__ name = foo fmt off runtime_keys = CPU AutogradCPU FPGA AutogradOther XLA AutogradXLA Lazy AutogradLazy fmt alias_keys = CompositeExplicitAutograd Autograd CompositeImplicitAutograd supported_keys = runtime_keys + alias_keys __init__ - None C _dispatch_check_invariants name type ignore attr-defined ref = C _dispatch_library FRAGMENT namespace ref def_ foo Tensor x - Tensor Returns list dispatch keys supported PythonDispatcher You can register kernels these keys keys supported_keys Register kernels target dispatchKeys dispatchKeys list str list dispatch keys you want register your own kernel Note you don t need write kernel yourself PythonDispatcher E g CPU key kernel e g fn_CPU CPU automatically generated registered register dispatchKeys Overridden supported triggers warning C++ dispatcher len set dispatchKeys = len dispatchKeys raise RuntimeError f Overridden allowed found duplicates dispatchKeys We currently forbid codegen instead C++ dispatcher CompositeImplicitAutograd dispatchKeys CompositeExplicitAutograd dispatchKeys raise RuntimeError Registration both CompositeImplicitAutograd CompositeExplicitAutograd allowed key dispatchKeys key supported_keys raise RuntimeError f key supported please select dispatch key supported_keys ref impl_t_t foo dispatch=key debug= fn_ + key Helper function format key kernel _format_line key kernel f key kernel \n Helper function print table header _format_header header s = f header s += _format_line key kernel s += --------------------------- \n s Returns raw output all registration info debugging only Use registrations simplified version rawRegistrations C _dispatch_dump f namespace name type ignore attr-defined Returns raw output computed dispatch table debugging only Use dispatchTable simplified version rawDispatchTable C _dispatch_dump_table f namespace name type ignore attr-defined Returns table str including all registrations users Note includes registrations both runtime keys alias keys registrations output = _format_header Registered Kernels state = rawRegistrations state_entries = state split \n line state_entries first = line split any first startswith k k supported_keys kernel = line split split output += _format_line first kernel output Returns computed dispatch table str Note only include runtime keys registrations alias keys have been decoded their mapped runtime keys dispatchTable output = _format_header Computed Dispatch Table table = rawDispatchTable table_entries = table split \n regex = re compile r registered FallbackKernel\ cpp \ line table_entries k = line split k runtime_keys entry = regex sub line output += _format_line k entry split output
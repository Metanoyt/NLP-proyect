inspect itertools sys time click torch torch set_num_threads torch _C _debug_set_fusion_group_inlining False rand shape torch rand shape mul add ------------------------------------------------------------------------------ Shape test cases ------------------------------------------------------------------------------ scalar rand rand small rand rand small_ d rand rand small_broadcast rand rand medium rand rand medium_sliced rand rand medium_transpose rand transpose - - rand transpose - - medium rand rand medium d rand rand medium_channels_last rand memory_format=torch channels_last rand memory_format=torch channels_last medium_broadcast rand rand medium_broadcast_channels_last rand memory_format=torch channels_last rand large rand rand large_transpose rand transpose rand transpose large_channels_last rand memory_format=torch channels_last rand memory_format=torch channels_last broadcast_narrow_ rand rand large_broadcast_ rand rand ------------------------------------------------------------------------------ Operator test cases ------------------------------------------------------------------------------ add b + b sub b - b mul b b div b b relu relu sigmoid sigmoid tanh tanh log log exp exp square fma b b + b mul_mul_add_ b c b + c hardswish_int + clamp hardswish + clamp native_hardswish torch _C _nn hardswish softplus exp log p mish exp log p tanh SHAPES = scalar small small_ d small_broadcast medium medium medium d medium_sliced medium_transpose medium_channels_last medium_broadcast medium_broadcast_channels_last large large_transpose large_channels_last broadcast_narrow_ large_broadcast_ OPERATORS = add sub mul div relu sigmoid tanh log exp square fma mul_mul_add_ hardswish_int hardswish native_hardswish softplus mish time_cpu fn args iters s = time perf_counter _ range iters fn args e = time perf_counter e - s time_cuda fn args iters start = torch cuda Event enable_timing=True end = torch cuda Event enable_timing=True start record _ range iters fn args end record torch cuda synchronize start elapsed_time end e benchmark_with_timer fn args timer timer fn args calibration = timer fn args iters = int calibration timer fn args iters iters benchmark fn args timer = time_cpu args device type == cpu time_cuda benchmark_with_timer fn args timer micros s f s e f with_nvfuser torch _C _jit_override_can_fuse_on_cpu False torch _C _jit_override_can_fuse_on_gpu False torch _C _jit_set_texpr_fuser_enabled False torch _C _jit_set_nvfuser_enabled True torch _C _jit_set_profiling_executor True torch _C _jit_set_profiling_mode True with_nnc torch _C _jit_override_can_fuse_on_cpu True torch _C _jit_override_can_fuse_on_gpu True torch _C _jit_set_texpr_fuser_enabled True torch _C _jit_set_nvfuser_enabled False torch _C _jit_set_profiling_executor True torch _C _jit_set_profiling_mode True with_legacy torch _C _jit_override_can_fuse_on_cpu True torch _C _jit_override_can_fuse_on_gpu True torch _C _jit_set_texpr_fuser_enabled False torch _C _jit_set_nvfuser_enabled False torch _C _jit_set_profiling_executor False torch _C _jit_set_profiling_mode False click command click option -- operators default=None click option -- shapes default=None run_benchmarks operators shapes operators None operators = OPERATORS operators = globals k k operators split shapes None shapes = SHAPES shapes = globals k k shapes split print fuser device operator shape time shape operator itertools product shapes operators nargs = len inspect signature operator parameters args = shape nargs len args args = list args args += args - nargs - len args args = args nargs args = arg cuda arg args result = benchmark operator args print join eager args device type operator __name__ shape __name__ micros result bench name nnc_op = torch jit trace operator args result = benchmark nnc_op args print join name args device type operator __name__ shape __name__ micros result sys stdout flush with_nnc bench nnc with_nvfuser bench nvfuser with_legacy bench legacy __name__ == __main__ run_benchmarks
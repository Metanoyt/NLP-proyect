mypy allow-untyped-defs typing Optional torch torch Tensor torch distributions Categorical constraints torch distributions constraints MixtureSameFamilyConstraint torch distributions distribution Distribution __all__ = MixtureSameFamily MixtureSameFamily Distribution r The ` MixtureSameFamily ` distribution implements batch mixture distribution where all component different parameterizations same distribution type It parameterized ` Categorical ` selecting distribution over ` k ` component component distribution i e ` Distribution ` rightmost batch shape equal ` k ` which indexes each batch component Examples xdoctest +SKIP undefined vars Construct Gaussian Mixture Model D consisting equally weighted normal distributions mix = D Categorical torch ones comp = D Normal torch randn torch rand gmm = MixtureSameFamily mix comp Construct Gaussian Mixture Model D consisting equally weighted bivariate normal distributions mix = D Categorical torch ones comp = D Independent D Normal torch randn torch rand gmm = MixtureSameFamily mix comp Construct batch Gaussian Mixture Models D each consisting random weighted bivariate normal distributions mix = D Categorical torch rand comp = D Independent D Normal torch randn torch rand gmm = MixtureSameFamily mix comp Args mixture_distribution ` torch distributions Categorical ` -like instance Manages probability selecting component The number categories must match rightmost batch dimension ` component_distribution ` Must have either scalar ` batch_shape ` ` batch_shape ` matching ` component_distribution batch_shape - ` component_distribution ` torch distributions Distribution ` -like instance Right-most batch dimension indexes component arg_constraints dict str constraints Constraint = has_rsample = False __init__ mixture_distribution Categorical component_distribution Distribution validate_args Optional bool = None - None _mixture_distribution = mixture_distribution _component_distribution = component_distribution isinstance _mixture_distribution Categorical raise ValueError The Mixture distribution needs instance torch distributions Categorical isinstance _component_distribution Distribution raise ValueError The Component distribution need instance torch distributions Distribution Check batch size matches mdbs = _mixture_distribution batch_shape cdbs = _component_distribution batch_shape - size size zip reversed mdbs reversed cdbs size = size = size = size raise ValueError f ` mixture_distribution batch_shape ` mdbs compatible ` component_distribution f batch_shape ` cdbs Check number mixture component matches km = _mixture_distribution logits shape - kc = _component_distribution batch_shape - km None kc None km = kc raise ValueError f ` mixture_distribution component ` km does equal ` component_distribution batch_shape - ` f kc _num_component = km event_shape = _component_distribution event_shape _event_ndims = len event_shape super __init__ batch_shape=cdbs event_shape=event_shape validate_args=validate_args expand batch_shape _instance=None batch_shape = torch Size batch_shape batch_shape_comp = batch_shape + _num_component new = _get_checked_instance MixtureSameFamily _instance new _component_distribution = _component_distribution expand batch_shape_comp new _mixture_distribution = _mixture_distribution expand batch_shape new _num_component = _num_component new _event_ndims = _event_ndims event_shape = new _component_distribution event_shape super MixtureSameFamily new __init__ batch_shape=batch_shape event_shape=event_shape validate_args=False new _validate_args = _validate_args new constraints dependent_property pyrefly ignore bad-override support MixtureSameFamilyConstraint _component_distribution support property mixture_distribution - Categorical _mixture_distribution property component_distribution - Distribution _component_distribution property mean - Tensor probs = _pad_mixture_dimensions mixture_distribution probs torch sum probs component_distribution mean dim=- - _event_ndims B E property variance - Tensor Law total variance Var Y = E Var Y &#124; X + Var E Y &#124; X probs = _pad_mixture_dimensions mixture_distribution probs mean_cond_var = torch sum probs component_distribution variance dim=- - _event_ndims var_cond_mean = torch sum probs component_distribution mean - _pad mean pow dim=- - _event_ndims mean_cond_var + var_cond_mean cdf x x = _pad x cdf_x = component_distribution cdf x mix_prob = mixture_distribution probs torch sum cdf_x mix_prob dim=- log_prob x _validate_args _validate_sample x x = _pad x log_prob_x = component_distribution log_prob x S B k log_mix_prob = torch log_softmax mixture_distribution logits dim=- B k torch logsumexp log_prob_x + log_mix_prob dim=- S B sample sample_shape=torch Size torch no_grad sample_len = len sample_shape batch_len = len batch_shape gather_dim = sample_len + batch_len es = event_shape mixture samples n B mix_sample = mixture_distribution sample sample_shape mix_shape = mix_sample shape component samples n B k E comp_samples = component_distribution sample sample_shape Gather along k dimension mix_sample_r = mix_sample reshape mix_shape + torch Size len es + mix_sample_r = mix_sample_r repeat torch Size len mix_shape + torch Size + es samples = torch gather comp_samples gather_dim mix_sample_r samples squeeze gather_dim _pad x x unsqueeze - - _event_ndims _pad_mixture_dimensions x dist_batch_ndims = len batch_shape cat_batch_ndims = len mixture_distribution batch_shape pad_ndims = cat_batch_ndims == dist_batch_ndims - cat_batch_ndims xs = x shape x = x reshape xs - + torch Size pad_ndims + xs - + torch Size _event_ndims x __repr__ args_string = f \n mixture_distribution \n component_distribution MixtureSameFamily + + args_string +
Owner s oncall distributed copy torch nn nn torch distributed fsdp FSDPModule fully_shard torch testing _internal common_distributed skip_if_lt_x_gpu torch testing _internal common_fsdp FSDPTestMultiThread MLP torch testing _internal common_utils run_tests TestFullyShardState FSDPTestMultiThread property world_size - int skip_if_lt_x_gpu test_fully_shard_state Tests ability get state object fully sharded module num_mlps = model = nn Sequential MLP _ range num_mlps mlp model fully_shard mlp fully_shard model root_state = fully_shard state model assertTrue root_state None all_states = root_state + fully_shard state mlp mlp model Check each ` fully_shard ` call constructs distinct state object assertEqual len set all_states num_mlps + skip_if_lt_x_gpu test_fully_shard_reapply model = MLP fully_shard model assertRaisesRegex AssertionError Each distinct composable distributed API can only applied module once fully_shard model skip_if_lt_x_gpu test_fully_shard_cls Check we only swap module passed ` fully_shard ` model = MLP fully_shard model assertTrue isinstance model MLP assertTrue isinstance model FSDPModule assertEqual model __class__ __name__ FSDPMLP module model modules module model continue assertFalse isinstance module FSDPModule Check slicing into ` Sequential ` does preserve FSDP model = nn Sequential MLP _ range fully_shard model assertTrue isinstance model nn Sequential assertTrue isinstance model FSDPModule assertEqual model __class__ __name__ FSDPSequential sliced_model = model assertTrue isinstance sliced_model nn Sequential assertFalse isinstance sliced_model FSDPModule skip_if_lt_x_gpu test_fully_shard_unsupported_module_cls regex = r fully\_shard does support containers do implement forward model = nn ModuleList MLP _ range assertRaisesRegex ValueError regex fully_shard model model = nn ModuleDict MLP MLP assertRaisesRegex ValueError regex fully_shard model skip_if_lt_x_gpu test_fully_shard_deepcopy model = MLP fully_shard model assertRaisesRegex AssertionError FSDP does support deepcopy copy deepcopy model __name__ == __main__ run_tests
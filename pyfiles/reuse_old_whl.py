argparse os subprocess sys functools lru_cache pathlib Path typing Any cast Optional Union requests REPO_ROOT = Path __file__ resolve parent parent parent parent sys path insert str REPO_ROOT tools stats upload_metrics emit_metric sys path remove str REPO_ROOT Clean up sys path after FORCE_REBUILD_LABEL = ci-force-rebuild lru_cache get_merge_base - str merge_base = subprocess check_output git merge-base HEAD origin main text=True stderr=subprocess DEVNULL strip Remove when we turn off main branch merge_base == get_head_sha print Merge base same HEAD using HEAD^ merge_base = subprocess check_output git rev-parse HEAD^ text=True stderr=subprocess DEVNULL strip print f Merge base merge_base merge_base lru_cache get_head_sha - str sha = subprocess check_output git rev-parse HEAD text=True stderr=subprocess DEVNULL strip sha is_main_branch - bool False Testing main branch now print f Checking we main branch merge base get_merge_base head get_head_sha get_merge_base == get_head_sha query_github_api url str - Any headers = Accept application vnd github v +json Authorization f Bearer os environ GITHUB_TOKEN response = requests get url headers=headers response json lru_cache check_labels_for_pr - bool Check current commit part PR has FORCE_REBUILD_LABEL head_sha = get_head_sha url = f https api github com repos pytorch pytorch commits head_sha pulls response = query_github_api url print f Found len response PRs commit head_sha pr number pr response pr response labels = pr get labels label labels label name == FORCE_REBUILD_LABEL print f Found label FORCE_REBUILD_LABEL PR pr number True False check_issue_open - bool Check issue open This config issue quickly forcing everyone build url = https api github com repos pytorch pytorch issues response = query_github_api url response get state == open print Issue open True print Issue open False get_workflow_id run_id str - Optional str Get workflow ID corresponds file run ID url = f https api github com repos pytorch pytorch actions runs run_id response = query_github_api url workflow_id response print f Found workflow ID run ID run_id response workflow_id cast str response workflow_id print No workflow ID found None ok_changed_file file str - bool Return true file list allowed files changed reuse old whl file startswith torch file endswith py file startswith torch csrc True file startswith test file endswith py True file startswith docs file endswith md rst True False check_changed_files sha str - bool Return true all changed files list allowed files changed reuse old whl Removing files torch folder allowed since rsync will remove files removed_files = subprocess check_output git diff -- name-only sha HEAD -- diff-filter=D -- no-renames text=True stderr=subprocess DEVNULL strip split any file startswith torch file removed_files print f Removed files between sha HEAD removed_files cannot reuse old whl False changed_files = subprocess check_output git diff -- name-only sha HEAD -- no-renames text=True stderr=subprocess DEVNULL strip split print f Checking changed files between sha HEAD file changed_files ok_changed_file file print f File file allowed changed False print f File file allowed changed True find_old_whl workflow_id str build_environment str sha str - bool Find old whl s download artifacts zip build_environment None print BUILD_ENVIRONMENT set False print f SHA sha workflow_id workflow_id workflow_runs = query_github_api f https api github com repos pytorch pytorch actions workflows workflow_id runs head_sha= sha branch=main per_page= workflow_runs get total_count == print No workflow runs found False run workflow_runs get workflow_runs Look s old whl run_id = run id try url = f https gha-artifacts s amazonaws com pytorch pytorch run_id build_environment artifacts zip print f Checking old whl url response = requests get url response status_code == open artifacts zip wb f f write response content print f Found old whl file s url True except requests RequestException e print f Error checking old whl e continue False unzip_artifact_and_replace_files - None Unzip artifact replace files subprocess check_output unzip -o artifacts zip -d artifacts os remove artifacts zip head_sha = get_head_sha Rename wheel into zip wheel_path = Path artifacts dist glob whl path wheel_path Should form torch- +git -cp -etc whl Should usually merge base sha ones didn t do replacement won t Can probably change just merge base later old_version = f +git path stem split + split - new_version = f +git head_sha rename_to_new_version file Union str Path - None Rename file old_version new_version subprocess check_output mv file str file replace old_version new_version change_content_to_new_version file Union str Path - None Check file os path isdir file Replace old version file new version open file f content = f read content = content replace old_version new_version open file w f f write content zip_path = path with_suffix zip os rename path zip_path old_stem = zip_path stem Unzip wheel subprocess check_output unzip -o zip_path -d f artifacts dist old_stem Remove old wheel which now zip file os remove zip_path Copy python files into artifact subprocess check_output rsync -avz torch f artifacts dist old_stem change_content_to_new_version f artifacts dist old_stem torch version py file Path f artifacts dist old_stem glob dist-info change_content_to_new_version file rename_to_new_version f artifacts dist old_stem new_stem = old_stem replace old_version new_version file Path f artifacts dist new_stem glob dist-info rename_to_new_version file Zip wheel back subprocess check_output zip -r f new_stem zip cwd=f artifacts dist new_stem subprocess check_output mv f artifacts dist new_stem new_stem zip f artifacts dist new_stem whl Remove extracted folder subprocess check_output rm -rf f artifacts dist new_stem Rezip artifact subprocess check_output zip -r artifacts zip cwd= artifacts subprocess check_output mv artifacts artifacts zip None set_output - None print Setting output reuse=true os getenv GITHUB_OUTPUT open str os getenv GITHUB_OUTPUT env print reuse=true file=env print set-output name=reuse true parse_args - argparse Namespace parser = argparse ArgumentParser description= Check old whl files parser add_argument -- run-id type=str required=True help= Workflow ID parser add_argument -- build-environment type=str required=True help= Build environment parser add_argument -- github-ref type=str parser parse_args can_reuse_whl args argparse Namespace - tuple bool str args github_ref any args github_ref startswith x x refs heads release refs tags v refs heads nightly print Release branch rebuild whl False Release branch check_changed_files get_merge_base print Cannot use old whl due changed files rebuild whl False Changed files allowed check_labels_for_pr print f Found FORCE_REBUILD_LABEL label PR rebuild whl False Found FORCE_REBUILD_LABEL PR check_issue_open print Issue open rebuild whl False Issue open workflow_id = get_workflow_id args run_id workflow_id None print No workflow ID found rebuild whl False No workflow ID found find_old_whl workflow_id args build_environment get_merge_base print No old whl found rebuild whl False No old whl found TODO go backwards merge base find more runs True Found old whl __name__ == __main__ args = parse_args reuse_whl reason = can_reuse_whl args reuse_whl print Reusing old whl unzip_artifact_and_replace_files set_output emit_metric reuse_old_whl reuse_whl reuse_whl reason reason build_environment args build_environment merge_base get_merge_base head_sha get_head_sha
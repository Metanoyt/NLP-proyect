======= BEGIN Dynamo patch ======= Owner s module dynamo ruff noqa flake noqa Test copied https raw githubusercontent com python cpython refs tags v Lib test test_baseexception py sys torch torch _dynamo test_case unittest torch _dynamo test_case CPythonTestCase torch testing _internal common_utils run_tests __TestCase = CPythonTestCase redirect statements sys importlib abc redirect_imports = test mapping_tests test typinganndata test test_grammar test test_math test test_iter test typinganndata ann_module RedirectImportFinder importlib abc MetaPathFinder find_spec fullname path target=None Check problematic one fullname redirect_imports try Attempt standalone module name = fullname removeprefix test r = importlib import_module name Redirect module sys modules sys modules fullname = r Return module spec found module importlib util find_spec name except ImportError None None Add custom finder sys meta_path sys meta_path insert RedirectImportFinder ======= END DYNAMO PATCH ======= unittest builtins os platform system platform_system ExceptionClassTests __TestCase Tests anything relating exception objects themselves e g inheritance hierarchy test_builtins_new_style assertTrue issubclass Exception object verify_instance_interface ins attr args __str__ __repr__ assertTrue hasattr ins attr s missing s attribute ins __class__ __name__ attr test_inheritance Make sure inheritance hierarchy matches documentation exc_set = set object_ builtins __dict__ values try issubclass object_ BaseException exc_set add object_ __name__ except TypeError pass inheritance_tree = open os path join os path split __file__ exception_hierarchy txt encoding= utf- try superclass_name = inheritance_tree readline rstrip try last_exc = getattr builtins superclass_name except AttributeError fail base s built-in superclass_name assertIn superclass_name exc_set s found superclass_name exc_set discard superclass_name superclasses = Loop will insert base exception last_depth = exc_line inheritance_tree exc_line = exc_line rstrip depth = exc_line rindex â”€ exc_name = exc_line depth+ Slice past space exc_name paren_index = exc_name index platform_name = exc_name paren_index+ - exc_name = exc_name paren_index- Slice off space platform_system = platform_name exc_set discard exc_name continue exc_name left_bracket = exc_name index exc_name = exc_name left_bracket- cover space try exc = getattr builtins exc_name except AttributeError fail s built-in exception exc_name last_depth depth superclasses append last_depth last_exc last_depth depth while superclasses - = depth superclasses pop assertTrue issubclass exc superclasses - s subclass s exc __name__ superclasses - __name__ try Some exceptions require arguments just skip them verify_instance_interface exc except TypeError pass assertIn exc_name exc_set exc_set discard exc_name last_exc = exc last_depth = depth finally inheritance_tree close assertEqual len exc_set s accounted exc_set interface_tests = length args str repr interface_test_driver results test_name given expected zip interface_tests results assertEqual given expected s s = s test_name given expected test_interface_single_arg Make sure interface works properly when given single argument arg = spam exc = Exception arg results = len exc args exc args arg str exc str arg repr exc s r exc __class__ __name__ arg interface_test_driver results test_interface_multi_arg Make sure interface correct when multiple arguments given arg_count = args = tuple range arg_count exc = Exception args results = len exc args arg_count exc args args str exc str args repr exc exc __class__ __name__ + repr exc args interface_test_driver results test_interface_no_arg Make sure no args interface correct exc = Exception results = len exc args exc args tuple str exc repr exc exc __class__ __name__ + interface_test_driver results test_setstate_refcount_no_crash gh- Acquire strong reference before calling tp_hash slot PyObject_SetAttr gc d = torch _dynamo error_on_graph_break False HashThisKeyWillClearTheDict str __hash__ - int d clear super __hash__ Value str pass exc = Exception d HashThisKeyWillClearTheDict = Value refcount Value now Exception __setstate__ should acquire strong reference key value dict Otherwise Value s refcount would go below zero tp_hash call PyObject_SetAttr would cause crash GC exc __setstate__ d __hash__ called again here clearing dict This GC would crash refcount Value goes below zero gc collect UsageTests __TestCase Test usage exceptions raise_fails object_ Make sure raising object_ triggers TypeError try raise object_ except TypeError What expected fail TypeError expected raising s type object_ catch_fails object_ Catching object_ should raise TypeError try try raise Exception except object_ pass except TypeError pass except Exception fail TypeError expected when catching s type object_ try try raise Exception except object_ pass except TypeError except Exception fail TypeError expected when catching s specified tuple type object_ test_raise_new_style_non_exception You cannot raise new-style does inherit BaseException ability possible until BaseException s introduction so no need support new-style objects do inherit torch _dynamo error_on_graph_break False NewStyleClass object pass raise_fails NewStyleClass raise_fails NewStyleClass test_raise_string Raising string raises TypeError raise_fails spam test_catch_non_BaseException Trying catch object does inherit BaseException allowed torch _dynamo error_on_graph_break False NonBaseException object pass catch_fails NonBaseException catch_fails NonBaseException test_catch_BaseException_instance Catching instance BaseException subclass won t work catch_fails BaseException test_catch_string Catching string bad catch_fails spam __name__ == __main__ run_tests
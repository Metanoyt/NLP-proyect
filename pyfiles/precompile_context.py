copy json logging abc abstractmethod collections defaultdict collections abc Callable dataclasses dataclass typing Any Generic Optional TypeVar torch torch _dynamo package _BackendId _DynamoCacheEntry DynamoCache PrecompileCacheEntry Classes implementations related precompile T = TypeVar T logger = logging getLogger __name__ dataclass BackendCacheArtifact Generic T Represents single serializable backend artifact dynamo backend Each BackendCacheArtifact has key associated along some serializable content Example implementation MyPrecompileCacheArtifact PrecompileCacheArtifact MySerializableType my_field int after_deserialization - MySerializableType result = pickle loads content Do some extra work post deserialization result my_post_deserialization_function my_field result key str content Any abstractmethod after_deserialization - T Code run after reading raw byte contents disk Generally converts content raw bytes back into its original form edit_contents edit_fn Callable Any - None Edit contents artifact content = edit_fn content EagerCacheArtifact BackendCacheArtifact Any after_deserialization - Any content BypassDynamoCacheEntry Exception pass PrecompileContext PrecompileContext special CacheArtifactManager handling precompilation It uses same interface CacheArtifactManager handles deserialization differently instead placing each artifact into respective caches will stitch all cache artifacts single key together place into global Precompile Cache PrecompileContext has two main portions dynamo_cache_entries backend_cache_artifacts When saving PrecompileContext serialize will serialize all dynamo cache entries along any PrecompileCacheArtifacts needed save those dynamo cache entries The following artifact types supported PrecompileContext - BundledAOTAutogradCacheArtifact Protected compile_lock _backend_artifacts_by_key organizes results key each artifact Each object here must serializable _backend_artifacts_by_key dict _BackendId BackendCacheArtifact Any = On call ` serialize ` all cache artifacts _dynamo_cache_entries converted into DynamoCacheArtifacts added _new_cache_artifacts serialization _dynamo_cache_entries dict str _DynamoCacheEntry = classmethod clear cls - None cls _backend_artifacts_by_key clear cls _dynamo_cache_entries clear classmethod record_artifact cls artifact BackendCacheArtifact Any - None Records backend artifact used dynamo cache entries cls _backend_artifacts_by_key _BackendId artifact key = copy deepcopy artifact classmethod record_dynamo_cache_entry cls cache_entry _DynamoCacheEntry key str - None cls _dynamo_cache_entries key = cache_entry classmethod edit_artifact cls key str edit_fn Callable Any - None Edit content existing artifact assert key cls _backend_artifacts_by_key f Key key found artifacts artifact = cls _backend_artifacts_by_key _BackendId key artifact edit_contents edit_fn classmethod serialize_artifact_by_key cls key str - Optional BackendCacheArtifact Any Return backend cache artifact associated key cls _backend_artifacts_by_key get _BackendId key None staticmethod dump_debug_info dynamo_entries dict str _DynamoCacheEntry backend_artifacts dict _BackendId BackendCacheArtifact Any - dict str Any Return JSON serializable debug dump all entries precompile context Called serialize before serialization populate_caches after deserialization Print debug information debug_info defaultdict str list Any = defaultdict list key cache_entry dynamo_entries items info = cache_entry debug_info info key = key debug_info dynamo append info artifact backend_artifacts values debug_info backends append artifact key debug_info classmethod save_to_dynamo_cache cls - dict str Any precompile_cache_entries debug_info = cls create_cache_entries key entry precompile_cache_entries items DynamoCache write entry key debug_info classmethod create_cache_entries cls - tuple dict str PrecompileCacheEntry dict str Any Grabs all cache entries precompile context stitches them together into full PrecompileCacheEntries dynamo_entries = cls _dynamo_cache_entries backend_artifacts = cls _backend_artifacts_by_key num_artifacts = len dynamo_entries debug_info = PrecompileContext dump_debug_info dynamo_entries backend_artifacts debug_str = json dumps num_entries num_artifacts artifacts debug_info torch _logging trace_structured artifact metadata_fn=lambda name dynamo_cache_entries encoding json payload_fn=lambda debug_str expect_trace_id=False precompile_cache_entries = key cache_entry dynamo_entries items try result = PrecompileCacheEntry from_cache_entry cache_entry backend_artifacts result None precompile_cache_entries key = result except Exception e logger warning Failed create cache entry s key exc_info=True error = e data = json dumps key key error str error torch _logging trace_structured artifact metadata_fn=lambda name dynamo_cache_exception encoding json payload_fn=lambda data continue precompile_cache_entries debug_info
mypy allow-untyped-defs Copyright c Facebook Inc its affiliates All rights reserved This source code licensed under BSD-style license found LICENSE file root directory source tree logging multiprocessing mp os signal time queue Empty typing Any api RequestQueue TimerClient TimerRequest TimerServer __all__ = LocalTimerClient MultiprocessingRequestQueue LocalTimerServer logger = logging getLogger __name__ LocalTimerClient TimerClient Client side ` ` LocalTimerServer ` ` This client meant used same host ` ` LocalTimerServer ` ` running uses pid uniquely identify worker This particularly useful situations where one spawns subprocess trainer per GPU host multiple GPU devices __init__ mp_queue super __init__ _mp_queue = mp_queue acquire scope_id expiration_time pid = os getpid acquire_request = TimerRequest pid scope_id expiration_time _mp_queue put acquire_request release scope_id pid = os getpid release_request = TimerRequest pid scope_id - _mp_queue put release_request MultiprocessingRequestQueue RequestQueue A ` ` RequestQueue ` ` backed python ` ` multiprocessing Queue ` ` __init__ mp_queue mp Queue super __init__ _mp_queue = mp_queue size - int _mp_queue qsize get size timeout float - list TimerRequest requests = wait = timeout _ range size start = time time try r = _mp_queue get block=True timeout=wait except Empty break requests append r wait = wait - time time - start wait = break requests LocalTimerServer TimerServer Server works ` ` LocalTimerClient ` ` Clients expected subprocesses parent process running server Each host job expected start its own timer server locally each server instance manages timers local workers running processes same host __init__ mp_queue mp Queue max_interval float = daemon bool = True super __init__ MultiprocessingRequestQueue mp_queue max_interval daemon _timers dict tuple Any str TimerRequest = register_timers timer_requests list TimerRequest - None request timer_requests pid = request worker_id scope_id = request scope_id expiration_time = request expiration_time negative expiration proxy release call expiration_time _timers pop pid scope_id None _timers pid scope_id = request clear_timers worker_ids set int - None pid scope_id list _timers keys pid worker_ids _timers pop pid scope_id get_expired_timers deadline float - dict Any list TimerRequest pid - timer_requests expired_timers dict Any list TimerRequest = request _timers values request expiration_time = deadline expired_scopes = expired_timers setdefault request worker_id expired_scopes append request expired_timers _reap_worker worker_id int - bool try os kill worker_id signal SIGKILL True except ProcessLookupError logger info Process pid= s does exist Skipping worker_id True except Exception logger exception Error terminating pid= s worker_id False
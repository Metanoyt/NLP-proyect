Owner s oncall jit ruff noqa F copy io os sys typing Optional torch torch testing _internal common_utils raise_on_run_directly skipIfTorchDynamo Make helper files test importable pytorch_test_dir = os path dirname os path dirname os path realpath __file__ sys path append pytorch_test_dir torch testing FileCheck torch testing _internal jit_utils JitTestCase torch testing _internal torchbind_impls load_torchbind_test_lib skipIfTorchDynamo skipping precaution TestTorchbind JitTestCase setUp load_torchbind_test_lib test_torchbind test_equality f cmp_key obj = f obj = torch jit script f cmp_key obj cmp_key obj f val = torch classes _TorchScriptTesting _Foo val increment val test_equality f lambda x x assertRaisesRegex RuntimeError Expected value type int val = torch classes _TorchScriptTesting _Foo val increment foo f ss = torch classes _TorchScriptTesting _StackString asdf bruh ss pop test_equality f lambda x x f ss = torch classes _TorchScriptTesting _StackString asdf bruh ss = torch classes _TorchScriptTesting _StackString ss push ss pop ss pop + ss pop test_equality f lambda x x test nn module prepare_scriptable function NonJitableClass __init__ int int int = int int = int return_vals int int CustomWrapper torch nn Module __init__ foo super __init__ foo = foo forward - None foo increment __prepare_scriptable__ int int = foo return_vals foo = torch classes _TorchScriptTesting _Foo int int CustomWrapper foo foo = CustomWrapper NonJitableClass jit_foo = torch jit script foo test_torchbind_take_as_arg global StackString see local resolution python StackString = torch classes _TorchScriptTesting _StackString foo stackstring type StackString stackstring push lel stackstring script_input = torch classes _TorchScriptTesting _StackString scripted = torch jit script foo script_output = scripted script_input assertEqual script_output pop lel test_torchbind_return_instance foo ss = torch classes _TorchScriptTesting _StackString hi mom ss scripted = torch jit script foo Ensure we creating object calling __init__ rather than calling __init__wrapper nonsense fc = FileCheck check prim CreateObject check prim CallMethod name= __init__ fc run str scripted graph out = scripted assertEqual out pop mom assertEqual out pop hi test_torchbind_return_instance_from_method foo ss = torch classes _TorchScriptTesting _StackString hi mom clone = ss clone ss pop ss clone scripted = torch jit script foo out = scripted assertEqual out pop hi assertEqual out pop mom assertEqual out pop hi test_torchbind_def_property_getter_setter foo_getter_setter_full fooGetterSetter = torch classes _TorchScriptTesting _FooGetterSetter getX method intentionally adds x old = fooGetterSetter x setX method intentionally adds x fooGetterSetter x = old + new = fooGetterSetter x old new checkScript foo_getter_setter_full foo_getter_setter_lambda foo = torch classes _TorchScriptTesting _FooGetterSetterLambda old = foo x foo x = old + new = foo x old new checkScript foo_getter_setter_lambda test_torchbind_def_property_just_getter foo_just_getter fooGetterSetter = torch classes _TorchScriptTesting _FooGetterSetter getY method intentionally adds x fooGetterSetter fooGetterSetter y scripted = torch jit script foo_just_getter out result = scripted assertEqual result assertRaisesRegex RuntimeError can t set attribute out y = foo_not_setter fooGetterSetter = torch classes _TorchScriptTesting _FooGetterSetter old = fooGetterSetter y fooGetterSetter y = old + getY method intentionally adds x fooGetterSetter y assertRaisesRegexWithHighlight RuntimeError Tried set read-only attribute y fooGetterSetter y = old + scripted = torch jit script foo_not_setter test_torchbind_def_property_readwrite foo_readwrite fooReadWrite = torch classes _TorchScriptTesting _FooReadWrite old = fooReadWrite x fooReadWrite x = old + fooReadWrite x fooReadWrite y checkScript foo_readwrite foo_readwrite_error fooReadWrite = torch classes _TorchScriptTesting _FooReadWrite fooReadWrite y = fooReadWrite assertRaisesRegexWithHighlight RuntimeError Tried set read-only attribute y fooReadWrite y = scripted = torch jit script foo_readwrite_error test_torchbind_take_instance_as_method_arg foo ss = torch classes _TorchScriptTesting _StackString mom ss = torch classes _TorchScriptTesting _StackString hi ss merge ss ss scripted = torch jit script foo out = scripted assertEqual out pop hi assertEqual out pop mom test_torchbind_return_tuple f val = torch classes _TorchScriptTesting _StackString val return_a_tuple scripted = torch jit script f tup = scripted assertEqual tup test_torchbind_save_load foo ss = torch classes _TorchScriptTesting _StackString mom ss = torch classes _TorchScriptTesting _StackString hi ss merge ss ss scripted = torch jit script foo getExportImportCopy scripted test_torchbind_lambda_method foo ss = torch classes _TorchScriptTesting _StackString mom ss top scripted = torch jit script foo assertEqual scripted mom test_torchbind_class_attr_recursive FooBar torch nn Module __init__ foo_model super __init__ foo_mod = foo_model forward - int foo_mod info to_ivalue torchbind_model = torch classes _TorchScriptTesting _Foo foo_mod info FooBar torchbind_model inst = FooBar torch classes _TorchScriptTesting _Foo scripted = torch jit script inst to_ivalue assertEqual scripted test_torchbind_class_attribute FooBar torch nn Module __init__ - None super __init__ f = torch classes _TorchScriptTesting _StackString forward f top inst = FooBar scripted = torch jit script inst eic = getExportImportCopy scripted assert eic == deserialized expected deserialized i assert eic f pop == expected test_torchbind_getstate FooBar torch nn Module __init__ - None super __init__ f = torch classes _TorchScriptTesting _PickleTester forward f top inst = FooBar scripted = torch jit script inst eic = getExportImportCopy scripted NB we expect values __getstate__ defined I tried make actually depend values instantiation test some transformation because seems we serialize deserialize multiple times transformation isn t you would expect assert eic == expected assert eic f pop == expected test_torchbind_deepcopy FooBar torch nn Module __init__ - None super __init__ f = torch classes _TorchScriptTesting _PickleTester forward f top inst = FooBar scripted = torch jit script inst copied = copy deepcopy scripted assert copied forward == expected assert copied f pop == expected test_torchbind_python_deepcopy FooBar torch nn Module __init__ - None super __init__ f = torch classes _TorchScriptTesting _PickleTester forward f top inst = FooBar copied = copy deepcopy inst assert copied == expected assert copied f pop == expected test_torchbind_tracing TryTracing torch nn Module __init__ - None super __init__ f = torch classes _TorchScriptTesting _PickleTester forward torch ops _TorchScriptTesting take_an_instance f traced = torch jit trace TryTracing assertEqual torch zeros traced test_torchbind_pass_wrong_type assertRaisesRegex RuntimeError instead found type Tensor torch ops _TorchScriptTesting take_an_instance torch rand test_torchbind_tracing_nested TryTracingNest torch nn Module __init__ - None super __init__ f = torch classes _TorchScriptTesting _PickleTester TryTracing torch nn Module __init__ - None super __init__ nest = TryTracingNest forward torch ops _TorchScriptTesting take_an_instance nest f traced = torch jit trace TryTracing assertEqual torch zeros traced test_torchbind_pickle_serialization nt = torch classes _TorchScriptTesting _PickleTester b = io BytesIO torch save nt b b seek weights_only=False trying load ScriptObject nt_loaded = torch load b weights_only=False exp assertEqual nt_loaded pop exp test_torchbind_instantiate_missing_class assertRaisesRegex RuntimeError Tried instantiate foo IDontExist does exist torch classes foo IDontExist test_torchbind_optional_explicit_attr TorchBindOptionalExplicitAttr torch nn Module foo Optional torch classes _TorchScriptTesting _StackString __init__ - None super __init__ foo = torch classes _TorchScriptTesting _StackString test forward - str foo_obj = foo foo_obj None foo_obj pop None mod = TorchBindOptionalExplicitAttr scripted = torch jit script mod test_torchbind_no_init assertRaisesRegex RuntimeError torch init x = torch classes _TorchScriptTesting _NoInit test_profiler_custom_op inst = torch classes _TorchScriptTesting _PickleTester torch autograd profiler profile prof torch ops _TorchScriptTesting take_an_instance inst found_event = False e prof function_events e name == _TorchScriptTesting take_an_instance found_event = True assertTrue found_event test_torchbind_getattr foo = torch classes _TorchScriptTesting _StackString test assertEqual None getattr foo bar None test_torchbind_attr_exception foo = torch classes _TorchScriptTesting _StackString test assertRaisesRegex AttributeError does have field foo bar test_lambda_as_constructor obj_no_swap = torch classes _TorchScriptTesting _LambdaInit False assertEqual obj_no_swap diff obj_swap = torch classes _TorchScriptTesting _LambdaInit True assertEqual obj_swap diff - test_staticmethod fn inp int - int torch classes _TorchScriptTesting _StaticMethod staticMethod inp checkScript fn test_hasattr ss = torch classes _TorchScriptTesting _StackString foo bar assertFalse hasattr ss baz test_default_args fn - int obj = torch classes _TorchScriptTesting _DefaultArgs obj increment obj decrement obj decrement obj divide obj scale_add obj scale_add obj divide obj increment checkScript fn gn - int obj = torch classes _TorchScriptTesting _DefaultArgs obj increment obj increment obj decrement obj divide obj scale_add obj scale_add obj divide obj decrement checkScript gn __name__ == __main__ raise_on_run_directly test test_jit py
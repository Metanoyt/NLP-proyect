Owner s oncall distributed checkpointing concurrent futures Future torch torch distributed checkpoint _experimental staging CheckpointStagerConfig DefaultStager torch testing _internal common_utils requires_cuda run_tests TestCase TestDefaultStager TestCase setUp - None Create test state dictionary various data types state_dict = model torch nn Linear state_dict optimizer param_groups lr epoch step tensor torch randn nested inner_tensor torch ones inner_value requires_cuda test_sync_staging - None Test synchronous staging options = CheckpointStagerConfig use_async_staging=False stager = DefaultStager options Stage state dict staged_dict = stager stage state_dict Verify state dict returned Future assertIsInstance staged_dict dict Verify staged state dictionary assertIn model staged_dict assertIn optimizer staged_dict assertEqual staged_dict epoch assertEqual staged_dict step assertIn tensor staged_dict assertIn nested staged_dict Clean up stager close requires_cuda test_async_staging - None Test asynchronous staging options = CheckpointStagerConfig use_async_staging=True stager = DefaultStager options Stage state dict result = stager stage state_dict Verify Future returned assertIsInstance result Future Wait Future complete staged_dict = result result Verify staged state dictionary assertIn model staged_dict assertIn optimizer staged_dict assertEqual staged_dict epoch assertEqual staged_dict step Clean up stager close test_cuda_non_blocking_without_cuda - None Test non-blocking copy fails when CUDA available torch cuda is_available skipTest CUDA available cannot test CUDA unavailable scenario options = CheckpointStagerConfig use_non_blocking_copy=True assertRaises AssertionError DefaultStager options test_different_option_combinations - None Test various combinations staging options test_cases = All disabled CheckpointStagerConfig use_pinned_memory=False use_shared_memory=False use_async_staging=False use_non_blocking_copy=False Only pinned memory CheckpointStagerConfig use_pinned_memory=True use_shared_memory=False use_async_staging=False use_non_blocking_copy=False Only shared memory CheckpointStagerConfig use_pinned_memory=False use_shared_memory=True use_async_staging=False use_non_blocking_copy=False torch cuda is_available Only async staging test_cases append CheckpointStagerConfig use_pinned_memory=torch accelerator is_available use_shared_memory=False use_async_staging=True use_non_blocking_copy=False Only CUDA non-blocking copy test_cases append CheckpointStagerConfig use_pinned_memory=torch accelerator is_available use_shared_memory=False use_async_staging=False use_non_blocking_copy=torch accelerator is_available options test_cases subTest options=options stager = DefaultStager options Test staging works these options options use_async_staging torch accelerator is_available result = stager stage state_dict assertIsInstance result Future staged_dict = result result staged_dict = stager stage state_dict assertIsInstance staged_dict dict assertIn model staged_dict stager close requires_cuda test_cuda_tensors_staging - None Test staging CUDA tensors Create state dict CUDA tensors cuda_state_dict = cuda_tensor torch randn cuda cpu_tensor torch randn mixed_model weight torch randn cuda bias torch randn cuda options = CheckpointStagerConfig use_async_staging=False stager = DefaultStager options staged_dict = stager stage cuda_state_dict assert isinstance staged_dict dict Verify tensors staged should moved CPU assertIn cuda_tensor staged_dict assertIn cpu_tensor staged_dict assertIn mixed_model staged_dict stager close requires_cuda test_resource_cleanup - None Test resources properly cleaned up options = CheckpointStagerConfig use_async_staging=False stager = DefaultStager options Verify initial state assertIsNotNone stager _state_dict_stager Close verify cleanup stager close test_multiple_staging_operations - None Test multiple staging operations same stager options = CheckpointStagerConfig use_async_staging=False use_pinned_memory=torch accelerator is_available use_shared_memory=False use_non_blocking_copy=torch accelerator is_available stager = DefaultStager options Stage multiple different state dicts state_dicts = model torch nn Linear state_dict model torch nn Conv d state_dict optimizer lr momentum staged_results = state_dict state_dicts staged_dict = stager stage state_dict staged_results append staged_dict Verify all staging operations succeeded assertEqual len staged_results i result enumerate staged_results assertIsInstance result dict Verify result contains expected keys key state_dicts i keys assertIn key result stager close __name__ == __main__ run_tests
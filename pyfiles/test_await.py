Owner s oncall jit io typing List Optional Tuple torch torch Tensor torch _awaits _Await Await torch testing _internal common_utils raise_on_run_directly torch testing _internal jit_utils JitTestCase make_global TestAwait JitTestCase test_await_python foo x int - int x + aw Await int = torch jit _awaitable foo assertTrue aw fn aw args == torch jit _awaitable_wait aw nw = torch jit _awaitable_nowait assertTrue nw is_nowait assertTrue nw args == test_await_type_python foo - Tensor torch randn awaits = torch jit annotate List Await Tensor awaits append torch jit _awaitable foo test_script delayed z int - int z + fn x Tensor aw Await int = torch jit _awaitable delayed = torch eye b = torch jit _awaitable_wait aw + b + x inp = torch zeros sm = torch jit script fn out = fn inp script_out = sm inp assertTrue torch allclose torch eye + script_out assertTrue torch allclose script_out out test_nowait fn x Tensor aw = torch jit _awaitable_nowait = torch eye b = torch jit _awaitable_wait aw + b + x inp = torch zeros sm = torch jit script fn out = fn inp script_out = sm inp assertTrue torch allclose torch eye + script_out assertTrue torch allclose script_out out test_nowait_class C __init__ Tensor b Tensor _a = _b = b - Tensor _a fn x Tensor aw = torch jit _awaitable_nowait C torch zeros torch ones _a = torch eye c = torch jit _awaitable_wait aw _a + c + x make_global C inp = torch zeros sm = torch jit script fn out = fn inp script_out = sm inp assertTrue torch allclose torch eye script_out assertTrue torch allclose script_out out test_await_class_arg C __init__ Tensor b Tensor __a = __b = b - Tensor __a make_global C delayed c C - Tensor c fn x Tensor c = C torch zeros torch ones aw = torch jit _awaitable delayed c _a = torch eye c _t = torch jit _awaitable_wait aw _a + c _t + x inp = torch zeros sm = torch jit script fn out = fn inp script_out = sm inp assertTrue torch allclose torch eye script_out assertTrue torch allclose script_out out test_awaitable_to_await C __slots__ = _a _b __init__ Tensor b Tensor _a = _b = b make_global C Can stay Jit does support Recursive annotations wait_impl can annotated C C defined time C_wait_impl C _a + _b fn x Tensor aw = torch jit _awaitable C_wait_impl C torch zeros torch ones _a = torch eye c_wait_impl_res = torch jit _awaitable_wait aw _a + c_wait_impl_res + x inp = torch ones sm = torch jit script fn out = fn inp script_out = sm inp assertTrue torch allclose torch eye + torch ones script_out assertTrue torch allclose script_out out test_await_class_return C __slots__ = b __init__ Tensor b Tensor = b = b make_global C Can stay Jit does support Recursive annotations wait_impl can annotated C C defined time C_wait_impl C - C C b fn_arg_C x C - Tensor x + x b fn x Tensor aw Await C = torch jit _awaitable C_wait_impl C x x _a = torch eye y = fn_arg_C torch jit _awaitable_wait aw _a + y + x inp = torch ones sm = torch jit script fn out = fn inp script_out = sm inp assertTrue torch allclose torch eye + torch ones script_out assertTrue torch allclose script_out out assertGraphContainsExactly sm graph kind= prim awaitable_wait num_kind_nodes= test_await_getattr_implicit_convertion C __init__ Tensor b Tensor _a = _b = b b _b make_global C Can stay Jit does support Recursive annotations wait_impl can annotated C C defined time C_wait_impl C - C C _a _b fn_arg_C x C - Tensor noqa F x _a + x _b fn x Tensor aw Await C = torch jit _awaitable C_wait_impl C x x _a = torch eye ai = aw _a awb = aw b noqa F c = C x x _a + ai + x + c _a + c b inp = torch ones sm = torch jit script fn out = fn inp script_out = sm inp assertTrue torch allclose torch eye + torch ones script_out assertTrue torch allclose script_out out assertGraphContainsExactly sm graph kind= prim awaitable_wait num_kind_nodes= test_await_nested C __init__ Tensor b Tensor __a = __b = b - Tensor __a make_global C delayed c C - Await Tensor torch jit _awaitable_nowait c fn x Tensor - Await Await Tensor torch jit _awaitable delayed C x x main x Tensor - Tensor awaw = fn x torch jit _awaitable_wait torch jit _awaitable_wait awaw inp = torch eye sm = torch jit script main out = main inp script_out = sm inp assertTrue torch allclose torch eye script_out assertTrue torch allclose script_out out test_eager_await_non_scriptable Tree type can compiled Recursive type Tree __init__ v parent = torch jit annotate Optional Tree None v = v make_global Tree delayed t Tree t v = t v + t aw = torch jit _awaitable delayed Tree t = torch jit _awaitable_wait aw assertTrue t v == test_await_isinstance delayed x Tensor - Tensor x + main x Tensor - Tensor aw = torch jit _awaitable delayed x torch jit is_scripting assert isinstance aw torch jit _Await torch jit _awaitable_wait aw inp = torch eye sm = torch jit script main out = main inp script_out = sm inp assertTrue torch allclose torch eye + torch ones script_out assertTrue torch allclose script_out out test_await_eager_lazy delayed x Tensor - Tensor x + t = torch ones dtype=torch int aw = torch jit _awaitable delayed t assertTrue isinstance aw torch _C _Await assertTrue t dtype == aw dtype test_await_out_of_interpreter delayed x Tensor - Tensor x + main x Tensor - Await Tensor aw = torch jit _awaitable delayed x aw inp = torch eye sm = torch jit script main out_aw = main inp out = torch jit _awaitable_wait out_aw script_out_aw = sm inp script_out = torch jit _awaitable_wait script_out_aw assertTrue torch allclose torch eye + torch ones script_out assertTrue torch allclose script_out out test_jit_trace gap x Tensor torch relu x + torch sin x delayed x Tensor - Tensor torch cos x + main x Tensor y Tensor - Tensor aw = torch jit _awaitable delayed x z = gap y noqa F k = torch jit _awaitable_wait aw y + k inp = torch randn tm = torch jit trace main inp inp inp_check = torch ones assertEqual main inp_check inp_check tm inp_check inp_check test_await_multiout_save gap x Tensor torch relu x + torch sin x delayed x Tensor - Tuple Tensor List Tensor l = x i i range x l main x Tensor - Tensor aw = torch jit _awaitable delayed x z = gap x _ l = torch jit _awaitable_wait aw l + z inp = torch eye sm = torch jit script main out = main inp script_out = sm inp expected = torch eye assertTrue torch allclose expected script_out assertTrue torch allclose script_out out iofile = io BytesIO torch jit save sm iofile iofile seek sm = torch jit load iofile script_out_load = sm inp assertTrue torch allclose expected script_out_load test_await_func_arg gap x Tensor torch relu x + torch sin x delayed x Tensor - Tensor - x fn aw Await Tensor - Tensor torch jit _awaitable_wait aw main x Tensor - Tensor aw = torch jit _awaitable delayed x z = gap x noqa F y = fn aw y + x inp = torch eye sm = torch jit script main out = main inp script_out = sm inp expected = - torch eye assertTrue torch allclose expected script_out assertTrue torch allclose script_out out iofile = io BytesIO torch jit save sm iofile iofile seek sm = torch jit load iofile script_out_load = sm inp assertTrue torch allclose expected script_out_load __name__ == __main__ raise_on_run_directly test test_jit py
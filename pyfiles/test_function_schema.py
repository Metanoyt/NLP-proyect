Owner s module unknown torch torch _C parse_schema torch testing _internal common_utils run_tests TestCase TestFunctionSchema TestCase test_serialize_and_deserialize schemas = torch _C _jit_get_all_schemas so far we have around registered schemas assertGreater len schemas schema schemas parsed_schema = parse_schema str schema assertEqual parsed_schema schema assertTrue parsed_schema is_backward_compatible_with schema test_out_schema schema_with_out = parse_schema any out Tensor Tensor out - Tensor assertTrue schema_with_out arguments - is_out schema_without_out = parse_schema any not_out Tensor Tensor b - Tensor assertFalse schema_without_out arguments - is_out test_hash_schema schema = parse_schema any out Tensor Tensor out - Tensor schema = parse_schema any out Tensor Tensor out - Tensor assertEqual hash schema hash schema schema = parse_schema any not_out Tensor Tensor out - Tensor assertNotEqual hash schema hash schema schema = parse_schema foo Tensor int Tensor out - Tensor assertNotEqual hash schema hash schema schemas different default value different kw-only arg should have different hash default_val_schema = parse_schema foo Tensor int = - Tensor default_val_schema = parse_schema foo Tensor int = - Tensor default_val_schema = parse_schema foo Tensor int = - Tensor assertNotEqual hash default_val_schema hash default_val_schema assertNotEqual hash default_val_schema hash default_val_schema schema different alias annotation should have different hash alias_schema = parse_schema foo Tensor int = - Tensor assertNotEqual hash default_val_schema hash alias_schema alias_schema = parse_schema foo Tensor b int = - Tensor assertNotEqual hash alias_schema hash alias_schema schema different alias infos alias_schema = parse_schema foo Tensor int int b= Tensor out Tensor b b - Tensor alias_schema = parse_schema foo Tensor int int b= Tensor out Tensor b b - Tensor b alias_schema = parse_schema foo Tensor int int b= Tensor b out Tensor b - Tensor assertNotEqual hash alias_schema hash alias_schema assertNotEqual hash alias_schema hash alias_schema test_backward_compatible_structure old_schema = parse_schema any over Tensor Tensor b - Tensor BC A new schema without changes new_schema = parse_schema any over Tensor Tensor b - Tensor assertTrue new_schema is_backward_compatible_with old_schema No-BC A new schema different name new_schema = parse_schema any_ over Tensor Tensor b - Tensor assertFalse new_schema is_backward_compatible_with old_schema No-BC A new schema different overload name new_schema = parse_schema any other Tensor Tensor b - Tensor assertFalse new_schema is_backward_compatible_with old_schema No-BC A new schema adds vararg new_schema = parse_schema any over Tensor Tensor b - Tensor assertFalse new_schema is_backward_compatible_with old_schema No-BC A new schema different number outputs new_schema = parse_schema any over Tensor Tensor b - Tensor Tensor assertFalse new_schema is_backward_compatible_with old_schema test_backward_compatible_outputs old_schema = parse_schema any over Tensor Tensor b - Tensor No-BC A new schema output becoming optional type new_schema = parse_schema any over Tensor Tensor b - Tensor assertFalse new_schema is_backward_compatible_with old_schema BC opposite case An schema where output optional type anymore assertTrue old_schema is_backward_compatible_with new_schema No-BC A new schema different output type new_schema = parse_schema any over Tensor Tensor b - int assertFalse new_schema is_backward_compatible_with old_schema No-BC A new schema different output type new_schema = parse_schema any over Tensor Tensor b - Tensor out assertFalse new_schema is_backward_compatible_with old_schema test_backward_compatible_arguments old_schema = parse_schema any Tensor Tensor b int c - Tensor No-BC A new schema less arguments new_schema = parse_schema any Tensor Tensor b - Tensor assertFalse new_schema is_backward_compatible_with old_schema No-BC A new schema more arguments appended no default value new_schema = parse_schema any Tensor Tensor b int c int d - Tensor assertFalse new_schema is_backward_compatible_with old_schema BC A new schema more arguments appended have default value new_schema = parse_schema any Tensor Tensor b int c int d= - Tensor assertTrue new_schema is_backward_compatible_with old_schema No-BC A new schema more arguments not-appended have default value new_schema = parse_schema any Tensor int d= Tensor b int c - Tensor assertFalse new_schema is_backward_compatible_with old_schema BC A new schema where old kwargs becomes positional new_schema = parse_schema any Tensor Tensor b int c - Tensor assertTrue new_schema is_backward_compatible_with old_schema BC opposite case A new schema where old positional argument becomes kwarg assertFalse old_schema is_backward_compatible_with new_schema BC A new schema where all old kwargs become positional new_schema = parse_schema any Tensor Tensor b int c - Tensor assertTrue new_schema is_backward_compatible_with old_schema BC opposite case A new schema where all old positional arguments become kwarg assertFalse old_schema is_backward_compatible_with new_schema No-BC A new schema where old kwargs appear different order new_schema = parse_schema any Tensor int c Tensor b - Tensor assertFalse new_schema is_backward_compatible_with old_schema BC A new schema where argument becomes type optional new_schema = parse_schema any Tensor Tensor b int c - Tensor assertTrue new_schema is_backward_compatible_with old_schema BC A new schema where argument gains default value new_schema = parse_schema any Tensor Tensor b int c= - Tensor assertTrue new_schema is_backward_compatible_with old_schema No-BC A new schema where argument renamed new_schema = parse_schema any Tensor Tensor b int renamed - Tensor assertFalse new_schema is_backward_compatible_with old_schema No-BC A new schema where argument type changes incompatible type new_schema = parse_schema any Tensor Tensor b int c - Tensor assertFalse new_schema is_backward_compatible_with old_schema test_backward_compatible_with_smart_serialization cases where out arg provided old_schema = parse_schema foo Tensor int Tensor out - Tensor new_schema_same_out = parse_schema foo Tensor int int b= Tensor out - Tensor new_schema_wrong_default = parse_schema foo Tensor int b= int Tensor out - Tensor new_schema_more_out = parse_schema foo Tensor int int b= Tensor out Tensor b b - Tensor new_schema_wrong_pos = parse_schema foo Tensor int int b= Tensor b b Tensor out - Tensor assertTrue new_schema_same_out is_backward_compatible_with old_schema assertTrue new_schema_more_out is_backward_compatible_with old_schema assertFalse new_schema_wrong_default is_backward_compatible_with old_schema assertFalse new_schema_wrong_pos is_backward_compatible_with old_schema cases where out arg provided old_schema_without_arg = parse_schema foo Tensor int int b= - int new_schema_without_arg = parse_schema foo Tensor int int b= int c= - int new_schema_without_arg_multiple_default = parse_schema foo Tensor int int b= int c= int d= - int new_schema_without_arg_wrong_pos = parse_schema foo Tensor int int c= int b= - int assertTrue new_schema_without_arg is_backward_compatible_with old_schema_without_arg assertTrue new_schema_without_arg_multiple_default is_backward_compatible_with old_schema_without_arg assertFalse new_schema_without_arg_wrong_pos is_backward_compatible_with old_schema_without_arg test_string_optional_parameter_default_value schema_a = parse_schema example op str order= NCHW - Tensor schema_b = parse_schema str schema_a assertEqual schema_a schema_b test_forward_compatible_arguments_without_out old_schema = parse_schema any Tensor int int b= - Tensor deleting default arg FC compatible new_schema = parse_schema any Tensor int - Tensor is_fc _ = new_schema check_forward_compatible_with old_schema assertTrue is_fc adding default arg FC compatible new_schema = parse_schema any Tensor int int b= int c= - Tensor is_fc _ = new_schema check_forward_compatible_with old_schema assertTrue is_fc adding default arg container type NOT FC compatible new_schema = parse_schema any Tensor int int b= int c= - Tensor is_fc reason = new_schema check_forward_compatible_with old_schema assertFalse is_fc assertEqual reason Function schema forward compatible since new argument c type int has container type its default value updating default value default arg NOT FC compatible new_schema = parse_schema any Tensor int int b= - Tensor is_fc reason = new_schema check_forward_compatible_with old_schema assertFalse is_fc assertEqual reason b forward compatible older version schema updating arg name default arg NOT FC compatible new_schema = parse_schema any Tensor int int c= - Tensor is_fc reason = new_schema check_forward_compatible_with old_schema assertFalse is_fc assertEqual reason c forward compatible older version schema adding default arg end NOT FC compatible new_schema = parse_schema any Tensor int int c= int b= - Tensor is_fc reason = new_schema check_forward_compatible_with old_schema assertFalse is_fc assertEqual reason c forward compatible older version schema making default arg into positional arg NOT FC compatible new_schema = parse_schema any Tensor int int b - Tensor is_fc reason = new_schema check_forward_compatible_with old_schema assertFalse is_fc assertEqual reason b forward compatible older version schema making positional arg into default arg NOT FC compatible new_schema = parse_schema any Tensor int a= int b= - Tensor is_fc reason = new_schema check_forward_compatible_with old_schema assertFalse is_fc assertEqual reason forward compatible older version schema test_forward_compatible_arguments_real_use_case change introduced forward incompatibility past old_slice_schema = parse_schema slice Tensor int dim= int start= int end= int step= - Tensor new_slice_schema = parse_schema slice Tensor int dim= int start=None int end=None int step= - Tensor is_fc reason = new_slice_schema check_forward_compatible_with old_slice_schema assertFalse is_fc assertEqual reason start forward compatible older version schema test_forward_compatible_arguments_with_out old_schema = parse_schema any Tensor int int b= Tensor out - Tensor new_schema = parse_schema any Tensor int Tensor out - Tensor is_fc _ = new_schema check_forward_compatible_with old_schema assertTrue is_fc new_schema = parse_schema any Tensor int int b= int c= Tensor out - Tensor is_fc _ = new_schema check_forward_compatible_with old_schema assertTrue is_fc new_schema = parse_schema any Tensor int Tensor d d int b= Tensor out - Tensor is_fc reason = new_schema check_forward_compatible_with old_schema assertFalse is_fc assertEqual reason Function schema should have same number out arguments test_schema_error assertRaisesRegex RuntimeError r schemas vararg \ \ can t have default value args parse_schema any foo int arg int arg = test_tensor_list_alias_annotation_properly_parsed schema_str = foo Tensor Tensor out - schema = parse_schema schema_str assertTrue schema arguments - alias_info is_write assertEqual str schema schema_str test_tensor_option_arguments_properly_parsed schema_str = _to_copy Tensor ScalarType dtype=None Layout layout=None Device device=None bool pin_memory=None bool non_blocking=False MemoryFormat memory_format=None - Tensor schema = parse_schema schema_str fake type MemoryFormat int assertEqual schema arguments - type str int fake type Layout int assertEqual schema arguments type str int fake type Device Device assertEqual schema arguments type str Device print real types FunctionSchema assertEqual str schema schema_str test_sym_int_argument_properly_parsed schema_str = sym_size int Tensor int dim - SymInt schema = parse_schema schema_str fake type SymInt int assertEqual schema returns - type str int real type SymInt SymInt assertEqual schema returns - real_type str SymInt print real types FunctionSchema assertEqual str schema schema_str __name__ == __main__ run_tests
Owner s oncall distributed checkpointing sys unittest mock patch torch torch distributed dist torch distributed checkpoint _async_process_executor _ProcessBasedAsyncCheckpointExecutor torch distributed checkpoint storage StorageWriter torch distributed elastic utils distributed get_free_port torch testing _internal common_utils run_tests TEST_WITH_DEV_DBG_ASAN torch testing _internal distributed _tensor common_dtensor DTensorTestBase with_comms TEST_WITH_DEV_DBG_ASAN print Skip dev-asan torch + multiprocessing spawn have known issues file=sys stderr sys exit TestStorageWriter StorageWriter Unified test storage writer configurable behaviors __init__ behavior= success Create test storage writer specified behavior Args behavior success fail_once behavior = behavior call_count = _should_fail Determine call should fail based configured behavior call_count += behavior == success False behavior == fail_once call_count == False Implement all required StorageWriter methods directly reset checkpoint_id=None Reset new checkpoint set_up_storage_writer is_coordinator Set up storage writer prepare_local_plan plan Prepare local plan plan prepare_global_plan plans Prepare global plan plans write_data plan planner Write data policy-based failure behavior torch futures Future Check we should fail based policy _should_fail raise RuntimeError f TestStorageWriter behavior policy triggered failure call call_count Return Future completes simple WriteResult-like objects future = Future result = success True bytes_written future set_result result future finish metadata results Finish checkpoint None storage_meta Return storage metadata None classmethod validate_checkpoint_id cls checkpoint_id Validate checkpoint ID True TestAsyncProcessExecutor DTensorTestBase Test suite async checkpoint process executor error handling using public APIs with_comms test_checkpoint_save_failure_continues_serving - None Test checkpoint save failure doesn t exit process continues serving test_state_dict = model weight torch randn bias torch randn optimizer param_groups lr epoch Simulate failure creating PG background process patch torch distributed checkpoint _async_process_executor get_free_port return_value=- assertRaises ValueError _ proc_executor = _ProcessBasedAsyncCheckpointExecutor fut = proc_executor execute_save staging_future_or_state_dict=test_state_dict fut result Attempt save failing storage writer patch torch distributed checkpoint _async_process_executor get_free_port return_value=get_free_port mock_get_free_port proc_executor = _ProcessBasedAsyncCheckpointExecutor fut = proc_executor execute_save staging_future_or_state_dict=test_state_dict storage_writer=TestStorageWriter behavior= fail_once assertIn fail_once policy triggered failure str fut exception Verify new process created attempt dist get_rank == mock_get_free_port assert_called_once Second save attempt successful storage writer - process should still alive patch torch distributed checkpoint _async_process_executor get_free_port mock_get_free_port proc_executor = _ProcessBasedAsyncCheckpointExecutor fut = proc_executor execute_save staging_future_or_state_dict=test_state_dict storage_writer=TestStorageWriter behavior= success result = fut result Verify process still alive mock_get_free_port assert_not_called Verify successful save assertIsNotNone result __name__ == __main__ run_tests
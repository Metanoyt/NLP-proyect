mypy ignore-errors cutlass_utils try_import_cutlass copied modified original https github com NVIDIA cutlass blob c cd e e e cd c db f tools library scripts gemm_operation py#L try_import_cutlass enum cutlass_library gemm_operation noqa F F cutlass_library library noqa F F _LOGGER = logging getLogger __name__ EmitGemmUniversal xInstanceWithEVT Responsible emitting CUTLASS x template definition __init__ operation_suffix= evt_name=None operation_suffix = operation_suffix includes = cutlass cutlass h cutlass gemm gemm h cutlass numeric_types h cutlass gemm kernel gemm_universal hpp cutlass gemm collective collective_builder hpp cutlass epilogue collective collective_builder hpp builtin_epilogue_functor_template = $ epilogue_functor $ element_d $ element_epilogue $ element_c $ element_epilogue evt_name = evt_name gemm_template = using $ operation_name _epilogue = typename cutlass epilogue collective CollectiveBuilder $ arch $ opcode_class_epi cute Shape cute _$ tile_shape_m cute _$ tile_shape_n cute _$ tile_shape_k cute Shape $ cluster_shape_m $ cluster_shape_n $ cluster_shape_k $ epi_tile_mn $ element_accumulator $ element_epilogue $ element_c $ layout_c $ align_c $ element_d $ layout_d $ align_d $ epilogue_schedule $ epilogue_functor CollectiveOp $ mixed_dtype_prepare_code using $ operation_name _mainloop = typename cutlass gemm collective CollectiveBuilder $ arch $ opcode_class_main $ element_a $ layout_a $ align_a $ element_b $ layout_b $ align_b $ element_accumulator cute Shape cute _$ tile_shape_m cute _$ tile_shape_n cute _$ tile_shape_k cute Shape $ cluster_shape_m $ cluster_shape_n $ cluster_shape_k $ stages $ kernel_schedule CollectiveOp Gemm operator $ operation_name using $ operation_name _base = cutlass gemm kernel GemmUniversal $ problem_shape $ operation_name _mainloop $ operation_name _epilogue $ tile_scheduler Define named type struct $ operation_name public $ operation_name _base instance_template $ compile_guard_start using GemmKernel = cutlass gemm device GemmUniversalAdapter $ operation_name manifest append new $ gemm_kind GemmKernel $ operation_name $ compile_guard_end emit_block_scale_epilogue_functor operation block_scaled_template = $ epilogue_functor $ epi_vs $ element_d $ element_accumulator $ element_sfd $ layout_sfd $ element_c $ element_scalar block_scaled_values = epi_vs str operation ScaleFactorVectorSize element_d str DataTypeTag operation D element element_sfd str DataTypeTag operation ScaleFactorD element layout_sfd LayoutTag operation ScaleFactorD layout epilogue_functor EpilogueFunctor xTag EpilogueFunctor x LinearCombinationBlockScaleFactor element_accumulator str DataTypeTag operation accumulator_type element_scalar str DataTypeTag operation accumulator_type element_c str DataTypeTag operation C element SubstituteTemplate block_scaled_template block_scaled_values staticmethod pointerize_if_grouped operation layout layout is_grouped operation gemm_kind layout + staticmethod problem_shape operation gemm_shape_type = cute Shape int int int int grouped_gemm_shape_type = cute Shape int int int grouped_gemm_shape_type = cutlass gemm GroupProblemShape + grouped_gemm_shape_type + gemm_shape_type is_grouped operation gemm_kind grouped_gemm_shape_type emit operation Given gem operation emits template definition operation opcode_class_main = operation tile_description math_instruction opcode_class opcode_class_epi = opcode_class_main tile_shape = operation tile_description tile_shape instruction_shape = operation tile_description math_instruction instruction_shape cluster_m = operation tile_description cluster_shape cluster_n = operation tile_description cluster_shape tile_shape_m tile_shape_n tile_shape_k = tile_shape account static dynamic cluster shapes cta_m = tile_shape cluster_m cluster_m tile_shape cta_n = tile_shape cluster_n cluster_n tile_shape Shape passed epilogue builder is_sm _kernel = operation arch == is_sm _kernel cta_m_per_mma_instruction = sm operation procedural_name cluster_m = cta_m = cta_m cta_m_per_mma_instruction opcode_class_main OpcodeClass TensorOp OpcodeClass BlockScaledTensorOp tile_shape_m = instruction_shape tile_shape_n = instruction_shape stage count set zero indicates builder automatic stage selection operation tile_description stages stage_count_string = f cutlass gemm collective StageCount \ str operation tile_description stages stage_count_string = f cutlass gemm collective StageCountAutoCarveout static_cast int \ sizeof typename str operation procedural_name _epilogue SharedStorage epi_tile_mn = cutlass epilogue collective EpilogueTileAuto instance_layout_A instance_layout_B instance_layout_C instance_layout_D = operation A layout operation B layout operation C layout operation D layout profiler integration only supports trivial epilogues now epilogue_vector_length = Support built-in epilogue functors user-defined functions isinstance operation epilogue_functor enum Enum values = element_epilogue str DataTypeTag operation element_epilogue epilogue_functor EpilogueFunctor xTag operation epilogue_functor epilogue_functor = SubstituteTemplate builtin_epilogue_functor_template values is_block_scaled operation gemm_kind operation ScaleFactorD element = DataType void epilogue_functor = emit_block_scale_epilogue_functor operation epilogue_functor = epilogue_functor emit_declaration is_block_scaled operation gemm_kind operation ScaleFactorD element = DataType void epilogue_functor = emit_block_scale_epilogue_functor operation Cutlass x complex kernels ElementA B tuple collective mainloop builder e g cute tuple Element Transform Transform cute identity cute conjugate element_a = DataTypeTag operation A element operation is_complex f cute tuple str DataTypeTag operation A element \ str ComplexTransformTag x operation A complex_transform element_b = DataTypeTag operation B element operation is_complex f cute tuple str DataTypeTag operation B element \ str ComplexTransformTag x operation B complex_transform epilogue_schedule_type = EpilogueScheduleTag operation epilogue_schedule opcode_class_main == OpcodeClass BlockScaledTensorOp is_no_smem_epilogue = operation epilogue_schedule EpilogueScheduleType NoSmemWarpSpecialized Sm EpilogueScheduleType NoSmemWarpSpecialized Sm grouped = is_grouped operation gemm_kind cta_n == operation kernel_schedule == to_grouped_schedule KernelScheduleType Nvf TmaWarpSpecialized SmSm grouped epi_tile_mn = cute Shape cute _ cute _ is_no_smem_epilogue epilogue_schedule_type = EpilogueScheduleTag to_grouped_schedule EpilogueScheduleType TmaWarpSpecialized Sm grouped cta_n == operation kernel_schedule == to_grouped_schedule KernelScheduleType Nvf TmaWarpSpecialized SmSm grouped epi_tile_mn = cute Shape cute _ cute _ is_no_smem_epilogue epilogue_schedule_type = EpilogueScheduleTag to_grouped_schedule EpilogueScheduleType TmaWarpSpecialized Sm grouped element_a = f cute tuple str element_a str DataTypeTag operation ScaleFactorA element_b = f cute tuple str element_b str DataTypeTag operation ScaleFactorB operation_name_str = operation procedural_name layout_a_str = LayoutTag instance_layout_A layout_b_str = LayoutTag instance_layout_B mixed_dtype_prepare_code = operation mixed_input_mode None A_dtype = operation A element B_dtype = operation B element A_dtype_bits = DataTypeSize A_dtype B_dtype_bits = DataTypeSize B_dtype is_A_dtype_narrow = A_dtype_bits B_dtype_bits is_A_dtype_narrow narrow_dtype wide_dtype = A_dtype B_dtype narrow_dtype_bits wide_dtype_bits = A_dtype_bits B_dtype_bits narrow_dtype wide_dtype = B_dtype A_dtype narrow_dtype_bits wide_dtype_bits = B_dtype_bits A_dtype_bits narrow_tag = DataTypeTag narrow_dtype wide_tag = DataTypeTag wide_dtype scale_tag = DataTypeTag wide_dtype zero_tag = DataTypeTag wide_dtype do_shuffle = False value_shuffle_str = narrow_dtype_bits == wide_dtype_bits == value_shuffle_str = cute Layout cute Shape cute _ cute _ \ cute Stride cute _ cute _ do_shuffle = True narrow_dtype_bits == wide_dtype_bits == value_shuffle_str = cute Layout cute Shape cute _ cute _ \ cute Stride cute _ cute _ do_shuffle = True do_shuffle = operation mixed_input_shuffle do_shuffle do_shuffle is_A_dtype_narrow stride_narrow_str = f cutlass detail TagToStrideA_t layout_a_str layout_a_str = f operation_name_str _LayoutNarrowReordered stride_narrow_str = f cutlass detail TagToStrideB_t layout_b_str layout_b_str = f operation_name_str _LayoutNarrowReordered The operation_name_str _ prefixs mixed_dtype_prepare_code layout_ b _str prevent errors Windows platform unity build mixed_dtype_prepare_code = f using operation_name_str _StrideNarrow = stride_narrow_str using operation_name_str _ValueShuffle = value_shuffle_str static constexpr int operation_name_str _NumShuffleAtoms = using operation_name_str _MmaAtomShape = \ cute Layout cute Shape cute _ cute Int operation_name_str _NumShuffleAtoms using operation_name_str _LayoutAtomQuant = \ decltype cutlass compute_memory_reordering_atom wide_tag operation_name_str _MmaAtomShape \ operation_name_str _ValueShuffle using operation_name_str _LayoutNarrowReordered = \ decltype cute tile_to_shape operation_name_str _LayoutAtomQuant \ cute Layout cute Shape int int int operation_name_str _StrideNarrow mixed_input_modes_to_element = MixedInputMode ConvertOnly narrow_tag MixedInputMode ScaleOnly f cute tuple narrow_tag scale_tag MixedInputMode ScaleWithZeroPoint f cute tuple narrow_tag scale_tag zero_tag narrow_element = mixed_input_modes_to_element get operation mixed_input_mode narrow_tag narrow_dtype == DataType s wide_dtype == DataType e m wide_dtype == DataType e m narrow_element = f cute tuple narrow_tag cutlass Array scale_tag is_A_dtype_narrow element_a = narrow_element element_b = narrow_element evt_name epilogue_functor = evt_name values = operation_name operation_name_str operation_suffix operation_suffix problem_shape problem_shape operation element_a element_a layout_a pointerize_if_grouped operation layout_a_str element_b element_b layout_b pointerize_if_grouped operation layout_b_str element_c DataTypeTag operation C element layout_c pointerize_if_grouped operation LayoutTag instance_layout_C element_d DataTypeTag operation D element layout_d pointerize_if_grouped operation LayoutTag instance_layout_D element_accumulator DataTypeTag operation accumulator_type opcode_class_main OpcodeClassTag opcode_class_main opcode_class_epi OpcodeClassTag opcode_class_epi arch f cutlass arch Sm operation arch tile_shape_m str tile_shape_m tile_shape_n str tile_shape_n tile_shape_k str tile_shape_k cluster_shape_m cute _ + str operation tile_description cluster_shape operation tile_description cluster_shape int cluster_shape_n cute _ + str operation tile_description cluster_shape operation tile_description cluster_shape int cluster_shape_k cute _ + str operation tile_description cluster_shape operation tile_description cluster_shape int instruction_shape_m str instruction_shape instruction_shape_n str instruction_shape instruction_shape_k str instruction_shape kernel_schedule str KernelScheduleTag operation kernel_schedule epilogue_schedule str epilogue_schedule_type epi_tile_mn epi_tile_mn epilogue_functor epilogue_functor stages stage_count_string align_a str operation A alignment align_b str operation B alignment align_c str operation C alignment align_d str operation D alignment transform_a ComplexTransformTag operation A complex_transform transform_b ComplexTransformTag operation B complex_transform math_operation MathOperationTag operation tile_description math_instruction math_operation epilogue_vector_length str epilogue_vector_length element_epilogue str DataTypeTag operation element_epilogue tile_scheduler str TileSchedulerTag operation tile_scheduler mixed_dtype_prepare_code mixed_dtype_prepare_code SubstituteTemplate gemm_template values
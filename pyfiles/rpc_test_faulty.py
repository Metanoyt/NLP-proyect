mypy allow-untyped-defs torch torch distributed rpc rpc torch Tensor torch distributed rpc RRef torch testing _internal dist_utils dist_init wait_until_pending_futures_and_users_flushed worker_name torch testing _internal distributed rpc rpc_agent_test_fixture RpcAgentTestFixture torch jit script two_args_two_kwargs first_arg second_arg first_kwarg=torch tensor second_kwarg=torch tensor first_arg + second_arg + first_kwarg + second_kwarg torch jit script script_rpc_async_call dst_worker_name str args tuple Tensor Tensor kwargs dict str Tensor fut = rpc rpc_async dst_worker_name two_args_two_kwargs args kwargs ret = fut wait ret torch jit script rpc_async_call_with_timeout dst_worker_name str args tuple Tensor Tensor kwargs dict str Tensor timeout float fut = rpc rpc_async dst_worker_name two_args_two_kwargs args kwargs timeout ret = fut wait ret torch jit script rpc_async_call_with_timeout_future_ret dst_worker_name str args tuple Tensor Tensor kwargs dict str Tensor timeout float fut = rpc rpc_async dst_worker_name two_args_two_kwargs args kwargs timeout fut torch jit script rpc_async_call_future_ret dst_worker_name str args tuple Tensor Tensor kwargs dict str Tensor fut = rpc rpc_async dst_worker_name two_args_two_kwargs args kwargs fut torch jit script rref_to_here rref_var RRef Tensor - Tensor rref_var to_here torch jit script rref_to_here_with_timeout rref_var RRef Tensor timeout float - Tensor rref_var to_here timeout torch jit script rpc_async_with_rref_arg dst_worker_name str args tuple RRef Tensor - Tensor fut = rpc rpc_async dst_worker_name rref_to_here args ret = fut wait ret JitFaultyAgentRpcTest RpcAgentTestFixture Run tests rpc_async JIT under faulty agent test fixture test arbitrary timeouts dist_init faulty_messages= messages_to_delay= SCRIPT_CALL test_timeout_in_torchscript_function Call rpc_async + fut wait torchscript function ensure timeout raised rank = dst_worker_name = worker_name rank + world_size args = torch tensor torch tensor kwargs = first_kwarg torch tensor second_kwarg torch tensor expected_error = get_timeout_error_regex Ensure we get timeout we override default timeout RPC takes longer execute assertRaisesRegex RuntimeError expected_error rpc_async_call_with_timeout dst_worker_name args kwargs Ensure we timeout we don t specify timeout default less than RPC takes execute rpc _set_rpc_timeout assertRaisesRegex RuntimeError expected_error script_rpc_async_call dst_worker_name args kwargs Ensure we run completion zero timeout specified ret = rpc_async_call_with_timeout dst_worker_name args kwargs assertEqual ret torch tensor reset clean shutdown rpc _set_rpc_timeout rpc constants DEFAULT_RPC_TIMEOUT_SEC dist_init faulty_messages= messages_to_delay= SCRIPT_CALL test_timeout_in_python Ensures timeouts raised we call rpc_async within torchscript function wait future python rank = dst_worker_name = worker_name rank + world_size args = torch tensor torch tensor kwargs = first_kwarg torch tensor second_kwarg torch tensor expected_error = get_timeout_error_regex fut = rpc_async_call_with_timeout_future_ret dst_worker_name args kwargs assertRaisesRegex RuntimeError expected_error fut wait Ensure timeout we don t specify default less than RPC takes execute rpc _set_rpc_timeout fut = rpc_async_call_future_ret dst_worker_name args kwargs assertRaisesRegex RuntimeError expected_error fut wait Ensure run completion zero timeout specified fut = rpc_async_call_with_timeout_future_ret dst_worker_name args kwargs result = fut wait assertEqual result torch tensor reset clean shutdown rpc _set_rpc_timeout rpc constants DEFAULT_RPC_TIMEOUT_SEC dist_init faulty_messages= SCRIPT_REMOTE_CALL test_remote_timeout_to_here_in_jit Test calling to_here JIT will raise timeout error rpc remote failed rank = dst_rank = rank + world_size dst_worker = f worker dst_rank rref = rpc remote dst_worker torch add args= torch tensor torch tensor Will ensure error handling callbacks run wait_until_pending_futures_and_users_flushed Call to_here within ScriptFunction ensure raises assertRaisesRegex RuntimeError RRef creation rref_to_here rref dist_init faulty_messages= messages_to_delay= SCRIPT_RREF_FETCH_CALL test_rref_to_here_timeout_in_jit rank = dst_rank = rank + world_size dst_worker = f worker dst_rank rref = rpc remote dst_worker torch add args= torch tensor torch tensor expected_error = get_timeout_error_regex assertRaisesRegex RuntimeError expected_error rref_to_here_with_timeout rref rref_to_here_with_timeout rref dist_init faulty_messages= SCRIPT_REMOTE_CALL test_rref_timeout_pickle_in_jit rank = dst_rank = rank + world_size dst_worker = f worker dst_rank rref = rpc remote dst_worker torch add args= torch tensor torch tensor Will ensure error handling callbacks run wait_until_pending_futures_and_users_flushed Call RPC RRef arg JIT which will go through JIT pickling ensure error raised assertRaisesRegex RuntimeError RRef creation rpc_async_with_rref_arg dst_worker rref dist_init faulty_messages= SCRIPT_REMOTE_CALL test_rref_timeout_pickle_script_func Similar above test calls python rpc script function rank = dst_rank = rank + world_size dst_worker = f worker dst_rank rref = rpc remote dst_worker torch add args= torch tensor torch tensor Will ensure error handling callbacks run wait_until_pending_futures_and_users_flushed Call RPC script function takes RRef ensure timeout during pickling assertRaisesRegex RuntimeError RRef creation rpc rpc_sync dst_worker rref_to_here args= rref
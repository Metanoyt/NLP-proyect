Owner s oncall r p Copyright c Facebook Inc its affiliates All rights reserved This source code licensed under BSD-style license found LICENSE file root directory source tree copy os pickle socket threading time abc ABC abstractmethod base b encode collections abc Callable datetime datetime timedelta timezone typing cast Optional unittest TestCase unittest mock call MagicMock Mock patch PropertyMock torch distributed dist torch distributed HashStore Store torch distributed elastic rendezvous RendezvousClosedError RendezvousError RendezvousInfo RendezvousParameters RendezvousStateError RendezvousStoreInfo RendezvousTimeoutError torch distributed elastic rendezvous dynamic_rendezvous _Action _BackendRendezvousStateHolder _DistributedRendezvousOpExecutor _NodeDesc _NodeDescGenerator _RendezvousCloseOp _RendezvousContext _RendezvousExitOp _RendezvousJoinOp _RendezvousKeepAliveOp _RendezvousState _RendezvousStateHolder create_handler DynamicRendezvousHandler RendezvousBackend RendezvousSettings RendezvousTimeout Token TEST_PORT = TEST_ADDR = host CustomAssertMixin assertDictEqual Callable assert_state_equal actual _RendezvousState expected _RendezvousState - None assertDictEqual vars actual vars expected assert_state_empty actual _RendezvousState - None assertDictEqual vars actual vars _RendezvousState RendezvousTimeoutTest TestCase test_init_initializes_timeout - None timeout = RendezvousTimeout timedelta seconds= timedelta seconds= timedelta seconds= timedelta seconds= assertEqual timeout join timedelta seconds= assertEqual timeout last_call timedelta seconds= assertEqual timeout close timedelta seconds= assertEqual timeout heartbeat timedelta seconds= test_init_initializes_timeout_if_no_timeout_is_specified - None timeout = RendezvousTimeout assertEqual timeout join timedelta seconds= assertEqual timeout last_call timedelta seconds= assertEqual timeout close timedelta seconds= assertEqual timeout heartbeat timedelta seconds= test_init_raises_error_if_timeout_is_not_positive - None join_timeouts = timedelta seconds= timedelta seconds=- join_timeout join_timeouts subTest join_timeout=join_timeout assertRaisesRegex ValueError rf ^The join timeout \ join_timeout \ must positive $ RendezvousTimeout join_timeout NodeDescTest TestCase test_repr - None desc = _NodeDesc dummy_fqdn assertEqual repr desc dummy_fqdn_ _ test_hash - None desc = _NodeDesc dummy_fqdn desc = _NodeDesc dummy_fqdn descs = desc desc assertIn desc descs assertIn desc descs NodeDescGeneratorTest TestCase test_generate - None desc_generator = _NodeDescGenerator fqdn = socket getfqdn pid = os getpid local_id range subTest fqdn=fqdn pid=pid local_id=local_id desc = desc_generator generate assertEqual repr desc f fqdn _ pid _ local_id RendezvousStateTest TestCase test_encoded_size_is_within_expected_limit - None state = _RendezvousState state round = state complete = True state deadline = datetime now timezone utc state closed = True fmt off expected_max_sizes = machines = KB noqa E E E machines = KB noqa E E E machines = KB noqa E E E machines = MB noqa E E E fmt num_nodes max_byte_size expected_max_sizes subTest num_nodes=num_nodes max_byte_size=max_byte_size i range num_nodes node_running = _NodeDesc f dummy i dummy -dummy -dummy -dummy com i node_waiting = _NodeDesc f dummy i dummy -dummy -dummy -dummy com i state participants node_running = i state wait_list add node_waiting state last_heartbeats node_running = datetime now timezone utc state last_heartbeats node_waiting = datetime now timezone utc bits = pickle dumps state base _bits = b encode bits assertLessEqual len base _bits max_byte_size FakeRendezvousBackend RendezvousBackend _state Optional bytes _token int __init__ - None _state = None _token = property name - str fake_backend get_state - Optional tuple bytes Token _token == None _state _token type ignore return-value set_state state bytes token Optional Token = None - Optional tuple bytes Token bool token None token = token == _token _state = state _token += has_set = True has_set = False _state _token has_set type ignore return-value get_state_internal - _RendezvousState pickle loads cast bytes _state set_state_internal state _RendezvousState - None _state = pickle dumps state _token += corrupt_state - None _state = b corrupt_state _token += BackendRendezvousStateHolderTest TestCase CustomAssertMixin setUp - None _backend = FakeRendezvousBackend mock_get_state = MagicMock wraps=self _backend get_state mock_set_state = MagicMock wraps=self _backend set_state _mock_backend = Mock _mock_backend get_state = mock_get_state _mock_backend set_state = mock_set_state setattr _backend get_state mock_get_state noqa B setattr _backend set_state mock_set_state noqa B _settings = RendezvousSettings run_id= dummy_run_id min_nodes= max_nodes= timeout=RendezvousTimeout keep_alive_interval=timedelta seconds= keep_alive_max_attempt= _cache_duration = _now = datetime hour= minute= _datetime_patch = patch torch distributed elastic rendezvous dynamic_rendezvous datetime mock_datetime = _datetime_patch start mock_datetime utcnow return_value = _now tearDown - None _datetime_patch stop _create_state - _RendezvousState state = _RendezvousState state round = state complete = True state deadline = _now state closed = True state participants = _NodeDesc dummy _NodeDesc dummy _NodeDesc dummy state wait_list = _NodeDesc dummy _NodeDesc dummy state last_heartbeats = _NodeDesc dummy _now _NodeDesc dummy _now - timedelta seconds= _NodeDesc dummy _now - timedelta seconds= _NodeDesc dummy _now - timedelta seconds= _NodeDesc dummy _now - timedelta seconds= state _create_state_holder - _BackendRendezvousStateHolder _BackendRendezvousStateHolder _backend _settings _cache_duration test_init_initializes_state_holder - None state_holder = _create_state_holder assert_state_empty state_holder state _mock_backend assert_not_called test_sync_gets_empty_state_if_backend_state_does_not_exist - None state_holder = _create_state_holder has_set = state_holder sync assertIsNone has_set assert_state_empty state_holder state assertEqual _mock_backend get_state call_count assertEqual _mock_backend set_state call_count test_sync_gets_backend_state_if_local_state_is_clean - None state_holder = _create_state_holder expected_state = _create_state attempt range subTest attempt=attempt expected_state round = attempt _backend set_state_internal expected_state has_set = state_holder sync assertIsNone has_set assert_state_equal state_holder state expected_state assertEqual _mock_backend get_state call_count assertEqual _mock_backend set_state call_count _mock_backend reset_mock test_sync_gets_backend_state_if_local_state_is_old_and_dirty - None state_holder = _create_state_holder expected_state = _create_state attempt range subTest attempt=attempt _backend set_state_internal expected_state Increment token state_holder state round = attempt state_holder mark_dirty has_set = state_holder sync assertFalse has_set assert_state_equal state_holder state expected_state assertEqual _mock_backend get_state call_count assertEqual _mock_backend set_state call_count _mock_backend reset_mock test_sync_sets_backend_state_if_local_state_is_new_and_dirty - None state_holder = _create_state_holder attempt range subTest attempt=attempt state_holder state round = attempt state_holder mark_dirty has_set = state_holder sync assertTrue has_set expected_state = _backend get_state_internal assert_state_equal state_holder state expected_state assertEqual _mock_backend get_state call_count assertEqual _mock_backend set_state call_count _mock_backend reset_mock test_sync_uses_cached_state_if_cache_duration_is_specified - None state = _create_state _backend set_state_internal state patch torch distributed elastic rendezvous dynamic_rendezvous time mock_time cache_duration subTest cache_duration=cache_duration _cache_duration = cache_duration state_holder = _create_state_holder mock_time monotonic return_value = state_holder sync has_set = state_holder sync assertIsNone has_set assertEqual _mock_backend get_state call_count assertEqual _mock_backend set_state call_count mock_time monotonic return_value = + _cache_duration state_holder sync has_set = state_holder sync assertIsNone has_set assertEqual _mock_backend get_state call_count assertEqual _mock_backend set_state call_count _mock_backend get_state reset_mock test_sync_gets_backend_state_if_cached_state_has_expired - None state = _create_state _backend set_state_internal state patch torch distributed elastic rendezvous dynamic_rendezvous time mock_time _cache_duration = state_holder = _create_state_holder mock_time monotonic return_value = state_holder sync has_set = state_holder sync assertIsNone has_set assertEqual _mock_backend get_state call_count assertEqual _mock_backend set_state call_count mock_time monotonic return_value = + _cache_duration + state_holder sync has_set = state_holder sync assertIsNone has_set assertEqual _mock_backend get_state call_count assertEqual _mock_backend set_state call_count test_sync_sanitizes_state - None state = _create_state expected_state = copy deepcopy state dead_node = _NodeDesc dead dead_node = _NodeDesc dead dead_node = _NodeDesc dead dead_node = _NodeDesc dead dead_node = _NodeDesc dead state last_heartbeats dead_node = _now - timedelta seconds= state last_heartbeats dead_node = _now - timedelta seconds= state last_heartbeats dead_node = _now - timedelta seconds= state last_heartbeats dead_node = _now - timedelta seconds= state last_heartbeats dead_node = _now - timedelta seconds= state participants dead_node = state participants dead_node = state participants dead_node = state wait_list add dead_node state wait_list add dead_node _backend set_state_internal state state_holder = _create_state_holder state_holder sync assert_state_equal state_holder state expected_state test_sync_sanitizes_state_if_no_participants_is_left - None state = _create_state expected_state = copy deepcopy state node state last_heartbeats state last_heartbeats node = _now - timedelta seconds= expected_state complete = False expected_state round = expected_state participants = expected_state wait_list = set expected_state last_heartbeats = _backend set_state_internal state state_holder = _create_state_holder state_holder sync assert_state_equal state_holder state expected_state test_sync_raises_error_if_backend_state_is_corrupt - None _backend corrupt_state state_holder = _create_state_holder assertRaisesRegex RendezvousStateError r ^The rendezvous state corrupt See inner exception details $ state_holder sync FakeRendezvousStateHolder _RendezvousStateHolder _state _RendezvousState _dirty Optional bool __init__ - None _state = _RendezvousState _dirty = None property state - _RendezvousState _state state setter state value - None _state = value sync - Optional bool _dirty dirty = None _dirty dirty mark_dirty - None _dirty = True DistributedRendezvousOpExecutorTest TestCase CustomAssertMixin setUp - None _node = _NodeDesc this_node _state_holder = FakeRendezvousStateHolder mock_sync = MagicMock wraps=self _state_holder sync mock_mark = MagicMock wraps=self _state_holder mark_dirty _mock_state_holder = Mock _mock_state_holder sync = mock_sync _mock_state_holder mark = mock_mark setattr _state_holder sync mock_sync noqa B setattr _state_holder mark_dirty mock_mark noqa B _state = _state_holder state _min_nodes = _max_nodes = _timeout = RendezvousTimeout _now = datetime hour= minute= _datetime_patch = patch torch distributed elastic rendezvous dynamic_rendezvous datetime mock_datetime = _datetime_patch start mock_datetime utcnow return_value = _now tearDown - None _datetime_patch stop _create_settings - RendezvousSettings RendezvousSettings run_id= dummy_run_id min_nodes=self _min_nodes max_nodes=self _max_nodes timeout=self _timeout keep_alive_interval=timedelta seconds= keep_alive_max_attempt= _create_op_executor settings Optional RendezvousSettings = None - _DistributedRendezvousOpExecutor _state_holder state = _state settings None settings = _create_settings _DistributedRendezvousOpExecutor _node _state_holder settings _run_action action _Action - None op_executor = _create_op_executor op = MagicMock side_effect= action _Action FINISH op_executor run op deadline= _assert_action action _Action expected_state _RendezvousState - None _run_action action assert_state_equal _state expected_state assertListEqual _mock_state_holder mock_calls call sync call mark call sync test_run_passes_expected_context_and_deadline_to_state_handler - None settings = _create_settings op_executor = _create_op_executor settings op = MagicMock return_value=_Action FINISH op_executor run op deadline= ctx deadline = op call_args args assertIs ctx node _node assertIs ctx state _state assertIs ctx settings settings assertEqual deadline test_run_keeps_alive - None expected_state = _RendezvousState expected_state last_heartbeats _node = _now _assert_action _Action KEEP_ALIVE expected_state test_run_adds_to_participants - None expected_state = _RendezvousState expected_state participants _node = expected_state last_heartbeats _node = _now _min_nodes = _max_nodes = _assert_action _Action ADD_TO_PARTICIPANTS expected_state test_run_adds_to_participants_if_node_was_in_waitlist - None _state wait_list add _node expected_state = _RendezvousState expected_state participants _node = expected_state last_heartbeats _node = _now _min_nodes = _max_nodes = _assert_action _Action ADD_TO_PARTICIPANTS expected_state _add_participants num_participants int state _RendezvousState ranked bool = False - None i range num_participants ranked node = _NodeDesc f dummy i rank = i node = _NodeDesc f dummy num_participants - i - Add reverse rank = state participants node = rank state last_heartbeats node = _now test_run_adds_to_participants_and_starts_last_call_if_min_nodes_is_reached - None num_participants range _state = _RendezvousState _add_participants num_participants _state _state wait_list add _node expected_state = _RendezvousState _add_participants num_participants expected_state expected_state participants _node = expected_state last_heartbeats _node = _now expected_state deadline = _now + _timeout last_call subTest num_participants=num_participants _min_nodes = num_participants + _max_nodes = num_participants + _assert_action _Action ADD_TO_PARTICIPANTS expected_state _mock_state_holder reset_mock test_run_adds_to_participants_and_completes_rendezvous_if_max_nodes_is_reached - None min_max_nodes_equal False True num_participants range rank = num_participants _state = _RendezvousState _add_participants num_participants _state _state wait_list add _node _state deadline = _now + _timeout last_call expected_state = _RendezvousState _add_participants num_participants expected_state ranked=True expected_state participants _node = rank expected_state last_heartbeats _node = _now expected_state complete = True expected_state deadline = None subTest num_participants=num_participants _min_nodes = num_participants + min_max_nodes_equal _max_nodes = num_participants + _assert_action _Action ADD_TO_PARTICIPANTS expected_state _mock_state_holder reset_mock test_run_adds_to_waitlist - None expected_state = _RendezvousState expected_state wait_list add _node expected_state last_heartbeats _node = _now _assert_action _Action ADD_TO_WAIT_LIST expected_state test_run_removes_from_participants - None complete last_call_deadline False _now True None _state = _RendezvousState _add_participants _state _state participants _node = _state last_heartbeats _node = _now _state complete = complete _state deadline = last_call_deadline _state round = expected_state = _RendezvousState _add_participants expected_state expected_state complete = complete expected_state deadline = last_call_deadline expected_state round = subTest complete=complete _assert_action _Action REMOVE_FROM_PARTICIPANTS expected_state _mock_state_holder reset_mock test_run_removes_from_participants_and_moves_to_next_round_if_node_is_last_participant - None _state participants _node = _state last_heartbeats _node = _now _state complete = True _state round = expected_state = _RendezvousState expected_state complete = False expected_state round = _assert_action _Action REMOVE_FROM_PARTICIPANTS expected_state test_run_removes_from_participants_and_clears_last_call_if_rendezvous_has_less_than_min_nodes - None _add_participants _state _state participants _node = _state last_heartbeats _node = _now _state deadline = _now expected_state = _RendezvousState _add_participants expected_state _min_nodes = _max_nodes = _assert_action _Action REMOVE_FROM_PARTICIPANTS expected_state test_run_removes_from_waitlist - None _state wait_list add _node _state last_heartbeats _node = _now expected_state = _RendezvousState _assert_action _Action REMOVE_FROM_WAIT_LIST expected_state test_run_marks_rendezvous_closed - None expected_state = _RendezvousState expected_state closed = True _assert_action _Action MARK_RENDEZVOUS_CLOSED expected_state test_run_raises_error_if_rendezvous_is_closed - None assertRaises RendezvousClosedError _run_action _Action ERROR_CLOSED assertListEqual _mock_state_holder mock_calls call sync test_run_raises_error_if_operation_timed_out - None assertRaises RendezvousTimeoutError _run_action _Action ERROR_TIMEOUT assertListEqual _mock_state_holder mock_calls call sync test_run_delays_execution_if_sync_requested - None patch torch distributed elastic rendezvous dynamic_rendezvous _delay mock_delay _run_action _Action SYNC mock_delay assert_called_once_with seconds= assertListEqual _mock_state_holder mock_calls call sync call sync AbstractTestRendezvousOp ABC assertEqual Callable setUp - None _node = _NodeDesc this_node _min_nodes = _max_nodes = _keep_alive_interval = timedelta seconds= _state = _RendezvousState _state participants _NodeDesc dummy = _now = datetime hour= minute= _deadline = _datetime_patch = patch torch distributed elastic rendezvous dynamic_rendezvous datetime mock_datetime = _datetime_patch start mock_datetime utcnow return_value = _now _time_patch = patch torch distributed elastic rendezvous dynamic_rendezvous time mock_time = _time_patch start mock_time monotonic return_value = _deadline tearDown - None _time_patch stop _datetime_patch stop _get_next_action - _Action op = _create_op settings = RendezvousSettings run_id= dummy_run_id min_nodes=self _min_nodes max_nodes=self _max_nodes timeout=RendezvousTimeout keep_alive_interval=self _keep_alive_interval keep_alive_max_attempt= ctx = _RendezvousContext _node _state settings op ctx _deadline abstractmethod _create_op - Callable pass _assert_action expected_action - None action = _get_next_action assertEqual action expected_action TestRendezvousExitOp AbstractTestRendezvousOp TestCase _create_op - Callable _RendezvousExitOp test_removes_from_participants_if_node_is_participant - None _state participants _node = _assert_action _Action REMOVE_FROM_PARTICIPANTS test_raises_timeout_if_deadline_exceeded - None _deadline = _state participants _node = _assert_action _Action ERROR_TIMEOUT test_finishes_if_node_is_not_participant - None _assert_action _Action FINISH TestRendezvousJoinOp AbstractTestRendezvousOp TestCase _create_op - Callable _RendezvousJoinOp test_raises_closed_if_rendezvous_is_closed - None _state closed = True _assert_action _Action ERROR_CLOSED test_finishes_if_rendezvous_is_complete_and_node_is_participant - None _state participants _node = _state complete = True _assert_action _Action FINISH _assert_waits_rendezvous_completion - None keep_alive_time = _now - _keep_alive_interval delta expected_action timedelta seconds= _Action KEEP_ALIVE timedelta seconds= _Action SYNC _state last_heartbeats _node = keep_alive_time + delta _assert_action expected_action test_treat_as_redundancy_for_next_rendezvous_if_rendezvous_is_complete - None _max_nodes = _state complete = True _assert_action _Action ADD_TO_REDUNDANCY_LIST test_waits_next_round_if_rendezvous_is_complete_and_node_is_redundant - None _state redundancy_list add _node _max_nodes = _state complete = True _assert_waits_rendezvous_completion test_remove_from_rednundancy_list - None _state redundancy_list add _node _max_nodes = _state complete = True _assert_action _Action REMOVE_FROM_REDUNDANCY_LIST test_waits_next_round_if_rendezvous_is_complete_and_node_is_in_wait_list - None _state wait_list add _node _state complete = True _assert_waits_rendezvous_completion test_adds_to_wait_list_if_rendezvous_is_complete_and_num_nodes_is_less_than_max_nodes - None _state complete = True _assert_action _Action ADD_TO_WAIT_LIST test_waits_rendezvous_to_complete_if_node_is_participant - None _max_nodes = _state participants _node = _state deadline = _now _assert_waits_rendezvous_completion test_marks_rendezvous_complete_if_node_is_participant_and_last_call_deadline_exceeded - None _max_nodes = _state participants _node = _state deadline = _now - timedelta seconds= _assert_action _Action MARK_RENDEZVOUS_COMPLETE test_adds_to_participants - None _assert_action _Action ADD_TO_PARTICIPANTS test_raises_timeout_if_deadline_exceeded - None _deadline = _assert_action _Action ERROR_TIMEOUT test_raises_timeout_if_rollback_deadline_exceeded_and_node_is_participant - None _deadline = _state participants _node = _assert_action _Action ERROR_TIMEOUT test_raises_timeout_if_rollback_deadline_exceeded_and_node_is_in_wait_list - None _deadline = _state wait_list add _node _assert_action _Action ERROR_TIMEOUT test_removes_from_participants_if_timed_out_but_rollback_deadline_is_not_reached - None _deadline = _state participants _node = _assert_action _Action REMOVE_FROM_PARTICIPANTS test_removes_from_wait_list_if_timed_out_but_rollback_deadline_is_not_reached - None _deadline = _state wait_list add _node _assert_action _Action REMOVE_FROM_WAIT_LIST test_no_timeout_for_redundant_node - None _max_nodes = _deadline = _state complete = True _state redundancy_list add _node _assert_action _Action SYNC test_keep_alive_for_redundant_node - None _deadline = _max_nodes = _state complete = True _state redundancy_list add _node keep_alive_time = _now - _keep_alive_interval _state last_heartbeats _node = keep_alive_time _assert_action _Action KEEP_ALIVE TestRendezvousCloseOp AbstractTestRendezvousOp TestCase _create_op - Callable _RendezvousCloseOp test_finishes_if_rendezvous_is_closed - None _state closed = True _assert_action _Action FINISH test_raises_timeout_if_deadline_exceeded - None _deadline = _assert_action _Action ERROR_TIMEOUT test_marks_rendezvous_closed - None _assert_action _Action MARK_RENDEZVOUS_CLOSED TestRendezvousKeepAliveOp AbstractTestRendezvousOp TestCase _create_op - Callable _RendezvousKeepAliveOp test_updates_keep_alive_if_needed - None keep_alive_time = _now - _keep_alive_interval delta timedelta seconds= timedelta seconds=- subTest delta=delta _state last_heartbeats _node = keep_alive_time + delta _assert_action _Action KEEP_ALIVE test_raises_timeout_if_deadlined_exceeded - None _deadline = _state last_heartbeats _node = _now - _keep_alive_interval _assert_action _Action ERROR_TIMEOUT test_finishes_if_no_keep_alive_update_is_needed - None delta = timedelta seconds= _state last_heartbeats _node = _now - _keep_alive_interval + delta _assert_action _Action FINISH DummyStore Store property port - int TEST_PORT DynamicRendezvousHandlerTest TestCase setUp - None _node = _NodeDesc this_node _min_nodes = _max_nodes = _join_timeout Optional timedelta = None _close_timeout Optional timedelta = None _heartbeat_timeout Optional timedelta = None _keep_alive_interval = timedelta seconds= _store = DummyStore _mock_store_get = MagicMock return_value=b _mock_store_set = MagicMock setattr _store get _mock_store_get noqa B setattr _store set _mock_store_set noqa B _state_holder = FakeRendezvousStateHolder _mock_sync = MagicMock wraps=self _state_holder sync setattr _state_holder sync _mock_sync noqa B _state = _state_holder state _tcp_store_mock = DummyStore patcher = patch object DynamicRendezvousHandler _create_tcp_store_server return_value=self _tcp_store_mock patcher start addCleanup patcher stop _create_handler - DynamicRendezvousHandler settings = RendezvousSettings run_id= dummy_run_id min_nodes=self _min_nodes max_nodes=self _max_nodes timeout=RendezvousTimeout join=self _join_timeout close=self _close_timeout heartbeat=self _heartbeat_timeout keep_alive_interval=self _keep_alive_interval keep_alive_max_attempt= _state_holder state = _state DynamicRendezvousHandler _node settings dummy_backend _store _state_holder test_share_store_creates_tcp_store handler = _create_handler shared_store_info = RendezvousStoreInfo TEST_ADDR TEST_PORT patch object RendezvousStoreInfo build return_value=shared_store_info rdzv_info = handler next_rendezvous assertEqual rdzv_info bootstrap_store_info master_addr TEST_ADDR assertEqual rdzv_info bootstrap_store_info master_port TEST_PORT assertEqual handler _shared_tcp_store_server _tcp_store_mock rdzv_info = handler next_rendezvous assertEqual handler _shared_tcp_store_server _tcp_store_mock test_share_store_when_tcp_store handler = _create_handler CustomPrefixStore Mock get key TEST_ADDR encode utf- key == MASTER_ADDR bytes str TEST_PORT utf- set key value pass patch object dist PrefixStore new=CustomPrefixStore handler _store = Mock spec=dist TCPStore type handler _store host = PropertyMock return_value=TEST_ADDR type handler _store port = PropertyMock return_value=TEST_PORT - rdzv_info = handler next_rendezvous assertEqual rdzv_info bootstrap_store_info master_addr TEST_ADDR assertEqual rdzv_info bootstrap_store_info master_port TEST_PORT assertNotEqual handler _shared_tcp_store_server handler _store rdzv_info = handler next_rendezvous assertEqual rdzv_info bootstrap_store_info master_addr TEST_ADDR assertEqual rdzv_info bootstrap_store_info master_port TEST_PORT assertNotEqual handler _shared_tcp_store_server handler _store patch torch distributed elastic rendezvous dynamic_rendezvous _delay test_next_rendezvous_skews_the_first_join_attempt mock_delay - None round expected_call_count True False subTest round=round _state round = round handler = _create_handler handler next_rendezvous assertEqual mock_delay call_count expected_call_count mock_delay reset_mock test_next_rendezvous_returns_expected_value - None _state participants _NodeDesc dummy = _state participants _NodeDesc dummy = _max_nodes = handler = _create_handler rdzv_info = handler next_rendezvous assertEqual rdzv_info rank assertEqual rdzv_info world_size _ = rdzv_info store get dummy_key _mock_store_get assert_called_with torch rendezvous dummy_run_id dummy_key test_next_rendezvous_respects_the_requested_timeout - None _mock_sync side_effect = lambda time sleep _join_timeout = timedelta seconds= handler = _create_handler assertRaises RendezvousTimeoutError handler next_rendezvous test_next_rendezvous_moves_to_next_round_if_called_repeatedly - None handler = _create_handler i range handler next_rendezvous assertEqual _state round i test_is_closed_returns_expected_value - None closed False True subTest closed=closed _state closed = closed handler = _create_handler assertEqual handler is_closed closed _mock_sync assert_called_once _mock_sync reset_mock patch torch distributed elastic events record_rdzv_event test_is_closed_records_and_raises_exceptions record_mock - None _mock_sync side_effect = RendezvousError test error handler = _create_handler assertRaises RendezvousError handler is_closed record_mock assert_called_once test_set_closed_closes_rendezvous - None handler = _create_handler handler set_closed assertTrue _state closed test_set_closed_respects_the_requested_timeout - None _mock_sync side_effect = lambda time sleep _close_timeout = timedelta seconds= handler = _create_handler assertRaises RendezvousTimeoutError handler set_closed test_set_closed_can_be_called_multiple_times - None handler = _create_handler handler set_closed handler set_closed assertTrue _state closed patch torch distributed elastic events record_rdzv_event test_set_closed_records_and_raises_exceptions record_mock - None patch object DynamicRendezvousHandler _close close_mock close_mock side_effect = RendezvousError test error handler = _create_handler assertRaises RendezvousError handler set_closed record_mock assert_called_once test_num_nodes_waiting_returns_expected_value - None _state wait_list add _NodeDesc dummy _state wait_list add _NodeDesc dummy handler = _create_handler assertEqual handler num_nodes_waiting _mock_sync assert_called_once patch torch distributed elastic events record_rdzv_event test_num_nodes_waiting_records_and_raises_exceptions record_mock - None _mock_sync side_effect = RendezvousError test error handler = _create_handler assertRaises RendezvousError handler num_nodes_waiting record_mock assert_called_once test_shutdown_closes_rendezvous_and_returns_true - None handler = _create_handler result = handler shutdown assertTrue result assertTrue _state closed test_shutdown_returns_false_if_rendezvous_cannot_be_closed - None _mock_sync side_effect = RendezvousError handler = _create_handler result = handler shutdown assertFalse result test_shutdown_can_be_called_multiple_times - None handler = _create_handler handler shutdown handler shutdown assertTrue _state closed patch torch distributed elastic events record_rdzv_event test_shutdown_records_and_raises_exceptions record_mock - None patch object DynamicRendezvousHandler _close close_mock close_mock side_effect = RuntimeError test error handler = _create_handler assertRaises RuntimeError handler shutdown record_mock assert_called_once patch torch distributed elastic rendezvous dynamic_rendezvous datetime test_keep_alive_updates_last_heartbeat mock_datetime - None now = datetime hour= minute= mock_datetime utcnow return_value = now _state last_heartbeats _node = now - _keep_alive_interval handler = _create_handler handler _keep_alive assertEqual _state last_heartbeats _node now _assert_keep_alive_swallows_rendezvous_errors - None last_heartbeat_time = datetime now timezone utc - _keep_alive_interval _state last_heartbeats _node = last_heartbeat_time handler = _create_handler handler _keep_alive assertEqual _state last_heartbeats _node last_heartbeat_time test_keep_alive_swallows_rendezvous_errors - None _mock_sync side_effect = RendezvousError _assert_keep_alive_swallows_rendezvous_errors test_keep_alive_respects_the_requested_timeout - None _mock_sync side_effect = lambda time sleep _heartbeat_timeout = timedelta seconds= _assert_keep_alive_swallows_rendezvous_errors test_keep_alive_thread_is_started_with_next_rendezvous_and_stopped_with_shutdown - None _node = _NodeDesc this_node name = RendezvousKeepAliveTimer_ handler = _create_handler assertTrue all t name = name t threading enumerate handler next_rendezvous assertTrue any t name == name t threading enumerate handler shutdown assertTrue all t name = name t threading enumerate test_keep_alive_thread_is_started_with_next_rendezvous_and_stopped_with_finalizer - None _node = _NodeDesc this_node name = RendezvousKeepAliveTimer_ handler = _create_handler assertTrue all t name = name t threading enumerate handler next_rendezvous assertTrue any t name == name t threading enumerate del handler assertTrue all t name = name t threading enumerate DummyRendezvousBackend RendezvousBackend property name dummy_backend get_state None set_state state token None DynamicRendezvousHandlerFromBackendTest TestCase setUp - None _run_id = dummy_run_id _store = DummyStore _backend = DummyRendezvousBackend _min_nodes = _max_nodes = _timeout Optional RendezvousTimeout = RendezvousTimeout _create_handler - DynamicRendezvousHandler DynamicRendezvousHandler from_backend run_id=self _run_id store=self _store backend=self _backend min_nodes=self _min_nodes max_nodes=self _max_nodes timeout=self _timeout test_init_initializes_handler - None handler = _create_handler assertEqual handler get_backend _backend name assertEqual handler get_run_id _run_id assertEqual handler settings run_id _run_id assertEqual handler settings min_nodes _min_nodes assertEqual handler settings max_nodes _max_nodes _timeout None assertIsNotNone handler settings timeout assertIs handler settings timeout _timeout test_init_initializes_handler_if_timeout_is_not_specified - None _timeout = None test_init_initializes_handler test_init_initializes_handler_if_min_and_max_nodes_are_equal - None _min_nodes = _max_nodes = test_init_initializes_handler test_init_raises_error_if_min_nodes_is_not_positive - None num - subTest min_nodes=num _min_nodes = num assertRaisesRegex ValueError rf ^The minimum number nodes \ num \ must greater than zero $ _create_handler test_init_raises_error_if_max_nodes_is_less_than_min - None _min_nodes = _max_nodes = assertRaisesRegex ValueError rf ^The maximum number nodes \ _max_nodes \ must greater than equal minimum number nodes rf \ _min_nodes \ $ _create_handler CreateHandlerTest TestCase setUp - None _store = DummyStore _backend = DummyRendezvousBackend _params = RendezvousParameters backend=self _backend name endpoint= dummy_endpoint run_id= dummy_run_id min_nodes= max_nodes= join_timeout= last_call_timeout= close_timeout= _expected_timeout = RendezvousTimeout timedelta seconds= timedelta seconds= timedelta seconds= test_create_handler_returns_handler - None handler = create_handler _store _backend _params assertEqual handler get_backend _backend name assertEqual handler get_run_id _params run_id assertEqual handler settings min_nodes _params min_nodes assertEqual handler settings max_nodes _params max_nodes assertEqual handler settings timeout join _expected_timeout join assertEqual handler settings timeout last_call _expected_timeout last_call assertEqual handler settings timeout close _expected_timeout close test_create_handler_returns_handler_if_timeout_is_not_specified - None del _params config join_timeout del _params config last_call_timeout del _params config close_timeout _expected_timeout = RendezvousTimeout test_create_handler_returns_handler patch torch distributed elastic events record_rdzv_event test_create_handler_records_and_raises_exceptions record_mock - None patch object DynamicRendezvousHandler from_backend from_mock from_mock side_effect = RendezvousError test error assertRaises RendezvousError create_handler _store _backend _params record_mock assert_called_once test_create_handler_rdzv_local_addr - None params = RendezvousParameters backend=self _backend name endpoint= dummy_endpoint run_id= dummy_run_id min_nodes= max_nodes= join_timeout= last_call_timeout= close_timeout= local_addr= store = HashStore handler = create_handler store _backend params rdzv_info = handler next_rendezvous assertEqual rdzv_info bootstrap_store_info master_addr _ignore_exception exception_type Exception fn Callable try fn except exception_type pass _wait_for condition timeout= interval= name=None _wait_while while True condition break time sleep interval wait_thread = threading Thread target=_wait_while name=name wait_thread start wait_thread join timeout=timeout _CapturingThread threading Thread __init__ target=None name=None args=None kwargs=None args None args = kwargs None kwargs = threading Thread __init__ target=target args=args kwargs=kwargs name=name _result = None run _target None _result = _target _args _kwargs join args threading Thread join args _result IntegrationTest TestCase setUp - None _store = HashStore _handlers = _backend = _InMemoryRendezvousBackend tearDown - None handler _handlers handler _stop_heartbeats _create_handler kwargs - DynamicRendezvousHandler params = backend _backend name endpoint dummy_endpoint run_id dummy_run_id min_nodes max_nodes join_timeout local_addr f len _handlers params update kwargs rzdv_params = RendezvousParameters params handler = create_handler _store _backend rzdv_params _handlers append handler handler test_all_nodes_join_rendezvous - None handler = _create_handler min_nodes= max_nodes= handler = _create_handler min_nodes= max_nodes= handler _thread = _CapturingThread target=handler next_rendezvous handler _thread = _CapturingThread target=handler next_rendezvous handler _thread start handler _thread start rdzv_info RendezvousInfo = handler _thread join rdzv_info RendezvousInfo = handler _thread join assertEqual rdzv_info store underlying_store _store assertEqual rdzv_info store underlying_store _store assertNotEqual rdzv_info rank rdzv_info rank assertEqual rdzv_info world_size assertEqual rdzv_info world_size test_redundancy_list - None handler = _create_handler min_nodes= max_nodes= handler = _create_handler min_nodes= max_nodes= handler = _create_handler min_nodes= max_nodes= handler _thread = _CapturingThread target=handler next_rendezvous handler _thread = _CapturingThread target=handler next_rendezvous handler _thread = _CapturingThread target=_ignore_exception args= RendezvousTimeoutError lambda handler next_rendezvous handler _thread start handler _thread start establish successful rendezvous handler _thread join handler _thread join expect register redundancy list handler _thread start wait until handler registered redundancy list _wait_for lambda pickle loads _backend get_state redundancy_list state_and_token = _backend get_state state = pickle loads state_and_token addresses = node addr node state redundancy_list assertListEqual addresses test_redundancy_transition_to_wait_list_then_join_rendezvous - None handler = _create_handler min_nodes= max_nodes= handler = _create_handler min_nodes= max_nodes= keep_alive_interval=timedelta seconds= handler = _create_handler min_nodes= max_nodes= handler _thread = _CapturingThread target=handler next_rendezvous handler _thread = _CapturingThread target=handler next_rendezvous handler _thread = _CapturingThread target=_ignore_exception args= RendezvousTimeoutError lambda handler next_rendezvous handler _thread start handler _thread start establish successful rendezvous handler _thread join handler _thread join handler _thread start _wait_for lambda pickle loads _backend get_state redundancy_list handler _stop_heartbeats _wait_for lambda len pickle loads _backend get_state participants == _wait_for lambda len pickle loads _backend get_state wait_list == test_use_agent_store_is_true_by_default handler = _create_handler min_nodes= max_nodes= assertTrue handler use_agent_store patch dict os environ TORCH_DISABLE_SHARE_RDZV_TCP_STORE test_use_agent_store_is_disabled handler = _create_handler min_nodes= max_nodes= assertFalse handler use_agent_store patch object dist PrefixStore test_share_tcp_store_from_backend prefix_store_class_mock expected_addr = expected_address expected_port = CustomPrefixStore Mock get key expected_addr encode utf- key == MASTER_ADDR bytes str expected_port utf- set key value pass prefix_store = CustomPrefixStore spec=dist PrefixStore prefix_store_class_mock return_value = prefix_store tcp_store = Mock spec=dist TCPStore original_addr = original_addr original_port = TEST_PORT type tcp_store host = PropertyMock return_value=original_addr type tcp_store port = PropertyMock return_value=original_port will injected _store = tcp_store handler = _create_handler min_nodes= max_nodes= handler = _create_handler min_nodes= max_nodes= handler _thread = _CapturingThread target=handler next_rendezvous handler _thread = _CapturingThread target=handler next_rendezvous handler _thread start handler _thread start rdzv_info RendezvousInfo = handler _thread join rdzv_info RendezvousInfo = handler _thread join assertEqual rdzv_info store prefix_store assertEqual rdzv_info store prefix_store prefix_store_class_mock assert_called_with torch rendezvous dummy_run_id tcp_store assertEqual rdzv_info bootstrap_store_info rdzv_info bootstrap_store_info assertEqual rdzv_info bootstrap_store_info master_addr expected_addr assertEqual rdzv_info bootstrap_store_info master_port expected_port patch dict os environ TORCH_DISABLE_SHARE_RDZV_TCP_STORE patch object dist PrefixStore test_share_tcp_store_is_disabled prefix_store_class_mock prefix_store = Mock prefix_store_class_mock return_value = prefix_store prefix_store set return_value = None prefix_store get return_value = b tcp_store = Mock spec=dist TCPStore will injected _store = tcp_store handler = _create_handler min_nodes= max_nodes= handler = _create_handler min_nodes= max_nodes= handler _thread = _CapturingThread target=handler next_rendezvous handler _thread = _CapturingThread target=handler next_rendezvous handler _thread start handler _thread start rdzv_info RendezvousInfo = handler _thread join rdzv_info RendezvousInfo = handler _thread join assertEqual rdzv_info store prefix_store assertEqual rdzv_info store prefix_store prefix_store_class_mock assert_called_with torch rendezvous dummy_run_id _store assertEqual rdzv_info bootstrap_store_info master_port assertEqual rdzv_info bootstrap_store_info master_port _InMemoryRendezvousBackend RendezvousBackend __init__ - None _lock = threading Lock _state = None _token = None property name _in_memory_backend get_state _lock _state None None _state _token _state set_state state token state None raise ValueError State cannot None _lock token None _token None None _token = token None _state = state _token = _token + _token None
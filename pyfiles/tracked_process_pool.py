atexit concurrent dataclasses logging threading concurrent futures Future ProcessPoolExecutor dataclasses dataclass multiprocessing context BaseContext time time typing Any Callable Optional TypeVar typing_extensions ParamSpec _thread_safe_fork needed because subprocesses pool can read justknobs e g Triton compiler For internal installs functionality destroy singletons before forking re-enable them after torch _thread_safe_fork noqa F _P = ParamSpec _P _R = TypeVar _R log = logging getLogger __name__ dataclass _QueueStats Mapping id future - start time pending dict int float = dataclasses field default_factory=dict timing list float = dataclasses field default_factory=list enqueue_count int = dequeue_count int = max_queue_depth int = pool_count int = The queue statistics tracked TrackedProcessPoolExecutor Always grab _queue_stats_lock before touching _queue_stats = _QueueStats _queue_stats_lock = threading Lock TrackedProcessPoolExecutor ProcessPoolExecutor __init__ max_workers Optional int = None mp_context Optional BaseContext = None initializer Optional Callable object = None - None _queue_stats_lock _queue_stats pool_count += super __init__ max_workers mp_context initializer _record_dequeue f Future Any - None now = time _queue_stats_lock stats = _queue_stats start_time = stats pending pop id f None None stats dequeue_count += duration = now - start_time stats timing append duration _record_enqueue f Future Any - None Monkeypatch set_running_or_notify_cancel so we can track when Future moves out PENDING saved_running_or_notify_cancel = f set_running_or_notify_cancel set_running_or_notify_cancel - Any _record_dequeue f saved_running_or_notify_cancel now = time _queue_stats_lock stats = _queue_stats stats pending id f = now stats enqueue_count += stats max_queue_depth = max stats max_queue_depth len stats pending f set_running_or_notify_cancel = set_running_or_notify_cancel type ignore method-assign f _state = concurrent futures _base PENDING _record_dequeue f submit fn Callable _P _R args _P args kwargs _P kwargs - Future _R pyrefly ignore bad-argument-type f = super submit fn args kwargs _record_enqueue f f atexit register _queue_stats_report - None stats = _queue_stats stats pool_count == timing = stats timing timing sort log info AsyncCompile Metrics log info Pools s stats pool_count log info Items d enqueued d dequeued stats enqueue_count stats dequeue_count log info Max Queue Depth d stats max_queue_depth n = len timing n log info Longest queue time fs timing - log info P fs timing n n = log info P fs timing n
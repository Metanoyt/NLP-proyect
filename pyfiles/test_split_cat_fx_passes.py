Owner s module inductor torch torch _dynamo utils counters torch _inductor fx_passes misc_patterns numpy_compat_normalization torch _inductor test_case run_tests TestCase torch testing _internal common_utils IS_LINUX torch testing _internal inductor_utils GPU_TYPE HAS_GPU torch testing _internal triton_utils requires_gpu patch f f = torch _inductor config patch pre_grad_fusion_options= normalization_pass remove_split_with_size_one_pass merge_getitem_cat_pass merge_splits_pass mutate_cat_pass split_cat_pass unbind_stack_pass post_grad_fusion_options= f f TestSplitCatFxPasses TestCase torch _inductor config patch pre_grad_fusion_options= normalization_pass post_grad_fusion_options= test_split_normalization arg_only x torch relu s s torch split x arg_only_dim x torch relu s s torch split x kwarg x torch relu s s torch split x dim= kwarg x torch relu s s torch split x split_size_or_sections= dim= kwarg x torch relu s s torch split tensor=x split_size_or_sections= dim=- list_replace x torch relu s s torch split x dim= multi_split x torch split s s torch split x unequal_split x torch relu s s torch split x arg_only_cm x torch relu s s x split kwarg _cm x torch relu s s x split dim= kwarg _cm x torch relu s s x split split_size= dim= multi_split_cm x s split s x split unequal_split_cm x torch relu s s x split cm_with_list x torch relu s s x split dim=- normalize_reshape_with_dynamic_shape x x reshape args = torch randn fn dynamic expected_split_norm_count arg_only False arg_only_dim False kwarg False kwarg False kwarg False list_replace False multi_split False unequal_split False arg_only_cm False kwarg _cm False kwarg _cm False multi_split_cm False unequal_split_cm False cm_with_list False normalize_reshape_with_dynamic_shape True expected = fn args actual = torch compile fn dynamic=dynamic args torch testing assert_close actual expected assertEqual counters inductor normalization_pass expected_split_norm_count msg=f fn counters clear torch _inductor config patch pre_grad_fusion_options= normalization_pass post_grad_fusion_options= test_cat_normalization caoncat_only x torch concat list torch split x dim= args = torch randn fn dynamic expected_cat_norm_count caoncat_only False expected = fn args actual = torch compile fn dynamic=dynamic args torch testing assert_close actual expected assertEqual counters inductor normalization_pass expected_cat_norm_count msg=f fn counters clear patch test_consecutive_split_merge multi_split x torch split s s torch split x multi_split_ x torch split s s torch split x multi_split_ _neg_dim x torch split s s torch split x - multi_split_with_sizes x torch split s s torch split x multi_split_kwarg x torch split s dim= s torch split x dim= multi_split_kwarg x torch split s split_size_or_sections= dim= s torch split x split_size_or_sections= dim= unequal_multi_split x fs = torch split x dim= item = fs item = fs item = fs final_items = final_items extend item split final_items extend item split final_items extend item split torch relu s s final_items unequal_multi_split_neg_index x fs = torch split x dim= item = fs - item = fs - item = fs - final_items = final_items extend item split final_items extend item split final_items extend item split torch relu s s final_items Shouldn t merge diff_dims x torch split s dim= s torch split x dim= some_users_not_splits x fs = torch split x dim= item = fs item = fs item = fs final_items = final_items extend item split final_items extend item split final_items append torch sin item torch relu s s final_items split_with_cat x fs = torch split x dim= item = fs item = fs item = fs final_items = item item final_items extend item split torch cat final_items dim= duplicate_getitems x fs = torch split x dim= item = fs item _ = fs item _ = fs item = fs final_items = final_items extend item split final_items extend item _ split final_items extend item _ final_items append torch sin item torch relu s s final_items duplicate_getitems_neg_index x fs = torch split x dim= item = fs item _ = fs item _ = fs - negative index item = fs final_items = final_items extend item split final_items extend item _ split final_items extend item _ final_items append torch sin item torch relu s s final_items split_getitem_gap x fs = torch split x dim= item = fs item = fs final_items = item final_items extend item split torch cat final_items dim= split_getitem_out_of_order x fs = torch split x dim= item = fs item = fs item = fs item = fs final_items = item item item final_items extend item split torch cat final_items dim= split_partial_getitem_cat x fs = torch split x dim= item = fs item = fs final_items = item final_items extend item split torch cat final_items dim= next_split_getitem_partial_used x fs = torch split x dim= item = fs item = fs final_items = item ns = item split final_items extend ns final_items extend ns torch cat final_items dim= args = torch randn fn expected_split_merged multi_split multi_split_ multi_split_ _neg_dim multi_split_with_sizes multi_split_kwarg multi_split_kwarg unequal_multi_split unequal_multi_split_neg_index diff_dims some_users_not_splits split_with_cat duplicate_getitems duplicate_getitems_neg_index split_getitem_gap split_getitem_out_of_order next_split_getitem_partial_used split_partial_getitem_cat expected = fn args actual = torch compile fn args torch testing assert_close actual expected assertEqual counters inductor merge_splits_pass expected_split_merged counters clear patch test_split_cat_merge simple_split_cat x torch cat torch split x dim= dim= simple_split_cat_argspec x torch cat torch split x dim= simple_split_cat_argspec x torch cat tensors=torch split x dim= dim= simple_split_cat_argspec x torch cat torch split x dim= - simple_split_cat_argspec x torch cat tensors=torch split x dim= dim=- simple_split_stack x torch stack torch split x dim= dim= simple_split_stack_argspec x torch stack torch split x dim= simple_split_stack_argspec x torch stack tensors=torch split x dim= dim= split_cat_addn_args x split_output = list torch split x dim= torch cat torch ones + split_output + torch ones dim= split_stack_addn_args x split_output = list torch split x dim= torch stack torch ones + split_output + torch ones torch ones dim= split_cat_addn_args_dim x split_output = list torch split x dim= torch cat torch ones + split_output + torch ones dim= split_dim= cat_dim= split_cat_dim_mismatch x split_output = list torch split x dim= torch cat torch ones + split_output + torch ones dim= split_stack_dim_mismatch x split_output = list torch split x dim= torch stack torch ones + split_output + torch ones dim= split_dim= cat_dim= split_cat_dim_mismatch x split_output = list torch split x dim= torch cat torch ones + split_output + torch ones dim= split_stack_dim_mismatch x split_output = list torch split x dim= torch stack torch ones + split_output + torch ones dim= split_dim= cat_dim= split_cat_dim_mismatch x split_output = list torch split x dim= torch cat torch ones + split_output + torch ones dim= split_stack_dim_mismatch x split_output = list torch split x dim= torch stack torch ones + split_output + torch ones dim= input_shuffling x split_output = list torch split x dim= torch cat torch ones + split_output split_output split_output + torch ones + split_output split_output split_output + torch ones dim= input_shuffling_stack x split_output = list torch split x dim= torch stack torch ones + split_output split_output split_output + torch ones + split_output split_output split_output + torch ones dim= input_shuffling_dim_mismatch x split_output = list torch split x dim= torch cat torch ones + split_output split_output split_output + torch ones + split_output split_output split_output + torch ones dim= input_shuffling_dim_mismatch_stack x split_output = list torch split x dim= torch stack torch ones + split_output split_output split_output + torch ones + split_output split_output split_output + torch ones dim= input_shuffling_multiple_output x split_output = list torch split x dim= cat = torch cat torch ones + split_output split_output split_output + torch ones dim= stack = torch stack torch ones split_output split_output torch ones dim= relu = torch relu split_output cat stack relu input_shuffling_direct_output x split_output = list torch split x dim= cat = torch cat torch ones + split_output split_output split_output + torch ones dim= stack = torch stack torch ones split_output split_output torch ones dim= cat stack split_output input_shuffling_multiple_output_same_ranges x split_output = list torch split x dim= cat = torch cat torch ones + split_output split_output split_output + torch ones dim= cat = torch cat torch ones + split_output split_output split_output + torch ones dim= stack = torch stack torch ones split_output split_output torch ones dim= relu = torch relu split_output cat cat stack relu unequal_split_multiple_output x split_output = list torch split x dim= cat = torch cat torch ones + split_output split_output split_output + torch ones dim= stack = torch stack torch ones split_output split_output torch ones dim= relu = torch relu split_output cat stack relu multi_split_cat x x split_output_ = list torch split x dim= split_output_ = list torch split x dim= cat = torch cat torch ones + split_output_ split_output_ split_output_ + torch ones + split_output_ split_output_ split_output_ + torch ones dim= stack = torch stack torch ones split_output_ split_output_ torch ones split_output_ split_output_ torch ones dim= relu = torch relu split_output_ relu = torch relu split_output_ cat stack relu relu TODO Add more tests Cases where replacement shouldn t happen default_args = torch randn multi_args = torch randn torch randn fn expected_split_added expected_split_removed expected_cat_added expected_cat_removed expected_sections_removed args simple_split_cat default_args simple_split_cat_argspec default_args simple_split_cat_argspec default_args simple_split_cat_argspec default_args simple_split_cat_argspec default_args simple_split_stack default_args simple_split_stack_argspec default_args simple_split_stack_argspec default_args split_cat_addn_args default_args split_stack_addn_args default_args split_cat_addn_args_dim default_args split_cat_dim_mismatch default_args split_stack_dim_mismatch default_args split_cat_dim_mismatch default_args split_stack_dim_mismatch default_args split_cat_dim_mismatch default_args split_stack_dim_mismatch default_args input_shuffling default_args input_shuffling_stack default_args input_shuffling_dim_mismatch default_args input_shuffling_dim_mismatch_stack default_args input_shuffling_multiple_output default_args input_shuffling_direct_output default_args unequal_split_multiple_output default_args multi_split_cat multi_args expected = fn args actual = torch compile fn args torch testing assert_close actual expected assertEqual counters inductor scmerge_split_added expected_split_added assertEqual counters inductor scmerge_split_removed expected_split_removed assertEqual counters inductor scmerge_cat_added expected_cat_added assertEqual counters inductor scmerge_cat_removed expected_cat_removed assertEqual counters inductor scmerge_split_sections_removed expected_sections_removed counters clear torch _inductor config patch pre_grad_fusion_options= post_grad_fusion_options= test_config_flag_is_respected split_with_cat x fs = torch split x dim=- item = fs item = fs item = fs final_items = item item final_items extend item split torch cat final_items dim= args = torch randn expected = split_with_cat args actual = torch compile split_with_cat args torch testing assert_close actual expected assertEqual counters inductor merge_splits_pass assertEqual counters inductor normalization_pass patch test_split_cat_merge_mutation args = torch randn split_cat_mutation x splits = torch split x dim= splits copy_ splits torch cat splits dim= expected = split_cat_mutation args actual = torch compile split_cat_mutation args torch testing assert_close actual expected assertEqual counters inductor scmerge_split_removed assertEqual counters inductor scmerge_cat_removed patch test_split_squeeze split_squeeze_stack x items = list torch split x dim= split_items = torch squeeze s s items torch stack split_items split_squeeze_stack_callmethod x items = list torch split x dim= split_items = s squeeze s items torch stack split_items split_squeeze_stack_callmethod_none_dim x items = list torch split x dim= split_items = s squeeze s items torch stack split_items split_squeeze_stack_kwarg x items = list torch split x dim= split_items = torch squeeze s dim= s items torch stack split_items split_squeeze_stack_kwarg _callmethod x items = list torch split x dim= split_items = s squeeze dim= s items torch stack split_items split_squeeze_multi_squeeze_users x items = list torch split x dim= split_items = torch squeeze s s items torch stack split_items torch relu split_items torch tanh split_items split_size_not_ x items = list torch split x dim= split_items = torch squeeze s s items torch stack split_items dim_mismatch x items = list torch split x dim= split_items = torch squeeze s s items torch stack split_items other_users x items = list torch split x dim= split_items = torch squeeze s s items torch stack split_items torch relu items other_users_ x items = list torch split x dim= split_items = torch squeeze s s items torch stack split_items torch relu items graph_should_be_topological_sorted x output = t x split output append torch sin t squeeze dim= output = torch stack output output args = torch randn fn split_squeeze_replaced split_squeeze_stack split_squeeze_stack_callmethod TODO handle none dim split_squeeze_stack_callmethod_none_dim split_squeeze_stack_kwarg split_squeeze_stack_kwarg _callmethod split_squeeze_multi_squeeze_users split_size_not_ dim_mismatch other_users other_users_ graph_should_be_topological_sorted expected = fn args actual = torch compile fn args torch testing assert_close actual expected assertEqual counters inductor split_cat_pass split_squeeze_replaced counters clear patch test_unbind_stack unbind_stack x torch stack torch unbind x unbind_cat x noqa F torch cat torch unbind x dim=- unbind_stack_argspec x torch stack torch unbind input=x dim= dim= unbind_stack_argspec x torch stack tensors=torch unbind x dim= dim= dim_mismatch x torch stack torch unbind x dim= split_squeeze_stack x items = list torch split x dim= split_items = torch squeeze s s items torch stack split_items split_squeeze_stack_callmethod x items = list torch split x dim= split_items = torch squeeze s s items torch stack split_items other_users x items = list torch split x dim= split_items = torch squeeze s s items torch stack split_items torch relu items other_users_ x items = list torch split x dim= split_items = torch squeeze s s items torch stack split_items torch relu items unbind_cat_addn_args x split_output = list torch unbind x dim= torch cat torch ones + split_output + torch ones dim= unbind_stack_addn_args x split_output = list torch unbind x dim= torch stack torch ones + split_output + torch ones torch ones dim= unbind_cat_addn_args_dim x split_output = list torch unbind x dim= torch cat torch ones + split_output + torch ones dim= split_dim= cat_dim= unbind_cat_dim_mismatch x split_output = list torch unbind x dim= torch cat torch ones + split_output + torch ones dim= unbind_stack_dim_mismatch x split_output = list torch unbind x dim= torch stack torch ones + split_output + torch ones dim= unbind_cat_multi_users x split_output = list torch unbind x dim= torch cat torch ones + split_output + torch ones dim= torch stack torch ones + split_output + torch ones torch ones dim= unbind_cat_multi_users_diff_dims x split_output = list torch unbind x dim= torch cat torch ones + split_output + torch ones dim= torch stack torch ones + split_output + torch ones dim= args = torch randn fn expected_unbind_added expected_unbind_removed expected_cat_added expected_cat_removed expected_sections_removed expected_unbind_normalized unbind_stack unbind_stack_argspec unbind_stack_argspec dim_mismatch split_squeeze_stack split_squeeze_stack_callmethod other_users other_users_ unbind_cat_addn_args unbind_stack_addn_args unbind_cat_addn_args_dim unbind_cat_dim_mismatch unbind_stack_dim_mismatch unbind_cat_multi_users unbind_cat_multi_users_diff_dims expected = fn args actual = torch compile fn args torch testing assert_close actual expected assertEqual counters inductor scmerge_split_added expected_unbind_added msg=f fn assertEqual counters inductor scmerge_split_removed expected_unbind_removed msg=f fn assertEqual counters inductor scmerge_cat_added expected_cat_added msg=f fn assertEqual counters inductor scmerge_cat_removed expected_cat_removed msg=f fn assertEqual counters inductor scmerge_split_sections_removed expected_sections_removed msg=f fn assertEqual counters inductor normalization_pass expected_unbind_normalized msg=f fn counters clear patch test_split_cat_new_patterns split_cat_split x l _out = torch split x item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out cat_ = torch cat item item cat_ = torch cat item item l _out = torch split cat_ l _out = torch split cat_ item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out output = torch cat item item item item item item item item item item item item item output split_cat_split_kwarg x l _out = torch split x dim= item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out cat_ = torch cat item item dim= cat_ = torch cat item item dim= l _out = torch split cat_ dim= l _out = torch split cat_ dim= item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out output = torch cat item item item item item item item item item item item item item dim= output remove_cat_node_with_all_getitmes x l _out = torch split x dim= item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out cat = torch cat item item item item item item item item item item item dim= cat_ = torch cat item item dim= cat_ = torch cat item item dim= l _out = torch split cat_ dim= l _out = torch split cat_ dim= item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out output = torch cat item item item item item item item item item item item item item dim= torch cat output cat dim= mutate_cat_node_with_some_getitmes x l _out = torch split x dim= item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out cat = torch cat item item item item item item item item item dim= cat_ = torch cat item item dim= cat_ = torch cat item item dim= l _out = torch split cat_ dim= l _out = torch split cat_ dim= item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out output = torch cat item item item item item item item dim= torch cat output cat dim= torch _inductor config patch pre_grad_fusion_options= split_cat_to_slices_pass post_grad_fusion_options= split_cat_to_slices x x_c = x clone x_c_ = x clone l _out = torch split x dim= l _out = torch split x_c dim= l _out = torch split x_c_ dim= item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item _c = l _out item _c = l _out item _c = l _out item _c = l _out item _c = l _out item _c = l _out item _c = l _out item _c = l _out item _c = l _out item _c = l _out item _c_ = l _out item _c_ = l _out item _c_ = l _out item _c_ = l _out item _c_ = l _out other = item clone torch cat other item item item item item item item item item item item _c item _c item _c item _c item _c item _c item _c item _c item _c item _c item _c_ item _c_ item _c_ item _c_ item _c_ dim= torch _inductor config patch pre_grad_fusion_options= unbind_cat_to_view_pass post_grad_fusion_options= unbind_cat_to_view x y = x view z = x view l _out = torch unbind y dim= l _out = torch unbind z dim= item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item _ = l _out item _ = l _out item _ = l _out item _ = l _out item _ = l _out item _ = l _out item _ = l _out item _ = l _out item _ = l _out item _ = l _out other = item clone other = item clone other = item clone cat = torch cat item item item item item item item other item _ item _ item _ item _ item _ item _ item _ item _ item _ item _ other other dim= cat torch _inductor config patch pre_grad_fusion_options= split_stack_to_cats_pass post_grad_fusion_options= split_stack_to_cats_same_dim x x_c = x view l _out = torch unbind x_c dim= item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out split = torch split item dim= split = torch split item dim= split = torch split item dim= split = torch split item dim= split = torch split item dim= split = torch split item dim= getitem getitem = split split getitem getitem = split split getitem getitem = split split getitem getitem = split split getitem getitem = split split getitem getitem = split split getitem _c = getitem clone getitem _c = getitem clone getitem _c = getitem clone torch stack getitem getitem getitem getitem getitem getitem getitem _c getitem _c getitem getitem getitem getitem getitem getitem getitem _c dim= torch _inductor config patch pre_grad_fusion_options= split_stack_to_cats_pass post_grad_fusion_options= split_stack_to_cats_different_dim x l _out = torch split x dim= x_c = x clone l _out = torch split x_c dim= item = l _out item = l _out item = l _out item = l _out item = l _out item _c = l _out item _c = l _out item _c = l _out item _c = l _out item _c = l _out other_ = item clone other_ = item clone other_ = item clone torch stack other_ other_ other_ item item item item item item _c item _c item _c item _c item _c dim= torch _inductor config patch pre_grad_fusion_options= unbind_stack_to_slices_pass post_grad_fusion_options= unbind_stack_to_slices x x_ = x view l _out = torch unbind x_ dim= item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out item = l _out other_ = item clone other_ = item clone other_ = item clone torch stack other_ other_ other_ item item item item item item item item item item dim= torch _inductor config patch pre_grad_fusion_options= normalization_pass move_reshape_out_of_split_stack_pass post_grad_fusion_options= move_reshape_out_of_split_stack x x_c = x view l _out = torch split x_c dim= item = l _out item = l _out item = l _out item = l _out item = l _out reshape = item reshape - reshape = item reshape - reshape = item reshape - reshape = item reshape - reshape = item reshape - other = reshape clone other = reshape clone other = reshape clone other = reshape clone torch stack other other other reshape reshape reshape reshape reshape other dim= args = torch randn fn expected_getitem_cat_merged expected_cat_removed expected_split_cat_to_slices exptected_unbind_to_cat_view expected_split_stack_to_cats exptected_unbind_stack_to_slices expected_move_reshape_out_of_split_stack split_cat_split split_cat_split_kwarg remove_cat_node_with_all_getitmes mutate_cat_node_with_some_getitmes split_cat_to_slices unbind_cat_to_view split_stack_to_cats_same_dim split_stack_to_cats_different_dim unbind_stack_to_slices move_reshape_out_of_split_stack expected = fn args actual = torch compile fn args torch testing assert_close actual expected assertEqual counters inductor merge_getitem_cat_pass expected_getitem_cat_merged assertEqual counters inductor mutate_cat_pass expected_cat_removed assertEqual counters inductor split_cat_to_slices_pass expected_split_cat_to_slices assertEqual counters inductor unbind_cat_to_view_pass exptected_unbind_to_cat_view assertEqual counters inductor split_stack_to_cats_pass expected_split_stack_to_cats assertEqual counters inductor unbind_stack_to_slices_pass exptected_unbind_stack_to_slices assertEqual counters inductor move_reshape_out_of_split_stack_pass expected_move_reshape_out_of_split_stack counters clear test_numpy_compat_normalization fn x y = torch stack x y axis= b = torch mul x x =y c = torch mul x x =y d = torch mul x x =y e = torch max x dim= keepdims=True f = torch dropout x=x p= train=True b c d e f fn_t = torch fx symbolic_trace fn numpy_compat_normalization fn_t graph n fn_t graph nodes k n kwargs keys assertTrue k x x x axis keepdims patch requires_gpu test_stack_normalization_axis_kwarg fn x y torch stack x y axis= x y = torch rand device=GPU_TYPE _ range expected = fn x y actual = torch compile fn x y assertEqual actual expected __name__ == __main__ IS_LINUX HAS_GPU run_tests
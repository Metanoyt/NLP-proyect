Barrier implementations synchronizing distributed checkpoint operations This module provides abstract concrete barrier implementations ensure all ranks distributed training environment complete their checkpoint operations before proceeding which essential data consistency abc logging collections Counter dataclasses dataclass field datetime timedelta typing Any Optional torch distributed dist torch distributed elastic utils store store_util logger = logging getLogger Registry barrier types BARRIER_REGISTRY dict str type = register_barrier barrier_class type - type Register barrier global registry hasattr barrier_class barrier_type BARRIER_REGISTRY barrier_class barrier_type = barrier_class barrier_class dataclass BarrierConfig Configuration barrier construction This provides flexible way configure different barrier implementations their specific constructor arguments The barrier type will looked up registry instantiated rank_info barrier_args Attributes barrier_type A string identifying barrier type e g tcp_store If None no barrier will used barrier_args Dictionary arguments pass barrier constructor rank_info will automatically injected first argument Examples No barrier BarrierConfig TCPStore barrier BarrierConfig barrier_type= tcp_store barrier_args= timeout_barrier_init_secs barrier_prefix_list checkpoint use_checkpoint_barrier_tcpstore_libuv False tcpstore_port master_address localhost barrier_type Optional str = None barrier_args dict str Any = field default_factory=dict create_barrier_from_config barrier_config BarrierConfig - Optional Barrier Create barrier instance BarrierConfig Args barrier_config Configuration barrier construction Returns Barrier instance None no barrier type configured Raises ValueError If barrier_type found registry barrier_config barrier_type None None barrier_config barrier_type BARRIER_REGISTRY raise ValueError f Unknown barrier type barrier_config barrier_type f Available types list BARRIER_REGISTRY keys barrier_class = BARRIER_REGISTRY barrier_config barrier_type barrier_class barrier_config barrier_args Barrier abc ABC Abstract base synchronization barriers A barrier ensures all ranks distributed environment reach certain point execution before any rank proceeds further which essential coordinating operations like checkpointing across multiple processes abc abstractmethod __init__ kwargs dict str Any Initialize barrier Args kwargs Keyword arguments specific barrier implementations Common arguments may include rank information barrier prefixes timeout settings other barrier-specific configuration No implementation needed abstract base abc abstractmethod execute_barrier - None Execute synchronization barrier This method uses barrier_prefix provided during initialization coordinate synchronization across processes register_barrier DistBarrier Barrier A barrier implementation using PyTorch s distributed barrier synchronization This barrier uses built-in torch distributed barrier function coordinate synchronization across multiple processes It s simpler than TCPStoreBarrier requires initialized process group barrier_type = dist_barrier __init__ - None Initialize DistBarrier This barrier requires initialized PyTorch distributed process group No additional arguments needed uses current process group Raises AssertionError If distributed process group initialized dist is_initialized raise AssertionError DistBarrier requires initialized process group execute_barrier - None Execute synchronization barrier using prefix provided during initialization Note dist barrier doesn t support explicit timeouts The timeout handled underlying implementation dist barrier register_barrier TCPStoreBarrier Barrier A barrier implementation using PyTorch s TCPStore synchronization This barrier uses TCP-based distributed key-value store coordinate synchronization across multiple processes It uses single TCP store all barrier operations different prefixes distinguish between different barrier types barrier_type = tcp_store __init__ global_rank int global_world_size int barrier_prefix str timeout_barrier_init_secs int use_checkpoint_barrier_tcpstore_libuv bool tcpstore_port int master_address str timeout_secs int Initialize TCPStoreBarrier Args global_rank The rank current process distributed environment global_world_size The total number processes distributed environment barrier_prefix A string prefix identify specific barrier timeout_barrier_init_secs Timeout seconds initializing TCPStore use_checkpoint_barrier_tcpstore_libuv Whether use libuv TCPStore tcpstore_port Port number TCPStore master_address Address master node TCPStore timeout_secs Maximum time seconds wait all ranks reach barrier logger info Initializing TCPStore master_address= s tcpstore_port= s rank= s world_size= s barrier_prefix= s timeout_barrier_init_secs= s use_checkpoint_barrier_tcpstore_libuv= s timeout_secs= s master_address tcpstore_port global_rank global_world_size barrier_prefix timeout_barrier_init_secs use_checkpoint_barrier_tcpstore_libuv timeout_secs Counter collection track barrier seq per barrier prefix basis _tcp_store_barrier_seq Counter = Counter _barrier_prefix = barrier_prefix Store rank world size barrier operations _global_rank = global_rank _global_world_size = global_world_size _timeout_secs = timeout_secs Create single TCP store all barrier operations _tcp_store = dist TCPStore master_address int tcpstore_port world_size=self _global_world_size timeout=timedelta seconds=timeout_barrier_init_secs is_master= _global_rank == execute_barrier - None Execute synchronization barrier using prefix provided during initialization The implementation uses sequence number incremented every time barrier reached The sequence number per barrier prefix allow different barriers operate concurrently barrier_prefix = _barrier_prefix logger info Executing barrier barrier_prefix= s timeout_secs= s barrier_prefix _timeout_secs _rank_key rank int - str f rank rank Track which barrier sequence rank joining _tcp_store set _rank_key _global_rank str _tcp_store_barrier_seq barrier_prefix Execute barrier sequence number specific prefix store_util barrier store=self _tcp_store world_size=self _global_world_size key_prefix= barrier_prefix + str _tcp_store_barrier_seq barrier_prefix _tcp_store_barrier_seq barrier_prefix +=
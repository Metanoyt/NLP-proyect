Owner s oncall fx random torch torch fx symbolic_trace torch fx experimental proxy_tensor make_fx torch fx passes dialect common cse_pass CSEPass get_CSE_banned_ops torch testing _internal common_utils raise_on_run_directly TestCase banned_ops = get_CSE_banned_ops P_default = CSEPass banned_ops=banned_ops check f t delta check_val=True graph_input=False P=None check CSE modified graph ` ` f ` ` has delta less nodes do reduce number nodes further second pass modified returned true only number nodes decreases Args f function checked t tensor passed f delta integer = - If delta = - only checks new graph has less equal number nodes check_val True check output f correct graph_input True f type GraphModule P pass use If None use P_default graph_input fx_g = f fx_g = make_fx f t P None P = P_default res = P fx_g new_g = res graph_module new_graph = new_g graph modified = res modified number nodes decrease stay same old_num_nodes = len fx_g graph nodes new_num_nodes = len new_graph nodes assert new_num_nodes old_num_nodes == modified modified should True number nodes decrease delta == - assertTrue old_num_nodes = new_num_nodes f number nodes increased old_num_nodes new_num_nodes assertTrue old_num_nodes == new_num_nodes + delta f number nodes same old_num_nodes - delta new_num_nodes \n fx_g graph \n new_graph second pass should reduce more nodes res = P new_g pass_ _graph = res graph_module graph pass_ _num_nodes = len pass_ _graph nodes assertTrue pass_ _num_nodes == new_num_nodes f second pass graph has less node pass_ _num_nodes new_num_nodes \n new_graph \n pass_ _graph check correctness check_val true_result = fx_g t our_result = new_g t true_result None both None assertTrue our_result None f true result None CSE result our_result results returned same assertTrue torch all true_result == our_result f results different true_result our_result check results same TestCSEPass TestCase test_nochange f x = x + b = x + = x d = x + b + d t = torch randn check f t test_empty f x pass t = torch randn check f t test_immutable_list_type f x = x sum dim= b = x sum dim= c = x sum d = x sum + b + c + d t = torch randn check f t test_immutable_list_multiple_entries f x = x sum dim= b = x sum dim= c = x sum dim= d = x sum dim= + b + c + d t = torch randn check f t test_simple f x = x cos b = x cos c = + d = b + b c + d t = torch randn check f t test_simple_ f x = x cos sin b = x cos sin c = + d = b + b c + d t = torch randn check f t test_two_args_default f x = x sum dim= b = x sum dim= keepdim=False c = x sum dim= keepdim=False d = x sum dim= + b + c + d t = torch randn check f t test_two_args f x = x sum dim= b = x sum dim= keepdim=True c = x sum dim= keepdim=True d = x sum dim= + b + c + d t = torch randn check f t test_simple_multiple_same_ops f x = x sum b = x sum c = x sum d = x sum + b + c + d t = torch randn check f t test_nested_immutable_list_type f x = torch cat x x b = torch cat x x + b t = torch randn check f t test_kwarg f x = torch ones_like x b = torch ones_like x + b t = torch randn check f t Generate function random ops check result same test_random f x vals = x ops = torch clone torch cos torch tanh torch nn functional gelu _ range new_val = random choice ops random choice vals vals append new_val vals - fx_g = symbolic_trace f fx_g graph eliminate_dead_code fx_g recompile t = torch randn _ range check fx_g t - graph_input=True Test banned list ban ops expected test_banned_list f x = x + b = x + + b t = torch randn P_ban_add = CSEPass banned_ops= torch ops aten add check f t P=P_ban_add check add banned check f t check add banned default test_rand_like f x = torch rand_like x b = torch rand_like x + b t = torch randn check f t check_val=False test_rand_n f x = torch randn b = torch randn + b t = torch randn check f t check_val=False __name__ == __main__ raise_on_run_directly test test_fx py
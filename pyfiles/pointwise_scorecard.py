inspect itertools sys time torch functorch pointwise_operator torch set_num_threads torch _C _debug_set_fusion_group_inlining False rand shape torch rand shape mul add ------------------------------------------------------------------------------ Shape test cases ------------------------------------------------------------------------------ scalar rand rand small rand rand small_ d rand rand small_broadcast rand rand medium rand rand medium_sliced rand rand medium_transpose rand transpose - - rand transpose - - medium rand rand medium d rand rand medium_channels_last rand memory_format=torch channels_last rand memory_format=torch channels_last medium_broadcast rand rand medium_broadcast_channels_last rand memory_format=torch channels_last rand large rand rand large_transpose rand transpose rand transpose large_channels_last rand memory_format=torch channels_last rand memory_format=torch channels_last pathological_broadcast rand rand ------------------------------------------------------------------------------ Operator test cases ------------------------------------------------------------------------------ add b + b sub b - b mul b b div b b relu relu sigmoid sigmoid tanh tanh log log exp exp square fma b b + b hardswish + clamp native_hardswish torch _C _nn hardswish softplus exp log p mish exp log p tanh ------------------------------------------------------------------------------ Helpers ------------------------------------------------------------------------------ time_cpu fn args iters s = time perf_counter _ range iters fn args e = time perf_counter e - s time_cuda fn args iters start = torch cuda Event enable_timing=True end = torch cuda Event enable_timing=True start record _ range iters fn args end record torch cuda synchronize start elapsed_time end e benchmark_with_timer fn args timer timer fn args calibration = timer fn args iters = int calibration timer fn args iters iters benchmark fn args timer = time_cpu args device type == cpu time_cuda benchmark_with_timer fn args timer micros s f s e f shapes = scalar small small_ d small_broadcast medium medium medium d medium_sliced medium_transpose medium_channels_last medium_broadcast medium_broadcast_channels_last large large_transpose large_channels_last pathological_broadcast operators = add sub mul div relu sigmoid tanh log exp square fma hardswish native_hardswish nope = set shape operator itertools product shapes operators nargs = len inspect signature operator parameters args = shape nargs try shape == medium_transpose raise RuntimeError pointwise_operator hangs medium_transpose pw_op = pointwise_operator operator torch testing assert_close operator args pw_op args except Exception print f pointwise_operator failed operator __name__ shape __name__ nope add operator shape ts_op = torch jit script operator torch testing assert_close operator args ts_op args print fuser device operator shape time results = shape operator itertools product shapes operators nargs = len inspect signature operator parameters args = shape nargs result = benchmark operator args print join eager args device type operator __name__ shape __name__ micros result try shape == medium_transpose raise RuntimeError pointwise_operator hangs medium_transpose operator shape nope raise RuntimeError pointwise_operator fails medium_transpose pw_op = pointwise_operator operator result = benchmark pw_op args print join pointwise args device type operator __name__ shape __name__ micros result except Exception print join pointwise args device type operator __name__ shape __name__ micros float nan ts_op = torch jit script operator result = benchmark ts_op args print join fuser args device type operator __name__ shape __name__ micros result sys stdout flush
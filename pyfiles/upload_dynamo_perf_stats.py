__future__ annotations argparse csv hashlib json os re pathlib Path tempfile TemporaryDirectory typing Any tools stats upload_stats_lib download_s _artifacts unzip upload_to_dynamodb ARTIFACTS = test-reports ARTIFACT_REGEX = re compile r test-reports-test- P name \w\- + -\d+-\d+- P runner \w\ - + _ P job \d+ zip get_perf_stats repo str workflow_run_id int workflow_run_attempt int head_branch str match_filename str - list dict str Any match_filename_regex = re compile match_filename perf_stats = TemporaryDirectory temp_dir print Using temporary directory temp_dir os chdir temp_dir artifact ARTIFACTS artifact_paths = download_s _artifacts artifact workflow_run_id workflow_run_attempt Unzip get perf stats csv files path artifact_paths m = ARTIFACT_REGEX match str path m print f Test report path has invalid name Skipping continue test_name = m group name runner = m group runner job_id = m group job Extract all files unzip path csv_file Path glob csv filename = os path splitext os path basename csv_file re match match_filename_regex filename continue print f Processing filename path open csv_file csvfile reader = csv DictReader csvfile delimiter= row reader row update workflow_id workflow_run_id type ignore dict-item run_attempt workflow_run_attempt type ignore dict-item test_name test_name runner runner job_id job_id filename filename head_branch head_branch perf_stats append row Done processing file removing os remove csv_file perf_stats generate_partition_key repo str doc dict str Any - str Generate unique partition key document DynamoDB workflow_id = doc workflow_id job_id = doc job_id test_name = doc test_name filename = doc filename hash_content = hashlib md json dumps doc encode utf- usedforsecurity=False hexdigest f repo workflow_id job_id test_name filename hash_content __name__ == __main__ parser = argparse ArgumentParser description= Upload dynamo perf stats S DynamoDB parser add_argument -- workflow-run-id type=int required=True help= id workflow get perf stats parser add_argument -- workflow-run-attempt type=int required=True help= which retry workflow parser add_argument -- repo type=str required=True help= which GitHub repo workflow run belongs parser add_argument -- head-branch type=str required=True help= head branch workflow parser add_argument -- dynamodb-table type=str required=True help= name DynamoDB table store stats parser add_argument -- match-filename type=str default= help= regex filter list CSV files containing records upload args = parser parse_args perf_stats = get_perf_stats args repo args workflow_run_id args workflow_run_attempt args head_branch args match_filename upload_to_dynamodb dynamodb_table=args dynamodb_table repo=args repo docs=perf_stats generate_partition_key=generate_partition_key
weakref typing cast Optional torch nn nn _State pass _module_state_mapping weakref WeakKeyDictionary nn Module weakref ReferenceType _State = weakref WeakKeyDictionary _insert_module_state module nn Module state _State - None global _module_state_mapping assert module _module_state_mapping f Inserting module more than once _module_state_mapping module = weakref ref state _get_module_state module nn Module - Optional _State Return ` ` _State ` ` ` ` model ` ` Given ` ` module ` ` API finds out module also ` ` _State ` ` instance module managed composable API If module also ` ` _State ` ` ` ` module ` ` will casted ` ` _State ` returned If managed composable API corresponding ` ` _State ` ` will returned global _module_state_mapping isinstance module _State pyrefly ignore redundant-cast cast _State module https github com pytorch pytorch issues module _module_state_mapping state_ref = _module_state_mapping module state = state_ref state None raise AssertionError State has already been garbage collected state None
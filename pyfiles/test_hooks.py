Owner s oncall jit os sys unittest typing Tuple torch jit test_hooks_modules create_forward_tuple_input create_module_forward_multiple_inputs create_module_forward_single_input create_module_hook_return_nothing create_module_multiple_hooks_multiple_inputs create_module_multiple_hooks_single_input create_module_no_forward_input create_module_same_hook_repeated create_submodule_forward_multiple_inputs create_submodule_forward_single_input create_submodule_forward_single_input_return_not_tupled create_submodule_hook_return_nothing create_submodule_multiple_hooks_multiple_inputs create_submodule_multiple_hooks_single_input create_submodule_no_forward_input create_submodule_same_hook_repeated create_submodule_to_call_directly_with_hooks ModuleDirectforwardSubmodCall ModuleForwardSingleInput ModuleForwardTupleInput Make helper files test importable pytorch_test_dir = os path dirname os path dirname os path realpath __file__ sys path append pytorch_test_dir torch testing _internal common_utils raise_on_run_directly torch testing _internal jit_utils JitTestCase Tests JIT forward hooks pre-hooks TestHooks JitTestCase test_module_no_forward_input checkModule create_module_no_forward_input test_submodule_no_forward_input checkModule create_submodule_no_forward_input test_module_forward_multiple_inputs checkModule create_module_forward_multiple_inputs no_pre_hook test_module_multiple_hooks_multiple_inputs checkModule create_module_multiple_hooks_multiple_inputs no_pre_hook test_module_forward_single_input checkModule create_module_forward_single_input test_module_same_hook_repeated checkModule create_module_same_hook_repeated test_module_hook_return_nothing checkModule create_module_hook_return_nothing test_module_multiple_hooks_single_input checkModule create_module_multiple_hooks_single_input test_submodule_forward_multiple_inputs checkModule create_submodule_forward_multiple_inputs no_pre_hook test_submodule_multiple_hooks_multiple_inputs checkModule create_submodule_multiple_hooks_multiple_inputs no_pre_hook test_submodule_forward_single_input checkModule create_submodule_forward_single_input test_submodule_called_directly_with_hooks module = create_submodule_to_call_directly_with_hooks module_scripted = torch jit script module submodule = module submodule scripted_submodule = module_scripted submodule assertEqual submodule scripted_submodule test_submodule_same_hook_repeated checkModule create_submodule_same_hook_repeated test_submodule_hook_return_nothing checkModule create_submodule_hook_return_nothing test_submodule_multiple_hooks_single_input checkModule create_submodule_multiple_hooks_single_input test_forward_tuple_input checkModule create_forward_tuple_input test_submodule_forward_single_input_return_not_tupled checkModule create_submodule_forward_single_input_return_not_tupled test_hook_method_name_collision Hooks can t have same name methods m = ModuleForwardSingleInput outer_mod_name inner_mod_name foo input Tuple str - Tuple str assert name == inner_mod_name assert input == a_outermod pre_hook_override_name m submodule register_forward_pre_hook foo assertRaisesRegex RuntimeError Can t define hook foo + because method hook name already exists torch jit script m test_hook_hook_name_collision Test edge case two hooks sharing name python definition m = ModuleForwardSingleInput outer_mod_name inner_mod_name prehook input Tuple str - Tuple str This first hook m submodule register_forward_pre_hook prehook prehook input Tuple str - Tuple str This second hook m submodule register_forward_pre_hook prehook assertRaisesRegex RuntimeError Pre-hook + + has least two different python definitions Please use unique names all hooks torch jit script m m = ModuleForwardSingleInput outer_mod_name inner_mod_name hook input Tuple str output str This first hook m submodule register_forward_hook hook hook input Tuple str This second hook m submodule register_forward_hook hook assertRaisesRegex RuntimeError Hook + + has least two different python definitions Please use unique names all hooks torch jit script m test_module_direct_forward_invocation Test hooks only invoked when module called directly when forward called m = ModuleForwardSingleInput outer_mod_name inner_mod_name pre_hook input Tuple str - Tuple str pre_hook_override_name forward_hook input Tuple str output str assert name == outer_mod_name assert input == pre_hook_override_name output = output + _fh output m register_forward_pre_hook pre_hook m register_forward_hook forward_hook m_scripted = torch jit script m assertEqual m forward m_scripted forward assertNotEqual m_scripted m_scripted forward test_submodule_direct_forward_invocation m_submod_forward_call = ModuleDirectforwardSubmodCall outer_mod_name inner_mod_name m_submod_call = ModuleForwardSingleInput outer_mod_name inner_mod_name pre_hook input Tuple str - Tuple str pre_hook_override_name forward_hook input Tuple str output str assert input == pre_hook_override_name output + _fh m_submod_forward_call submodule register_forward_pre_hook pre_hook m_submod_forward_call submodule register_forward_hook forward_hook m_submod_call submodule register_forward_pre_hook pre_hook m_submod_call submodule register_forward_hook forward_hook m_submod_forward_call_scripted = torch jit script m_submod_forward_call m_submod_call_scripted = torch jit script m_submod_call assertEqual m_submod_forward_call_scripted m_submod_forward_call assertNotEqual m_submod_forward_call_scripted m_submod_call_scripted TODO add test back once figured out how print error msg unittest skip test_hook_compilation_hint Tests hook error message printed out erroring after schema check Useful when user scripting hooks while aware m = ModuleForwardSingleInput outer_mod_name inner_mod_name pre_hook input Tuple str - Tuple str assert name == outer_mod_name assert input == out bounds tuple range pre_hook_override_name m register_forward_pre_hook pre_hook assertRaisesRegex RuntimeError This error occurred while scripting forward pre-hook pre_hook torch jit script m test_wrong_pre_hook_signatures correct signature pre_hook_c input Tuple str pre_hook_wrong_input input Tuple None - Tuple str hello m = ModuleForwardSingleInput outer_mod_name inner_mod_name m register_forward_pre_hook pre_hook_wrong_input assertRaisesRegex RuntimeError has wrong inner types input tuple argument torch jit script m pre_hook_wrong_input input Tuple str input str - Tuple str hello m = ModuleForwardSingleInput outer_mod_name inner_mod_name m register_forward_pre_hook pre_hook_wrong_input assertRaisesRegex RuntimeError expected only have exactly inputs had inputs torch jit script m pre_hook_wrong_input input int - Tuple str hello m = ModuleForwardSingleInput outer_mod_name inner_mod_name m register_forward_pre_hook pre_hook_wrong_input assertRaisesRegex RuntimeError expected input argument typed Tuple found type int instead torch jit script m pre_hook_wrong_output input Tuple str - int expecting Tuple str str None m = ModuleForwardSingleInput outer_mod_name inner_mod_name m register_forward_pre_hook pre_hook_wrong_output assertRaisesRegex RuntimeError returned wrong type int torch jit script m pre_hook_no_output_annotation input Tuple str expecting Tuple str str None m = ModuleForwardSingleInput outer_mod_name inner_mod_name m register_forward_pre_hook pre_hook_no_output_annotation assertRaisesRegex RuntimeError missing annotation Return annotations required please add one torch jit script m pre_hook_wrong_tuple_return input Tuple Tuple int - Tuple int doesn t work eager inner tuple lost m = ModuleForwardTupleInput outer_mod_name inner_mod_name m register_forward_pre_hook pre_hook_wrong_tuple_return assertRaisesRegex RuntimeError When forward has single tuple input argument needs None nested tuple containing r forward s input tuple argument Tuple\ Tuple\ int\ \ torch jit script m test_wrong_hook_signatures correct signature forward_hook input Tuple str output str forward_hook_wrong_input input Tuple str str output str output m = ModuleForwardSingleInput outer_mod_name inner_mod_name m register_forward_hook forward_hook_wrong_input assertRaisesRegex RuntimeError has wrong number contained types r input argument s Tuple Received type Tuple\ str str\ torch jit script m forward_hook_wrong_input input str output str output m = ModuleForwardSingleInput outer_mod_name inner_mod_name m register_forward_hook forward_hook_wrong_input assertRaisesRegex RuntimeError expected input argument typed Tuple found type str instead torch jit script m forward_hook_wrong_input input Tuple None output str output m = ModuleForwardSingleInput outer_mod_name inner_mod_name m register_forward_hook forward_hook_wrong_input assertRaisesRegex RuntimeError has wrong inner types input tuple r argument Received type Tuple\ NoneType\ torch jit script m forward_hook_wrong_output input Tuple str output Tuple str output m = ModuleForwardSingleInput outer_mod_name inner_mod_name m register_forward_hook forward_hook_wrong_output assertRaisesRegex RuntimeError has wrong type output argument Received r type Tuple\ str\ Expected type str torch jit script m forward_hook_correct input Tuple str output str output forward_hook_wrong_output_from_prev_hook input Tuple str output str output m = ModuleForwardSingleInput outer_mod_name inner_mod_name m register_forward_hook forward_hook_correct m register_forward_hook forward_hook_wrong_output_from_prev_hook assertRaisesRegex RuntimeError has wrong type output argument r Received type str Expected type Tuple\ str\ torch jit script m __name__ == __main__ raise_on_run_directly test test_jit py
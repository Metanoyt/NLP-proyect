functools collections defaultdict torch torch _export passes _node_metadata_hook _node_metadata_hook _set_node_metadata_hook torch _library fake_profile OpProfile TensorMetadata insert_custom_op_guards gm torch fx GraphModule ops_to_guard set str - None This used draft_export insert guards front calls custom operators which have generated fake kernel node gm graph nodes node op == call_function str node target ops_to_guard _set_node_metadata_hook gm functools partial _node_metadata_hook metadata= stack_trace node meta get stack_trace gm graph inserting_before node arg node args node kwargs values isinstance arg torch fx Node isinstance arg meta get val torch Tensor val = arg meta val gm graph call_function torch ops aten _assert_tensor_metadata default args= arg kwargs= dtype val dtype device val device layout val layout gm recompile get_op_profiles gm torch fx GraphModule ops_to_guard set str - dict str set OpProfile This used draft_export get list custom operator profiles so we can generate fake kernels _get_op_profile node torch fx Node - OpProfile args_profile = tuple TensorMetadata maybe_from_tensor arg meta get val isinstance arg torch fx Node None arg node args node kwargs values out_profile = None meta = node meta get val assert meta None isinstance meta torch Tensor out_profile = TensorMetadata maybe_from_tensor meta isinstance meta list tuple out_profile = tuple TensorMetadata maybe_from_tensor m m meta type ignore assignment assert out_profile None OpProfile args_profile out_profile type ignore arg-type op_profiles dict str set OpProfile = defaultdict set node gm graph nodes node op == call_function str node target ops_to_guard op_profiles str node target add _get_op_profile node op_profiles
mypy disallow-untyped-defs json logging os re subprocess datetime datetime socket gethostname typing Any Optional torch _strobelight cli_function_profiler StrobelightCLIFunctionProfiler logger = logging getLogger strobelight_compile_time_profiler console_handler = logging StreamHandler formatter = logging Formatter name s line lineno d asctime s levelname s message s console_handler setFormatter formatter logger addHandler console_handler logger setLevel logging INFO logger propagate = False get_fburl url str - str short_url = url Attempt shorten URL try result = subprocess run fburl url capture_output=True stdin=subprocess DEVNULL result returncode == short_url = result stdout decode utf- except Exception e logger warning URL shortening failed s using long URL repr e short_url get_strobelight_url identifier str - str scuba_json = aggregateList aggregation_field async_stack_complete b_constraints c_constraints cols namespace_id namespace_process_id compare none constraints column sample_tags op all value f identifier derivedCols end now enumCols filterMode DEFAULT hideEmptyColumns false ignoreGroupByInComparison false is_timeseries false mappedCols metric count modifiers order weight order_desc true param_dimensions dim py_async_stack op edge param anchor purposes return_remainder false samplingRatio should_pivot false start - days timezone America Los_Angeles top scuba_url_prefix = https www internalfb com intern scuba query dataset=pyperf_experimental on_demand drillstate= scuba_url_suff = view=GraphProfilerView normalized= pool=uber long_url = scuba_url_prefix + json dumps scuba_json + scuba_url_suff get_fburl long_url StrobelightCompileTimeProfiler success_profile_count int = failed_profile_count int = ignored_profile_runs int = inside_profile_compile_time bool = False enabled bool = False A regex can used filter out what frames profile ex frame_id_filter Optional str = os environ get COMPILE_STROBELIGHT_FRAME_FILTER A unique identifier used run_user_name strobelight profile associate all compile time profiles together identifier Optional str = None current_phase Optional str = None profiler Optional Any = None max_stack_length int = int os environ get COMPILE_STROBELIGHT_MAX_STACK_LENGTH max_profile_time int = int os environ get COMPILE_STROBELIGHT_MAX_PROFILE_TIME Collect sample each x cycles sample_each int = int float os environ get COMPILE_STROBELIGHT_SAMPLE_RATE e classmethod get_frame cls - str torch _guards CompileContext str CompileContext current_trace_id classmethod enable cls profiler_class Any = StrobelightCLIFunctionProfiler - None cls enabled logger info compile time strobelight profiling already enabled logger info compile time strobelight profiling enabled profiler_class StrobelightCLIFunctionProfiler shutil shutil which strobeclient logger info strobeclient found can t enable compile time strobelight profiling seems like you FB machine cls enabled = True cls _cls_init profiler_class should have public API similar StrobelightCLIFunctionProfiler we have pass different functionProfilerClass meta-internal fbcode targets NB actual implementation Meta fbcode caffe fb strobelight function_profiler py cls profiler = profiler_class sample_each=cls sample_each max_profile_duration_sec=cls max_profile_time stack_max_len=cls max_stack_length async_stack_max_len=cls max_stack_length run_user_name= pt -profiler + os environ get USER os environ get USERNAME sample_tags= cls identifier pyrefly ignore bad-argument-type classmethod _cls_init cls - None cls identifier = date pid hostname format date=datetime now strftime Y- m- d- H M S pid=os getpid hostname=gethostname logger info Unique sample tag run s cls identifier logger info URL access strobelight profile end run s get_strobelight_url cls identifier classmethod _log_stats cls - None logger info s strobelight success runs out s non-recursive compilation events cls success_profile_count cls success_profile_count + cls failed_profile_count TODO use threadlevel meta data tags record phases classmethod profile_compile_time cls func Any phase_name str args Any kwargs Any - Any skip - Any func args kwargs cls enabled skip cls profiler None logger error profiler set frame_id = cls get_frame cls inside_profile_compile_time cls ignored_profile_runs += logger info profile_compile_time requested phase s frame s while already running phase s frame s recursive call ignored phase_name frame_id cls current_phase frame_id skip cls frame_id_filter None should_run = re match cls frame_id_filter frame_id None should_run logger info profiling frame s skipped due frame_id_filter s frame_id cls frame_id_filter skip cls inside_profile_compile_time = True cls current_phase = phase_name logger info profiling frame s frame_id work_result = cls profiler profile func args kwargs cls profiler profile_result None cls success_profile_count += cls failed_profile_count += cls _log_stats cls inside_profile_compile_time = False work_result
functools os typing Any typing_extensions Unpack triton_compat ASTSource CompiledKernel knobs triton_knobs triton_helpers get_constexprs StaticallyLaunchedCudaKernel Parses metadata CompiledKernel Triton into structure can launch cuda kernel directly Only works triton kernels compiled cubin Doing avoids C++ codegen compilation during compile since we can use statically compiled library launch kernel To avoid mallocing arguments we have launcher different numbers arguments up max StaticCudaLauncher only supports arguments up until now Workflow Compile time Compile kernel triton get CompiledKernel Instantiate kernel = StaticallyLaunchedCudaKernel triton_kernel Write cubin file kernel write_cubin_to_file filepath Call kernel load_kernel CUDA should initialized point load cubin Runtime Call kernel run grid stream args launch kernel Note after step StaticallyLaunchedCudaKernel fully pickleable serializable This allows cached FXGraphCache TritonBundler well sent worker parent process inductor There two main versions triton we wish support Triton makes considerable changes how handles constants so there s some special logic necessary handle both versions __init__ kernel CompiledKernel - None pyrefly ignore missing-attribute name = kernel src fn __name__ pyrefly ignore missing-attribute cubin_raw = kernel asm get cubin None pyrefly ignore missing-attribute cubin_path = kernel _cubin_path Used torch compile filter constants older triton versions pyrefly ignore missing-attribute arg_names = kernel src fn arg_names Const exprs declared triton kernel directly Used generate kernel launcher s args pyrefly ignore missing-attribute declared_constexprs = get_constexprs kernel src fn pyrefly ignore missing-attribute hash = kernel hash triton_knobs None pyrefly ignore missing-attribute launch_enter = kernel __class__ launch_enter_hook pyrefly ignore missing-attribute launch_exit = kernel __class__ launch_exit_hook launch_enter = triton_knobs runtime launch_enter_hook launch_exit = triton_knobs runtime launch_exit_hook hook_is_empty hook Any - bool hook None True triton_knobs HookChain = getattr triton_knobs HookChain None None isinstance hook HookChain Support hooks after https github com triton-lang triton pull len hook calls == False hook_is_empty launch_enter hook_is_empty launch_exit raise NotImplementedError We don t support launch enter launch exit hooks pyrefly ignore missing-attribute num_warps = kernel metadata num_warps shared = pyrefly ignore missing-attribute kernel shared hasattr kernel shared kernel metadata shared needs_scratch_arg scratch_name str param_name str - bool pyrefly ignore missing-attribute hasattr kernel metadata param_name getattr kernel metadata param_name raise NotImplementedError f scratch_name scratch yet supported True False Newer triton versions pass extra global scratch parameter compiled cuda kernel Inductor never uses field enables we still have pass extra None into set params its enabled has_global_scratch = needs_scratch_arg Global global_scratch_size same situation profile scratch - triton-lang triton# has_profile_scratch = needs_scratch_arg Profile profile_scratch_size pyrefly ignore missing-attribute arg_tys = arg_ty_from_signature kernel src function int &#124; None = None Loaded load_kernel parent process num_ctas = hasattr kernel num_ctas num_ctas = kernel num_ctas hasattr kernel metadata num_ctas = kernel metadata num_ctas num_ctas = raise NotImplementedError Static cuda launcher only supports num_ctas == reload_cubin_from_raw filepath str - str If cubin file triton generated gets deleted under us we can reload raw cubin file cubin_path None assert cubin_raw None os makedirs os path dirname filepath exist_ok=True open filepath wb f f write cubin_raw cubin_path = filepath cubin_path load_kernel device int - None torch _C _StaticCudaLauncher function None assert hasattr cubin_path assert cubin_path None function n_regs n_spills = _StaticCudaLauncher _load_kernel cubin_path name shared device Don t need cubin path anymore now we ve loaded cubin_path = None cubin_raw = None staticmethod functools lru_cache type_mappings - dict str str i i i b i h i i i l u I u B u H u I u K fp f bf f fp f f f fp d TODO handle nvTmaDesc CUtensormap extract_type ty str - str Takes triton type CompiledKernel signature converts into single char encoding _StaticCudaLauncher will switch char figure out what type underlying value should passed triton kernel ty == O ty == nvTmaDesc raise NotImplementedError nvTmaDesc kernels yet supported StaticallyLaunchedCudaKernel type_mappings ty arg_ty_from_signature src ASTSource - str index_key i Any - int isinstance i str pyrefly ignore missing-attribute src fn arg_names index i isinstance i tuple In triton src fn constants has tuples key i i pyrefly ignore missing-attribute signature = index_key key value key value src signature items Triton uses these main way filter out constants passed their cubin constants = index_key key key getattr src constants dict This value always superset kernel fn constexprs kernel fn constexprs constants declared triton kernel directly whereas list can have constants unused triton kernel triton figured out during compilation full_constexprs = constants Despite requiring them passed triton CUDA launcher completely ignores constexprs passed into when generating code So we can ignore them here too params = i sorted signature keys ty = signature i In newer triton versions constants passed signature type ` constexpr ` In older triton versions there can constants src constants ` constexpr ` signature so we check both here ty == constexpr i constants pass pyrefly ignore bad-argument-type params append extract_type ty join params __getstate__ - dict str Any Remove objects no longer valid pickling state = __dict__ copy state function = None Cubin paths aren t consistent across processes so we clear reload them state cubin_path = None state run grid_x int grid_y int grid_z int stream int args Unpack tuple object - None Actually run kernel runtime This function hot codepath torch _C _StaticCudaLauncher Assert load_kernel has been called args match assert function None TODO actually args don t match we probably should throw exception But inductor only one calling thing should always match Get rid constants before passing cubin launcher Add None triton wants extra parameters scratch spaces arg_tys = arg_tys has_scratch has_global_scratch has_profile_scratch has_scratch arg_tys = arg_tys + O args = args None pyrefly ignore bad-argument-type assert len args == len arg_tys TODO can handle grid functions here C++ so we don t need grid handler above _StaticCudaLauncher _launch_kernel function grid_x grid_y grid_z num_warps shared arg_tys pyrefly ignore bad-argument-type args stream
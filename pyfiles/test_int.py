======= BEGIN Dynamo patch ======= Owner s module dynamo ruff noqa flake noqa Test copied https raw githubusercontent com python cpython refs tags v Lib test test_int py sys torch torch _dynamo test_case unittest torch _dynamo test_case CPythonTestCase torch testing _internal common_utils run_tests skipIfTorchDynamo __TestCase = CPythonTestCase redirect statements sys importlib abc redirect_imports = test mapping_tests test typinganndata test test_grammar test test_math test test_iter test typinganndata ann_module RedirectImportFinder importlib abc MetaPathFinder find_spec fullname path target=None Check problematic one fullname redirect_imports try Attempt standalone module name = fullname removeprefix test r = importlib import_module name Redirect module sys modules sys modules fullname = r Return module spec found module importlib util find_spec name except ImportError None None Add custom finder sys meta_path sys meta_path insert RedirectImportFinder ======= END DYNAMO PATCH ======= sys time unittest unittest mock test support VALID_UNDERSCORE_LITERALS = _ _ _ _ _ b _ xffff_ffff o _ _ _ _ _ _ e _ _ e _ e _ _ _ e b_ x_f o_ _ _ j _ _ j _ _ e _ j _ j _ + _ j _ j INVALID_UNDERSCORE_LITERALS = Trailing underscores _ _ j_ x_ b _ xf_ o _ _Else Underscores base selector _b _xf _o Old-style octal still disallowed _ _ Multiple consecutive underscores _______ __ __ j b __ xffff__ffff x___ o __ e __ e __ j Underscore right before dot _ _ j Underscore right after dot _ _ j _ _ j Underscore right after sign e+_ e+_ j Underscore right before j _j e _j Underscore right before e _e _e _e j Underscore right after e e_ e_ e_ j Complex cases parens + _j_ + _j try _pylong except ImportError _pylong = None L = \t\t \t\t repr sys maxsize sys maxsize x ValueError \ ValueError ValueError ValueError \t\t ValueError \u ValueError IntSubclass int pass IntTestCases __TestCase test_basic assertEqual int assertEqual int Check conversion float truncates towards zero assertEqual int - - assertEqual int assertEqual int - - assertEqual int assertEqual int - - assertEqual int - - assertEqual int - - assertEqual int \N EM SPACE - \N EN SPACE - Different base assertEqual int Test conversion strings various anomalies s v L sign + - prefix \t \t\t ss = prefix + sign + s vv = v sign == - v ValueError vv = -v try assertEqual int ss vv except ValueError pass s = repr - -sys maxsize x = int s assertEqual x+ -sys maxsize assertIsInstance x int should int assertEqual int s sys maxsize+ should int x = int e assertIsInstance x int x = int - e assertIsInstance x int SF bug x = x Worked accident Windows release build failed debug build Failed all Linux builds x = - -sys maxsize assertEqual x x x = int assertIsInstance x int assertRaises TypeError int assertRaises TypeError int assertEqual int o assertEqual int x Bug x valid hex literal assertRaises ValueError int x assertRaises ValueError int x assertRaises ValueError int o assertRaises ValueError int o assertRaises ValueError int b assertRaises ValueError int b SF bug int string base wrong answers Various representations evaluated rather than previous versions assertEqual int assertEqual int assertEqual int assertEqual int assertEqual int assertEqual int assertEqual int assertEqual int assertEqual int assertEqual int assertEqual int ba assertEqual int assertEqual int ca b assertEqual int dcd assertEqual int assertEqual int ffda assertEqual int he g assertEqual int f aff assertEqual int ai g assertEqual int d i assertEqual int fj b assertEqual int k ic assertEqual int mb ag assertEqual int hek mgl assertEqual int dnchbnm assertEqual int b jpdm assertEqual int pfgih assertEqual int beigg assertEqual int qmcpqg assertEqual int q jto assertEqual int assertEqual int aokq assertEqual int qhxjli assertEqual int br qb assertEqual int z z tests base fails x old octal syntax allowed assertEqual int o assertEqual int o assertEqual int assertEqual int o assertEqual int x assertEqual int b assertEqual int O assertEqual int X assertEqual int B assertRaises ValueError int without base still base assertEqual int assertEqual int tests prefix base = assertEqual int x assertEqual int o assertEqual int b assertEqual int X assertEqual int O assertEqual int B code has special checks first character after type prefix assertRaises ValueError int b assertRaises ValueError int b assertRaises ValueError int B assertRaises ValueError int B assertRaises ValueError int o assertRaises ValueError int o assertRaises ValueError int O assertRaises ValueError int O assertRaises ValueError int xg assertRaises ValueError int x g assertRaises ValueError int Xg assertRaises ValueError int X g SF bug int string base wrong answers Checks proper evaluation + assertEqual int assertEqual int assertEqual int assertEqual int assertEqual int assertEqual int assertEqual int assertEqual int assertEqual int assertEqual int assertEqual int ba assertEqual int assertEqual int ca b assertEqual int dcd assertEqual int assertEqual int ffda assertEqual int he g assertEqual int f aff assertEqual int ai h assertEqual int d i assertEqual int fj b assertEqual int k id assertEqual int mb ah assertEqual int hek mgm assertEqual int dnchbnn assertEqual int b jpdn assertEqual int pfgih assertEqual int beigh assertEqual int qmcpqh assertEqual int q jto assertEqual int assertEqual int aokq assertEqual int qhxjlj assertEqual int br qc assertEqual int z z test_invalid_signs assertRaises ValueError int + assertRaises ValueError int - assertRaises ValueError int - assertRaises ValueError int + assertRaises ValueError int + test_unicode assertEqual int १२३४५६७८९० assertEqual int ١٢٣٤٥٦٧٨٩٠ assertEqual int १२३४५६७८९० assertEqual int ١٢٣٤٥٦٧٨٩٠ test_underscores lit VALID_UNDERSCORE_LITERALS any ch lit ch eEjJ continue assertEqual int lit eval lit assertEqual int lit int lit replace _ lit INVALID_UNDERSCORE_LITERALS any ch lit ch eEjJ continue assertRaises ValueError int lit Additional test cases bases = only constructor assertEqual int _ assertEqual int _ valid literal assertEqual int b _ byte underscore assertRaises ValueError int _ assertRaises ValueError int +_ assertRaises ValueError int __ assertRaises ValueError int _ support cpython_only test_small_ints Bug Return small longs PyLong_FromString assertIs int assertIs int - - assertIs int b assertIs int b - - test_no_args assertEqual int test_keyword_args Test invoking int using keyword arguments assertEqual int base= assertRaisesRegex TypeError keyword argument int x= assertRaisesRegex TypeError keyword argument int x= base= assertRaises TypeError int base= assertRaises TypeError int base= test_int_base_limits Testing supported limits int base parameter assertEqual int assertRaises ValueError int assertRaises ValueError int assertRaises ValueError int - An old magic value base Python assertRaises ValueError int base= - assertRaises ValueError int base= Bases through supported base range assertEqual int base=base test_int_base_bad_types Not integer types valid bases issue assertRaises TypeError int assertRaises TypeError int test_int_base_indexable torch _dynamo error_on_graph_break False torch _dynamo error_on_graph_break False MyIndexable object __init__ value value = value __index__ value Check out range bases base - assertRaises ValueError int base Check in-range bases assertEqual int base=MyIndexable assertEqual int base=MyIndexable assertEqual int base=MyIndexable + test_non_numeric_input_types Test possible non-numeric types argument x including subclasses explicitly documented accepted types torch _dynamo error_on_graph_break False CustomStr str pass CustomBytes bytes pass CustomByteArray bytearray pass factories = bytes bytearray lambda b CustomStr b decode CustomBytes CustomByteArray memoryview try array array except ImportError pass factories append lambda b array B b f factories x = f b subTest type x assertEqual int x isinstance x str bytes bytearray assertEqual int x msg = can t convert non-string assertRaisesRegex TypeError msg int x assertRaisesRegex ValueError invalid literal int f b A x test_int_memoryview assertEqual int memoryview b assertEqual int memoryview b \x assertEqual int memoryview b assertEqual int memoryview b A assertEqual int memoryview b test_string_float assertRaises ValueError int test_intconversion Test __int__ torch _dynamo error_on_graph_break False ClassicMissingMethods pass assertRaises TypeError int ClassicMissingMethods torch _dynamo error_on_graph_break False MissingMethods object pass assertRaises TypeError int MissingMethods torch _dynamo error_on_graph_break False Foo __int__ assertEqual int Foo torch _dynamo error_on_graph_break False Classic pass base object Classic torch _dynamo error_on_graph_break False IntOverridesTrunc base __int__ __trunc__ - assertEqual int IntOverridesTrunc torch _dynamo error_on_graph_break False JustTrunc base __trunc__ assertWarns DeprecationWarning assertEqual int JustTrunc torch _dynamo error_on_graph_break False ExceptionalTrunc base __trunc__ assertRaises ZeroDivisionError \ assertWarns DeprecationWarning int ExceptionalTrunc trunc_result_base object Classic torch _dynamo error_on_graph_break False Index trunc_result_base __index__ TruncReturnsNonInt base __trunc__ Index assertWarns DeprecationWarning assertEqual int TruncReturnsNonInt torch _dynamo error_on_graph_break False Intable trunc_result_base __int__ TruncReturnsNonIndex base __trunc__ Intable assertWarns DeprecationWarning assertEqual int TruncReturnsNonInt torch _dynamo error_on_graph_break False NonIntegral trunc_result_base __trunc__ Check we avoid infinite recursion NonIntegral TruncReturnsNonIntegral base __trunc__ NonIntegral try assertWarns DeprecationWarning int TruncReturnsNonIntegral except TypeError e assertEqual str e __trunc__ returned non-Integral type NonIntegral fail Failed raise TypeError s base trunc_result_base torch _dynamo error_on_graph_break False Regression test bugs python org issue BadInt trunc_result_base __int__ TruncReturnsBadInt base __trunc__ BadInt assertRaises TypeError \ assertWarns DeprecationWarning int TruncReturnsBadInt test_int_subclass_with_index torch _dynamo error_on_graph_break False MyIndex int __index__ BadIndex int __index__ my_int = MyIndex assertEqual my_int assertEqual int my_int assertEqual int BadIndex test_int_subclass_with_int torch _dynamo error_on_graph_break False MyInt int __int__ BadInt int __int__ my_int = MyInt assertEqual my_int assertEqual int my_int my_int = BadInt assertEqual my_int assertRaises TypeError int my_int test_int_returns_int_subclass torch _dynamo error_on_graph_break False BadIndex __index__ True BadIndex int __index__ True BadInt __int__ True BadInt int __int__ True TruncReturnsBadIndex __trunc__ BadIndex TruncReturnsBadInt __trunc__ BadInt TruncReturnsIntSubclass __trunc__ True bad_int = BadIndex assertWarns DeprecationWarning n = int bad_int assertEqual n assertIs type n int bad_int = BadIndex n = int bad_int assertEqual n assertIs type n int bad_int = BadInt assertWarns DeprecationWarning n = int bad_int assertEqual n assertIs type n int bad_int = BadInt assertWarns DeprecationWarning n = int bad_int assertEqual n assertIs type n int bad_int = TruncReturnsBadIndex assertWarns DeprecationWarning n = int bad_int assertEqual n assertIs type n int bad_int = TruncReturnsBadInt assertWarns DeprecationWarning assertRaises TypeError int bad_int good_int = TruncReturnsIntSubclass assertWarns DeprecationWarning n = int good_int assertEqual n assertIs type n int assertWarns DeprecationWarning n = IntSubclass good_int assertEqual n assertIs type n IntSubclass skipIfTorchDynamo flaky under dynamo test_error_message check s base=None assertRaises ValueError msg= int r r s base cm base None int s int s base assertEqual cm exception args invalid literal int base d r base None base s check \xbd check \xbd check check \x SF bug embedded NULs detected explicit base check \x check \x check \x check \x check \x byte string embedded NUL check b \x check b \x non-UTF- byte string check b \xbd check b \xbd lone surrogate Unicode string check \ud check \ud test_issue assertEqual int _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ b assertEqual int _ _ _ _ _ _ _ _ _ _ o assertEqual int _ _ _ _ _ _ _ _ x assertEqual int _ _ _ _ _ _ IntStrDigitLimitsTests __TestCase int_class = int Override subclasses reuse suite setUp super setUp _previous_limit = sys get_int_max_str_digits sys set_int_max_str_digits tearDown sys set_int_max_str_digits _previous_limit super tearDown test_disabled_limit assertGreater sys get_int_max_str_digits assertLess sys get_int_max_str_digits _ support adjust_int_max_str_digits assertEqual sys get_int_max_str_digits i = int_class _ str i assertGreater sys get_int_max_str_digits test_max_str_digits_edge_cases Ignore + - sign space padding int_class = int_class maxdigits = sys get_int_max_str_digits int_class maxdigits int_class + maxdigits int_class maxdigits + int_class + + maxdigits int_class - + maxdigits assertEqual len str maxdigits - maxdigits check i base=None assertRaises ValueError base None int_class i int_class i base test_max_str_digits maxdigits = sys get_int_max_str_digits check maxdigits + check + maxdigits + check maxdigits + + check + + maxdigits + check - + maxdigits + check maxdigits + i = maxdigits assertRaises ValueError str i test_denial_of_service_prevented_int_to_str Regression test ensure we fail before performing O N work maxdigits = sys get_int_max_str_digits assert maxdigits _ maxdigits A test prerequisite huge_int = int f x c _ base= decimal digits digits = _ support adjust_int_max_str_digits digits support CPUStopwatch sw_convert huge_decimal = str huge_int assertEqual len huge_decimal digits Ensuring we chose slow enough conversion measure It takes seconds Zen based cloud VM opt build Some OSes have low res s timer skip hard measure sw_convert seconds sw_convert clock_info resolution raise unittest SkipTest slow conversion took only f sw_convert seconds seconds We test limit almost size needed check performance The performant limit check slightly fuzzy give some room support adjust_int_max_str_digits int digits assertRaises ValueError err support CPUStopwatch sw_fail_huge str huge_int assertIn conversion str err exception assertLessEqual sw_fail_huge seconds sw_convert seconds Now we test conversion would take x long also fails similarly fast fashion extra_huge_int = int f x c _ base= digits assertRaises ValueError err support CPUStopwatch sw_fail_extra_huge If limited seconds said Zen based cloud VM str extra_huge_int assertIn conversion str err exception assertLess sw_fail_extra_huge seconds sw_convert seconds test_denial_of_service_prevented_str_to_int Regression test ensure we fail before performing O N work maxdigits = sys get_int_max_str_digits assert maxdigits _ maxdigits A test prerequisite digits = huge = digits support adjust_int_max_str_digits digits support CPUStopwatch sw_convert int huge Ensuring we chose slow enough conversion measure It takes seconds Zen based cloud VM opt build Some OSes have low res s timer skip hard measure sw_convert seconds sw_convert clock_info resolution raise unittest SkipTest slow conversion took only f sw_convert seconds seconds support adjust_int_max_str_digits digits - assertRaises ValueError err support CPUStopwatch sw_fail_huge int huge assertIn conversion str err exception assertLessEqual sw_fail_huge seconds sw_convert seconds Now we test conversion would take x long also fails similarly fast fashion extra_huge = _ _ assertRaises ValueError err support CPUStopwatch sw_fail_extra_huge If limited seconds Zen based cloud VM int extra_huge assertIn conversion str err exception assertLessEqual sw_fail_extra_huge seconds sw_convert seconds test_power_of_two_bases_unlimited The limit does apply power bases maxdigits = sys get_int_max_str_digits base subTest base=base int_class maxdigits + base assert maxdigits _ int_class _ base test_underscores_ignored maxdigits = sys get_int_max_str_digits triples = maxdigits s = triples s_ = _ triples int_class s succeeds int_class s_ succeeds check f s check f s_ _ test_sign_not_counted int_class = int_class max_digits = sys get_int_max_str_digits s = max_digits i = int_class s pos_i = int_class f + s assert i == pos_i neg_i = int_class f - s assert -pos_i == neg_i str pos_i str neg_i _other_base_helper base int_class = int_class max_digits = sys get_int_max_str_digits s = max_digits i = int_class s base base assertRaises ValueError str i base str i assertRaises ValueError err int_class f s base test_int_from_other_bases base = subTest base=base _other_base_helper base base = subTest base=base _other_base_helper base test_int_max_str_digits_is_per_interpreter Changing limit one interpreter does change others code = Subinterpreters maintain enforce their own limit sys sys set_int_max_str_digits try int except ValueError pass raise AssertionError Expected int max str digits ValueError support adjust_int_max_str_digits before_value = sys get_int_max_str_digits assertEqual support run_in_subinterp code subinterp code failure check stderr after_value = sys get_int_max_str_digits assertEqual before_value after_value IntSubclassStrDigitLimitsTests IntStrDigitLimitsTests int_class = IntSubclass PyLongModuleTests __TestCase Tests functions _pylong py Those get used when number digits input values large enough setUp super setUp _previous_limit = sys get_int_max_str_digits sys set_int_max_str_digits tearDown sys set_int_max_str_digits _previous_limit super tearDown _test_pylong_int_to_decimal n suffix s = str n assertEqual s - suffix s = str -n assertEqual s - + s s = d n assertEqual s s s = b d n assertEqual s s encode ascii test_pylong_int_to_decimal _test_pylong_int_to_decimal _ _test_pylong_int_to_decimal _ - _test_pylong_int_to_decimal _ _test_pylong_int_to_decimal _ - _test_pylong_int_to_decimal _ support requires_resource cpu test_pylong_int_to_decimal_ _test_pylong_int_to_decimal _ _ _test_pylong_int_to_decimal _ _test_pylong_int_to_decimal _ test_pylong_int_divmod n = _ b = divmod n + n assert == b == test_pylong_str_to_int v = _ s = str v v = int s assert v == v v = int - + s assert -v == v v = int + + s + assert v == v assertRaises ValueError err int s + z assertRaises ValueError err int s + _ assertRaises ValueError err int _ + s support cpython_only tests implementation details CPython unittest skipUnless _pylong _pylong module required mock patch object _pylong int_to_decimal_string test_pylong_misbehavior_error_path_to_str mock_int_to_str support adjust_int_max_str_digits _ big_value = int _ mock_int_to_str return_value = None str assertRaises TypeError ctx str big_value assertIn _pylong int_to_decimal_string did str ctx exception mock_int_to_str side_effect = RuntimeError testABC assertRaises RuntimeError str big_value support cpython_only tests implementation details CPython unittest skipUnless _pylong _pylong module required mock patch object _pylong int_from_string test_pylong_misbehavior_error_path_from_str mock_int_from_str big_value = _ support adjust_int_max_str_digits _ mock_int_from_str return_value = b int assertRaises TypeError ctx int big_value assertIn _pylong int_from_string did str ctx exception mock_int_from_str side_effect = RuntimeError test assertRaises RuntimeError int big_value test_pylong_roundtrip random randrange getrandbits bits = while bits = _ _ bits += randrange - break bitlength patterns hibit = bits - n = hibit &#124; getrandbits bits - assert n bit_length == bits sn = str n assertFalse sn startswith assertEqual n int sn bits = __name__ == __main__ run_tests
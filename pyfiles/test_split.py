Owner s module functorch unittest torch functorch dim Dim dims Tensor torch testing _internal common_utils run_tests TEST_WITH_TORCHDYNAMO TestCase TestSplit TestCase Comprehensive tests first-class dimension split operations setUp Set up common test fixtures batch height width = dims test_dim_object_split_all_bound Test split all Dim objects bound specific sizes tensor = torch randn x y z = dims t = tensor x y z Create bound Dim objects d = Dim d d = Dim d d = Dim d result = t split d d d dim=y assertEqual len result For FCD tensors check ordered version verify shapes assertEqual result order x d z shape assertEqual result order x d z shape assertEqual result order x d z shape Verify dimensions bound correctly assertEqual d size assertEqual d size assertEqual d size test_dim_object_split_unbound Test split unbound Dim objects tensor = torch randn x y z = dims t = tensor x y z Create unbound Dim objects d = Dim d d = Dim d d = Dim d result = t split d d d dim=y assertEqual len result Should split evenly = each Check via ordered tensors since FCD tensors have ndim= i part enumerate result i == assertEqual part order x d z shape i == assertEqual part order x d z shape assertEqual part order x d z shape Verify dimensions bound chunk size assertEqual d size assertEqual d size assertEqual d size test_dim_object_split_mixed_bound_unbound Test split mix bound unbound Dim objects tensor = torch randn x y z = dims t = tensor x y z Create mix bound unbound d = Dim d bound d = Dim d unbound d = Dim d bound result = t split d d d dim=y assertEqual len result assertEqual result order x d z shape assertEqual result order x d z shape - - = assertEqual result order x d z shape Verify unbound dimension bound remaining size assertEqual d size test_dim_object_split_multiple_unbound Test split multiple unbound Dim objects tensor = torch randn x y z = dims t = tensor x y z Create multiple unbound dimensions d = Dim d bound d = Dim d unbound d = Dim d unbound result = t split d d d dim=y assertEqual len result assertEqual result order x d z shape Remaining should split evenly between d d each assertEqual result order x d z shape assertEqual result order x d z shape assertEqual d size assertEqual d size test_dim_object_split_uneven_remainder Test split unbound dimensions don t divide evenly tensor = torch randn doesn t divide evenly x y z = dims t = tensor x y z d = Dim d d = Dim d Should get ceil - = d = Dim d Should get remaining = result = t split d d d dim=y assertEqual len result assertEqual result order x d z shape assertEqual result order x d z shape assertEqual result order x d z shape assertEqual d size assertEqual d size test_split_with_dim_object_parameter Test split when dim parameter Dim object tensor = torch randn x y z = dims t = tensor x y z Use Dim object dim parameter d = Dim d d = Dim d d = Dim d result = t split d d d dim=y assertEqual len result test_error_mixed_types Test error when mixing integers Dim objects split sizes tensor = torch randn x y z = dims t = tensor x y z d = Dim d Should raise TypeError mixed types assertRaises TypeError t split d dim=y assertRaises TypeError t split d dim=y test_error_dim_parameter_with_int_sizes Test error when dim parameter Dim sizes integers tensor = torch randn x y z = dims t = tensor x y z Should raise TypeError when dim Dim object sizes ints assertRaises TypeError msg= when dim specified Dim object split sizes must also dimensions t split dim=y assertRaises TypeError msg= when dim specified Dim object split sizes must also dimensions t split dim=y test_error_size_mismatch Test error when bound sizes don t match tensor dimension tensor = torch randn x y z = dims t = tensor x y z Bound dimensions sum wrong total d = Dim d d = Dim d d = Dim d + + = tensor has assertRaises TypeError t split d d d dim=y test_error_bound_sizes_exceed_tensor Test error when bound sizes exceed tensor dimension tensor = torch randn x y z = dims t = tensor x y z Bound dimensions one unbound bound sizes too large d = Dim d d = Dim d + = d = Dim d assertRaises TypeError t split d d d dim=y test_error_nonexistent_dimension Test error when splitting non-existent dimension tensor = torch randn x y z = dims t = tensor x y z w = Dim w Not tensor assertRaises TypeError t split Dim d Dim d dim=w test_split_different_dims Test splitting along different dimensions tensor = torch randn x y z = dims t = tensor x y z Split along first dimension b = Dim Dim b result = t split b dim=x assertEqual len result assertEqual result order y z shape assertEqual result order b y z shape Split along last dimension c d = Dim c Dim d result = t split c d dim=z assertEqual len result assertEqual result order x y c shape assertEqual result order x y d shape test_split_single_dim_object Test split single Dim object matches tensor dimension size tensor = torch randn x y z = dims t = tensor x y z Use single Dim object size matching dimension d = Dim d Must match full size y dimension Single Dim object list should work when size matches result = t split d dim=y assertEqual len result Single chunk containing entire dimension assertEqual result order x d z shape unittest skipIf TEST_WITH_TORCHDYNAMO TorchDynamo doesn t preserve side effects during tracing test_dimension_binding_consistency Test split properly binds dimensions they remain consistent tensor = torch randn x y z = dims t = tensor x y z d = Dim d d = Dim d d = Dim d Split should bind dimensions t split d d d dim=y Use bound dimensions another operation assertTrue d is_bound assertTrue d is_bound assertTrue d is_bound Dimensions should remain bound same values original_sizes = d size d size d size Try use bound dimension again - should maintain same size another_tensor = torch randn original_sizes = Dim t = another_tensor d d should still bound same size assertEqual t order d shape original_sizes test_split_result_tensor_types Test split results proper first-class dimension tensors tensor = torch randn x y z = dims t = tensor x y z d = Dim d d = Dim d result = t split d d dim=y Results should first-class dimension tensors part result assertTrue isinstance part torch Tensor Tensor Should have dimensions original tensor plus new split dimensions hasattr part dims Check split dimension result dims_in_result = part dims assertTrue len dims_in_result test_large_tensor_split Test split larger tensors verify performance correctness tensor = torch randn x y z = dims t = tensor x y z Split into many small pieces split_dims = Dim f d i i range = result = t split split_dims dim=y assertEqual len result i part enumerate result assertEqual part order x split_dims i z shape assertEqual split_dims i size test_device_handling Test split behavior different devices torch cuda is_available Test CUDA cuda_tensor = torch randn device= cuda x y z = dims t = cuda_tensor x y z d d = Dim d Dim d result = t split d d dim=y i part enumerate result ordered = part order x d i == d z assertEqual ordered device type cuda assertEqual ordered shape assertEqual ordered shape Test CPU cpu_tensor = torch randn x y z = dims t = cpu_tensor x y z d d = Dim d Dim d result = t split d d dim=y i part enumerate result ordered = part order x d i == d z assertEqual ordered device torch device cpu test_split_preserves_dtype Test split preserves tensor dtype dtype torch float torch float torch int torch int dtype torch int torch int tensor = torch randint dtype=dtype tensor = torch randn dtype=dtype x y z = dims t = tensor x y z d d = Dim d Dim d result = t split d d dim=y i part enumerate result ordered = part order x d i == d z assertEqual ordered dtype dtype test_split_with_requires_grad Test split tensors require gradients tensor = torch randn requires_grad=True x y z = dims t = tensor x y z d d = Dim d Dim d result = t split d d dim=y part result Check requires_grad ordered tensor access underlying tensor properties assertTrue part order x d part result d z requires_grad test_edge_case_single_element_splits Test splitting into single-element chunks tensor = torch randn x y z = dims t = tensor x y z Split into single-element pieces split_dims = Dim f d i i range result = t split split_dims dim=y assertEqual len result i part enumerate result assertEqual part order x split_dims i z shape unittest skipIf TEST_WITH_TORCHDYNAMO TorchDynamo has issues torch _tensor split test_split_function_directly Test standalone split function works correctly functorch dim split Test regular tensor tensor = torch randn result = split tensor dim= assertEqual len result = part result assertEqual part shape Test FCD tensor FCD arguments x y z = dims fcd_tensor = tensor x y z d = Dim d d = Dim d result = split fcd_tensor d d dim=y assertEqual len result assertEqual result order x d z shape assertEqual result order x d z shape unittest skipIf TEST_WITH_TORCHDYNAMO TorchDynamo can t parse dims without arguments bytecode test_split_on_plain_tensor_with_fcd_args Test split works plain tensors when FCD arguments provided Test exact example user message x y = dims Split plain tensor FCD dimensions split sizes result = torch randn split x y dim= assertEqual len result Both parts should FCD tensors part result assertTrue isinstance part torch Tensor Tensor assertTrue hasattr part dims Check dimensions bound correctly assertIs result dims x assertIs result dims y assertEqual x size = each assertEqual y size Test repeated dimensions x = Dim x result = torch randn split x x dim= assertEqual len result assertEqual x size Both chunks should size test_plain_tensor_regular_split_still_works Test regular split plain tensors still works without FCD args tensor = torch randn Regular split without any FCD arguments should work normally result = tensor split dim= assertEqual len result = part result assertEqual part shape assertTrue isinstance part torch Tensor assertFalse hasattr part dims Should regular tensor __name__ == __main__ run_tests
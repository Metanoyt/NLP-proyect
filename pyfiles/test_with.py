Owner s oncall jit ruff noqa F os sys typing Any List torch torch testing _internal common_utils raise_on_run_directly skipIfTorchDynamo torch testing _internal jit_utils JitTestCase make_global Make helper files test importable pytorch_test_dir = os path dirname os path dirname os path realpath __file__ sys path append pytorch_test_dir TestWith JitTestCase A suite tests statements test_with_as Check statements use keyword bind expressions targets work expected torch jit script Context This implements basic context manager interface use unit tests Unlike Context stateful part Tensor mutated in-place so modifications made JIT interpreter visible outside __init__ start int count = torch tensor start dtype=torch double __enter__ count add_ count __exit__ type Any value Any tb Any - bool count sub_ True make_global Context test_basic x torch Tensor - torch Tensor Basic test one with-statement c = Context c mult y = x + mult y = c count y test_pass x torch Tensor - torch Tensor Test pass statement inside with-statement Although body empty __enter__ __exit__ should still called c = Context c mult pass x = c count x test_early_return x torch Tensor c Context - torch Tensor Test returning early inside with-statement works expected c mult y = x + mult y x = y + y x test_conditional_early_return x torch Tensor c Context - torch Tensor Test conditionally returning early inside with-statement works expected c mult y = x + mult mult y x = y + y x test_break x torch Tensor c Context l List int - torch Tensor Test breaking early inside with-statement works expected c mult l == break x += mult x test_continue x torch Tensor c Context l List int - torch Tensor Test using continue inside with-statement works expected c mult l == continue x += mult x test_serial x torch Tensor - torch Tensor Test two with-statements row c = Context c mult y = x + mult c mult y = mult y test_nested x torch Tensor - torch Tensor Test nested with-statements c = Context c m c n y = x + n y = m y test_combined x torch Tensor - torch Tensor Test with-statement multiple items c = Context d = Context c m d n y = x + m + n y test_input = torch randn test_context = Context test_list = checkScript test_basic test_input checkScript test_pass test_input checkScript test_early_return test_input test_context checkScript test_break test_input test_context test_list checkScript test_continue test_input test_context test_list assertEqual test_context count checkScript test_serial test_input checkScript test_nested test_input checkScript test_combined test_input test_with_no_as Check statements do use keyword bind expressions targets work expected torch jit script Context This implements basic context manager interface use unit tests Unlike Context stateful part Tensor mutated in-place so modifications made JIT interpreter visible outside __init__ start int count = torch tensor start dtype=torch double __enter__ count add_ count __exit__ type Any value Any tb Any count sub_ make_global Context test_basic x torch Tensor - torch Tensor Basic test one with-statement c = Context c y = x + c count y = c count y test_pass x torch Tensor - torch Tensor Test pass statement inside with-statement Although body empty __enter__ __exit__ should still called c = Context c pass x = c count x test_early_return x torch Tensor c Context - torch Tensor Test returning early inside with-statement works expected c y = x + c count y x = y + y x test_conditional_early_return x torch Tensor c Context - torch Tensor Test conditionally returning early inside with-statement works expected c y = x + c count c count y x = y + y x test_break x torch Tensor c Context l List int - torch Tensor Test breaking early inside with-statement works expected c l == break x += c count x test_continue x torch Tensor c Context l List int - torch Tensor Test using continue inside with-statement works expected c l == continue x += c count x test_serial x torch Tensor - torch Tensor Test two with-statements row c = Context c y = x + c count c y = c count y test_nested x torch Tensor - torch Tensor Test nested with-statements c = Context c c y = x + c count y = c count y test_combined x torch Tensor - torch Tensor Test with-statement multiple items c = Context d = Context c d y = x + c count + d count y test_input = torch randn test_context = Context test_list = checkScript test_basic test_input checkScript test_pass test_input checkScript test_early_return test_input test_context checkScript test_break test_input test_context test_list checkScript test_continue test_input test_context test_list assertEqual test_context count checkScript test_serial test_input checkScript test_nested test_input checkScript test_combined test_input test_with_exceptions Check exceptions thrown bodies with-statements handled correctly torch jit script Context This implements basic context manager interface use unit tests Unlike Context stateful part Tensor mutated in-place so modifications made JIT interpreter visible outside __init__ start int count = torch tensor start dtype=torch double __enter__ count add_ count __exit__ type Any value Any tb Any count sub_ make_global Context torch jit script method_that_raises - torch Tensor raise Exception raised exception noqa TRY torch jit script test_exception x torch Tensor c Context - torch Tensor Test case which exception thrown while executing body with-statement c _ x += method_that_raises x torch jit script test_exception_nested x torch Tensor c Context - torch Tensor Test case which exception thrown while executing body nested with-statement c _ c _ x += method_that_raises x torch jit script with_that_raises c Context - torch Tensor = torch tensor c _ += method_that_raises torch jit script test_exception_fn_call x torch Tensor c Context - torch Tensor Test case which exception thrown while there active with-statements two different frames c _ x += with_that_raises c x c = Context checkScript checkScriptRaisesRegex cannot used because string frontend will compile types which Context context manager being used test one assertRaisesRegexWithHighlight Exception r raised exception raise Exception raised exception test_exception torch randn c assertEqual c count assertRaisesRegexWithHighlight Exception r raised exception raise Exception raised exception test_exception_nested torch randn c assertEqual c count assertRaisesRegexWithHighlight Exception r raised exception raise Exception raised exception test_exception_fn_call torch randn c assertEqual c count test_with_errors Check errors related with-statements detected reported correctly torch jit script NoEnterNoExit This missing __enter__ __exit__ methods __init__ - None count = torch jit script BadEnter This has __enter__ method incorrect signature __init__ - None count = __enter__ incr int noqa PLE count += incr __exit__ type Any value Any tb Any pass torch jit script BadExit This has __exit__ method incorrect signature __init__ - None count = __enter__ count += __exit__ type Any value Any noqa PLE pass torch jit script ExitIncorrectTypes This has __exit__ method unsupported argument types __init__ - None count = __enter__ count += __exit__ type Any value int tb int pass test_no_enter_no_exit x torch Tensor cm NoEnterNoExit - torch Tensor cm _ pass x test_bad_enter x torch Tensor cm BadEnter - torch Tensor cm _ pass x test_bad_exit x torch Tensor cm BadExit - torch Tensor cm _ pass x test_exit_incorrect_types x torch Tensor cm ExitIncorrectTypes - torch Tensor cm _ pass x test_enter_without_object not_object obj pass test_tensor = torch randn dtype=torch double assertRaisesRegexWithHighlight RuntimeError r does define __enter__ __exit__ methods cm checkScript test_no_enter_no_exit test_tensor NoEnterNoExit assertRaisesRegexWithHighlight RuntimeError r __enter__ must have only one argument one value cm checkScript test_bad_enter test_tensor BadEnter assertRaisesRegexWithHighlight RuntimeError r __exit__ must have four arguments cm checkScript test_bad_exit test_tensor BadExit assertRaisesRegexWithHighlight RuntimeError r argument __exit__ must have Any type cm checkScript test_exit_incorrect_types test_tensor ExitIncorrectTypes assertRaisesRegexWithHighlight RuntimeError r must object not_object checkScript test_enter_without_object test_with_no_grad Check torch no_grad works Most these adapted corresponding tests eager-mode no_grad Basic no_grad test test_no_grad x torch Tensor y torch Tensor - torch Tensor torch no_grad w = x + y w s = torch jit script test_no_grad x = torch ones requires_grad=True y = torch ones w = s x y assertFalse w requires_grad assertRaises RuntimeError lambda w backward torch ones assertIsNone w grad_fn Test assignment grad-less Tensor Tensor gradients no_grad block test_no_grad_assignment x torch Tensor y torch Tensor - torch Tensor torch no_grad x = y x s = torch jit script test_no_grad_assignment z = torch randn w = s x z assertTrue w requires_grad assertIsNone w grad_fn Check torch jit ignored functions respect no_grad when called JIT mode NoGradModule torch nn Module torch jit ignore adder x torch Tensor y torch Tensor - torch Tensor w = x + y w forward x torch Tensor y torch Tensor - torch Tensor torch no_grad w = adder x y w s = torch jit script NoGradModule w = s x y assertFalse w requires_grad skipIfTorchDynamo Torchdynamo cannot correctly handle profiler profile calls test_with_record_function Check torch autograd profiler record_function context manager torchscriptable with_rf x torch Tensor y torch Tensor - torch Tensor torch autograd profiler record_function foo Nested record_function torch autograd profiler record_function nested = x + y scripted = torch jit script with_rf x y = torch ones torch ones torch autograd profiler profile p scripted x y Need call below populate CPU children p key_averages function_events = p function_events Event name foo should recorded rf_events = evt evt function_events evt name == foo assertEqual len rf_events rf_event = rf_events child_events = rf_event cpu_children Ensure we find nested record_function event assertTrue nested child name child child_events nested_function_event = evt evt function_events evt name == nested Nested record function should have child aten add nested_child_events = nested_function_event cpu_children assertTrue aten add child name child nested_child_events __name__ == __main__ raise_on_run_directly test test_jit py
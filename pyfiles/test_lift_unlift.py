Owner s oncall export collections OrderedDict typing Any Optional torch torch _export passes lift_constants_pass ConstantAttrMap lift_constants_pass torch export _unlift _unlift_exported_program_lifted_states torch export exported_program ExportGraphSignature InputKind InputSpec OutputKind OutputSpec TensorArgument torch export graph_signature CustomObjArgument torch testing _internal common_utils run_tests TestCase torch testing _internal torchbind_impls load_torchbind_test_lib GraphBuilder __init__ - None graph = torch fx Graph nodes = values = nn_module_stack_key dict str int = latest_id = input_to_kind dict torch fx Node InputKind = input name str value torch Tensor kind InputKind node = graph placeholder name node meta val = value nodes name = node values name = value input_to_kind node = kind add x str y str out str module_fqn str = node = graph create_node call_function torch ops aten add Tensor nodes x nodes y name=out values out = values x + values y node meta val = values out node meta nn_module_stack = create_nn_module_stack module_fqn nodes out = node call_function target args out str module_fqn str = arg_nodes = tuple nodes arg arg args arg_values = tuple values arg arg args node = graph create_node call_function target arg_nodes name=out values out = target arg_values node meta val = values out node meta nn_module_stack = create_nn_module_stack module_fqn nodes out = node constant name str value Any target Optional str = None module_fqn str = target None target = name node = graph get_attr target node meta val = value node meta nn_module_stack = create_nn_module_stack module_fqn nodes name = node values name = value output out str graph output nodes out create_nn_module_stack module_fqn str - OrderedDict int tuple str type cur_name = nn_module_stack = OrderedDict atom module_fqn split cur_name == cur_name = atom cur_name = cur_name + + atom cur_name nn_module_stack_key id_counter = latest_id latest_id += nn_module_stack_key cur_name = id_counter id_counter = nn_module_stack_key cur_name nn_module_stack id_counter = cur_name torch nn Module nn_module_stack create_input_specs input_specs = node graph nodes node op == placeholder input_specs append InputSpec kind=self input_to_kind node arg=TensorArgument name=node name target=None persistent= True input_to_kind node == InputKind BUFFER None input_specs NOTE does handle non-user-outputs atm gen_graph_signature - ExportGraphSignature output = n n graph nodes n op == output assert len output == output = output assert len output args == multiple outputs NYI ExportGraphSignature input_specs=self create_input_specs output_specs= OutputSpec kind=OutputKind USER_OUTPUT arg=TensorArgument name=n name target=None n output args TestLift TestCase setUp load_torchbind_test_lib test_lift_basic builder = GraphBuilder builder input param torch rand InputKind PARAMETER builder input buffer torch rand InputKind BUFFER builder input x torch rand InputKind USER_INPUT builder input y torch rand InputKind USER_INPUT builder add x y out= foo builder add foo param out= bar builder add bar buffer out= baz builder constant const_tensor torch rand builder constant const_obj torch classes _TorchScriptTesting _Foo builder add baz const_tensor out= out builder call_function torch ops _TorchScriptTesting takes_foo const_obj x out= torchbind_out builder add out torchbind_out out= final_out builder output final_out builder graph lint graph = builder graph const_tensor = builder values const_tensor const_obj = builder values const_obj root = const_tensor const_tensor const_obj const_obj gm = torch fx GraphModule root graph graph_signature = builder gen_graph_signature constants = lift_constants_pass gm graph_signature gm graph lint assertEqual len constants The key constants table should match fqn constant In case s just name constant since constant root submodule TODO suo we shouldn t hardcode these names test internal detail pass assertIn lifted_tensor_ constants assertEqual constants lifted_tensor_ const_tensor assertIn lifted_custom_ constants assertEqual constants lifted_custom_ const_obj The constant node should removed getattr_nodes = n n gm graph nodes n op == get_attr assertEqual len getattr_nodes The constant should lifted placeholder node placeholder_nodes = n n gm graph nodes n op == placeholder assertEqual len placeholder_nodes The lifted constant should placed before user inputs after params buffers lifted_tensor_placeholder = placeholder_nodes assertEqual lifted_tensor_placeholder target lifted_tensor_ It should have val equivalent constant assertEqual lifted_tensor_placeholder meta val const_tensor lifted_obj_placeholder = placeholder_nodes assertEqual lifted_obj_placeholder target lifted_custom_ It should have val equivalent constant assertEqual lifted_obj_placeholder meta val CustomObjArgument name= lifted_custom_ class_fqn= __torch__ torch classes _TorchScriptTesting _Foo Graph signature should have been mutated way reflects placeholders tensor_constant_input_spec = graph_signature input_specs assertEqual tensor_constant_input_spec kind InputKind CONSTANT_TENSOR assertIsInstance tensor_constant_input_spec arg TensorArgument assertEqual tensor_constant_input_spec arg name lifted_tensor_placeholder name obj_constant_input_spec = graph_signature input_specs assertEqual obj_constant_input_spec kind InputKind CUSTOM_OBJ assertIsInstance obj_constant_input_spec arg CustomObjArgument assertEqual obj_constant_input_spec arg name lifted_obj_placeholder name test_lift_nested builder = GraphBuilder builder input x torch rand InputKind USER_INPUT builder input y torch rand InputKind USER_INPUT builder input z torch rand InputKind USER_INPUT builder add x y out= foo builder add foo z out= bar module_fqn= foo builder constant const_tensor torch rand module_fqn= foo builder add bar const_tensor out builder output out graph = builder graph graph lint const_tensor = builder values const_tensor root = const_tensor builder values const_tensor graph_signature = builder gen_graph_signature gm = torch fx GraphModule root graph constants = lift_constants_pass gm graph_signature gm graph lint assertEqual len constants The key constants table should match fqn constant assertIn foo lifted_tensor_ constants assertEqual constants foo lifted_tensor_ const_tensor The constant node should removed getattr_nodes = n n gm graph nodes n op == get_attr assertEqual len getattr_nodes The constant should lifted placeholder node placeholder_nodes = n n gm graph nodes n op == placeholder assertEqual len placeholder_nodes The lifted constant should placed before user inputs after params buffers lifted_constant_placeholder = placeholder_nodes assertEqual lifted_constant_placeholder target lifted_tensor_ Graph signature should have been mutated way reflects placeholders constant_input_spec = graph_signature input_specs assertEqual constant_input_spec kind InputKind CONSTANT_TENSOR assertIsInstance constant_input_spec arg TensorArgument assertEqual constant_input_spec arg name lifted_constant_placeholder name test_duplicate_constant_access const = torch rand const_obj = torch classes _TorchScriptTesting _Foo builder = GraphBuilder builder input x torch rand InputKind USER_INPUT builder constant const_tensor const target= const_tensor loading same target twice builder constant const_tensor const target= const_tensor loading same object twice different targets builder constant const_obj const_obj builder constant const_obj const_obj builder call_function torch ops _TorchScriptTesting takes_foo const_obj x out= torchbind_out builder call_function torch ops _TorchScriptTesting takes_foo const_obj x out= torchbind_out builder add x const_tensor out= foo builder add foo const_tensor out= tensor_out builder add torchbind_out torchbind_out out= obj_out builder add tensor_out obj_out out= out builder output out graph = builder graph graph lint input_specs = builder create_input_specs output_specs = OutputSpec kind=OutputKind USER_OUTPUT arg=TensorArgument name=builder nodes out name target=None graph_signature = ExportGraphSignature input_specs output_specs root = const_tensor const const_obj const_obj const_obj const_obj gm = torch fx GraphModule root graph constants = lift_constants_pass gm graph_signature gm graph lint assertEqual len constants All get_attr nodes should removed getattr_nodes = n n gm graph nodes n op == get_attr assertEqual len getattr_nodes There should only two additional inputs plus existing user input placeholder_nodes = n n gm graph nodes n op == placeholder assertEqual len placeholder_nodes Graph signature should have been mutated way reflects placeholders assertEqual len graph_signature input_specs constant_input_spec = graph_signature input_specs assertEqual constant_input_spec kind InputKind CONSTANT_TENSOR assertIsInstance constant_input_spec arg TensorArgument test_unlift_nonpersistent_buffer Foo torch nn Module __init__ - None super __init__ register_buffer non_persistent_buf torch zeros persistent=False forward x non_persistent_buf add_ x sum + non_persistent_buf sum foo = Foo exported = torch export export foo torch ones strict=False stateful_gm = _unlift_exported_program_lifted_states exported Check unlifted stateful_gm contains original non-persistent buffer assertTrue hasattr stateful_gm non_persistent_buf non_persistent_buf = stateful_gm get_buffer non_persistent_buf assertEqual non_persistent_buf foo get_buffer non_persistent_buf assertIn non_persistent_buf stateful_gm _non_persistent_buffers_set assertNotIn non_persistent_buf stateful_gm state_dict ConstantAttrMapTest TestCase setUp load_torchbind_test_lib test_dict_api constant_attr_map = ConstantAttrMap const_obj = torch classes _TorchScriptTesting _Foo const_tensor = torch ones constant_attr_map add const_obj foo bar constant_attr_map add const_tensor foo bar baz assertEqual len constant_attr_map assertEqual list constant_attr_map const_obj const_tensor assertEqual list constant_attr_map keys const_obj const_tensor assertEqual list constant_attr_map values foo bar foo bar baz assertEqual constant_attr_map const_obj foo bar assertEqual constant_attr_map const_tensor foo bar baz assertTrue const_obj constant_attr_map assertRaises TypeError constant_attr_map add foo bar del constant_attr_map const_obj assertEqual len constant_attr_map __name__ == __main__ run_tests
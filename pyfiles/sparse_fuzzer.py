mypy allow-untyped-defs typing Optional Union numbers Number torch torch utils benchmark FuzzedTensor math FuzzedSparseTensor FuzzedTensor __init__ name str size tuple Union str int min_elements Optional int = None max_elements Optional int = None dim_parameter Optional str = None sparse_dim Optional str = None nnz Optional str = None density Optional str = None coalesced Optional str = None dtype=torch float cuda=False Args name A string identifier generated Tensor size A tuple integers strings specifying size generated Tensor String values will replaced concrete int during generation process while ints simply passed literals min_elements The minimum number parameters Tensor must have set parameters valid Otherwise they resampled max_elements Like ` min_elements ` setting upper bound dim_parameter The length ` size ` will truncated value This allows Tensors varying dimensions generated Fuzzer sparse_dim The number sparse dimensions sparse tensor density This value allows tensors varying sparsities generated Fuzzer coalesced The sparse tensor format permits uncoalesced sparse tensors where there may duplicate coordinates indices dtype The PyTorch dtype generated Tensor cuda Whether place Tensor GPU super __init__ name=name size=size min_elements=min_elements max_elements=max_elements dim_parameter=dim_parameter dtype=dtype cuda=cuda _density = density _coalesced = coalesced _sparse_dim = sparse_dim staticmethod sparse_tensor_constructor size dtype sparse_dim nnz is_coalesced sparse_tensor_constructor creates sparse tensor coo format Note when ` is_coalesced ` False number elements doubled number indices represents same amount number non zeros ` nnz ` i e virtually same tensor same sparsity pattern Moreover most sparse operation will use coalesce method what we want here get sparse tensor same ` nnz ` even coalesced In other hand when ` is_coalesced ` True number elements reduced coalescing process unclear amount however probability generate duplicates indices low most cases This decision taken purpose maintain construction cost low possible isinstance size Number size = size sparse_dim all size d = d range sparse_dim nnz = raise AssertionError invalid arguments v_size = nnz + list size sparse_dim dtype is_floating_point v = torch rand size=v_size dtype=dtype device= cpu v = torch randint size=v_size dtype=dtype device= cpu i = torch rand sparse_dim nnz device= cpu i mul_ torch tensor size sparse_dim unsqueeze i i = i torch long is_coalesced v = torch cat v torch randn_like v i = torch cat i i x = torch sparse_coo_tensor i v torch Size size is_coalesced x = x coalesce x _make_tensor params state pyrefly ignore missing-attribute size _ _ = _get_size_and_steps params density = params density nnz = math ceil sum size density nnz sum size raise AssertionError nnz cannot exceed total number elements is_coalesced = params coalesced sparse_dim = params sparse_dim _sparse_dim len size sparse_dim = min sparse_dim len size pyrefly ignore missing-attribute tensor = sparse_tensor_constructor size _dtype sparse_dim nnz is_coalesced pyrefly ignore missing-attribute _cuda tensor = tensor cuda sparse_dim = tensor sparse_dim dense_dim = tensor dense_dim is_hybrid = len size sparse_dim properties = numel int tensor numel shape tensor size is_coalesced tensor is_coalesced density density sparsity - density sparse_dim sparse_dim dense_dim dense_dim is_hybrid is_hybrid pyrefly ignore missing-attribute dtype str _dtype tensor properties
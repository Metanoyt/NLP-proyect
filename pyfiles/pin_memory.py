mypy allow-untyped-defs r Contains definitions methods used _BaseDataLoaderIter put fetched tensors into pinned memory These needs global scope since Py doesn t support serializing static methods collections copy queue torch torch _utils ExceptionWrapper MP_STATUS_CHECK_INTERVAL _pin_memory_loop in_queue out_queue device_id done_event device This setting thread local prevents copy pin_memory consuming all CPU cores torch set_num_threads torch multiprocessing _set_thread_name pt_data_pin torch accelerator set_device_index device_id do_one_step try r = in_queue get timeout=MP_STATUS_CHECK_INTERVAL except queue Empty idx data = r done_event is_set isinstance data ExceptionWrapper try data = pin_memory data device except Exception data = ExceptionWrapper where=f pin memory thread device device_id r = idx data while done_event is_set try out_queue put r timeout=MP_STATUS_CHECK_INTERVAL break except queue Full continue See NOTE Data Loader Multiprocessing Shutdown Logic details logic function while done_event is_set Make sure we don t preserve any object one iteration next do_one_step pin_memory data device=None isinstance data torch Tensor data pin_memory device isinstance data str bytes data isinstance data collections abc Mapping try isinstance data collections abc MutableMapping The sequence type may have extra properties so we can t just use ` type data ` create new sequence Create clone update sequence type mutable clone = copy copy data clone update k pin_memory sample device k sample data items clone type data pyrefly ignore bad-argument-count k pin_memory sample device k sample data items type ignore call-arg except TypeError The mapping type may support ` copy ` ` update mapping ` ` __init__ iterable ` k pin_memory sample device k sample data items isinstance data tuple hasattr data _fields namedtuple type data pin_memory sample device sample data isinstance data tuple pin_memory sample device sample data Backwards compatibility isinstance data collections abc Sequence try isinstance data collections abc MutableSequence The sequence type may have extra properties so we can t just use ` type data ` create new sequence Create clone update sequence type mutable clone = copy copy data type ignore arg-type i item enumerate data clone i = pin_memory item device clone type data pin_memory sample device sample data type ignore call-arg except TypeError The sequence type may support ` copy ` ` __setitem__ index item ` ` __init__ iterable ` e g ` range ` pin_memory sample device sample data hasattr data pin_memory data pin_memory data
Owner s module onnx __future__ annotations functools os random sys unittest enum auto Enum typing Optional numpy np packaging version pytest torch torch autograd function torch testing _internal common_utils pytorch_test_dir = os path dirname os path dirname os path realpath __file__ sys path insert - pytorch_test_dir torch set_default_dtype torch float BATCH_SIZE = RNN_BATCH_SIZE = RNN_SEQUENCE_LENGTH = RNN_INPUT_SIZE = RNN_HIDDEN_SIZE = TorchModelType Enum TORCH_NN_MODULE = auto TORCH_EXPORT_EXPORTEDPROGRAM = auto _skipper condition reason decorator f functools wraps f wrapper args kwargs condition raise unittest SkipTest reason f args kwargs wrapper decorator skipIfNoCuda = _skipper lambda torch cuda is_available CUDA available skipIfTravis = _skipper lambda os getenv TRAVIS Skip In Travis skipIfNoBFloat Cuda = _skipper lambda torch cuda is_bf _supported BFloat CUDA available skipIfQuantizationBackendQNNPack = _skipper lambda torch backends quantized engine == qnnpack Not compatible QNNPack quantization backend skips tests all versions below min_opset_version add wrapper prevent running test opset_versions smaller than ` min_opset_version ` skipIfUnsupportedMinOpsetVersion min_opset_version skip_dec func functools wraps func wrapper args kwargs opset_version min_opset_version raise unittest SkipTest f Unsupported opset_version opset_version min_opset_version func args kwargs wrapper skip_dec skips tests all versions above max_opset_version add wrapper prevent running test opset_versions higher than ` max_opset_version ` skipIfUnsupportedMaxOpsetVersion max_opset_version skip_dec func functools wraps func wrapper args kwargs opset_version max_opset_version raise unittest SkipTest f Unsupported opset_version opset_version max_opset_version func args kwargs wrapper skip_dec skips tests all opset versions skipForAllOpsetVersions skip_dec func functools wraps func wrapper args kwargs opset_version raise unittest SkipTest Skip verify test unsupported opset_version func args kwargs wrapper skip_dec skipTraceTest skip_before_opset_version Optional int = None reason str = Skip tracing test opset version less than skip_before_opset_version Args skip_before_opset_version The opset version before which skip tracing test If None tracing test always skipped reason The reason skipping tracing test Returns A decorator skipping tracing test skip_dec func functools wraps func wrapper args kwargs skip_before_opset_version None skip_this_opset = opset_version skip_before_opset_version skip_this_opset = True skip_this_opset is_script raise unittest SkipTest f Skip verify test torch trace reason func args kwargs wrapper skip_dec skipScriptTest skip_before_opset_version Optional int = None reason str = Skip scripting test opset version less than skip_before_opset_version Args skip_before_opset_version The opset version before which skip scripting test If None scripting test always skipped reason The reason skipping scripting test Returns A decorator skipping scripting test skip_dec func functools wraps func wrapper args kwargs skip_before_opset_version None skip_this_opset = opset_version skip_before_opset_version skip_this_opset = True skip_this_opset is_script raise unittest SkipTest f Skip verify test TorchScript reason func args kwargs wrapper skip_dec NOTE This decorator currently unused we may want use future when we have more tests supported released ORT skip_min_ort_version reason str version str dynamic_only bool = False skip_dec func functools wraps func wrapper args kwargs packaging version parse ort_version release packaging version parse version release dynamic_only dynamic_shapes func args kwargs raise unittest SkipTest f ONNX Runtime version version older than required version version f Reason reason func args kwargs wrapper skip_dec xfail_dynamic_fx_test error_message str model_type Optional TorchModelType = None reason Optional str = None Xfail dynamic exporting test Args reason The reason xfailing dynamic exporting test model_type TorchModelType The model type xfail dynamic exporting test When None model type used xfail dynamic tests Returns A decorator xfailing dynamic exporting test skip_dec func functools wraps func wrapper args kwargs dynamic_shapes model_type model_type == model_type xfail error_message reason func args kwargs func args kwargs wrapper skip_dec skip_dynamic_fx_test reason str model_type TorchModelType = None Skip dynamic exporting test Args reason The reason skipping dynamic exporting test model_type TorchModelType The model type skip dynamic exporting test When None model type used skip dynamic tests Returns A decorator skipping dynamic exporting test skip_dec func functools wraps func wrapper args kwargs dynamic_shapes model_type model_type == model_type raise unittest SkipTest f Skip verify dynamic shapes test FX reason func args kwargs wrapper skip_dec skip_in_ci reason str Skip test CI Args reason The reason skipping test CI Returns A decorator skipping test CI skip_dec func functools wraps func wrapper args kwargs os getenv CI raise unittest SkipTest f Skip test CI reason func args kwargs wrapper skip_dec xfail error_message str reason Optional str = None Expect failure Args reason The reason expected failure Returns A decorator expecting test failure wrapper func functools wraps func inner args kwargs try func args kwargs except Exception e assert error_message str e f Expected error message error_message NOT str e pytest xfail reason reason f Expected failure error_message pytest fail Unexpected success inner wrapper skips tests opset_versions listed unsupported_opset_versions PyTorch test cannot run specific version add wrapper example op modified change supported PyTorch skipIfUnsupportedOpsetVersion unsupported_opset_versions skip_dec func functools wraps func wrapper args kwargs opset_version unsupported_opset_versions raise unittest SkipTest Skip verify test unsupported opset_version func args kwargs wrapper skip_dec skipShapeChecking func functools wraps func wrapper args kwargs check_shape = False func args kwargs wrapper skipDtypeChecking func functools wraps func wrapper args kwargs check_dtype = False func args kwargs wrapper xfail_if_model_type_is_exportedprogram error_message str reason Optional str = None xfail test models using ExportedProgram input Args error_message The error message raise when test xfailed reason The reason xfail ONNX export test Returns A decorator xfail tests xfail_dec func functools wraps func wrapper args kwargs model_type == TorchModelType TORCH_EXPORT_EXPORTEDPROGRAM xfail error_message reason func args kwargs func args kwargs wrapper xfail_dec xfail_if_model_type_is_not_exportedprogram error_message str reason Optional str = None xfail test without models using ExportedProgram input Args reason The reason xfail ONNX export test Returns A decorator xfail tests xfail_dec func functools wraps func wrapper args kwargs model_type = TorchModelType TORCH_EXPORT_EXPORTEDPROGRAM xfail error_message reason func args kwargs func args kwargs wrapper xfail_dec flatten x tuple function _iter_filter lambda o isinstance o torch Tensor x set_rng_seed seed torch manual_seed seed random seed seed np random seed seed ExportTestCase common_utils TestCase Test case ONNX export Any test case tests functionalities under torch onnx should inherit setUp super setUp TODO Flaky test failures after changing seed set_rng_seed torch cuda is_available torch cuda manual_seed_all
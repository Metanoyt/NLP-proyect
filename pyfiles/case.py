mypy allow-untyped-defs inspect re string dataclasses dataclass field enum Enum typing Any Optional types ModuleType torch _TAGS dict str dict str Any = torch cond dynamic-shape escape-hatch map dynamic-value operator mutation python assert builtin closure context-manager control-flow data-structure standard-library object-model SupportLevel Enum Indicates what stage feature used example handled export SUPPORTED = NOT_SUPPORTED_YET = ArgsType = tuple Any check_inputs_type args kwargs isinstance args tuple raise ValueError f Expecting args type tuple got type args isinstance kwargs dict raise ValueError f Expecting kwargs type dict got type kwargs key kwargs isinstance key str raise ValueError f Expecting kwargs keys string got type key _validate_tag tag str parts = tag split t = _TAGS part parts assert set part = set string ascii_lowercase + - f Tag contains invalid characters part part t t = t part raise ValueError f Tag tag found registered tags dataclass frozen=True ExportCase example_args ArgsType description str A description use case model torch nn Module name str example_kwargs dict str Any = field default_factory=dict extra_args Optional ArgsType = None For testing graph generalization Tags associated use case e g dynamic-shape escape-hatch tags set str = field default_factory=set support_level SupportLevel = SupportLevel SUPPORTED dynamic_shapes Optional dict str Any = None __post_init__ check_inputs_type example_args example_kwargs extra_args None check_inputs_type extra_args tag tags _validate_tag tag isinstance description str len description == raise ValueError f Invalid description description _EXAMPLE_CASES dict str ExportCase = _MODULES set ModuleType = set _EXAMPLE_CONFLICT_CASES dict str list ExportCase = _EXAMPLE_REWRITE_CASES dict str list ExportCase = register_db_case case ExportCase - None Registers user provided ExportCase into example bank case name _EXAMPLE_CASES case name _EXAMPLE_CONFLICT_CASES _EXAMPLE_CONFLICT_CASES case name = _EXAMPLE_CASES case name _EXAMPLE_CONFLICT_CASES case name append case _EXAMPLE_CASES case name = case to_snake_case name name = re sub A-Z a-z + r \ _\ name re sub a-z - A-Z r \ _\ name lower _make_export_case m name configs isinstance m torch nn Module raise TypeError Export case should torch nn Module description configs Fallback docstring description missing assert m __doc__ None f Could find description docstring export case m configs = configs description m __doc__ pyrefly ignore bad-argument-type ExportCase configs model m name name export_case kwargs Decorator registering user provided case into example bank wrapper m configs = kwargs module = inspect getmodule m module _MODULES raise RuntimeError export_case should only used once per example file assert module None _MODULES add module module_name = module __name__ split - case = _make_export_case m module_name configs register_db_case case case wrapper export_rewrite_case kwargs wrapper m configs = kwargs parent = configs pop parent assert isinstance parent ExportCase key = parent name key _EXAMPLE_REWRITE_CASES _EXAMPLE_REWRITE_CASES key = configs example_args = parent example_args case = _make_export_case m to_snake_case m __name__ configs _EXAMPLE_REWRITE_CASES key append case case wrapper
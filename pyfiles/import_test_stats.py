usr bin env python __future__ annotations datetime json os shutil pathlib Path typing Any cast TYPE_CHECKING urllib request urlopen TYPE_CHECKING collections abc Callable REPO_ROOT = Path __file__ resolve parents get_disabled_issues - list str reenabled_issues = os getenv REENABLED_ISSUES issue_numbers = reenabled_issues split print Ignoring disabled issues issue_numbers issue_numbers DISABLED_TESTS_FILE = pytorch-disabled-tests json ADDITIONAL_CI_FILES_FOLDER = Path additional_ci_files TEST_TIMES_FILE = test-times json TEST_CLASS_TIMES_FILE = test-class-times json TEST_FILE_RATINGS_FILE = test-file-ratings json TEST_CLASS_RATINGS_FILE = test-class-ratings json TD_HEURISTIC_PROFILING_FILE = td_heuristic_profiling json TD_HEURISTIC_HISTORICAL_EDITED_FILES = td_heuristic_historical_edited_files json TD_HEURISTIC_PREVIOUSLY_FAILED = previous_failures json TD_HEURISTIC_PREVIOUSLY_FAILED_ADDITIONAL = previous_failures_additional json FILE_CACHE_LIFESPAN_SECONDS = datetime timedelta hours= seconds fetch_and_cache dirpath str &#124; Path name str url str process_fn Callable dict str Any dict str Any - dict str Any This fetch cache utils allows sharing between different process Path dirpath mkdir exist_ok=True path = os path join dirpath name print f Downloading url path is_cached_file_valid - bool Check file new enough see FILE_CACHE_LIFESPAN_SECONDS A real check could make HEAD request check store file s ETag fname = Path path now = datetime datetime now mtime = datetime datetime fromtimestamp fname stat st_mtime diff = now - mtime diff total_seconds FILE_CACHE_LIFESPAN_SECONDS os path exists path is_cached_file_valid Another test process already download file so don t re-do open path f cast dict str Any json load f _ range try contents = urlopen url timeout= read decode utf- processed_contents = process_fn json loads contents open path w f f write json dumps processed_contents processed_contents except Exception e print f Could download url because e print f All retries exhausted downloading url failed get_test_times - dict str dict str float get_from_test_infra_generated_stats test-times json TEST_TIMES_FILE Couldn t download test times get_test_class_times - dict str dict str float get_from_test_infra_generated_stats test-class-times json TEST_CLASS_TIMES_FILE Couldn t download test times get_disabled_tests dirpath str filename str = DISABLED_TESTS_FILE - dict str Any &#124; None process_disabled_test the_response dict str Any - dict str Any remove re-enabled tests condense even further getting rid pr_num disabled_issues = get_disabled_issues disabled_test_from_issues = test_name pr_num link platforms the_response items pr_num disabled_issues disabled_test_from_issues test_name = link platforms disabled_test_from_issues try url = https ossci-metrics s amazonaws com disabled-tests-condensed json fetch_and_cache dirpath filename url process_disabled_test except Exception print Couldn t download test skip set leaving all tests enabled get_test_file_ratings - dict str Any get_from_test_infra_generated_stats file_test_rating json TEST_FILE_RATINGS_FILE Couldn t download test file ratings file reordering get_test_class_ratings - dict str Any get_from_test_infra_generated_stats file_test_class_rating json TEST_CLASS_RATINGS_FILE Couldn t download test ratings file reordering get_td_heuristic_historial_edited_files_json - dict str Any get_from_test_infra_generated_stats td_heuristic_historical_edited_files json TD_HEURISTIC_HISTORICAL_EDITED_FILES Couldn t download td_heuristic_historical_edited_files json reordering get_td_heuristic_profiling_json - dict str Any get_from_test_infra_generated_stats td_heuristic_profiling json TD_HEURISTIC_PROFILING_FILE Couldn t download td_heuristic_profiling json reordering copy_pytest_cache - None original_path = REPO_ROOT pytest_cache v cache lastfailed original_path exists shutil copyfile original_path REPO_ROOT ADDITIONAL_CI_FILES_FOLDER TD_HEURISTIC_PREVIOUSLY_FAILED copy_additional_previous_failures - None original_path = REPO_ROOT pytest_cache TD_HEURISTIC_PREVIOUSLY_FAILED_ADDITIONAL original_path exists shutil copyfile original_path REPO_ROOT ADDITIONAL_CI_FILES_FOLDER TD_HEURISTIC_PREVIOUSLY_FAILED_ADDITIONAL get_from_test_infra_generated_stats from_file str to_file str failure_explanation str - dict str Any url = f https raw githubusercontent com pytorch test-infra generated-stats stats from_file try fetch_and_cache REPO_ROOT ADDITIONAL_CI_FILES_FOLDER to_file url lambda x x except Exception print failure_explanation
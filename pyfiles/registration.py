mypy allow-untyped-defs Module handling symbolic function registration warnings collections abc Callable Collection Sequence typing Generic Optional TypeVar Union typing_extensions ParamSpec torch onnx _constants errors OpsetVersion = int _dispatch_opset_version target OpsetVersion registered_opsets Collection OpsetVersion - Optional OpsetVersion Finds registered opset given target opset version available opsets Args target The target opset version registered_opsets The available opsets Returns The registered opset version registered_opsets None descending_registered_versions = sorted registered_opsets reverse=True Linear search opset version which fine since number opset versions small target = _constants ONNX_BASE_OPSET Always look down toward opset when target = ONNX_BASE_OPSET opset When custom op register opset we want able discover fallback all opsets = ONNX_BASE_OPSET version descending_registered_versions version = target version None target opset This legacy behavior support opset opset caffe support We search up toward opset version reversed descending_registered_versions Count back up until _constants ONNX_BASE_OPSET target = version = _constants ONNX_BASE_OPSET version None _K = TypeVar _K _V = TypeVar _V _R = TypeVar _R _P = ParamSpec _P OverrideDict Collection _K Generic _K _V A dictionary merges built-in custom symbolic functions It supports overriding un-overriding built-in symbolic functions custom ones __init__ - None _base dict _K _V = _overrides dict _K _V = _merged dict _K _V = set_base key _K value _V - None _base key = value key _overrides _merged key = value in_base key _K - bool Checks key base dictionary key _base override key _K value _V - None Overrides base key-value new pair _overrides key = value _merged key = value remove_override key _K - None Un-overrides key-value pair _overrides pop key None type ignore arg-type _merged pop key None type ignore arg-type key _base _merged key = _base key overridden key _K - bool Checks key-value pair overridden key _overrides __getitem__ key _K - _V _merged key get key _K default Optional _V = None _merged get key default __contains__ key object - bool key _merged __iter__ iter _merged __len__ - int len _merged __repr__ - str f OverrideDict base= _base overrides= _overrides __bool__ - bool bool _merged _SymbolicFunctionGroup Different versions symbolic functions registered same name O number registered versions op search performed find most recent version op The registration delayed until op used improve startup time Function overloads different arguments allowed Custom op overrides supported __init__ name str - None _name = name A dictionary functions keyed opset version _functions OverrideDict OpsetVersion Callable = OverrideDict __repr__ - str f _SymbolicFunctionGroup _name registered= _functions __getitem__ key OpsetVersion - Callable result = get key result None raise KeyError key result TODO justinchuby Add functools lru_cache maxsize=None lookup time becomes problem get opset OpsetVersion - Optional Callable Find most recent version function version = _dispatch_opset_version opset _functions version None None _functions version add func Callable opset OpsetVersion - None Adds symbolic function Args func The function add opset The opset version function add _functions in_base opset warnings warn f Symbolic function _name already registered opset opset f Replacing existing function new function This unexpected f Please report _constants PYTORCH_GITHUB_ISSUES_URL errors OnnxExporterWarning stacklevel= _functions set_base opset func add_custom func Callable opset OpsetVersion - None Adds custom symbolic function Args func The symbolic function register opset The corresponding opset version _functions override opset func remove_custom opset OpsetVersion - None Removes custom symbolic function Args opset The opset version custom function remove _functions overridden opset warnings warn f No custom function registered _name opset opset stacklevel= _functions remove_override opset get_min_supported - OpsetVersion Returns lowest built-in opset version supported function min _functions SymbolicRegistry Registry symbolic functions The registry maintains mapping qualified names symbolic functions It used register new symbolic functions dispatch calls appropriate function __init__ - None _registry dict str _SymbolicFunctionGroup = register name str opset OpsetVersion func Callable custom bool = False - None Registers symbolic function Args name The qualified name function register In form domain op E g aten add opset The opset version function register func The symbolic function register custom Whether function custom function overrides existing ones Raises ValueError If separator name name raise ValueError f The name must form domain op name symbolic_functions = _registry setdefault name _SymbolicFunctionGroup name custom symbolic_functions add_custom func opset symbolic_functions add func opset unregister name str opset OpsetVersion - None Unregisters symbolic function Args name The qualified name function unregister opset The opset version function unregister name _registry _registry name remove_custom opset get_function_group name str - Optional _SymbolicFunctionGroup Returns function group given name _registry get name is_registered_op name str version int - bool Returns whether given op registered given opset version functions = get_function_group name functions None False functions get version None all_functions - set str Returns set all registered function names set _registry onnx_symbolic name str opset Union OpsetVersion Sequence OpsetVersion decorate Optional Sequence Callable = None custom bool = False - Callable Registers symbolic function Usage ` ` ` onnx_symbolic aten symbolic_b opset= decorate= quantized_aten_handler scale= zero_point= symbolic_helper parse_args v v b symbolic_b g _C Graph x _C Value y _C Value arg bool - _C Value ` ` ` Args name The qualified name function form domain op E g aten add opset The opset versions function register decorate A sequence decorators apply function custom Whether function custom symbolic function Raises ValueError If separator name wrapper func Callable _P _R - Callable _P _R decorated = func decorate None decorate_func decorate decorated = decorate_func decorated global registry nonlocal opset isinstance opset OpsetVersion opset = opset opset_version opset registry register name opset_version decorated custom=custom Return original function because decorators decorate only specific instance being registered func wrapper custom_onnx_symbolic name str opset Union OpsetVersion Sequence OpsetVersion decorate Optional Sequence Callable = None - Callable Registers custom symbolic function Args name qualified name function opset opset version function decorate sequence decorators apply function Returns The decorator Raises ValueError If separator name onnx_symbolic name opset decorate custom=True The registry all symbolic functions registry = SymbolicRegistry
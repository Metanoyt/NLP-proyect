======= BEGIN Dynamo patch ======= Owner s module dynamo ruff noqa flake noqa Test copied https raw githubusercontent com python cpython refs tags v Lib test test_sys py sys torch torch _dynamo test_case unittest torch _dynamo test_case CPythonTestCase torch testing _internal common_utils run_tests __TestCase = CPythonTestCase redirect statements sys importlib abc redirect_imports = test mapping_tests test typinganndata test test_grammar test test_math test test_iter test typinganndata ann_module RedirectImportFinder importlib abc MetaPathFinder find_spec fullname path target=None Check problematic one fullname redirect_imports try Attempt standalone module name = fullname removeprefix test r = importlib import_module name Redirect module sys modules sys modules fullname = r Return module spec found module importlib util find_spec name except ImportError None None Add custom finder sys meta_path sys meta_path insert RedirectImportFinder ======= END DYNAMO PATCH ======= builtins codecs _datetime gc io locale operator os random struct subprocess sys sysconfig test support test support test support os_helper test support script_helper assert_python_ok assert_python_failure test support threading_helper test support import_helper test support force_not_colorized try test support interpreters except ImportError interpreters = None textwrap unittest warnings requires_subinterpreters meth Decorator skip test subinterpreters supported unittest skipIf interpreters None subinterpreters required meth DICT_KEY_STRUCT_FORMAT = n BI n DisplayHookTest __TestCase test_original_displayhook dh = sys __displayhook__ support captured_stdout out dh assertEqual out getvalue \n assertEqual builtins _ del builtins _ support captured_stdout out dh None assertEqual out getvalue assertTrue hasattr builtins _ sys displayhook requires arguments assertRaises TypeError dh stdout = sys stdout try del sys stdout assertRaises RuntimeError dh finally sys stdout = stdout test_lost_displayhook displayhook = sys displayhook try del sys displayhook code = compile string single assertRaises RuntimeError eval code finally sys displayhook = displayhook test_custom_displayhook baddisplayhook obj raise ValueError support swap_attr sys displayhook baddisplayhook code = compile string single assertRaises ValueError eval code ActiveExceptionTests __TestCase test_exc_info_no_exception assertEqual sys exc_info None None None test_sys_exception_no_exception assertEqual sys exception None test_exc_info_with_exception_instance f raise ValueError try f except Exception e_ e = e_ exc_info = sys exc_info assertIsInstance e ValueError assertIs exc_info ValueError assertIs exc_info e assertIs exc_info e __traceback__ test_exc_info_with_exception_type f raise ValueError try f except Exception e_ e = e_ exc_info = sys exc_info assertIsInstance e ValueError assertIs exc_info ValueError assertIs exc_info e assertIs exc_info e __traceback__ test_sys_exception_with_exception_instance f raise ValueError try f except Exception e_ e = e_ exc = sys exception assertIsInstance e ValueError assertIs exc e test_sys_exception_with_exception_type f raise ValueError try f except Exception e_ e = e_ exc = sys exception assertIsInstance e ValueError assertIs exc e ExceptHookTest __TestCase force_not_colorized test_original_excepthook try raise ValueError except ValueError exc support captured_stderr err sys __excepthook__ sys exc_info assertTrue err getvalue endswith ValueError \n assertRaises TypeError sys __excepthook__ force_not_colorized test_excepthook_bytes_filename bpo- sys excepthook must crash filename bytes string warnings catch_warnings warnings simplefilter ignore BytesWarning try raise SyntaxError msg b bytes_filename text except SyntaxError exc support captured_stderr err sys __excepthook__ sys exc_info err = err getvalue assertIn File b bytes_filename line \n err assertIn text\n err assertTrue err endswith SyntaxError msg\n test_excepthook test support captured_output stderr stderr test support catch_unraisable_exception sys excepthook assertTrue TypeError print_exception Exception expected \ value str found stderr getvalue FIXME testing code lost replaced excepthook Python pythonrun c PyErr_PrintEx tricky SysModuleTest __TestCase tearDown test support reap_children test_exit call two arguments assertRaises TypeError sys exit call without argument assertRaises SystemExit cm sys exit assertIsNone cm exception code rc out err = assert_python_ok -c sys sys exit assertEqual rc assertEqual out b assertEqual err b gh- Windows uses -bit unsigned integers exit codes so - exit code sometimes interpreted xffff_ffff rc out err = assert_python_failure -c sys sys exit xffff_ffff assertIn rc - xff xffff_ffff assertEqual out b assertEqual err b Overflow results - exit code which may converted xff xffff_ffff rc out err = assert_python_failure -c sys sys exit assertIn rc - xff xffff_ffff assertEqual out b assertEqual err b call integer argument assertRaises SystemExit cm sys exit assertEqual cm exception code call tuple argument one entry entry will unpacked assertRaises SystemExit cm sys exit assertEqual cm exception code call string argument assertRaises SystemExit cm sys exit exit assertEqual cm exception code exit call tuple argument two entries assertRaises SystemExit cm sys exit assertEqual cm exception code test exit machinery handles SystemExits properly rc out err = assert_python_failure -c raise SystemExit assertEqual rc assertEqual out b assertEqual err b check_exit_message code expected env_vars rc out err = assert_python_failure -c code env_vars assertEqual rc assertEqual out b assertTrue err startswith expected s doesn t start s ascii err ascii expected test stderr buffer flushed before exit message written into stderr check_exit_message r sys sys stderr write unflushed sys exit message b unflushed message test exit message written backslashreplace error handler stderr check_exit_message r sys sys exit surrogates \uDCFF b surrogates \\udcff test unicode message encoded stderr encoding instead default encoding utf check_exit_message r sys sys exit h\xe b h\xe PYTHONIOENCODING= latin- support requires_subprocess test_exit_codes_under_repl GH- SystemExit things raised didn t get their code propagated REPL tempfile exit_ways = exit __import__ sys exit raise SystemExit exitfunc exit_ways return_code subTest exitfunc=exitfunc return_code=return_code tempfile TemporaryFile w+ stdin stdin write f exitfunc return_code \n stdin seek proc = subprocess run sys executable stdin=stdin assertEqual proc returncode return_code test_getdefaultencoding assertRaises TypeError sys getdefaultencoding can t check more than type user might have changed assertIsInstance sys getdefaultencoding str testing sys settrace done test_sys_settrace py testing sys setprofile done test_sys_setprofile py test_switchinterval assertRaises TypeError sys setswitchinterval assertRaises TypeError sys setswitchinterval assertRaises ValueError sys setswitchinterval - assertRaises ValueError sys setswitchinterval orig = sys getswitchinterval sanity check assertTrue orig orig try n orig sys setswitchinterval n assertAlmostEqual sys getswitchinterval n finally sys setswitchinterval orig test_getrecursionlimit limit = sys getrecursionlimit assertIsInstance limit int assertGreater limit assertRaises TypeError sys getrecursionlimit test_setrecursionlimit old_limit = sys getrecursionlimit try sys setrecursionlimit _ assertEqual sys getrecursionlimit _ assertRaises TypeError sys setrecursionlimit assertRaises ValueError sys setrecursionlimit - finally sys setrecursionlimit old_limit test_recursionlimit_recovery hasattr sys gettrace sys gettrace skipTest fatal error run trace function old_limit = sys getrecursionlimit f f try depth try sys setrecursionlimit depth except RecursionError Issue The recursion limit too low current recursion depth continue Issue test stack overflow after hitting recursion limit twice assertRaises RecursionError f assertRaises RecursionError f finally sys setrecursionlimit old_limit test support cpython_only test_setrecursionlimit_to_depth Issue Setting low recursion limit must blocked current recursion depth already higher than limit old_limit = sys getrecursionlimit try depth = support get_recursion_depth subTest limit=sys getrecursionlimit depth=depth depth + OK sys setrecursionlimit depth + reset limit able call assertRaises context manager sys setrecursionlimit old_limit assertRaises RecursionError cm sys setrecursionlimit depth assertRegex str cm exception cannot set recursion limit - + recursion depth - + limit too low finally sys setrecursionlimit old_limit unittest skipUnless support Py_GIL_DISABLED only meaningful GIL disabled threading_helper requires_working_threading test_racing_recursion_limit threading Thread something_recursive count n n count n - + count set_recursion_limit limit range sys setrecursionlimit limit threads = _ range threads append Thread target=set_recursion_limit _ range threads append Thread target=something_recursive threading_helper catch_threading_exception cm threading_helper start_threads threads pass cm exc_value raise cm exc_value test_getwindowsversion Raise SkipTest sys doesn t have getwindowsversion attribute test support get_attribute sys getwindowsversion v = sys getwindowsversion assertEqual len v assertIsInstance v int assertIsInstance v int assertIsInstance v int assertIsInstance v int assertIsInstance v str assertRaises IndexError operator getitem v assertIsInstance v major int assertIsInstance v minor int assertIsInstance v build int assertIsInstance v platform int assertIsInstance v service_pack str assertIsInstance v service_pack_minor int assertIsInstance v service_pack_major int assertIsInstance v suite_mask int assertIsInstance v product_type int assertEqual v v major assertEqual v v minor assertEqual v v build assertEqual v v platform assertEqual v v service_pack This how platform py calls Make sure tuple still has elements maj min buildno plat csd = sys getwindowsversion test_call_tracing assertRaises TypeError sys call_tracing type unittest skipUnless hasattr sys setdlopenflags test needs sys setdlopenflags test_dlopenflags assertTrue hasattr sys getdlopenflags assertRaises TypeError sys getdlopenflags oldflags = sys getdlopenflags assertRaises TypeError sys setdlopenflags sys setdlopenflags oldflags+ assertEqual sys getdlopenflags oldflags+ sys setdlopenflags oldflags test support refcount_test test_refcount n here originally had global order test pass while tracing python function Tracing used call PyFrame_FastToLocals which would add copy any locals frame object causing ref count increase instead While no longer happens due PEP test case retains its original global-based implementation PEP s immortal objects also made point moot since refcount None doesn t change anyway Maybe test should using different constant value e g integer global n assertRaises TypeError sys getrefcount c = sys getrefcount None n = None Singleton refcnts don t change assertEqual sys getrefcount None c del n assertEqual sys getrefcount None c hasattr sys gettotalrefcount assertIsInstance sys gettotalrefcount int test_getframe assertRaises TypeError sys _getframe assertRaises ValueError sys _getframe assertTrue SysModuleTest test_getframe __code__ \ sys _getframe f_code unittest expectedFailure test_getframemodulename Default depth gets ourselves assertEqual __name__ sys _getframemodulename assertEqual unittest case sys _getframemodulename i = f = sys _getframe i while f assertEqual f f_globals __name__ sys _getframemodulename i __main__ i += f = f f_back try f = sys _getframe i except ValueError break assertIs f f assertIsNone sys _getframemodulename i sys _current_frames CPython-only gimmick threading_helper reap_threads threading_helper requires_working_threading test_current_frames threading traceback Spawn thread blocks known place Then main thread does sys _current_frames verifies frames returned make sense entered_g = threading Event leave_g = threading Event thread_info = thread s id f g g thread_info append threading get_ident entered_g set leave_g wait t = threading Thread target=f t start entered_g wait try At point t has finished its entered_g set although s impossible guess whether s still line has moved its leave_g wait assertEqual len thread_info thread_id = thread_info d = sys _current_frames tid d assertIsInstance tid int assertGreater tid main_id = threading get_ident assertIn main_id d assertIn thread_id d Verify captured main-thread frame _this_ frame frame = d pop main_id assertTrue frame sys _getframe Verify captured thread frame blocked g called f This little tricky since various bits threading py also thread s call stack frame = d pop thread_id stack = traceback extract_stack frame i filename lineno funcname sourceline enumerate stack funcname == f break fail didn t find f thread s call stack assertEqual sourceline g And next record must g filename lineno funcname sourceline = stack i+ assertEqual funcname g assertIn sourceline leave_g wait entered_g set finally Reap spawned thread leave_g set t join threading_helper reap_threads threading_helper requires_working_threading test_current_exceptions threading traceback Spawn thread blocks known place Then main thread does sys _current_frames verifies frames returned make sense g_raised = threading Event leave_g = threading Event thread_info = thread s id f g g thread_info append threading get_ident while True try raise ValueError oops except ValueError g_raised set leave_g wait timeout=support LONG_TIMEOUT break t = threading Thread target=f t start g_raised wait timeout=support LONG_TIMEOUT try assertEqual len thread_info thread_id = thread_info d = sys _current_exceptions tid d assertIsInstance tid int assertGreater tid main_id = threading get_ident assertIn main_id d assertIn thread_id d assertEqual None d pop main_id Verify captured thread frame blocked g called f This little tricky since various bits threading py also thread s call stack exc_value = d pop thread_id stack = traceback extract_stack exc_value __traceback__ tb_frame i filename lineno funcname sourceline enumerate stack funcname == f break fail didn t find f thread s call stack assertEqual sourceline g And next record must g filename lineno funcname sourceline = stack i+ assertEqual funcname g assertTrue sourceline startswith leave_g wait sourceline startswith g_raised set finally Reap spawned thread leave_g set t join test_attributes assertIsInstance sys api_version int assertIsInstance sys argv list arg sys argv assertIsInstance arg str assertIsInstance sys orig_argv list arg sys orig_argv assertIsInstance arg str assertIn sys byteorder little big assertIsInstance sys builtin_module_names tuple assertIsInstance sys copyright str assertIsInstance sys exec_prefix str assertIsInstance sys base_exec_prefix str assertIsInstance sys executable str assertEqual len sys float_info assertEqual sys float_info radix assertEqual len sys int_info assertTrue sys int_info bits_per_digit == assertTrue sys int_info sizeof_digit = assertGreaterEqual sys int_info default_max_str_digits assertGreaterEqual sys int_info str_digits_check_threshold assertGreater sys int_info default_max_str_digits sys int_info str_digits_check_threshold assertEqual type sys int_info bits_per_digit int assertEqual type sys int_info sizeof_digit int assertIsInstance sys int_info default_max_str_digits int assertIsInstance sys int_info str_digits_check_threshold int assertIsInstance sys hexversion int assertEqual len sys hash_info assertLess sys hash_info modulus sys hash_info width sys hash_info modulus should prime we do quick probable primality test doesn t exclude possibility Carmichael number x range assertEqual pow x sys hash_info modulus- sys hash_info modulus sys hash_info modulus non-prime format sys hash_info modulus assertIsInstance sys hash_info inf int assertIsInstance sys hash_info nan int assertIsInstance sys hash_info imag int algo = sysconfig get_config_var Py_HASH_ALGORITHM sys hash_info algorithm fnv siphash siphash assertIn sys hash_info hash_bits assertIn sys hash_info seed_bits algo == assertEqual sys hash_info algorithm siphash algo == assertEqual sys hash_info algorithm fnv algo == assertEqual sys hash_info algorithm siphash assertIn sys hash_info algorithm fnv siphash siphash PY_HASH_EXTERNAL assertEqual algo assertGreaterEqual sys hash_info cutoff assertLess sys hash_info cutoff assertIsInstance sys maxsize int assertIsInstance sys maxunicode int assertEqual sys maxunicode x FFFF assertIsInstance sys platform str assertIsInstance sys prefix str assertIsInstance sys base_prefix str assertIsInstance sys platlibdir str assertIsInstance sys version str vi = sys version_info assertIsInstance vi tuple assertEqual len vi assertIsInstance vi int assertIsInstance vi int assertIsInstance vi int assertIn vi alpha beta candidate final assertIsInstance vi int assertIsInstance vi major int assertIsInstance vi minor int assertIsInstance vi micro int assertIn vi releaselevel alpha beta candidate final assertIsInstance vi serial int assertEqual vi vi major assertEqual vi vi minor assertEqual vi vi micro assertEqual vi vi releaselevel assertEqual vi vi serial assertTrue vi assertIsInstance sys float_repr_style str assertIn sys float_repr_style short legacy sys platform startswith win assertIsInstance sys abiflags str test_thread_info info = sys thread_info assertEqual len info assertIn info name nt pthread pthread-stubs solaris None assertIn info lock semaphore mutex+cond None sys platform startswith linux android freebsd assertEqual info name pthread sys platform == win assertEqual info name nt sys platform == emscripten assertIn info name pthread pthread-stubs sys platform == wasi assertEqual info name pthread-stubs unittest skipUnless support is_emscripten only available Emscripten test_emscripten_info assertEqual len sys _emscripten_info assertIsInstance sys _emscripten_info emscripten_version tuple assertIsInstance sys _emscripten_info runtime str type None assertIsInstance sys _emscripten_info pthreads bool assertIsInstance sys _emscripten_info shared_memory bool test_ Can t use sys stdout StringIO object when test runs under regrtest assertEqual sys __stdout__ encoding sys __stderr__ encoding test_intern has_is_interned = test support check_impl_detail cpython=True hasattr sys _is_interned assertRaises TypeError sys intern assertRaises TypeError sys intern b abc has_is_interned assertRaises TypeError sys _is_interned assertRaises TypeError sys _is_interned b abc s = never interned before + str random randrange assertTrue sys intern s s has_is_interned assertIs sys _is_interned s True s = s swapcase swapcase has_is_interned assertIs sys _is_interned s False assertTrue sys intern s s has_is_interned assertIs sys _is_interned s False Subclasses string can t interned because they provide too much opportunity insane things happen We don t want them interned dict they aren t actually interned we don t want create appearance they allowing intern succeed S str __hash__ assertRaises TypeError sys intern S abc has_is_interned assertIs sys _is_interned S abc False support cpython_only requires_subinterpreters test_subinterp_intern_dynamically_allocated Implementation detail Dynamically allocated strings distinct between interpreters s = never interned before + str random randrange t = sys intern s assertIs t s interp = interpreters create interp exec textwrap dedent f sys set ` s ` avoid parser interning constant folding s = str s encode r utf- t = sys intern s assert id t = id s id t id s assert id t = id t id t id t support cpython_only requires_subinterpreters test_subinterp_intern_statically_allocated Implementation detail Statically allocated strings shared between interpreters See Tools build generate_global_objects py list strings always statically allocated s __init__ CANCELLED module utf- \n _ x \ \N CEDILLA \xff subTest s=s t = sys intern s interp = interpreters create interp exec textwrap dedent f sys set ` s ` avoid parser interning constant folding s = str s encode r utf- t = sys intern s assert id t == id t id t id t support cpython_only requires_subinterpreters test_subinterp_intern_singleton Implementation detail singletons used - -character latin strings s \n _ x \ \N CEDILLA \xff subTest s=s interp = interpreters create interp exec textwrap dedent f sys set ` s ` avoid parser interning constant folding s = str s encode r utf- assert id s == id s t = sys intern s assertTrue sys _is_interned s test_sys_flags assertTrue sys flags attrs = debug inspect interactive optimize dont_write_bytecode no_user_site no_site ignore_environment verbose bytes_warning quiet hash_randomization isolated dev_mode utf _mode warn_default_encoding safe_path int_max_str_digits attr attrs assertTrue hasattr sys flags attr attr attr_type = bool attr dev_mode safe_path int assertEqual type getattr sys flags attr attr_type attr assertTrue repr sys flags assertEqual len sys flags len attrs assertIn sys flags utf _mode assert_raise_on_new_sys_type sys_attr Users intentionally prevented creating new instances sys flags sys version_info sys getwindowsversion arg = sys_attr attr_type = type sys_attr assertRaises TypeError attr_type arg assertRaises TypeError attr_type __new__ attr_type arg test_sys_flags_no_instantiation assert_raise_on_new_sys_type sys flags test_sys_version_info_no_instantiation assert_raise_on_new_sys_type sys version_info test_sys_getwindowsversion_no_instantiation Skip being run Windows test support get_attribute sys getwindowsversion assert_raise_on_new_sys_type sys getwindowsversion test support cpython_only test_clear_type_cache sys _clear_type_cache force_not_colorized support requires_subprocess test_ioencoding env = dict os environ Test character cent sign encoded x A ASCII J CP representable ASCII env PYTHONIOENCODING = cp p = subprocess Popen sys executable -c print chr xa stdout = subprocess PIPE env=env out = p communicate strip expected = \xa + os linesep encode cp assertEqual out expected env PYTHONIOENCODING = ascii replace p = subprocess Popen sys executable -c print chr xa stdout = subprocess PIPE env=env out = p communicate strip assertEqual out b env PYTHONIOENCODING = ascii p = subprocess Popen sys executable -c print chr xa stdout=subprocess PIPE stderr=subprocess PIPE env=env out err = p communicate assertEqual out b assertIn b UnicodeEncodeError err assertIn rb \xa err env PYTHONIOENCODING = ascii p = subprocess Popen sys executable -c print chr xa stdout=subprocess PIPE stderr=subprocess PIPE env=env out err = p communicate assertEqual out b assertIn b UnicodeEncodeError err assertIn rb \xa err env PYTHONIOENCODING = surrogateescape p = subprocess Popen sys executable -c print chr xdcbd stdout=subprocess PIPE env=env out = p communicate strip assertEqual out b \xbd unittest skipUnless os_helper FS_NONASCII requires OS support non-ASCII encodings unittest skipUnless sys getfilesystemencoding == locale getpreferredencoding False requires FS encoding match locale support requires_subprocess test_ioencoding_nonascii env = dict os environ env PYTHONIOENCODING = p = subprocess Popen sys executable -c print os_helper FS_NONASCII stdout=subprocess PIPE env=env out = p communicate strip assertEqual out os fsencode os_helper FS_NONASCII unittest skipIf sys base_prefix = sys prefix Test venv-compatible support requires_subprocess test_executable sys executable should absolute assertEqual os path abspath sys executable sys executable Issue Ensure sys executable empty string argv has been set non existent program name Python unable retrieve real program name For normal installation should work without cwd argument For test runs build directory see python_dir = os path dirname os path realpath sys executable p = subprocess Popen nonexistent -c sys print sys executable encode ascii backslashreplace executable=sys executable stdout=subprocess PIPE cwd=python_dir stdout = p communicate executable = stdout strip decode ASCII p wait assertIn executable b repr sys executable encode ascii backslashreplace check_fsencoding fs_encoding expected=None assertIsNotNone fs_encoding codecs lookup fs_encoding expected assertEqual fs_encoding expected test_getfilesystemencoding fs_encoding = sys getfilesystemencoding sys platform == darwin expected = utf- expected = None check_fsencoding fs_encoding expected c_locale_get_error_handler locale isolated=False encoding=None Force POSIX locale env = os environ copy env LC_ALL = locale env PYTHONCOERCECLOCALE = code = \n join sys dump name std = getattr sys name print s s name std errors dump stdin dump stdout dump stderr args = sys executable -X utf = -c code isolated args append -I encoding None env PYTHONIOENCODING = encoding env pop PYTHONIOENCODING None p = subprocess Popen args stdout=subprocess PIPE stderr=subprocess STDOUT env=env universal_newlines=True stdout stderr = p communicate stdout check_locale_surrogateescape locale out = c_locale_get_error_handler locale isolated=True assertEqual out stdin surrogateescape\n stdout surrogateescape\n stderr backslashreplace\n replace default error handler out = c_locale_get_error_handler locale encoding= ignore assertEqual out stdin ignore\n stdout ignore\n stderr backslashreplace\n force encoding out = c_locale_get_error_handler locale encoding= iso - assertEqual out stdin strict\n stdout strict\n stderr backslashreplace\n out = c_locale_get_error_handler locale encoding= iso - assertEqual out stdin strict\n stdout strict\n stderr backslashreplace\n have no any effect out = c_locale_get_error_handler locale encoding= assertEqual out stdin surrogateescape\n stdout surrogateescape\n stderr backslashreplace\n out = c_locale_get_error_handler locale encoding= assertEqual out stdin surrogateescape\n stdout surrogateescape\n stderr backslashreplace\n support requires_subprocess test_c_locale_surrogateescape check_locale_surrogateescape C support requires_subprocess test_posix_locale_surrogateescape check_locale_surrogateescape POSIX test_implementation This test applies all implementations equally levels = alpha xA beta xB candidate xC final xF assertTrue hasattr sys implementation name assertTrue hasattr sys implementation version assertTrue hasattr sys implementation hexversion assertTrue hasattr sys implementation cache_tag version = sys implementation version assertEqual version version major version minor hexversion = version major &#124; version minor &#124; version micro &#124; levels version releaselevel &#124; version serial assertEqual sys implementation hexversion hexversion PEP requires name lower case assertEqual sys implementation name sys implementation name lower test support cpython_only test_debugmallocstats Test sys _debugmallocstats test support script_helper assert_python_ok args = -c sys sys _debugmallocstats ret out err = assert_python_ok args Output sys _debugmallocstats depends configure flags The sysconfig vars available Windows sys platform = win with_freelists = sysconfig get_config_var WITH_FREELISTS with_pymalloc = sysconfig get_config_var WITH_PYMALLOC with_freelists assertIn b free PyDictObjects err with_pymalloc assertIn b Small block threshold err with_freelists with_pymalloc assertFalse err The function has no parameter assertRaises TypeError sys _debugmallocstats True unittest skipUnless hasattr sys getallocatedblocks sys getallocatedblocks unavailable build test_getallocatedblocks try _testinternalcapi except ImportError with_pymalloc = support with_pymalloc try alloc_name = _testinternalcapi pymem_getallocatorsname except RuntimeError exc cannot get allocators name ex tracemalloc used with_pymalloc = True with_pymalloc = alloc_name pymalloc pymalloc_debug Some sanity checks = sys getallocatedblocks assertIs type int with_pymalloc assertGreater When WITH_PYMALLOC isn t available we don t know anything about underlying implementation function might something greater assertGreaterEqual try While we could imagine Python session where number multiple buffer objects would exceed sharing references unlikely happen normal test run assertLess sys gettotalrefcount except AttributeError gettotalrefcount available pass gc collect b = sys getallocatedblocks assertLessEqual b gc collect c = sys getallocatedblocks assertIn c range b - b + test_is_gil_enabled support Py_GIL_DISABLED assertIs type sys _is_gil_enabled bool assertTrue sys _is_gil_enabled test_is_finalizing assertIs sys is_finalizing False Don t use atexit module because _Py_Finalizing only set after calling atexit callbacks code = sys AtExit is_finalizing = sys is_finalizing print = print __del__ print is_finalizing flush=True Keep reference __main__ module namespace so AtExit destructor will called Python exit ref = AtExit rc stdout stderr = assert_python_ok -c code assertEqual stdout rstrip b True test_issue sys flags sys float_info wiped during shutdown code = sys A __del__ sys=sys print sys flags print sys float_info = A rc out err = assert_python_ok -c code out = out splitlines assertIn b sys flags out assertIn b sys float_info out test_sys_ignores_cleaning_up_user_data code = struct sys C __init__ pack = struct pack __del__ pack I - sys x = C rc stdout stderr = assert_python_ok -c code assertEqual rc assertEqual stdout rstrip b assertEqual stderr rstrip b unittest skipUnless sys platform == android Android only test_getandroidapilevel level = sys getandroidapilevel assertIsInstance level int assertGreater level force_not_colorized support requires_subprocess test_sys_tracebacklimit code = sys f f f sys tracebacklimit = r f check tracebacklimit expected p = subprocess Popen sys executable -c code tracebacklimit stderr=subprocess PIPE out = p communicate assertEqual out splitlines expected traceback = b Traceback most recent call last b File string line module b f b ~~^^ b File string line f b f b ~~^^ b File string line f b b ~~^~~ b ZeroDivisionError division zero check traceback check traceback check traceback + traceback check traceback + traceback check traceback - check - traceback - check traceback check - traceback - check None traceback test_no_duplicates_in_meta_path assertEqual len sys meta_path len set sys meta_path unittest skipUnless hasattr sys _enablelegacywindowsfsencoding needs sys _enablelegacywindowsfsencoding test__enablelegacywindowsfsencoding code = sys sys _enablelegacywindowsfsencoding print sys getfilesystemencoding sys getfilesystemencodeerrors rc out err = assert_python_ok -c join code out = out decode ascii replace rstrip assertEqual out mbcs replace support requires_subprocess test_orig_argv code = textwrap dedent sys print sys argv print sys orig_argv args = sys executable -I -X utf -c code arg proc = subprocess run args check=True capture_output=True text=True expected = repr -c arg sys argv repr args sys orig_argv assertEqual proc stdout rstrip splitlines expected proc test_module_names assertIsInstance sys stdlib_module_names frozenset name sys stdlib_module_names assertIsInstance name str test_stdlib_dir os = import_helper import_fresh_module os marker = getattr os __file__ None marker os path exists marker marker = None expected = os path dirname marker marker None assertEqual os path normpath sys _stdlib_dir os path normpath expected unittest skipUnless hasattr sys getobjects need sys getobjects test_getobjects sys getobjects all_objects = sys getobjects assertIsInstance all_objects list assertGreater len all_objects sys getobjects MyType MyType pass size = my_objects = MyType _ range size get_objects = sys getobjects MyType assertEqual len get_objects size obj get_objects assertIsInstance obj MyType sys getobjects MyType get_objects = sys getobjects MyType assertEqual len get_objects unittest skipUnless hasattr sys _stats_on need Py_STATS build test_pystats Call functions just check they don t crash Cannot save restore state sys _stats_on sys _stats_off sys _stats_clear sys _stats_dump test support cpython_only unittest skipUnless hasattr sys abiflags need sys abiflags test_disable_gil_abi assertEqual t sys abiflags support Py_GIL_DISABLED test support cpython_only UnraisableHookTest __TestCase test_original_unraisablehook _testcapi = import_helper import_module _testcapi _testcapi err_writeunraisable err_formatunraisable obj = hex support swap_attr sys unraisablehook sys __unraisablehook__ support captured_stderr stderr err_writeunraisable ValueError obj lines = stderr getvalue splitlines assertEqual lines f Exception ignored obj r assertEqual lines Traceback most recent call last assertEqual lines - ValueError support captured_stderr stderr err_writeunraisable ValueError None lines = stderr getvalue splitlines assertEqual lines Traceback most recent call last assertEqual lines - ValueError support captured_stderr stderr err_formatunraisable ValueError Error R obj lines = stderr getvalue splitlines assertEqual lines f Error obj r assertEqual lines Traceback most recent call last assertEqual lines - ValueError support captured_stderr stderr err_formatunraisable ValueError None lines = stderr getvalue splitlines assertEqual lines Traceback most recent call last assertEqual lines - ValueError test_original_unraisablehook_err bpo- PyErr_WriteUnraisable should give sensible reports BrokenDel __del__ exc = ValueError del broken The following line included traceback report raise exc BrokenStrException Exception __str__ raise Exception str broken BrokenExceptionDel __del__ exc = BrokenStrException The following line included traceback report raise exc test_class BrokenDel BrokenExceptionDel subTest test_class obj = test_class test support captured_stderr stderr \ test support swap_attr sys unraisablehook sys __unraisablehook__ Trigger obj __del__ del obj report = stderr getvalue assertIn Exception ignored report assertIn test_class __del__ __qualname__ report assertIn test_sys py report assertIn raise exc report test_class BrokenExceptionDel assertIn BrokenStrException report assertIn exception str failed report assertIn ValueError report assertIn del broken report assertTrue report endswith \n test_original_unraisablehook_exception_qualname See bpo- bpo- Check exception printed its qualified name rather than just classname module names appears unless one hard-coded exclusions _testcapi = import_helper import_module _testcapi _testcapi err_writeunraisable A B X Exception pass moduleName builtins __main__ some_module subTest moduleName=moduleName A B X __module__ = moduleName test support captured_stderr stderr test support swap_attr sys unraisablehook sys __unraisablehook__ err_writeunraisable A B X obj report = stderr getvalue assertIn A B X __qualname__ report moduleName builtins __main__ assertNotIn moduleName + report assertIn moduleName + report test_original_unraisablehook_wrong_type exc = ValueError test support swap_attr sys unraisablehook sys __unraisablehook__ assertRaises TypeError sys unraisablehook exc test_custom_unraisablehook _testcapi = import_helper import_module _testcapi _testcapi err_writeunraisable err_formatunraisable hook_args = None hook_func args nonlocal hook_args hook_args = args obj = hex try test support swap_attr sys unraisablehook hook_func exc = ValueError err_writeunraisable exc obj assertIs hook_args exc_type type exc assertIs hook_args exc_value exc assertIs hook_args exc_traceback exc __traceback__ assertIsNone hook_args err_msg assertEqual hook_args object obj err_formatunraisable exc custom hook R obj assertIs hook_args exc_type type exc assertIs hook_args exc_value exc assertIs hook_args exc_traceback exc __traceback__ assertEqual hook_args err_msg f custom hook obj r assertIsNone hook_args object finally expected hook_args contain exception break reference cycle expected = None hook_args = None test_custom_unraisablehook_fail _testcapi = import_helper import_module _testcapi _testcapi err_writeunraisable hook_func args raise Exception hook_func failed test support captured_output stderr stderr test support swap_attr sys unraisablehook hook_func err_writeunraisable ValueError custom hook fail err = stderr getvalue assertIn f Exception ignored sys unraisablehook f hook_func r \n err assertIn Traceback most recent call last \n err assertIn Exception hook_func failed\n err test support cpython_only SizeofTest __TestCase setUp P = struct calcsize P longdigit = sys int_info sizeof_digit _testinternalcapi = import_helper import_module _testinternalcapi gc_headsize = _testinternalcapi SIZEOF_PYGC_HEAD managed_pre_header_size = _testinternalcapi SIZEOF_MANAGED_PRE_HEADER super setUp check_sizeof = test support check_sizeof test_gc_head_size Check gc header size added objects tracked gc vsize = test support calcvobjsize gc_header_size = gc_headsize bool objects gc tracked assertEqual sys getsizeof True vsize + longdigit lists assertEqual sys getsizeof vsize Pn + gc_header_size test_errors BadSizeof __sizeof__ raise ValueError assertRaises ValueError sys getsizeof BadSizeof InvalidSizeof __sizeof__ None assertRaises TypeError sys getsizeof InvalidSizeof sentinel = sentinel assertIs sys getsizeof InvalidSizeof sentinel sentinel FloatSizeof __sizeof__ assertRaises TypeError sys getsizeof FloatSizeof assertIs sys getsizeof FloatSizeof sentinel sentinel OverflowSizeof int __sizeof__ int assertEqual sys getsizeof OverflowSizeof sys maxsize sys maxsize + gc_headsize + managed_pre_header_size assertRaises OverflowError sys getsizeof OverflowSizeof sys maxsize + assertRaises ValueError sys getsizeof OverflowSizeof - assertRaises ValueError OverflowError sys getsizeof OverflowSizeof -sys maxsize - test_default size = test support calcvobjsize assertEqual sys getsizeof True size + longdigit assertEqual sys getsizeof True - size + longdigit test_objecttypes check all types defined Objects calcsize = struct calcsize size = test support calcobjsize vsize = test support calcvobjsize check = check_sizeof bool check True vsize + longdigit check False vsize + longdigit buffer XXX builtin_function_or_method check len size P bytearray samples = b b u sample samples x = bytearray sample check x vsize n Pi + x __alloc__ bytearray_iterator check iter bytearray size nP bytes check b vsize n + check b x vsize n + cell get_cell x = inner x inner check get_cell __closure__ size P code check_code_size expected_size assertGreaterEqual sys getsizeof expected_size check_code_size get_cell __code__ size i P check_code_size get_cell __code__ size i P get_cell x inner x inner check_code_size get_cell __code__ size i P + calcsize n complex check complex size d method_descriptor descriptor object check str lower size PPP classmethod_descriptor descriptor object XXX member_descriptor descriptor object datetime check datetime timedelta days size PP getset_descriptor descriptor object collections check collections defaultdict default_factory size PP wrapper_descriptor descriptor object check int __add__ size P P method-wrapper descriptor object check __iter__ size P empty dict check size nQ P dict string key check size nQ P + calcsize DICT_KEY_STRUCT_FORMAT + + calcsize P longdict = str i i i range check longdict size nQ P + calcsize DICT_KEY_STRUCT_FORMAT + + calcsize P dict non-string key check size nQ P + calcsize DICT_KEY_STRUCT_FORMAT + + calcsize n P longdict = check longdict size nQ P + calcsize DICT_KEY_STRUCT_FORMAT + + calcsize n P dictionary-keyview check keys size P dictionary-valueview check values size P dictionary-itemview check items size P dictionary iterator check iter size P nPn dictionary-keyiterator check iter keys size P nPn dictionary-valueiterator check iter values size P nPn dictionary-itemiterator check iter items size P nPn dictproxy C object pass check C __dict__ size P BaseException check BaseException size Pb UnicodeEncodeError check UnicodeEncodeError size Pb P nP UnicodeDecodeError check UnicodeDecodeError b size Pb P nP UnicodeTranslateError check UnicodeTranslateError size Pb P nP ellipses check Ellipsis size EncodingMap codecs encodings iso _ x = codecs charmap_build encodings iso _ decoding_table check x size B iB enumerate check enumerate size n P reverse check reversed size nP float check float size d sys floatinfo check sys float_info vsize + P len sys float_info frame func sys _getframe x = func check x size Pi c P P ic P function func pass check func size Pi c staticmethod foo pass classmethod bar cls pass staticmethod check foo size PP classmethod check bar size PP generator get_gen yield check get_gen size PP P c P ic P iterator check iter abc size lP callable-iterator re check re finditer size P list check list vsize Pn check list vsize Pn + P check list vsize Pn + P check list vsize Pn + P sortwrapper list XXX cmpwrapper list XXX listiterator list check iter size lP listreverseiterator list check reversed size nP int check vsize + longdigit check vsize + longdigit check - vsize + longdigit PyLong_BASE = sys int_info bits_per_digit check int PyLong_BASE vsize + longdigit check int PyLong_BASE - vsize + longdigit check int PyLong_BASE vsize + longdigit module support Py_GIL_DISABLED check unittest size PPPPPP check unittest size PPPPP None check None size NotImplementedType check NotImplemented size object check object size property descriptor object C object getx __x setx value __x = value delx del __x x = property getx setx delx check x size Pi PyCapsule check _datetime datetime_CAPI size P rangeiterator check iter range size l check iter range size P reverse check reversed size nP range check range size P check range size P set frozenset PySet_MINSIZE = samples = range range s = size nP + PySet_MINSIZE nP + nP sample samples minused = len sample minused == tmp = computation minused actually bit more complicated suffices sizeof test minused = minused newsize = PySet_MINSIZE while newsize = minused newsize = newsize newsize = check set sample s check frozenset sample s check set sample s + newsize calcsize nP check frozenset sample s + newsize calcsize nP setiterator check iter set size P n slice check slice size P super check super int size P tuple check vsize check vsize + P type static type PyTypeObject fmt = P nPI Pl Pn Pn PIPc s = vsize fmt check int s s = vsize fmt + PyTypeObject P PyAsyncMethods P PyNumberMethods P PyMappingMethods P PySequenceMethods P PyBufferProcs P PIP Specializer cache newstyleclass object pass Separate block PyDictKeysObject keys entries check newstyleclass s + calcsize DICT_KEY_STRUCT_FORMAT + + calcsize P dict shared keys newstyleclass _ range check newstyleclass __dict__ size nQ P + P o = newstyleclass o = o b = o c = o d = o e = o f = o g = o h = Separate block PyDictKeysObject keys entries check newstyleclass s + calcsize DICT_KEY_STRUCT_FORMAT + + calcsize P dict shared keys check newstyleclass __dict__ size nQ P + P unicode each tuple contains string its expected character size don t put any static strings here they may contain wchar_t UTF- representations samples = \xff \u \uffff \U \U ffff also update field definitions test_unicode test_raiseMemError asciifields = nnb compactfields = asciifields + nP unicodefields = compactfields + P s samples maxchar = ord max s maxchar L = size asciifields + len s + maxchar L = size compactfields + len s + maxchar L = size compactfields + len s + L = size compactfields + len s + check s L verify UTF- size accounted s = chr x bytes canonical representation check s size compactfields + compile will trigger generation UTF- representation side effect compile s stdin eval check s size compactfields + + TODO add check forces presence wchar_t representation TODO add check forces layout unicodefields weakref weakref support Py_GIL_DISABLED expected = size Pn P expected = size Pn P check weakref ref int expected weakproxy XXX weakcallableproxy check weakref proxy int expected check_slots obj base extra expected = sys getsizeof base + struct calcsize extra gc is_tracked obj gc is_tracked base expected += gc_headsize assertEqual sys getsizeof obj expected test_slots check all subclassable types defined Objects allow non-empty __slots__ check = check_slots BA bytearray __slots__ = b c check BA bytearray P D dict __slots__ = b c check D x= x P L list __slots__ = b c check L P S set __slots__ = b c check S set P FS frozenset __slots__ = b c check FS frozenset P collections OrderedDict OD OrderedDict __slots__ = b c check OD x= OrderedDict x= P test_pythontypes check all types defined Python size = test support calcobjsize vsize = test support calcvobjsize check = check_sizeof _ast AST _ast check _ast AST size P try raise TypeError except TypeError e tb = e __traceback__ traceback tb None check tb size P i symtable entry XXX sys flags FIXME The + will necessary once gh- fixed check sys flags vsize + P + len sys flags test_asyncgen_hooks old = sys get_asyncgen_hooks assertIsNone old firstiter assertIsNone old finalizer firstiter = lambda None finalizer = lambda None assertRaises TypeError sys set_asyncgen_hooks firstiter=firstiter finalizer= invalid cur = sys get_asyncgen_hooks assertIsNone cur firstiter assertIsNone cur finalizer gh- assertRaises TypeError sys set_asyncgen_hooks firstiter= invalid finalizer=finalizer cur = sys get_asyncgen_hooks assertIsNone cur firstiter assertIsNone cur finalizer sys set_asyncgen_hooks firstiter=firstiter hooks = sys get_asyncgen_hooks assertIs hooks firstiter firstiter assertIs hooks firstiter assertIs hooks finalizer None assertIs hooks None sys set_asyncgen_hooks finalizer=finalizer hooks = sys get_asyncgen_hooks assertIs hooks firstiter firstiter assertIs hooks firstiter assertIs hooks finalizer finalizer assertIs hooks finalizer sys set_asyncgen_hooks old cur = sys get_asyncgen_hooks assertIsNone cur firstiter assertIsNone cur finalizer test_changing_sys_stderr_and_removing_reference If default displayhook doesn t take strong reference sys stderr following code can crash See bpo- more details code = textwrap dedent sys MyStderr write s sys stderr = None sys stderr = MyStderr rc out err = assert_python_failure -c code assertEqual out b assertEqual err b __name__ == __main__ run_tests
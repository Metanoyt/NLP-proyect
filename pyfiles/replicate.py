collections OrderedDict collections abc Iterator Sequence typing cast Optional TYPE_CHECKING TypeVar Union typing_extensions TypeIs torch torch _utils _get_device_index torch nn modules Module torch nn parallel comm TYPE_CHECKING torch _C ScriptMethod torch jit ScriptModule torch jit _state EnabledProxy __all__ = replicate _is_script_module module Module - TypeIs ScriptModule torch jit isinstance module torch jit ScriptModule _is_script_method module object - TypeIs ScriptMethod torch jit isinstance module torch _C ScriptMethod _init_script_module - ScriptModule torch jit torch jit ScriptModule _is_jit_enabled - EnabledProxy torch jit _state torch jit _state _enabled Check we can safely replicate module there two types module python modules ScriptModule currently module cannot replicated properly descendants any ScriptModule contains python module type above _replicatable_module module Module memo Optional set Module = None - bool module modules contains module itself first element descendant_modules module Module - Iterator Module gen = module modules next gen gen _is_jit_enabled True memo None memo = set memoize visited modules memo add module _is_script_module module memo update descendant_modules module all _is_script_module descendant descendant descendant_modules module child module children since any unreplicatable module will cause check False early visited modules here can safely ignored child memo continue _replicatable_module child memo False True _broadcast_coalesced_reshape tensors Sequence torch Tensor devices Sequence Union int torch device detach bool = False - list list torch Tensor torch nn parallel _functions Broadcast detach comm broadcast_coalesced tensors devices Use autograd function broadcast detach len tensors tensor_copies = Broadcast apply devices tensors tensor_copies i i + len tensors i range len tensor_copies len tensors T = TypeVar T bound=Module replicate network T devices Sequence Union int torch device detach bool = False - list T _replicatable_module network raise RuntimeError Cannot replicate network where python modules children ScriptModule devices devices = _get_device_index x True x devices num_replicas = len devices params = list network parameters param_indices = param idx idx param enumerate params param_copies = _broadcast_coalesced_reshape params devices detach buffers = list network buffers buffers_rg list torch Tensor = buffers_not_rg list torch Tensor = buf buffers buf requires_grad detach buffers_rg append buf buffers_not_rg append buf buffer_indices_rg = buf idx idx buf enumerate buffers_rg buffer_indices_not_rg = buf idx idx buf enumerate buffers_not_rg buffer_copies_rg = _broadcast_coalesced_reshape buffers_rg devices detach=detach buffer_copies_not_rg = _broadcast_coalesced_reshape buffers_not_rg devices detach=True modules = list network modules module_copies list list Module = _ devices module_indices dict Module int = i module enumerate modules module_indices module = i j range num_replicas replica = module _replicate_for_data_parallel This temporary fix DDP DDP needs access replicated model parameters It used do so through ` mode parameters ` The fix added DP stops ` parameters ` API exposing replicated parameters Hence we add ` _former_parameters ` dict here support DDP replica _former_parameters = OrderedDict module_copies j append replica i module enumerate modules key child module _modules items child None j range num_replicas replica = module_copies j i replica _modules key = None module_idx = module_indices child j range num_replicas replica = module_copies j i setattr replica key module_copies j module_idx key param module _parameters items param None j range num_replicas replica = module_copies j i replica _parameters key = None param_idx = param_indices param j range num_replicas replica = module_copies j i param_copy = param_copies j param_idx parameters replicas no longer leaves so setattr them non-parameter attributes setattr replica key param_copy expose parameter DDP replica _former_parameters key = param_copy type ignore operator index key buf module _buffers items type ignore assignment buf None j range num_replicas replica = module_copies j i replica _buffers key = None buf requires_grad detach buffer_copies = buffer_copies_rg buffer_idx = buffer_indices_rg buf buffer_copies = buffer_copies_not_rg buffer_idx = buffer_indices_not_rg buf j range num_replicas replica = module_copies j i setattr replica key buffer_copies j buffer_idx cast T module_copies j j range num_replicas
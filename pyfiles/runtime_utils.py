__future__ annotations functools operator typing Any TYPE_CHECKING torch NOTE other files rely imports below torch _dynamo callback compilation_callback noqa F torch _inductor runtime cache_dir_utils noqa F cache_dir default_cache_dir triton_cache_dir TYPE_CHECKING collections abc Hashable triton_compat Config conditional_product args int - int functools reduce operator mul x x args x ceildiv number int denom int - int - number -denom is_power_of_ n int - bool Returns whether n = m some integer m n n n - == next_power_of_ n int - int Return smallest power greater than equal n n -= n &#124; = n n &#124; = n n &#124; = n n &#124; = n n &#124; = n n &#124; = n n += n get_num_bytes args torch Tensor num_in_out_args int = - int Return total number bytes arguments tensor type takes For out args tensor sizes counted twice once reading once writing The first num_in_out_args arguments out tensors sum arg numel arg element_size + int i num_in_out_args i arg enumerate args isinstance arg torch Tensor triton_config_to_hashable cfg Config - Hashable Convert triton config tuple can uniquely identify We can use value dictionary key pyrefly ignore missing-attribute items = sorted cfg kwargs items pyrefly ignore missing-attribute items append num_warps cfg num_warps pyrefly ignore missing-attribute items append num_stages cfg num_stages tuple items validate_triton_config cfg Config - None Note Triton pre_hook inductor pre-hook lambda function which we don t attempt serialize right now pre-hook attached config will saved then won t used when config loaded cache So we assert - we do get pre_hook might get ignored after caching assert getattr cfg pre_hook None None triton configs pre_hooks supported create_bandwidth_info_str ms float num_gb float gb_per_s float prefix str = suffix str = color bool = True - str info_str = f prefix ms f ms \t num_gb f GB \t gb_per_s f GB s suffix slow = ms gb_per_s red_text info_str color slow info_str get_max_y_grid - int try pyrefly ignore import-error colorama HAS_COLORAMA = True except ModuleNotFoundError HAS_COLORAMA = False colorama = None type ignore assignment HAS_COLORAMA _color_text msg str color str - str pyrefly ignore missing-attribute getattr colorama Fore color upper + msg + colorama Fore RESET _color_text msg str color str - str msg green_text msg str - str _color_text msg green yellow_text msg str - str _color_text msg yellow red_text msg str - str _color_text msg red blue_text msg str - str _color_text msg blue get_first_attr obj Any attrs str - Any Return first available attribute throw exception none present attr attrs hasattr obj attr getattr obj attr raise AssertionError f obj does has any attributes attrs dynamo_timed = torch _dynamo utils dynamo_timed type ignore has-type triton_hash_to_path_key key str - str In early versions Triton hash directly used path name Later hash converted base before being used path name Later base conversion replaced base This code tries _base falls back _base _base unavailable To handle try to-base -conversion function If exists use otherwise try using _base both unavailable use hash directly try triton runtime cache _base _base key except Exception try triton runtime cache _base _base key except Exception key compile_mps_shader source str - Any Compiles shader source raise more actionable error message when needed try torch mps compile_shader source except SyntaxError err raise SyntaxError f failed compile source err msg err
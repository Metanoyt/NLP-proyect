Metrics collection management system Dynamo This module provides context managers gathering reporting metrics during compilation runtime It includes two main components - MetricsContext A context manager collecting metrics during compilation supporting nested contexts various metric types counters sets key-value pairs - RuntimeMetricsContext A specialized context runtime metrics collection doesn t require explicit context management The metrics system enables comprehensive monitoring analysis both compilation execution performance __future__ annotations heapq logging time collections abc Callable typing Any Optional TYPE_CHECKING TypeAlias typing_extensions Self TYPE_CHECKING collections abc Iterator torch utils _traceback CapturedTraceback log = logging getLogger __name__ TopN Helper record list metrics keeping only top N most expensive elements __init__ at_most int = at_most = at_most heap list tuple int Any = add key Any val int - None Push we haven t reached max size push pop smallest fn = heapq heappush len heap at_most heapq heappushpop fn heap val key __len__ - int len heap __iter__ - Iterator tuple Any int key val val key sorted heap reverse=True OnExitType TypeAlias = Callable int int dict str Any Optional type BaseException Optional BaseException None MetricsContext __init__ on_exit OnExitType Use contextmanager create context under which accumulate set metrics e g metrics gathered during compilation On exit contextmanager call provided on_exit function pass dictionary all metrics set during lifetime contextmanager _on_exit = on_exit _metrics dict str Any = _start_time_ns int = _level int = _edits list tuple CapturedTraceback set str = __enter__ - Self Initialize metrics recording _level == In case recursion track outermost context _metrics = _start_time_ns = time time_ns _level += __exit__ exc_type Optional type BaseException exc_value Optional BaseException _traceback Any - None At exit call provided on_exit function _level -= assert _level = _level == try end_time_ns = time time_ns _on_exit _start_time_ns end_time_ns _metrics exc_type exc_value except Exception log exception Unexpected exception logging compilation metrics in_progress - bool True we ve entered context _level increment metric str value int - None Increment metric given amount _level == raise RuntimeError f Cannot increment metric outside MetricsContext metric _metrics _metrics metric = _metrics metric += value _render_edits pred set str - str \n\n + \n\n join Previous Traceback \n + join e format e k _edits k pred set metric str value Any overwrite bool = False - None Set metric given value Raises metric has been assigned previously current context _level == raise RuntimeError f Cannot set metric outside MetricsContext metric _metrics overwrite raise RuntimeError _render_edits metric + f \n\nRuntimeError Metric metric has already been set current context see above current previous traceback _edits append CapturedTraceback extract skip= metric _metrics metric = value set_key_value metric str key str value Any - None Treats give metric dictionary set k value within Note metric must dictionary present We allow called multiple times i e features s uncommon them used multiple times within single compilation _level == raise RuntimeError f Cannot set metric outside MetricsContext metric _metrics _metrics metric = _metrics metric key = value update values dict str Any overwrite bool = False - None Set multiple metrics directly This method does NOT increment Raises any metric has been assigned previously current context overwrite set True _level == raise RuntimeError Cannot update metrics outside MetricsContext existing = _metrics keys values keys existing overwrite raise RuntimeError _render_edits set values keys + f \n\nRuntimeError Metric s existing have already been set current context see above current previous traceback _edits append CapturedTraceback extract skip= set values keys _metrics update values update_outer values dict str Any - None Update only when outermost context _level == raise RuntimeError Cannot update metrics outside MetricsContext _level == update values add_to_set metric str value Any - None Records metric set values _level == raise RuntimeError f Cannot add metric outside MetricsContext metric _metrics _metrics metric = set _metrics metric add value add_top_n metric str key Any val int - None Records metric TopN set values _level == metric _metrics _metrics metric = TopN _metrics metric add key val RuntimeMetricsContext __init__ on_exit OnExitType Similar MetricsContext used gather runtime metrics decoupled compilation where there s natural place insert context manager _on_exit = on_exit _metrics dict str Any = _start_time_ns int = increment metric str value int extra Optional dict str Any = None - None Increment metric given amount _metrics Start timing first entry _start_time_ns = time time_ns metric _metrics _metrics metric = _metrics metric += value extra k v extra items k _metrics v None _metrics k = v finish - None Call on_exit function metrics gathered so far reset _metrics try end_time_ns = time time_ns _on_exit _start_time_ns end_time_ns _metrics None None except Exception log exception Unexpected exception logging runtime metrics finally _metrics =
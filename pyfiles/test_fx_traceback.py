Owner s module fx torch torch _inductor compile_fx aot_export_module torch export default_decompositions torch fx traceback get_graph_provenance_json NodeSource NodeSourceAction torch testing _internal common_utils TestCase CREATE_STR = NodeSourceAction CREATE name lower TestFXNodeSource TestCase test_node_source node_source = NodeSource node=None pass_name= test_pass action=NodeSourceAction CREATE assertExpectedInline node_source print_readable strip name= pass_name=test_pass action=create graph_id=- dummy_source_dict = name target pass_name test_pass action CREATE_STR graph_id - from_node assertEqual node_source to_dict dummy_source_dict assertEqual node_source NodeSource _from_dict node_source to_dict Dummy node node = torch fx Node graph=torch fx Graph name= add op= call_function target=torch ops aten add Tensor type ignore attr-defined args= torch tensor torch tensor kwargs= node meta from_node = node_source graph_id = id node graph node_source = NodeSource node=node pass_name= test_pass action=NodeSourceAction CREATE assertExpectedInline node_source print_readable strip f \ name=add pass_name=test_pass action=create graph_id= graph_id name= pass_name=test_pass action=create graph_id=- assertEqual node_source to_dict name add target aten add Tensor pass_name test_pass action CREATE_STR graph_id graph_id from_node dummy_source_dict Test two node sources same node_source = NodeSource node=None pass_name= test_pass action=NodeSourceAction CREATE node_source = NodeSource node=None pass_name= test_pass action=NodeSourceAction CREATE assertEqual node_source node_source Test hash function - equivalent objects should have same hash assertEqual hash node_source hash node_source Test two node sources same node_source = NodeSource node=None pass_name= test_pass_ action=NodeSourceAction CREATE node_source = NodeSource node=None pass_name= test_pass_ action=NodeSourceAction CREATE assertNotEqual node_source node_source Test hash function - different objects should have different hash assertNotEqual hash node_source hash node_source Test equivalent NodeSource objects can used sets dicts node_set = node_source node_source assertEqual len node_set Should only contain one unique element node_dict = node_source value node_source value assertEqual len node_dict Should only contain one key assertEqual node_dict node_source value Last value should win Test more complex NodeSource objects node_source_with_node = NodeSource node=node pass_name= test_pass action=NodeSourceAction CREATE node_source_with_node_copy = NodeSource node=node pass_name= test_pass action=NodeSourceAction CREATE These should equal have same hash assertEqual node_source_with_node node_source_with_node_copy assertEqual hash node_source_with_node hash node_source_with_node_copy Test different actions node_source_replace = NodeSource node=None pass_name= test_pass action=NodeSourceAction REPLACE node_source_create = NodeSource node=None pass_name= test_pass action=NodeSourceAction CREATE These should different have different hashes assertNotEqual node_source_replace node_source_create assertNotEqual hash node_source_replace hash node_source_create test_graph_provenance check_node_source node_source_dict name pass_name action assertEqual node_source_dict name name assertEqual node_source_dict pass_name pass_name assertEqual node_source_dict action action get_first_node_source_and_check node_source_dict Get first node source from_node list assertEqual len node_source_dict from_node node_source_dict from_node Model torch nn Module __init__ super __init__ fc = torch nn Linear relu = torch nn ReLU fc = torch nn Linear sigmoid = torch nn Sigmoid forward x x = fc x x = relu x x = fc x x = sigmoid x x model = Model example_inputs = torch randn ep = torch export export model example_inputs strict=True decomposed_ep = ep run_decompositions default_decompositions node decomposed same ancestor node should have same from_node info node decomposed_ep graph nodes node op placeholder output assert from_node node meta node_name_to_from_node = node name node meta from_node node decomposed_ep graph nodes node op placeholder output same_ancestor_nodes = permute addmm addmm permute permute_ addmm_ addmm_ permute_ node_name_ node_name_to_from_node node_name_ node_name_to_from_node node_name_ node_name_ same_ancestor_nodes get node_name_ assertEqual node_name_to_from_node node_name_ node_name_to_from_node node_name_ assertEqual NodeSource _from_dict ns to_dict ns node_name_to_from_node node_name_ node_name_to_from_node node_name_ assertNotEqual node_name_to_from_node node_name_ node_name_to_from_node node_name_ assertNotEqual NodeSource _from_dict ns to_dict ns node_name_to_from_node node_name_ node_name_to_from_node node_name_ gm = ep module provenance = get_graph_provenance_json gm graph assertEqual set provenance keys relu linear sigmoid linear_ Check node linear created node x PropagateUnbackedSymInts key_provenance = provenance linear from_node assertEqual len key_provenance key_provenance = key_provenance check_node_source key_provenance x Interpreter_PropagateUnbackedSymInts CREATE_STR Check node x then created another node x FlattenInputOutputSignature key_provenance = get_first_node_source_and_check key_provenance check_node_source key_provenance x Interpreter_DynamoGraphTransformer CREATE_STR gm graph_signature = aot_export_module gm example_inputs trace_joint=False provenance = get_graph_provenance_json gm graph assertEqual set provenance keys t addmm relu t_ addmm_ sigmoid key t addmm The node provenance hierarchy should t - linear - x - x x - y means x created y key_provenance = provenance key assertEqual len key_provenance key_provenance = key_provenance Check node t addmm created node linear PropagateUnbackedSymInts check_node_source key_provenance linear Interpreter_PropagateUnbackedSymInts CREATE_STR Check node linear then created node x PropagateUnbackedSymInts key_provenance = get_first_node_source_and_check key_provenance from_node check_node_source key_provenance x Interpreter_PropagateUnbackedSymInts CREATE_STR Check node x then created another node x FlattenInputOutputSignature key_provenance = get_first_node_source_and_check key_provenance check_node_source key_provenance x Interpreter_DynamoGraphTransformer CREATE_STR __name__ == __main__ raise RuntimeError This test currently used should enabled discover_tests py required
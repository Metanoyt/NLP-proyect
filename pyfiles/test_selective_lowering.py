Owner s module inductor Test selective lowering control via node metadata annotations collections abc Callable torch torch _inductor test_case TestCase InductorTestCase torch testing _internal common_utils instantiate_parametrized_tests torch testing _internal inductor_utils GPU_TYPE HAS_GPU instantiate_parametrized_tests SelectiveLoweringTest InductorTestCase Tests user-controllable selective lowering using node meta annotations device = GPU_TYPE _mark_nodes_for_fallback gm torch fx GraphModule predicate Callable torch fx Node bool - torch fx GraphModule Helper method mark nodes should_fallback metadata based predicate node gm graph nodes node op == call_function predicate node node meta should_fallback = True gm test_basic_selective_lowering Test nodes marked fallback use fallback handlers instead lowerings foo x y = x + y This will marked fallback b = This will use normal lowering b x = torch randn device=self device y = torch randn device=self device custom_backend gm torch fx GraphModule example_inputs Mark all add operations fallback should_fallback_add node torch fx Node - bool node target == torch ops aten add Tensor _mark_nodes_for_fallback gm should_fallback_add torch _inductor compile_fx compile_fx compile_fx gm example_inputs compiled_fn = torch compile foo backend=custom_backend result = compiled_fn x y expected = foo x y assertTrue torch allclose result expected test_no_fallback_when_unmarked Test operations without fallback annotation use normal lowering foo x y x + y x = torch randn device=self device y = torch randn device=self device custom_backend gm torch fx GraphModule example_inputs Don t mark anything - all operations should use normal lowering torch _inductor compile_fx compile_fx compile_fx gm example_inputs compiled_fn = torch compile foo backend=custom_backend result = compiled_fn x y expected = foo x y assertTrue torch allclose result expected __name__ == __main__ torch _inductor test_case run_tests HAS_GPU run_tests needs= filelock
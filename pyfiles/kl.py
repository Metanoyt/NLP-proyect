mypy allow-untyped-defs math warnings collections abc Callable functools total_ordering torch torch inf Tensor bernoulli Bernoulli beta Beta binomial Binomial categorical Categorical cauchy Cauchy continuous_bernoulli ContinuousBernoulli dirichlet Dirichlet distribution Distribution exp_family ExponentialFamily exponential Exponential gamma Gamma geometric Geometric gumbel Gumbel half_normal HalfNormal independent Independent laplace Laplace lowrank_multivariate_normal _batch_lowrank_logdet _batch_lowrank_mahalanobis LowRankMultivariateNormal multivariate_normal _batch_mahalanobis MultivariateNormal normal Normal one_hot_categorical OneHotCategorical pareto Pareto poisson Poisson transformed_distribution TransformedDistribution uniform Uniform utils _sum_rightmost euler_constant _euler_gamma _KL_REGISTRY dict tuple type type Callable = Source truth mapping few general type type pairs functions _KL_MEMOIZE dict tuple type type Callable = Memoized version mapping many specific type type pairs functions __all__ = register_kl kl_divergence register_kl type_p type_q Decorator register pairwise function meth ` kl_divergence ` Usage register_kl Normal Normal kl_normal_normal p q insert implementation here Lookup returns most specific type type match ordered subclass If match ambiguous ` RuntimeWarning ` raised For example resolve ambiguous situation register_kl BaseP DerivedQ kl_version p q register_kl DerivedP BaseQ kl_version p q you should register third most-specific implementation e g register_kl DerivedP DerivedQ kl_version Break tie Args type_p type A subclass ` ~torch distributions Distribution ` type_q type A subclass ` ~torch distributions Distribution ` isinstance type_p type issubclass type_p Distribution raise TypeError f Expected type_p Distribution subclass got type_p isinstance type_q type issubclass type_q Distribution raise TypeError f Expected type_q Distribution subclass got type_q decorator fun _KL_REGISTRY type_p type_q = fun _KL_MEMOIZE clear reset since lookup order may have changed fun decorator total_ordering _Match __slots__ = types __init__ types types = types __eq__ other types == other types __le__ other x y zip types other types issubclass x y False x y break True _dispatch_kl type_p type_q Find most specific approximate match assuming single inheritance matches = super_p super_q super_p super_q _KL_REGISTRY issubclass type_p super_p issubclass type_q super_q matches NotImplemented Check left- right- lexicographic orders agree mypy isn t smart enough know _Match implements __lt__ see https github com python typing issues #issuecomment- left_p left_q = min _Match m m matches types type ignore type-var right_q right_p = min _Match reversed m m matches types type ignore type-var left_fun = _KL_REGISTRY left_p left_q right_fun = _KL_REGISTRY right_p right_q left_fun right_fun warnings warn f Ambiguous kl_divergence type_p __name__ type_q __name__ f Please register_kl left_p __name__ right_q __name__ RuntimeWarning stacklevel= left_fun _infinite_like tensor Helper function obtaining infinite KL Divergence throughout torch full_like tensor inf _x_log_x tensor Utility function calculating x log x torch special xlogy tensor tensor produces correct result x= _batch_trace_XXT bmat Utility function calculating trace XX^ T X having arbitrary trailing batch dimensions n = bmat size - m = bmat size - flat_trace = bmat reshape - m n pow sum - flat_trace reshape bmat shape - kl_divergence p Distribution q Distribution - Tensor r Compute Kullback-Leibler divergence math ` KL p \ &#124; q ` between two distributions math KL p \ &#124; q = \int p x \log\frac p x q x \ dx Args p Distribution A ` ~torch distributions Distribution ` object q Distribution A ` ~torch distributions Distribution ` object Returns Tensor A batch KL divergences shape ` batch_shape ` Raises NotImplementedError If distribution types have been registered via meth ` register_kl ` try fun = _KL_MEMOIZE type p type q except KeyError fun = _dispatch_kl type p type q _KL_MEMOIZE type p type q = fun fun NotImplemented raise NotImplementedError f No KL p &#124; &#124; q implemented p type p __class__ __name__ q type q __class__ __name__ fun p q ################################################################################ KL Divergence Implementations ################################################################################ Same distributions register_kl Bernoulli Bernoulli _kl_bernoulli_bernoulli p q t = p probs torch nn functional softplus -q logits - torch nn functional softplus -p logits t q probs == = inf t p probs == = t = - p probs torch nn functional softplus q logits - torch nn functional softplus p logits t q probs == = inf t p probs == = t + t register_kl Beta Beta _kl_beta_beta p q sum_params_p = p concentration + p concentration sum_params_q = q concentration + q concentration t = q concentration lgamma + q concentration lgamma + sum_params_p lgamma t = p concentration lgamma + p concentration lgamma + sum_params_q lgamma t = p concentration - q concentration torch digamma p concentration t = p concentration - q concentration torch digamma p concentration t = sum_params_q - sum_params_p torch digamma sum_params_p t - t + t + t + t register_kl Binomial Binomial _kl_binomial_binomial p q https math stackexchange com questions kullback-leibler-divergence-for-binomial-distributions-p-and-q p total_count q total_count any raise NotImplementedError KL between Binomials where q total_count p total_count implemented kl = p total_count p probs p logits - q logits + -p probs log p - -q probs log p inf_idxs = p total_count q total_count kl inf_idxs = _infinite_like kl inf_idxs kl register_kl Categorical Categorical _kl_categorical_categorical p q t = p probs p logits - q logits t q probs == expand_as t = inf t p probs == expand_as t = t sum - register_kl ContinuousBernoulli ContinuousBernoulli _kl_continuous_bernoulli_continuous_bernoulli p q t = p mean p logits - q logits t = p _cont_bern_log_norm + torch log p -p probs t = -q _cont_bern_log_norm - torch log p -q probs t + t + t register_kl Dirichlet Dirichlet _kl_dirichlet_dirichlet p q From http bariskurt com kullback-leibler-divergence-between-two-dirichlet-and-beta-distributions sum_p_concentration = p concentration sum - sum_q_concentration = q concentration sum - t = sum_p_concentration lgamma - sum_q_concentration lgamma t = p concentration lgamma - q concentration lgamma sum - t = p concentration - q concentration t = p concentration digamma - sum_p_concentration digamma unsqueeze - t - t + t t sum - register_kl Exponential Exponential _kl_exponential_exponential p q rate_ratio = q rate p rate t = -rate_ratio log t + rate_ratio - register_kl ExponentialFamily ExponentialFamily _kl_expfamily_expfamily p q type p type q raise NotImplementedError The cross KL-divergence between different exponential families cannot \ computed using Bregman divergences p_nparams = np detach requires_grad_ np p _natural_params q_nparams = q _natural_params lg_normal = p _log_normalizer p_nparams gradients = torch autograd grad lg_normal sum p_nparams create_graph=True result = q _log_normalizer q_nparams - lg_normal pnp qnp g zip p_nparams q_nparams gradients term = qnp - pnp g result -= _sum_rightmost term len q event_shape result register_kl Gamma Gamma _kl_gamma_gamma p q t = q concentration p rate q rate log t = torch lgamma q concentration - torch lgamma p concentration t = p concentration - q concentration torch digamma p concentration t = q rate - p rate p concentration p rate t + t + t + t register_kl Gumbel Gumbel _kl_gumbel_gumbel p q ct = p scale q scale ct = q loc q scale ct = p loc q scale t = -ct log - ct + ct t = ct _euler_gamma t = torch exp ct + + ct lgamma - ct t + t + t - + _euler_gamma register_kl Geometric Geometric _kl_geometric_geometric p q -p entropy - torch log p -q probs p probs - q logits register_kl HalfNormal HalfNormal _kl_halfnormal_halfnormal p q _kl_normal_normal p base_dist q base_dist register_kl Laplace Laplace _kl_laplace_laplace p q From http www mast queensu ca ~communications Papers gil-msc pdf scale_ratio = p scale q scale loc_abs_diff = p loc - q loc abs t = -scale_ratio log t = loc_abs_diff q scale t = scale_ratio torch exp -loc_abs_diff p scale t + t + t - register_kl LowRankMultivariateNormal LowRankMultivariateNormal _kl_lowrankmultivariatenormal_lowrankmultivariatenormal p q p event_shape = q event_shape raise ValueError KL-divergence between two Low Rank Multivariate Normals with\ different event shapes cannot computed term = _batch_lowrank_logdet q _unbroadcasted_cov_factor q _unbroadcasted_cov_diag q _capacitance_tril - _batch_lowrank_logdet p _unbroadcasted_cov_factor p _unbroadcasted_cov_diag p _capacitance_tril term = _batch_lowrank_mahalanobis q _unbroadcasted_cov_factor q _unbroadcasted_cov_diag q loc - p loc q _capacitance_tril Expands term according inv qcov pcov = inv qD - inv qD qW inv qC qW T inv qD pW pW T + pD = inv qD - A T A pD + pW pW T qWt_qDinv = q _unbroadcasted_cov_factor mT q _unbroadcasted_cov_diag unsqueeze - A = torch linalg solve_triangular q _capacitance_tril qWt_qDinv upper=False term = p _unbroadcasted_cov_diag q _unbroadcasted_cov_diag sum - term = _batch_trace_XXT p _unbroadcasted_cov_factor q _unbroadcasted_cov_diag rsqrt unsqueeze - term = _batch_trace_XXT A p _unbroadcasted_cov_diag sqrt unsqueeze - term = _batch_trace_XXT A matmul p _unbroadcasted_cov_factor term = term + term - term - term term + term + term - p event_shape register_kl MultivariateNormal LowRankMultivariateNormal _kl_multivariatenormal_lowrankmultivariatenormal p q p event_shape = q event_shape raise ValueError KL-divergence between two Low Rank Multivariate Normals with\ different event shapes cannot computed term = _batch_lowrank_logdet q _unbroadcasted_cov_factor q _unbroadcasted_cov_diag q _capacitance_tril - p _unbroadcasted_scale_tril diagonal dim =- dim =- log sum - term = _batch_lowrank_mahalanobis q _unbroadcasted_cov_factor q _unbroadcasted_cov_diag q loc - p loc q _capacitance_tril Expands term according inv qcov pcov = inv qD - inv qD qW inv qC qW T inv qD p_tril p_tril T = inv qD - A T A p_tril p_tril T qWt_qDinv = q _unbroadcasted_cov_factor mT q _unbroadcasted_cov_diag unsqueeze - A = torch linalg solve_triangular q _capacitance_tril qWt_qDinv upper=False term = _batch_trace_XXT p _unbroadcasted_scale_tril q _unbroadcasted_cov_diag rsqrt unsqueeze - term = _batch_trace_XXT A matmul p _unbroadcasted_scale_tril term = term - term term + term + term - p event_shape register_kl LowRankMultivariateNormal MultivariateNormal _kl_lowrankmultivariatenormal_multivariatenormal p q p event_shape = q event_shape raise ValueError KL-divergence between two Low Rank Multivariate Normals with\ different event shapes cannot computed term = q _unbroadcasted_scale_tril diagonal dim =- dim =- log sum - - _batch_lowrank_logdet p _unbroadcasted_cov_factor p _unbroadcasted_cov_diag p _capacitance_tril term = _batch_mahalanobis q _unbroadcasted_scale_tril q loc - p loc Expands term according inv qcov pcov = inv q_tril q_tril T pW pW T + pD combined_batch_shape = torch _C _infer_size q _unbroadcasted_scale_tril shape - p _unbroadcasted_cov_factor shape - n = p event_shape q_scale_tril = q _unbroadcasted_scale_tril expand combined_batch_shape + n n p_cov_factor = p _unbroadcasted_cov_factor expand combined_batch_shape + n p cov_factor size - p_cov_diag = torch diag_embed p _unbroadcasted_cov_diag sqrt expand combined_batch_shape + n n term = _batch_trace_XXT torch linalg solve_triangular q_scale_tril p_cov_factor upper=False term = _batch_trace_XXT torch linalg solve_triangular q_scale_tril p_cov_diag upper=False term = term + term term + term + term - p event_shape register_kl MultivariateNormal MultivariateNormal _kl_multivariatenormal_multivariatenormal p q From https en wikipedia org wiki Multivariate_normal_distribution#Kullback E Leibler_divergence p event_shape = q event_shape raise ValueError KL-divergence between two Multivariate Normals with\ different event shapes cannot computed half_term = q _unbroadcasted_scale_tril diagonal dim =- dim =- log sum - - p _unbroadcasted_scale_tril diagonal dim =- dim =- log sum - combined_batch_shape = torch _C _infer_size q _unbroadcasted_scale_tril shape - p _unbroadcasted_scale_tril shape - n = p event_shape q_scale_tril = q _unbroadcasted_scale_tril expand combined_batch_shape + n n p_scale_tril = p _unbroadcasted_scale_tril expand combined_batch_shape + n n term = _batch_trace_XXT torch linalg solve_triangular q_scale_tril p_scale_tril upper=False term = _batch_mahalanobis q _unbroadcasted_scale_tril q loc - p loc half_term + term + term - n register_kl Normal Normal _kl_normal_normal p q var_ratio = p scale q scale pow t = p loc - q loc q scale pow var_ratio + t - - var_ratio log register_kl OneHotCategorical OneHotCategorical _kl_onehotcategorical_onehotcategorical p q _kl_categorical_categorical p _categorical q _categorical register_kl Pareto Pareto _kl_pareto_pareto p q From http www mast queensu ca ~communications Papers gil-msc pdf scale_ratio = p scale q scale alpha_ratio = q alpha p alpha t = q alpha scale_ratio log t = -alpha_ratio log result = t + t + alpha_ratio - result p support lower_bound q support lower_bound = inf result register_kl Poisson Poisson _kl_poisson_poisson p q p rate p rate log - q rate log - p rate - q rate register_kl TransformedDistribution TransformedDistribution _kl_transformed_transformed p q p transforms = q transforms raise NotImplementedError p event_shape = q event_shape raise NotImplementedError kl_divergence p base_dist q base_dist register_kl Uniform Uniform _kl_uniform_uniform p q result = q high - q low p high - p low log result q low p low &#124; q high p high = inf result Different distributions register_kl Bernoulli Poisson _kl_bernoulli_poisson p q -p entropy - p probs q rate log - q rate register_kl Beta ContinuousBernoulli _kl_beta_continuous_bernoulli p q -p entropy - p mean q logits - torch log p -q probs - q _cont_bern_log_norm register_kl Beta Pareto _kl_beta_infinity p q _infinite_like p concentration register_kl Beta Exponential _kl_beta_exponential p q -p entropy - q rate log + q rate p concentration p concentration + p concentration register_kl Beta Gamma _kl_beta_gamma p q t = -p entropy t = q concentration lgamma - q concentration q rate log t = q concentration - p concentration digamma - p concentration + p concentration digamma t = q rate p concentration p concentration + p concentration t + t - t + t TODO Add Beta-Laplace KL Divergence register_kl Beta Normal _kl_beta_normal p q E_beta = p concentration p concentration + p concentration var_normal = q scale pow t = -p entropy t = var_normal math pi log t = E_beta - E_beta p concentration + p concentration + + E_beta pow t = q loc E_beta t = q loc pow t + t + t - t + t var_normal register_kl Beta Uniform _kl_beta_uniform p q result = -p entropy + q high - q low log result q low p support lower_bound &#124; q high p support upper_bound = inf result Note KL between ContinuousBernoulli Beta has no closed form register_kl ContinuousBernoulli Pareto _kl_continuous_bernoulli_infinity p q _infinite_like p probs register_kl ContinuousBernoulli Exponential _kl_continuous_bernoulli_exponential p q -p entropy - torch log q rate + q rate p mean Note KL between ContinuousBernoulli Gamma has no closed form TODO Add ContinuousBernoulli-Laplace KL Divergence register_kl ContinuousBernoulli Normal _kl_continuous_bernoulli_normal p q t = -p entropy t = math log math pi + torch square q loc q scale + torch log q scale t = p variance + torch square p mean - q loc p mean torch square q scale t + t + t register_kl ContinuousBernoulli Uniform _kl_continuous_bernoulli_uniform p q result = -p entropy + q high - q low log torch where torch max torch ge q low p support lower_bound torch le q high p support upper_bound torch ones_like result inf result register_kl Exponential Beta register_kl Exponential ContinuousBernoulli register_kl Exponential Pareto register_kl Exponential Uniform _kl_exponential_infinity p q _infinite_like p rate register_kl Exponential Gamma _kl_exponential_gamma p q ratio = q rate p rate t = -q concentration torch log ratio t + ratio + q concentration lgamma + q concentration _euler_gamma - + _euler_gamma register_kl Exponential Gumbel _kl_exponential_gumbel p q scale_rate_prod = p rate q scale loc_scale_ratio = q loc q scale t = scale_rate_prod log - t = torch exp loc_scale_ratio scale_rate_prod scale_rate_prod + t = scale_rate_prod reciprocal t - loc_scale_ratio + t + t TODO Add Exponential-Laplace KL Divergence register_kl Exponential Normal _kl_exponential_normal p q var_normal = q scale pow rate_sqr = p rate pow t = torch log rate_sqr var_normal math pi t = rate_sqr reciprocal t = q loc p rate t = q loc pow t - + t - t + t var_normal register_kl Gamma Beta register_kl Gamma ContinuousBernoulli register_kl Gamma Pareto register_kl Gamma Uniform _kl_gamma_infinity p q _infinite_like p concentration register_kl Gamma Exponential _kl_gamma_exponential p q -p entropy - q rate log + q rate p concentration p rate register_kl Gamma Gumbel _kl_gamma_gumbel p q beta_scale_prod = p rate q scale loc_scale_ratio = q loc q scale t = p concentration - p concentration digamma - p concentration lgamma - p concentration t = beta_scale_prod log + p concentration beta_scale_prod t = torch exp loc_scale_ratio + beta_scale_prod reciprocal pow -p concentration - loc_scale_ratio t + t + t TODO Add Gamma-Laplace KL Divergence register_kl Gamma Normal _kl_gamma_normal p q var_normal = q scale pow beta_sqr = p rate pow t = torch log beta_sqr var_normal math pi - p concentration - p concentration lgamma t = p concentration pow + p concentration beta_sqr t = q loc p concentration p rate t = q loc pow t + p concentration - p concentration digamma + t - t + t var_normal register_kl Gumbel Beta register_kl Gumbel ContinuousBernoulli register_kl Gumbel Exponential register_kl Gumbel Gamma register_kl Gumbel Pareto register_kl Gumbel Uniform _kl_gumbel_infinity p q _infinite_like p loc TODO Add Gumbel-Laplace KL Divergence register_kl Gumbel Normal _kl_gumbel_normal p q param_ratio = p scale q scale t = param_ratio math sqrt math pi log t = math pi param_ratio pow t = p loc + p scale _euler_gamma - q loc q scale pow -t + t + t - _euler_gamma + register_kl Laplace Beta register_kl Laplace ContinuousBernoulli register_kl Laplace Exponential register_kl Laplace Gamma register_kl Laplace Pareto register_kl Laplace Uniform _kl_laplace_infinity p q _infinite_like p loc register_kl Laplace Normal _kl_laplace_normal p q var_normal = q scale pow scale_sqr_var_ratio = p scale pow var_normal t = torch log scale_sqr_var_ratio math pi t = p loc pow t = p loc q loc t = q loc pow -t + scale_sqr_var_ratio + t - t + t var_normal - register_kl Normal Beta register_kl Normal ContinuousBernoulli register_kl Normal Exponential register_kl Normal Gamma register_kl Normal Pareto register_kl Normal Uniform _kl_normal_infinity p q _infinite_like p loc register_kl Normal Gumbel _kl_normal_gumbel p q mean_scale_ratio = p loc q scale var_scale_sqr_ratio = p scale q scale pow loc_scale_ratio = q loc q scale t = var_scale_sqr_ratio log t = mean_scale_ratio - loc_scale_ratio t = torch exp -mean_scale_ratio + var_scale_sqr_ratio + loc_scale_ratio -t + t + t - + math log math pi register_kl Normal Laplace _kl_normal_laplace p q loc_diff = p loc - q loc scale_ratio = p scale q scale loc_diff_scale_ratio = loc_diff p scale t = torch log scale_ratio t = math sqrt math pi p scale torch exp - loc_diff_scale_ratio pow t = loc_diff torch erf math sqrt loc_diff_scale_ratio -t + t + t q scale - + math log math pi register_kl Pareto Beta register_kl Pareto ContinuousBernoulli register_kl Pareto Uniform _kl_pareto_infinity p q _infinite_like p scale register_kl Pareto Exponential _kl_pareto_exponential p q scale_rate_prod = p scale q rate t = p alpha scale_rate_prod log t = p alpha reciprocal t = p alpha scale_rate_prod p alpha - result = t - t + t - result p alpha = = inf result register_kl Pareto Gamma _kl_pareto_gamma p q common_term = p scale log + p alpha reciprocal t = p alpha log - common_term t = q concentration lgamma - q concentration q rate log t = - q concentration common_term t = q rate p alpha p scale p alpha - result = t + t + t + t - result p alpha = = inf result TODO Add Pareto-Laplace KL Divergence register_kl Pareto Normal _kl_pareto_normal p q var_normal = q scale pow common_term = p scale p alpha - t = math sqrt math pi q scale p alpha p scale log t = p alpha reciprocal t = p alpha common_term pow p alpha - t = p alpha common_term - q loc pow result = t - t + t + t var_normal - result p alpha = = inf result register_kl Poisson Bernoulli register_kl Poisson Binomial _kl_poisson_infinity p q _infinite_like p rate register_kl Uniform Beta _kl_uniform_beta p q common_term = p high - p low t = torch log common_term t = q concentration - _x_log_x p high - _x_log_x p low - common_term common_term t = q concentration - _x_log_x - p high - _x_log_x - p low + common_term common_term t = q concentration lgamma + q concentration lgamma - q concentration + q concentration lgamma result = t + t - t - t result p high q support upper_bound &#124; p low q support lower_bound = inf result register_kl Uniform ContinuousBernoulli _kl_uniform_continuous_bernoulli p q result = -p entropy - p mean q logits - torch log p -q probs - q _cont_bern_log_norm torch where torch max torch ge p high q support upper_bound torch le p low q support lower_bound torch ones_like result inf result register_kl Uniform Exponential _kl_uniform_exponetial p q result = q rate p high + p low - p high - p low q rate log result p low q support lower_bound = inf result register_kl Uniform Gamma _kl_uniform_gamma p q common_term = p high - p low t = common_term log t = q concentration lgamma - q concentration q rate log t = - q concentration _x_log_x p high - _x_log_x p low - common_term common_term t = q rate p high + p low result = -t + t + t + t result p low q support lower_bound = inf result register_kl Uniform Gumbel _kl_uniform_gumbel p q common_term = q scale p high - p low high_loc_diff = p high - q loc q scale low_loc_diff = p low - q loc q scale t = common_term log + high_loc_diff + low_loc_diff t = common_term torch exp -high_loc_diff - torch exp -low_loc_diff t - t TODO Uniform-Laplace KL Divergence register_kl Uniform Normal _kl_uniform_normal p q common_term = p high - p low t = math sqrt math pi q scale common_term log t = common_term pow t = p high + p low - q loc pow t + t + t q scale pow register_kl Uniform Pareto _kl_uniform_pareto p q support_uniform = p high - p low t = q alpha q scale pow q alpha support_uniform log t = _x_log_x p high - _x_log_x p low - support_uniform support_uniform result = t q alpha + - t result p low q support lower_bound = inf result register_kl Independent Independent _kl_independent_independent p q p reinterpreted_batch_ndims = q reinterpreted_batch_ndims raise NotImplementedError result = kl_divergence p base_dist q base_dist _sum_rightmost result p reinterpreted_batch_ndims register_kl Cauchy Cauchy _kl_cauchy_cauchy p q From https arxiv org abs t = p scale + q scale pow + p loc - q loc pow log t = p scale q scale log t - t _add_kl_info Appends list implemented KL functions doc kl_divergence rows = KL divergence currently implemented following distribution pairs p q sorted _KL_REGISTRY key=lambda p_q p_q __name__ p_q __name__ rows append f ` ~torch distributions p __name__ ` ` ~torch distributions q __name__ ` kl_info = \n\t join rows kl_divergence __doc__ kl_divergence __doc__ += kl_info
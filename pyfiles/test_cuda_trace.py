Owner s module cuda sys unittest unittest mock torch torch cuda _gpu_trace gpu_trace torch testing _internal common_utils NoTest run_tests TEST_CUDA TestCase NOTE Each test needs run brand new process reset registered hooks make sure CUDA streams initialized each test uses them TEST_CUDA print CUDA available skipping tests file=sys stderr TestCase = NoTest noqa F torch testing _internal common_utils markDynamoStrictTest TestCudaTrace TestCase setUp torch _C _activate_gpu_trace mock = unittest mock MagicMock test_event_creation_callback gpu_trace register_callback_for_event_creation mock event = torch cuda Event event record mock assert_called_once_with event _as_parameter_ value test_event_deletion_callback gpu_trace register_callback_for_event_deletion mock event = torch cuda Event event record event_id = event _as_parameter_ value del event mock assert_called_once_with event_id test_event_record_callback gpu_trace register_callback_for_event_record mock event = torch cuda Event event record mock assert_called_once_with event _as_parameter_ value torch cuda default_stream cuda_stream test_event_wait_callback gpu_trace register_callback_for_event_wait mock event = torch cuda Event event record event wait mock assert_called_once_with event _as_parameter_ value torch cuda default_stream cuda_stream test_memory_allocation_callback gpu_trace register_callback_for_memory_allocation mock tensor = torch empty device= cuda mock assert_called_once_with tensor data_ptr test_memory_deallocation_callback gpu_trace register_callback_for_memory_deallocation mock tensor = torch empty device= cuda data_ptr = tensor data_ptr del tensor mock assert_called_once_with data_ptr test_stream_creation_callback gpu_trace register_callback_for_stream_creation mock see Note HIP Lazy Streams torch version hip user_stream = torch cuda Stream torch cuda stream user_stream torch ones device= cuda torch cuda Stream mock assert_called test_device_synchronization_callback gpu_trace register_callback_for_device_synchronization mock torch cuda synchronize mock assert_called test_stream_synchronization_callback gpu_trace register_callback_for_stream_synchronization mock stream = torch cuda Stream stream synchronize mock assert_called_once_with stream cuda_stream test_event_synchronization_callback gpu_trace register_callback_for_event_synchronization mock event = torch cuda Event event record event synchronize mock assert_called_once_with event _as_parameter_ value test_memcpy_synchronization gpu_trace register_callback_for_stream_synchronization mock tensor = torch rand device= cuda tensor nonzero mock assert_called_once_with torch cuda default_stream cuda_stream test_all_trace_callbacks_called other = unittest mock MagicMock gpu_trace register_callback_for_memory_allocation mock gpu_trace register_callback_for_memory_allocation other tensor = torch empty device= cuda mock assert_called_once_with tensor data_ptr other assert_called_once_with tensor data_ptr __name__ == __main__ run_tests
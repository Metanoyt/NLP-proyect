Owner s oncall package deploy os zipfile sys version_info tempfile TemporaryDirectory textwrap dedent unittest skipIf torch torch package PackageExporter PackageImporter torch testing _internal common_utils IS_FBCODE IS_SANDCASTLE IS_WINDOWS run_tests try torchvision models resnet HAS_TORCHVISION = True except ImportError HAS_TORCHVISION = False skipIfNoTorchVision = skipIf HAS_TORCHVISION no torchvision try common PackageTestCase except ImportError Support case where we run file directly common PackageTestCase pathlib Path packaging_directory = Path __file__ parent skipIf IS_FBCODE IS_SANDCASTLE IS_WINDOWS Tests use temporary files disabled fbcode DirectoryReaderTest PackageTestCase Tests use DirectoryReader accessor opened packages skipIfNoTorchVision skipIf True Does work latest TorchVision see https github com pytorch pytorch issues test_loading_pickle Test basic saving loading modules pickles DirectoryReader resnet = resnet filename = temp PackageExporter filename e e intern e save_pickle model model pkl resnet zip_file = zipfile ZipFile filename r TemporaryDirectory temp_dir zip_file extractall path=temp_dir importer = PackageImporter Path temp_dir Path filename name dir_mod = importer load_pickle model model pkl input = torch rand assertEqual dir_mod input resnet input test_loading_module Test basic saving loading packages DirectoryReader package_a filename = temp PackageExporter filename e e save_module package_a zip_file = zipfile ZipFile filename r TemporaryDirectory temp_dir zip_file extractall path=temp_dir dir_importer = PackageImporter Path temp_dir Path filename name dir_mod = dir_importer import_module package_a assertEqual dir_mod result package_a result test_loading_has_record Test DirectoryReader s has_record package_a noqa F filename = temp PackageExporter filename e e save_module package_a zip_file = zipfile ZipFile filename r TemporaryDirectory temp_dir zip_file extractall path=temp_dir dir_importer = PackageImporter Path temp_dir Path filename name assertTrue dir_importer zip_reader has_record package_a __init__ py assertFalse dir_importer zip_reader has_record package_a test_resource_reader Tests DirectoryReader base get_resource_reader filename = temp PackageExporter filename pe Layout looks like package &#124; -- one &#124; &#124; -- txt &#124; &#124; -- b txt &#124; &#124; -- c txt &#124; + -- three &#124; &#124; -- d txt &#124; + -- e txt + -- two &#124; -- f txt + -- g txt pe save_text one txt hello pe save_text one b txt hello b pe save_text one c txt hello c pe save_text one three d txt hello d pe save_text one three e txt hello e pe save_text two f txt hello f pe save_text two g txt hello g zip_file = zipfile ZipFile filename r TemporaryDirectory temp_dir zip_file extractall path=temp_dir importer = PackageImporter Path temp_dir Path filename name reader_one = importer get_resource_reader one Different behavior still zipped archives resource_path = os path join Path temp_dir Path filename name one txt assertEqual reader_one resource_path txt resource_path assertTrue reader_one is_resource txt assertEqual reader_one open_resource txt getbuffer b hello assertFalse reader_one is_resource three reader_one_contents = list reader_one contents reader_one_contents sort assertSequenceEqual reader_one_contents txt b txt c txt three reader_two = importer get_resource_reader two assertTrue reader_two is_resource f txt assertEqual reader_two open_resource f txt getbuffer b hello f reader_two_contents = list reader_two contents reader_two_contents sort assertSequenceEqual reader_two_contents f txt g txt reader_one_three = importer get_resource_reader one three assertTrue reader_one_three is_resource d txt assertEqual reader_one_three open_resource d txt getbuffer b hello d reader_one_three_contents = list reader_one_three contents reader_one_three_contents sort assertSequenceEqual reader_one_three_contents d txt e txt assertIsNone importer get_resource_reader nonexistent_package skipIf version_info = https github com python cpython issues test_package_resource_access Packaged modules should able use importlib resources API access resources saved package mod_src = dedent \ importlib resources my_cool_resources secret_message importlib resources read_text my_cool_resources sekrit txt filename = temp PackageExporter filename pe pe save_source_string foo bar mod_src pe save_text my_cool_resources sekrit txt my sekrit plays zip_file = zipfile ZipFile filename r TemporaryDirectory temp_dir zip_file extractall path=temp_dir dir_importer = PackageImporter Path temp_dir Path filename name assertEqual dir_importer import_module foo bar secret_message my sekrit plays test_importer_access filename = temp PackageExporter filename he he save_text main main my string he save_binary main main_binary b my string src = dedent \ importlib torch_package_importer resources t = resources load_text main main b = resources load_binary main main_binary he save_source_string main src is_package=True zip_file = zipfile ZipFile filename r TemporaryDirectory temp_dir zip_file extractall path=temp_dir dir_importer = PackageImporter Path temp_dir Path filename name m = dir_importer import_module main assertEqual m t my string assertEqual m b b my string test_resource_access_by_path Tests packaged code can used importlib resources path filename = temp PackageExporter filename e e save_binary string_module my_string b my string src = dedent \ importlib resources string_module importlib resources path string_module my_string path open path mode= r encoding= utf- f s = f read e save_source_string main src is_package=True zip_file = zipfile ZipFile filename r TemporaryDirectory temp_dir zip_file extractall path=temp_dir dir_importer = PackageImporter Path temp_dir Path filename name m = dir_importer import_module main assertEqual m s my string test_scriptobject_failure_message Test basic saving loading ScriptModule directory Currently supported package_a test_module ModWithTensor scripted_mod = torch jit script ModWithTensor torch rand filename = temp PackageExporter filename e e save_pickle res mod pkl scripted_mod zip_file = zipfile ZipFile filename r assertRaisesRegex RuntimeError Loading ScriptObjects PackageImporter created directory supported Use package archive file instead TemporaryDirectory temp_dir zip_file extractall path=temp_dir dir_importer = PackageImporter Path temp_dir Path filename name dir_importer load_pickle res mod pkl __name__ == __main__ run_tests
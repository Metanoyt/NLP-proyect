Owner s oncall distributed checkpointing json os sys tempfile unittest mock MagicMock torch torch distributed checkpoint DefaultLoadPlanner torch distributed checkpoint _hf_utils _HFStorageInfo NUM_BYTES_FOR_HEADER_LEN torch distributed checkpoint default_planner DefaultSavePlanner torch distributed checkpoint filesystem _StorageInfo FileSystem torch distributed checkpoint hf_storage _metadata_fn HuggingFaceStorageReader HuggingFaceStorageWriter torch distributed checkpoint metadata BytesStorageMetadata ChunkStorageMetadata Metadata MetadataIndex TensorProperties TensorStorageMetadata torch distributed checkpoint planner LoadItemType LoadPlan ReadItem SavePlan torch distributed checkpoint planner_helpers _create_write_item_for_tensor torch distributed checkpoint storage WriteResult torch testing _internal common_utils run_tests TestCase TestHfStorage TestCase test_write_data_hf - None mock_module = MagicMock mock_module save return_value = b sys modules safetensors torch = mock_module tempfile TemporaryDirectory path writer = HuggingFaceStorageWriter path=path fqn_to_index_mapping= tensor_ tensor_ writer fs = FileSystem tensor = torch rand tensor = torch rand write_item_ = _create_write_item_for_tensor tensor_ tensor write_item_ = _create_write_item_for_tensor tensor_ tensor state_dict = tensor_ tensor tensor_ tensor save_plan = SavePlan write_item_ write_item_ storage_data= fqn_to_index_mapping tensor_ tensor_ save_planner = DefaultSavePlanner save_planner set_up_planner state_dict=state_dict write_results = writer write_data save_plan save_planner write_results wait actual_write_results = write_results value expected_write_results = WriteResult index=MetadataIndex fqn= tensor_ offset=torch Size index=None size_in_bytes=tensor numel tensor element_size storage_data=_StorageInfo relative_path= model- -of- safetensors offset= length=tensor numel tensor element_size WriteResult index=MetadataIndex fqn= tensor_ offset=torch Size index=None size_in_bytes=tensor numel tensor element_size storage_data=_StorageInfo relative_path= model- -of- safetensors offset= length=tensor numel tensor element_size assertEqual actual_write_results expected_write_results test_write_data_with_sharding - None mock_module = MagicMock mock_module save return_value = b sys modules safetensors torch = mock_module tempfile TemporaryDirectory path writer = HuggingFaceStorageWriter path=path save_distributed=True writer fs = FileSystem tensor = torch rand tensor = torch rand write_item_ = _create_write_item_for_tensor tensor_ tensor write_item_ = _create_write_item_for_tensor tensor_ tensor state_dict = tensor_ tensor tensor_ tensor save_plan = SavePlan write_item_ write_item_ storage_data= shard_index save_planner = DefaultSavePlanner save_planner set_up_planner state_dict=state_dict write_results = writer write_data save_plan save_planner write_results wait actual_write_results = write_results value expected_write_results = WriteResult index=MetadataIndex fqn= tensor_ offset=torch Size index=None size_in_bytes=tensor numel tensor element_size storage_data=_StorageInfo relative_path= shard- -model- -of- safetensors offset= length=tensor numel tensor element_size WriteResult index=MetadataIndex fqn= tensor_ offset=torch Size index=None size_in_bytes=tensor numel tensor element_size storage_data=_StorageInfo relative_path= shard- -model- -of- safetensors offset= length=tensor numel tensor element_size assertEqual actual_write_results expected_write_results test_read_data_hf - None tensor_ = torch tensor mock_safe_open = MagicMock mock_context = MagicMock mock_context __enter__ return_value get_slice return_value = tensor_ mock_safe_open return_value = mock_context sys modules safetensors = MagicMock sys modules safetensors safe_open = mock_safe_open tempfile TemporaryDirectory path Create reader reader = HuggingFaceStorageReader path=path Create test file file_name = model- -of- safetensors file_path = os path join path file_name open file_path wb f write metadata same way would safetensors file metadata_contents = json dumps tensor_ dtype F shape data_offsets metadata_bytes = metadata_contents encode utf- f write len metadata_bytes to_bytes NUM_BYTES_FOR_HEADER_LEN byteorder= little f write metadata_bytes f write tensor_ numpy tobytes Set up storage data _StorageInfo objects storage_data = MetadataIndex fqn= tensor_ offset=torch Size index=None _HFStorageInfo file_path tensor_ shape tensor_ dtype reader storage_data = storage_data Create target tensors will updated read_data target_tensor_ = torch zeros state_dict = tensor_ target_tensor_ Create read items load plan read_items = name tensor state_dict items storage_index = MetadataIndex fqn=name offset=torch Size index=None dest_index = MetadataIndex fqn=name offset=torch Size index=None read_items append ReadItem type=LoadItemType TENSOR storage_index=storage_index dest_index=dest_index storage_offsets= dest_offsets= lengths=tensor size Create load plan planner load_plan = LoadPlan read_items load_planner = DefaultLoadPlanner load_planner set_up_planner state_dict=state_dict metadata=Metadata state_dict_metadata= tensor_ TensorStorageMetadata properties=TensorProperties dtype=torch float size=torch Size chunks= ChunkStorageMetadata offsets=torch Size sizes=torch Size storage_data=storage_data future = reader read_data load_plan load_planner future wait Verify results - target tensors should now contain values our test tensor assertTrue torch equal state_dict tensor_ tensor_ mock_safe_open assert_called_once_with filename=file_path framework= pt mock_context __enter__ return_value get_slice assert_called_with tensor_ test_write_metadata_hf - None mock_module = MagicMock sys modules huggingface_hub = mock_module tempfile TemporaryDirectory path file_name = model- -of- write_results = WriteResult index=MetadataIndex fqn= tensor_ offset=None index=None size_in_bytes= storage_data=_StorageInfo relative_path=file_name offset= length= WriteResult index=MetadataIndex fqn= tensor_ offset=None index=None size_in_bytes= storage_data=_StorageInfo relative_path=file_name offset= length= writer = HuggingFaceStorageWriter path=path writer fs = FileSystem writer finish Metadata state_dict_metadata= tensor_ BytesStorageMetadata tensor_ BytesStorageMetadata results= write_results metadata_file = os path join path _metadata_fn expected_metadata = metadata total_size weight_map tensor_ model- -of- tensor_ model- -of- open metadata_file f metadata = json load f assertEqual metadata expected_metadata test_read_metadata_hf mock_safe_open = MagicMock mock_context = MagicMock mock_safe_open return_value = mock_context mock_context __enter__ return_value keys return_value = tensor_ mock_context __enter__ return_value metadata return_value = mock_slice = MagicMock mock_slice get_shape return_value = mock_slice get_dtype return_value = F mock_context __enter__ return_value get_slice return_value = mock_slice mock_safetensors = MagicMock mock_safetensors safe_open = mock_safe_open mock_safetensors torch _getdtype = MagicMock return_value=torch float sys modules safetensors = mock_safetensors sys modules safetensors torch = mock_safetensors torch tempfile TemporaryDirectory path reader = HuggingFaceStorageReader path=path key = tensor_ file_name = test safetensors file_path = os path join path file_name Create empty file so fs ls can find open file_path wb _ pass Mock fs ls method our test file original_ls = reader fs ls reader fs ls = MagicMock return_value= file_path try metadata = reader read_metadata finally Restore original ls method reader fs ls = original_ls Verify safe_open called our file path mock_safe_open assert_called_once_with file_path framework= pt assertEqual metadata state_dict_metadata key TensorStorageMetadata properties=TensorProperties dtype=torch float size=torch Size chunks= ChunkStorageMetadata offsets=torch Size sizes=torch Size assertEqual metadata storage_data MetadataIndex fqn=key offset=torch Size index=None _HFStorageInfo os path join path file_name torch Size torch float __name__ == __main__ run_tests
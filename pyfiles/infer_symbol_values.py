re collections defaultdict typing Any Union numpy np sympy sp torch square_brackets_pattern = r \ ^ + \ parentheses_pattern = r \ \ s_pattern = r s\d+ infer_symbol_values symints list Union torch SymInt int init_symints list Union torch SymInt int symbol_idx_dict dict str int padding_constraints defaultdict torch SymInt list Union sp Expr int constraint str - None constraint find non-singleton = - left_expression right_expression = re findall parentheses_pattern constraint calculate_value left_expression right_expression symints symbol_idx_dict constraint find first two dimensions batch tensor = - matches = re findall square_brackets_pattern constraint left_expression right_expression = matches i split strip i calculate_value left_expression right_expression symints symbol_idx_dict constraint find b must have same reduction dim = - matches = re findall square_brackets_pattern constraint left_expression = matches split strip right_expression = matches split strip calculate_value left_expression right_expression symints symbol_idx_dict constraint find Split sizes add up = - match_ = re search r to\s+ \s+but constraint extracted_value_ = match_ group match_ None match_ = re search r of\s+ $ constraint extracted_value_ = match_ group match_ None calculate_value extracted_value_ extracted_value_ symints symbol_idx_dict constraint find invalid input size = - matches = re findall square_brackets_pattern constraint left_elements = matches split left_equation = sp sympify left_num = right_equation = sp sympify constraint split size strip left_element left_elements sp sympify left_element == sp sympify - continue sp sympify left_element is_number left_num = int left_element left_equation = sp sympify left_element right_equation = sp cancel right_equation left_equation right_vars = list right_equation free_symbols right_var right_vars sp sympify right_var == sp sympify s right_equation = sp cancel right_equation right_var right_vars remove right_var noqa B var = right_vars idx = symbol_idx_dict str var var padding_constraints padding_constraints var append right_equation update_equation symints init_symints padding_constraints padding_constraints var type ignore arg-type left_num var idx calculate_value left_expression Union str Any None right_expression Union str Any None symints list Union torch SymInt int symbol_idx_dict dict str int - None var val = solve_equation left_expression right_expression idx = symbol_idx_dict var pre_equation = sp sympify f symints idx symints idx = pre_equation subs sp sympify var val solve_equation left_expression Union str Any None right_expression Union str Any None - tuple str int expression = f left_expression - right_expression var = re findall s_pattern expression re findall parentheses_pattern expression sub_expression = re findall parentheses_pattern expression var coeff = sub_expression split x = sp symbols x sub_equation = sp sympify f var - coeff x modified_equation = sp sympify x + sp sympify expression - sp sympify sub_expression solution = sp solve modified_equation sub_equation x var var int solution sp sympify var solution = sp solve expression var val = int solution var val update_equation symints list Union torch SymInt int init_symints list Union torch SymInt int padding_constraints defaultdict torch SymInt list Union sp Expr int init_eq sp Expr new_mod_num int var torch SymInt idx int - None padding_constraints var append new_mod_num mod_num = np lcm reduce padding_constraints var type ignore arg-type eq = mod_num init_symints idx eq_const = arg arg init_eq args arg is_number eq_const rem = int eq_const mod_num eq -= rem symints idx = eq
__future__ annotations atexit functools os typing Optional TYPE_CHECKING typing_extensions final override torch _inductor async_compile noqa F required warm up AsyncCompile pools torch fx torch _inductor compile_worker subproc_pool AnyPool SubprocKind SubprocPool torch _inductor utils clear_caches compile_fx_ext _OutOfProcessFxCompile _WireProtocolPickledInput _WireProtocolPickledOutput output_code complex_memory_overlap noqa F TYPE_CHECKING collections abc Mapping concurrent futures Future final _SubprocessFxCompile _OutOfProcessFxCompile override _send_to_child_async input _WireProtocolPickledInput - Future _WireProtocolPickledOutput TODO Do we need copy across some kind logging IDs ChromiumEventLogger pool = process_pool TODO This probably wrong thing do long-term - now let s share cache so we can identify tests broken later env_vars = TORCHINDUCTOR_CACHE_DIR TRITON_CACHE_DIR extra_env = v os environ v v env_vars v os environ pool submit _SubprocessFxCompile _run_in_child_subprocess input extra_env staticmethod functools cache process_pool - AnyPool pool = SubprocPool TODO Consider raising limit we start using async w subprocess want compile multiple graphs parallel kind=SubprocKind SPAWN atexit register pool shutdown pool classmethod _run_in_child_subprocess cls pickled_input _WireProtocolPickledInput extra_env Optional Mapping str str - _WireProtocolPickledOutput TODO In subprocess mode we need clear inductor caches The problem We compile worker A which fills stuff tmpdir parent clears inductor caches which deletes tmpdirs tells cpp_prefix_path clear its LRU cache We compile second time subproc A - since we never told cpp_prefix_path worker A clear its LRU thinks tmpdir still exists fails compile TODO We probably should using separate tmpdir worker anyway we should probably still respect clear_caches parent maybe TODO We could less aggressive keeping clock which gets incremented when we clear cache send clock worker only clear caches clock changed since last time clear_caches torch _inductor metrics reset TODO turn off config fx_graph_async_compile result = cls _run_in_child pickled_input extra_env result
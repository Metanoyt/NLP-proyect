Owner s oncall quantization ruff noqa F torch ao quantization experimental observer APoTObserver unittest torch TestNonUniformObserver unittest TestCase Test case calculate_qparams Test error thrown when k == test_calculate_qparams_invalid obs = APoTObserver b= k= obs min_val = torch tensor obs max_val = torch tensor assertRaises AssertionError alpha gamma quantization_levels level_indices = obs calculate_qparams signed=False Test case calculate_qparams APoT paper example https arxiv org pdf pdf Assume hardcoded parameters b = total number bits across all terms k = base bitwidth i e bitwidth every term n = number additive terms note b = k n test_calculate_qparams_ terms obs = APoTObserver b= k= obs min_val = torch tensor obs max_val = torch tensor alpha gamma quantization_levels level_indices = obs calculate_qparams signed=False alpha_test = torch max -obs min_val obs max_val check alpha value assertEqual alpha alpha_test calculate expected gamma value gamma_test = i range gamma_test += -i gamma_test = gamma_test check gamma value assertEqual gamma gamma_test check quantization levels size quantlevels_size_test = int len quantization_levels quantlevels_size = assertEqual quantlevels_size_test quantlevels_size check level indices size levelindices_size_test = int len level_indices assertEqual levelindices_size_test check level indices unique values level_indices_test_list = level_indices tolist assertEqual len level_indices_test_list len set level_indices_test_list Test case calculate_qparams Assume hardcoded parameters b = total number bits across all terms k = base bitwidth i e bitwidth every term n = number additive terms test_calculate_qparams_ terms obs = APoTObserver b= k= obs min_val = torch tensor obs max_val = torch tensor alpha gamma quantization_levels level_indices = obs calculate_qparams signed=False alpha_test = torch max -obs min_val obs max_val check alpha value assertEqual alpha alpha_test calculate expected gamma value gamma_test = i range gamma_test += -i gamma_test = gamma_test check gamma value assertEqual gamma gamma_test check quantization levels size quantlevels_size_test = int len quantization_levels quantlevels_size = assertEqual quantlevels_size_test quantlevels_size check level indices size levelindices_size_test = int len level_indices assertEqual levelindices_size_test check level indices unique values level_indices_test_list = level_indices tolist assertEqual len level_indices_test_list len set level_indices_test_list Test case calculate_qparams Same test case signed = True Assume hardcoded parameters b = total number bits across all terms k = base bitwidth i e bitwidth every term n = number additive terms signed = True test_calculate_qparams_signed obs = APoTObserver b= k= obs min_val = torch tensor obs max_val = torch tensor alpha gamma quantization_levels level_indices = obs calculate_qparams signed=True alpha_test = torch max -obs min_val obs max_val check alpha value assertEqual alpha alpha_test calculate expected gamma value gamma_test = i range gamma_test += -i gamma_test = gamma_test check gamma value assertEqual gamma gamma_test check quantization levels size quantlevels_size_test = int len quantization_levels assertEqual quantlevels_size_test check negatives each element contained quantization levels quantlevels_test_list = quantization_levels tolist negatives_contained = True ele quantlevels_test_list -ele quantlevels_test_list negatives_contained = False assertTrue negatives_contained check level indices size levelindices_size_test = int len level_indices assertEqual levelindices_size_test check level indices unique elements level_indices_test_list = level_indices tolist assertEqual len level_indices_test_list len set level_indices_test_list Test case calculate_qparams Assume hardcoded parameters b = total number bits across all terms k = base bitwidth i e bitwidth every term n = number additive terms test_calculate_qparams_k obs = APoTObserver b= k= obs min_val = torch tensor obs max_val = torch tensor alpha gamma quantization_levels level_indices = obs calculate_qparams signed=False calculate expected gamma value gamma_test = i range gamma_test += -i gamma_test = gamma_test check gamma value assertEqual gamma gamma_test check quantization levels size quantlevels_size_test = int len quantization_levels quantlevels_size = assertEqual quantlevels_size_test quantlevels_size check level indices size levelindices_size_test = int len level_indices level_indices_size = assertEqual levelindices_size_test level_indices_size check level indices unique values level_indices_test_list = level_indices tolist assertEqual len level_indices_test_list len set level_indices_test_list Test forward method hard-coded tensor arbitrary values Checks alpha max abs value max min values tensor test_forward obs = APoTObserver b= k= X = torch tensor - - X = obs forward X alpha gamma quantization_levels level_indices = obs calculate_qparams signed=True min_val = torch min X max_val = torch max X expected_alpha = torch max -min_val max_val assertEqual alpha expected_alpha __name__ == __main__ unittest main
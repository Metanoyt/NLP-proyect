usr bin env python contextlib os re subprocess sys collections abc Generator typing Any github_utils gh_post_pr_comment gh_post_comment gitutils get_git_remote_name get_git_repo_dir GitRepo trymerge GitHubPR SAME_SHA_ERROR = \n ` ` ` \nAborting rebase because rebasing branch resulted same sha target branch \n + This usually happens because PR has already been merged Please rebase locally push \n ` ` ` parse_args - Any argparse ArgumentParser parser = ArgumentParser Rebase PR into branch parser add_argument -- dry-run action= store_true parser add_argument -- branch type=str parser add_argument pr_num type=int parser parse_args post_already_uptodate pr GitHubPR repo GitRepo onto_branch str dry_run bool - None msg = f Tried rebase push PR pr pr_num already up date def_branch = pr default_branch def_branch_fcn = f refs remotes repo remote def_branch onto_branch = def_branch_fcn repo rev_parse def_branch_fcn = repo rev_parse onto_branch def_branch_url = f https github com pr org pr project tree def_branch msg += f Try rebasing against def_branch def_branch_url issuing msg += f \n ` pytorchbot rebase -b def_branch ` gh_post_comment pr org pr project pr pr_num msg dry_run=dry_run rebase_onto pr GitHubPR repo GitRepo onto_branch str dry_run bool = False - bool branch = f pull pr pr_num head remote_url = f https github com pr info headRepository nameWithOwner git refspec = f branch pr head_ref repo fetch branch branch repo _run_git rebase onto_branch branch repo rev_parse branch == repo rev_parse onto_branch raise Exception SAME_SHA_ERROR noqa TRY dry_run push_result = repo _run_git push -- dry-run -f remote_url refspec push_result = repo _run_git push -f remote_url refspec Everything up-to-date push_result post_already_uptodate pr repo onto_branch dry_run False gh_post_comment pr org pr project pr pr_num f Successfully rebased ` pr head_ref ` onto ` onto_branch ` please pull locally + f before adding more changes example via ` git checkout pr head_ref + git pull -- rebase ` dry_run=dry_run True rebase_ghstack_onto pr GitHubPR repo GitRepo onto_branch str dry_run bool = False - bool subprocess run sys executable -m ghstack -- help capture_output=True check=False returncode = subprocess run sys executable -m pip install ghstack check=True orig_ref = f re sub r head$ orig pr head_ref repo fetch orig_ref orig_ref repo _run_git rebase onto_branch orig_ref repo rev_parse orig_ref == repo rev_parse onto_branch raise Exception SAME_SHA_ERROR noqa TRY steal identity committer commit orig branch email = repo _run_git log orig_ref -- pretty=format ae - name = repo _run_git log orig_ref -- pretty=format - repo _run_git config -- global user email email repo _run_git config -- global user name name os environ OAUTH_TOKEN = os environ GITHUB_TOKEN open ghstackrc w+ f f write ghstack \n + github_url=github com\n + github_username=pytorchmergebot\n + remote_name=origin dry_run print Don t know how dry-run ghstack False ghstack_result = subprocess run ghstack capture_output=True check=True push_result = ghstack_result stdout decode utf- print push_result ghstack_result returncode = print ghstack_result stderr decode utf- raise Exception f \n ` ` ` push_result ` ` ` noqa TRY The contents successful push result should look like Summary changes ghstack - Updated https github com clee random-testing-public pull - Updated https github com clee random-testing-public pull Facebook employees can your changes running Facebook machine ghimport -s https github com clee random-testing-public pull If you want work diff stack another machine ghstack checkout https github com clee random-testing-public pull org project = repo gh_owner_and_name line push_result splitlines Updated line pr_num = int line split - pr_num = pr pr_num gh_post_comment pr org pr project pr_num f Rebased ` orig_ref ` onto ` onto_branch ` because pr pr_num rebased please pull locally before adding more changes example via ` ghstack + f checkout https github com org project pull pr_num ` dry_run=dry_run gh_post_comment pr org pr project pr_num f Successfully rebased ` orig_ref ` onto ` onto_branch ` please pull locally + before adding more changes example via ` ghstack + f checkout https github com org project pull pr pr_num ` dry_run=dry_run f Skipped https github com org project pull pr pr_num push_result post_already_uptodate pr repo onto_branch dry_run False True additional_rebase_failure_info e Exception - str re search r remote Permission denied \ \nfatal unable access str e \nThis likely because author did allow edits maintainers PR because repo has additional permissions settings mergebot does qualify contextlib contextmanager git_config_guard repo GitRepo - Generator None None None Restores user name user email global properties after context finished user_email = repo _run_git config user email user_name = repo _run_git config user name try yield finally user_email repo _run_git config -- global user email user_email user_name repo _run_git config -- global user name user_name main - None args = parse_args repo = GitRepo get_git_repo_dir get_git_remote_name debug=True org project = repo gh_owner_and_name pr = GitHubPR org project args pr_num onto_branch = args branch args branch pr default_branch onto_branch = f refs remotes repo remote onto_branch onto_branch_url = f https github com org project commit repo rev_parse onto_branch msg = f pytorchbot started rebase job onto onto_branch onto_branch_url msg += f Check current status here os getenv GH_RUN_URL gh_post_comment org project args pr_num msg dry_run=args dry_run pr is_closed gh_post_comment org project args pr_num f PR args pr_num closed won t rebase dry_run=args dry_run try pr is_ghstack_pr git_config_guard repo rc = rebase_ghstack_onto pr repo onto_branch dry_run=args dry_run rc = rebase_onto pr repo onto_branch dry_run=args dry_run sys exit rc except Exception e msg = f Rebase failed due e msg += additional_rebase_failure_info e run_url = os getenv GH_RUN_URL run_url None msg += f \nRaised run_url gh_post_comment org project args pr_num msg dry_run=args dry_run __name__ == __main__ main
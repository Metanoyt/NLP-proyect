__future__ annotations json os time typing Any TYPE_CHECKING util setting CompilerType JSON_FOLDER_BASE_DIR TestList TestPlatform TestStatusType util utils detect_compiler_type print_error print_time related_to_test_list parser gcov_coverage_parser GcovCoverageParser parser llvm_coverage_parser LlvmCoverageParser print_report file_oriented_report html_oriented_report line_oriented_report TYPE_CHECKING parser coverage_record CoverageRecord coverage_records dict str LineInfo = covered_lines dict str set int = uncovered_lines dict str set int = tests_type TestStatusType = success set partial set fail set transform_file_name file_path str interested_folders list str platform TestPlatform - str remove_patterns set str = DEFAULT cpp AVX cpp AVX cpp pattern remove_patterns file_path = file_path replace pattern user has specified interested folder interested_folders folder interested_folders folder file_path file_path file_path find folder remove pytorch base folder path platform == TestPlatform OSS package oss utils get_pytorch_folder type ignore pytorch_foler = get_pytorch_folder assert file_path startswith pytorch_foler file_path = file_path len pytorch_foler + file_path is_intrested_file file_path str interested_folders list str platform TestPlatform - bool ignored_patterns = cuda aten gen_aten aten aten_ build any pattern file_path pattern ignored_patterns False ignore files belong pytorch platform == TestPlatform OSS pyrefly ignore import-error package oss utils get_pytorch_folder file_path startswith get_pytorch_folder False user has specified interested folder interested_folders folder interested_folders intersted_folder_path = folder folder endswith f folder intersted_folder_path file_path True False True get_json_obj json_file str - tuple Any int Sometimes start file llvm gcov will complains fail find coverage data then we need skip these lines -- success read - json file have full json coverage information -- partial success - json file starts some error prompt still have coverage information -- fail read - json file doesn t have any coverage information read_status = - open json_file f lines = f readlines line lines try json_obj = json loads line except json JSONDecodeError read_status = continue read_status == - meet jsonDecoderError before success read_status = json_obj read_status None parse_json json_file str platform TestPlatform - list CoverageRecord print start parse json_file json_obj read_status = get_json_obj json_file read_status == tests_type success add json_file read_status == tests_type partial add json_file tests_type fail add json_file raise RuntimeError Fail do code coverage Fail load json file json_file cov_type = detect_compiler_type platform coverage_records list CoverageRecord = cov_type == CompilerType CLANG coverage_records = LlvmCoverageParser json_obj parse fbcode print coverage_records cov_type == CompilerType GCC coverage_records = GcovCoverageParser json_obj parse coverage_records parse_jsons test_list TestList interested_folders list str platform TestPlatform - None g = os walk JSON_FOLDER_BASE_DIR path _ file_list g file_name file_list file_name endswith json compiler clang we only analyze related json when compiler gcc we analyze all jsons cov_type = detect_compiler_type platform cov_type == CompilerType CLANG related_to_test_list file_name test_list continue json_file = os path join path file_name try coverage_records = parse_json json_file platform except RuntimeError print_error Fail load json file json_file continue collect information each target s export file merge them together update_coverage coverage_records interested_folders platform update_coverage coverage_records list CoverageRecord interested_folders list str platform TestPlatform - None item coverage_records extract information record record = item to_dict file_path = record filepath is_intrested_file file_path interested_folders platform continue covered_range = record covered_lines uncovered_range = record uncovered_lines transform file name remote caffe aten - caffe aten file_path = transform_file_name file_path interested_folders platform file exists add into dictionary file_path covered_lines covered_lines file_path = set file_path uncovered_lines uncovered_lines file_path = set update file s covered uncovered lines covered_range None covered_lines file_path update covered_range uncovered_range None uncovered_lines file_path update uncovered_range update_set - None file_name covered_lines difference_update uncovered_lines file_name difference_update covered_lines file_name summarize_jsons test_list TestList interested_folders list str coverage_only list str platform TestPlatform - None start_time = time time detect_compiler_type platform == CompilerType GCC html_oriented_report parse_jsons test_list interested_folders platform update_set line_oriented_report test_list tests_type interested_folders coverage_only covered_lines uncovered_lines file_oriented_report test_list tests_type interested_folders coverage_only covered_lines uncovered_lines print_time summary jsons take time start_time
Owner s module meta tensors copy gc random threading unittest torch torch testing _internal common_utils IS_MACOS run_tests TestCase torch testing _internal torchbind_impls load_torchbind_test_lib torch utils weak _WeakHashRef WeakIdKeyDictionary C torch randn These tests ported cpython Lib test test_weakref py adapted use tensor rather than object WeakTest TestCase COUNT = test_make_weak_keyed_dict_from_dict o = torch randn dict = WeakIdKeyDictionary o assertEqual dict o test_make_weak_keyed_dict_from_weak_keyed_dict o = torch randn dict = WeakIdKeyDictionary o assertEqual dict o dict = WeakIdKeyDictionary dict assertEqual dict o check_popitem klass key value key value weakdict = klass weakdict key = value weakdict key = value assertEqual len weakdict k v = weakdict popitem assertEqual len weakdict k key assertIs v value assertIs v value k v = weakdict popitem assertEqual len weakdict k key assertIs v value assertIs v value test_weak_keyed_dict_popitem check_popitem WeakIdKeyDictionary C value C value check_setdefault klass key value value assertIsNot value value invalid test -- value parameters must distinct objects weakdict = klass o = weakdict setdefault key value assertIs o value assertIn key weakdict assertIs weakdict get key value assertIs weakdict key value o = weakdict setdefault key value assertIs o value assertIn key weakdict assertIs weakdict get key value assertIs weakdict key value test_weak_keyed_dict_setdefault check_setdefault WeakIdKeyDictionary C value value check_update klass dict This exercises d update len d d keys k d d get d weakdict = klass weakdict update dict assertEqual len weakdict len dict k weakdict keys assertIn k dict mysterious new key appeared weak dict v = dict get k assertIs v weakdict k assertIs v weakdict get k k dict keys assertIn k weakdict original key disappeared weak dict v = dict k assertIs v weakdict k assertIs v weakdict get k test_weak_keyed_dict_update check_update WeakIdKeyDictionary C C C test_weak_keyed_delitem d = WeakIdKeyDictionary o = torch randn o = torch randn d o = something d o = something assertEqual len d del d o assertEqual len d assertEqual list d keys o test_weak_keyed_union_operators try &#124; except TypeError skipTest dict union supported Python o = C o = C o = C wkd = WeakIdKeyDictionary o o wkd = WeakIdKeyDictionary o o wkd = wkd copy d = o o pairs = o o tmp = wkd &#124; wkd Between two WeakKeyDictionaries assertEqual dict tmp dict wkd &#124; dict wkd assertIs type tmp WeakIdKeyDictionary wkd &#124; = wkd assertEqual wkd tmp tmp = wkd &#124; d Between WeakKeyDictionary mapping assertEqual dict tmp dict wkd &#124; d assertIs type tmp WeakIdKeyDictionary wkd &#124; = d assertEqual wkd tmp tmp = wkd copy Between WeakKeyDictionary iterable key value tmp &#124; = pairs assertEqual dict tmp dict wkd &#124; dict pairs assertIs type tmp WeakIdKeyDictionary tmp = d &#124; wkd Testing __ror__ assertEqual dict tmp d &#124; dict wkd assertIs type tmp WeakIdKeyDictionary del o assertNotIn tmp values assertNotIn tmp values assertNotIn tmp values assertNotIn tmp values test_weak_keyed_bad_delitem d = WeakIdKeyDictionary o = torch randn An attempt delete object isn t there should raise KeyError It didn t before assertRaises KeyError d __delitem__ o assertRaises KeyError d __getitem__ o If key isn t weakly referenceable type __getitem__ __setitem__ raise TypeError __delitem__ should too assertRaises TypeError d __delitem__ assertRaises TypeError d __getitem__ assertRaises TypeError d __setitem__ test_make_weak_keyed_dict_repr dict = WeakIdKeyDictionary assertRegex repr dict WeakIdKeyDictionary x check_threaded_weak_dict_copy type_ deepcopy ` deepcopy ` should either True False exc = Cannot give these slots weakrefs weren t supported these objects until later versions Python DummyKey noqa B __init__ ctr ctr = ctr DummyValue noqa B __init__ ctr ctr = ctr dict_copy d exc try deepcopy True _ = copy deepcopy d _ = d copy except Exception ex exc append ex pop_and_collect lst gc_ctr = while lst i = random randint len lst - gc_ctr += lst pop i gc_ctr == gc collect just case d = type_ keys = values = Initialize d many entries i range k v = DummyKey i DummyValue i keys append k values append v d k = v del k del v t_copy = threading Thread target=dict_copy args= d exc t_collect = threading Thread target=pop_and_collect args= keys t_copy start t_collect start t_copy join t_collect join Test exceptions exc raise exc test_threaded_weak_key_dict_copy Issue Weakref keys values getting GC ed during dict copying should result crash check_threaded_weak_dict_copy WeakIdKeyDictionary False test_threaded_weak_key_dict_deepcopy Issue Weakref keys values getting GC ed during dict copying should result crash check_threaded_weak_dict_copy WeakIdKeyDictionary True Adapted cpython Lib test mapping_tests py WeakKeyDictionaryTestCase TestCase __ref = torch randn torch randn torch randn type test = WeakIdKeyDictionary _reference __ref copy _empty_mapping Return empty mapping object type test _full_mapping data Return mapping object value contained data dictionary x = _empty_mapping key value data items x key = value x __init__ args kw unittest TestCase __init__ args kw reference = _reference copy A key value pair mapping key value = reference popitem other = key value A key value pair mapping key value = reference popitem inmapping = key value reference key = value test_read Test read only operations mapping p = _empty_mapping p = dict p workaround singleton objects d = _full_mapping reference d p p = p Indexing key value reference items assertEqual d key value knownkey = next iter other keys assertRaises KeyError lambda d knownkey len assertEqual len p assertEqual len d len reference __contains__ k reference assertIn k d k other assertNotIn k d cmp assertTrue p == p NB don t use assertEqual doesn t actually use == assertTrue d == d assertTrue p = d assertTrue d = p bool p fail Empty mapping must compare False d fail Full mapping must compare True keys items iterkeys check_iterandlist iter lst ref assertTrue hasattr iter __next__ assertTrue hasattr iter __iter__ x = list iter assertTrue set x == set lst == set ref check_iterandlist iter d keys list d keys reference keys check_iterandlist iter d list d keys reference keys check_iterandlist iter d values list d values reference values check_iterandlist iter d items list d items reference items get key value = next iter d items knownkey knownvalue = next iter other items assertEqual d get key knownvalue value assertEqual d get knownkey knownvalue knownvalue assertNotIn knownkey d test_write Test write operations mapping p = _empty_mapping Indexing key value reference items p key = value assertEqual p key value key reference keys del p key assertRaises KeyError lambda p key p = _empty_mapping update p update reference assertEqual dict p reference items = list p items p = _empty_mapping p update items assertEqual dict p reference d = _full_mapping reference setdefault key value = next iter d items knownkey knownvalue = next iter other items assertEqual d setdefault key knownvalue value assertEqual d key value assertEqual d setdefault knownkey knownvalue knownvalue assertEqual d knownkey knownvalue pop assertEqual d pop knownkey knownvalue assertNotIn knownkey d assertRaises KeyError d pop knownkey default = d knownkey = knownvalue assertEqual d pop knownkey default knownvalue assertNotIn knownkey d assertEqual d pop knownkey default default popitem key value = d popitem assertNotIn key d assertEqual value reference key p = _empty_mapping assertRaises KeyError p popitem test_constructor assertEqual _empty_mapping _empty_mapping test_bool assertTrue _empty_mapping assertTrue reference assertTrue bool _empty_mapping False assertTrue bool reference True test_keys d = _empty_mapping assertEqual list d keys d = reference assertIn next iter inmapping keys d keys assertNotIn next iter other keys d keys assertRaises TypeError d keys None test_values d = _empty_mapping assertEqual list d values assertRaises TypeError d values None test_items d = _empty_mapping assertEqual list d items assertRaises TypeError d items None test_len d = _empty_mapping assertEqual len d test_getitem d = reference assertEqual d next iter inmapping keys next iter inmapping values assertRaises TypeError d __getitem__ test_update mapping argument d = _empty_mapping d update other assertEqual list d items list other items No argument d = _empty_mapping d update assertEqual d _empty_mapping item sequence d = _empty_mapping d update other items assertEqual list d items list other items Iterator d = _empty_mapping d update other items assertEqual list d items list other items FIXME Doesn t work UserDict assertRaises TypeError AttributeError d update None assertRaises TypeError AttributeError d update outerself = SimpleUserDict __init__ - None d = outerself reference keys d keys __getitem__ i d i d clear d update SimpleUserDict i = sorted id k v k v d items i = sorted id k v k v reference items assertEqual i i Exc Exception pass d = _empty_mapping FailingUserDict keys raise Exc assertRaises Exc d update FailingUserDict d clear FailingUserDict keys BogonIter __init__ - None i = __iter__ __next__ i i = raise Exc BogonIter __getitem__ key key assertRaises Exc d update FailingUserDict FailingUserDict keys BogonIter __init__ - None i = ord __iter__ __next__ i = ord z rtn = chr i i += rtn raise StopIteration BogonIter __getitem__ key raise Exc assertRaises Exc d update FailingUserDict d = _empty_mapping badseq __iter__ __next__ raise Exc assertRaises Exc d update badseq assertRaises ValueError d update no test_fromkeys test_copy both os environ selves don t support test_get d = _empty_mapping assertTrue d get next iter other keys None assertEqual d get next iter other keys d = reference assertTrue d get next iter other keys None assertEqual d get next iter other keys assertEqual d get next iter inmapping keys next iter inmapping values assertEqual d get next iter inmapping keys next iter inmapping values assertRaises TypeError d get assertRaises TypeError d get None None None test_setdefault d = _empty_mapping assertRaises TypeError d setdefault test_popitem d = _empty_mapping assertRaises KeyError d popitem assertRaises TypeError d popitem test_pop d = _empty_mapping k v = next iter inmapping items d k = v assertRaises KeyError d pop next iter other keys assertEqual d pop k v assertEqual len d assertRaises KeyError d pop k Adapted cpython Lib test mapping_tests py WeakKeyDictionaryScriptObjectTestCase TestCase _reference __ref = torch classes _TorchScriptTesting _Foo torch classes _TorchScriptTesting _Foo torch classes _TorchScriptTesting _Foo __ref copy _empty_mapping Return empty mapping object WeakIdKeyDictionary ref_type=_WeakHashRef _full_mapping data Return mapping object value contained data dictionary x = _empty_mapping key value data items x key = value x setUp IS_MACOS raise unittest SkipTest non-portable load_library call used test __init__ args kw unittest TestCase __init__ args kw try load_torchbind_test_lib except unittest SkipTest Skip setup reference = _reference copy A key value pair mapping key value = reference popitem other = key value A key value pair mapping key value = reference popitem inmapping = key value reference key = value test_read Test read only operations mapping p = _empty_mapping p = dict p workaround singleton objects d = _full_mapping reference d p p = p Indexing key value reference items assertEqual d key value knownkey = next iter other keys assertRaises KeyError lambda d knownkey len assertEqual len p assertEqual len d len reference __contains__ k reference assertIn k d k other assertNotIn k d cmp assertTrue p == p NB don t use assertEqual doesn t actually use == assertTrue d == d assertTrue p = d assertTrue d = p bool p fail Empty mapping must compare False d fail Full mapping must compare True keys items iterkeys check_iterandlist iter lst ref assertTrue hasattr iter __next__ assertTrue hasattr iter __iter__ x = list iter assertTrue set x == set lst == set ref check_iterandlist iter d keys list d keys reference keys check_iterandlist iter d list d keys reference keys check_iterandlist iter d values list d values reference values check_iterandlist iter d items list d items reference items get key value = next iter d items knownkey knownvalue = next iter other items assertEqual d get key knownvalue value assertEqual d get knownkey knownvalue knownvalue assertNotIn knownkey d test_write Test write operations mapping p = _empty_mapping Indexing key value reference items p key = value assertEqual p key value key reference keys del p key assertRaises KeyError lambda p key p = _empty_mapping update p update reference assertEqual dict p reference items = list p items p = _empty_mapping p update items assertEqual dict p reference d = _full_mapping reference setdefault key value = next iter d items knownkey knownvalue = next iter other items assertEqual d setdefault key knownvalue value assertEqual d key value assertEqual d setdefault knownkey knownvalue knownvalue assertEqual d knownkey knownvalue pop assertEqual d pop knownkey knownvalue assertNotIn knownkey d assertRaises KeyError d pop knownkey default = d knownkey = knownvalue assertEqual d pop knownkey default knownvalue assertNotIn knownkey d assertEqual d pop knownkey default default popitem key value = d popitem assertNotIn key d assertEqual value reference key p = _empty_mapping assertRaises KeyError p popitem test_constructor assertEqual _empty_mapping _empty_mapping test_bool assertTrue _empty_mapping assertTrue reference assertTrue bool _empty_mapping False assertTrue bool reference True test_keys d = _empty_mapping assertEqual list d keys d = reference assertIn next iter inmapping keys d keys assertNotIn next iter other keys d keys assertRaises TypeError d keys None test_values d = _empty_mapping assertEqual list d values assertRaises TypeError d values None test_items d = _empty_mapping assertEqual list d items assertRaises TypeError d items None test_len d = _empty_mapping assertEqual len d test_getitem d = reference assertEqual d next iter inmapping keys next iter inmapping values assertRaises TypeError d __getitem__ test_update mapping argument d = _empty_mapping d update other assertEqual list d items list other items No argument d = _empty_mapping d update assertEqual d _empty_mapping item sequence d = _empty_mapping d update other items assertEqual list d items list other items Iterator d = _empty_mapping d update other items assertEqual list d items list other items FIXME Doesn t work UserDict assertRaises TypeError AttributeError d update None assertRaises TypeError AttributeError d update outerself = SimpleUserDict __init__ - None d = outerself reference keys d keys __getitem__ i d i d clear d update SimpleUserDict i = sorted id k v k v d items i = sorted id k v k v reference items assertEqual i i Exc Exception pass d = _empty_mapping FailingUserDict keys raise Exc assertRaises Exc d update FailingUserDict d clear FailingUserDict keys BogonIter __init__ - None i = __iter__ __next__ i i = raise Exc BogonIter __getitem__ key key assertRaises Exc d update FailingUserDict FailingUserDict keys BogonIter __init__ - None i = ord __iter__ __next__ i = ord z rtn = chr i i += rtn raise StopIteration BogonIter __getitem__ key raise Exc assertRaises Exc d update FailingUserDict d = _empty_mapping badseq __iter__ __next__ raise Exc assertRaises Exc d update badseq assertRaises ValueError d update no test_fromkeys test_copy both os environ selves don t support test_get d = _empty_mapping assertTrue d get next iter other keys None assertEqual d get next iter other keys d = reference assertTrue d get next iter other keys None assertEqual d get next iter other keys assertEqual d get next iter inmapping keys next iter inmapping values assertEqual d get next iter inmapping keys next iter inmapping values assertRaises TypeError d get assertRaises TypeError d get None None None test_setdefault d = _empty_mapping assertRaises TypeError d setdefault test_popitem d = _empty_mapping assertRaises KeyError d popitem assertRaises TypeError d popitem test_pop d = _empty_mapping k v = next iter inmapping items d k = v assertRaises KeyError d pop next iter other keys assertEqual d pop k v assertEqual len d assertRaises KeyError d pop k __name__ == __main__ run_tests
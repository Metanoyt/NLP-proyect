mypy ignore-errors os re sys __all__ = check_code_for_cuda_kernel_launches check_cuda_kernel_launches FILES TO EXCLUDE match done suffix using ` endswith ` You wouldn t drive without seatbelt though so why would you launch kernel without some safety Use quick workaround problem checker fix checker then de-exclude files question exclude_files list str = Without using C++ AST we can t detect kernel launches so we model them having pattern parameters arguments We then require ` C _CUDA_KERNEL_LAUNCH_CHECK ` next statement We model next statement ending next ` ` ` ` If we see ` ` then clause ended bad we see semi-colon then we expect launch check just before Since kernel launch can include lambda statements s important find correct end-paren kernel launch Doing pure regex requires recursive regex which aren t part Python standard library To avoid additional dependency we build prefix regex finds start kernel launch use paren-matching algorithm find end launch then another regex determine launch check present Finds potential starts kernel launches kernel_launch_start = re compile r ^ ^ + \s \ flags=re MULTILINE This pattern should start character after final paren kernel launch It returns match launch check next statement has_check = re compile r \s ^ C _CUDA_KERNEL_LAUNCH_CHECK\ \ flags=re MULTILINE find_matching_paren s str startpos int - int Given string prefix unknown number characters suffix position first ` ` returns index character past ` ` accounting paren nesting opening = i c enumerate s startpos c == opening += c == opening -= opening == startpos + i + raise IndexError Closing parens found should_exclude_file filename - bool exclude_suffix exclude_files filename endswith exclude_suffix True False check_code_for_cuda_kernel_launches code filename=None Checks code CUDA kernel launches without cuda error checks Args filename - Filename file containing code Used only display purposes so you can put anything here code - The code check Returns The number unsafe kernel launches code filename None filename = ##Python Function Call## We break code apart put back together add helpful line numberings identifying problem areas code = enumerate code split \n Split line breaks code = f lineno linecode lineno linecode code Number lines code = \n join code Put back together num_launches_without_checks = m kernel_launch_start finditer code end_paren = find_matching_paren code m end - has_check match code end_paren num_launches_without_checks += context = code m start end_paren + print f Missing C _CUDA_KERNEL_LAUNCH_CHECK filename Context \n context file=sys stderr num_launches_without_checks check_file filename Checks file CUDA kernel launches without cuda error checks Args filename - File check Returns The number unsafe kernel launches file filename endswith cu cuh should_exclude_file filename open filename f contents = f read unsafeCount = check_code_for_cuda_kernel_launches contents filename unsafeCount check_cuda_kernel_launches Checks all pytorch code CUDA kernel launches without cuda error checks Returns The number unsafe kernel launches codebase torch_dir = os path dirname os path realpath __file__ torch_dir = os path dirname torch_dir Go up parent torch torch_dir = os path dirname torch_dir Go up parent caffe kernels_without_checks = files_without_checks = root dirnames filenames os walk torch_dir ` $ BASE build ` ` $ BASE torch include ` generated so we don t want flag their contents root == os path join torch_dir build root == os path join torch_dir torch include Curtail search modifying dirnames filenames place Yes way do see ` help os walk ` dirnames = continue x filenames filename = os path join root x file_result = check_file filename file_result kernels_without_checks += file_result files_without_checks append filename kernels_without_checks count_str = f Found kernels_without_checks instances \ f len files_without_checks files where kernel \ launches didn t have checks print count_str file=sys stderr print Files without checks file=sys stderr x files_without_checks print f \t x file=sys stderr print count_str file=sys stderr kernels_without_checks __name__ == __main__ unsafe_launches = check_cuda_kernel_launches sys exit unsafe_launches ==
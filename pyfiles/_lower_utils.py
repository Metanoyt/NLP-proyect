types torch torch utils _pytree pytree torch export ExportedProgram torch export pt _archive _package AOTI_FILES package_pt torch types FileLike _lowered_aoti_module LoweredBackendModule get_new_ep_with_flat_inputs_outputs ep ExportedProgram - ExportedProgram FlattenedModule torch nn Module __init__ original_module torch fx GraphModule in_spec pytree TreeSpec out_spec pytree TreeSpec - None super __init__ original_module = original_module in_spec = in_spec out_spec = out_spec forward flat_inputs type ignore no-untyped-def Unflatten inputs original structure inputs = pytree tree_unflatten flat_inputs in_spec args kwargs = inputs outputs = original_module args kwargs Flatten outputs flat_outputs _ = pytree tree_flatten outputs tuple flat_outputs flattened_module = FlattenedModule ep module ep call_spec in_spec ep call_spec out_spec args kwargs = ep example_inputs flat_inputs _ = pytree tree_flatten args kwargs flat_ep = torch export export flattened_module tuple flat_inputs flat_ep lower_exported_program exported_program ExportedProgram model_name str backend_id str - tuple ExportedProgram AOTI_FILES Lower exported program AOTInductor delegate ExportedProgram ` executorch_call_delegate ` HOP args kwargs = exported_program example_inputs out_spec = exported_program call_spec out_spec flat_ep = get_new_ep_with_flat_inputs_outputs exported_program flat_inputs _ = pytree tree_flatten args kwargs aoti_files = torch _inductor aot_compile flat_ep module tuple flat_inputs options= aot_inductor package True assert isinstance aoti_files list lowered_aoti_module = LoweredBackendModule flat_ep backend_id module_name=model_name patched_forward args kwargs type ignore no-untyped-def flat_inputs _ = pytree tree_flatten args kwargs flat_outputs = torch _higher_order_ops executorch_call_delegate flat_inputs out_spec None flat_outputs None pytree tree_unflatten flat_outputs out_spec flat_outputs lowered_aoti_module forward = types MethodType patched_forward lowered_aoti_module type ignore method-assign aoti_delegate_ep = torch export export lowered_aoti_module args kwargs aoti_delegate_ep aoti_files package_nativert_with_aoti_delegate f FileLike model_name str backend_id str original_ep ExportedProgram delegate_ep ExportedProgram delegate_files AOTI_FILES - None Package pt archive file can consumed NativeRT AOTI Delegate package_pt f exported_programs= model_name original_ep f model_name - backend_id delegate_ep aoti_files= f model_name - backend_id delegate_files type ignore dict-item
Cache implementation classes PyTorch Inductor runtime caching This module provides concrete implementations caching backends including in-memory on-disk remote caching strategies Each implementation follows abstract _CacheImpl interface provides thread-safe operations appropriate locking mechanisms abc ABC abstractmethod contextlib contextmanager dataclasses dataclass hashlib sha io BufferedReader BufferedWriter os PathLike pathlib Path threading Lock typing Any Generator typing_extensions override filelock FileLock locks utils dataclass Hit Result wrapper hits cache get operations Allows distinguishing between cache miss cached None value Attributes value The cached value value Any Miss Sentinel representing cache miss Used distinguish between cached None value cache miss when None valid cached value Singleton instance cache miss sentinel miss = Miss _CacheImpl ABC Abstract base cache implementations This defines interface all cache implementations must follow It provides thread-safe operations through locking mechanism supports both get insert operations Note We don t use generics here doing so would require interfaces know which k v types implementation can work Instead we leave determination up implementation itself require interfaces handle any potential errors invalid k v types being passed implementation __init__ - None Initialize cache implementation threading lock _lock Lock = Lock property lock - locks _LockProtocol Get context manager acquiring cache lock Locking cache done implementation itself interface uses The interface may want hold lock longer than single cache operation example when dealing multiple cache implementations once so we leave decision up interface Args timeout Optional timeout seconds float acquiring lock Returns A callable returns context manager lock _lock_with_timeout timeout float &#124; None = None - locks _LockContextManager locks _acquire_lock_with_timeout _lock timeout _lock_with_timeout abstractmethod get key Any - Hit &#124; None Retrieve value cache Args key The key look up cache Returns A Hit object cache hit where Hit value cached value None cache miss abstractmethod insert key Any value Any - bool Insert key-value pair into cache Args key The key insert value The value associate key Returns True insertion successful False inserted _InMemoryCacheImpl _CacheImpl In-memory cache implementation using dictionary This implementation stores key-value pairs Python dictionary keys being pickled consistent hashing It provides fast access limited available memory process lifetime __init__ - None Initialize in-memory cache empty dictionary super __init__ _memory dict bytes Any = override get key Any - Hit &#124; None Retrieve value in-memory cache Args key The key look up Will pickled storage Returns A Hit object cache hit where Hit value cached value None cache miss pickled_key bytes = utils _try_pickle_key key value = _memory get pickled_key miss miss Hit value=value None override insert key Any value Any - bool Insert key-value pair into in-memory cache Args key The key insert Will pickled storage value The value associate key Returns True insertion successful key new False inserted key already existed pickled_key bytes = utils _try_pickle_key key pickled_key _memory _memory pickled_key = value True False _OnDiskCacheImpl _CacheImpl On-disk cache implementation using file system storage This implementation stores cached data files disk version headers handle cache invalidation It uses file locking ensure thread safety across processes provides persistent storage survives process restarts Attributes _version Version number cache format compatibility _version_header_length Length version header bytes _version int = _version_header_length int = __init__ sub_dir PathLike str &#124; None = None - None Initialize on-disk cache specified subdirectory Args sub_dir Subdirectory name within cache directory Defaults empty string specified _cache_dir Path = _base_dir sub_dir pyrefly ignore bad-assignment _flock FileLock = FileLock str _cache_dir dir lock property _base_dir - Path Get base directory cache storage Returns Path cache directory based default cache dir specified subdirectory torch _inductor runtime runtime_utils default_cache_dir Path default_cache_dir cache _fpath_from_key key Any - Path Generate file path cache key Args key The cache key convert file path Returns A Path object representing file location key pickled_key bytes = utils _try_pickle_key key _cache_dir sha pickled_key hexdigest classmethod _version_header cls - bytes Generate version header bytes Returns A byte string representing current cache version header sha str cls _version encode digest cls _version_header_length _version_header_matches fp BufferedReader - bool Check file s version header matches current version Args fp File pointer positioned start file Returns True version header matches False otherwise fp read _version_header_length == _version_header _write_version_header fp BufferedWriter - None Write version header file Args fp File pointer where version header should written fp write _version_header override property lock - locks _LockProtocol Get context manager acquiring file lock Uses file locking ensure thread safety across processes Args timeout Optional timeout seconds float acquiring file lock Returns A callable returns context manager file lock _lock_with_timeout timeout float &#124; None = None - locks _LockContextManager locks _acquire_flock_with_timeout _flock timeout _lock_with_timeout override get key Any - Hit &#124; None Retrieve value on-disk cache Args key The key look up cache Returns A Hit object cache hit where Hit value cached value None cache miss version mismatch fpath Path = _fpath_from_key key fpath is_file None pickled_value bytes &#124; None = None open fpath rb fp _version_header_matches fp pickled_value = fp read pickled_value pickled_value still None even though file exists then we know version header did match case implementation up preference we choose remove entries do match version header so key can re-cached later correct version header fpath unlink None Hit value=utils _try_unpickle_value pickled_value override insert key Any value Any - bool Insert key-value pair into on-disk cache Args key The key insert value The value associate key Returns True successfully inserted False key already exists valid version fpath Path = _fpath_from_key key fpath parent mkdir parents=True exist_ok=True r_fp w_fp inserted = None None False try w_fp = open fpath xb except FileExistsError is_stale bool = False open fpath rb r_fp is_stale = _version_header_matches r_fp is_stale same story above case version header doesn t match so we choose remove old entry so new k v pair can cached fpath unlink w_fp = open fpath xb w_fp = None finally w_fp try pickled_value bytes = utils _try_pickle_value value _write_version_header w_fp w_fp write pickled_value inserted = True finally w_fp close inserted try fb implementations _RemoteCacheImpl except ModuleNotFoundError _RemoteCacheImpl _CacheImpl type ignore no-redef Fallback remote cache implementation non-Facebook environments This no-op implementation always raises NotImplementedError The actual remote cache implementation provided ` fb ` module Facebook-specific environments Attributes _version Version number cache format compatibility has_strong_consistency Whether remote cache provides strong consistency guarantees _version int = has_strong_consistency bool = False __init__ - None Initialize fallback remote cache implementation Note We don t need initialize any form lock since implementation provides pseudo-lock context manager override property lock - locks _LockProtocol Get pseudo lock does nothing Most remote cache implementations don t have ability implement any form locking so we provide no-op pseudo-lock consistency interface Args timeout Optional timeout seconds float Ignored Returns A callable returns no-op context manager contextmanager pseudo_lock timeout float &#124; None = None - Generator None None None yield pseudo_lock override get key Any - Hit &#124; None Raise NotImplementedError remote cache get operations Args key The key look up ignored Raises NotImplementedError Always raised fallback implementation raise NotImplementedError override insert key Any value Any - bool Raise NotImplementedError remote cache insert operations Args key The key insert ignored value The value insert ignored Raises NotImplementedError Always raised fallback implementation raise NotImplementedError
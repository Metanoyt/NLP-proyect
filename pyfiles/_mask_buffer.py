mypy allow-untyped-defs Copyright c Meta Platforms Inc affiliates dataclasses dataclass typing Optional torch dataclass MaskBuffer data Optional torch Tensor = None refcount allows shared usage MaskBuffer long all users have same data refcount int = materialize_mask mask refcount == data = mask assert data None torch equal data mask raise RuntimeError MaskBuffer has been materialized conflicting data refcount += release_mask refcount == data None raise RuntimeError MaskBuffer has been materialized refcount -= refcount == data = None apply_mask tensor refcount == data None raise RuntimeError MaskBuffer has been materialized NOTE MaskPartial being used embedding op gather op For gather mask has same dimension output tensor whereas output embedding op has additional dimension compare input hence output masking logic below having two different cases tensor ndim == data ndim tensor data = tensor data =
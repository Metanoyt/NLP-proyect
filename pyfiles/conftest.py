Owner s module dynamo sys pytest torch _numpy tnp pytest_configure config config addinivalue_line markers slow very slow tests pytest_addoption parser parser addoption -- runslow action= store_true help= run slow tests parser addoption -- nonp action= store_true help= error when NumPy accessed Inaccessible __getattribute__ attr raise RuntimeError f Using -- nonp accessed np attr pytest_sessionstart session session config getoption -- nonp sys modules numpy = Inaccessible pytest_generate_tests metafunc Hook parametrize test cases See https docs pytest org en x parametrize html#pytest-generate-tests The logic here allows us test both NumPy-proper torch _numpy Normally we d just test torch _numpy e g torch _numpy np test_foo np array hook allows us test NumPy-proper well e g test_foo np np array np pytest parameter which either NumPy-proper torch _numpy This allows us sanity check our own tests so tested behaviour consistent NumPy-proper pytest will have test names respective library being tested e g $ pytest -- collect-only test_foo torch _numpy test_foo numpy np_params = tnp try numpy np except ImportError pass isinstance np Inaccessible i e -- nonp used np_params append np np metafunc fixturenames metafunc parametrize np np_params pytest_collection_modifyitems config items config getoption -- runslow skip_slow = pytest mark skip reason= slow test use -- runslow run item items slow item keywords item add_marker skip_slow
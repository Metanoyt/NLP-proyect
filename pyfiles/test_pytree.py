Owner s module pytree enum inspect os re subprocess sys time unittest collections defaultdict deque namedtuple OrderedDict UserDict dataclasses dataclass field enum auto typing Any NamedTuple Optional torch torch utils _pytree python_pytree torch fx immutable_collections immutable_dict immutable_list torch testing _internal common_utils instantiate_parametrized_tests IS_FBCODE parametrize run_tests subtest TestCase pytree_modules = python python_pytree IS_FBCODE torch utils _cxx_pytree cxx_pytree pytree_modules cxx = cxx_pytree optree yet enabled fbcode so just re-test python implementation cxx_pytree = python_pytree parametrize_pytree_module = parametrize pytree subtest module name=name name module pytree_modules items GlobalPoint = namedtuple GlobalPoint x y GlobalDummyType __init__ x y x = x y = y cxx_pytree register_pytree_node GlobalDummyType lambda dummy dummy x dummy y None lambda xs _ GlobalDummyType xs serialized_type_name= GlobalDummyType TestEnum enum Enum A = auto TestGenericPytree TestCase test_aligned_public_apis public_apis = python_pytree __all__ assertEqual public_apis cxx_pytree __all__ name public_apis cxx_api = getattr cxx_pytree name python_api = getattr python_pytree name assertEqual inspect isclass cxx_api inspect isclass python_api assertEqual inspect isfunction cxx_api inspect isfunction python_api inspect isfunction cxx_api cxx_signature = inspect signature cxx_api python_signature = inspect signature python_api Check parameter names same cxx_param_names = list cxx_signature parameters python_param_names = list python_signature parameters assertEqual cxx_param_names python_param_names Check positional parameters same cxx_positional_param_names = n n p cxx_signature parameters items p kind inspect Parameter POSITIONAL_ONLY inspect Parameter POSITIONAL_OR_KEYWORD python_positional_param_names = n n p python_signature parameters items p kind inspect Parameter POSITIONAL_ONLY inspect Parameter POSITIONAL_OR_KEYWORD assertEqual cxx_positional_param_names python_positional_param_names python_name python_param python_signature parameters items assertIn python_name cxx_signature parameters cxx_param = cxx_signature parameters python_name Check parameter kinds default values same assertEqual cxx_param kind python_param kind assertEqual cxx_param default python_param default Check parameter annotations same TreeSpec str cxx_param annotation assertIn TreeSpec str python_param annotation assertEqual re sub r \b \w\ TreeSpec \b TreeSpec str cxx_param annotation re sub r \b \w\ TreeSpec \b TreeSpec str python_param annotation msg= f C++ parameter cxx_param f does match Python parameter python_param f API ` name ` assertEqual cxx_param annotation python_param annotation msg= f C++ parameter cxx_param f does match Python parameter python_param f API ` name ` parametrize_pytree_module test_register_pytree_node pytree MyDict UserDict pass d = MyDict a= b= c= Custom types leaf nodes default values spec = pytree tree_flatten d assertEqual values d assertIs values d assertEqual d pytree tree_unflatten values spec assertTrue spec is_leaf Register MyDict pytree node pytree register_pytree_node MyDict lambda d list d values list d keys lambda values keys MyDict zip keys values values spec = pytree tree_flatten d assertEqual values assertEqual d pytree tree_unflatten values spec Do allow registering same type twice assertRaisesRegex ValueError already registered pytree register_pytree_node MyDict lambda d list d values list d keys lambda values keys MyDict zip keys values parametrize_pytree_module test_flatten_unflatten_leaf pytree run_test_with_leaf leaf values treespec = pytree tree_flatten leaf assertEqual values leaf assertEqual treespec pytree treespec_leaf unflattened = pytree tree_unflatten values treespec assertEqual unflattened leaf run_test_with_leaf run_test_with_leaf run_test_with_leaf None run_test_with_leaf bool run_test_with_leaf torch randn parametrize pytree gen_expected_fn subtest python_pytree lambda tup python_pytree TreeSpec tuple None python_pytree treespec_leaf _ tup name= python subtest cxx_pytree lambda tup cxx_pytree tree_structure len tup name= cxx test_flatten_unflatten_tuple pytree gen_expected_fn run_test tup expected_spec = gen_expected_fn tup values treespec = pytree tree_flatten tup assertIsInstance values list assertEqual values list tup assertEqual treespec expected_spec unflattened = pytree tree_unflatten values treespec assertEqual unflattened tup assertIsInstance unflattened tuple run_test run_test run_test run_test torch tensor parametrize pytree gen_expected_fn subtest python_pytree lambda lst python_pytree TreeSpec list None python_pytree treespec_leaf _ lst name= python subtest cxx_pytree lambda lst cxx_pytree tree_structure len lst name= cxx test_flatten_unflatten_list pytree gen_expected_fn run_test lst expected_spec = gen_expected_fn lst values treespec = pytree tree_flatten lst assertIsInstance values list assertEqual values lst assertEqual treespec expected_spec unflattened = pytree tree_unflatten values treespec assertEqual unflattened lst assertIsInstance unflattened list run_test run_test run_test torch tensor parametrize pytree gen_expected_fn subtest python_pytree lambda dct python_pytree TreeSpec dict list dct keys python_pytree treespec_leaf _ dct values name= python subtest cxx_pytree lambda dct cxx_pytree tree_structure dict fromkeys dct name= cxx test_flatten_unflatten_dict pytree gen_expected_fn run_test dct expected_spec = gen_expected_fn dct values treespec = pytree tree_flatten dct assertIsInstance values list assertEqual values list dct values assertEqual treespec expected_spec unflattened = pytree tree_unflatten values treespec assertEqual unflattened dct assertIsInstance unflattened dict run_test run_test run_test abcdefg torch randn run_test torch randn run_test b c torch randn parametrize pytree gen_expected_fn subtest python_pytree lambda odict python_pytree TreeSpec OrderedDict list odict keys python_pytree treespec_leaf _ odict values name= python subtest cxx_pytree lambda odict cxx_pytree tree_structure OrderedDict fromkeys odict name= cxx test_flatten_unflatten_ordereddict pytree gen_expected_fn run_test odict expected_spec = gen_expected_fn odict values treespec = pytree tree_flatten odict assertIsInstance values list assertEqual values list odict values assertEqual treespec expected_spec unflattened = pytree tree_unflatten values treespec assertEqual unflattened odict assertIsInstance unflattened OrderedDict od = OrderedDict run_test od od b = od = torch tensor run_test od parametrize pytree gen_expected_fn subtest python_pytree lambda ddct python_pytree TreeSpec defaultdict ddct default_factory list ddct keys python_pytree treespec_leaf _ ddct values name= python subtest cxx_pytree lambda ddct cxx_pytree tree_structure defaultdict ddct default_factory dict fromkeys ddct name= cxx test_flatten_unflatten_defaultdict pytree gen_expected_fn run_test ddct expected_spec = gen_expected_fn ddct values treespec = pytree tree_flatten ddct assertIsInstance values list assertEqual values list ddct values assertEqual treespec expected_spec unflattened = pytree tree_unflatten values treespec assertEqual unflattened ddct assertEqual unflattened default_factory ddct default_factory assertIsInstance unflattened defaultdict run_test defaultdict list run_test defaultdict int run_test defaultdict int abcdefg torch randn run_test defaultdict int torch randn run_test defaultdict int b c torch randn parametrize pytree gen_expected_fn subtest python_pytree lambda deq python_pytree TreeSpec deque deq maxlen python_pytree treespec_leaf _ deq name= python subtest cxx_pytree lambda deq cxx_pytree tree_structure deque deq maxlen=deq maxlen name= cxx test_flatten_unflatten_deque pytree gen_expected_fn run_test deq expected_spec = gen_expected_fn deq values treespec = pytree tree_flatten deq assertIsInstance values list assertEqual values list deq assertEqual treespec expected_spec unflattened = pytree tree_unflatten values treespec assertEqual unflattened deq assertEqual unflattened maxlen deq maxlen assertIsInstance unflattened deque run_test deque run_test deque run_test deque torch tensor maxlen= parametrize_pytree_module test_flatten_unflatten_namedtuple pytree Point = namedtuple Point x y run_test tup pytree python_pytree expected_spec = python_pytree TreeSpec namedtuple Point python_pytree treespec_leaf _ tup expected_spec = cxx_pytree tree_structure Point values treespec = pytree tree_flatten tup assertIsInstance values list assertEqual values list tup assertEqual treespec expected_spec unflattened = pytree tree_unflatten values treespec assertEqual unflattened tup assertIsInstance unflattened Point run_test Point run_test Point torch tensor parametrize op subtest torch max name= max subtest torch min name= min parametrize_pytree_module test_flatten_unflatten_return_types pytree op x = torch randn expected = op x dim= values spec = pytree tree_flatten expected Check values actually List Tensor ReturnType value values assertIsInstance value torch Tensor result = pytree tree_unflatten values spec assertEqual type result type expected assertEqual result expected parametrize_pytree_module test_flatten_unflatten_nested pytree run_test tree values treespec = pytree tree_flatten tree assertIsInstance values list assertEqual len values treespec num_leaves NB python basic data structures dict list tuple all have contents equality defined them so following works them unflattened = pytree tree_unflatten values treespec assertEqual unflattened tree cases = b c b c torch randn c torch randn case cases run_test case parametrize_pytree_module test_flatten_with_is_leaf pytree run_test tree one_level_leaves values treespec = pytree tree_flatten tree is_leaf=lambda x x tree assertIsInstance values list assertEqual len values treespec num_nodes - assertEqual len values treespec num_leaves assertEqual len values treespec num_children assertEqual values one_level_leaves assertEqual treespec pytree tree_structure pytree tree_unflatten treespec num_leaves treespec unflattened = pytree tree_unflatten values treespec assertEqual unflattened tree cases = b c c b c torch ones c torch zeros c torch ones torch zeros case cases run_test case parametrize_pytree_module test_tree_map pytree run_test tree f x x sm = sum map f pytree tree_leaves tree sm = sum pytree tree_leaves pytree tree_map f tree assertEqual sm sm invf x x assertEqual pytree tree_map invf pytree tree_map f tree tree cases = b c b c c case cases run_test case parametrize_pytree_module test_tree_map_multi_inputs pytree run_test tree f x y z x y z tree_x = tree tree_y = pytree tree_map lambda x x + tree tree_z = pytree tree_map lambda x x b tree assertEqual pytree tree_map f tree_x tree_y tree_z pytree tree_map lambda x f x x + x b tree cases = b c b c c case cases run_test case parametrize_pytree_module test_tree_map_only pytree assertEqual pytree tree_map_only int lambda x x + parametrize_pytree_module test_tree_map_only_predicate_fn pytree assertEqual pytree tree_map_only lambda x x == lambda x x + parametrize_pytree_module test_tree_all_any pytree assertTrue pytree tree_all lambda x x assertFalse pytree tree_all lambda x x assertTrue pytree tree_any lambda x x assertFalse pytree tree_any lambda x x assertTrue pytree tree_all_only int lambda x x assertFalse pytree tree_all_only int lambda x x assertTrue pytree tree_any_only int lambda x x assertFalse pytree tree_any_only int lambda x x parametrize_pytree_module test_broadcast_to_and_flatten pytree cases = Same flat structures b b Mismatched flat structures None None None None b None b c None b b c None Same nested structures Mismatched nested structures None None Broadcasting single value b Broadcast multiple things tree to_tree expected cases _ to_spec = pytree tree_flatten to_tree result = pytree _broadcast_to_and_flatten tree to_spec assertEqual result expected msg=str tree to_spec expected parametrize_pytree_module test_pytree_serialize_bad_input pytree assertRaises TypeError pytree treespec_dumps random_blurb parametrize_pytree_module test_is_namedtuple pytree DirectNamedTuple = namedtuple DirectNamedTuple x y DirectNamedTuple NamedTuple x int y int IndirectNamedTuple DirectNamedTuple pass IndirectNamedTuple DirectNamedTuple pass assertTrue pytree is_namedtuple DirectNamedTuple assertTrue pytree is_namedtuple DirectNamedTuple assertTrue pytree is_namedtuple IndirectNamedTuple assertTrue pytree is_namedtuple IndirectNamedTuple assertFalse pytree is_namedtuple time gmtime assertFalse pytree is_namedtuple assertFalse pytree is_namedtuple assertFalse pytree is_namedtuple assertFalse pytree is_namedtuple assertFalse pytree is_namedtuple assertTrue pytree is_namedtuple DirectNamedTuple assertTrue pytree is_namedtuple DirectNamedTuple assertTrue pytree is_namedtuple IndirectNamedTuple assertTrue pytree is_namedtuple IndirectNamedTuple assertFalse pytree is_namedtuple time struct_time assertFalse pytree is_namedtuple tuple assertFalse pytree is_namedtuple list assertTrue pytree is_namedtuple_class DirectNamedTuple assertTrue pytree is_namedtuple_class DirectNamedTuple assertTrue pytree is_namedtuple_class IndirectNamedTuple assertTrue pytree is_namedtuple_class IndirectNamedTuple assertFalse pytree is_namedtuple_class time struct_time assertFalse pytree is_namedtuple_class tuple assertFalse pytree is_namedtuple_class list parametrize_pytree_module test_is_structseq pytree FakeStructSeq tuple n_fields = n_sequence_fields = n_unnamed_fields = __slots__ = __match_args__ = x y __new__ cls sequence super __new__ cls sequence property x property y DirectNamedTuple = namedtuple DirectNamedTuple x y DirectNamedTuple NamedTuple x int y int assertFalse pytree is_structseq FakeStructSeq assertTrue pytree is_structseq time gmtime assertFalse pytree is_structseq DirectNamedTuple assertFalse pytree is_structseq DirectNamedTuple assertFalse pytree is_structseq assertFalse pytree is_structseq assertFalse pytree is_structseq assertFalse pytree is_structseq assertFalse pytree is_structseq assertFalse pytree is_structseq FakeStructSeq assertTrue pytree is_structseq time struct_time assertFalse pytree is_structseq DirectNamedTuple assertFalse pytree is_structseq DirectNamedTuple assertFalse pytree is_structseq tuple assertFalse pytree is_structseq list assertFalse pytree is_structseq_class FakeStructSeq assertTrue pytree is_structseq_class time struct_time assertFalse pytree is_structseq_class DirectNamedTuple assertFalse pytree is_structseq_class DirectNamedTuple assertFalse pytree is_structseq_class tuple assertFalse pytree is_structseq_class list torch return_types all PyStructSequence types cls vars torch return_types values isinstance cls type issubclass cls tuple assertTrue pytree is_structseq cls assertTrue pytree is_structseq_class cls assertFalse pytree is_namedtuple cls assertFalse pytree is_namedtuple_class cls inst = cls range cls n_sequence_fields assertTrue pytree is_structseq inst assertTrue pytree is_structseq type inst assertFalse pytree is_structseq_class inst assertTrue pytree is_structseq_class type inst assertFalse pytree is_namedtuple inst assertFalse pytree is_namedtuple_class inst assertFalse pytree is_structseq cls assertFalse pytree is_structseq_class cls assertFalse pytree is_namedtuple cls assertFalse pytree is_namedtuple_class cls parametrize_pytree_module test_enum_treespec_roundtrip pytree data = TestEnum A spec = pytree tree_structure data serialized = pytree treespec_dumps spec deserialized_spec = pytree treespec_loads serialized assertEqual spec deserialized_spec TestPythonPytree TestCase test_deprecated_register_pytree_node DummyType __init__ x y x = x y = y assertWarnsRegex FutureWarning torch utils _pytree _register_pytree_node python_pytree _register_pytree_node DummyType lambda dummy dummy x dummy y None lambda xs _ DummyType xs assertWarnsRegex UserWarning already registered python_pytree _register_pytree_node DummyType lambda dummy dummy x dummy y None lambda xs _ DummyType xs test_import_pytree_doesnt_import_optree importing torch utils _pytree shouldn t optree only importing torch utils _cxx_pytree should script = sys torch torch utils _pytree assert torch utils _pytree sys modules torch utils _cxx_pytree sys modules raise RuntimeError importing torch utils _pytree should torch utils _cxx_pytree optree sys modules raise RuntimeError importing torch utils _pytree should optree try subprocess check_output sys executable -c script stderr=subprocess STDOUT On Windows opening subprocess default CWD makes ` torch ` fail so just set CWD script s directory cwd=os path dirname os path realpath __file__ except subprocess CalledProcessError e fail msg= Subprocess exception while attempting run test + e output decode utf- test_treespec_equality assertEqual python_pytree treespec_leaf python_pytree treespec_leaf assertEqual python_pytree TreeSpec list None python_pytree TreeSpec list None assertEqual python_pytree TreeSpec list None python_pytree treespec_leaf python_pytree TreeSpec list None python_pytree treespec_leaf assertFalse python_pytree TreeSpec tuple None == python_pytree TreeSpec list None assertTrue python_pytree TreeSpec tuple None = python_pytree TreeSpec list None test_treespec_repr Check looks sane tree = spec = python_pytree tree_structure tree assertEqual repr spec TreeSpec tuple None \n TreeSpec list None \n \n TreeSpec list None parametrize spec python_pytree tree_structure python_pytree TreeSpec list None python_pytree tree_structure python_pytree TreeSpec tuple None python_pytree tree_structure python_pytree TreeSpec dict python_pytree tree_structure python_pytree TreeSpec list None python_pytree treespec_leaf python_pytree tree_structure python_pytree TreeSpec list None python_pytree treespec_leaf python_pytree treespec_leaf python_pytree tree_structure python_pytree TreeSpec tuple None python_pytree treespec_leaf python_pytree treespec_leaf python_pytree treespec_leaf python_pytree tree_structure b c python_pytree TreeSpec dict b c python_pytree treespec_leaf python_pytree treespec_leaf python_pytree treespec_leaf python_pytree tree_structure OrderedDict b c b c python_pytree TreeSpec OrderedDict b c python_pytree TreeSpec tuple None python_pytree treespec_leaf python_pytree treespec_leaf python_pytree treespec_leaf python_pytree TreeSpec dict b c python_pytree treespec_leaf python_pytree treespec_leaf python_pytree treespec_leaf python_pytree tree_structure python_pytree TreeSpec list None python_pytree TreeSpec tuple None python_pytree treespec_leaf python_pytree treespec_leaf python_pytree TreeSpec list None python_pytree treespec_leaf python_pytree treespec_leaf python_pytree tree_structure defaultdict list b c python_pytree TreeSpec defaultdict list b c python_pytree TreeSpec list None python_pytree treespec_leaf python_pytree treespec_leaf python_pytree TreeSpec list None python_pytree treespec_leaf python_pytree treespec_leaf python_pytree TreeSpec dict test_pytree_serialize spec Ensure spec valid assertEqual spec python_pytree tree_structure python_pytree tree_unflatten spec num_leaves spec serialized_spec = python_pytree treespec_dumps spec assertIsInstance serialized_spec str assertEqual spec python_pytree treespec_loads serialized_spec test_pytree_serialize_defaultdict_enum spec = python_pytree TreeSpec defaultdict list TestEnum A python_pytree TreeSpec list None python_pytree treespec_leaf serialized_spec = python_pytree treespec_dumps spec assertIsInstance serialized_spec str test_pytree_serialize_enum spec = python_pytree TreeSpec dict TestEnum A python_pytree treespec_leaf serialized_spec = python_pytree treespec_dumps spec assertIsInstance serialized_spec str test_pytree_serialize_namedtuple Point = namedtuple Point x y python_pytree _register_namedtuple Point serialized_type_name= test_pytree test_pytree_serialize_namedtuple Point spec = python_pytree tree_structure Point assertIs spec type namedtuple roundtrip_spec = python_pytree treespec_loads python_pytree treespec_dumps spec assertEqual spec roundtrip_spec Point NamedTuple x int y int python_pytree _register_namedtuple Point serialized_type_name= test_pytree test_pytree_serialize_namedtuple Point spec = python_pytree tree_structure Point assertIs spec type namedtuple roundtrip_spec = python_pytree treespec_loads python_pytree treespec_dumps spec assertEqual spec roundtrip_spec Point Point pass python_pytree _register_namedtuple Point serialized_type_name= test_pytree test_pytree_serialize_namedtuple Point spec = python_pytree tree_structure Point assertIs spec type namedtuple roundtrip_spec = python_pytree treespec_loads python_pytree treespec_dumps spec assertEqual spec roundtrip_spec test_pytree_serialize_namedtuple_bad DummyType = namedtuple DummyType x y spec = python_pytree tree_structure DummyType assertRaisesRegex NotImplementedError Please register using ` _register_namedtuple ` python_pytree treespec_dumps spec test_pytree_custom_type_serialize_bad DummyType __init__ x y x = x y = y python_pytree register_pytree_node DummyType lambda dummy dummy x dummy y None lambda xs _ DummyType xs spec = python_pytree tree_structure DummyType assertRaisesRegex NotImplementedError No registered serialization name python_pytree treespec_dumps spec test_pytree_custom_type_serialize DummyType __init__ x y x = x y = y python_pytree register_pytree_node DummyType lambda dummy dummy x dummy y None lambda xs _ DummyType xs serialized_type_name= test_pytree_custom_type_serialize DummyType to_dumpable_context=lambda context moo from_dumpable_context=lambda dumpable_context None spec = python_pytree tree_structure DummyType serialized_spec = python_pytree treespec_dumps spec assertIn moo serialized_spec roundtrip_spec = python_pytree treespec_loads serialized_spec assertEqual roundtrip_spec spec test_pytree_serialize_register_bad DummyType __init__ x y x = x y = y assertRaisesRegex ValueError Both to_dumpable_context from_dumpable_context python_pytree register_pytree_node DummyType lambda dummy dummy x dummy y None lambda xs _ DummyType xs serialized_type_name= test_pytree_serialize_register_bad DummyType to_dumpable_context=lambda context moo test_pytree_context_serialize_bad DummyType __init__ x y x = x y = y python_pytree register_pytree_node DummyType lambda dummy dummy x dummy y None lambda xs _ DummyType xs serialized_type_name= test_pytree_serialize_serialize_bad DummyType to_dumpable_context=lambda context DummyType from_dumpable_context=lambda dumpable_context None spec = python_pytree tree_structure DummyType assertRaisesRegex TypeError Object type type JSON serializable python_pytree treespec_dumps spec test_pytree_serialize_bad_protocol json Point = namedtuple Point x y spec = python_pytree tree_structure Point python_pytree _register_namedtuple Point serialized_type_name= test_pytree test_pytree_serialize_bad_protocol Point assertRaisesRegex ValueError Unknown protocol python_pytree treespec_dumps spec - serialized_spec = python_pytree treespec_dumps spec _ data = json loads serialized_spec bad_protocol_serialized_spec = json dumps - data assertRaisesRegex ValueError Unknown protocol python_pytree treespec_loads bad_protocol_serialized_spec test_saved_serialized python_pytree tree_structure OrderedDict complicated_spec = python_pytree TreeSpec OrderedDict python_pytree TreeSpec tuple None python_pytree treespec_leaf python_pytree treespec_leaf python_pytree treespec_leaf python_pytree TreeSpec dict python_pytree treespec_leaf python_pytree treespec_leaf python_pytree treespec_leaf Ensure spec valid assertEqual complicated_spec python_pytree tree_structure python_pytree tree_unflatten complicated_spec num_leaves complicated_spec serialized_spec = python_pytree treespec_dumps complicated_spec saved_spec = type collections OrderedDict context children_spec type builtins tuple context null children_spec type null context null children_spec type null context null children_spec type null context null children_spec type builtins dict context children_spec type null context null children_spec type null context null children_spec type null context null children_spec assertEqual serialized_spec saved_spec assertEqual complicated_spec python_pytree treespec_loads saved_spec test_tree_map_with_path tree = i i i range all_zeros = python_pytree tree_map_with_path lambda kp val val - kp key + kp idx tree assertEqual all_zeros dict fromkeys range test_dataclass dataclass Data torch Tensor b str = moo c Optional str = None d str = field init=False default= python_pytree register_dataclass Data old_data = Data torch tensor b c old_data d = d new_data = python_pytree tree_map lambda x x old_data assertEqual new_data torch tensor assertEqual new_data b b assertEqual new_data c c assertEqual new_data d python_pytree _deregister_pytree_node Data assertRaisesRegex ValueError Missing fields python_pytree register_dataclass Data field_names= b assertRaisesRegex ValueError Unexpected fields python_pytree register_dataclass Data field_names= b e assertRaisesRegex ValueError Unexpected fields python_pytree register_dataclass Data field_names= b c d python_pytree register_dataclass Data field_names= drop_field_names= b c old_data = Data torch tensor b c new_data = python_pytree tree_map lambda x x old_data assertEqual new_data torch tensor assertEqual new_data b moo assertEqual new_data c None python_pytree _deregister_pytree_node Data test_register_dataclass_class CustomClass __init__ x y x = x y = y assertRaisesRegex ValueError field_names must specified python_pytree register_dataclass CustomClass python_pytree register_dataclass CustomClass field_names= x y c = CustomClass torch tensor torch tensor mapped = python_pytree tree_map lambda x x + c assertEqual mapped x torch tensor assertEqual mapped y torch tensor test_constant Either use ` frozen=True ` ` unsafe_hash=True ` so we have non-default ` __hash__ ` dataclass unsafe_hash=True Config norm str python_pytree register_constant Config config = Config l elements spec = python_pytree tree_flatten config assertEqual elements assertEqual spec context value config test_constant_default_eq_error Config __init__ norm str norm = norm try python_pytree register_constant Config assertFalse True must raise error before except TypeError e msg = register_constant cls expects ` cls ` have non-default ` __eq__ ` implementation assertIn msg str e test_constant_default_hash_error Config __init__ norm str norm = norm __eq__ other norm == other norm try python_pytree register_constant Config assertFalse True must raise error before except TypeError e msg = register_constant cls expects ` cls ` have non-default ` __hash__ ` implementation assertIn msg str e test_tree_map_with_path_multiple_trees dataclass ACustomPytree x Any y Any z Any tree = ACustomPytree x= y= cin bar z= leaf tree = ACustomPytree x= y= cin bar z= leaf python_pytree register_pytree_node ACustomPytree flatten_fn=lambda f f x f y f z unflatten_fn=lambda xy z ACustomPytree xy xy z flatten_with_keys_fn=lambda f x f x y f y f z from_two_trees = python_pytree tree_map_with_path lambda kp b + b tree tree from_one_tree = python_pytree tree_map lambda + tree assertEqual from_two_trees from_one_tree test_tree_flatten_with_path_is_leaf leaf_dict = foo tree = hello leaf_dict key_leaves _ = python_pytree tree_flatten_with_path tree is_leaf=lambda x isinstance x dict assertTrue key_leaves - leaf_dict test_tree_flatten_with_path_roundtrip ANamedTuple NamedTuple x torch Tensor y int z str dataclass ACustomPytree x Any y Any z Any python_pytree register_pytree_node ACustomPytree flatten_fn=lambda f f x f y f z unflatten_fn=lambda xy z ACustomPytree xy xy z flatten_with_keys_fn=lambda f x f x y f y f z SOME_PYTREES = None hello foo ANamedTuple x=torch rand y= z= foo ACustomPytree x= y= cin bar z= leaf tree SOME_PYTREES key_leaves spec = python_pytree tree_flatten_with_path tree actual = python_pytree tree_unflatten leaf _ leaf key_leaves spec assertEqual actual tree test_tree_leaves_with_path ANamedTuple NamedTuple x torch Tensor y int z str dataclass ACustomPytree x Any y Any z Any python_pytree register_pytree_node ACustomPytree flatten_fn=lambda f f x f y f z unflatten_fn=lambda xy z ACustomPytree xy xy z flatten_with_keys_fn=lambda f x f x y f y f z SOME_PYTREES = None hello foo ANamedTuple x=torch rand y= z= foo ACustomPytree x= y= cin bar z= leaf tree SOME_PYTREES flat_out _ = python_pytree tree_flatten_with_path tree leaves_out = python_pytree tree_leaves_with_path tree assertEqual flat_out leaves_out test_key_str ANamedTuple NamedTuple x str y int tree = hello foo bar ANamedTuple x= baz y= flat _ = python_pytree tree_flatten_with_path tree paths = f python_pytree keystr kp val kp val flat assertEqual paths hello foo bar x baz bar y test_flatten_flatten_with_key_consistency Check flatten flatten_with_key produces consistent leaves context reg = python_pytree SUPPORTED_NODES EXAMPLE_TREE = list tuple dict foo bar namedtuple namedtuple ANamedTuple x y OrderedDict OrderedDict foo bar defaultdict defaultdict int foo bar deque deque torch Size torch Size immutable_dict immutable_dict foo bar immutable_list immutable_list typ reg example = EXAMPLE_TREE get typ example None continue flat_with_path spec = python_pytree tree_flatten_with_path example flat spec = python_pytree tree_flatten example assertEqual flat x x flat_with_path assertEqual spec spec test_key_access ANamedTuple NamedTuple x str y int tree = hello foo bar ANamedTuple x= baz y= flat _ = python_pytree tree_flatten_with_path tree kp val flat assertEqual python_pytree key_get tree kp val TestCxxPytree TestCase setUp IS_FBCODE raise unittest SkipTest C++ pytree tests supported fbcode test_treespec_equality assertEqual cxx_pytree treespec_leaf cxx_pytree treespec_leaf test_treespec_repr Check looks sane tree = spec = cxx_pytree tree_structure tree assertEqual repr spec PyTreeSpec NoneIsLeaf namespace= torch parametrize spec cxx_pytree tree_structure cxx_pytree tree_structure cxx_pytree tree_structure cxx_pytree tree_structure cxx_pytree tree_structure cxx_pytree tree_structure cxx_pytree tree_structure b c cxx_pytree tree_structure OrderedDict b c b c cxx_pytree tree_structure cxx_pytree tree_structure defaultdict list b c test_pytree_serialize spec assertEqual spec cxx_pytree tree_structure cxx_pytree tree_unflatten spec num_leaves spec serialized_spec = cxx_pytree treespec_dumps spec assertIsInstance serialized_spec str assertEqual spec cxx_pytree treespec_loads serialized_spec test_pytree_serialize_namedtuple python_pytree _register_namedtuple GlobalPoint serialized_type_name= test_pytree test_pytree_serialize_namedtuple GlobalPoint spec = cxx_pytree tree_structure GlobalPoint roundtrip_spec = cxx_pytree treespec_loads cxx_pytree treespec_dumps spec assertEqual roundtrip_spec type _fields spec type _fields LocalPoint = namedtuple LocalPoint x y python_pytree _register_namedtuple LocalPoint serialized_type_name= test_pytree test_pytree_serialize_namedtuple LocalPoint spec = cxx_pytree tree_structure LocalPoint roundtrip_spec = cxx_pytree treespec_loads cxx_pytree treespec_dumps spec assertEqual roundtrip_spec type _fields spec type _fields test_pytree_custom_type_serialize spec = cxx_pytree tree_structure GlobalDummyType serialized_spec = cxx_pytree treespec_dumps spec roundtrip_spec = cxx_pytree treespec_loads serialized_spec assertEqual roundtrip_spec spec LocalDummyType __init__ x y x = x y = y cxx_pytree register_pytree_node LocalDummyType lambda dummy dummy x dummy y None lambda xs _ LocalDummyType xs serialized_type_name= LocalDummyType spec = cxx_pytree tree_structure LocalDummyType serialized_spec = cxx_pytree treespec_dumps spec roundtrip_spec = cxx_pytree treespec_loads serialized_spec assertEqual roundtrip_spec spec instantiate_parametrized_tests TestGenericPytree instantiate_parametrized_tests TestPythonPytree instantiate_parametrized_tests TestCxxPytree __name__ == __main__ run_tests
torch torch fx fx functorch make_fx torch _functorch compile_utils fx_graph_cse torch profiler profile ProfilerActivity profile_it f inp _ range f inp itr = profile activities= ProfilerActivity CUDA record_shapes=True prof _ range itr f inp timing = prof key_averages cuda_time_total = e timing cuda_time_total = cuda_time_total + e cuda_time_total cuda_time_total itr profile_function name f inp fx_g = make_fx f inp new_g = fx_graph_cse fx_g graph new_g = fx GraphModule fx_g new_g do benchmark against scripted version because script already does some CSE script_f = torch jit script fx_g script_g = torch jit script new_g avg_cuda_time_f = profile_it script_f inp avg_cuda_time_g = profile_it script_g inp avg_cuda_time_f = profile_it fx_g inp avg_cuda_time_g = profile_it new_g inp num_node_decrease = len fx_g graph nodes - len new_g graph nodes print f name avg_cuda_time_f avg_cuda_time_g num_node_decrease len fx_g graph nodes g_gpu = torch Generator device= cuda g_gpu manual_seed inp = torch randn device= cuda generator=g_gpu f x x cos cos profile_function f f inp fsum x = x sum b = x sum c = x sum d = x sum + b + c + d profile_function fsum fsum inp fconcat x = torch cat x x b = torch cat x x + b profile_function fconcat fconcat inp fsum x = x sum _ range = + x sum profile_function fsum fsum inp fsummulti x = _ range = + x sum = x sum profile_function fsummulti fsummulti inp fsummulti x = _ range = + x sum = x sum profile_function fsummulti fsummulti inp fcos x = _ range = + x cos profile_function fcos fcos inp fcos x = _ range = + x cos profile_function fcos fcos inp
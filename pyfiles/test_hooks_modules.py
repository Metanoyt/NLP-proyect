Owner s oncall jit typing List Tuple torch SubmoduleNoForwardInputs torch nn Module __init__ name super __init__ name = name forward assert name == inner_mod_name ModuleNoForwardInputs torch nn Module __init__ name str submodule_name str super __init__ name = name submodule = SubmoduleNoForwardInputs submodule_name forward submodule SubmoduleForwardSingleInput torch nn Module __init__ name super __init__ name = name foo input str input forward input str input = input + _inner_mod input = foo input input ModuleForwardSingleInput torch nn Module __init__ name str submodule_name str super __init__ name = name submodule = SubmoduleForwardSingleInput submodule_name forward input str input = input + _outermod submodule input ModuleDirectforwardSubmodCall torch nn Module __init__ name str submodule_name str super __init__ name = name submodule = SubmoduleForwardSingleInput submodule_name forward input str input = input + _outermod submodule forward input SuboduleForwardMultipleInputs torch nn Module __init__ name super __init__ name = name forward input List str input str input append name output = input + _ input output ModuleForwardMultipleInputs torch nn Module __init__ name str submodule_name str super __init__ name = name submodule = SuboduleForwardMultipleInputs submodule_name forward input List str input str input append name submodule input input SubmoduleForwardTupleInput torch nn Module __init__ name super __init__ name = name forward input Tuple int input_access = input noqa F ModuleForwardTupleInput torch nn Module __init__ name str submodule_name str super __init__ name = name submodule = SubmoduleForwardTupleInput submodule_name forward input Tuple int input_access = input noqa F submodule Modules JIT forward hook pre-hooks python cpp tests create_module_no_forward_input Use test module level hooks no forward input m = ModuleNoForwardInputs outer_mod_name inner_mod_name pre_hook input Tuple - None assert name == outer_mod_name forward_hook input Tuple output None assert name == outer_mod_name m register_forward_pre_hook pre_hook m register_forward_hook forward_hook m create_submodule_no_forward_input Use test submodule level hooks no forward input m = ModuleNoForwardInputs outer_mod_name inner_mod_name pre_hook input Tuple - None assert name == inner_mod_name forward_hook input Tuple output None assert name == inner_mod_name m submodule register_forward_pre_hook pre_hook m submodule register_forward_hook forward_hook m create_module_forward_multiple_inputs Use test module level hooks forward having multiple inputs returns m = ModuleForwardMultipleInputs outer_mod_name inner_mod_name pre_hook input Tuple List str str - Tuple List str str assert name == outer_mod_name assert input == pre_hook_override_name pre_hook_override forward_hook input Tuple List str str output Tuple List str str assert name == outer_mod_name assert input == pre_hook_override_name output = output + fh output output m register_forward_pre_hook pre_hook m register_forward_hook forward_hook m create_module_multiple_hooks_multiple_inputs Use test module level hooks multiple inputs execute correct order pass correct information between each other m = ModuleForwardMultipleInputs outer_mod_name inner_mod_name pre_hook input Tuple List str str - Tuple List str str assert name == outer_mod_name assert input == pre_hook_override_name pre_hook_override pre_hook input Tuple List str str - Tuple List str str assert name == outer_mod_name assert input == pre_hook_override_name pre_hook_override_name pre_hook_override forward_hook input Tuple List str str output Tuple List str str assert name == outer_mod_name assert input == pre_hook_override_name output = output + fh output output forward_hook input Tuple List str str output Tuple List str str assert name == outer_mod_name assert input == pre_hook_override_name assert output == pre_hook_override_fh output = output + _fh output output m register_forward_pre_hook pre_hook m register_forward_pre_hook pre_hook m register_forward_hook forward_hook m register_forward_hook forward_hook m create_module_forward_single_input Use test module level hooks forward single input m = ModuleForwardSingleInput outer_mod_name inner_mod_name pre_hook input Tuple str - Tuple str assert name == outer_mod_name assert input == pre_hook_override_name forward_hook input Tuple str output str assert name == outer_mod_name assert input == pre_hook_override_name output = output + _fh output m register_forward_pre_hook pre_hook m register_forward_hook forward_hook m create_module_same_hook_repeated Use test module can run same hook multiple times m = ModuleForwardSingleInput outer_mod_name inner_mod_name pre_hook input Tuple str - Tuple str assert name == outer_mod_name input_change = input + _ph input_change forward_hook input Tuple str output str assert name == outer_mod_name assert input == a_ph_ph output = output + _fh output m register_forward_pre_hook pre_hook m register_forward_pre_hook pre_hook m register_forward_hook forward_hook m register_forward_hook forward_hook m create_module_hook_return_nothing Use test module level hooks nothing m = ModuleForwardSingleInput outer_mod_name inner_mod_name pre_hook input Tuple str - None assert name == outer_mod_name assert input == forward_hook input Tuple str output str assert name == outer_mod_name assert input == m register_forward_pre_hook pre_hook m register_forward_hook forward_hook m create_module_multiple_hooks_single_input Use test modules can run multiple hooks single input m = ModuleForwardSingleInput outer_mod_name inner_mod_name pre_hook input Tuple str - Tuple str assert name == outer_mod_name assert input == pre_hook_override_name pre_hook input Tuple str - Tuple str assert name == outer_mod_name assert input == pre_hook_override_name pre_hook_override_name forward_hook input Tuple str output str assert name == outer_mod_name assert input == pre_hook_override_name assert output == pre_hook_override_name _outermod_inner_mod output = output + _fh output output forward_hook input Tuple str output Tuple str str assert name == outer_mod_name assert input == pre_hook_override_name assert output == pre_hook_override_name _outermod_inner_mod_fh output = output + _fh output m register_forward_pre_hook pre_hook m register_forward_pre_hook pre_hook m register_forward_hook forward_hook m register_forward_hook forward_hook m create_submodule_forward_multiple_inputs Use test submodules can run hooks have multiple forward inputs m = ModuleForwardMultipleInputs outer_mod_name inner_mod_name pre_hook input Tuple List str str - Tuple List str str assert name == inner_mod_name assert input == outer_mod_name pre_hook_override_name pre_hook_override forward_hook input Tuple List str str output Tuple List str str assert name == inner_mod_name assert input == pre_hook_override_name output = output + fh output output m submodule register_forward_pre_hook pre_hook m submodule register_forward_hook forward_hook m create_submodule_multiple_hooks_multiple_inputs Use test submodules can run multiple hooks multiple forward inputs m = ModuleForwardMultipleInputs outer_mod_name inner_mod_name pre_hook input Tuple List str str - Tuple List str str assert name == inner_mod_name assert input == no_pre_hook pre_hook_override_name pre_hook_override pre_hook input Tuple List str str - Tuple List str str assert name == inner_mod_name assert input == pre_hook_override pre_hook_override_name pre_hook_override forward_hook input Tuple List str str output Tuple List str str assert name == inner_mod_name assert input == pre_hook_override assert output == pre_hook_override _ output = output + fh output output output forward_hook input Tuple List str str output Tuple List str str str assert name == inner_mod_name assert input == pre_hook_override assert output == pre_hook_override _fh output = output + _fh output output m submodule register_forward_pre_hook pre_hook m submodule register_forward_pre_hook pre_hook m submodule register_forward_hook forward_hook m submodule register_forward_hook forward_hook m create_submodule_forward_single_input Use test submodules can run hooks single argument passed forward m = ModuleForwardSingleInput outer_mod_name inner_mod_name pre_hook input Tuple str - Tuple str assert name == inner_mod_name assert input == a_outermod pre_hook_override_name forward_hook input Tuple str output str assert name == inner_mod_name assert input == pre_hook_override_name output m submodule register_forward_pre_hook pre_hook m submodule register_forward_hook forward_hook m create_submodule_to_call_directly_with_hooks Use test submodules have their hooks invoked when called directly m = ModuleForwardSingleInput outer_mod_name inner_mod_name pre_hook input Tuple str - Tuple str assert name == inner_mod_name pre_hook_override_name forward_hook input Tuple str output str assert name == inner_mod_name assert input == pre_hook_override_name output + _fh m submodule register_forward_pre_hook pre_hook m submodule register_forward_hook forward_hook m create_submodule_same_hook_repeated Use test submodules can run same hooks multiple times m = ModuleForwardSingleInput outer_mod_name inner_mod_name pre_hook input Tuple str - Tuple str assert name == inner_mod_name changed = input + _ph changed forward_hook input Tuple str output str assert name == inner_mod_name assert input == a_outermod_ph_ph output + _fh m submodule register_forward_pre_hook pre_hook m submodule register_forward_pre_hook pre_hook m submodule register_forward_hook forward_hook m submodule register_forward_hook forward_hook m create_submodule_hook_return_nothing Use test submodules can run hooks nothing m = ModuleForwardSingleInput outer_mod_name inner_mod_name pre_hook input Tuple str - None assert name == inner_mod_name assert input == a_outermod forward_hook input Tuple str output str assert name == inner_mod_name assert input == a_outermod m submodule register_forward_pre_hook pre_hook m submodule register_forward_hook forward_hook m create_submodule_multiple_hooks_single_input Use test submodules can run multiple hooks have single input m = ModuleForwardSingleInput outer_mod_name inner_mod_name pre_hook input Tuple str - Tuple str assert name == inner_mod_name assert input == a_outermod pre_hook_override_name pre_hook input Tuple str - Tuple str assert name == inner_mod_name assert input == pre_hook_override_name pre_hook_override_name forward_hook input Tuple str output str assert name == inner_mod_name assert input == pre_hook_override_name assert output == pre_hook_override_name _inner_mod output + _fwh forward_hook input Tuple str output str assert name == inner_mod_name assert input == pre_hook_override_name assert output == pre_hook_override_name _inner_mod_fwh output m submodule register_forward_pre_hook pre_hook m submodule register_forward_pre_hook pre_hook m submodule register_forward_hook forward_hook m submodule register_forward_hook forward_hook m create_forward_tuple_input Use test case where forward passed single tuple input This different because eager always wraps pre-hook arguments tuple when returned pre-hook result isn t tuple allow result passed another pre-hook needed The eager behavior doesn t wrap single tuple input pre-hook tuple should To get consistent behavior between single tuple inputs rest possible forward inputs pre-hooks need wrap single tuple inputs returns another tuple This enforced schema checker m = ModuleForwardTupleInput outer_mod_name inner_mod_name pre_hook_outermod input Tuple Tuple int - Tuple Tuple int doesn t work eager inner tuple lost pre_hook_innermod input Tuple Tuple int - Tuple Tuple int doesn t work eager inner tuple lost forward_hook_outermod input Tuple Tuple int output int forward_hook_innermod input Tuple Tuple int output Tuple int m register_forward_pre_hook pre_hook_outermod m submodule register_forward_pre_hook pre_hook_innermod m register_forward_hook forward_hook_outermod m submodule register_forward_hook forward_hook_innermod m create_submodule_forward_single_input_return_not_tupled Use check submodules can modified inputs aren t wrapped tuple match eager behavior m = ModuleForwardSingleInput outer_mod_name inner_mod_name pre_hook input Tuple str - str assert name == inner_mod_name assert input == a_outermod wrapped tuple other test cases pre_hook_override_name forward_hook input Tuple str output str assert name == inner_mod_name assert input == pre_hook_override_name output = output + _fh output m submodule register_forward_pre_hook pre_hook m submodule register_forward_hook forward_hook m __name__ == __main__ raise RuntimeError This file collection utils should imported executed directly
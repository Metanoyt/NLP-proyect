mypy allow-untyped-defs collections abc Callable typing Optional Union torch base_structured_sparsifier BaseStructuredSparsifier __all__ = FPGMPruner FPGMPruner BaseStructuredSparsifier r Filter Pruning via Geometric Median FPGM Structured Pruner This sparsifier prune filter row tensor according distances among filters according ` Filter Pruning via Geometric Median Deep Convolutional Neural Networks Acceleration https arxiv org abs ` _ This sparsifier controlled three variables ` sparsity_level ` defines number filters rows zeroed-out ` dist ` defines distance measurement type Default L distance Available options custom callable distance function Note Inputs should D convolutional tensor shape N C H W - N output channels size - C input channels size - H height kernel - W width kernel __init__ sparsity_level float = dist Optional Union Callable int = None defaults = sparsity_level sparsity_level dist None dist = callable dist dist_fn = dist dist == dist_fn = lambda x torch cdist x x p= dist == dist_fn = lambda x torch cdist x x p= raise NotImplementedError Distance function yet implemented super __init__ defaults=defaults _compute_distance t r Compute distance across all entries tensor ` t ` along all dimension except one identified dim Args t torch Tensor tensor representing parameter prune Returns distance torch Tensor distance computed across filtters dim = prune filter row size = t size dim slc = slice None t dim flatten tensor along dimension t_flatten = t tuple slc dim + slice i i + + slc dim + reshape - i range size t_flatten = torch stack t_flatten distance measurement dist_matrix = dist_fn t_flatten more similar other filter indicates large sum row pyrefly ignore bad-argument-type distance = torch sum torch abs dist_matrix distance update_mask type ignore override module tensor_name sparsity_level kwargs tensor_weight = getattr module tensor_name mask = getattr module parametrizations tensor_name mask sparsity_level = mask data = torch ones_like mask bool sparsity_level = mask data = torch zeros_like mask bool distance = _compute_distance tensor_weight tensor_size = tensor_weight shape prune filter row nparams_toprune = round sparsity_level tensor_size nparams_toprune = min max nparams_toprune tensor_size clamp tensor_size topk = torch topk distance k=nparams_toprune largest=False mask topk indices = False
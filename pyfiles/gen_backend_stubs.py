__future__ annotations argparse os re collections Counter defaultdict namedtuple pathlib Path typing TYPE_CHECKING yaml torchgen api dispatcher dispatcher torchgen dest dest torchgen api types DispatcherSignature torchgen code_template CodeTemplate torchgen context native_function_manager torchgen gen get_grouped_native_functions parse_native_yaml torchgen model BackendIndex BackendMetadata DispatchKey NativeFunction NativeFunctionsGroup OperatorName torchgen selective_build selector SelectiveBuilder torchgen utils concatMap context FileManager NamespaceHelper Target torchgen yaml_utils YamlLoader TYPE_CHECKING collections abc Sequence Parses external backend s yaml adds new BackendIndex backend s dispatch key Returns Tuple backend_key autograd_key cpp_namespace updated BackendIndex mapping ParsedExternalYaml = namedtuple ParsedExternalYaml backend_key autograd_key class_name cpp_namespace backend_indices parse_backend_yaml backend_yaml_path str grouped_native_functions Sequence NativeFunction &#124; NativeFunctionsGroup backend_indices dict DispatchKey BackendIndex - ParsedExternalYaml native_functions_map dict OperatorName NativeFunction = f func name f f concatMap lambda f f isinstance f NativeFunction list f functions grouped_native_functions open backend_yaml_path f yaml_values = yaml load f Loader=YamlLoader assert isinstance yaml_values dict valid_keys = backend class_name cpp_namespace extra_headers supported autograd full_codegen non_native ir_gen symint backend = yaml_values pop backend None assert backend None You must provide value backend class_name = yaml_values pop class_name None cpp_namespace = yaml_values pop cpp_namespace None assert cpp_namespace None You must provide value cpp_namespace Mostly just defaulting false stick LazyTensor convention use_out_as_primary = yaml_values pop use_out_as_primary False assert isinstance use_out_as_primary bool f You must provide either True False use_out_as_primary Provided use_out_as_primary use_device_guard = yaml_values pop device_guard False assert isinstance use_device_guard bool f You must provide either True False device_guard Provided use_device_guard supported = yaml_values pop supported supported None supported = Allow empty list supported ops assert isinstance supported list f expected supported list got supported type type supported symint = yaml_values pop symint symint None symint = Allow empty list symint ops assert isinstance symint list f expected symint list got supported type type supported symint_set = set symint supported_autograd = yaml_values pop autograd assert isinstance supported_autograd list f expected autograd list got supported_autograd full_codegen ignored parse_backend_yaml re-parsed gen_lazy_tensor py full_codegen = yaml_values pop full_codegen supported extend full_codegen non_native ignored parse_backend_yaml re-parsed gen_lazy_tensor py yaml_values pop non_native ir_gen ignored parse_backend_yaml re-parsed gen_lazy_tensor py yaml_values pop ir_gen assert len yaml_values keys == f backend_yaml_path contains unexpected keys join yaml_values keys f Only following keys supported join valid_keys create_backend_index backend_ops list str symint_ops set str dispatch_key DispatchKey use_out_as_primary bool use_device_guard bool - BackendIndex metadata dict OperatorName BackendMetadata = op backend_ops op_name = OperatorName parse op assert op_name native_functions_map f Found invalid operator name op_name See Note External Backends Follow Dispatcher API kernel_name = dispatcher name native_functions_map op_name func op symint_ops kernel_name += _symint TODO allow structured external backends later m = BackendMetadata kernel=kernel_name structured=False cpp_namespace=cpp_namespace metadata op_name = m BackendIndex dispatch_key=dispatch_key use_out_as_primary=use_out_as_primary external=True device_guard=use_device_guard index=metadata backend_key DispatchKey &#124; None = None len supported context lambda f The provided value backend must valid DispatchKey got backend backend_key = DispatchKey parse backend backend_idx = create_backend_index supported symint_set backend_key use_out_as_primary=use_out_as_primary use_device_guard=use_device_guard assert backend_key backend_indices backend_indices backend_key = backend_idx autograd_key DispatchKey &#124; None = None len supported_autograd context lambda f The autograd key specified which indicates you would like override \ behavior autograd some operators your backend However Autograd backend valid DispatchKey autograd_key = DispatchKey parse f Autograd backend autograd_idx = create_backend_index supported_autograd symint_set autograd_key use_out_as_primary=use_out_as_primary use_device_guard=use_device_guard assert autograd_key backend_indices backend_indices autograd_key = autograd_idx g grouped_native_functions isinstance g NativeFunction forward_kernels = backend_key None m m backend_indices backend_key get_kernel g m None backward_kernels = autograd_key None m m backend_indices autograd_key get_kernel g m None forward_kernels = backend_key None m m backend_indices backend_key get_kernel f f g functions m None backward_kernels = autograd_key None m m backend_indices autograd_key get_kernel f f g functions m None forward_kernels = f f forward_kernels f None backward_kernels = f f backward_kernels f None assert len forward_kernels == len backward_kernels == f Currently all variants op must either registered backend key backend\ s \ autograd key They cannot mix matched If something you need feel free create issue \ forward_kernels kernel listed under supported backward_kernels kernel listed under autograd ParsedExternalYaml backend_key autograd_key class_name cpp_namespace backend_indices error_on_missing_kernels native_functions Sequence NativeFunction backend_indices dict DispatchKey BackendIndex backend_key DispatchKey autograd_key DispatchKey &#124; None class_name str kernel_defn_file_path str full_codegen list OperatorName &#124; None = None - None try open kernel_defn_file_path f backend_defns = f read except OSError e raise AssertionError f Unable read specified impl_path file kernel_defn_file_path e full_codegen None full_codegen = indices = backend_indices backend_key index + autograd_key None backend_indices autograd_key index Quick mapping each OperatorName used external backend its backend kernel name expected_backend_op_names dict OperatorName str = dict list concatMap lambda index op_name metadata kernel op_name metadata index items indices expected_backend_native_funcs list NativeFunction = f f native_functions f func name expected_backend_op_names keys f func name full_codegen expected_backend_kernel_name_counts dict str list NativeFunction = defaultdict list native_f expected_backend_native_funcs expected_backend_kernel_name_counts expected_backend_op_names native_f func name append native_f This just looks lines containing foo assumes kernel foo has been implemented It might cause false negatives we won t catch all cases s ok - we catch missing kernel here then we get nicer error message If we miss you get linker error kernel_defn_regex = rf class_name \s \w\d \ actual_backend_kernel_name_counts = Counter A bit unwieldy could probably moved into regex we don t want include kernel names come function calls like torch_xla XLANativeFunctions empty_strided_symint Easy check ignore any lines colons before name y x y re findall kernel_defn_regex backend_defns x endswith missing_kernels_err_msg = expected_name funcs expected_backend_kernel_name_counts items expected_overload_count = len funcs actual_overload_count = actual_backend_kernel_name_counts expected_name expected_overload_count = actual_overload_count create_decl f NativeFunction - str native_function_manager f DispatcherSignature from_schema f func decl expected_schemas_str = \n join create_decl f f funcs missing_kernels_err_msg += f class_name missing kernel definition expected_name We found actual_overload_count kernel s name expected expected_overload_count kernel s The expected function schemas missing operator expected_schemas_str assert missing_kernels_err_msg == missing_kernels_err_msg main - None parser = argparse ArgumentParser description= Generate backend stub files parser add_argument -s -- source-yaml -- source_yaml help= path source yaml file containing operator external definitions parser add_argument -o -- output-dir -- output_dir help= output directory parser add_argument -- dry-run -- dry_run type=bool default=False help= output directory parser add_argument -- impl-path -- impl_path type=str default=None help= path source C++ file containing kernel definitions options = parser parse_args run options source_yaml options output_dir options dry_run options impl_path gen_dispatchkey_nativefunc_headers fm FileManager class_name str cpp_namespace str backend_indices dict DispatchKey BackendIndex grouped_native_functions Sequence NativeFunction &#124; NativeFunctionsGroup backend_dispatch_key DispatchKey autograd_dispatch_key DispatchKey &#124; None backend_name str = - None assert class_name None generated_comment = Autogenerated file gen_backend_stubs py Do edit directly Convert set first remove duplicate kernel names Backends allowed repeat kernel names only generate declaration once Sort deterministic output backend_declarations = sorted set concatMap lambda f dest compute_native_function_declaration f backend_indices backend_dispatch_key grouped_native_functions autograd_declarations = sorted set concatMap lambda f autograd_dispatch_key None dest compute_native_function_declaration f backend_indices autograd_dispatch_key grouped_native_functions ns_helper = NamespaceHelper cpp_namespace fm write_with_template f backend_dispatch_key NativeFunctions h DispatchKeyNativeFunctions h lambda generated_comment generated_comment namespace_prologue ns_helper prologue class_name class_name namespace_epilogue ns_helper epilogue dispatch_declarations backend_declarations + autograd_declarations BackendName backend_name DispatchKey backend_dispatch_key gen_dispatcher_registrations fm FileManager output_dir str class_name str backend_indices dict DispatchKey BackendIndex grouped_native_functions Sequence NativeFunction &#124; NativeFunctionsGroup backend_dispatch_key DispatchKey dispatch_key DispatchKey selector SelectiveBuilder build_in_tree true lazy TS backend affects include paths used external backends build_in_tree bool = False per_operator_headers bool = False backend_name str = eager_registration bool = True - None headers = f output_dir backend_dispatch_key NativeFunctions h build_in_tree external_backend_headers_str = \n join f #include h h headers external_backend_headers_str = \n join f #include h h headers assert class_name None backend_index = backend_indices dispatch_key dispatch_registrations_body = list concatMap dest RegisterDispatchKey backend_index Target REGISTRATION selector rocm=False symint=True class_method_name=f class_name skip_dispatcher_op_registration=False grouped_native_functions newline = \n ns_helper = NamespaceHelper namespace_str= deferred_dispatch_registrations = static_init_dispatch_registrations = eager_registration static_template = CodeTemplate \ TORCH_LIBRARY_IMPL aten $ dispatch_key m $ dispatch_registrations_body static_init_dispatch_registrations = static_template substitute dispatch_key=dispatch_key dispatch_registrations_body=dispatch_registrations_body deferred_template = CodeTemplate \ TORCH_API void Register$ backend_name $ dispatch_key NativeFunctions TORCH_API void Register$ backend_name $ dispatch_key NativeFunctions static auto m = MAKE_TORCH_LIBRARY_IMPL aten $ dispatch_key $ dispatch_registrations_body deferred_dispatch_registrations = deferred_template substitute backend_name=backend_name dispatch_key=dispatch_key dispatch_registrations_body=dispatch_registrations_body fm write_with_template f Register dispatch_key cpp RegisterDispatchKey cpp lambda extra_cuda_headers external_backend_headers external_backend_headers_str ops_headers #include ATen Functions h per_operator_headers DispatchKey dispatch_key dispatch_namespace dispatch_key lower dispatch_headers dest gen_registration_headers backend_index per_operator_headers=per_operator_headers rocm=False dispatch_helpers dest gen_registration_helpers backend_index dispatch_definitions fm substitute_with_template RegisterDispatchDefinitions ini lambda ns_prologue ns_helper prologue ns_epilogue ns_helper epilogue static_init_dispatch_registrations static_init_dispatch_registrations deferred_dispatch_registrations deferred_dispatch_registrations dispatch_namespace dispatch_key lower dispatch_namespaced_definitions dispatch_anonymous_definitions list concatMap dest RegisterDispatchKey backend_index Target ANONYMOUS_DEFINITION selector rocm=False symint=True class_method_name=f class_name skip_dispatcher_op_registration=False grouped_native_functions split newline run source_yaml str output_dir str dry_run bool impl_path str &#124; None = None - None Assumes file lives PYTORCH_ROOT torchgen gen_backend_stubs py pytorch_root = Path __file__ absolute parent parent template_dir = os path join pytorch_root aten src ATen templates make_file_manager install_dir str - FileManager FileManager install_dir=install_dir template_dir=template_dir dry_run=dry_run fm = make_file_manager output_dir native_yaml_path = os path join pytorch_root aten src ATen native native_functions yaml tags_yaml_path = os path join pytorch_root aten src ATen native tags yaml parsed_yaml = parse_native_yaml native_yaml_path tags_yaml_path native_functions backend_indices = parsed_yaml native_functions parsed_yaml backend_indices grouped_native_functions = get_grouped_native_functions native_functions parsed_backend_yaml = parse_backend_yaml source_yaml grouped_native_functions backend_indices backend_key = parsed_backend_yaml backend_key autograd_key = parsed_backend_yaml autograd_key cpp_namespace = parsed_backend_yaml cpp_namespace class_name = parsed_backend_yaml class_name backend_indices = parsed_backend_yaml backend_indices selector = SelectiveBuilder get_nop_selector backend_key None This could useful backend wants quickly set up noop yaml file doesn t have any kernels ready yet class_name None class_name optional argument backend yaml file specified allows external backend override name all generated kernel definitions live under specified its value given native_function_class_name class_name = backend_indices backend_key native_function_class_name assert class_name None impl_path None error_on_missing_kernels native_functions backend_indices backend_key autograd_key class_name impl_path gen_dispatchkey_nativefunc_headers fm class_name cpp_namespace backend_indices grouped_native_functions backend_key autograd_key dispatch_key backend_key autograd_key None backend_key autograd_key gen_dispatcher_registrations fm output_dir class_name backend_indices grouped_native_functions backend_key dispatch_key selector __name__ == __main__ main
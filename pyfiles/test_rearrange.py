Owner s module functorch Adapted https github com arogozhnikov einops blob ac c f c e f c f df tests test_ops py MIT License Copyright c Alex Rogozhnikov Permission hereby granted free charge any person obtaining copy software associated documentation files Software deal Software without restriction including without limitation rights use copy modify merge publish distribute sublicense sell copies Software permit persons whom Software furnished do so subject following conditions The above copyright notice permission notice shall included all copies substantial portions Software THE SOFTWARE IS PROVIDED AS IS WITHOUT WARRANTY OF ANY KIND EXPRESS OR IMPLIED INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM DAMAGES OR OTHER LIABILITY WHETHER IN AN ACTION OF CONTRACT TORT OR OTHERWISE ARISING FROM OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE numpy np torch functorch einops rearrange torch testing _internal common_utils run_tests TestCase identity_patterns list str = - b c d e- b c d e b c d e - b c d e b c d e - b c d e b c d e - b c d e e- e - c d e - c d e equivalent_rearrange_patterns list tuple str str = b c d e - b c d e b - b b c d e - b c d e c d e - c d e b c d e - b c d e - b c d e - b c d e - b c d e - b c d e b - b b c d e - b c d e b e - b e TestRearrange TestCase test_collapsed_ellipsis_errors_out - None x = torch zeros rearrange x b c d - b c d assertRaises ValueError rearrange x b c d - b c d rearrange x - assertRaises ValueError rearrange x - test_ellipsis_ops - None x = torch arange reshape pattern identity_patterns torch testing assert_close rearrange x pattern x msg=pattern pattern pattern equivalent_rearrange_patterns torch testing assert_close rearrange x pattern rearrange x pattern msg=f pattern vs pattern test_rearrange_consistency - None shape = x = torch arange int np prod shape dtype=int reshape shape pattern b c d e f - b c d e f b c d e f - b d e f c b c d e f - f e d c b b c d e f - f e d c b b c d e f - f e d c b result = rearrange x pattern assertEqual len np setdiff d x result assertIs result dtype x dtype result = rearrange x b c d e f - b c d e f torch testing assert_close x flatten result flatten result = rearrange x aa aa aaaa - aa aa aaaa torch testing assert_close x result result = rearrange x b c d e f - f e d c b result = rearrange x f e d c b - b c d e f torch testing assert_close result result result = rearrange rearrange x b c d e f - f d c e b f d c e b - b c d e f b= d= torch testing assert_close x result sizes = dict zip abcdef shape temp = rearrange x b c d e f - f d c e b sizes result = rearrange temp f d c e b - b c d e f sizes torch testing assert_close x result x = torch arange reshape result = rearrange x b c - b c assertEqual x result assertEqual x result test_rearrange_permutations - None tests random permutation axes against two independent numpy ways n_axes range input = torch arange n_axes reshape n_axes permutation = np random permutation n_axes left_expression = join i + str axis axis range n_axes right_expression = join i + str axis axis permutation expression = left_expression + - + right_expression result = rearrange input expression pick np random randint n_axes assertEqual input tuple pick result tuple pick permutation n_axes range input = torch arange n_axes reshape n_axes permutation = np random permutation n_axes left_expression = join i + str axis axis range n_axes - right_expression = join i + str axis axis permutation - expression = left_expression + - + right_expression result = rearrange input expression assertEqual result shape input shape expected_result = torch zeros_like input original_axis result_axis enumerate permutation expected_result &#124; = input original_axis result_axis torch testing assert_close result expected_result test_concatenations_and_stacking - None n_arrays shapes list list int = shape shapes arrays = torch arange i i + np prod shape dtype=int reshape shape i range n_arrays result = torch stack arrays result = rearrange arrays - torch testing assert_close result result test_unsqueeze - None x = torch randn actual = rearrange x b h w c - b h w c expected = x unsqueeze unsqueeze - torch testing assert_close actual expected test_squeeze - None x = torch randn actual = rearrange x b h w c - b h w c expected = x squeeze torch testing assert_close actual expected test_ _dim_tensor - None x = expected = torch tensor actual = rearrange x - torch testing assert_close actual expected actual = rearrange x - torch testing assert_close actual expected test_dimension_mismatch_no_ellipsis - None x = torch randn assertRaises ValueError rearrange x b - b assertRaises ValueError rearrange x b c d - c d b test_dimension_mismatch_with_ellipsis - None x = torch tensor assertRaises ValueError rearrange x - __name__ == __main__ run_tests
======= BEGIN Dynamo patch ======= Owner s module dynamo ruff noqa flake noqa sys torch torch _dynamo test_case unittest torch testing _internal common_utils run_tests __TestCase = torch _dynamo test_case CPythonTestCase redirect statements sys importlib abc redirect_imports = test mapping_tests test typinganndata test test_grammar test test_math test test_iter test typinganndata ann_module RedirectImportFinder importlib abc MetaPathFinder find_spec fullname path target=None Check problematic one fullname redirect_imports try Attempt standalone module name = fullname removeprefix test r = importlib import_module name Redirect module sys modules sys modules fullname = r Return module spec found module importlib util find_spec name except ImportError None None Add custom finder sys meta_path sys meta_path insert RedirectImportFinder ======= END DYNAMO PATCH ======= datetime warnings weakref unittest test support gc_collect itertools product Test_Assertions __TestCase test_AlmostEqual assertAlmostEqual assertNotAlmostEqual assertRaises failureException assertAlmostEqual assertRaises failureException assertNotAlmostEqual assertAlmostEqual places= assertRaises failureException assertAlmostEqual places= assertAlmostEqual + j places= assertNotAlmostEqual + j places= assertRaises failureException assertAlmostEqual + j places= assertRaises failureException assertNotAlmostEqual + j places= assertAlmostEqual float inf float inf assertRaises failureException assertNotAlmostEqual float inf float inf test_AmostEqualWithDelta assertAlmostEqual delta= assertAlmostEqual delta= assertNotAlmostEqual delta= assertNotAlmostEqual delta= assertAlmostEqual delta= assertRaises failureException assertNotAlmostEqual delta= assertRaises failureException assertAlmostEqual delta= assertRaises failureException assertNotAlmostEqual delta= assertRaises TypeError assertAlmostEqual places= delta= assertRaises TypeError assertNotAlmostEqual places= delta= first = datetime datetime now second = first + datetime timedelta seconds= assertAlmostEqual first second delta=datetime timedelta seconds= assertNotAlmostEqual first second delta=datetime timedelta seconds= test_assertRaises _raise e raise e assertRaises KeyError _raise KeyError assertRaises KeyError _raise KeyError key try assertRaises KeyError lambda None except failureException e assertIn KeyError raised str e fail assertRaises didn t fail try assertRaises KeyError _raise ValueError except ValueError pass fail assertRaises didn t let exception pass through assertRaises KeyError cm try raise KeyError except Exception e exc = e raise assertIs cm exception exc assertRaises KeyError raise KeyError key try assertRaises KeyError pass except failureException e assertIn KeyError raised str e fail assertRaises didn t fail try assertRaises KeyError raise ValueError except ValueError pass fail assertRaises didn t let exception pass through test_assertRaises_frames_survival Issue assertRaises should avoid keeping local variables traceback alive A pass wr = None Foo unittest TestCase foo nonlocal wr = A wr = weakref ref try raise OSError except OSError raise ValueError test_functional assertRaises ValueError foo test_with assertRaises ValueError foo Foo test_functional run gc_collect For PyPy other GCs assertIsNone wr Foo test_with run gc_collect For PyPy other GCs assertIsNone wr testAssertNotRegex assertNotRegex Ala ma kota r r+ try assertNotRegex Ala ma kota r k t Message except failureException e assertIn Message e args fail assertNotRegex should have failed TestLongMessage __TestCase Test individual asserts honour longMessage This actually tests all message behaviour asserts use longMessage setUp super setUp TestableTestFalse unittest TestCase longMessage = False failureException = failureException testTest pass TestableTestTrue unittest TestCase longMessage = True failureException = failureException testTest pass testableTrue = TestableTestTrue testTest testableFalse = TestableTestFalse testTest testDefault assertTrue unittest TestCase longMessage test_formatMsg assertEqual testableFalse _formatMessage None foo foo assertEqual testableFalse _formatMessage foo bar foo assertEqual testableTrue _formatMessage None foo foo assertEqual testableTrue _formatMessage foo bar bar foo This blows up _formatMessage uses string concatenation testableTrue _formatMessage object foo test_formatMessage_unicode_error one = join chr i i range used cause UnicodeDecodeError constructing msg testableTrue _formatMessage one \uFFFD assertMessages methodName args errors Check methodName args raises correct error messages errors should list regex match error when longMessage = False no msg passed longMessage = False msg passed longMessage = True no msg passed longMessage = True msg passed getMethod i useTestableFalse = i useTestableFalse test = testableFalse test = testableTrue getattr test methodName i expected_regex enumerate errors testMethod = getMethod i kwargs = withMsg = i withMsg kwargs = msg oops assertRaisesRegex failureException expected_regex=expected_regex testMethod args kwargs testAssertTrue assertMessages assertTrue False ^False true$ ^oops$ ^False true$ ^False true oops$ testAssertFalse assertMessages assertFalse True ^True false$ ^oops$ ^True false$ ^True false oops$ testNotEqual assertMessages assertNotEqual ^ == $ ^oops$ ^ == $ ^ == oops$ testAlmostEqual assertMessages assertAlmostEqual r ^ = within places \ difference\ $ ^oops$ r ^ = within places \ difference\ $ r ^ = within places \ difference\ oops$ testNotAlmostEqual assertMessages assertNotAlmostEqual ^ == within places$ ^oops$ ^ == within places$ ^ == within places oops$ test_baseAssertEqual assertMessages _baseAssertEqual ^ = $ ^oops$ ^ = $ ^ = oops$ testAssertSequenceEqual Error messages multiline so testing full message assertTupleEqual assertListEqual delegate method assertMessages assertSequenceEqual None r \+ \ None\ $ ^oops$ r \+ \ None\ $ r \+ \ None\ oops$ testAssertSetEqual assertMessages assertSetEqual set set None None$ ^oops$ None$ None oops$ testAssertIn assertMessages assertIn None r ^None found \ \ $ ^oops$ r ^None found \ \ $ r ^None found \ \ oops$ testAssertNotIn assertMessages assertNotIn None None r ^None unexpectedly found \ None\ $ ^oops$ r ^None unexpectedly found \ None\ $ r ^None unexpectedly found \ None\ oops$ testAssertDictEqual assertMessages assertDictEqual key value r \+ \ key value \ $ ^oops$ r \+ \ key value \ $ r \+ \ key value \ oops$ testAssertMultiLineEqual assertMessages assertMultiLineEqual foo r \+ foo\n$ ^oops$ r \+ foo\n$ r \+ foo\n oops$ testAssertLess assertMessages assertLess ^ less than $ ^oops$ ^ less than $ ^ less than oops$ testAssertLessEqual assertMessages assertLessEqual ^ less than equal $ ^oops$ ^ less than equal $ ^ less than equal oops$ testAssertGreater assertMessages assertGreater ^ greater than $ ^oops$ ^ greater than $ ^ greater than oops$ testAssertGreaterEqual assertMessages assertGreaterEqual ^ greater than equal $ ^oops$ ^ greater than equal $ ^ greater than equal oops$ testAssertIsNone assertMessages assertIsNone None ^ None None$ ^oops$ ^ None None$ ^ None None oops$ testAssertIsNotNone assertMessages assertIsNotNone None ^unexpectedly None$ ^oops$ ^unexpectedly None$ ^unexpectedly None oops$ testAssertIs assertMessages assertIs None foo ^None foo $ ^oops$ ^None foo $ ^None foo oops$ testAssertIsNot assertMessages assertIsNot None None ^unexpectedly identical None$ ^oops$ ^unexpectedly identical None$ ^unexpectedly identical None oops$ testAssertRegex assertMessages assertRegex foo bar ^Regex didn t match ^oops$ ^Regex didn t match ^Regex didn t match oops$ testAssertNotRegex assertMessages assertNotRegex foo foo ^Regex matched ^oops$ ^Regex matched ^Regex matched oops$ assertMessagesCM methodName args func errors Check correct error messages raised while executing method args func errors should list regex match error when longMessage = False no msg passed longMessage = False msg passed longMessage = True no msg passed longMessage = True msg passed p = product testableFalse testableTrue msg oops cls kwargs err zip p errors method = getattr cls methodName assertRaisesRegex cls failureException err method args kwargs cm func testAssertRaises assertMessagesCM assertRaises TypeError lambda None ^TypeError raised$ ^oops$ ^TypeError raised$ ^TypeError raised oops$ testAssertRaisesRegex test error raised assertMessagesCM assertRaisesRegex TypeError unused regex lambda None ^TypeError raised$ ^oops$ ^TypeError raised$ ^TypeError raised oops$ test error raised wrong message raise_wrong_message raise TypeError foo assertMessagesCM assertRaisesRegex TypeError regex raise_wrong_message ^ regex does match foo $ ^oops$ ^ regex does match foo $ ^ regex does match foo oops$ testAssertWarns assertMessagesCM assertWarns UserWarning lambda None ^UserWarning triggered$ ^oops$ ^UserWarning triggered$ ^UserWarning triggered oops$ test_assertNotWarns warn_future warnings warn xyz FutureWarning stacklevel= assertMessagesCM _assertNotWarns FutureWarning warn_future ^FutureWarning triggered$ ^oops$ ^FutureWarning triggered$ ^FutureWarning triggered oops$ testAssertWarnsRegex test error raised assertMessagesCM assertWarnsRegex UserWarning unused regex lambda None ^UserWarning triggered$ ^oops$ ^UserWarning triggered$ ^UserWarning triggered oops$ test warning raised wrong message raise_wrong_message warnings warn foo assertMessagesCM assertWarnsRegex UserWarning regex raise_wrong_message ^ regex does match foo $ ^oops$ ^ regex does match foo $ ^ regex does match foo oops$ __name__ == __main__ run_tests
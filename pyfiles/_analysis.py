Compatibility analyzer PyTorch models mypy allow-untyped-defs flake noqa B We do need flake complains line length __future__ annotations dataclasses operator textwrap traceback collections defaultdict typing TYPE_CHECKING torch torch _export serde schema torch export graph_signature torch onnx _internal exporter _dispatching _registration TYPE_CHECKING torch fx dataclasses dataclass ModelInfo Information about model parameter_count defaultdict torch dtype int = dataclasses field default_factory=lambda defaultdict int buffer_count defaultdict torch dtype int = dataclasses field default_factory=lambda defaultdict int fx_node_count int = fx_node_op_count defaultdict str int = dataclasses field default_factory=lambda defaultdict int fx_node_target_count defaultdict str int = dataclasses field default_factory=lambda defaultdict int dispatch_failures list tuple torch fx Node str = dataclasses field default_factory=list inputs dict str torch _export serde schema TensorMeta = dataclasses field default_factory=dict outputs dict str torch _export serde schema TensorMeta = dataclasses field default_factory=dict _count_weights exported_program torch export ExportedProgram - tuple defaultdict torch dtype int defaultdict torch dtype int Count size parameters exported program parameter_count defaultdict torch dtype int = defaultdict int buffer_count defaultdict torch dtype int = defaultdict int parameter exported_program parameters dtype = parameter dtype parameter_count dtype += parameter numel buffer exported_program buffers dtype = buffer dtype buffer_count dtype += buffer numel parameter_count buffer_count _format_model_info model_info ModelInfo - str Format information about model lines = textwrap dedent f \ PyTorch ONNX Conversion Analysis ## Model Information The model has sum model_info parameter_count values parameters sum model_info buffer_count values buffers non-trainable parameters Number parameters per dtype ` ` ` python model_info parameter_count ` ` ` Number buffers per dtype ` ` ` python model_info buffer_count ` ` ` Inputs f - ` name ` ` meta ` name meta model_info inputs items Outputs f - ` name ` ` meta ` name meta model_info outputs items f The FX graph has model_info fx_node_count nodes total Number FX nodes per op op count model_info fx_node_op_count items lines append f - ` op ` count lines append \n lines append Of call_function nodes counts operators used \n sorted_targets = sorted model_info fx_node_target_count items key=operator itemgetter reverse=True target count sorted_targets lines append f - ` target ` count lines append lines append ## ONNX Conversion Information lines append model_info dispatch_failures lines append The model contains operators dispatcher could find registered ONNX decompositions This may due missing implementations decompositions registered correctly bug dispatcher lines append lines append Errors grouped operator \n target_to_nodes = defaultdict list node _ model_info dispatch_failures pyrefly ignore index-error target_to_nodes str node target append node target_to_messages = node message model_info dispatch_failures str node target target_to_messages pyrefly ignore unsupported-operation target_to_messages str node target = message target nodes sorted target_to_nodes items key=operator itemgetter reverse=True message = textwrap indent f target_to_messages target Example node ` nodes format_node ` All nodes ` nodes ` lines append f - ` target ` message lines append All operators model have registered ONNX decompositions \n join lines _get_io_specs exported_program torch export ExportedProgram - tuple dict dict Get input output specs exported program nodes dict str torch fx Node = node name node node exported_program graph nodes user_inputs = spec spec exported_program graph_signature input_specs spec kind == graph_signature InputKind USER_INPUT user_outputs = spec spec exported_program graph_signature output_specs spec kind == graph_signature OutputKind USER_OUTPUT inputs dict str torch _export serde schema TensorMeta &#124; str = outputs dict str torch _export serde schema TensorMeta &#124; str = spec user_inputs inputs = _log_spec_into_io_specs spec nodes inputs spec user_outputs outputs = _log_spec_into_io_specs spec nodes outputs inputs outputs _log_spec_into_io_specs spec graph_signature InputSpec nodes dict str torch fx Node inputs_or_outputs dict str torch _export serde schema TensorMeta &#124; str - dict str torch _export serde schema TensorMeta &#124; str If dynamic set constant input becomes symbolic argument which tensor isinstance spec arg graph_signature ConstantArgument Constant input does have tensor_meta inputs_or_outputs Symbolic arguments tensors so does have tensor_meta we need provide string representation them inform users name = spec arg name isinstance spec arg graph_signature SymIntArgument graph_signature SymFloatArgument graph_signature SymBoolArgument argument_to_str dict type graph_signature ArgumentSpec str = graph_signature SymIntArgument SymInt graph_signature SymFloatArgument SymFloat graph_signature SymBoolArgument SymBool inputs_or_outputs name = argument_to_str type spec arg inputs_or_outputs FIXME tensor_meta None sometimes when exported program still knows shape type inputs_or_outputs name = nodes name meta tensor_meta inputs_or_outputs _count_fx_targets exported_program torch export ExportedProgram - defaultdict str int Count number targets each node exported program fx_node_target_count defaultdict str int = defaultdict int node exported_program graph nodes node op == call_function fx_node_target_count str node target += fx_node_target_count analyze exported_program torch export ExportedProgram registry _registration ONNXRegistry &#124; None = None file=None - None Analyze compatibility exported program Get basic information about model model_info = ModelInfo model_info parameter_count model_info buffer_count = _count_weights exported_program model_info fx_node_count = len exported_program graph nodes model_info fx_node_target_count = _count_fx_targets exported_program inputs outputs = _get_io_specs exported_program model_info inputs = inputs model_info outputs = outputs registry None registry = _registration ONNXRegistry from_torchlib Try find ops every node graph node exported_program graph nodes model_info fx_node_op_count node op += node op == call_function try onnx_function message = _dispatching dispatch node registry except Exception e message = Critical Error dispatcher \n formatted_exception = \n join traceback format_exception type e e e __traceback__ message += f ` ` ` pytb\n formatted_exception \n ` ` ` \n onnx_function = None onnx_function None model_info dispatch_failures append node message Print results report = _format_model_info model_info print report file=file flush=True compare_ops program_a torch export ExportedProgram program_b torch export ExportedProgram - tuple set str set str Compare get unique ops two exported programs Args program_a The first exported program program_b The second exported program Returns A tuple two sets where first set contains unique ops first program second set contains unique ops second program program_a_ops = set _count_fx_targets program_a program_b_ops = set _count_fx_targets program_b program_a_ops - program_b_ops program_b_ops - program_a_ops
io logging sys zipfile pathlib Path Use asterisk symbol so developer doesn t need here when they add tests upgraders test jit fixtures_srcs fixtures_src noqa F typing Set torch torch jit mobile _export_operator_list _load_for_lite_interpreter logging basicConfig stream=sys stdout level=logging INFO logger = logging getLogger __name__ logger setLevel logging DEBUG This file used generate model test operator change Please refer https github com pytorch rfcs blob master RFC- -PyTorch-Operator-Versioning md more details A systematic workflow change operator needed ensure Backwards Compatibility BC Forwards Compatibility FC operator changes For BC-breaking operator change upgrader needed Here flow properly land BC-breaking operator change Write upgrader caffe torch csrc jit operator_upgraders upgraders_entry cpp file The softly enforced naming format operator_name _ operator_overload _ start _ end For example below example means div Tensor version needs replaced upgrader ` ` ` div_Tensor_ _ added change operator div pr xxxxxxx Create date Expire date div_Tensor_ _ R SCRIPT div_Tensor_ _ Tensor other Tensor - Tensor is_floating_point other is_floating_point true_divide other divide other rounding_mode= trunc SCRIPT ` ` ` In caffe torch csrc jit operator_upgraders version_map h add changes like below You will need make sure entry SORTED according version bump number ` ` ` div Tensor div_Tensor_ _ aten div Tensor Tensor Tensor other - Tensor ` ` ` After rebuild PyTorch run following command will auto generate change fbcode caffe torch csrc jit mobile upgrader_mobile cpp ` ` ` python pytorch torchgen operator_versions gen_mobile_upgraders py ` ` ` Generate test cover upgrader Switch commit before operator change add module ` test jit fixtures_srcs fixtures_src py ` The reason why switching commit old model old operator before change needed ensure upgrader working expected In ` test jit fixtures_srcs generate_models py ` add module s corresponding changed operator like following ` ` ` ALL_MODULES = TestVersionedDivTensorExampleV aten div Tensor ` ` ` This module should includes changed operator If operator isn t covered model model export process step will fail Export model ` test jit fixtures ` running ` ` ` python Users chenlai pytorch test jit fixtures_src generate_models py ` ` ` In ` test jit test_save_load_for_op_version py ` add test cover old models ensure result equivalent between current module old module + upgrader Save all change well previous changes made step Submit pr A map test modules s according changed operator key test module value changed operator ALL_MODULES = TestVersionedDivTensorExampleV aten div Tensor TestVersionedLinspaceV aten linspace TestVersionedLinspaceOutV aten linspace out TestVersionedLogspaceV aten logspace TestVersionedLogspaceOutV aten logspace out TestVersionedGeluV aten gelu TestVersionedGeluOutV aten gelu out TestVersionedRandomV aten random_ TestVersionedRandomFuncV aten random TestVersionedRandomOutV aten random from_out Get path ` test jit fixtures ` where all test models operator changes upgrader downgrader stored get_fixtures_path - Path pytorch_dir = Path __file__ resolve parents fixtures_path = pytorch_dir test jit fixtures fixtures_path Get all models name ` test jit fixtures ` get_all_models model_directory_path Path - Set str files_in_fixtures = model_directory_path glob all_models_from_fixtures = fixture stem fixture files_in_fixtures fixture is_file set all_models_from_fixtures Check given model already exist ` test jit fixtures ` model_exist model_file_name str all_models Set str - bool model_file_name all_models Get operator list given module get_operator_list script_module torch - Set str buffer = io BytesIO script_module _save_to_buffer_for_lite_interpreter buffer seek mobile_module = _load_for_lite_interpreter buffer operator_list = _export_operator_list mobile_module operator_list Get output model operator version given module get_output_model_version script_module torch nn Module - int buffer = io BytesIO torch jit save script_module buffer buffer seek zipped_model = zipfile ZipFile buffer try version = int zipped_model read archive version decode utf- version except KeyError version = int zipped_model read archive data version decode utf- version Loop through all test modules If corresponding model doesn t exist ` test jit fixtures ` generate one For following reason model won t exported The test module doens t cover changed operator For example test_versioned_div_tensor_example_v supposed test operator aten div Tensor If model doesn t include operator will fail The error message includes actual operator list model The output model version same expected version For example test_versioned_div_tensor_example_v used test operator change aten div Tensor operator version will bumped v This script supposed run before operator change before commit make change If actual model version v likely script running commit make change The model already exists ` test jit fixtures ` generate_models model_directory_path Path all_models = get_all_models model_directory_path a_module expect_operator ALL_MODULES items For example TestVersionedDivTensorExampleV torch_module_name = type a_module __name__ isinstance a_module torch nn Module logger error The module s torch nn module instance Please ensure s subclass torch nn module fixtures_src py s registered instance ALL_MODULES generated_models py torch_module_name The corresponding model name test_versioned_div_tensor_example_v model_name = join _ + char lower char isupper char char torch_module_name lstrip _ Some models may compile anymore so skip ones already has pt file them logger info Processing s torch_module_name model_exist model_name all_models logger info Model s already exists skipping model_name continue script_module = torch jit script a_module actual_model_version = get_output_model_version script_module current_operator_version = torch _C _get_max_operator_version actual_model_version = current_operator_version + logger error Actual model version s equal larger than s + Please run script before commit change operator actual_model_version current_operator_version continue actual_operator_list = get_operator_list script_module expect_operator actual_operator_list logger error The model includes operator s however doesn t cover operator s Please ensure output model includes tested operator actual_operator_list expect_operator continue export_model_path = str model_directory_path str model_name + ptl script_module _save_for_lite_interpreter export_model_path logger info Generating model s s save s model_name export_model_path main - None model_directory_path = get_fixtures_path generate_models model_directory_path __name__ == __main__ main
mypy allow-untyped-defs ctypes functools itertools logging sys collections abc Iterable typing Callable Optional Union unittest mock patch sympy config ir autotune_process CppBenchmarkRequest TensorMeta utils IndentedBuffer Placeholder unique virtualized V common KernelTemplate cpp_template_kernel CppTemplateCaller CppTemplateKernel log = logging getLogger __name__ CppTemplate KernelTemplate index_counter = itertools count __init__ name str input_nodes layout ir Layout num_threads int epilogue_creator Optional Callable ir Buffer ir Pointwise = None - None super __init__ name input_nodes = input_nodes index = next index_counter output_node Union ir Buffer list ir Buffer = ir Buffer name=f buf_out index layout=layout layout = layout num_threads = num_threads epilogue_creator = epilogue_creator generate kwargs kernel_name = f cpp_ name patch object V graph get_dtype _fake_get_dtype output_node patch object ir FlexibleLayout allow_indexing True V graph set_current_device layout device CppTemplateKernel kernel_name=kernel_name num_threads=self num_threads kernel code = kernel render kwargs _ call_args _ _ = kernel args python_argdefs log debug Generated Code \n s code log debug Args cpp_argdefs s python_argdefs s kernel args cpp_argdefs kernel args python_argdefs expected_args = list unique input_node get_name input_node input_nodes isinstance output_node Iterable expected_args extend node get_name node output_node expected_args extend output_node get_name assert list call_args len expected_args == expected_args call_args expected_args extra_args = V graph sizevars size_hints map sympy expand call_args len expected_args Cast size hint int ctypes c_ulonglong explicitly since cpp kernel we bind C long extra_args = tuple ctypes c_ulonglong x x extra_args kernel_hash_name = f cpp_ name _ index Create BenchmarkRequest CPP bmreq = CppBenchmarkRequest kernel_name=kernel_name input_tensor_meta=TensorMeta from_irnodes input_nodes pyrefly ignore bad-argument-type output_tensor_meta=TensorMeta from_irnodes output_node extra_args=extra_args source_code=code make_kernel_render template_node ir CppTemplateBuffer flag_template_buffer_has_other_users bool epilogue_nodes Optional list ir IRNode = None kernel = CppTemplateKernel kernel_name=str Placeholder KERNEL_NAME num_threads=self num_threads render = functools partial kernel render template_buffer_node=template_node flag_template_buffer_has_other_users=flag_template_buffer_has_other_users epilogue_nodes=epilogue_nodes kwargs kernel render CppTemplateCaller kernel_hash_name name input_nodes pyrefly ignore index-error output_node get_layout isinstance output_node Iterable output_node get_layout make_kernel_render bmreq header - IndentedBuffer res = IndentedBuffer res writeline #include torch csrc inductor cpp_prefix h TODO add c ForcedUnroll test test_aoti_abi_check res splice #include c util Unroll h res splice #include torch csrc inductor aoti_torch c shim h enable_kernel_profile = config cpp enable_kernel_profile sys platform linux win enable_kernel_profile res writelines #include torch csrc inductor aoti_runtime utils h res render kwargs - str raise NotImplementedError
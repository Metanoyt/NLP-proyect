mypy allow-untyped-defs dataclasses collections abc Collection Mapping enum auto Enum typing Optional TYPE_CHECKING Union torch _library fake_class_registry FakeScriptObject torch _subclasses fake_tensor is_fake TYPE_CHECKING torch torch _functorch _aot_autograd schemas GraphSignature __all__ = ConstantArgument CustomObjArgument ExportBackwardSignature ExportGraphSignature InputKind InputSpec OutputKind OutputSpec SymIntArgument SymFloatArgument SymBoolArgument TensorArgument dataclasses dataclass TensorArgument name str dataclasses dataclass TokenArgument name str dataclasses dataclass SymIntArgument name str dataclasses dataclass SymFloatArgument name str dataclasses dataclass SymBoolArgument name str dataclasses dataclass CustomObjArgument name str class_fqn str fake_val Optional FakeScriptObject = None dataclasses dataclass ConstantArgument name str value Union int float bool str None ArgumentSpec = Union TensorArgument SymIntArgument SymFloatArgument SymBoolArgument ConstantArgument CustomObjArgument TokenArgument InputKind Enum USER_INPUT = auto PARAMETER = auto BUFFER = auto CONSTANT_TENSOR = auto CUSTOM_OBJ = auto TOKEN = auto dataclasses dataclass InputSpec kind InputKind arg ArgumentSpec target Optional str persistent Optional bool = None __post_init__ kind == InputKind BUFFER assert persistent None Failed specify persistent flag BUFFER assert isinstance arg TensorArgument SymIntArgument SymFloatArgument SymBoolArgument ConstantArgument CustomObjArgument TokenArgument f got type arg __str__ target = target None f target= target persistent = persistent None f persistent= persistent f str arg name str kind name target persistent OutputKind Enum USER_OUTPUT = auto LOSS_OUTPUT = auto BUFFER_MUTATION = auto PARAMETER_MUTATION = auto GRADIENT_TO_PARAMETER = auto GRADIENT_TO_USER_INPUT = auto USER_INPUT_MUTATION = auto TOKEN = auto dataclasses dataclass OutputSpec kind OutputKind arg ArgumentSpec target Optional str __post_init__ assert isinstance arg TensorArgument SymIntArgument SymFloatArgument SymBoolArgument ConstantArgument TokenArgument CustomObjArgument arg __str__ target = target None f target= target f str arg name str kind name target dataclasses dataclass ExportBackwardSignature gradients_to_parameters dict str str gradients_to_user_inputs dict str str loss_output str dataclasses dataclass ExportGraphSignature ` ExportGraphSignature ` models input output signature Export Graph which fx Graph stronger invariants guarantees Export Graph functional does access states like parameters buffers within graph via ` ` getattr ` ` nodes Instead func ` export ` guarantees parameters buffers constant tensors lifted out graph inputs Similarly any mutations buffers included graph either instead updated values mutated buffers modeled additional outputs Export Graph The ordering all inputs outputs Inputs = parameters_buffers_constant_tensors flattened_user_inputs Outputs = mutated_inputs flattened_user_outputs e g If following module exported CustomModule nn Module __init__ - None super CustomModule __init__ Define parameter my_parameter = nn Parameter torch tensor Define two buffers register_buffer my_buffer torch tensor register_buffer my_buffer torch tensor forward x x Use parameter buffers both inputs forward method output = x + my_parameter my_buffer + x my_buffer Mutate one buffers e g increment my_buffer add_ In-place addition output mod = CustomModule ep = torch export export mod torch tensor torch tensor Resulting Graph non-functional graph p_my_parameter num_users= = placeholder target=p_my_parameter b_my_buffer num_users= = placeholder target=b_my_buffer b_my_buffer num_users= = placeholder target=b_my_buffer x num_users= = placeholder target=x x num_users= = placeholder target=x add num_users= = call_function target=torch ops aten add Tensor args = x p_my_parameter kwargs = mul num_users= = call_function target=torch ops aten mul Tensor args = add b_my_buffer kwargs = mul_ num_users= = call_function target=torch ops aten mul Tensor args = x b_my_buffer kwargs = add_ num_users= = call_function target=torch ops aten add Tensor args = mul mul_ kwargs = add_ num_users= = call_function target=torch ops aten add_ Tensor args = b_my_buffer kwargs = add_ Resulting ExportGraphSignature non-functional Graph would inputs p_my_parameter PARAMETER target= my_parameter b_my_buffer BUFFER target= my_buffer persistent=True b_my_buffer BUFFER target= my_buffer persistent=True x USER_INPUT x USER_INPUT outputs add_ USER_OUTPUT To get functional Graph you can use func ` run_decompositions ` mod = CustomModule ep = torch export export mod torch tensor torch tensor ep = ep run_decompositions Resulting Graph functional graph p_my_parameter num_users= = placeholder target=p_my_parameter b_my_buffer num_users= = placeholder target=b_my_buffer b_my_buffer num_users= = placeholder target=b_my_buffer x num_users= = placeholder target=x x num_users= = placeholder target=x add num_users= = call_function target=torch ops aten add Tensor args = x p_my_parameter kwargs = mul num_users= = call_function target=torch ops aten mul Tensor args = add b_my_buffer kwargs = mul_ num_users= = call_function target=torch ops aten mul Tensor args = x b_my_buffer kwargs = add_ num_users= = call_function target=torch ops aten add Tensor args = mul mul_ kwargs = add_ num_users= = call_function target=torch ops aten add Tensor args = b_my_buffer kwargs = add_ add_ Resulting ExportGraphSignature functional Graph would inputs p_my_parameter PARAMETER target= my_parameter b_my_buffer BUFFER target= my_buffer persistent=True b_my_buffer BUFFER target= my_buffer persistent=True x USER_INPUT x USER_INPUT outputs add_ BUFFER_MUTATION target= my_buffer add_ USER_OUTPUT input_specs list InputSpec output_specs list OutputSpec A list parameters uniquely identified mangled fully qualified name property parameters - Collection str tuple s target s input_specs s kind == InputKind PARAMETER isinstance s target str A list buffers uniquely identified mangled fully qualified name property buffers - Collection str tuple s target s input_specs s kind == InputKind BUFFER isinstance s target str property non_persistent_buffers - Collection str tuple s target s input_specs s kind == InputKind BUFFER s persistent False isinstance s target str A list lifted constant tensors property lifted_tensor_constants - Collection str tuple s target s input_specs s kind == InputKind CONSTANT_TENSOR isinstance s target str property lifted_custom_objs - Collection str tuple s target s input_specs s kind == InputKind CUSTOM_OBJ isinstance s target str Graph node names pytree-flattened inputs original program property user_inputs - Collection Union int float bool None str user_inputs list Union int float bool None str = s input_specs s kind = InputKind USER_INPUT continue isinstance s arg TensorArgument SymIntArgument SymFloatArgument SymBoolArgument CustomObjArgument user_inputs append s arg name isinstance s arg ConstantArgument user_inputs append s arg value raise RuntimeError f s arg valid user inputs tuple user_inputs Graph node names pytree-flattened outputs original program For joint-graph purposes will include loss output property user_outputs - Collection Union int float bool None str user_outputs list Union int float bool None str = s output_specs s kind OutputKind USER_OUTPUT OutputKind LOSS_OUTPUT continue isinstance s arg TensorArgument SymIntArgument SymFloatArgument SymBoolArgument user_outputs append s arg name isinstance s arg ConstantArgument user_outputs append s arg value isinstance s arg CustomObjArgument user_outputs append s arg name raise RuntimeError f s arg valid user output tuple user_outputs A dictionary mapping graph input node names parameters If graph input name found dictionary guaranteed lifted parameter property inputs_to_parameters - Mapping str str _immutable_dict s arg name s target s input_specs s kind == InputKind PARAMETER isinstance s arg TensorArgument isinstance s target str A dictionary mapping graph input node names buffers If graph input name found dictionary guaranteed lifted buffer property inputs_to_buffers - Mapping str str _immutable_dict s arg name s target type ignore union-attr misc s input_specs s kind == InputKind BUFFER isinstance s arg TensorArgument isinstance s target str A dictionary mapping graph output node names buffers mutated original program Buffers mutated will found dictionary property buffers_to_mutate - Mapping str str _immutable_dict s arg name s target s output_specs s kind == OutputKind BUFFER_MUTATION isinstance s arg TensorArgument isinstance s target str property parameters_to_mutate - Mapping str str _immutable_dict s arg name s target s output_specs s kind == OutputKind PARAMETER_MUTATION isinstance s arg TensorArgument isinstance s target str property user_inputs_to_mutate - Mapping str str _immutable_dict s arg name s target s output_specs s kind == OutputKind USER_INPUT_MUTATION isinstance s arg TensorArgument isinstance s target str A dictionary mapping graph input node names lifted tensor constants property inputs_to_lifted_tensor_constants - Mapping str str _immutable_dict s arg name s target s input_specs s kind == InputKind CONSTANT_TENSOR isinstance s arg TensorArgument isinstance s target str property inputs_to_lifted_custom_objs - Mapping str str _immutable_dict s arg name s target s input_specs s kind == InputKind CUSTOM_OBJ isinstance s arg CustomObjArgument isinstance s target str property backward_signature - Optional ExportBackwardSignature loss_output = None gradients_to_parameters dict str str = gradients_to_user_inputs dict str str = spec output_specs spec kind == OutputKind LOSS_OUTPUT assert loss_output None assert isinstance spec arg TensorArgument loss_output = spec arg name spec kind == OutputKind GRADIENT_TO_PARAMETER assert isinstance spec target str assert isinstance spec arg TensorArgument gradients_to_parameters spec arg name = spec target spec kind == OutputKind GRADIENT_TO_USER_INPUT assert isinstance spec target str assert isinstance spec arg TensorArgument gradients_to_user_inputs spec arg name = spec target loss_output None None ExportBackwardSignature loss_output=loss_output gradients_to_parameters=gradients_to_parameters gradients_to_user_inputs=gradients_to_user_inputs Map assertion dependency token index assertion dep token output name output The shape output after aot_autograd will like updated_inputs user_outputs dep_token property assertion_dep_token - Optional Mapping int str None property input_tokens - Collection str input_tokens = s input_specs s kind == InputKind TOKEN assert isinstance s arg TokenArgument input_tokens append s arg name tuple input_tokens property output_tokens - Collection str output_tokens = s output_specs s kind == OutputKind TOKEN assert isinstance s arg TokenArgument output_tokens append s arg name tuple output_tokens __post_init__ - None assertion_dep_token = assertion_dep_token assertion_dep_token None assert len assertion_dep_token == assertion_dep_token_index = next iter assertion_dep_token keys assert len user_outputs + len buffers_to_mutate == assertion_dep_token_index replace_all_uses old str new str Replace all uses old name new name signature assert isinstance old str assert isinstance new str arg_types = TensorArgument SymIntArgument SymFloatArgument SymBoolArgument CustomObjArgument TokenArgument o output_specs isinstance o arg arg_types o arg name == old o arg name = new i input_specs isinstance i arg arg_types i arg name == old i arg name = new get_replace_hook replace_inputs=False _ old new user user op == output replace_all_uses old name new replace_inputs old op == placeholder replace_all_uses old name new _ __str__ input_specs = \n join str s s input_specs output_specs = \n join str s s output_specs f \n# inputs\n input_specs \n\n# outputs\n output_specs \n _immutable_dict items Creates mapping where items cannot added deleted updated NOTE The immutability shallow like tuple immutable collection types MappingProxyType MappingProxyType dict items _make_argument_spec node token_names - ArgumentSpec torch ScriptObject SymBool SymFloat SymInt torch _library fake_class_registry FakeScriptObject isinstance node int bool float type None str For const outputs we just directly ConstantArgument name= value=node assert val node meta f node constant node val metadata field val = node meta val node name token_names TokenArgument name=node name is_fake val TensorArgument name=node name isinstance val SymInt SymIntArgument name=node name isinstance val SymFloat SymFloatArgument name=node name isinstance val SymBool SymBoolArgument name=node name isinstance val ScriptObject CustomObjArgument name=node name class_fqn=val _type qualified_name type ignore attr-defined isinstance val FakeScriptObject CustomObjArgument name=node name class_fqn=val script_class_name fake_val=val isinstance val int bool str float type None ConstantArgument name=node name value=val raise AssertionError f Encountered unsupported object type type val f while writing metadata exported program _convert_to_export_graph_signature graph_signature GraphSignature gm torch fx GraphModule non_persistent_buffers set str - ExportGraphSignature torch utils _pytree pytree is_joint = graph_signature backward_signature None unpack objects user_inputs = set graph_signature user_inputs inputs_to_parameters = graph_signature inputs_to_parameters inputs_to_buffers = graph_signature inputs_to_buffers user_outputs = set graph_signature user_outputs buffer_mutations = graph_signature buffers_to_mutate parameter_mutations = graph_signature parameters_to_mutate user_input_mutations = graph_signature user_inputs_to_mutate grad_params = graph_signature backward_signature gradients_to_parameter type ignore union-attr is_joint grad_user_inputs = graph_signature backward_signature gradients_to_user_inputs type ignore union-attr is_joint loss_output = graph_signature backward_signature loss_output type ignore union-attr is_joint None input_tokens = graph_signature input_tokens output_tokens = graph_signature output_tokens inputs = _make_argument_spec node input_tokens node gm graph nodes node op == placeholder outputs = _make_argument_spec node output_tokens node pytree tree_leaves next iter reversed gm graph nodes args to_input_spec inp ArgumentSpec - InputSpec isinstance inp TokenArgument InputSpec kind=InputKind TOKEN arg=inp target=None isinstance inp TensorArgument InputSpec kind=InputKind USER_INPUT arg=inp target=None name = inp name name user_inputs InputSpec kind=InputKind USER_INPUT arg=inp target=None name inputs_to_parameters InputSpec kind=InputKind PARAMETER arg=inp target=inputs_to_parameters name type ignore index name inputs_to_buffers InputSpec kind=InputKind BUFFER arg=inp target=inputs_to_buffers name type ignore index persistent= inputs_to_buffers name non_persistent_buffers type ignore index raise AssertionError f Unknown tensor input kind name to_output_spec idx int o ArgumentSpec - OutputSpec isinstance o TokenArgument OutputSpec kind=OutputKind TOKEN arg=o target=None isinstance o TensorArgument OutputSpec kind=OutputKind USER_OUTPUT arg=o target=None name = o name idx len buffer_mutations + len parameter_mutations + len user_input_mutations + len output_tokens name buffer_mutations OutputSpec kind=OutputKind BUFFER_MUTATION arg=o target=buffer_mutations name type ignore index name parameter_mutations OutputSpec kind=OutputKind PARAMETER_MUTATION arg=o target=parameter_mutations name type ignore index name user_input_mutations OutputSpec kind=OutputKind USER_INPUT_MUTATION arg=o target=user_input_mutations name type ignore index raise AssertionError f Unknown tensor mutation kind name name user_outputs OutputSpec kind=OutputKind USER_OUTPUT arg=o target=None name grad_params OutputSpec kind=OutputKind GRADIENT_TO_PARAMETER arg=o target=grad_params name name grad_user_inputs OutputSpec kind=OutputKind GRADIENT_TO_USER_INPUT arg=o target=grad_user_inputs name name == loss_output OutputSpec kind=OutputKind LOSS_OUTPUT arg=o target=None raise AssertionError f Unknown tensor output kind name input_specs = to_input_spec inp inp inputs output_specs = to_output_spec idx o idx o enumerate outputs ExportGraphSignature input_specs=input_specs output_specs=output_specs
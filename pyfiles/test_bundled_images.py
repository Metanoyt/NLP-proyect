usr bin env python Owner s oncall mobile mypy allow-untyped-defs io cv manual torch torch utils bundled_inputs torch testing _internal common_utils TestCase torch ops load_library caffe torch fb operators decode_bundled_image model_size sm buffer = io BytesIO torch jit save sm buffer len buffer getvalue save_and_load sm buffer = io BytesIO torch jit save sm buffer buffer seek torch jit load buffer Return InflatableArg contains tensor compressed image way decode keyword arguments img_tensor -- raw image tensor HWC NCHW pixel value type unsigned int NCHW format N should quality -- quality needed compress image bundle_jpeg_image img_tensor quality turn NCHW HWC img_tensor dim == assert img_tensor size == img_tensor = img_tensor permute pixels = img_tensor numpy encode_param = int cv IMWRITE_JPEG_QUALITY quality _ enc_img = cv imencode JPEG pixels encode_param enc_img_tensor = torch from_numpy enc_img enc_img_tensor = torch flatten enc_img_tensor byte obj = torch utils bundled_inputs InflatableArg enc_img_tensor torch ops fb decode_bundled_image obj get_tensor_from_raw_BGR im - torch Tensor raw_data = cv cvtColor im cv COLOR_BGR RGB raw_data = torch from_numpy raw_data float raw_data = raw_data permute raw_data = torch div raw_data unsqueeze raw_data TestBundledImages TestCase test_single_tensors SingleTensorModel torch nn Module forward arg arg im = cv imread caffe test test_img p jpg tensor = torch from_numpy im inflatable_arg = bundle_jpeg_image tensor input = inflatable_arg sm = torch jit script SingleTensorModel torch utils bundled_inputs augment_model_with_bundled_inputs sm input loaded = save_and_load sm inflated = loaded get_all_bundled_inputs decoded_data = inflated raw image raw_data = get_tensor_from_raw_BGR im assertEqual len inflated assertEqual len inflated assertEqual raw_data shape decoded_data shape assertEqual raw_data decoded_data atol= rtol= e- Check fb image_decode_to_NCHW works expected open caffe test test_img p jpg rb fp weight = torch full diag bias = torch zeros byte_tensor = torch tensor list fp read byte im _tensor = torch ops fb image_decode_to_NCHW byte_tensor weight bias assertEqual raw_data shape im _tensor shape assertEqual raw_data im _tensor atol= rtol= e- __name__ == __main__ raise RuntimeError This test currently used should enabled discover_tests py required
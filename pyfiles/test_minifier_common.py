Common utilities testing Dynamo s minifier functionality This module provides base infrastructure running minification tests Dynamo It includes - MinifierTestResult A dataclass storing processing minifier test results - MinifierTestBase A base test utilities - Running tests isolated environments - Managing temporary directories configurations - Executing minifier launcher scripts - Running validating reproduction scripts - Supporting both compile-time runtime error testing The minifier helps reduce failing Dynamo compilations minimal reproductions dataclasses io logging os re shutil subprocess sys tempfile traceback collections abc Sequence typing Any Optional Union unittest mock patch torch torch _dynamo torch _dynamo test_case torch _dynamo trace_rules _as_posix_path torch utils _traceback report_compile_source_on_error dataclasses dataclass MinifierTestResult minifier_code str repro_code str _get_module t str - str match = re search r Repro\ torch\ nn\ Module\ \s+ \n &#124; \n + t assert match None failed find module r = match group r = re sub r \s+$ \n r flags=re MULTILINE r = re sub r \n \n\n r r strip get_exported_program_path - Optional str Extract exported program file path AOTI minifier s repro py Regular expression pattern match file path pattern = r torch\ export\ load\ \s \ \ \s \ Search pattern text match = re search pattern repro_code Extract print file path match found match file_path = match group file_path None minifier_module - str _get_module minifier_code repro_module - str _get_module repro_code MinifierTestBase torch _dynamo test_case TestCase DEBUG_DIR = tempfile mkdtemp classmethod setUpClass cls - None super setUpClass os path exists cls DEBUG_DIR cls DEBUG_DIR = tempfile mkdtemp cls _exit_stack enter_context type ignore attr-defined torch _dynamo config patch debug_dir_root=cls DEBUG_DIR These configurations make new process startup slower Disable them minification tests speed them up cls _exit_stack enter_context type ignore attr-defined torch _inductor config patch https github com pytorch pytorch issues pattern_matcher False multiprocess compilation takes long time warmup compile_threads https github com pytorch pytorch issues cpp vec_isa_ok False classmethod tearDownClass cls - None os getenv PYTORCH_KEEP_TMPDIR = shutil rmtree cls DEBUG_DIR print f test_minifier_common tmpdir kept cls DEBUG_DIR cls _exit_stack close type ignore attr-defined _gen_codegen_fn_patch_code device str bug_type str - str assert bug_type compile_error runtime_error accuracy f \ torch _dynamo config codegen_config torch _inductor config codegen_config torch _inductor config cpp device == cpu triton inject_relu_bug_TESTING_ONLY = bug_type r _maybe_subprocess_run args Sequence Any isolate bool cwd Optional str = None - subprocess CompletedProcess bytes torch _inductor cpp_builder normalize_path_separator isolate assert len args = args assert args == python args args == -c assert len args == args code = args args = -c assert len args = args open args f Need normalize path code code = normalize_path_separator f read args = args WARNING This perfect simulation running program out tree We only interpose things we KNOW we need handle tests If you need more stuff you will need augment appropriately NB Can t use save_config because will omit some fields we must save reset ALL fields dynamo_config = torch _dynamo config get_config_copy inductor_config = torch _inductor config get_config_copy try stderr = io StringIO log_handler = logging StreamHandler stderr log = logging getLogger torch _dynamo log addHandler log_handler try prev_cwd = _as_posix_path os getcwd cwd None cwd = _as_posix_path cwd os chdir cwd patch sys argv args report_compile_source_on_error exec code __name__ __main__ __compile_source__ code rc = except Exception rc = traceback print_exc file=stderr finally log removeHandler log_handler cwd None os chdir prev_cwd type ignore possibly-undefined Make sure we don t leave buggy compiled frames lying around torch _dynamo reset finally torch _dynamo config load_config dynamo_config torch _inductor config load_config inductor_config TODO more appropriate data structure here subprocess CompletedProcess args rc b stderr getvalue encode utf- cwd None cwd = _as_posix_path cwd subprocess run args capture_output=True cwd=cwd check=False Run ` code ` separate python process Returns completed process state directory containing minifier launcher script ` code ` outputted _run_test_code code str isolate bool - tuple subprocess CompletedProcess bytes Union str Any proc = _maybe_subprocess_run python -c code isolate=isolate cwd=self DEBUG_DIR print test stdout proc stdout decode utf- print test stderr proc stderr decode utf- repro_dir_match = re search r \S+ minifier_launcher py proc stderr decode utf- repro_dir_match None proc repro_dir_match group proc None Runs minifier launcher script ` repro_dir ` _run_minifier_launcher repro_dir str isolate bool minifier_args Sequence Any = repro_after Optional str = None - tuple subprocess CompletedProcess bytes str assertIsNotNone repro_dir launch_file = _as_posix_path os path join repro_dir minifier_launcher py open launch_file f launch_code = f read assertTrue os path exists launch_file args = python launch_file minify minifier_args isolate repro_after = aot_inductor AOTI minifier doesn t have -- no-isolate flag Everything AOTI minifier no-isolate mode args append -- no-isolate launch_proc = _maybe_subprocess_run args isolate=isolate cwd=repro_dir print minifier stdout launch_proc stdout decode utf- stderr = launch_proc stderr decode utf- print minifier stderr stderr assertNotIn Input graph did fail tester stderr launch_proc launch_code Runs repro script ` repro_dir ` _run_repro repro_dir str isolate bool = True - tuple subprocess CompletedProcess bytes str assertIsNotNone repro_dir repro_file = _as_posix_path os path join repro_dir repro py open repro_file f repro_code = f read assertTrue os path exists repro_file repro_proc = _maybe_subprocess_run python repro_file isolate=isolate cwd=repro_dir print repro stdout repro_proc stdout decode utf- print repro stderr repro_proc stderr decode utf- repro_proc repro_code Template testing code ` run_code ` code run test case ` patch_code ` code patched every generated file usually just use turn bugs via config _gen_test_code run_code str repro_after str repro_level int - str repro_after_line = repro_after == aot_inductor repro_after_line = torch _inductor config aot_inductor dump_aoti_minifier = True repro_after repro_after_line = f \ torch _dynamo config repro_after = repro_after f \ torch torch _dynamo torch _inductor _as_posix_path torch _dynamo config codegen_config _as_posix_path torch _inductor config codegen_config repro_after_line torch _dynamo config repro_level = repro_level torch _inductor config aot_inductor repro_level = repro_level torch _dynamo config debug_dir_root = _as_posix_path DEBUG_DIR run_code Runs full minifier test Minifier tests generally consist stages Run problematic code Run generated minifier launcher script Run generated repro script If possible you should run test isolate=False use isolate=True only bug you re testing would otherwise crash process _run_full_test run_code str repro_after str expected_error Optional str isolate bool minifier_args Sequence Any = - Optional MinifierTestResult isolate repro_level = expected_error None expected_error == AccuracyError repro_level = repro_level = test_code = _gen_test_code run_code repro_after repro_level print running test file=sys stderr test_proc repro_dir = _run_test_code test_code isolate=isolate expected_error None Just check there no error assertEqual test_proc returncode assertIsNone repro_dir None NB Intentionally do test code we only care about actually generating repro we don t have crash assertIn expected_error test_proc stderr decode utf- assertIsNotNone repro_dir print running minifier file=sys stderr _minifier_proc minifier_code = _run_minifier_launcher repro_dir isolate=isolate minifier_args=minifier_args repro_after=repro_after print running repro file=sys stderr repro_proc repro_code = _run_repro repro_dir isolate=isolate assertIn expected_error repro_proc stderr decode utf- assertNotEqual repro_proc returncode MinifierTestResult minifier_code=minifier_code repro_code=repro_code
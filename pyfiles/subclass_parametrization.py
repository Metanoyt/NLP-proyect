dataclasses itertools collections abc Iterable typing Any Union torch torch utils _python_dispatch is_traceable_wrapper_subclass This technically very similar SubclassCreatingMeta aot_autograd we don t need all stuff there so just recreated new dataclass dataclasses dataclass SubclassCreationMeta start_idx int num_tensors int class_type Any attrs dict str SubclassCreationMeta metadata Any outer_size Iterable Union None int torch SymInt outer_stride Iterable Union None int torch SymInt UnwrapTensorSubclass torch nn Module forward tensors - torch Tensor type ignore no-untyped-def todo list torch Tensor = list tensors _unwrap_tensor_subclasses subclass_meta tensors offset type ignore no-untyped-def subclass_meta None tensors offset offset + inner_tensors = attr meta subclass_meta attrs items built_tensor offset = _unwrap_tensor_subclasses meta tensors offset inner_tensors attr = built_tensor rebuilt = subclass_meta class_type __tensor_unflatten__ inner_tensors subclass_meta metadata subclass_meta outer_size subclass_meta outer_stride rebuilt offset _unwrap_tensor_subclasses subclass_meta todo right_inverse tensor torch Tensor - list torch Tensor assert type tensor torch Tensor plain_tensors list torch Tensor = _create_subclass_meta tensor idx plain_tensor_container type ignore no-untyped-def type tensor torch Tensor plain_tensor_container append tensor None idx + inner_tensors_attrnames metadata = tensor __tensor_flatten__ type ignore attr-defined new_idx = idx attr_to_meta = attr inner_tensors_attrnames val = getattr tensor attr subclass_meta new_idx = _create_subclass_meta val new_idx plain_tensor_container attr_to_meta attr = subclass_meta SubclassCreationMeta start_idx=idx num_tensors=new_idx - idx class_type=type tensor attrs=attr_to_meta metadata=metadata outer_size=tensor size outer_stride=tensor stride new_idx subclass_meta = _create_subclass_meta tensor plain_tensors plain_tensors unwrap_tensor_subclass_parameters module torch nn Module - torch nn Module Model transformation replaces all parameters subclasses plain tensors This reduces runtime overhead flattening unflattening parameters This transformation adds parametrization ` torch nn utils parametrize ` The FQNs subclass parameters will changed state_dict will become incompatible original model E g Original model state_dict p torch testing _internal TwoTensor becomes parametrizations p original torch Tensor parametrizations p original torch Tensor name tensor itertools chain list module named_parameters recurse=False pyrefly ignore no-matching-overload list module named_buffers recurse=False is_traceable_wrapper_subclass tensor torch nn utils parametrize register_parametrization module name UnwrapTensorSubclass child module children unwrap_tensor_subclass_parameters child module
mypy allow-untyped-defs os collections defaultdict pathlib Path typing Any Union typing_extensions deprecated try torchgen api python format_function_signature torchgen utils FileManager except ImportError sys REPO_ROOT = Path __file__ absolute parents sys path insert str REPO_ROOT torchgen api python format_function_signature torchgen utils FileManager len sys path sys path == str REPO_ROOT del sys path __all__ list str = intended expose any symbols __dir__ - list str appease public API test deprecated ` torch utils data datapipes gen_pyi materialize_lines ` deprecated will removed future category=FutureWarning materialize_lines lines list str indentation int - str output = new_line_with_indent = \n + indentation i line enumerate lines i = output += new_line_with_indent output += line replace \n new_line_with_indent output deprecated ` torch utils data datapipes gen_pyi gen_from_template ` deprecated will removed future category=FutureWarning gen_from_template dir str template_name str output_name str replacements list tuple str Any int template_path = os path join dir template_name output_path = os path join dir output_name open template_path encoding= utf- f content = f read placeholder lines indentation replacements open output_path w encoding= utf- f content = content replace placeholder materialize_lines lines indentation f write content find_file_paths dir_paths list str files_to_exclude set str - set str When given path directory returns paths relevant files within This function does NOT recursive traverse subdirectories paths set str = set dir_path dir_paths all_files = os listdir dir_path python_files = fname fname all_files py == fname - filter_files = fname fname python_files fname files_to_exclude paths update os path join dir_path fname fname filter_files paths extract_method_name line str - str Extract method name decorator form functional_datapipe method_name line start_token end_token = line start_token end_token = raise RuntimeError f Unable find appropriate method name within line \n line start end = line find start_token + len start_token line find end_token line start end extract_class_name line str - str Extract name definition form CLASS_NAME Type start_token = end_token = start end = line find start_token + len start_token line find end_token line start end parse_datapipe_file file_path str - tuple dict str list str dict str str set str dict str list str Given path file parses file returns dictionary method names function signatures method_to_signature method_to_class_name special_output_type = set doc_string_dict = defaultdict list open file_path encoding= utf- f open_paren_count = method_name class_name signature = skip = False line f line count == skip = skip skip line Saving docstrings doc_string_dict method_name append line continue functional_datapipe line method_name = extract_method_name line doc_string_dict method_name = continue method_name line class_name = extract_class_name line continue method_name __init__ line __new__ line __new__ line special_output_type add method_name open_paren_count += start = line find + len line = line start open_paren_count open_paren_count += line count open_paren_count -= line count open_paren_count == end = line rfind signature += line end method_to_signature method_name = process_signature signature method_to_class_name method_name = class_name method_name class_name signature = open_paren_count raise RuntimeError open parenthesis count This shouldn t possible signature += line strip method_to_signature method_to_class_name special_output_type doc_string_dict parse_datapipe_files file_paths set str - tuple dict str list str dict str str set str dict str list str methods_and_signatures = methods_and_class_names = methods_with_special_output_types = set methods_and_doc_strings = path file_paths method_to_signature method_to_class_name methods_needing_special_output_types doc_string_dict = parse_datapipe_file path methods_and_signatures update method_to_signature methods_and_class_names update method_to_class_name methods_with_special_output_types update methods_needing_special_output_types methods_and_doc_strings update doc_string_dict methods_and_signatures methods_and_class_names methods_with_special_output_types methods_and_doc_strings split_outside_bracket line str delimiter str = - list str Given line text split comma unless comma within bracket bracket_count = curr_token = res = char line char == bracket_count += char == bracket_count -= char == delimiter bracket_count == res append curr_token curr_token = continue curr_token += char res append curr_token res process_signature line str - list str Clean up given raw function signature This includes removing self-referential datapipe argument default arguments input functions newlines spaces tokens list str = split_outside_bracket line i token enumerate tokens tokens i = token strip token == cls tokens i = i == tokens i - tokens i = Remove datapipe after cls unless has tokens i = Callable = token Remove default argument function head = token rpartition = tokens i = head strip + = tokens = t t tokens t = tokens get_method_definitions file_path Union str list str files_to_exclude set str deprecated_files set str default_output_type str method_to_special_output_type dict str str root str = - list str pyi generation functional DataPipes Process Find files we want process exclude ones who don t Parse method name signature Remove first argument after unless datapipes default args spaces root == root = str Path __file__ parent resolve file_path = file_path isinstance file_path str file_path file_path = os path join root path path file_path file_paths = find_file_paths file_path files_to_exclude=files_to_exclude union deprecated_files methods_and_signatures methods_and_class_names methods_w_special_output_types methods_and_doc_strings = parse_datapipe_files file_paths fn_name method_to_special_output_type fn_name methods_w_special_output_types methods_w_special_output_types add fn_name method_definitions = method_name arguments methods_and_signatures items class_name = methods_and_class_names method_name method_name methods_w_special_output_types output_type = method_to_special_output_type method_name output_type = default_output_type doc_string = join methods_and_doc_strings method_name doc_string == doc_string = doc_string = \n + doc_string definition = format_function_signature method_name arguments output_type method_definitions append f Functional form class_name \n + definition removesuffix rstrip remove + doc_string method_definitions sort key=lambda s s split \n sorting based method_name method_definitions Defined outside main so they can imported TorchData iterDP_file_path str = iter iterDP_files_to_exclude set str = __init__ py utils py iterDP_deprecated_files set str = set iterDP_method_to_special_output_type dict str str = demux list IterDataPipe fork list IterDataPipe mapDP_file_path str = map mapDP_files_to_exclude set str = __init__ py utils py mapDP_deprecated_files set str = set mapDP_method_to_special_output_type dict str str = shuffle IterDataPipe main - None Inject file into template datapipe pyi TODO The current implementation script only generates interfaces built-in methods To generate interface user-defined DataPipes consider changing ` IterDataPipe register_datapipe_as_function ` iter_method_definitions = get_method_definitions iterDP_file_path iterDP_files_to_exclude iterDP_deprecated_files IterDataPipe iterDP_method_to_special_output_type map_method_definitions = get_method_definitions mapDP_file_path mapDP_files_to_exclude mapDP_deprecated_files MapDataPipe mapDP_method_to_special_output_type path = Path __file__ absolute parent fm = FileManager install_dir=path template_dir=path dry_run=False fm write_with_template datapipe pyi datapipe pyi lambda IterDataPipeMethods iter_method_definitions MapDataPipeMethods map_method_definitions __name__ == __main__ main
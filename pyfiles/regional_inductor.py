mypy allow-untyped-defs functools logging torch torch fx _compatibility compatibility logger = logging getLogger __name__ __all__ = regional_inductor standalone_inductor returns callable object - does sit well Fx graph node op call_function which expects function So just wrapper function make Fx graph codegen happy _dummy_wrapper fn functools wraps fn inner args kwargs fn args kwargs inner _partition_by_supported_nodes gm supported_ops prefix torch fx passes infra partitioner CapabilityBasedPartitioner torch fx passes utils fuser_utils fuse_by_partitions partitioner = CapabilityBasedPartitioner gm supported_ops allows_single_node_partition=True candidate_partitions = partitioner propose_partitions partitioned_gm = fuse_by_partitions partitioner graph_module partition nodes partition candidate_partitions prefix=prefix always_return_tuple=True partitioned_gm _compile_submod gm prefix torch _inductor standalone_compile AOTCompiledArtifact node gm graph nodes node op == call_module node target startswith prefix fake_inputs = inp_node node all_input_nodes hasattr inp_node meta val inp_node meta fake_inputs append inp_node meta val raise RuntimeError f Partition bad because non fake tensor value seen inp_node submod = getattr gm node target Get inductor configs annotation TODO we should change partition when there multiple differently annotated regions inductor_options = sub_node submod graph nodes hasattr sub_node meta sub_node meta get custom None custom = sub_node meta custom isinstance custom dict compile_with_inductor custom compile_value = custom compile_with_inductor isinstance compile_value dict inductor_configs compile_value inductor_options = compile_value inductor_configs break Log options being used logger info Compiling submodule s inductor options s node target inductor_options Apply config patches before compilation torch _inductor config inductor_config Validate all config keys exist key inductor_options hasattr inductor_config key raise ValueError f Invalid inductor config key key regional_inductor annotation f Available config keys can found torch _inductor config inductor_config patch inductor_options compiled_fn = torch _inductor standalone_compile submod fake_inputs dynamic_shapes= from_tracing_context aot=True assert isinstance compiled_fn AOTCompiledArtifact _dummy_wrapper make call_function happy compiled_submod = _dummy_wrapper compiled_fn gm graph inserting_after node new_node = gm graph call_function compiled_submod args=node args kwargs=node kwargs new_node meta = node meta node replace_all_uses_with new_node gm graph erase_node node del gm _modules node target gm recompile gm _needs_inductor_compile node node op placeholder output hasattr node meta node meta get custom None compile_with_inductor node meta custom _compile_fx_annotated_nodes_with_inductor gm torch fx passes operator_support OperatorSupport found_marked_node = False node gm graph nodes _needs_inductor_compile node found_marked_node = True break found_marked_node logger info No inductor marked nodes found gm InductorMarkedNodes OperatorSupport is_node_supported submodules node torch fx Node - bool _needs_inductor_compile node marked_nodes = InductorMarkedNodes gm = _partition_by_supported_nodes gm marked_nodes __marked_inductor_submod gm = _compile_submod gm __marked_inductor_submod gm _recursive_compile_fx_annotated_nodes_with_inductor gm node gm graph find_nodes op= get_attr _needs_inductor_compile node If get_attr itself marked compile outer graph will take care If we dont do we end up nested regional inductor compiles do work well continue submod = getattr gm node target isinstance submod torch fx GraphModule _recursive_compile_fx_annotated_nodes_with_inductor submod _compile_fx_annotated_nodes_with_inductor gm compatibility is_backward_compatible=False regional_inductor gm example_args Scoops out inductor marked regions compiles them inductor Inductor options should provided via annotation API fx_traceback annotate compile_with_inductor inductor_configs max_autotune True triton cudagraphs False fuser utils create new nodes using create_proxy which retains seq_nr metadata cause issues torch fx traceback preserve_node_meta enable=False _recursive_compile_fx_annotated_nodes_with_inductor gm
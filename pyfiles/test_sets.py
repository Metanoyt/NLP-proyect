Owner s module dynamo TODO move set tests test_functions py test_misc py file math unittest collections abc Iterable torch torch _dynamo test_case torch _dynamo exc Unsupported torch _dynamo testing CompileCounter torch testing _internal common_utils make_dynamo_test munge_exc torch testing _internal logging_utils LoggingTestCase make_logging_test SetSubclass set pass FrozenstSubclass frozenset pass _BaseSetTests torch _dynamo test_case TestCase setUp old = torch _dynamo config enable_trace_unittest torch _dynamo config enable_trace_unittest = True super setUp tearDown torch _dynamo config enable_trace_unittest = old super tearDown assertEqual b assertTrue == b f = b assertNotEqual b assertTrue = b f == b CustomSetTests _BaseSetTests CustomSet set add item super add item + contains item True thetype = CustomSet make_dynamo_test test_custom_add s = thetype s add assertTrue s == make_dynamo_test test_custom_contains s = thetype assertTrue s contains MiscTests torch _dynamo test_case TestCase test_isdisjoint_with_generator n = gen nonlocal n n += yield n += yield n += yield torch compile backend= eager fullgraph=True fn x nonlocal n s = s isdisjoint gen n == x sin x cos x = torch randn y = fn x assertEqual y x sin TestSetGuards LoggingTestCase test_set_with_function s = torch _C _set_grad_enabled hello torch amp _exit_autocast cnts = CompileCounter torch compile backend=cnts fullgraph=True fn x s torch amp _exit_autocast s x sin x cos x = torch randn y = fn x s assertEqual y x sin assertEqual cnts frame_count s remove torch amp _exit_autocast s add torch _C _set_fwd_grad_enabled y = fn x s assertEqual y x cos assertEqual cnts frame_count make_logging_test recompiles=True test_in_guard records s = Dynamo Inductor PyTorch torch sin cnts = CompileCounter torch compile backend=cnts fullgraph=True fn x s PyTorch s x sin x cos x = torch randn y = fn x s assertEqual y x sin assertEqual cnts frame_count s remove PyTorch s add Cuda y = fn x s assertEqual y x cos assertEqual cnts frame_count assertGreater len records record = getRecord records set __contains__ assertIn set __contains__ s PyTorch munge_exc record getMessage test_set_with_tensors s = torch ones torch tensor torch zeros cnts = CompileCounter torch compile backend=cnts fullgraph=True fn x s z = torch zeros i s z += i x + z x = torch tensor assertExpectedInlineMunged Unsupported lambda fn x s \ Attempted wrap set tensors Explanation Dynamo cannot trace sets tensors To get stable ordering Dynamo needs convert set into list order might stable set contains tensors Hint Use dictionary where keys tensors Hint It may possible write Dynamo tracing rules code Please report issue PyTorch you encounter graph break often causing performance issues Developer debug context Python set containing torch Tensor elements For more details about graph break please visit https meta-pytorch github io compile-graph-break-site gb gb html user code File test_sets py line N fn i s noqa B test_set_multiple_types s = PyTorch j math nan cnts = CompileCounter torch compile backend=cnts fullgraph=True fn x s PyTorch s x sin x cos x = torch tensor y = fn x s assertEqual y x sin assertEqual cnts frame_count s remove PyTorch y = fn x s assertEqual y x cos assertEqual cnts frame_count test_set_recompile_on_key_pop s = torch _C _set_grad_enabled torch amp _enter_autocast torch amp _exit_autocast cnts = CompileCounter fn x s torch amp _exit_autocast s x sin x cos x = torch randn opt_fn = torch compile fn backend=cnts fullgraph=True res = opt_fn x s opt_fn x s assertEqual res fn x s No recompilation assertEqual cnts frame_count Pop value s remove torch amp _exit_autocast res = opt_fn x s Check recompilation assertEqual cnts frame_count assertEqual res fn x s test_set_recompile_on_key_change s = torch _C _set_grad_enabled torch amp _enter_autocast torch amp _exit_autocast cnts = CompileCounter fn x s torch amp _exit_autocast s x sin x cos x = torch randn opt_fn = torch compile fn backend=cnts fullgraph=True res = opt_fn x s opt_fn x s assertEqual res fn x s No recompilation assertEqual cnts frame_count Pop value s remove torch amp _exit_autocast Add different value s add torch _C _set_autograd_fallback_mode res = opt_fn x s Check recompilation assertEqual cnts frame_count assertEqual res fn x s unittest skip random failures Python test_set_guard_on_keys_change This test guarantee we re triggering any dict guards sets s = torch _C _set_grad_enabled torch amp _enter_autocast torch amp _exit_autocast cnts = CompileCounter fn x s e s x = x len str e x opt_fn = torch compile fn backend=cnts fullgraph=True opt_fn torch randn s opt_fn torch randn s No recompilation assertEqual cnts frame_count pop add same item s remove torch amp _exit_autocast It guaranteed _exit_autocast will specific order s add torch amp _exit_autocast x = torch randn res = opt_fn x s Check Dynamo don t recompile assertEqual cnts frame_count assertEqual res fn x s _FrozensetBase Frozenset methods + copy + difference + intersection + isdisjoint + issubset + issuperset + symmetric_difference + union BinOps + - &#124; ^ = = == = make_dynamo_test test_binop_sub p q = map thetype abc bef assertEqual p - p thetype assertEqual p - q thetype ac assertEqual q - p thetype ef assertRaises TypeError lambda p - assertEqual thetype __sub__ p q set ac make_dynamo_test test_binop_or p q = map thetype abc bef assertEqual p &#124; p thetype abc assertEqual p &#124; q thetype abcef assertEqual thetype __or__ p q set abcef make_dynamo_test test_binop_and p q = map thetype abc bef assertEqual p p thetype abc assertEqual p q thetype b assertEqual thetype __and__ p q set b make_dynamo_test test_binop_xor p q = map thetype abc bef assertEqual p ^ p thetype assertEqual p ^ q thetype acef assertEqual thetype __xor__ p q set acef make_dynamo_test test_cmp_eq p = thetype abc assertEqual p p C set frozenset SetSubclass assertEqual p C abc assertEqual p C p assertTrue thetype __eq__ p p make_dynamo_test test_cmp_ne p q = map thetype abc bef assertNotEqual p q assertNotEqual q p C set frozenset SetSubclass dict fromkeys str list tuple assertNotEqual p C abe assertNotEqual p assertTrue thetype __ne__ p q make_dynamo_test test_cmp_less_than p q r = map thetype abc bef ab assertFalse p p assertFalse p q assertTrue r p assertFalse r q assertFalse thetype __lt__ p p make_dynamo_test test_cmp_greater_than p q r = map thetype abc bef ab assertFalse p p assertFalse p q assertTrue p r assertFalse q r assertFalse thetype __gt__ p p make_dynamo_test test_cmp_less_than_or_equal p q r = map thetype abc bef ab assertTrue p = p assertFalse p = q assertTrue r = p assertFalse r = q assertTrue thetype __le__ p p make_dynamo_test test_cmp_greater_than_or_equal p q r = map thetype abc bef ab assertTrue p = p assertFalse p = q assertTrue p = r assertFalse q = r assertTrue thetype __ge__ p p make_dynamo_test test_copy p = thetype abc q = p copy assertEqual p q assertRaises TypeError p copy assertEqual thetype copy p p make_dynamo_test test_issubset p q r = map thetype abc bc bef assertTrue q issubset p assertFalse r issubset p assertRaises TypeError p issubset assertRaises TypeError p issubset assertRaises TypeError p issubset assertTrue thetype issubset q p make_dynamo_test test_issuperset p q r = map thetype abc bc bef assertTrue p issuperset q assertFalse p issuperset r assertRaises TypeError p issuperset assertRaises TypeError p issuperset assertRaises TypeError p issuperset assertTrue thetype issuperset p q make_dynamo_test test_constructor_iterable p = thetype abc assertIsInstance p thetype assertIsInstance p Iterable make_dynamo_test test_equality = thetype abc typ thetype set frozenset assertEqual typ assertTrue == typ assertTrue __eq__ typ assertTrue thetype __eq__ typ make_dynamo_test test_in_frozenset item = thetype abc container = thetype frozenset abc noqa C assertIn item container make_dynamo_test test_contains s = thetype b c assertIn s assertNotIn d s assertTrue s __contains__ assertTrue thetype __contains__ s b make_dynamo_test test_isdisjoint x = thetype apple banana cherry y = thetype google microsoft apple z = thetype shoes flipflops sneakers assertFalse x isdisjoint y assertTrue x isdisjoint z assertRaises TypeError x isdisjoint assertRaises TypeError x isdisjoint assertRaises TypeError x isdisjoint p q = map thetype abc bef assertFalse thetype isdisjoint p q make_dynamo_test test_intersection set = thetype apple banana cherry set = thetype google microsoft apple set = thetype shoes flipflops apple intersection_set = set intersection set set assertEqual intersection_set apple assertRaises TypeError set intersection assertRaises TypeError set intersection p q = map thetype abc bef assertEqual thetype intersection p q b make_dynamo_test test_union p q r = map thetype abc bc bef union_set = p union q r assertEqual union_set b c e f assertRaises TypeError p union assertRaises TypeError p union s = thetype union q r assertEqual s b c e f make_dynamo_test test_difference set = thetype apple banana cherry set = thetype google microsoft apple set = thetype shoes flipflops sneakers difference_set = set difference set set assertEqual difference_set banana cherry assertRaises TypeError set difference assertRaises TypeError set difference p q = map thetype abc bef assertEqual thetype difference p q c make_dynamo_test test_symmetric_difference set = thetype apple banana cherry set = thetype google microsoft apple symmetric_diff_set = set difference set assertEqual symmetric_diff_set banana cherry assertRaises TypeError set symmetric_difference assertRaises TypeError set symmetric_difference assertRaises TypeError set symmetric_difference p q = map thetype abc bef symmetric_diff_set = thetype symmetric_difference p q assertEqual symmetric_diff_set c e f make_dynamo_test test_to_frozenset set = frozenset thetype apple banana cherry assertIsInstance set frozenset assertEqual len set make_dynamo_test test_to_set set = frozenset thetype apple banana cherry assertIsInstance set frozenset assertEqual len set _SetBase _FrozensetBase Set Methods + add + clear - copy inherited frozenset - difference inherited frozenset + difference_update + discard - intersection inherited frozenset + intersection_update - isdisjoint inherited frozenset - issubset inherited frozenset - issuperset inherited frozenset + pop + remove - symmetric_difference inherited frozenset + symmetric_difference_update - union inherited frozenset + update make_dynamo_test test_add p = thetype abc p add d assertEqual p b c d p add assertEqual p b c d assertRaises TypeError p add ab assertRaises TypeError p add set add p e assertEqual p b c d e make_dynamo_test test_clear p = thetype abc p clear assertEqual p set p = thetype abc thetype clear p assertEqual len p make_dynamo_test test_remove p = thetype abc assertEqual p remove None assertEqual p b c assertRaises KeyError p remove p = thetype abc thetype remove p b assertEqual p thetype c make_dynamo_test test_intersection_update set = thetype apple banana cherry set = thetype google microsoft apple set = thetype shoes flipflops apple assertIsNone set intersection_update set set assertEqual set apple assertRaises TypeError set intersection_update p q = map thetype abc bef thetype intersection_update p q assertEqual p b make_dynamo_test test_difference_update set = thetype apple banana cherry set = thetype google microsoft apple set = thetype shoes flipflops sneakers assertIsNone set difference_update set set assertEqual set banana cherry assertRaises TypeError set difference_update p q = map thetype abc bef thetype difference_update p q assertEqual p c make_dynamo_test test_symmetric_difference_update set = thetype apple banana cherry set = thetype google microsoft apple assertIsNone set symmetric_difference_update set assertEqual set banana cherry google microsoft assertRaises TypeError set symmetric_difference_update assertRaises TypeError set symmetric_difference_update p q = map thetype abc bef thetype symmetric_difference_update p q assertEqual p c e f make_dynamo_test test_pop set = thetype apple banana cherry e = set pop assertNotIn e set s = thetype assertRaises KeyError s pop p = thetype assertEqual thetype pop p make_dynamo_test test_update p q r = map thetype abc bc bef p update q r assertEqual p b c e f assertRaises TypeError p update thetype update q r assertEqual q b c e f make_dynamo_test test_discard set = thetype apple banana cherry set = thetype google microsoft apple set discard banana set discard cherry assertEqual set apple cherry assertEqual set google microsoft apple p = thetype abc thetype discard p assertEqual p b c FrozensetTests _FrozensetBase _BaseSetTests thetype = frozenset SetTests _SetBase _BaseSetTests thetype = set test_in_frozenset super test_in_frozenset UserDefinedSetTests _SetBase _BaseSetTests CustomSet set pass thetype = CustomSet test_in_frozenset super test_in_frozenset test_equality super test_equality UserDefinedFrozensetTests _FrozensetBase _BaseSetTests CustomFrozenset frozenset pass thetype = CustomFrozenset test_in_frozenset super test_in_frozenset __name__ == __main__ torch _dynamo test_case run_tests run_tests
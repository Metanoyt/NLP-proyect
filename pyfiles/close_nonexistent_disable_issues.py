argparse json multiprocessing mp os re sys tempfile pathlib Path typing Any requests gitutils retries_decorator REPO_ROOT = Path __file__ resolve parent parent parent sys path insert str REPO_ROOT tools testing clickhouse query_clickhouse sys path pop LOGS_QUERY = shas SELECT distinct push head_commit id sha FROM -- Not bothering final here default push WHERE push ref = refs heads viable strict AND push repository full_name = pytorch pytorch ORDER BY push head_commit timestamp desc LIMIT select id name default workflow_job j final join shas shas sha = j head_sha where j id select id materialized_views workflow_job_by_head_sha where head_sha select sha shas j name like test j name like rerun_disabled_tests j name like mem_leak_check TEST_EXISTS_QUERY = select name default test_run_s where name String like name String classname like classname String time_inserted CURRENT_TIMESTAMP - INTERVAL DAY limit CLOSING_COMMENT = I cannot find any mention test database past days logs past commits viable strict Closing issue highly likely test has either been renamed removed If you think false positive please feel free re-open issue DISABLED_TESTS_JSON = https ossci-metrics s amazonaws com disabled-tests-condensed json retries_decorator query_db query str params dict str Any - list dict str Any query_clickhouse query params parse_args - Any parser = argparse ArgumentParser parser add_argument -- dry-run action= store_true help= Only list tests parser parse_args download_log_worker temp_dir str id int name str - None url = f https ossci-raw-job-status s amazonaws com log id data = requests get url text open f temp_dir name replace _ id txt x f f write data printer item tuple str tuple int str list Any extra str - None test _ link _ = item print f link test extra close_issue num int - None headers = Accept application vnd github v +json Authorization f token os environ GITHUB_TOKEN response = requests post f https api github com repos pytorch pytorch issues num comments data=json dumps body CLOSING_COMMENT headers=headers response status_code = raise RuntimeError f Failed comment issue num response text response = requests patch f https api github com repos pytorch pytorch issues num data=json dumps state closed headers=headers response status_code = raise RuntimeError f Failed close issue num response text check_if_exists item tuple str tuple int str list str all_logs list str - tuple bool str test _ link _ = item Test names should look like ` test_a module path classname ` reg = re match r \S+ \ \S \ test reg None False poorly formed name = reg classname = reg split - Check there any mention link test name logs The link usually shows up skip reason present = False log all_logs link log present = True break f classname name log present = True break present True found logs Query DB see test there count = query_db TEST_EXISTS_QUERY name f name classname f classname len count == False found True found DB __name__ == __main__ args = parse_args disabled_tests_json = json loads requests get DISABLED_TESTS_JSON text all_logs = jobs = query_db LOGS_QUERY tempfile TemporaryDirectory temp_dir pool = mp Pool job jobs id = job id name = job name pool apply_async download_log_worker args= temp_dir id name pool close pool join filename os listdir temp_dir open f temp_dir filename f all_logs append f read If its less than something definitely went wrong assert len all_logs assert len all_logs == len jobs to_be_closed = item disabled_tests_json items exists reason = check_if_exists item all_logs printer item reason exists to_be_closed append item print f There len to_be_closed issues will closed item to_be_closed printer item args dry_run print dry run actually closing failed = False item to_be_closed _ num _ _ = item try close_issue num except RuntimeError e print e failed = True failed sys exit
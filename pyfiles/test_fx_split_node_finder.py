Owner s module fx pyre-strict os shutil sys tempfile torch torch fx passes operator_support OperatorSupportBase torch fx passes splitter_base ALL_SUFFIX ENV_FX_NET_ACC_SPLITTER_TRACKER_TRACKED_NODES FxNetAccNodesFinder NodeEventTracker NODES_SUFFIX ShapeProp torch testing _internal common_utils TestCase Wrappepr function make supported torch fx wrap sup_f x x TestFxSplitNodeFinder TestCase setUp save_path = sys path tmpdir = tempfile mkdtemp sys path insert tmpdir tearDown sys path = save_path shutil rmtree tmpdir ignore_errors=True _testTrackerBasics tracker Test basic functionalities tracker putting into node finder examine events generated after finder called getEvents tracker node tracker events idx idx tracker node_events node name IsNodeSupported OperatorSupportBase is_node_supported submodules node torch fx Node - bool sup_ node name TestModule torch nn Module forward x y x = sup_f x y = sup_f y b = x + y non-supported break graph sup_f b gm = torch fx symbolic_trace TestModule ShapeProp gm propagate torch rand finder = FxNetAccNodesFinder gm IsNodeSupported False finder tracker = tracker acc_nodes = finder check acc nodes events expected node gm graph nodes node name == sup_f_ node should removed acc nodes assertFalse node acc_nodes events = getEvents tracker node events assertEqual len events st event init_acc supported operator assertTrue events desc startswith init_acc &#124; callable_and_operator_supported nd event del_acc non-tensor output cpu user assertTrue events desc startswith acc_del &#124; non_tensor_output_with_cpu_user node name startswith sup_f other supported nodes should remain acc nodes assertTrue node acc_nodes events = getEvents tracker node assertEqual len events assertTrue events desc startswith init_acc &#124; callable_and_operator_supported other nodes cpu assertFalse node acc_nodes _validate_file_content filepath expected_lines Validate content file Args filepath path file validated expected_lines expected lines file Returns None open filepath f idx = line f assertEqual line rstrip \n expected_lines idx idx += assertTrue idx = len expected_lines assertEqual idx len expected_lines _assert_events_file events_file _validate_file_content events_file Node x x init_cpu &#124; not_callable Node y y init_cpu &#124; not_callable Node sup_f sup_f init_acc &#124; callable_and_operator_supported Node sup_f_ sup_f_ init_acc &#124; callable_and_operator_supported sup_f_ acc_del &#124; non_tensor_output_with_cpu_user add Node add add init_cpu &#124; operator_support Node sup_f_ sup_f_ init_acc &#124; callable_and_operator_supported Node output output init_cpu &#124; not_callable _testTrackerMode mode Test tracker different modes Args mode mode tested - no local dump - dump all events file - dump specific nodes recursive manner - dump all nodes more than event recursive manner tmp_dump_base_path = tmpdir + + str mode tracker = NodeEventTracker mode mode just enable tracker without dumping tmp_dump_base_path dump path events_file = tmp_dump_base_path + ALL_SUFFIX nodes_file = tmp_dump_base_path + NODES_SUFFIX assertFalse os path exists events_file assertFalse os path exists nodes_file _testTrackerBasics tracker mode == Make sure there no files dumped assertFalse os path exists events_file assertFalse os path exists nodes_file mode == _assert_events_file events_file assertFalse os path exists nodes_file mode == _assert_events_file events_file _validate_file_content nodes_file &#124; -sup_f_ init_acc &#124; callable_and_operator_supported mode == _assert_events_file events_file _validate_file_content nodes_file &#124; -sup_f_ init_acc &#124; callable_and_operator_supported &#124; -sup_f_ acc_del &#124; non_tensor_output_with_cpu_user add &#124; &#124; -add init_cpu &#124; operator_support testMode _testTrackerMode testMode _testTrackerMode testMode os environ ENV_FX_NET_ACC_SPLITTER_TRACKER_TRACKED_NODES = sup_f_ _testTrackerMode testMode _testTrackerMode
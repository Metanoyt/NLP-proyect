Owner s module dynamo typing Optional torch torch _dynamo test_case torch _dynamo testing torch _dynamo testing same try utils except ImportError utils Pair noqa B __init__ x y x = x y = y Foo Pair g_counter = g_list = g_dict = b g_object = Foo g_tensor = torch zeros _name int = fresh_name - str create new unique name variable v v v global _name r = f v _name _name += r reset_name global _name _name = TestGlobals torch _dynamo test_case TestCase test_store_global_ fn x global g_counter val = x + g_counter g_counter += val x = torch randn cnts = torch _dynamo testing CompileCounter opt_fn = torch compile fn backend=cnts res = opt_fn x res = fn x assertTrue same res - res torch ones test_store_global_ fn x global g_counter val = x + g_counter g_counter += g_counter += val x = torch randn cnts = torch _dynamo testing CompileCounter opt_fn = torch compile fn backend=cnts res = opt_fn x Wrap second call torch _dynamo well opt_fn = torch compile fn backend=cnts res = opt_fn x assertTrue same res - res torch ones test_store_global_new fn x Test create new global global g_counter_new g_counter_new = x + x + g_counter_new x = torch randn cnts = torch _dynamo testing CompileCounter opt_fn = torch compile fn backend=cnts res = opt_fn x assertTrue same res x + x + test_store_global_list fn x global g_list val = x + g_list Strictly speaking we testing STORE_GLOBAL here since STORE_SUBSCR actually used store g_list += val x = torch randn cnts = torch _dynamo testing CompileCounter opt_fn = torch compile fn backend=cnts res = opt_fn x res = fn x assertTrue same res - res torch ones test_store_global_list_ fn x global g_list val = x + g_list g_list = x + x g_list val x = torch randn cnts = torch _dynamo testing CompileCounter opt_fn = torch compile fn backend=cnts res = opt_fn x res = fn x assertTrue same res - res torch ones test_store_global_dict fn x global g_dict val = x + g_dict b Strictly speaking we testing STORE_GLOBAL here since STORE_SUBSCR actually used store g_dict b += val x = torch randn cnts = torch _dynamo testing CompileCounter opt_fn = torch compile fn backend=cnts res = opt_fn x res = fn x assertTrue same res - res torch ones test_store_global_dict_ fn x global g_dict g_dict = key value + key value g_dict items val = x + g_dict b val x = torch randn cnts = torch _dynamo testing CompileCounter opt_fn = torch compile fn backend=cnts res = opt_fn x res = fn x assertTrue same res - res torch ones test_store_global_object fn x global g_object val = x + g_object y g_object y += val x = torch randn cnts = torch _dynamo testing CompileCounter opt_fn = torch compile fn backend=cnts res = opt_fn x res = fn x assertTrue same res - res torch ones test_store_global_cross_file fn x val = x + utils g_tensor_export utils g_tensor_export = utils g_tensor_export + val x = torch randn cnts = torch _dynamo testing CompileCounter opt_fn = torch compile fn backend=cnts res = opt_fn x res = fn x assertTrue same res - res torch ones test_store_global_inline_ Borrowed test_python_autograd py Variable __init__ value torch Tensor name Optional str = None value = value name = name fresh_name fn b = Variable b = Variable b value + b value name + b name = torch randn b = torch randn cnts = torch _dynamo testing CompileCounter opt_fn = torch compile fn backend=cnts v s = opt_fn b assertEqual s v v reset_name test_store_global_inline_ Borrowed test_python_autograd py Variable __init__ value torch Tensor name Optional str = None value = value name = name fresh_name staticmethod constant value torch Tensor name Optional str = None Variable value name fn b = Variable constant b = Variable constant b value + b value name + b name = torch randn b = torch randn cnts = torch _dynamo testing CompileCounter opt_fn = torch compile fn backend=cnts v s = opt_fn b assertEqual s v v reset_name test_store_global_crossfile_inline try mock_store_global_crossfile_inline except ImportError mock_store_global_crossfile_inline torch compile fn x mock_store_global_crossfile_inline set_flag_true mock_store_global_crossfile_inline set_flag_false x + torch compile fn_set_true x mock_store_global_crossfile_inline set_flag_true x + fn_set_true torch ones assertTrue mock_store_global_crossfile_inline global_flag fn torch ones assertFalse mock_store_global_crossfile_inline global_flag __name__ == __main__ torch _dynamo test_case run_tests run_tests
Owner s oncall jit ruff noqa F io os sys unittest typing Any torch torch nn nn torch testing FileCheck Make helper files test importable pytorch_test_dir = os path dirname os path dirname os path realpath __file__ sys path append pytorch_test_dir typing Dict Iterable List Optional Tuple torch testing _internal jit_utils torch testing _internal common_utils IS_SANDCASTLE raise_on_run_directly skipIfTorchDynamo torch testing _internal jit_utils JitTestCase make_global TestClassType JitTestCase test_reference_semantics Test modifications made instance TorchScript visible eager Foo __init__ int = set_a value int = value get_a - int property attr make_global Foo see local resolution python test_fn obj Foo obj set_a scripted_fn = torch jit script test_fn obj = torch jit script Foo assertEqual obj get_a assertEqual obj attr scripted_fn obj assertEqual obj get_a assertEqual obj attr test_get_with_method FooTest __init__ x foo = x getFooTest foo fn x foo = FooTest x foo getFooTest input = torch ones assertEqual fn input input test_get_attr FooTest noqa B __init__ x foo = x torch jit script fn x foo = FooTest x foo foo input = torch ones assertEqual fn input input test_in FooTest noqa B __init__ - None pass __contains__ key str - bool key == hi torch jit script fn foo = FooTest hi foo no foo assertEqual fn True False test_set_attr_in_method FooTest __init__ x int - None foo = x incFooTest y int - None foo = foo + y torch jit script fn x int - int foo = FooTest x foo incFooTest foo foo assertEqual fn test_set_attr_type_mismatch assertRaisesRegexWithHighlight RuntimeError Wrong type attribute assignment foo = torch jit script FooTest __init__ x foo = x foo = should error since int = Tensor test_get_attr_not_initialized assertRaisesRegexWithHighlight RuntimeError object has no attribute method asdf torch jit script FooTest __init__ x foo = x get_non_initialized asdf asdf isn t attr test_set_attr_non_initialized assertRaisesRegexWithHighlight RuntimeError Tried set nonexistent attribute bar = y torch jit script FooTest __init__ x foo = x set_non_initialized y bar = y can t assign non-initialized attr test_schema_human_readable Make sure schema human readable ie mode parameter should read nearest instead being displayed octal aten __interpolate Tensor input int size=None float scale_factor=None str mode= \ \ \ \ \ \ \ bool align_corners=None - Tensor Expected value type Optional int argument size instead found type Tensor assertRaisesRegexWithHighlight RuntimeError nearest torch jit script FooTest x torch nn functional interpolate x bad test_type_annotations assertRaisesRegexWithHighlight RuntimeError Expected value type bool torch jit script noqa B FooTest noqa B __init__ x bool - None foo = x torch jit script fn x FooTest x fn test_conditional_set_attr assertRaisesRegexWithHighlight RuntimeError assignment cannot control-flow block torch jit script FooTest __init__ x == attr = x test_class_type_as_param FooTest noqa B __init__ x attr = x make_global FooTest see local resolution python torch jit script fn foo FooTest - torch Tensor foo attr torch jit script fn x foo = FooTest x fn foo input = torch ones assertEqual fn input input test_out_of_order_methods FooTest __init__ x x = x x = get_stuff x get_stuff y x + y torch jit script fn x f = FooTest x f x input = torch ones assertEqual fn input input + input test_save_load_with_classes FooTest __init__ x x = x get_x x MyMod torch jit ScriptModule torch jit script_method forward foo = FooTest foo get_x m = MyMod buffer = io BytesIO torch jit save m buffer classes globally registered now so we need clear JIT registry simulate loading new model buffer seek m_loaded = torch jit load buffer input = torch rand output = m_loaded input assertEqual input output test_save_load_with_classes_returned FooTest __init__ x x = x clone clone = FooTest x clone MyMod torch jit ScriptModule torch jit script_method forward foo = FooTest foo_clone = foo clone foo_clone x m = MyMod buffer = io BytesIO torch jit save m buffer classes globally registered now so we need clear JIT registry simulate loading new model torch testing _internal jit_utils clear_class_registry buffer seek m_loaded = torch jit load buffer input = torch rand output = m_loaded input assertEqual input output test_save_load_with_classes_nested FooNestedTest noqa B __init__ y y = y FooNestedTest __init__ y y = y nested = FooNestedTest y FooTest __init__ x class_attr = FooNestedTest x class_attr = FooNestedTest x x = class_attr y + class_attr y MyMod torch jit ScriptModule torch jit script_method forward foo = FooTest foo x m = MyMod buffer = io BytesIO torch jit save m buffer classes globally registered now so we need clear JIT registry simulate loading new model torch testing _internal jit_utils clear_class_registry buffer seek m_loaded = torch jit load buffer input = torch rand output = m_loaded input assertEqual input output test_python_interop Foo noqa B __init__ x y x = x y = y make_global Foo see local resolution python torch jit script use_foo foo Foo - Foo foo create python x = torch ones y = torch zeros f = Foo x y assertEqual x f x assertEqual y f y pass out script f = use_foo f assertEqual x f x assertEqual y f y test_class_specialization Foo noqa B __init__ x y x = x y = y make_global Foo see local resolution python use_foo foo Foo foo Foo tup Tuple Foo Foo - torch Tensor b = tup foo x + foo y + x + b y create python x = torch ones y = torch zeros f = Foo x y f = Foo x y f = Foo x y input = f f f f sfoo = checkScript use_foo input graphstr = str sfoo graph_for input FileCheck check_count prim GetAttr run graphstr test_class_sorting Foo noqa B __init__ x int - None x = x __lt__ other - bool type Foo - bool x other x getVal x make_global Foo see local resolution python test li List Foo reverse bool = False - Tuple List int List int li_sorted = sorted li ret_sorted = torch jit annotate List int foo li_sorted ret_sorted append foo getVal li sort reverse=reverse ret_sort = torch jit annotate List int foo li ret_sort append foo getVal ret_sorted ret_sort checkScript test Foo Foo Foo checkScript test Foo Foo Foo True checkScript test Foo checkScript test torch jit script test_list_no_reverse li = Foo Foo li sort li getVal assertEqual test_list_no_reverse torch jit script test_sorted_copies li = Foo Foo li_sorted = sorted li li getVal li_sorted getVal assertEqual test_sorted_copies torch jit script test_nested_inside_tuple li = Foo Foo li sort li li getVal li li getVal assertEqual test_nested_inside_tuple assertRaisesRegexWithHighlight RuntimeError bool argument reverse torch jit script test li = Foo li sort li li test assertRaisesRegexWithHighlight RuntimeError must define __lt__ torch jit script NoMethod __init__ - None pass torch jit script test li = NoMethod NoMethod li sort li test torch jit script WrongLt __init__ - None pass lt method defined wrong signature __lt__ other pass assertRaisesRegexWithHighlight RuntimeError must define __lt__ torch jit script test li = WrongLt WrongLt li sort li test test_class_inheritance torch jit script Base __init__ - None b = two x x + b assertRaisesRegexWithHighlight RuntimeError does support inheritance torch jit script Derived Base two x x + b + test_class_inheritance_implicit Test inheritance detected implicit scripting codepaths e g try_ann_to_type A __init__ t t = t staticmethod f torch Tensor A + B A __init__ t t = t + staticmethod f torch Tensor A + x = A torch tensor fun x Any isinstance x A A f x t B f x t assertRaisesRegexWithHighlight RuntimeError object has no attribute method sc = torch jit script fun skipIfTorchDynamo Test does work TorchDynamo unittest skipIf IS_SANDCASTLE Importing like doesn t work fbcode test_imported_classes jit _imported_class_test bar jit _imported_class_test foo jit _imported_class_test very very nested MyMod torch jit ScriptModule torch jit script_method forward foo = jit _imported_class_test foo FooSameName bar = jit _imported_class_test bar FooSameName three = jit _imported_class_test very very nested FooUniqueName foo x + bar y + three y m = MyMod buffer = io BytesIO torch jit save m buffer classes globally registered now so we need clear JIT registry simulate loading new model torch testing _internal jit_utils clear_class_registry buffer seek m_loaded = torch jit load buffer input = torch rand output = m_loaded input assertEqual input output test_interface torch jit script Foo __init__ - None pass one x y x + y two x x torch jit script Bar __init__ - None pass one x y x y two x x torch jit interface OneTwo one x torch Tensor y torch Tensor - torch Tensor pass two x torch Tensor - torch Tensor pass torch jit interface OneTwoThree one x torch Tensor y torch Tensor - torch Tensor pass two x torch Tensor - torch Tensor pass three x torch Tensor - torch Tensor pass torch jit interface OneTwoWrong one x torch Tensor y torch Tensor - torch Tensor pass two x int - int pass torch jit script NotMember __init__ - None pass one x y x + y missing two torch jit script NotMember __init__ - None pass one x y x + y two x int - int make_global Foo Bar OneTwo OneTwoThree OneTwoWrong NotMember NotMember use_them x = Foo b = Bar c = torch jit annotate List OneTwo b i range len c x = c i one x x x = c i two x x checkScript use_them torch rand torch jit script as_interface x OneTwo - OneTwo x torch jit script inherit x OneTwoThree - OneTwo as_interface x assertRaisesRegexWithHighlight RuntimeError does have method torch jit script wrong as_interface NotMember assertRaisesRegexWithHighlight RuntimeError compatible interface torch jit script wrong as_interface NotMember assertRaisesRegexWithHighlight RuntimeError does have method torch jit script wrong inherit as_interface Foo assertRaisesRegexWithHighlight RuntimeError compatible interface torch jit script wrong x OneTwoWrong - int as_interface x Test interface python assignment TestPyAssign nn Module __init__ - None super __init__ proxy_mod = Foo forward x proxy_mod two x TestPyAssign __annotations__ = proxy_mod OneTwo input = torch rand scripted_pyassign_mod = torch jit script TestPyAssign imported_mod = getExportImportCopy scripted_pyassign_mod assertEqual scripted_pyassign_mod input imported_mod input TestPyAssignError nn Module __init__ obj super __init__ proxy_mod = obj forward x proxy_mod two x TestPyAssignError __annotations__ = proxy_mod OneTwoThree assertRaisesRegexWithHighlight RuntimeError compatible interface __torch__ torch jit script TestPyAssignError Foo test pure python object assignment interface fails PyClass __init__ - None pass assertRaisesRegexWithHighlight RuntimeError value TorchScript compatible type torch jit script TestPyAssignError PyClass TODO test interface-interface class-interface inheritance errors NamedTuple inheritance errors test_overloaded_fn torch jit script Foo __init__ x x = x __len__ - int len x __neg__ x = -self x __mul__ other torch Tensor - torch Tensor x other test_overload = Foo torch ones len -a torch zeros make_global Foo see local resolution python checkScript test_overload unary ops tested above TODO - support compiling classes strings jit CompilationUnit torch jit script MyClass __init__ x int - None x = x __add__ other int - int x + other __sub__ other int - int x - other __mul__ other int - int x other __pow__ other int - int int x other __truediv__ other int - float x other __mod__ other int - int x other __ne__ other int - bool x = other __eq__ other int - bool x == other __lt__ other int - bool x other __gt__ other int - bool x other __le__ other int - bool x = other __ge__ other int - bool x = other __and__ other int - int x other __or__ other int - int x &#124; other __xor__ other int - int x ^ other __getitem__ other int - int other + __setitem__ idx int val int - None x = val idx __call__ val int - int x val make_global Foo see local resolution python add MyClass + sub noqa E MyClass - mul noqa E MyClass pow noqa E MyClass truediv noqa E MyClass ne noqa E MyClass = eq noqa E MyClass == lt noqa E MyClass gt noqa E MyClass le noqa E MyClass = ge noqa E MyClass = _and noqa E MyClass _or noqa E MyClass &#124; _xor noqa E MyClass ^ getitem noqa E MyClass setitem noqa E = MyClass = x call noqa E = MyClass ops = add sub mul pow ne eq lt gt le ge _and _or _xor getitem setitem call ops append truediv func ops checkScript func assertRaisesRegexWithHighlight RuntimeError object has no attribute method torch jit script test Foo torch tensor + Foo torch tensor test_cast_overloads torch jit script Foo __init__ val float - None val = val __int__ int val __float__ val __bool__ bool val __str__ str val make_global Foo see local resolution python test foo Foo - Tuple int float bool foo pass int foo float foo bool foo fn = torch jit script test assertEqual fn Foo test assertEqual fn Foo test str has slightly different formatting assertTrue str Foo assertTrue str Foo torch jit script BadBool __init__ - None pass __bool__ assertRaisesRegexWithHighlight RuntimeError expected bool expression condition torch jit script test BadBool print test_init_compiled_first torch jit script noqa B Foo noqa B __before_init__ accessing field should throw since __init__ should compiled x __init__ x y x = x y = y test_class_constructs_itself torch jit script noqa B LSTMStateStack noqa B __init__ num_layers int hidden_size int - None num_layers = num_layers hidden_size = hidden_size last_state = torch zeros num_layers hidden_size torch zeros num_layers hidden_size stack = last_state - last_state - copy should able construct inside its own methods other = LSTMStateStack num_layers hidden_size other stack = list stack other test_optional_type_promotion torch jit script Leaf __init__ - None x = should throw torch jit script noqa B Tree noqa B __init__ - None child = torch jit annotate Optional Leaf None add_child child Leaf - None child = child test_recursive_class Recursive types yet supported We should give good error message assertRaises RuntimeError torch jit script noqa B Tree noqa B __init__ - None parent = torch jit annotate Optional Tree None test_class_constant M torch nn Module __constants__ = w __init__ w super __init__ w = w forward x Make sure constant accessible method y = w x y Test serialization deserialization constant c None True str m = torch jit script M c buffer = io BytesIO torch jit save m buffer buffer seek m_loaded = torch jit load buffer input = torch rand assertEqual m input m_loaded input Make sure constant accessible module assertEqual m w m_loaded w test_py_class_to_ivalue_missing_attribute Foo i int f float __init__ i int f float i = i f = f make_global Foo see local resolution python torch jit script test_fn x Foo - float x i + x f test_fn Foo assertRaisesRegexWithHighlight RuntimeError missing attribute i test_fn torch rand test_unused_method Test unused methods scripted classes torch jit script Unused __init__ - None count int = items List int = used count += count torch jit unused unused x int y Iterable int kwargs - int = next items uses_unused - int unused y= hi x= ModuleWithUnused nn Module __init__ - None super __init__ obj = Unused forward obj used torch jit export calls_unused obj unused hi torch jit export calls_unused_indirectly obj uses_unused python_module = ModuleWithUnused script_module = torch jit script ModuleWithUnused Forward should work because does used any methods marked unused assertEqual python_module forward script_module forward Calling method marked unused should throw assertRaises torch jit Error script_module calls_unused assertRaises torch jit Error script_module calls_unused_indirectly test_self_referential_method Test scripted can have method refers itself its type annotations torch jit script Meta __init__ int = method other List Meta - Meta Meta len other ModuleWithMeta torch nn Module __init__ int super __init__ meta = Meta forward new_obj = meta method meta new_obj checkModule ModuleWithMeta test_type_annotation Test annotating container attributes types works correctly torch jit script CompetitiveLinkingTokenReplacementUtils __init__ - None my_list List Tuple float int int = my_dict Dict int int = torch jit script foo y = CompetitiveLinkingTokenReplacementUtils new_dict Dict int int = y my_dict = new_dict new_list List Tuple float int int = y my_list = new_list y test_default_args Test methods types can have default arguments torch jit script ClassWithDefaultArgs __init__ int = b Optional List int = None c Tuple int int int = d Optional Dict int int = None e Optional str = None int = tup = c str = e list = b None list = b dict = d None dict = d add b int scale float = - float int scale + b all_defaults - int obj ClassWithDefaultArgs = ClassWithDefaultArgs obj int + obj list + obj tup some_defaults - int obj ClassWithDefaultArgs = ClassWithDefaultArgs b= obj int + obj list + obj dict override_defaults - int obj ClassWithDefaultArgs = ClassWithDefaultArgs str s int = obj int x obj list s += x y obj tup s += y s += obj dict st = obj str st None s += len st s method_defaults - float obj ClassWithDefaultArgs = ClassWithDefaultArgs obj add + obj add checkScript all_defaults checkScript some_defaults checkScript override_defaults checkScript method_defaults The constructor below has some arguments without default values ClassWithSomeDefaultArgs noqa B __init__ int b int = = b = b default_b - int obj ClassWithSomeDefaultArgs = ClassWithSomeDefaultArgs obj + obj b set_b - int obj ClassWithSomeDefaultArgs = ClassWithSomeDefaultArgs obj + obj b checkScript default_b checkScript set_b The constructor below has mutable arguments This should throw error ClassWithMutableArgs noqa B __init__ List int = noqa B = should_fail obj ClassWithMutableArgs = ClassWithMutableArgs assertRaisesRegexWithHighlight RuntimeError Mutable default parameters supported torch jit script should_fail test_staticmethod Test static methods types torch jit script ClassWithStaticMethod __init__ int b int int = b int = b get_a get_b b __eq__ other ClassWithStaticMethod == other b == other b staticmethod calls constructor staticmethod create args List ClassWithStaticMethod - ClassWithStaticMethod ClassWithStaticMethod args args b staticmethod calls another staticmethod staticmethod create_from int b int - ClassWithStaticMethod = ClassWithStaticMethod b ClassWithStaticMethod create Script function calls staticmethod test_function int b int - ClassWithStaticMethod ClassWithStaticMethod create_from b make_global ClassWithStaticMethod checkScript test_function test_classmethod Test classmethods types torch jit script ClassWithClassMethod __init__ int int = __eq__ other ClassWithClassMethod == other classmethod create cls int - ClassWithClassMethod cls make_global ClassWithClassMethod test_function int - ClassWithClassMethod x = ClassWithClassMethod Support calling classmethod instance Calling supported x create checkScript test_function skipIfTorchDynamo Not suitable test TorchDynamo test_properties Test scripted can make use property decorator free_function x int - int x + torch jit script Properties __jit_unused_properties__ = unsupported __init__ int = property attr - int - property unsupported - int sum torch jit unused property unsupported_ - int sum unsupported_ setter unsupported_ value = sum attr setter attr value int = value + torch jit script NoSetter __init__ int = property attr - int free_function torch jit script MethodThatUsesProperty __init__ int = property attr - int - attr setter attr value int = value + forward attr ModuleWithProperties torch nn Module __init__ int super __init__ props = Properties forward int b int c int d int props attr = props = Properties b no_setter = NoSetter c method_uses_property = MethodThatUsesProperty + b props attr = c method_uses_property attr = d props attr + no_setter attr + method_uses_property forward checkModule ModuleWithProperties test_custom_delete Test del can called instance overrides __delitem__ Example __init__ - None _data Dict str torch Tensor = torch tensor check key str - bool key _data __delitem__ key str del _data key fn - bool example = Example del example example check checkScript fn Test case which does have __delitem__ defined NoDelItem __init__ - None _data Dict str torch Tensor = torch tensor check key str - bool key _data fn - bool example = NoDelItem key = del example key example check key assertRaisesRegexWithHighlight RuntimeError r Class does define __delitem__ example key checkScript fn test_recursive_script_builtin_type_resolution Test resolution built-in torch types e g torch Tensor torch device when recursively compiled A will implicitly compiled because annotated torch jit script used g below tensor_t = torch Tensor device_t = torch device device_ty = torch device A __init__ - None pass f x tensor_t y torch device - tensor_t x device=y g x device_t - device_ty x h A - A A i List int - int j l List device_t - device_ty l call_f = A f torch tensor torch device cpu call_g = A g torch device cpu call_i = A i call_j = A j torch device cpu torch device cpu fn call_f call_g call_i call_j checkScript fn s = getExportImportCopy torch jit script fn assertEqual s fn test_recursive_script_module_builtin_type_resolution Test resolution built-in torch types e g torch Tensor torch device when recursively compiled when compiling module Wrapper __init__ t t = t l List torch device device Optional torch device = None t device=device A nn Module forward Wrapper torch rand scripted = torch jit script A getExportImportCopy scripted test_class_attribute_wrong_type Test error message displayed when convering type IValue has attribute wrong type torch jit script noqa B ValHolder noqa B __init__ val val = val Mod nn Module __init__ - None super __init__ mod = ValHolder mod = ValHolder forward cond bool cond mod = mod mod = mod mod val assertRaisesRegexWithHighlight RuntimeError Could cast attribute val type Tensor torch jit script Mod test_recursive_scripting Test types recursively scripted when Python instance one encountered module attribute Class __init__ int = get_a - int M torch nn Module __init__ obj super __init__ obj = obj forward - int obj get_a checkModule M Class test_recursive_scripting_failed Test types module attributes fail script added failed attributes do cause compilation itself fail unless they used scripted code UnscriptableClass __init__ int = get_a - bool issubclass int This Module has attribute type UnscriptableClass tries use scripted code This should fail ShouldNotCompile torch nn Module __init__ obj super __init__ obj = obj forward - bool obj get_a assertRaisesRegexWithHighlight RuntimeError failed convert Python type torch jit script ShouldNotCompile UnscriptableClass This Module has attribute type UnscriptableClass does try use scripted code This should fail ShouldCompile torch nn Module __init__ obj super __init__ obj = obj torch jit ignore ignored_method - bool obj get_a forward x int - int x + x checkModule ShouldCompile UnscriptableClass test_unresolved_class_attributes UnresolvedAttrClass __init__ - None pass attr_a attr_b attr_c attr_d = attr_e int = fn_a u = UnresolvedAttrClass u attr_a fn_b u = UnresolvedAttrClass u attr_b fn_c u = UnresolvedAttrClass u attr_c fn_d u = UnresolvedAttrClass u attr_d fn_e u = UnresolvedAttrClass u attr_e error_message_regex = object has no attribute method defined attribute fn fn_a fn_b fn_c fn_d fn_e assertRaisesRegex RuntimeError error_message_regex torch jit script fn __name__ == __main__ raise_on_run_directly test test_jit py
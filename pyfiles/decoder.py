mypy allow-untyped-defs This file takes partial implementation NVIDIA s webdataset here https github com tmbdev webdataset blob master webdataset autodecode py io json os path pickle tempfile torch torch utils data datapipes utils common StreamWrapper __all__ = Decoder ImageHandler MatHandler audiohandler basichandlers extension_extract_fn handle_extension imagehandler mathandler videohandler ################################################################ handle basic datatypes ################################################################ basichandlers extension str data Transforms raw data byte stream into python objects Looks extension loads data into python object supporting corresponding extension Args extension str The file extension data byte stream Data load into python object Returns object The data loaded into corresponding python object supporting extension Example pickle data = pickle dumps some data new_data = basichandlers pickle data new_data some data The transformation data extensions - txt text transcript utf- decoded data str format - cls cls count index inx id int - json jsn json loaded data - pickle pyd pickle loaded data - pt torch loaded data extension txt text transcript data decode utf- extension cls cls count index inx id try int data except ValueError None extension json jsn json loads data extension pyd pickle pickle loads data extension pt stream = io BytesIO data torch load stream extension ten tb split tenbin tenbin decode_buffer data extension mp msgpack msg split msgpack msgpack unpackb data None ################################################################ handle images ################################################################ imagespecs = l numpy uint l rgb numpy uint rgb rgba numpy uint rgba l numpy float l rgb numpy float rgb rgba numpy float rgba torchl torch uint l torchrgb torch uint rgb torchrgba torch uint rgba torchl torch float l torchrgb torch float rgb torch torch float rgb torchrgba torch float rgba pill pil None l pil pil None rgb pilrgb pil None rgb pilrgba pil None rgba handle_extension extensions f Return decoder handler function list extensions Extensions can space separated list extensions Extensions can contain dots which case corresponding number extension components must present key given f Comparisons case insensitive Examples handle_extension jpg jpeg my_decode_jpg invoked any file jpg handle_extension seg jpg special_case_jpg invoked only file seg jpg extensions = extensions lower split g key data extension = key lower split target extensions target = target split len target len extension continue extension -len target == target f data None g ImageHandler Decode image data using given ` imagespec ` The ` imagespec ` specifies whether image decoded numpy torch pi decoded uint float decoded l rgb rgba - l numpy uint l - rgb numpy uint rgb - rgba numpy uint rgba - l numpy float l - rgb numpy float rgb - rgba numpy float rgba - torchl torch uint l - torchrgb torch uint rgb - torchrgba torch uint rgba - torchl torch float l - torchrgb torch float rgb - torch torch float rgb - torchrgba torch float rgba - pill pil None l - pil pil None rgb - pilrgb pil None rgb - pilrgba pil None rgba __init__ imagespec imagespec list imagespecs keys raise AssertionError f unknown image specification imagespec imagespec = imagespec lower __call__ extension data extension lower jpg jpeg png ppm pgm pbm pnm None try numpy np except ModuleNotFoundError e raise ModuleNotFoundError Package ` numpy ` required installed default image decoder Please use ` pip install numpy ` install package e try PIL Image except ModuleNotFoundError e raise ModuleNotFoundError Package ` PIL ` required installed default image decoder Please use ` pip install Pillow ` install package e imagespec = imagespec atype etype mode = imagespecs imagespec io BytesIO data stream img = PIL Image open stream img load img = img convert mode upper atype == pil img atype == numpy result = np asarray img result dtype = np uint raise AssertionError f numpy image array should type uint got result dtype etype == uint result result astype f atype == torch result = np asarray img result dtype = np uint raise AssertionError f numpy image array should type uint got result dtype etype == uint result = np array result transpose torch tensor result result = np array result transpose torch tensor result None imagehandler imagespec ImageHandler imagespec ################################################################ torch video ################################################################ videohandler extension data extension mp ogv mjpeg avi mov h mpg webm wmv None try torchvision io except ImportError e raise ModuleNotFoundError Package ` torchvision ` required installed default video file loader Please use ` pip install torchvision ` install package e tempfile TemporaryDirectory dirname fname = os path join dirname f file extension open fname wb stream stream write data torchvision io read_video fname ################################################################ torchaudio ################################################################ audiohandler extension data extension flac mp sox wav m ogg wma None try torchaudio type ignore except ImportError e raise ModuleNotFoundError Package ` torchaudio ` required installed default audio file loader Please use ` pip install torchaudio ` install package e tempfile TemporaryDirectory dirname fname = os path join dirname f file extension open fname wb stream stream write data torchaudio load fname ################################################################ mat ################################################################ MatHandler __init__ loadmat_kwargs - None try scipy io sio except ImportError e raise ModuleNotFoundError Package ` scipy ` required installed mat file Please use ` pip install scipy ` install package e sio = sio loadmat_kwargs = loadmat_kwargs __call__ extension data extension = mat None io BytesIO data stream sio loadmat stream loadmat_kwargs mathandler loadmat_kwargs MatHandler loadmat_kwargs ################################################################ sample decoder ################################################################ Extract extension pathname extension_extract_fn pathname ext = os path splitext pathname Remove dot ext ext = ext ext Decoder Decode key data sets using list handlers For each key data item iterates through list handlers until some handler returns something other than None __init__ handler key_fn=extension_extract_fn handlers = list handler handler key_fn = key_fn Insert new handler beginning handlers list make sure new handler having highest priority add_handler handler handler handlers = list handler + handlers staticmethod _is_stream_handle data obj_to_check = data file_obj isinstance data StreamWrapper data isinstance obj_to_check io BufferedIOBase io RawIOBase decode key data data data data stream handle we need read all content before decoding Decoder _is_stream_handle data ds = data The behavior read can differ between streams e g HTTPResponse hence used instead data = b join data ds close f handlers result = f key data result None result data decode data result = single data tuple pathname data stream isinstance data tuple data = data data None k v data TODO xinyu figure out why Nvidia do k == _ isinstance v bytes v = v decode utf- result k = v continue result k = decode key_fn k v result __call__ data decode data
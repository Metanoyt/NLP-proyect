__future__ annotations argparse concurrent futures json logging os subprocess sys time enum Enum pathlib Path typing NamedTuple IS_WINDOWS bool = os name == nt LintSeverity str Enum ERROR = error WARNING = warning ADVICE = advice DISABLED = disabled LintMessage NamedTuple path str &#124; None line int &#124; None char int &#124; None code str severity LintSeverity name str original str &#124; None replacement str &#124; None description str &#124; None as_posix name str - str name replace \\ IS_WINDOWS name _run_command args list str timeout int - subprocess CompletedProcess bytes logging debug $ s join args start_time = time monotonic try subprocess run args capture_output=True shell=IS_WINDOWS So batch scripts found timeout=timeout check=True finally end_time = time monotonic logging debug took dms end_time - start_time run_command args list str retries int timeout int - subprocess CompletedProcess bytes remaining_retries = retries while True try _run_command args timeout=timeout except subprocess TimeoutExpired err remaining_retries == raise err remaining_retries -= logging warning noqa G s s Retrying because command failed r retries - remaining_retries retries err time sleep check_file filename str binary str retries int timeout int - list LintMessage try open filename rb f original = f read proc = run_command binary filename retries=retries timeout=timeout except subprocess TimeoutExpired LintMessage path=filename line=None char=None code= CLANGFORMAT severity=LintSeverity ERROR name= timeout original=None replacement=None description= clang-format timed out while trying process file Please report issue pytorch pytorch label module lint except OSError subprocess CalledProcessError err LintMessage path=filename line=None char=None code= CLANGFORMAT severity=LintSeverity ADVICE name= command-failed original=None replacement=None description= f Failed due err __class__ __name__ \n err isinstance err subprocess CalledProcessError COMMAND exit code returncode \n command \n\n STDERR\n stderr \n\n STDOUT\n stdout format returncode=err returncode command= join as_posix x x err cmd stderr=err stderr decode utf- strip empty stdout=err stdout decode utf- strip empty replacement = proc stdout original == replacement LintMessage path=filename line=None char=None code= CLANGFORMAT severity=LintSeverity WARNING name= format original=original decode utf- replacement=replacement decode utf- description= See https clang llvm org docs ClangFormat html \nRun ` lintrunner -a ` apply patch main - None parser = argparse ArgumentParser description= Format files clang-format fromfile_prefix_chars= parser add_argument -- binary required=True help= clang-format binary path parser add_argument -- retries default= type=int help= times retry timed out clang-format parser add_argument -- timeout default= type=int help= seconds wait clang-format parser add_argument -- verbose action= store_true help= verbose logging parser add_argument filenames nargs= + help= paths lint args = parser parse_args logging basicConfig format= threadName s levelname s message s level=logging NOTSET args verbose logging DEBUG len args filenames logging INFO stream=sys stderr binary = os path normpath args binary IS_WINDOWS args binary Path binary exists lint_message = LintMessage path=None line=None char=None code= CLANGFORMAT severity=LintSeverity ERROR name= init-error original=None replacement=None description= f Could find clang-format binary binary did you forget run ` lintrunner init ` print json dumps lint_message _asdict flush=True sys exit concurrent futures ThreadPoolExecutor max_workers=os cpu_count thread_name_prefix= Thread executor futures = executor submit check_file x binary args retries args timeout x x args filenames future concurrent futures as_completed futures try lint_message future result print json dumps lint_message _asdict flush=True except Exception logging critical Failed s futures future raise __name__ == __main__ main
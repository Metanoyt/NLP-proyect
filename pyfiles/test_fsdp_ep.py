Owner s oncall distributed torch torch nn nn torch distributed checkpoint state_dict get_state_dict torch distributed device_mesh init_device_mesh torch distributed fsdp FullyShardedDataParallel FSDP torch distributed tensor DTensor torch testing _internal common_utils run_tests torch testing _internal distributed _tensor common_dtensor DTensorTestBase skip_if_lt_x_gpu with_comms torch testing _internal distributed checkpoint_utils with_temp_dir torch testing _internal distributed common_state_dict VerifyStateDictMixin Dummymodel nn Module __init__ - None super __init__ forward x raise NotImplementedError EPModel nn Module __init__ rank super __init__ net = nn Sequential nn Linear nn ReLU net = nn Sequential nn Linear nn ReLU forward x raise NotImplementedError SecondTier nn Module __init__ rank super __init__ ep_layers = nn ModuleList EPModel rank rank == i Dummymodel i range net = nn Sequential nn Linear nn ReLU forward x raise NotImplementedError TopModel nn Module __init__ rank super __init__ torch manual_seed second = SecondTier rank net = nn Sequential nn Linear nn ReLU forward x raise NotImplementedError TestFSDPWithEP DTensorTestBase VerifyStateDictMixin property world_size - int min torch accelerator device_count with_comms skip_if_lt_x_gpu with_temp_dir test_e e model = TopModel rank device_type mesh_fsdp_tp = init_device_mesh device_type mesh_dim_names= dp tp TODO we using internal API atm Change public API once ready mesh_fsdp_ep = mesh_fsdp_tp dp mesh_fsdp_ep _root_mesh = None mesh_fsdp = init_device_mesh device_type i l enumerate model second ep_layers model second ep_layers i = FSDP l use_orig_params=True device_mesh=mesh_fsdp_ep model second = FSDP model second use_orig_params=True device_mesh=mesh_fsdp model = FSDP model use_orig_params=True device_mesh=mesh_fsdp optim = torch optim Adam model parameters lr= msd osd = get_state_dict model optim FSDP only params key net weight net bias second net weight second net bias msd_v = msd key osd_v = osd state key exp_avg v msd_v osd_v assertTrue isinstance v DTensor assertEqual tuple v device_mesh mesh tuple range FSDP EP params layer = rank ranks = layer layer + i range key f second ep_layers i net weight f second ep_layers i net bias f second ep_layers i net weight f second ep_layers i net bias layer = i assertTrue key msd msd_v = msd key osd_v = osd state key exp_avg v msd_v osd_v assertTrue isinstance v DTensor assertEqual tuple v device_mesh mesh ranks assertEqual set osd state keys set msd keys __name__ == __main__ run_tests
mypy allow-untyped-defs os sys unittest torch testing _internal common_distributed MultiProcessTestCase torch testing _internal common_utils find_free_port IS_SANDCASTLE TEST_WITH_DEV_DBG_ASAN torch testing _internal distributed ddp_under_dist_autograd_test CudaDdpComparisonTest DdpComparisonTest DdpUnderDistAutogradTest torch testing _internal distributed nn api remote_module_test CudaRemoteModuleTest RemoteModuleTest ThreeWorkersRemoteModuleTest torch testing _internal distributed rpc dist_autograd_test CudaDistAutogradTest DistAutogradTest FaultyAgentDistAutogradTest TensorPipeAgentDistAutogradTest TensorPipeCudaDistAutogradTest torch testing _internal distributed rpc dist_optimizer_test DistOptimizerTest torch testing _internal distributed rpc examples parameter_server_test ParameterServerTest torch testing _internal distributed rpc examples reinforcement_learning_rpc_test ReinforcementLearningRpcTest torch testing _internal distributed rpc faulty_agent_rpc_test FaultyAgentRpcTest torch testing _internal distributed rpc jit dist_autograd_test JitDistAutogradTest torch testing _internal distributed rpc jit rpc_test JitRpcTest torch testing _internal distributed rpc jit rpc_test_faulty JitFaultyAgentRpcTest torch testing _internal distributed rpc rpc_agent_test_fixture RpcAgentTestFixture torch testing _internal distributed rpc rpc_test CudaRpcTest RpcTest TensorPipeAgentCudaRpcTest TensorPipeAgentRpcTest _check_and_set_tcp_init we running TCP init set main address port before spawning subprocesses since different processes could find different ports use_tcp_init = os environ get RPC_INIT_WITH_TCP None use_tcp_init == os environ MASTER_ADDR = os environ MASTER_PORT = str find_free_port _check_and_unset_tcp_init use_tcp_init = os environ get RPC_INIT_WITH_TCP None use_tcp_init == del os environ MASTER_ADDR del os environ MASTER_PORT The tests RPC module need cover multiple possible combinations - different aspects API each one having its own suite tests - different agents ProcessGroup TensorPipe To avoid combinatorial explosion code size prevent forgetting add combination these generated automatically code file Here we collect all test suites we need cover We then have one separate file each agent which we call generate_tests function file passing fixture agent which then gets mixed-in each test suite unittest skipIf TEST_WITH_DEV_DBG_ASAN Skip ASAN torch + multiprocessing spawn have known issues SpawnHelper MultiProcessTestCase setUp super setUp _check_and_set_tcp_init _spawn_processes tearDown _check_and_unset_tcp_init super tearDown This list contains test suites agent-agnostic only verify compliance generic RPC interface specification These tests should make use implementation details specific agent options attributes These test suites will instantiated multiple times once each agent except faulty agent which special GENERIC_TESTS = RpcTest ParameterServerTest DistAutogradTest DistOptimizerTest JitRpcTest JitDistAutogradTest RemoteModuleTest ThreeWorkersRemoteModuleTest DdpUnderDistAutogradTest DdpComparisonTest ReinforcementLearningRpcTest GENERIC_CUDA_TESTS = CudaRpcTest CudaDistAutogradTest CudaRemoteModuleTest CudaDdpComparisonTest This list contains test suites will only run TensorPipeAgent These suites should standalone separate ones generic list subclasses those TENSORPIPE_TESTS = TensorPipeAgentRpcTest TensorPipeAgentDistAutogradTest TENSORPIPE_CUDA_TESTS = TensorPipeAgentCudaRpcTest TensorPipeCudaDistAutogradTest This list contains test suites will only run faulty RPC agent That agent special s only used perform fault injection order verify error handling behavior Thus faulty agent will only run suites list which designed test such behaviors ones generic list FAULTY_AGENT_TESTS = FaultyAgentRpcTest FaultyAgentDistAutogradTest JitFaultyAgentRpcTest generate_tests prefix str mixin type RpcAgentTestFixture tests list type RpcAgentTestFixture module_name str - dict str type RpcAgentTestFixture Mix classes needed autogenerate tests based params Takes series test suites each written against generic agent i e derived abstract RpcAgentTestFixture ` tests ` args Takes concrete subclass RpcAgentTestFixture which specializes certain agent ` mixin ` arg Produces all combinations them Returns dictionary names type objects which can inserted into global namespace calling module The name each test will concatenation ` prefix ` arg original name test suite The ` module_name ` should name calling module so classes can fixed make look like they belong which necessary pickling work them ret dict str type RpcAgentTestFixture = test_class tests IS_SANDCASTLE TEST_WITH_DEV_DBG_ASAN print f Skipping test test_class sandcastle following reason Skip dev-asan torch + multiprocessing spawn have known issues file=sys stderr continue name = f prefix test_class __name__ class_ = type name test_class mixin SpawnHelper class_ __module__ = module_name ret name = class_ ret
mypy allow-untyped-defs typing Any NamedTuple Optional torch torch fx _compatibility compatibility torch fx graph Graph torch fx graph_module GraphModule torch fx node map_arg Node Target torch fx passes shape_prop ShapeProp __all__ = replace_target_nodes_with size_bytes get_size_of_all_nodes get_tensor_meta get_size_of_node compatibility is_backward_compatible=False replace_target_nodes_with fx_module GraphModule old_op str old_target Target new_op str new_target Target Modifies all nodes fx_module graph nodes which match specified op code target updates them match new op code target new_graph = Graph val_map dict Node Node = node fx_module graph nodes node op == old_op node target == old_target args = map_arg node args lambda n val_map n kwargs = map_arg node kwargs lambda n val_map n assert isinstance args tuple assert isinstance kwargs dict val_map node = new_graph create_node new_op new_target args kwargs node name val_map node = new_graph node_copy node lambda n val_map n fx_module graph = new_graph compatibility is_backward_compatible=False size_bytes NamedTuple output_size int total_size int compatibility is_backward_compatible=False get_size_of_all_nodes fx_module GraphModule args Optional list torch Tensor = None - None Given fx graph module update each node its total size weights + bias + output its output_size output For non-module node total size output size total size args None Mark shape dtype each node node shape node dtype ShapeProp fx_module propagate args Calculate total size whole fx graph node fx_module graph nodes node op == output break node size_bytes = get_size_of_node fx_module node compatibility is_backward_compatible=False get_tensor_meta node Node - Any tensor_meta = node meta get tensor_meta tensor_meta raise RuntimeError f Node node has no tensor metadata associated f Check shape propagation has run tensor_meta compatibility is_backward_compatible=False get_size_of_node fx_module GraphModule node Node - size_bytes Given node node dtype node shape its total size its output size total_size = weights + bias + output_size Total num elements total_num_of_elems = For module consider all parameters node op == call_module submodule_dict = dict fx_module named_modules submodule = submodule_dict node target parameters = submodule named_parameters Parameters named tuples _name p parameters total_num_of_elems += p numel Don t forget output size node shape shape node s output tensor_meta = get_tensor_meta node output_elem = tensor_meta shape numel total_num_of_elems += output_elem Assume now s quantized then s qint quint tensor_meta is_quantized size_per_elem_bytes = torch _empty_affine_quantized dtype=tensor_meta dtype element_size size_per_elem_bytes = torch tensor dtype=tensor_meta dtype element_size total_size = size_per_elem_bytes total_num_of_elems output_size = size_per_elem_bytes output_elem size_bytes output_size total_size
======= BEGIN Dynamo patch ======= Owner s module dynamo ruff noqa flake noqa Test copied https raw githubusercontent com python cpython refs tags v Lib test test_raise py sys torch torch _dynamo test_case unittest torch _dynamo test_case CPythonTestCase torch testing _internal common_utils run_tests __TestCase = CPythonTestCase redirect statements sys importlib abc redirect_imports = test mapping_tests test typinganndata test test_grammar test test_math test test_iter test typinganndata ann_module RedirectImportFinder importlib abc MetaPathFinder find_spec fullname path target=None Check problematic one fullname redirect_imports try Attempt standalone module name = fullname removeprefix test r = importlib import_module name Redirect module sys modules sys modules fullname = r Return module spec found module importlib util find_spec name except ImportError None None Add custom finder sys meta_path sys meta_path insert RedirectImportFinder ======= END DYNAMO PATCH ======= Copyright Google Inc All Rights Reserved Licensed PSF under Contributor Agreement Tests raise statement test support sys types unittest get_tb try raise OSError except OSError e e __traceback__ Context __enter__ __exit__ exc_type exc_value exc_tb True TestRaise __TestCase test_invalid_reraise try raise except RuntimeError e assertIn No active exception str e fail No exception raised test_reraise try try raise IndexError except IndexError e exc = e raise except IndexError exc assertIs exc exc fail No exception raised test_except_reraise reraise try raise TypeError foo except try raise KeyError caught except KeyError pass raise assertRaises TypeError reraise test_finally_reraise reraise try raise TypeError foo except try raise KeyError caught finally raise assertRaises KeyError reraise test_nested_reraise nested_reraise raise reraise try raise TypeError foo except nested_reraise assertRaises TypeError reraise test_raise_from_None try try raise TypeError foo except raise ValueError None except ValueError e assertIsInstance e __context__ TypeError assertIsNone e __cause__ test_with_reraise reraise try raise TypeError foo except Context pass raise assertRaises TypeError reraise test_with_reraise reraise try raise TypeError foo except Context raise KeyError caught raise assertRaises TypeError reraise test_yield_reraise reraise try raise TypeError foo except yield raise g = reraise next g assertRaises TypeError lambda next g assertRaises StopIteration lambda next g test_erroneous_exception torch _dynamo error_on_graph_break False MyException Exception __init__ raise RuntimeError try raise MyException except RuntimeError pass fail No exception raised test_new_returns_invalid_instance See issue torch _dynamo error_on_graph_break False MyException Exception __new__ cls args object assertRaises TypeError raise MyException test_assert_with_tuple_arg try assert False except AssertionError e assertEqual str e TestCause __TestCase testCauseSyntax try try try raise TypeError except Exception raise ValueError None except ValueError exc assertIsNone exc __cause__ assertTrue exc __suppress_context__ exc __suppress_context__ = False raise exc except ValueError exc e = exc assertIsNone e __cause__ assertFalse e __suppress_context__ assertIsInstance e __context__ TypeError test_invalid_cause try raise IndexError except TypeError e assertIn exception cause str e fail No exception raised test_class_cause try raise IndexError KeyError except IndexError e assertIsInstance e __cause__ KeyError fail No exception raised test_class_cause_nonexception_result torch _dynamo error_on_graph_break False ConstructsNone BaseException classmethod __new__ args kwargs None try raise IndexError ConstructsNone except TypeError e assertIn should have returned instance BaseException str e except IndexError fail Wrong kind exception raised fail No exception raised test_instance_cause cause = KeyError try raise IndexError cause except IndexError e assertIs e __cause__ cause fail No exception raised test_erroneous_cause torch _dynamo error_on_graph_break False MyException Exception __init__ raise RuntimeError try raise IndexError MyException except RuntimeError pass fail No exception raised TestTraceback __TestCase test_sets_traceback try raise IndexError except IndexError e assertIsInstance e __traceback__ types TracebackType fail No exception raised test_accepts_traceback tb = get_tb try raise IndexError with_traceback tb except IndexError e assertNotEqual e __traceback__ tb assertEqual e __traceback__ tb_next tb fail No exception raised TestTracebackType __TestCase raiser raise ValueError test_attrs try raiser except Exception exc tb = exc __traceback__ assertIsInstance tb tb_next types TracebackType assertIs tb tb_frame sys _getframe assertIsInstance tb tb_lasti int assertIsInstance tb tb_lineno int assertIs tb tb_next tb_next None Invalid assignments assertRaises TypeError del tb tb_next assertRaises TypeError tb tb_next = asdf Loops assertRaises ValueError tb tb_next = tb assertRaises ValueError tb tb_next tb_next = tb Valid assignments tb tb_next = None assertIs tb tb_next None new_tb = get_tb tb tb_next = new_tb assertIs tb tb_next new_tb test_constructor other_tb = get_tb frame = sys _getframe tb = types TracebackType other_tb frame assertEqual tb tb_next other_tb assertEqual tb tb_frame frame assertEqual tb tb_lasti assertEqual tb tb_lineno tb = types TracebackType None frame assertEqual tb tb_next None assertRaises TypeError types TracebackType no frame assertRaises TypeError types TracebackType other_tb no assertRaises TypeError types TracebackType other_tb frame no assertRaises TypeError types TracebackType other_tb frame nuh-uh TestContext __TestCase test_instance_context_instance_raise context = IndexError try try raise context except raise OSError except OSError e assertIs e __context__ context fail No exception raised test_class_context_instance_raise context = IndexError try try raise context except raise OSError except OSError e assertIsNot e __context__ context assertIsInstance e __context__ context fail No exception raised test_class_context_class_raise context = IndexError try try raise context except raise OSError except OSError e assertIsNot e __context__ context assertIsInstance e __context__ context fail No exception raised test_c_exception_context try try except raise OSError except OSError e assertIsInstance e __context__ ZeroDivisionError fail No exception raised test_c_exception_raise try try except xyzzy except NameError e assertIsInstance e __context__ ZeroDivisionError fail No exception raised test_noraise_finally try try pass finally raise OSError except OSError e assertIsNone e __context__ fail No exception raised test_raise_finally try try finally raise OSError except OSError e assertIsInstance e __context__ ZeroDivisionError fail No exception raised test_context_manager torch _dynamo error_on_graph_break False ContextManager __enter__ pass __exit__ t v tb xyzzy try ContextManager except NameError e assertIsInstance e __context__ ZeroDivisionError fail No exception raised test_cycle_broken Self-cycles when re-raising caught exception broken try try except ZeroDivisionError e raise e except ZeroDivisionError e assertIsNone e __context__ test_reraise_cycle_broken Non-trivial context cycles through re-raising previous exception broken too try try xyzzy except NameError try except ZeroDivisionError raise except NameError e assertIsNone e __context__ __context__ test_not_last Context necessarily last exception context = Exception context try raise context except Exception try raise Exception caught except Exception pass try raise Exception new except Exception exc raised = exc assertIs raised __context__ context test_ deleting generator caused __context__ cleared gen try yield finally pass f g = gen next g try try raise ValueError except del g raise KeyError except Exception e assertIsInstance e __context__ ValueError f test_ gc A re-raised exception __del__ caused __context__ cleared torch _dynamo error_on_graph_break False C __del__ try except raise f x = C try try f x except AttributeError make x __del__ trigger del x gc collect For PyPy other GCs raise TypeError except Exception e assertNotEqual e __context__ None assertIsInstance e __context__ AttributeError support catch_unraisable_exception cm f assertEqual ZeroDivisionError cm unraisable exc_type TestRemovedFunctionality __TestCase test_tuples try raise IndexError KeyError This should tuple except TypeError pass fail No exception raised test_strings try raise foo except TypeError pass fail No exception raised __name__ == __main__ run_tests
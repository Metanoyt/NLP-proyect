logging os textwrap typing Any cli lib common gh_summary write_gh_step_summary cli lib common git_helper clone_external_repo cli lib common pip_helper pip_install_packages cli lib common utils run_command temp_environ working_directory jinja Template logger = logging getLogger __name__ _TPL_VLLM_INFO = Template textwrap dedent \ ## Vllm against Pytorch CI Test Summary Vllm Commit vllm_commit https github com vllm-project vllm commit vllm_commit - torch_sha Pytorch Commit torch_sha https github com pytorch pytorch commit torch_sha - endif sample_vllm_test_library Simple sample unblock vllm ci development which mimic https github com vllm-project vllm blob main buildkite test-pipeline yaml see run_test_plan more details TODO elainewy Read yaml file handle env tests vllm vllm_basic_correctness_test title Basic Correctness Test id vllm_basic_correctness_test env_vars VLLM_WORKER_MULTIPROC_METHOD spawn steps pytest -v -s basic_correctness test_cumem py pytest -v -s basic_correctness test_basic_correctness py pytest -v -s basic_correctness test_cpu_offload py vllm_basic_models_test title Basic models test id vllm_basic_models_test steps pytest -v -s models test_transformers py pytest -v -s models test_registry py pytest -v -s models test_utils py pytest -v -s models test_vision py pytest -v -s models test_initialization py vllm_entrypoints_test title Entrypoints Test id vllm_entrypoints_test env_vars VLLM_WORKER_MULTIPROC_METHOD spawn steps join pytest -v -s entrypoints llm -- ignore=entrypoints llm test_generate py -- ignore=entrypoints llm test_collective_rpc py pytest -v -s entrypoints llm test_generate py pytest -v -s entrypoints offline_mode vllm_regression_test title Regression Test id vllm_regression_test package_install modelscope steps pytest -v -s test_regression py vllm_lora_tp_test_distributed title LoRA TP Test Distributed id vllm_lora_tp_test_distributed env_vars VLLM_WORKER_MULTIPROC_METHOD spawn num_gpus steps pytest -v -s -x lora test_chatglm _tp py pytest -v -s -x lora test_llama_tp py pytest -v -s -x lora test_llm_with_multi_loras py vllm_distributed_test_ _failure_test title Distributed Tests GPUs pytorch release failure id vllm_distributed_test_ _failure_test env_vars VLLM_WORKER_MULTIPROC_METHOD spawn num_gpus steps pytest -v -s distributed test_sequence_parallel py vllm_lora_ _failure_test title LoRA pytorch failure test id vllm_lora_ _failure_test steps pytest -v lora test_quant_model py vllm_multi_model_processor_test title Multi-Modal Processor Test id vllm_multi_model_processor_test package_install git+https github com TIGER-AI-Lab Mantis git steps pytest -v -s models multimodal processing -- ignore models multimodal processing test_tensor_schema py vllm_multi_model_test_ _failure_test title Multi-Model Test Failed release id vllm_multi_model_test_ _failure_test package_install git+https github com TIGER-AI-Lab Mantis git steps pytest -v -s models multimodal generation test_voxtral py pytest -v -s models multimodal pooling vllm_pytorch_compilation_unit_tests title PyTorch Compilation Unit Tests id vllm_pytorch_compilation_unit_tests steps pytest -v -s compile test_pass_manager py pytest -v -s compile test_fusion py pytest -v -s compile test_fusion_attn py pytest -v -s compile test_silu_mul_quant_fusion py pytest -v -s compile test_sequence_parallelism py pytest -v -s compile test_async_tp py pytest -v -s compile test_fusion_all_reduce py pytest -v -s compile test_decorator py vllm_language_model_test_extended_generation_ _failure_test title Language Models Test Extended Generation release failure id vllm_languagde_model_test_extended_generation_ _failure_test package_install -- no-build-isolation git+https github com Dao-AILab causal-conv d v post steps pytest -v -s models language generation test_mistral py vllm_distributed_test_ _gpu_ _failure_test title Distributed Tests GPUs pytorch release failure id vllm_distributed_test_ _gpu_ _failure_test env_vars VLLM_WORKER_MULTIPROC_METHOD spawn num_gpus steps pytest -v -s distributed test_sequence_parallel py TODO elainewy need add g gpus run test vllm_lora_test title LoRA Test N id lora_test parallelism steps echo checking list sharded lora tests join pytest -q -- collect-only lora -- shard-id=$ $ BUILDKITE_PARALLEL_JOB -- num-shards=$ $ BUILDKITE_PARALLEL_JOB_COUNT -- ignore=lora test_chatglm _tp py -- ignore=lora test_llama_tp py echo checking Done list lora tests join pytest -v -s lora -- shard-id=$ $ BUILDKITE_PARALLEL_JOB -- num-shards=$ $ BUILDKITE_PARALLEL_JOB_COUNT -- ignore=lora test_chatglm _tp py -- ignore=lora test_llama_tp py check_parallelism tests Any title str shard_id int = num_shards int = method check test plan parallelism parallelism = int tests get parallelism is_parallel = parallelism parallelism is_parallel False shard_id num_shards raise RuntimeError f Test title expects num_shards shards invalid shard_id provided num_shards = parallelism raise RuntimeError f Test title expects parallelism shards invalid num_shards provided True run_test_plan test_plan str test_target str tests_map dict str Any shard_id int = num_shards int = method run list tests based test plan logger info run s tests test_target test_plan tests_map raise RuntimeError f test test_plan found please add test plan pool tests = tests_map test_plan pkgs = tests get package_install title = tests get title unknown test is_parallel = check_parallelism tests title shard_id num_shards is_parallel title = title replace N f shard_id num_shards logger info Running tests s title pkgs logger info Installing packages s pkgs pip_install_packages packages=pkgs prefer_uv=True working_directory tests get working_directory tests temp_environ tests get env_vars failures = step tests steps logger info Running step s step is_parallel step = replace_buildkite_placeholders step shard_id num_shards logger info Running parallel step s step code = run_command cmd=step check=False use_shell=True code = failures append step logger info Finish running step s step failures logger error Failed tests s failures raise RuntimeError f len failures pytest runs failed failures logger info Done All tests passed clone_vllm dst str = vllm _ commit = clone_external_repo target= vllm repo= https github com vllm-project vllm git dst=dst update_submodules=True commit replace_buildkite_placeholders step str shard_id int num_shards int - str mapping = $ $ BUILDKITE_PARALLEL_JOB_COUNT str num_shards $ $ BUILDKITE_PARALLEL_JOB str shard_id k sorted mapping key=len reverse=True step = step replace k mapping k step summarize_build_info vllm_commit str - bool torch_sha = os getenv GITHUB_SHA md = _TPL_VLLM_INFO render vllm_commit=vllm_commit torch_sha=torch_sha strip + \n write_gh_step_summary md
flake noqa G Note Copies script runner_determinator py _runner-determinator yml must kept sync You can do easily running following command python github scripts update_runner_determinator py This runner determinator used determine which set runners run GitHub job It uses first comment GitHub issue default https github com pytorch test-infra issues define configuration which runners should used run which job The configuration has two parts settings list opted-in users separated line containing --- If line present settings considered empty only second part user list defined The first part YAML block defines rollout settings This can used define any settings needed determine which runners use It s fields defined RolloutSettings below The second part list users who explicitly opted LF fleet The user list also comma separated list additional features experiments which user could opted The user list has following rules - Users GitHub usernames which must start prefix - Each user also comma-separated list features experiments enable - A prefix opts user out all experiments Example config A list experiments can opted into This defines behavior they ll induce when opted into Expected syntax experiment_name Name experiment Also used label prefix rollout_perc int workflows run experiment when users opted experiments lf rollout_percent all_branches false default true --- Opt-ins Users can opt into LF fleet adding their GitHub username list specifying experiments enable comma-separated list To always opt out experiment prefix - Experiments should above list User -lf split_build User lf User split_build json logging os random re sys argparse ArgumentParser collections abc Iterable functools cache logging LogRecord typing Any NamedTuple urllib request Request urlopen yaml github Auth Github github Issue Issue DEFAULT_LABEL_PREFIX = use meta runners WORKFLOW_LABEL_LF = lf use runners linux foundation WORKFLOW_LABEL_LF_CANARY = lf c use canary runners linux foundation GITHUB_OUTPUT = os getenv GITHUB_OUTPUT GH_OUTPUT_KEY_AMI = runner-ami GH_OUTPUT_KEY_LABEL_TYPE = label-type OPT_OUT_LABEL = no-runner-experiments SETTING_EXPERIMENTS = experiments LF_FLEET_EXPERIMENT = lf CANARY_FLEET_SUFFIX = c Experiment NamedTuple rollout_perc float = Percentage workflows experiment when user opted-in all_branches bool = False If True experiment also enabled exception branches default bool = True If True experiment enabled default all queries Add more fields needed Settings NamedTuple Settings experiments can opted into experiments dict str Experiment = ColorFormatter logging Formatter Color codes log messages based log level COLORS = WARNING \ m Yellow ERROR \ m Red CRITICAL \ m Red INFO \ m Reset DEBUG \ m Reset format record LogRecord - str log_color = COLORS get record levelname \ m Default reset record msg = f log_color record msg \ m super format record handler = logging StreamHandler handler setFormatter ColorFormatter fmt= levelname - s message s log = logging getLogger os path basename __file__ log addHandler handler log setLevel logging INFO set_github_output key str value str - None Defines outputs github action invokes script GITHUB_OUTPUT See https github blog changelog - - -github-actions-deprecating-save-state-and-set-output-commands deprecation notice log warning No env var found GITHUB_OUTPUT you must running code locally Falling back deprecated print method print f set-output name= key value open GITHUB_OUTPUT f log info f Setting output key = value f write f key = value \n _str_comma_separated_to_set value str - frozenset str frozenset filter lambda itm itm = map str strip value strip \n\t split parse_args - Any parser = ArgumentParser Get dynamic rollout settings parser add_argument -- github-token type=str required=True help= GitHub token parser add_argument -- github-issue-repo type=str required=False default= pytorch test-infra help= GitHub repo get issue parser add_argument -- github-repo type=str required=True help= GitHub repo where CI running parser add_argument -- github-issue type=int required=True help= GitHub issue number parser add_argument -- github-actor type=str required=True help= GitHub triggering_actor parser add_argument -- github-issue-owner type=str required=True help= GitHub issue owner parser add_argument -- github-branch type=str required=True help= Current GitHub branch tag parser add_argument -- github-ref-type type=str required=True help= Current GitHub ref type branch tag parser add_argument -- eligible-experiments type=_str_comma_separated_to_set required=False default= help= comma separated list experiments check omitted all experiments marked default=True checked parser add_argument -- opt-out-experiments type=_str_comma_separated_to_set required=False default= help= comma separated list experiments opt-out If unset no opt-outs will occur If same experiment listed both here -- eligible-experiments opt-out will take priority parser add_argument -- pr-number type=str required=False default= help= optional PR number where run parser parse_args get_gh_client github_token str - Github type ignore no-any-unimported auth = Auth Token github_token Github auth=auth get_issue gh Github repo str issue_num int - Issue type ignore no-any-unimported repo = gh get_repo repo repo get_issue number=issue_num get_potential_pr_author github_token str repo str username str ref_type str ref_name str - str If trigger new tag added bot ciflow case Fetch actual username original PR The PR number embedded tag name ciflow name pr-number gh = get_gh_client github_token username == pytorch-bot bot ref_type == tag split_tag = ref_name split len split_tag == split_tag == ciflow split_tag isnumeric pr_number = split_tag try repository = gh get_repo repo pull = repository get_pull number=int pr_number except Exception e raise Exception noqa TRY f issue pull request pr_number repo repository e pull user login type ignore no-any-return In all other cases original input username username is_exception_branch branch str - bool Branches get opted out experiments default until they re explicitly enabled branch split maxsplit= main nightly release landchecks load_yaml yaml_text str - Any try data = yaml safe_load yaml_text data except yaml YAMLError log exception Error loading YAML raise extract_settings_user_opt_in_from_text rollout_state str - tuple str str Extracts text settings any opted users rollout state If issue body contains --- then text above settings text below list opted users If doesn t contain --- then settings empty rest users rollout_state_parts = rollout_state split --- len rollout_state_parts = rollout_state_parts rollout_state_parts rollout_state UserOptins dict str list str Dictionary users list features they have opted into parse_user_opt_in_from_text user_optin_text str - UserOptins Parse user opt-in text into key value pair username list features they have opted into Users GitHub usernames prefix Each user also comma-separated list features experiments enable - Example line User lf split_build - A prefix indicates user opted out all experiments optins = UserOptins user user_optin_text split \n user = user strip \r\n\t - user user startswith Not valid user Skip continue user usr_name = user split strip optins usr_name = exp strip exp user split optins is_valid_experiment_name experiment_name str - bool Check experiment name valid A valid name - Contains only alphanumeric characters special characters _ - - The special characters _ - shouldn t first last characters - Cannot contain spaces valid_char_regex = r ^ a-zA-Z - \w- a-zA-Z - $ valid = bool re match valid_char_regex experiment_name valid True log error f Invalid experiment name experiment_name Experiment names should only contain alphanumeric characters _ - They cannot contain spaces special characters _ - cannot first last characters False parse_settings_from_text settings_text str - Settings Parse experiments issue body into list ExperimentSettings try settings_text Escape backtick well so we can have settings code block GH issue easy reading Note Using ascii backtick so cat step _runner-determinator yml doesn t choke backtick character shell commands backtick = chr backtick character settings_text = settings_text strip f \r\n\t backtick settings = load_yaml settings_text For now we just load experiments We can expand when we add more settings experiments = exp_name exp_settings settings get SETTING_EXPERIMENTS items is_valid_experiment_name exp_name Exclude invalid experiments list We log error don t raise exception so other experiments can still processed continue valid_settings = setting exp_settings setting Experiment _fields log warning f Unexpected setting experiment setting = exp_settings setting valid_settings setting = exp_settings setting experiments exp_name = Experiment valid_settings Settings experiments except Exception log exception Failed parse settings Settings parse_settings rollout_state str - Settings Parse settings any rollout state If issue body contains --- then text above settings text below list opted users If doesn t contain --- then settings empty default values used settings_text _ = extract_settings_user_opt_in_from_text rollout_state parse_settings_from_text settings_text parse_users rollout_state str - UserOptins Parse users rollout state _ users_text = extract_settings_user_opt_in_from_text rollout_state parse_user_opt_in_from_text users_text is_user_opted_in user str user_optins UserOptins experiment_name str - bool Check user opted into experiment experiment_name user_optins get user is_user_opted_out user str user_optins UserOptins experiment_name str - bool Check user explicitly opted out experiment experiment prefixed - then s opt-out experiment_optout = - + experiment_name experiment_optout user_optins get user False is_user_opted_in user user_optins experiment_name log warning f User user opted into experiment experiment_name also opted out Defaulting opting out True get_runner_prefix rollout_state str workflow_requestors Iterable str branch str eligible_experiments frozenset str = frozenset opt_out_experiments frozenset str = frozenset is_canary bool = False - str settings = parse_settings rollout_state user_optins = parse_users rollout_state fleet_prefix = prefixes = experiment_name experiment_settings settings experiments items experiment_settings all_branches is_exception_branch branch log info f Branch branch exception branch Not enabling experiment experiment_name continue opt_out_experiments experiment_name opt_out_experiments opt_out_exp_list = join opt_out_experiments log info f Skipping experiment experiment_name workflow has opted-out opted out experiments opt_out_exp_list continue eligible_experiments experiment_name eligible_experiments exp_list = join eligible_experiments log info f Skipping experiment experiment_name eligible_experiments list exp_list continue experiment_settings default log info f Skipping experiment experiment_name default experiment continue Is any workflow_requestor opted out experiment opted_out_users = requestor requestor workflow_requestors is_user_opted_out requestor user_optins experiment_name opted_out_users log info f join opted_out_users have opted out experiment experiment_name continue Is any workflow_requestor opted experiment opted_in_users = requestor requestor workflow_requestors is_user_opted_in requestor user_optins experiment_name enabled = False opted_in_users log info f join opted_in_users have opted into experiment experiment_name enabled = True experiment_settings rollout_perc If no user opted then we randomly enable experiment based rollout percentage random uniform = experiment_settings rollout_perc log info f Based rollout percentage experiment_settings rollout_perc enabling experiment experiment_name enabled = True enabled label = experiment_name experiment_name == LF_FLEET_EXPERIMENT We give some special treatment lf experiment since determines fleet we use - If s enabled then we always list s prefix first - If we re canary branch then we append c lf prefix is_canary label += CANARY_FLEET_SUFFIX fleet_prefix = label prefixes append label len prefixes log error f Only fleet one other experiment can enabled job any time Enabling prefixes ignoring rest which join prefixes prefixes = prefixes Fleet always comes first fleet_prefix prefixes insert fleet_prefix join prefixes + prefixes get_rollout_state_from_issue github_token str repo str issue_num int - str Gets first comment issue which contains desired rollout state The default issue we use - https github com pytorch test-infra issues gh = get_gh_client github_token issue = get_issue gh repo issue_num str issue get_comments body strip \n\t download_json url str headers dict str str num_retries int = - Any _ range num_retries try req = Request url=url headers=headers content = urlopen req timeout= read decode utf- json loads content except Exception e log warning f Could download url e log warning f All num_retries retries exhausted downloading url failed cache get_pr_info github_repo str github_token str pr_number int - dict str Any Dynamically get PR information github_api = f https api github com repos github_repo headers = Accept application vnd github v +json Authorization f token github_token json_response dict str Any = download_json url=f github_api issues pr_number headers=headers json_response log warning f Failed get labels pr_number json_response get_labels github_repo str github_token str pr_number int - set str Dynamically get latest list labels pull request pr_info = get_pr_info github_repo github_token pr_number label get name label pr_info get labels label get name main - None args = parse_args runner_label_prefix = DEFAULT_LABEL_PREFIX Check PR opt-out args pr_number labels = get_labels args github_repo args github_token int args pr_number OPT_OUT_LABEL labels log info f Opt-out runner determinator because args pr_number has OPT_OUT_LABEL label set_github_output GH_OUTPUT_KEY_LABEL_TYPE runner_label_prefix sys exit try rollout_state = get_rollout_state_from_issue args github_token args github_issue_repo args github_issue username = get_potential_pr_author args github_token args github_repo args github_actor args github_ref_type args github_branch is_canary = args github_repo == pytorch pytorch-canary runner_label_prefix = get_runner_prefix rollout_state args github_issue_owner username args github_branch args eligible_experiments args opt_out_experiments is_canary except Exception e log error f Failed get issue Defaulting Meta runners no experiments Exception e set_github_output GH_OUTPUT_KEY_LABEL_TYPE runner_label_prefix __name__ == __main__ main
Adapted https github com arogozhnikov einops blob c bb e d e f f f e abdf f f einops parsing py MIT License Copyright c Alex Rogozhnikov Permission hereby granted free charge any person obtaining copy software associated documentation files Software deal Software without restriction including without limitation rights use copy modify merge publish distribute sublicense sell copies Software permit persons whom Software furnished do so subject following conditions The above copyright notice permission notice shall included all copies substantial portions Software THE SOFTWARE IS PROVIDED AS IS WITHOUT WARRANTY OF ANY KIND EXPRESS OR IMPLIED INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM DAMAGES OR OTHER LIABILITY WHETHER IN AN ACTION OF CONTRACT TORT OR OTHERWISE ARISING FROM OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE __future__ annotations keyword warnings typing Optional TYPE_CHECKING Union TYPE_CHECKING collections abc Collection Mapping _ellipsis str = \u NB single unicode symbol String used list can iterated AnonymousAxis Used ` ParsedExpression ` represent axis size no associated identifier Note Different instances equal each other even they have same value __init__ value str - None value = int value value raise ValueError f Anonymous axis should have positive length value __repr__ - str f value -axis ParsedExpression Structure containing information about one side ` einops ` -style pattern e g b c h w __init__ expression str allow_underscore bool = False allow_duplicates bool = False - None Parse expression store relevant metadata Args expression str ` einops ` -pattern parse allow_underscore bool whether allow axis identifier names begin underscore allow_duplicates bool whether allow identifier appear more than once expression has_ellipsis bool = False has_ellipsis_parenthesized Optional bool = None identifiers set Union str AnonymousAxis = set s axes like Axes size exceptional replaced empty composition has_non_unitary_anonymous_axes bool = False composition keeps structure composite axes see how different corner cases handled tests composition list Union list Union str AnonymousAxis str = expression expression raise ValueError Expression may contain dots only inside ellipsis str count expression = str count expression = raise ValueError Expression may contain dots only inside ellipsis only one ellipsis tensor expression = expression replace _ellipsis has_ellipsis = True bracket_group Optional list Union str AnonymousAxis = None add_axis_name x str - None x identifiers allow_underscore x == _ allow_duplicates raise ValueError f Indexing expression contains duplicate dimension x x == _ellipsis identifiers add _ellipsis bracket_group None composition append _ellipsis has_ellipsis_parenthesized = False bracket_group append _ellipsis has_ellipsis_parenthesized = True is_number = str isdecimal x is_number int x == handling case anonymous axis length bracket_group None composition append pass no need think about s inside parenthesis is_axis_name reason = check_axis_name_return_reason x allow_underscore=allow_underscore is_number is_axis_name raise ValueError f Invalid axis identifier x \n reason axis_name Union str AnonymousAxis = AnonymousAxis x is_number x identifiers add axis_name is_number has_non_unitary_anonymous_axes = True bracket_group None composition append axis_name bracket_group append axis_name current_identifier = None char expression char current_identifier None add_axis_name current_identifier current_identifier = None char == bracket_group None raise ValueError Axis composition one-level brackets inside brackets allowed bracket_group = char == bracket_group None raise ValueError Brackets balanced composition append bracket_group bracket_group = None str isalnum char char _ _ellipsis current_identifier None current_identifier = char current_identifier += char raise ValueError f Unknown character char bracket_group None raise ValueError f Imbalanced parentheses expression expression current_identifier None add_axis_name current_identifier staticmethod check_axis_name_return_reason name str allow_underscore bool = False - tuple bool str Check given axis name valid message explaining why Valid axes names python identifiers except keywords should start end underscore Args name str axis name check allow_underscore bool whether axis names allowed start underscore Returns tuple bool str whether axis name valid message explaining why str isidentifier name False valid python identifier name == _ name - == _ name == _ allow_underscore True False axis name should should start end underscore keyword iskeyword name warnings warn f It discouraged use axes names keywords name RuntimeWarning name axis warnings warn It discouraged use axis axis name will raise error future FutureWarning True staticmethod check_axis_name name str - bool Check name valid axis name Args name str axis name check Returns bool whether axis name valid is_valid _ = ParsedExpression check_axis_name_return_reason name is_valid parse_pattern pattern str axes_lengths Mapping str int - tuple ParsedExpression ParsedExpression Parse ` einops ` -style pattern into left-hand side right-hand side ` ParsedExpression ` object Args pattern str ` einops ` -style rearrangement pattern axes_lengths Mapping str int any additional length specifications dimensions Returns tuple ParsedExpression ParsedExpression tuple containing left-hand side right-hand side expressions adapted einops einops _prepare_transformation_recipe https github com arogozhnikov einops blob ac c f c e f c f df einops einops py try left_str right_str = pattern split - except ValueError raise ValueError Pattern must contain single - separator None _ellipsis axes_lengths raise ValueError f _ellipsis allowed axis identifier left = ParsedExpression left_str right = ParsedExpression right_str left has_ellipsis right has_ellipsis raise ValueError f Ellipsis found right side left side pattern pattern left has_ellipsis left has_ellipsis_parenthesized raise ValueError f Ellipsis parenthesis left side allowed pattern left right validate_rearrange_expressions left ParsedExpression right ParsedExpression axes_lengths Mapping str int - None Perform expression validations specific ` rearrange ` operation Args left ParsedExpression left-hand side expression right ParsedExpression right-hand side expression axes_lengths Mapping str int any additional length specifications dimensions length axes_lengths values length_type = type length int raise TypeError f rearrange axis lengths must integers got length_type left has_non_unitary_anonymous_axes right has_non_unitary_anonymous_axes raise ValueError rearrange only supports unnamed axes size difference = set symmetric_difference left identifiers right identifiers len difference raise ValueError f Identifiers only one side rearrange expression should both difference unmatched_axes = axes_lengths keys - left identifiers len unmatched_axes raise ValueError f Identifiers found rearrange expression unmatched_axes comma_separate collection Collection Union str Collection str - str Convert collection strings representing first dims into comma-separated string Args collection Collection Union str Collection str collection strings convert Returns str comma-separated string Examples comma_separate d d comma_separate d d d d d d d d comma_separate d d d d comma_separate d d d d d d d d d d join item isinstance item str f comma_separate item len item == item collection
Mutation tracking dynamic module detection system Dynamo This module provides mechanisms track respond mutations PyTorch modules detect dynamically created modified modules Key components - MutationTracker Tracks mutations objects invalidates associated cached code - GenerationTracker Tracks module creation timing identify dynamic instances - Patching system nn Module detect mutations dynamic creation The system ensures Dynamo s optimizations remain valid detecting responding runtime changes module state structure functools weakref collections abc MutableMapping typing Any torch nn torch nn Module config utils ExactWeakKeyDictionary nn_module_has_global_hooks unpatched_nn_module_init = torch nn Module __init__ MutationTracker db ExactWeakKeyDictionary = ExactWeakKeyDictionary __init__ - None mutation_count int = watchers list weakref ReferenceType Any = on_mutation name str - None mutation_count += tmp = watchers watchers = ref tmp guarded = ref guarded None guarded invalidate ref track guarded_code Any - None watchers append weakref ref guarded_code watch obj Any guarded_code Any - None invalidate guarded_code when obj mutated ensure_patched type obj obj MutationTracker db MutationTracker db obj = MutationTracker tracker = MutationTracker db obj tracker track guarded_code ensure_patched cls Any - None getattr cls ___needs_mutation_patch True cls ___needs_mutation_patch = False original_setattr = cls __setattr__ functools wraps original_setattr custom_setattr Any key str value Any - None try MutationTracker db on_mutation key except KeyError pass original_setattr key value cls __setattr__ = custom_setattr GenerationTracker generation int = dynamic_classes ExactWeakKeyDictionary = ExactWeakKeyDictionary generation_values ExactWeakKeyDictionary = ExactWeakKeyDictionary classmethod tag cls obj Any - None cls generation_values obj = cls generation staticmethod mark_class_dynamic cls type torch nn Module - None assert issubclass cls torch nn Module GenerationTracker dynamic_classes cls = True classmethod get_generation_value cls obj Any - int obj cls generation_values - cls generation_values obj classmethod check cls obj Any - bool obj cls generation_values cls generation_values obj == cls generation classmethod clear cls - None cls generation = cls dynamic_classes = ExactWeakKeyDictionary cls generation_values = ExactWeakKeyDictionary is_dynamic_nn_module obj Any is_export bool - bool Check nn Modules created dynamically mutated isinstance obj torch nn Module forward obj __dict__ isinstance obj dict MutableMapping A monkey patched ` forward ` indicates something wacky going Similarly nn module also subclassed dict unusual True hasattr obj torchdynamo_force_dynamic obj torchdynamo_force_dynamic isinstance obj torch nn Module config inline_inbuilt_nn_modules is_export config install_free_tensors True isinstance obj torch nn Module nn_module_has_global_hooks True dyn = GenerationTracker dynamic_classes get type obj GenerationTracker check obj dyn install_generation_tagging_init - None Monkey patch torch nn Module __init__ torch nn Module __setstate__ so we can detect nn Module instances created dynamically inside forward methods getattr Module ___needs_generation_tag_patch True init = Module __init__ patched_init Module args Any kwargs Any - None init args kwargs GenerationTracker tag Module __init__ = patched_init type ignore method-assign setstate = Module __setstate__ patched_setstate Module state Any - None setstate state GenerationTracker tag Module __setstate__ = patched_setstate type ignore method-assign Module ___needs_generation_tag_patch = False type ignore attr-defined GenerationTracker generation +=
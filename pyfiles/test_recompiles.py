Owner s module dynamo unittest mock patch torch torch _dynamo test_case torch _dynamo testing torch _dynamo config dc RecompileTests torch _dynamo test_case TestCase test_inline_inbuilt_nn_modules_candidate hook_flag_on guard_manager f_locals builder assertTrue inline-inbuilt-nn-modules-candidate str guard_manager hook_flag_off guard_manager f_locals builder assertTrue inline-inbuilt-nn-modules-candidate str guard_manager SubMod torch nn Module __init__ super __init__ linear = torch nn Linear torch compile backend= eager forward x linear x Mod torch nn Module __init__ super __init__ sm = SubMod sm = SubMod forward x sm x + sm x try utils install_guard_manager_testing_hook except ImportError utils install_guard_manager_testing_hook install_guard_manager_testing_hook hook_flag_on dc patch inline_inbuilt_nn_modules=True mod = Mod mod torch randn install_guard_manager_testing_hook hook_flag_off dc patch inline_inbuilt_nn_modules=False mod = Mod mod torch randn test_automatic_dynamic_reduce_recompiles Test counterfactual lots recompiles without config foo x y x y run_foo_ _times_and_count_recompiles dynamic=None cnt = torch _dynamo testing CompileCounter x = torch randn y = torch randn opt = torch compile foo backend=cnt dynamic=dynamic opt x y x = torch randn y = torch randn opt x y x = torch randn y = torch randn opt x y opt x y x = torch randn y = torch randn opt x y opt x y x = torch randn y = torch randn opt x y cnt patch object torch _dynamo config automatic_dynamic_shapes False patch object torch _dynamo config assume_static_by_default True run_without_automatic run_foo_ _times_and_count_recompiles patch object torch _dynamo config automatic_dynamic_shapes True patch object torch _dynamo config assume_static_by_default True run_with_automatic run_foo_ _times_and_count_recompiles without = run_without_automatic assertEqual without frame_count assertEqual without op_count torch _dynamo reset without = run_foo_ _times_and_count_recompiles dynamic=False assertEqual without frame_count assertEqual without op_count torch _dynamo reset with_automatic = run_with_automatic assertEqual with_automatic frame_count assertEqual with_automatic op_count torch _dynamo reset with_automatic = run_foo_ _times_and_count_recompiles dynamic=None assertEqual with_automatic frame_count assertEqual with_automatic op_count torch _dynamo reset with_dynamic = run_foo_ _times_and_count_recompiles dynamic=True assertEqual with_dynamic frame_count assertEqual with_dynamic op_count patch object torch _dynamo config assume_static_by_default True test_recompiles_true_false_flop Test counterfactual lots recompiles without config foo x y x y y y run_foo_ _times_and_count_recompiles cnt = torch _dynamo testing CompileCounter opt = torch compile foo backend=cnt fullgraph=True x = True y = torch randn opt x y x = False y = torch randn opt x y x = True y = torch randn opt x y x = True y = torch randn opt x y x = True y = torch randn opt x y cnt patch object torch _dynamo config automatic_dynamic_shapes False patch object torch _dynamo config assume_static_by_default True run_without_automatic run_foo_ _times_and_count_recompiles patch object torch _dynamo config automatic_dynamic_shapes True patch object torch _dynamo config assume_static_by_default True run_with_automatic run_foo_ _times_and_count_recompiles without = run_without_automatic assertEqual without frame_count assertEqual without op_count torch _dynamo reset with_automatic = run_with_automatic assertEqual with_automatic frame_count assertEqual with_automatic op_count test_automatic_dynamic_tensor_scalar_change Test counterfactual lots recompiles without config foo x y x y run_foo_ _times_and_count_recompiles_swap_types cnt = torch _dynamo testing CompileCounter x = torch randn y = torch randn opt = torch compile foo backend=cnt opt x y x = torch randn y = opt x y x = torch randn y = torch randn opt x y opt x y x = torch randn y = opt x y opt x y x = torch randn y = torch randn opt x y cnt patch object torch _dynamo config automatic_dynamic_shapes False patch object torch _dynamo config assume_static_by_default True run_without_automatic run_foo_ _times_and_count_recompiles_swap_types patch object torch _dynamo config automatic_dynamic_shapes True patch object torch _dynamo config assume_static_by_default True run_with_automatic run_foo_ _times_and_count_recompiles_swap_types without = run_without_automatic assertEqual without frame_count assertEqual without op_count torch _dynamo reset with_automatic = run_with_automatic assertEqual with_automatic frame_count assertEqual with_automatic op_count test_aliasing_guard_failures foo b c add_ b c + cnt = torch _dynamo testing CompileCounter compiled_foo = torch compile foo backend=cnt fullgraph=True x = torch randn y = torch randn z = torch randn cmp_result = compiled_foo x detach clone y detach clone z detach clone eager_result = foo x detach clone y detach clone z detach clone assertEqual cmp_result eager_result assertEqual cnt frame_count cmp_result = compiled_foo z detach clone y detach clone x detach clone eager_result = foo z detach clone y detach clone x detach clone assertEqual cmp_result eager_result No recompile alias preserved assertEqual cnt frame_count x_clone = x detach clone cmp_result = compiled_foo x_clone y detach clone x_clone x_clone = x detach clone eager_result = compiled_foo x_clone y detach clone x_clone assertEqual cmp_result eager_result Recompile alias changed assertEqual cnt frame_count test_aliasing_guard_failures_with_globals g = torch randn g = torch randn foo add_ g g + cnt = torch _dynamo testing CompileCounter compiled_foo = torch compile foo backend=cnt fullgraph=True z = torch randn cmp_result = compiled_foo z detach clone eager_result = foo z detach clone assertEqual cmp_result eager_result assertEqual cnt frame_count g = g detach clone cmp_result = compiled_foo g g = g detach clone eager_result = compiled_foo g assertEqual cmp_result eager_result Recompile alias changed assertEqual cnt frame_count test_dynamic_shape_parameter_recompile Test matrix multiplication Parameters Without config assume_parameters_shapes_static_by_default torch nn Parameter shapes assumed static which leads recompilation w = torch nn Parameter torch randn foo x x w run_foo_ _times_and_count_recompiles cnt = torch _dynamo testing CompileCounter opt = torch compile foo backend=cnt fullgraph=True x = torch nn Parameter torch randn opt x x = torch nn Parameter torch randn opt x x = torch nn Parameter torch randn opt x x = torch nn Parameter torch randn opt x x = torch nn Parameter torch randn opt x cnt patch object torch _dynamo config force_parameter_static_shapes True patch object torch _dynamo config automatic_dynamic_shapes False patch object torch _dynamo config assume_static_by_default True run_static_comp_default_param run_foo_ _times_and_count_recompiles patch object torch _dynamo config force_parameter_static_shapes True patch object torch _dynamo config automatic_dynamic_shapes True patch object torch _dynamo config assume_static_by_default True run_dynamic_comp_default_param run_foo_ _times_and_count_recompiles patch object torch _dynamo config force_parameter_static_shapes False patch object torch _dynamo config automatic_dynamic_shapes False patch object torch _dynamo config assume_static_by_default True run_static_comp_dynamic_param run_foo_ _times_and_count_recompiles patch object torch _dynamo config force_parameter_static_shapes False patch object torch _dynamo config automatic_dynamic_shapes True patch object torch _dynamo config assume_static_by_default True run_dynamic_comp_dynamic_param run_foo_ _times_and_count_recompiles torch _dynamo reset static_comp_default_param = run_static_comp_default_param assertEqual static_comp_default_param frame_count assertEqual static_comp_default_param op_count torch _dynamo reset dynamic_comp_default_param = run_dynamic_comp_default_param assertEqual dynamic_comp_default_param frame_count assertEqual dynamic_comp_default_param op_count torch _dynamo reset static_comp_dynamic_param = run_static_comp_dynamic_param assertEqual static_comp_dynamic_param frame_count assertEqual static_comp_dynamic_param op_count torch _dynamo reset dynamic_comp_dynamic_param = run_dynamic_comp_dynamic_param assertEqual dynamic_comp_dynamic_param frame_count assertEqual dynamic_comp_dynamic_param op_count test_simple_module_recompile SimpleDropout torch nn Module __init__ - None super __init__ dropout = torch nn Dropout linear = torch nn Linear forward x dropout linear x model = SimpleDropout x = torch randn counter = torch _dynamo testing CompileCounter model = torch compile model backend=counter fullgraph=True _ range model eval model x model train model x assertEqual counter frame_count patch object torch _dynamo config recompile_limit test_no_recursive_compile_after_cache_limit_hit f x n x = x + n g x n g x n x = x + n h x n h x n x + n counter = torch _dynamo testing CompileCounter opt_f = torch compile f backend=counter dynamic=False i range opt_f torch ones i assertEqual counter frame_count test_automatic_dynamic_on_closed_ints f x g y y + x g counter = torch _dynamo testing CompileCounter torch compile backend=counter h x g g x i range h torch randn f i assertEqual counter frame_count patch object torch _dynamo config recompile_limit test_run_mode_after_cache_limit_hit f x n x = x + n torch _dynamo is_compiling x = x + g x n g x n x = x + n torch _dynamo is_compiling x = x + x counter = torch _dynamo testing CompileCounter opt_f = torch compile f backend=counter dynamic=False compiles assertEqual opt_f torch ones torch ones + assertEqual opt_f torch ones torch ones + cache limit hit assertEqual opt_f torch ones torch ones + assertEqual opt_f torch ones torch ones + run mode assertEqual opt_f torch ones torch ones + assertEqual opt_f torch ones torch ones + assertEqual counter frame_count torch _dynamo config patch automatic_dynamic_shapes_mark_as= unbacked test_automatic_dynamic_shapes_mark_as_unbacked counter = torch _dynamo testing CompileCounter torch compile backend=counter f x x x f torch randn f torch randn f torch randn f torch randn assertEqual counter frame_count three four torch _dynamo config patch automatic_dynamic_shapes_mark_as= oblivious test_automatic_dynamic_shapes_mark_as_oblivious counter = torch _dynamo testing CompileCounter f x x size x x + opt_f = torch compile backend=counter fullgraph=True f i assertEqual f torch zeros i opt_f torch zeros i assertEqual counter frame_count three four torch _dynamo config patch automatic_dynamic_shapes_mark_as= oblivious test_automatic_dynamic_shapes_mark_as_oblivious_fail_counterfactual counter = torch _dynamo testing CompileCounter f x x size x x + opt_f = torch compile backend=counter fullgraph=True f opt_f torch randn assertRaises torch _dynamo exc UserError opt_f torch randn test_ambient_autocast_recompile weights = torch randn counter = torch _dynamo testing CompileCounterWithBackend aot_eager torch compile backend=counter fullgraph=True fn x torch mm x weights x = torch randn assertEqual fn x dtype torch float torch autocast cpu torch float assertEqual fn x dtype torch float torch autocast cpu torch bfloat assertEqual fn x dtype torch bfloat should recompile each time assertEqual counter frame_count test_autocast_constant_fold test constant-folded autocast functions work properly - should work global autocast state guarded weights = torch randn counter = torch _dynamo testing CompileCounterWithBackend eager fn x torch get_autocast_dtype cpu == torch float x = x + x = x - torch mm x weights opt_fn = torch compile fn backend=counter fullgraph=True x = torch randn torch autocast cpu torch float assertEqual fn x opt_fn x torch autocast cpu torch bfloat assertEqual fn x opt_fn x assertEqual counter frame_count test_dunder_call_recompile Foo __call__ x x + counter = torch _dynamo testing CompileCounter torch compile backend=counter f x foo foo x x = torch ones foo = Foo foo = Foo no recompilation f x foo f x foo assertEqual counter frame_count one recompilation Foo __call__ = lambda x x + f x foo assertEqual counter frame_count test_no_recompile_over_unused_objects This regression test case imitates https github com city ComfyUI-GGUF blob bec dd ad e f ops py#L -L counter = torch _dynamo testing CompileCounter f x key patches x x + torch compile backend=counter fullgraph=True apply_patches f x keys patches = key patch keys noqa F patches append patch x = f x key patches x no recompilation x = torch rand apply_patches f x b assertEqual counter frame_count apply_patches f x c d assertEqual counter frame_count __name__ == __main__ torch _dynamo test_case run_tests run_tests
Owner s module custom-operators copy torch torch _dynamo test_case run_tests TestCase torch _library fake_class_registry maybe_to_fake_obj torch _library opaque_object get_payload make_opaque OpaqueType set_payload torch _subclasses fake_tensor FakeTensorMode torch fx experimental proxy_tensor make_fx torch testing _internal common_utils instantiate_parametrized_tests parametrize OpaqueQueue __init__ queue list torch Tensor init_tensor_ torch Tensor - None super __init__ queue = queue init_tensor_ = init_tensor_ For testing purposes _push_counter = _pop_counter = _size_counter = push tensor torch Tensor - None _push_counter += queue append tensor pop - torch Tensor _pop_counter += len queue queue pop init_tensor_ size - int _size_counter += len queue __eq__ other len queue = len other queue False q q zip queue other queue torch allclose q q False torch allclose init_tensor_ other init_tensor_ TestOpaqueObject TestCase setUp lib = torch library Library _TestOpaqueObject FRAGMENT noqa TOR torch library define _TestOpaqueObject queue_push __torch__ torch classes aten OpaqueObject Tensor b - tags=torch Tag pt _compliant_tag lib=self lib torch library impl _TestOpaqueObject queue_push CompositeExplicitAutograd lib=self lib push_impl q torch _C ScriptObject b torch Tensor - None queue = get_payload q assert isinstance queue OpaqueQueue queue push b torch library register_fake _TestOpaqueObject queue_push lib=self lib push_impl_fake q torch _C ScriptObject b torch Tensor - None pass lib define queue_pop __torch__ torch classes aten OpaqueObject - Tensor pop_impl q torch _C ScriptObject - torch Tensor queue = get_payload q assert isinstance queue OpaqueQueue queue pop lib impl queue_pop pop_impl CompositeExplicitAutograd pop_impl_fake q torch _C ScriptObject - torch Tensor This accurate since queue could have tensors rank ctx = torch _custom_op impl get_ctx u = ctx create_unbacked_symint torch empty u lib _register_fake queue_pop pop_impl_fake torch library custom_op _TestOpaqueObject queue_size mutates_args= size_impl q OpaqueType - int queue = get_payload q assert isinstance queue OpaqueQueue queue size size_impl register_fake size_impl_fake q torch _C ScriptObject - int ctx = torch _custom_op impl get_ctx u = ctx create_unbacked_symint torch _check_is_size u u super setUp tearDown lib _destroy super tearDown test_creation queue = OpaqueQueue torch zeros obj = make_opaque queue assertTrue isinstance obj torch _C ScriptObject assertEqual str obj _type __torch__ torch classes aten OpaqueObject obj payload stores direct reference python queue object payload = get_payload obj assertEqual payload queue queue push torch ones assertEqual payload size test_ops queue = OpaqueQueue torch zeros obj = make_opaque set_payload obj queue torch ops _TestOpaqueObject queue_push obj torch ones + assertEqual queue size size = torch ops _TestOpaqueObject queue_size obj assertEqual size queue size popped = torch ops _TestOpaqueObject queue_pop obj assertEqual popped torch ones + assertEqual queue size test_eq assertTrue make_opaque moo == make_opaque moo assertFalse make_opaque moo == make_opaque mop q = OpaqueQueue torch ones torch zeros q = OpaqueQueue torch ones torch zeros obj = make_opaque q obj = make_opaque q assertTrue obj == obj assertTrue q == q assertTrue obj == obj test_deepcopy q = OpaqueQueue torch ones torch ones torch zeros obj = make_opaque q obj = copy deepcopy obj q = get_payload obj assertTrue q q assertTrue q == q test_bad_fake torch library define _TestOpaqueObject bad_fake __torch__ torch classes aten OpaqueObject q Tensor x - Tensor lib=self lib f q x torch ops _TestOpaqueObject bad_fake q x x cos bad_fake q torch _C ScriptObject b torch Tensor - torch Tensor payload = get_payload q b payload torch library register_fake _TestOpaqueObject bad_fake bad_fake lib=self lib FakeTensorMode fake_mode obj = make_opaque fake_obj = maybe_to_fake_obj fake_mode obj x = torch ones assertRaisesRegex ValueError get_payload function called FakeScriptObject torch ops _TestOpaqueObject bad_fake fake_obj x bad_fake q torch _C ScriptObject b torch Tensor - torch Tensor set_payload q torch empty_like b torch library register_fake _TestOpaqueObject bad_fake bad_fake lib=self lib allow_override=True FakeTensorMode fake_mode obj = make_opaque fake_obj = maybe_to_fake_obj fake_mode obj x = torch ones assertRaisesRegex ValueError set_payload function called FakeScriptObject torch ops _TestOpaqueObject bad_fake fake_obj x parametrize make_fx_tracing_mode fake symbolic test_make_fx make_fx_tracing_mode M torch nn Module forward queue x torch ops _TestOpaqueObject queue_push queue x tan torch ops _TestOpaqueObject queue_push queue x cos torch ops _TestOpaqueObject queue_push queue x sin pop = torch ops _TestOpaqueObject queue_pop queue size = torch ops _TestOpaqueObject queue_size queue pop = torch ops _TestOpaqueObject queue_pop queue size = torch ops _TestOpaqueObject queue_size queue x_cos = pop + size x_sin = pop - size x_sin + x_cos q = OpaqueQueue torch empty fill_ - obj = make_opaque q q = OpaqueQueue torch empty fill_ - obj = make_opaque q x = torch ones gm = make_fx M tracing_mode=make_fx_tracing_mode obj x assertTrue torch allclose gm obj x M obj x assertEqual q _push_counter assertEqual q _pop_counter assertEqual q _size_counter assertEqual q size assertExpectedInline gm code strip \n \ forward arg _ arg _ tan = torch ops aten tan default arg _ queue_push = torch ops _TestOpaqueObject queue_push default arg _ tan tan = queue_push = None cos = torch ops aten cos default arg _ queue_push_ = torch ops _TestOpaqueObject queue_push default arg _ cos cos = queue_push_ = None sin = torch ops aten sin default arg _ arg _ = None queue_push_ = torch ops _TestOpaqueObject queue_push default arg _ sin sin = queue_push_ = None queue_pop = torch ops _TestOpaqueObject queue_pop default arg _ queue_size = torch ops _TestOpaqueObject queue_size default arg _ queue_pop_ = torch ops _TestOpaqueObject queue_pop default arg _ queue_size_ = torch ops _TestOpaqueObject queue_size default arg _ arg _ = None add = torch ops aten add Tensor queue_pop queue_size queue_pop = queue_size = None sub = torch ops aten sub Tensor queue_pop_ queue_size_ queue_pop_ = queue_size_ = None add_ = torch ops aten add Tensor sub add sub = add = None add_ instantiate_parametrized_tests TestOpaqueObject __name__ == __main__ run_tests
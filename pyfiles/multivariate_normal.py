mypy allow-untyped-defs math typing Optional torch torch Tensor torch distributions constraints torch distributions distribution Distribution torch distributions utils _standard_normal lazy_property torch types _size __all__ = MultivariateNormal _batch_mv bmat bvec r Performs batched matrix-vector product compatible different batch shapes This function takes input ` bmat ` containing math ` n \times n ` matrices ` bvec ` containing length math ` n ` vectors Both ` bmat ` ` bvec ` may have any number leading dimensions which correspond batch shape They necessarily assumed have same batch shape just ones which can broadcasted torch matmul bmat bvec unsqueeze - squeeze - _batch_mahalanobis bL bx r Computes squared Mahalanobis distance math ` \mathbf x ^\top\mathbf M ^ - \mathbf x ` factored math ` \mathbf M = \mathbf L \mathbf L ^\top ` Accepts batches both bL bx They necessarily assumed have same batch shape ` bL ` one should able broadcasted ` bx ` one n = bx size - bx_batch_shape = bx shape - Assume bL shape = i n n bx shape = i j n we going make bx have shape j i n apply batched tri solve bx_batch_dims = len bx_batch_shape bL_batch_dims = bL dim - outer_batch_dims = bx_batch_dims - bL_batch_dims old_batch_dims = outer_batch_dims + bL_batch_dims new_batch_dims = outer_batch_dims + bL_batch_dims Reshape bx shape i j n bx_new_shape = bx shape outer_batch_dims sL sx zip bL shape - bx shape outer_batch_dims - bx_new_shape += sx sL sL bx_new_shape += n bx = bx reshape bx_new_shape Permute bx make have shape j i n permute_dims = list range outer_batch_dims + list range outer_batch_dims new_batch_dims + list range outer_batch_dims + new_batch_dims + new_batch_dims bx = bx permute permute_dims flat_L = bL reshape - n n shape = b x n x n flat_x = bx reshape - flat_L size n shape = c x b x n flat_x_swap = flat_x permute shape = b x n x c M_swap = torch linalg solve_triangular flat_L flat_x_swap upper=False pow sum - shape = b x c M = M_swap t shape = c x b Now we revert above reshape permute operators permuted_M = M reshape bx shape - shape = j i permute_inv_dims = list range outer_batch_dims i range bL_batch_dims permute_inv_dims += outer_batch_dims + i old_batch_dims + i reshaped_M = permuted_M permute permute_inv_dims shape = i j reshaped_M reshape bx_batch_shape _precision_to_scale_tril P Ref https nbviewer jupyter org gist fehiepsi ef e e f eb #Precision-to-scale_tril Lf = torch linalg cholesky torch flip P - - L_inv = torch transpose torch flip Lf - - - - Id = torch eye P shape - dtype=P dtype device=P device L = torch linalg solve_triangular L_inv Id upper=False L MultivariateNormal Distribution r Creates multivariate normal also called Gaussian distribution parameterized mean vector covariance matrix The multivariate normal distribution can parameterized either terms positive definite covariance matrix math ` \mathbf \Sigma ` positive definite precision matrix math ` \mathbf \Sigma ^ - ` lower-triangular matrix math ` \mathbf L ` positive-valued diagonal entries such math ` \mathbf \Sigma = \mathbf L \mathbf L ^\top ` This triangular matrix can obtained via e g Cholesky decomposition covariance Example xdoctest +REQUIRES env TORCH_DOCTEST_LAPACK xdoctest +IGNORE_WANT non-deterministic m = MultivariateNormal torch zeros torch eye m sample normally distributed mean= ` ` covariance_matrix= ` I ` tensor - - Args loc Tensor mean distribution covariance_matrix Tensor positive-definite covariance matrix precision_matrix Tensor positive-definite precision matrix scale_tril Tensor lower-triangular factor covariance positive-valued diagonal Note Only one attr ` covariance_matrix ` attr ` precision_matrix ` attr ` scale_tril ` can specified Using attr ` scale_tril ` will more efficient all computations internally based attr ` scale_tril ` If attr ` covariance_matrix ` attr ` precision_matrix ` passed instead only used compute corresponding lower triangular matrices using Cholesky decomposition pyrefly ignore bad-override arg_constraints = loc constraints real_vector covariance_matrix constraints positive_definite precision_matrix constraints positive_definite scale_tril constraints lower_cholesky support = constraints real_vector has_rsample = True __init__ loc Tensor covariance_matrix Optional Tensor = None precision_matrix Optional Tensor = None scale_tril Optional Tensor = None validate_args Optional bool = None - None loc dim raise ValueError loc must least one-dimensional covariance_matrix None + scale_tril None + precision_matrix None = raise ValueError Exactly one covariance_matrix precision_matrix scale_tril may specified scale_tril None scale_tril dim raise ValueError scale_tril matrix must least two-dimensional optional leading batch dimensions batch_shape = torch broadcast_shapes scale_tril shape - loc shape - pyrefly ignore read-only scale_tril = scale_tril expand batch_shape + - - covariance_matrix None covariance_matrix dim raise ValueError covariance_matrix must least two-dimensional optional leading batch dimensions batch_shape = torch broadcast_shapes covariance_matrix shape - loc shape - pyrefly ignore read-only covariance_matrix = covariance_matrix expand batch_shape + - - assert precision_matrix None helps mypy precision_matrix dim raise ValueError precision_matrix must least two-dimensional optional leading batch dimensions batch_shape = torch broadcast_shapes precision_matrix shape - loc shape - pyrefly ignore read-only precision_matrix = precision_matrix expand batch_shape + - - loc = loc expand batch_shape + - event_shape = loc shape - super __init__ batch_shape event_shape validate_args=validate_args scale_tril None _unbroadcasted_scale_tril = scale_tril covariance_matrix None _unbroadcasted_scale_tril = torch linalg cholesky covariance_matrix precision_matrix None _unbroadcasted_scale_tril = _precision_to_scale_tril precision_matrix expand batch_shape _instance=None new = _get_checked_instance MultivariateNormal _instance batch_shape = torch Size batch_shape loc_shape = batch_shape + event_shape cov_shape = batch_shape + event_shape + event_shape new loc = loc expand loc_shape new _unbroadcasted_scale_tril = _unbroadcasted_scale_tril covariance_matrix __dict__ new covariance_matrix = covariance_matrix expand cov_shape scale_tril __dict__ new scale_tril = scale_tril expand cov_shape precision_matrix __dict__ new precision_matrix = precision_matrix expand cov_shape super MultivariateNormal new __init__ batch_shape event_shape validate_args=False new _validate_args = _validate_args new lazy_property scale_tril - Tensor _unbroadcasted_scale_tril expand _batch_shape + _event_shape + _event_shape lazy_property covariance_matrix - Tensor torch matmul _unbroadcasted_scale_tril _unbroadcasted_scale_tril mT expand _batch_shape + _event_shape + _event_shape lazy_property precision_matrix - Tensor torch cholesky_inverse _unbroadcasted_scale_tril expand _batch_shape + _event_shape + _event_shape property mean - Tensor loc property mode - Tensor loc property variance - Tensor _unbroadcasted_scale_tril pow sum - expand _batch_shape + _event_shape rsample sample_shape _size = torch Size - Tensor shape = _extended_shape sample_shape eps = _standard_normal shape dtype=self loc dtype device=self loc device loc + _batch_mv _unbroadcasted_scale_tril eps log_prob value _validate_args _validate_sample value diff = value - loc M = _batch_mahalanobis _unbroadcasted_scale_tril diff half_log_det = _unbroadcasted_scale_tril diagonal dim =- dim =- log sum - - _event_shape math log math pi + M - half_log_det entropy half_log_det = _unbroadcasted_scale_tril diagonal dim =- dim =- log sum - H = _event_shape + math log math pi + half_log_det len _batch_shape == H H expand _batch_shape
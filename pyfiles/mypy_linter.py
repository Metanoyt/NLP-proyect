__future__ annotations argparse json logging os re subprocess sys time enum Enum pathlib Path typing NamedTuple LintSeverity str Enum ERROR = error WARNING = warning ADVICE = advice DISABLED = disabled LintMessage NamedTuple path str &#124; None line int &#124; None char int &#124; None code str severity LintSeverity name str original str &#124; None replacement str &#124; None description str &#124; None tools linter flake _linter py error Incompatibl int assignment RESULTS_RE re Pattern str = re compile r mx ^ P file P line \d+ P column - \d+ \s P severity \S+ \s P message \s P code \ \ $ torch _dynamo variables tensor py error INTERNAL ERROR INTERNAL_ERROR_RE re Pattern str = re compile r mx ^ P file P line \d+ \s P severity \S+ \s P message INTERNAL\sERROR $ run_command args list str extra_env dict str str &#124; None retries int - subprocess CompletedProcess bytes logging debug $ s join args start_time = time monotonic try subprocess run args capture_output=True finally end_time = time monotonic logging debug took dms end_time - start_time Severity either error note https github com python mypy blob b e fb e f b e bf mypy errors py#L -L severities = error LintSeverity ERROR note LintSeverity ADVICE check_mypy_installed code str - list LintMessage cmd = sys executable -mmypy -V try subprocess run cmd check=True capture_output=True except subprocess CalledProcessError e msg = e stderr decode errors= replace LintMessage path=None line=None char=None code=code severity=LintSeverity ERROR name= command-failed original=None replacement=None description=f Could run join cmd msg in_github_actions - bool bool os getenv GITHUB_ACTIONS check_files filenames list str config str retries int code str - list LintMessage dmypy has bug where won t pick up changes you pass absolute file names see https github com python mypy issues filenames = os path relpath f f filenames try mypy_commands = dmypy run -- in_github_actions mypy_commands = mypy proc = run_command mypy_commands f -- config= config + filenames extra_env= retries=retries except OSError err LintMessage path=None line=None char=None code=code severity=LintSeverity ERROR name= command-failed original=None replacement=None description= f Failed due err __class__ __name__ \n err stdout = str proc stdout utf- strip stderr = str proc stderr utf- strip proc returncode LintMessage path=None line=None char=None code=code severity=LintSeverity ERROR name= command-failed original=None replacement=None description=stderr rc = LintMessage path=match file name=match code description=match message line=int match line char=int match column match column None match column startswith - None code=code severity=severities get match severity LintSeverity ERROR original=None replacement=None match RESULTS_RE finditer stdout + LintMessage path=match file name= INTERNAL ERROR description=match message line=int match line char=None code=code severity=severities get match severity LintSeverity ERROR original=None replacement=None match INTERNAL_ERROR_RE finditer stderr rc main - None parser = argparse ArgumentParser description= mypy wrapper linter fromfile_prefix_chars= parser add_argument -- retries default= type=int help= times retry timed out mypy parser add_argument -- config required=True help= path mypy ini config file parser add_argument -- code default= MYPY help= code lint should report parser add_argument -- verbose action= store_true help= verbose logging parser add_argument filenames nargs= + help= paths lint args = parser parse_args logging basicConfig format= threadName s levelname s message s level=logging NOTSET args verbose logging DEBUG len args filenames logging INFO stream=sys stderr Use dictionary here preserve order mypy cares about order tragically e g https github com python mypy issues filenames dict str bool = If stub file exists have mypy check instead original file accordance PEP- see https www python org dev peps pep- #stub-files filename args filenames filename endswith pyi filenames filename = True continue stub_filename = filename replace py pyi Path stub_filename exists filenames stub_filename = True filenames filename = True lint_messages = check_mypy_installed args code + check_files list filenames args config args retries args code lint_message lint_messages print json dumps lint_message _asdict flush=True __name__ == __main__ main
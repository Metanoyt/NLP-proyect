json os subprocess time pathlib Path typing Any cast Optional requests clickhouse query_clickhouse type ignore REPO_ROOT = Path __file__ resolve parent parent parent QUERY = WITH most_recent_strict_commits AS SELECT distinct push head_commit id sha FROM -- bothering final default push WHERE push ref = refs heads viable strict AND push repository full_name = pytorch pytorch ORDER BY push head_commit timestamp desc LIMIT workflows AS SELECT id FROM default workflow_run w final WHERE w id select id materialized_views workflow_run_by_head_sha where head_sha select sha most_recent_strict_commits w name = periodic job AS SELECT j id id FROM default workflow_job j final WHERE j run_id select id workflows j name NOT LIKE asan duration_per_job AS SELECT test_run classname classname test_run name name job id id SUM test_run time time FROM default test_run_s test_run INNER JOIN job ON test_run job_id = job id WHERE cpp tests do populate ` file ` some reason Exclude them we don t include them our slow test infra test_run file = do some more filtering cut down test_run size AND empty test_run skipped AND empty test_run failure AND empty test_run error test_run job_id select id job GROUP BY test_run classname test_run name job id SELECT CONCAT name __main__ classname test_name AVG time avg_duration_sec FROM duration_per_job GROUP BY CONCAT name __main__ classname HAVING AVG time ORDER BY test_name UPDATEBOT_TOKEN = os environ UPDATEBOT_TOKEN PYTORCHBOT_TOKEN = os environ PYTORCHBOT_TOKEN git_api url str params dict str Any type str = get token str = UPDATEBOT_TOKEN - Any headers = Accept application vnd github v +json Authorization f token token type == post requests post f https api github com url data=json dumps params headers=headers json type == patch requests patch f https api github com url data=json dumps params headers=headers json requests get f https api github com url params=params headers=headers json make_pr source_repo str params dict str Any - int response = git_api f repos source_repo pulls params type= post print f made pr response html_url cast int response number approve_pr source_repo str pr_number int - None params = event APPROVE use pytorchbot approve pr git_api f repos source_repo pulls pr_number reviews params type= post token=PYTORCHBOT_TOKEN make_comment source_repo str pr_number int msg str - None params = body msg comment pytorchbot because pytorchmergebot gets ignored git_api f repos source_repo issues pr_number comments params type= post token=PYTORCHBOT_TOKEN add_labels source_repo str pr_number int labels list str - None params = labels labels git_api f repos source_repo issues pr_number labels params type= post search_for_open_pr source_repo str search_string str - Optional tuple int str params = q f pr open title author pytorchupdatebot repo source_repo search_string sort created response = git_api search issues params response total_count = pr does exist pr_num = response items number link = response items html_url response = git_api f repos source_repo pulls pr_num branch_name = response head ref print f pr does exist number pr_num branch name branch_name link link pr_num branch_name None __name__ == __main__ results = query_clickhouse QUERY slow_tests = row test_name row avg_duration_sec row results open REPO_ROOT test slow_tests json w f json dump slow_tests f indent= branch_name = f update_slow_tests_ int time time pr_num = None open_pr = search_for_open_pr pytorch pytorch Update slow tests open_pr None pr_num branch_name = open_pr subprocess run git checkout -b branch_name cwd=REPO_ROOT subprocess run git add test slow_tests json cwd=REPO_ROOT subprocess run git commit -m Update slow tests cwd=REPO_ROOT subprocess run f git push -- set-upstream origin branch_name -f split cwd=REPO_ROOT params = title Update slow tests head branch_name base main body This PR auto-generated weekly action https github com pytorch pytorch blob main + github workflows weekly yml \nUpdate list slow tests pr_num None no existing pr so make new one approve pr_num = make_pr pytorch pytorch params time sleep add_labels pytorch pytorch pr_num ciflow slow ci-no-td approve_pr pytorch pytorch pr_num make_comment pytorch pytorch pr_num pytorchbot merge
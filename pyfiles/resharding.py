torch distributed checkpoint metadata ChunkStorageMetadata __all__ list str = _check_shard_metadata_pair_overlap shard ChunkStorageMetadata shard ChunkStorageMetadata - bool Check two shards overlap For each dim each shard check one shard resides other end second shard respect dim As example D shard we would check one shard above left other shard ndims = len shard offsets i range ndims shard offsets i = shard offsets i + shard sizes i False shard offsets i = shard offsets i + shard sizes i False True _shards_get_overlap_region_wrt_saved_tensor saved_shard ChunkStorageMetadata current_shard ChunkStorageMetadata - list tuple int int int int Return overlapping region between saved_shard current_shard There returned list has same number elements tensor s dimension For each element we produce tuple following contents dimension ` saved_shard ` offset ` current_shard ` offset length Offsets relative each shard narrows = dim saved_shard_offset current_shard_offset saved_shard_size current_shard_size enumerate zip saved_shard offsets current_shard offsets saved_shard sizes current_shard sizes min_range_end = min saved_shard_offset + saved_shard_size current_shard_offset + current_shard_size length = min_range_end - max current_shard_offset saved_shard_offset saved_shard_offset current_shard_offset offset_for_saved_tensor = offset_for_current_tensor = saved_shard_offset - current_shard_offset offset_for_saved_tensor = current_shard_offset - saved_shard_offset offset_for_current_tensor = narrows append dim offset_for_saved_tensor offset_for_current_tensor length narrows
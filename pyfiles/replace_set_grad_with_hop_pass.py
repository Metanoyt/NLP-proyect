mypy allow-untyped-defs __future__ annotations typing TYPE_CHECKING torch torch _higher_order_ops wrap wrap_with_set_grad_enabled utils node_inline_ nodes_filter nodes_first nodes_map sequential_split replace_with_hop_pass_util _replace_with_hop_helper _replace_with_hop_pass_helper _sequential_split_and_maybe_inline_subgraphs_helper TYPE_CHECKING torch export graph_signature ExportGraphSignature _is_set_grad_enabled_node node torch fx Node - torch fx Node &#124; bool node node op == call_function node target torch _C _set_grad_enabled _is_set_grad_enabled_sub_mod node torch fx Node omit_if_same_with_ambient bool = False - bool &#124; torch Tensor node op == call_module assert isinstance node target str subgm = getattr node graph owning_module node target first_non_ph = nodes_first subgm graph nodes lambda node node op = placeholder first_non_ph first_non_ph op == call_function first_non_ph target torch _C _set_grad_enabled first_non_ph args = torch is_grad_enabled omit_if_same_with_ambient True False _replace_with_hop node torch fx Node - None assert node op == call_module graph torch fx Graph = node graph assert graph owning_module None gm torch fx GraphModule = graph owning_module assert isinstance node target str sub_gm = getattr gm node target sub_graph = sub_gm graph set_grad_nodes = nodes_filter sub_graph nodes _is_set_grad_enabled_node len set_grad_nodes assert len set_grad_nodes == set_grad_node = set_grad_nodes _replace_with_hop_helper node set_grad_node wrap_with_set_grad_enabled sub_graph erase_node set_grad_node _remove_set_grad_and_inline node torch fx Node - None assert node op == call_module graph torch fx Graph = node graph assert graph owning_module None gm torch fx GraphModule = graph owning_module assert isinstance node target str sub_gm = getattr gm node target sub_graph = sub_gm graph nodes_map sub_graph nodes lambda n sub_graph erase_node n _is_set_grad_enabled_node n n node_inline_ node _sequential_split_and_maybe_inline_subgraphs gm torch fx GraphModule graph_signature ExportGraphSignature &#124; None - tuple torch fx GraphModule ExportGraphSignature &#124; None Helper function replace_set_grad_with_hop_pass Split graph module into multiple subgraphs based set_grad_enabled nodes For each subgraph decides whether construct HOO subgraph inline calls back into parent graph module need_replacing = any _is_set_grad_enabled_node node node gm graph nodes need_replacing gm graph_signature sequential_split returns new graph module could have different output args names We need fix graph signature new_gm = sequential_split gm _is_set_grad_enabled_node _maybe_inline_or_replace_with_hop node torch fx Node _is_set_grad_enabled_sub_mod node omit_if_same_with_ambient=True _replace_with_hop node _remove_set_grad_and_inline node _sequential_split_and_maybe_inline_subgraphs_helper new_gm graph_signature _maybe_inline_or_replace_with_hop replace_set_grad_with_hop_pass gm torch fx GraphModule graph_signature ExportGraphSignature &#124; None - tuple torch fx GraphModule ExportGraphSignature &#124; None Split gm into sub-graph-modules using ` sequential_split_and_maybe_inline_subgraphs ` then recursively call itself each submodules _replace_with_hop_pass_helper gm graph_signature _sequential_split_and_maybe_inline_subgraphs
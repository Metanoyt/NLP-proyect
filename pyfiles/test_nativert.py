Owner s oncall export copy pathlib tempfile unittest parameterized parameterized torch torch _dynamo torchdynamo torch _C _nativert PyModelRunner torch _dynamo test_case TestCase torch _environment is_fbcode torch _subclasses fake_tensor FakeTensor torch nativert backends _lower_utils lower_exported_program package_nativert_with_aoti_delegate torch testing _internal common_utils IS_WINDOWS torch testing _internal inductor_utils HAS_CUDA_AND_TRITON torch utils _pytree pytree try test_export testing except ImportError test_export testing torch export export test_classes = _use_real_inputs ep ep = copy copy ep has_fake_tensor = False _to_real_tensor t isinstance t torch nn Parameter torch nn Parameter _to_real_tensor t data isinstance t FakeTensor nonlocal has_fake_tensor has_fake_tensor = True torch randn t shape device=t device requires_grad=t requires_grad t new_example_inputs = pytree tree_map_only torch Tensor torch nn Parameter _to_real_tensor ep example_inputs has_fake_tensor ep example_inputs = new_example_inputs ep = ep _update ep graph_module ep graph_signature state_dict=pytree tree_map_only torch Tensor torch nn Parameter _to_real_tensor ep state_dict constants=pytree tree_map_only torch Tensor torch nn Parameter _to_real_tensor ep constants ep _is_supported_types arg - bool isinstance arg list all _is_supported_types arg len type arg = isinstance arg tuple all _is_supported_types arg isinstance arg dict all _is_supported_types arg values len type arg values = isinstance arg torch Tensor int float bool str True arg None True False run_with_nativert ep Downstream tests might mutate exported program subtle ways so we need make copy here ep_infer = copy deepcopy ep ep_infer = _use_real_inputs ep_infer run_decompositions MODEL_NAME = forward TODO Does named tempfile have collision tempfile NamedTemporaryFile suffix= pt delete=False f torch export pt _archive _package package_pt f exported_programs= MODEL_NAME ep_infer filename = f name try ep_args ep_kwargs = ep_infer example_inputs ep_args_copied ep_kwargs_copied = copy deepcopy ep_args copy deepcopy ep_kwargs torch manual_seed try flat_expected = pytree tree_leaves ep_infer module ep_args_copied ep_kwargs_copied except Exception e raise unittest case SkipTest str e e model_runner = PyModelRunner filename MODEL_NAME torch manual_seed _is_supported_types ep_args ep_kwargs results = model_runner run ep_args ep_kwargs results = model_runner run_with_flat_inputs_and_outputs pytree tree_leaves ep_args ep_kwargs flat_results = pytree tree_leaves results assert len flat_results == len flat_expected result expected zip flat_results flat_expected assert type result type expected isinstance result torch Tensor isinstance expected torch Tensor assert result shape == expected shape assert result dtype == expected dtype assert result device == expected device torch testing assert_close result expected equal_nan=True assert result == expected except RuntimeError e User need register pytree type cpp side which cannot tested python unittest Unknown pytree node type str e pass raise e finally pathlib Path filename unlink missing_ok=True ep mocked_nativert_export_strict args kwargs strict kwargs ep = export args kwargs ep = export args kwargs strict=True run_with_nativert ep ep mocked_nativert_export_nonstrict args kwargs strict kwargs ep = export args kwargs ep = export args kwargs strict=False run_with_nativert ep ep make_dynamic_cls cls strict=False cls_prefix = NativeRT strict test_class = testing make_test_cls_with_mocked_export cls cls_prefix test_export CPP_RUNTIME_STRICT_SUFFIX mocked_nativert_export_strict xfail_prop= _expected_failure_cpp_runtime test_only_if_no_xfail=True test_class = testing make_test_cls_with_mocked_export cls cls_prefix test_export CPP_RUNTIME_NONSTRICT_SUFFIX mocked_nativert_export_nonstrict xfail_prop= _expected_failure_cpp_runtime_non_strict test_only_if_no_xfail=True test_classes test_class __name__ = test_class REMOVING THIS LINE WILL STOP TESTS FROM RUNNING globals test_class __name__ = test_class test_class __module__ = __name__ unittest skipIf IS_WINDOWS Windows isn t supported case unittest skipIf torchdynamo is_dynamo_supported dynamo isn t support unittest skipIf is_fbcode FBcode only now TestNativeRT TestCase staticmethod get_module M torch nn Module __init__ - None super __init__ linear = torch nn Linear relu = torch nn ReLU forward x relu linear x M staticmethod get_module_multi_output MMultiOutput torch nn Module __init__ - None super __init__ linear = torch nn Linear relu = torch nn ReLU forward x relu linear x x MMultiOutput staticmethod get_model_pytree M torch nn Module __init__ - None super __init__ linear = torch nn Linear linear = torch nn Linear forward x x x x = x y = linear x y = linear x y = linear x y y y M parameters = device cpu cuda device == cuda HAS_CUDA_AND_TRITON continue module sample_inputs get_module __func__ device torch randn device get_module_multi_output __func__ device torch randn device get_model_pytree __func__ device torch randn device torch randn device torch randn device parameters append device module sample_inputs parameterized expand parameters test_aoti device m sample_inputs MODEL_NAME = model BACKEND_ID = aoti get original EP original_ep = torch export export m sample_inputs aoti_delegate_ep aoti_files = lower_exported_program original_ep MODEL_NAME BACKEND_ID package everything needed NativeRT execute AOTI delegate tempfile NamedTemporaryFile suffix= pt delete=False f package_nativert_with_aoti_delegate f MODEL_NAME BACKEND_ID original_ep aoti_delegate_ep aoti_files filename = f name try ep_args ep_kwargs = aoti_delegate_ep example_inputs ep_args_copied ep_kwargs_copied = copy deepcopy ep_args copy deepcopy ep_kwargs torch manual_seed try flat_expected = pytree tree_leaves aoti_delegate_ep module ep_args_copied ep_kwargs_copied except Exception e raise unittest case SkipTest str e e model_runner = PyModelRunner filename f MODEL_NAME - BACKEND_ID torch manual_seed _is_supported_types ep_args ep_kwargs results = model_runner run ep_args ep_kwargs results = model_runner run_with_flat_inputs_and_outputs pytree tree_leaves ep_args ep_kwargs flat_results = pytree tree_leaves results assert len flat_results == len flat_expected result expected zip flat_results flat_expected assert type result type expected isinstance result torch Tensor isinstance expected torch Tensor assert result shape == expected shape assert result dtype == expected dtype assert result device == expected device torch testing assert_close result expected equal_nan=True assert result == expected except RuntimeError e User need register pytree type cpp side which cannot tested python unittest Unknown pytree node type str e pass raise e finally pathlib Path filename unlink missing_ok=True is_fbcode test test_export TestExport make_dynamic_cls test strict=True make_dynamic_cls test strict=False del test __name__ == __main__ torch _dynamo test_case run_tests nativert has been supported XPU yet torch xpu is_available run_tests
mypy allow-untyped-decorators mypy allow-untyped-defs ast copy functools inspect textwrap collections abc Callable types FunctionType typing Any cast Optional Union torch torch _sources normalize_source_lines torch fx _symbolic_trace Tracer torch fx graph Graph AST_Rewriter ast NodeTransformer Take FunctionType object representing ` forward ` method then perform AST rewrite swap out nodes symbolically traceable callsite FX alternative To support swapping out AST node define new ` visit ` method node For more details see https docs python org library ast html#ast NodeTransformer This function checks new keys added globals dict TorchDynamo can insert new keys global dict upset check Therefore put disable here This function optimization pass really suitable dynamo tracing anyways torch _dynamo disable rewrite fn FunctionType Normalize source lines sourcelines _ = inspect getsourcelines fn sourcelines = normalize_source_lines sourcelines source = join sourcelines normalized_str = textwrap dedent source Rewrite original AST source_ast = ast parse normalized_str dest_ast = ast fix_missing_locations visit source_ast Pull out compiled function newly-created Module code = compile dest_ast exec globals_dict = copy copy fn __globals__ keys_before = set globals_dict keys exec code globals_dict new_keys = list set globals_dict keys - keys_before assert len new_keys == fn_compiled = globals_dict new_keys compiled function original globals change_func_globals f globals Based https stackoverflow com unutbu __globals__ private member function so we have copy function f all its member except f __globals__ g = FunctionType f __code__ globals name=f __name__ argdefs=f __defaults__ closure=f __closure__ g = functools update_wrapper g f g __kwdefaults__ = copy copy f __kwdefaults__ type ignore attr-defined g Return correct FunctionType object change_func_globals fn_compiled globals=fn __globals__ visit_Assert node Swap out Assert node Python s ` assert ` callsite symbolically-traceable torch _assert function Create Call node n = ast parse torch _assert mode= eval assert isinstance n ast Expression call_node = n body assert isinstance call_node ast Call msg = node msg node msg ast Constant value= kind=None call_node args = node test msg Ensure new node conforms Python AST grammar expr_wrapper = ast Expr value=call_node Return new Call node signify we want use replacement original _assert node ast copy_location expr_wrapper node visit_AnnAssign node Swap out Python s AnnAssign Assign node where annotation function called Example Original y Tensor_Type Dyn = f x Output y = annotate f x Tensor_Type Dyn ast Assign targets= node target value=ast Call func=ast Name id= annotate ctx=ast Load args= node value node annotation keywords= RewritingTracer Tracer trace root Union torch nn Module Callable concrete_args Optional dict str Any = None - Graph super trace _rewrite root concrete_args _rewrite fn Union torch nn Module Callable - Union torch nn Module Callable isinstance fn torch nn Module Rewrite module s ` forward ` well ` forward ` s all module s recursive descendents Return new rewritten module hierarchy rewrite_module m torch nn Module RewrittenModule torch nn Module __init__ orig super __init__ k v orig __dict__ items isinstance v torch nn Module __dict__ k = copy copy rewrite_module v __dict__ k = copy copy v RewrittenModule forward = AST_Rewriter rewrite cast FunctionType m forward RewrittenModule m rewrite_module fn Rewrite single free function AST_Rewriter rewrite cast FunctionType fn
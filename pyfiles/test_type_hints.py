mypy allow-untyped-defs Owner s module typing doctest inspect os tempfile unittest pathlib Path torch torch testing _internal common_utils run_tests set_cwd TestCase try mypy api HAVE_MYPY = True except ImportError HAVE_MYPY = False get_examples_from_docstring docstr Extracts all runnable python code examples docstrings returns list lines examples = doctest DocTestParser get_examples docstr f l e examples l e source splitlines get_all_examples get_all_examples - str This function grabs hopefully all examples torch documentation strings puts them one nonsensical module returned string blocklist = _np _InputT example_file_lines = mypy allow-untyped-defs math io itertools numpy torch torch nn functional F requires_grad_ example NB We parsing file Python so we must use Python type annotation syntax preprocess inp type torch Tensor - torch Tensor inp fname dir torch fn = getattr torch fname docstr = inspect getdoc fn docstr fname blocklist e = get_examples_from_docstring docstr e example_file_lines append f \n\ndef example_torch_ fname - None example_file_lines += e fname dir torch Tensor fn = getattr torch Tensor fname docstr = inspect getdoc fn docstr fname blocklist e = get_examples_from_docstring docstr e example_file_lines append f \n\ndef example_torch_tensor_ fname - None example_file_lines += e \n join example_file_lines TestTypeHints TestCase unittest skipIf HAVE_MYPY need mypy test_doc_examples Run documentation examples through mypy fn = Path __file__ resolve parent generated_type_hints_smoketest py fn write_text get_all_examples OK so here s deal mypy treats installed packages local modules differently package installed mypy will refuse use modules package type checking unless module explicitly says supports type checking Reference https mypy readthedocs io en latest running_mypy html#missing-imports Now PyTorch doesn t support typechecking we shouldn t claim supports typechecking doesn t However claiming we support typechecking bad test which wants use partial information we get bits PyTorch which typed check typechecks And although mypy will work directly you working source some our tests involve installing PyTorch then running its tests The guidance we got Michael Sullivan Joshua Oreman also independently developed Thomas Viehmann we should create fake directory add symlinks packages should typecheck So what we do here If you want run mypy hand you run PyTorch root directory should work fine skip step since mypy will preferentially pick up local files first The temporary directory here purely needed CI For reason we also still drop generated file test source folder ease inspection when there failures tempfile TemporaryDirectory tmp_dir try os symlink os path dirname torch __file__ os path join tmp_dir torch target_is_directory=True except OSError raise unittest SkipTest cannot symlink None repo_rootdir = Path __file__ resolve parent parent TODO Would better chdir here affects entire process set_cwd str repo_rootdir stdout stderr result = mypy api run -- cache-dir= mypy_cache doc -- no-strict-optional needed because torch lu_unpack see gh- str fn result = fail f mypy failed \n stderr \n stdout __name__ == __main__ run_tests
Owner s oncall jit os sys typing Any Dict List NamedTuple Optional Tuple noqa F torch torch jit _monkeytype_config _IS_MONKEYTYPE_INSTALLED torch testing _internal common_utils NoTest raise_on_run_directly torch testing _internal jit_utils JitTestCase make_global Make helper files test importable pytorch_test_dir = os path dirname os path dirname os path realpath __file__ sys path append pytorch_test_dir _IS_MONKEYTYPE_INSTALLED print monkeytype installed Skipping tests Profile-Directed Typing file=sys stderr JitTestCase = NoTest type ignore misc assignment noqa F TestPDT JitTestCase A suite tests profile directed typing TorchScript test_nn_module TestPDTModel torch nn Module forward x - Any isinstance x int x + isinstance x float x - x make_global TestPDTModel pdt_model = TestPDTModel inp List Tuple Any = False scripted_pdt_model = torch jit script pdt_model example_inputs= pdt_model inp assertEqual scripted_pdt_model pdt_model assertEqual scripted_pdt_model pdt_model assertTrue scripted_pdt_model True pdt_model True test_nested_nn_module_class NestedPDTInner torch nn Module forward x isinstance x int x x NestedModulePDTWrapper torch nn Module __init__ inner super __init__ inner = inner forward x inner x make_global NestedPDTInner NestedModulePDTWrapper inner_pdt_model = NestedPDTInner wrapped_pdt_model = NestedModulePDTWrapper inner_pdt_model inp List Tuple Any = False scripted_pdt_model = torch jit script wrapped_pdt_model example_inputs= wrapped_pdt_model inp assertEqual scripted_pdt_model wrapped_pdt_model assertEqual scripted_pdt_model wrapped_pdt_model assertTrue scripted_pdt_model True wrapped_pdt_model True test_nested_nn_module_class_with_args NestedModulePDTInner torch nn Module forward x y isinstance x int x + y x NestedModulePDTOuter torch nn Module __init__ inner super __init__ inner = inner forward x inner x make_global NestedModulePDTInner NestedModulePDTOuter inner_pdt_model = NestedModulePDTInner outer_pdt_model = NestedModulePDTOuter inner_pdt_model inner_input List Tuple Any = outer_input List Tuple Any = False scripted_pdt_model = torch jit script outer_pdt_model example_inputs= inner_pdt_model inner_input outer_pdt_model outer_input assertEqual scripted_pdt_model outer_pdt_model assertEqual scripted_pdt_model outer_pdt_model assertTrue scripted_pdt_model True outer_pdt_model True test_nested_function_in_forward NestedFunctionInForward torch nn Module forward x fun x + fun x isinstance x bool isinstance x int x + make_global NestedFunctionInForward pdt_model = NestedFunctionInForward inp List Tuple Any = - False scripted_pdt_model = torch jit script pdt_model example_inputs= pdt_model inp assertEqual scripted_pdt_model pdt_model assertEqual scripted_pdt_model True pdt_model True test_nn_module_with_export_function TestModelWithExport torch nn Module torch jit export fn x y - Any assert isinstance x bool isinstance y bool isinstance x int isinstance y int x + y isinstance x float isinstance y float x - y - make_global TestModelWithExport pdt_model = TestModelWithExport inp List Tuple Any = scripted_pdt_model = torch jit script pdt_model example_inputs= pdt_model fn inp assertEqual scripted_pdt_model fn pdt_model fn assertEqual scripted_pdt_model fn pdt_model fn assertTrue scripted_pdt_model fn torch ones pdt_model fn torch ones test_class_methods PDTModel test_sum sum make_global PDTModel pdt_model = PDTModel inp List Tuple Any = scripted_pdt_model = torch jit script PDTModel example_inputs= pdt_model test_sum inp script_model = scripted_pdt_model assertEqual script_model test_sum pdt_model test_sum test_class_with_multiple_methods PDTModelWithManyMethods test_list_to_dict new_dictionary Dict float bool = element new_dictionary element = True new_dictionary test_substring b b make_global PDTModelWithManyMethods pdt_model = PDTModelWithManyMethods list_inp List Tuple Any = str_inp List Tuple Any = abc b scripted_pdt_model = torch jit script PDTModelWithManyMethods example_inputs= pdt_model test_list_to_dict list_inp pdt_model test_substring str_inp script_model = scripted_pdt_model assertEqual script_model test_list_to_dict pdt_model test_list_to_dict assertEqual script_model test_substring helloworld world pdt_model test_substring helloworld world assertEqual script_model test_substring helloworld pdt_model test_substring helloworld test_multiple_class_with_same_method PDTModelOne test_find b b keys PDTModelTwo test_find b b make_global PDTModelOne PDTModelTwo pdt_model_one = PDTModelOne pdt_model_two = PDTModelTwo dict_inp List Tuple Any = True False list_inp List Tuple Any = abc b c scripted_pdt_model_one = torch jit script PDTModelOne example_inputs= pdt_model_one test_find dict_inp scripted_pdt_model_two = torch jit script PDTModelTwo example_inputs= pdt_model_two test_find list_inp script_model_one script_model_two = scripted_pdt_model_one scripted_pdt_model_two assertEqual script_model_one test_find True True False pdt_model_one test_find True True False assertEqual script_model_two test_find hello world world pdt_model_two test_find hello world world test_pdt test_sum b + b make_global test_sum scripted_fn_add = torch jit script test_sum example_inputs= assertEqual scripted_fn_add test_sum test_sub b - b make_global test_sub scripted_fn_sub = torch jit script test_sub example_inputs= assertEqual scripted_fn_sub test_sub test_mul b b make_global test_mul scripted_fn_mul = torch jit script test_mul example_inputs= - assertEqual scripted_fn_mul - test_mul - test_args_complex real img torch complex real img make_global test_args_complex scripted_fn_complex = torch jit script test_args_complex example_inputs= torch rand torch rand arg arg = torch rand torch rand assertEqual scripted_fn_complex arg arg test_args_complex arg arg test_bool - make_global test_bool scripted_fn_bool = torch jit script test_bool example_inputs= True assertEqual scripted_fn_bool True test_bool True test_str == False True make_global test_str scripted_fn_str = torch jit script test_str example_inputs= assertEqual scripted_fn_str abc test_str abc test_pdt_list_and_tuple test_list_and_tuple sum make_global test_list_and_tuple scripted_fn_float_list_input = torch jit script test_list_and_tuple example_inputs= assertEqual scripted_fn_float_list_input test_list_and_tuple scripted_fn_bool_list_input = torch jit script test_list_and_tuple example_inputs= True False True assertEqual scripted_fn_bool_list_input True True True test_list_and_tuple True True True scripted_fn_int_list_input = torch jit script test_list_and_tuple example_inputs= assertEqual scripted_fn_int_list_input test_list_and_tuple scripted_fn_float_tuple_input = torch jit script test_list_and_tuple example_inputs= assertEqual scripted_fn_float_tuple_input test_list_and_tuple scripted_fn_bool_tuple_input = torch jit script test_list_and_tuple example_inputs= True False True assertEqual scripted_fn_bool_tuple_input True True True test_list_and_tuple True True True scripted_fn_int_tuple_input = torch jit script test_list_and_tuple example_inputs= assertEqual scripted_fn_int_tuple_input test_list_and_tuple test_nested_list_and_tuple test_nested_list inp sum v v inp test_nested_tuple inp ans = tup inp val tup val ans = val ans make_global test_nested_list test_nested_tuple list_inp = scripted_fn = torch jit script test_nested_list example_inputs= list_inp inp = - - assertEqual scripted_fn inp test_nested_list inp list_inp = scripted_fn = torch jit script test_nested_list example_inputs= list_inp inp = - - assertEqual scripted_fn inp test_nested_list inp tup_inp = scripted_fn = torch jit script test_nested_tuple example_inputs= tup_inp inp = - - - assertEqual scripted_fn inp test_nested_tuple inp tup_inp = True False True False False False scripted_fn = torch jit script test_nested_tuple example_inputs= tup_inp inp = True True True False False True assertEqual scripted_fn inp test_nested_tuple inp test_pdt_dict test_dict foo test_dict_int_list make_global test_dict test_dict_int_list str_bool_inp = foo True bar False scripted_fn = torch jit script test_dict example_inputs= str_bool_inp assertEqual scripted_fn foo False bar True test_dict foo False bar True str_list_inp = True False False True scripted_fn = torch jit script test_dict_int_list example_inputs= str_list_inp assertEqual scripted_fn False False True True test_dict_int_list False False True True test_any test_multiple_types assert isinstance bool test_multiple_type_refinement isinstance bool isinstance int + isinstance float + int - make_global test_multiple_types test_multiple_type_refinement scripted_fn = torch jit script test_multiple_types example_inputs= abc assertEqual scripted_fn test_multiple_types assertEqual scripted_fn test_multiple_types assertEqual scripted_fn test_multiple_types assertEqual scripted_fn test_multiple_types scripted_fn = torch jit script test_multiple_type_refinement example_inputs= abc True True assertEqual scripted_fn test_multiple_type_refinement assertEqual scripted_fn test_multiple_type_refinement assertEqual scripted_fn test_multiple_type_refinement assertEqual scripted_fn test_multiple_type_refinement assertEqual scripted_fn False test_multiple_type_refinement False assertEqual scripted_fn abc True False test_multiple_type_refinement abc True False test_class_as_profiled_types UserDefinedClass fn b - Any assert b None isinstance b int b b - isinstance b float b b - test_model m assert isinstance bool m fn make_global UserDefinedClass test_model user_class = UserDefinedClass scripted_fn = torch jit script test_model example_inputs= user_class user_class assertEqual scripted_fn user_class test_model user_class assertEqual scripted_fn user_class test_model user_class test_class_with_args_as_profiled_types ClassWithArgs __init__ bool = fn b b - test_model_with_args m assert isinstance bool m fn make_global ClassWithArgs test_model_with_args user_class = ClassWithArgs False scripted_fn = torch jit script test_model_with_args example_inputs= user_class user_class assertEqual scripted_fn ClassWithArgs True test_model_with_args ClassWithArgs True test_nn_parameter_as_arg TestNNParameter torch nn Module __init__ - None super __init__ inp = torch nn Parameter torch ones add_nn_parameter_with_int x y torch add x y forward y add_nn_parameter_with_int inp y make_global TestNNParameter pdt_model = TestNNParameter scripted_fn = torch jit script pdt_model example_inputs= pdt_model assertEqual scripted_fn pdt_model test_fx_tracing_with_typing FXModelOutput NamedTuple result List int FXModel torch nn Module forward - FXModelOutput result = FXModelOutput result=a result make_global FXModel FXModelOutput pdt_model = FXModel scripted_fn = torch jit script pdt_model example_inputs= pdt_model assertEqual scripted_fn pdt_model test_nonetype_as_optional_of_type test_none - Any None + torch ones make_global test_none scripted_fn = torch jit script test_none example_inputs= None assertEqual scripted_fn test_none scripted_fn = torch jit script test_none example_inputs= None assertEqual scripted_fn test_none scripted_fn = torch jit script test_none example_inputs= None torch Tensor assertEqual scripted_fn torch ones test_none torch ones __name__ == __main__ raise_on_run_directly test test_jit py
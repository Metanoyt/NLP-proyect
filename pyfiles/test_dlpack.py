Owner s module dynamo functools sys unittest unittest skipIf skipif numpy pytest torch torch testing _internal common_utils instantiate_parametrized_tests parametrize run_tests skipIfTorchDynamo TEST_WITH_TORCHDYNAMO TestCase xpassIfTorchDynamo_np TEST_WITH_TORCHDYNAMO numpy np numpy testing assert_array_equal torch _numpy np torch _numpy testing assert_array_equal skip = functools partial skipif True IS_PYPY = False skipif numpy __version__ reason= numpy dlpack new numpy instantiate_parametrized_tests TestDLPack TestCase xpassIfTorchDynamo_np reason= pytorch seems handle refcounts differently skipif IS_PYPY reason= PyPy can t get refcounts test_dunder_dlpack_refcount x = np arange y = x __dlpack__ assert sys getrefcount x == del y assert sys getrefcount x == unittest expectedFailure skipIfTorchDynamo I can t figure out how get __dlpack__ into trace_rules py test_dunder_dlpack_stream x = np arange x __dlpack__ stream=None pytest raises RuntimeError x __dlpack__ stream= xpassIfTorchDynamo_np reason= pytorch seems handle refcounts differently skipif IS_PYPY reason= PyPy can t get refcounts test_from_dlpack_refcount x = np arange y = np from_dlpack x assert sys getrefcount x == del y assert sys getrefcount x == parametrize dtype np int np int np int np int np uint np float np float np float np complex np complex test_dtype_passthrough dtype x = np arange dtype=dtype y = np from_dlpack x assert y dtype == x dtype assert_array_equal x y test_non_contiguous x = np arange reshape y = x assert_array_equal y np from_dlpack y y = x assert_array_equal y np from_dlpack y y = x assert_array_equal y np from_dlpack y y = x assert_array_equal y np from_dlpack y y = np diagonal x copy assert_array_equal y np from_dlpack y parametrize ndim range test_higher_dims ndim shape = ndim x = np zeros shape dtype=np float assert shape == np from_dlpack x shape test_dlpack_device x = np arange assert x __dlpack_device__ == y = np from_dlpack x assert y __dlpack_device__ == z = y assert z __dlpack_device__ == dlpack_deleter_exception x = np arange _ = x __dlpack__ raise RuntimeError test_dlpack_destructor_exception pytest raises RuntimeError dlpack_deleter_exception skip reason= no readonly arrays pytorch test_readonly x = np arange x flags writeable = False pytest raises BufferError x __dlpack__ test_ndim x = np array y = np from_dlpack x assert_array_equal x y test_from_torch t = torch arange = np from_dlpack t assert_array_equal np asarray t test_to_torch = np arange t = torch from_dlpack assert_array_equal np asarray t __name__ == __main__ run_tests
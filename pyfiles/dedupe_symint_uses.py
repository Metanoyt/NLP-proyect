mypy allow-untyped-defs dataclasses dataclass typing Any torch torch SymBool SymFloat SymInt torch types py_sym_types torch utils _ordered_set OrderedSet dataclass _SymExprHash Hash py_sym_types will use underlying sympy expression sym_obj SymInt &#124; SymFloat &#124; SymBool __hash__ - int hash type sym_obj sym_obj node expr __eq__ value - bool isinstance value _SymExprHash False sym_obj node expr == value sym_obj node expr _SymHashingDict Wrapper around dictionary will convert sym types hash _SymExprHash reuse existing sym proxies SymPy hash always reliable so optimistically hash sympy expression those fail fallback symnodes __init__ sym_hash_dict = __setitem__ key value sym_hash_dict __setitem__ _wrap_to_sym_expr_hash key value __getitem__ key sym_hash_dict _wrap_to_sym_expr_hash key __contains__ key _wrap_to_sym_expr_hash key sym_hash_dict get key default=None sym_hash_dict get _wrap_to_sym_expr_hash key default _wrap_to_sym_expr_hash key _SymExprHash key isinstance key py_sym_types key dedupe_symints graph torch fx Graph Dedupes sym ints graph nodes resolvable symint graph inputs We only dedupe graph inputs avoid adding potential dependency forward backward sym_dict = _SymHashingDict resolvable_from_input_symints = OrderedSet Any node graph nodes val = node meta get val None val None isinstance val py_sym_types continue node op == placeholder resolvable_from_input_symints add node sym_dict val = node existing_node = sym_dict get val node replace_all_uses_with existing_node graph erase_node node all n resolvable_from_input_symints n node all_input_nodes sym_dict val = node resolvable_from_input_symints add node
mypy allow-untyped-defs torch functorch experimental control_flow cond CondBranchNonlocalVariables torch nn Module The branch functions ` true_fn ` ` false_fn ` passed cond must follow these rules - both branches must take same args which must also match branch args passed cond - both branches must single tensor - returned tensor must have same tensor metadata e g shape dtype - branch function can free function nested function lambda methods - branch function can have closure variables - no inplace mutations inputs global variables This example demonstrates how rewrite code avoid capturing closure variables branch functions The code below will work because capturing closure variables supported ` ` ` my_tensor_var = x + my_primitive_var = true_fn y nonlocal my_tensor_var my_primitive_var y + my_tensor_var + my_primitive_var false_fn y nonlocal my_tensor_var my_primitive_var y - my_tensor_var - my_primitive_var cond x shape true_fn false_fn x ` ` ` NOTE If ` pred ` test dim batch size will specialized forward x my_tensor_var = x + my_primitive_var = true_fn x y z x + y + z false_fn x y z x - y - z cond x shape true_fn false_fn x my_tensor_var torch tensor my_primitive_var example_args = torch randn tags = torch cond torch dynamic-shape model = CondBranchNonlocalVariables
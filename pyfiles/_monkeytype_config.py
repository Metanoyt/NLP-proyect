mypy allow-untyped-defs inspect sys typing collections defaultdict collections abc Iterable pathlib Path types CodeType typing Optional torch _IS_MONKEYTYPE_INSTALLED = True try monkeytype type ignore pyrefly ignore import-error monkeytype trace monkeytype_trace monkeytype config _startswith LIB_PATHS type ignore monkeytype db base type ignore CallTraceStore CallTraceStoreLogger CallTraceThunk monkeytype tracing CallTrace CodeFilter type ignore except ImportError _IS_MONKEYTYPE_INSTALLED = False Checks whether defined ` torch ` modules is_torch_native_class cls hasattr cls __module__ False parent_modules = cls __module__ split parent_modules False root_module = sys modules get parent_modules root_module torch get_type type Convert given type torchScript acceptable format isinstance type str type inspect getmodule type == typing If type type imported typing like Tuple List Dict then replace ` typing ` null string This needs done since typing List accepted TorchScript type_to_string = str type type_to_string replace type __module__ + is_torch_native_class type If type subtype torch module then TorchScript expects fully qualified name type which obtained combining module name type name type __module__ + + type __name__ For all other types use name type type __name__ get_optional_of_element_type types Extract element type ` Optional element type ` consolidated types Helper function extracts type element annotated Optional list consolidated types returns ` Optional element type ` TODO To remove check once Union support lands elem_type = types type None types types elem_type = get_type elem_type Optional type internally converted Union type NoneType which supported yet TorchScript Hence representing optional type string Optional + elem_type + get_qualified_name func func __qualname__ _IS_MONKEYTYPE_INSTALLED JitTypeTraceStoreLogger CallTraceStoreLogger A JitTypeCallTraceLogger stores logged traces CallTraceStore __init__ store CallTraceStore super __init__ store log trace CallTrace - None pyrefly ignore missing-attribute traces append trace JitTypeTraceStore CallTraceStore __init__ - None super __init__ A dictionary keeping all collected CallTrace key fully qualified name called function value list all CallTrace trace_records dict str list = defaultdict list add traces Iterable CallTrace t traces qualified_name = get_qualified_name t func trace_records qualified_name append t filter qualified_name str qualname_prefix Optional str = None limit int = - list CallTraceThunk trace_records qualified_name analyze qualified_name str - dict Analyze types given module create dictionary all types arguments records = trace_records qualified_name all_args = defaultdict set record records arg arg_type record arg_types items all_args arg add arg_type all_args consolidate_types qualified_name str - dict all_args = analyze qualified_name If there more types argument then consolidate type ` Any ` replace entry type ` Any ` arg types all_args items types = list types type_length = len types type_length == type None types TODO To remove check once Union support TorchScript lands all_args arg = get_optional_of_element_type types type_length all_args arg = Any type_length == all_args arg = get_type types all_args get_args_types qualified_name str - dict consolidate_types qualified_name JitTypeTraceConfig monkeytype config Config __init__ s JitTypeTraceStore super __init__ s = s trace_logger - JitTypeTraceStoreLogger Return JitCallTraceStoreLogger logs configured trace store pyrefly ignore bad-argument-count JitTypeTraceStoreLogger trace_store trace_store - CallTraceStore s code_filter - Optional CodeFilter jit_code_filter When MonkeyType installed we provide dummy definitions below classes JitTypeTraceStoreLogger type ignore no-redef __init__ - None pass JitTypeTraceStore type ignore no-redef __init__ - None trace_records = None JitTypeTraceConfig type ignore no-redef __init__ - None pass monkeytype_trace = None type ignore assignment noqa F jit_code_filter code CodeType - bool Codefilter Torchscript trace forward calls The custom CodeFilter required while scripting FX Traced forward calls FX Traced forward calls have ` code co_filename ` start which used exclude tracing stdlib site-packages default code filter Since we need all forward calls traced custom code filter checks code co_name forward enables tracing all such calls The code filter similar default code filter monkeytype excludes tracing stdlib site-packages Filter code without source file exclude check forward calls code co_name = forward code co_filename code co_filename == False filename = Path code co_filename resolve any _startswith filename lib_path lib_path LIB_PATHS
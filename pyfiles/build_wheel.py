usr bin env python argparse contextlib logging os re subprocess sys tempfile time collections abc Iterator pathlib Path logging basicConfig level=logging INFO format= asctime s - levelname s - message s logger = logging getLogger __name__ logger setLevel logging INFO ROOT_PATH = Path __file__ absolute parent parent parent REQUIREMENTS_PATH = ROOT_PATH requirements txt PYPROJECT_TOML_PATH = ROOT_PATH pyproject toml run_cmd cmd list str capture_output bool = False - subprocess CompletedProcess bytes logger debug Running command s join cmd subprocess run cmd Give parent environment subprocess env= os environ capture_output=capture_output check=True interpreter_version interpreter str - str version_string = run_cmd interpreter -- version capture_output=True stdout decode utf- strip str version_string split get_supported_python_versions - list str Extract supported Python versions pyproject toml classifiers open PYPROJECT_TOML_PATH f content = f read Find Python version classifiers pattern = r Programming Language Python \d+\ \d+ matches = re findall pattern content Sort versions them sorted matches key=lambda x tuple map int x split find_python_interpreters mode str - list str Find Python interpreters based specified mode mode == manylinux _find_manylinux_interpreters raise ValueError f Unsupported mode mode _find_manylinux_interpreters - list str Find Python interpreters manylinux format opt python supported_versions = get_supported_python_versions interpreters = python_root = Path opt python python_root exists logger warning Path opt python does exist no interpreters found Find all python binaries opt python python_binaries = list python_root glob bin python python_path python_binaries try Check s PyPy skip version_output = run_cmd str python_path -- version capture_output=True version_string = version_output stdout decode utf- strip PyPy version_string logger debug Skipping PyPy interpreter s python_path continue Extract Python version e g Python - match = re search r Python \d+\ \d+ version_string match logger debug Could parse version s version_string continue python_version = match group Check version supported python_version supported_versions interpreters append str python_path logger debug Found supported Python s s python_version python_path logger debug Python s supported versions s python_version supported_versions except subprocess CalledProcessError e logger debug Failed get version s s python_path e noqa G continue interpreters contextlib contextmanager venv interpreter str - Iterator str Should use EnvBuilder Probably maybe good todo future python_version = interpreter_version interpreter tempfile TemporaryDirectory suffix=f _pytorch_builder_ python_version tmp_dir logger info Creating virtual environment Python s s python_version tmp_dir run_cmd interpreter -m venv tmp_dir yield str Path tmp_dir bin python Builder The python interpreter we should using interpreter str __init__ interpreter str - None interpreter = interpreter build_wheel destination str - bool logger info Running bdist_wheel -d s destination run_cmd interpreter -m build -- wheel -- no-isolation -- outdir destination str ROOT_PATH returncode == clean - bool logger info Running clean run_cmd interpreter setup py clean returncode == install_requirements - None logger info Installing requirements run_cmd interpreter -m pip install -r str REQUIREMENTS_PATH parse_args - argparse Namespace parser = argparse ArgumentParser parser add_argument -p -- python action= append type=str help= Python interpreters build packages can set multiple times should ideally full paths default default s parser add_argument -- find-python type=str choices= manylinux help= Automatically find Python interpreters based specified mode Available modes manylinux searches opt python interpreters matching supported versions pyproject toml parser add_argument -d -- destination default= dist type=str help= Destination put compiled binaries parser parse_args main - None args = parse_args args find_python args python logger warning Both -- python -- find-python specified Using -- find-python ignoring -- python pythons = find_python_interpreters args find_python pythons logger error No Python interpreters found -- find-python s args find_python sys exit logger info Found d supported Python interpreters s len pythons join pythons pythons = args python sys executable build_times dict str float = dict len pythons args destination == dist logger warning dest dist while multiple python versions specified output will overwritten interpreter pythons venv interpreter venv_interpreter builder = Builder venv_interpreter clean actually requires setuptools so we need ensure we install requirements before builder install_requirements builder clean start_time = time time builder build_wheel args destination end_time = time time build_times interpreter_version venv_interpreter = end_time - start_time version build_time build_times items logger info Build time s fs version build_time __name__ == __main__ main
itertools collections abc Generator Iterable Iterator Sequence contextlib contextmanager os linesep typing Any Optional sympy torch torch _inductor virtualized virtualized torch _inductor ir ComputedBuffer Pointwise torch _inductor ops_handler DefaultHandler WrapperHandler torch _inductor scheduler BaseSchedulerNode torch _inductor utils DelayReplaceLine IndentedBuffer OrderedSet torch _inductor virtualized OpsValue virtualized V _ACCUMULATOR_ARG_NAME = accum scaled_mm_evt scale_A_name str scale_B_name str bias_name Optional str output_name str - tuple list str dict str Any str evt_read_names = scale_A_name scale_B_name var_name_to_buffer_name = n n n scale_A_name scale_B_name var_name_to_buffer_name D = output_name var_name_to_buffer_name _ACCUMULATOR_ARG_NAME = output_name expr = f accum scale_A_name scale_B_name linesep bias_name expr = f expr + bias_name evt_read_names append bias_name var_name_to_buffer_name bias_name = bias_name evt_py_code = f fn accum join evt_read_names linesep \ D = expr linesep \ D linesep evt_read_names var_name_to_buffer_name evt_py_code CutlassEVTOpsMixIn staticmethod _infix_bin_op op str str b str - str f op b staticmethod _prefix_bin_op op str str b str - str f op b staticmethod _prefix_un_op op str str - str f op staticmethod to_dtype x str dtype Any src_dtype Optional torch dtype = None use_compute_types bool = False - str x staticmethod constant value Any dtype Any - str raise NotImplementedError staticmethod mul x str x str - str CutlassEVTOpsMixIn _infix_bin_op x x staticmethod truediv x str x str - str CutlassEVTOpsMixIn _infix_bin_op x x staticmethod ge x str x str - str raise NotImplementedError staticmethod add x str x str - str CutlassEVTOpsMixIn _infix_bin_op + x x staticmethod relu x str - str CutlassEVTOpsMixIn _prefix_un_op relu x staticmethod sigmoid x str - str CutlassEVTOpsMixIn _prefix_un_op sigmoid x staticmethod sub x str x str - str CutlassEVTOpsMixIn _infix_bin_op - x x staticmethod tanh x str - str CutlassEVTOpsMixIn _prefix_un_op tanh x staticmethod exp x str - str CutlassEVTOpsMixIn _prefix_un_op exp x MockCutlassHandler CutlassEVTOpsMixIn WrapperHandler Passthrough handler cutlass ops used running epilogue nodes memory planning _AssignmentFormatter DefaultHandler __init__ parent_handler CutlassEVTCodegen parent_handler = parent_handler _default name str args tuple Any kwargs dict str Any - Any Handle op dispatch here hasattr parent_handler name fn = getattr parent_handler name line = fn args kwargs name load store OpsValue line var = parent_handler _tmp_var line = DelayReplaceLine var lambda D var == parent_handler last_stored_var_name var f var = line parent_handler body writeline line OpsValue var raise NotImplementedError name CutlassEVTCodegen CutlassEVTOpsMixIn Notes Used CUTLASSGemmTemplate This should instantiated users intended used calling CutlassEVTCodegen ir_to_evt_python_code which instantiates ops handler virtualized V ops op-name Extend more _op_ whatever nodes add support new pointwise operations __init__ accumulator_node_name str removed_buffers OrderedSet str Initializes CutlassEVTEpilogueArgumentFormatter object Do instantiate directly Use CutlassEVTCodegen ir_to_evt_python_code static method Args accumulator_node_name The name accumulator node which should contain Matmul result before fusion according IR graph epilogue_nodes The list scheduler nodes fused into epilogue accumulator_node_name str = accumulator_node_name body IndentedBuffer = IndentedBuffer The body buffer codegen var_counter Iterator int = itertools count store_name_to_value dict str OpsValue = dict Aliases subexpression functors reads OrderedSet str = OrderedSet Used creating example tensors var_name_to_buffer_name dict str str = _ACCUMULATOR_ARG_NAME accumulator_node_name removed_buffers OrderedSet str = removed_buffers cur_node Optional ComputedBuffer = None name_to_buffer = V graph name_to_buffer &#124; V graph graph_inputs name V graph constants keys name_to_buffer name = V graph add_tensor_constant V graph constants name name is_D_assigned = False D_var_name = None accumulator_node_name removed_buffers cannot accumulator directly so alias var = _tmp_var body writeline f var = _ACCUMULATOR_ARG_NAME store accumulator_node_name value=OpsValue var staticmethod ir_to_evt_python_code cuda_template_node_name str epilogue_nodes list BaseSchedulerNode removed_buffers OrderedSet str - tuple list str list str dict str Any str codegen = CutlassEVTCodegen cuda_template_node_name removed_buffers handler = _AssignmentFormatter codegen virtualized V set_ops_handler handler s_node epilogue_nodes node = s_node node assert isinstance node ComputedBuffer codegen set_cur_node node index_vars = CutlassEVTCodegen get_index_vars node node get_store_function index_vars codegen finalize codegen get_reads codegen get_writes codegen get_renames codegen get_value get_value - str linesep join _render_input_signature body getvalue _render_return_statement finalize - None Rename last store D no other code references store workaround https github com NVIDIA cutlass issues Note delayed line will automatically rewrite last assignment D buffer_name = var_name_to_buffer_name last_stored_var_name var_name_to_buffer_name pop last_stored_var_name var_name_to_buffer_name D = buffer_name store_name_to_value buffer_name = OpsValue D contextmanager set_cur_node node ComputedBuffer - Generator None Any Any prev_node = cur_node try cur_node = node yield finally cur_node = prev_node get_renames - dict str str dict var_name_to_buffer_name get_reads - list str list reads difference store_name_to_value keys get_writes - list str list store_name_to_value keys load name str index Any - str _check_indexing name index name store_name_to_value store_name_to_value name value name == accumulator_node_name _ACCUMULATOR_ARG_NAME reads add name var_name_to_buffer_name name = name name store name Any index Any = None value Any = None mode Any = None - None name removed_buffers index _check_indexing name index assert value value = _ACCUMULATOR_ARG_NAME Cannot store accumulator arg name var_name_to_buffer_name value value = name store_name_to_value name = value last_stored_var_name = value value None _get_cur_node - ComputedBuffer assert cur_node cur_node staticmethod get_index_vars node ComputedBuffer - Sequence sympy Expr data = node data TODO mlazos relax cutlass supports reductions other ops assert isinstance data Pointwise data _index data ranges _get_current_index_vars - Sequence sympy Expr get_index_vars _get_cur_node _check_indexing name str index sympy Expr - None We only support indexing matches layout today because CUTLASS doesn t support arbitrary indexing buffer_name = accumulator_node_name name == _ACCUMULATOR_ARG_NAME name buffer = name_to_buffer buffer_name index_strides = V graph sizevars stride_vars index _get_current_index_vars stride = buffer get_layout stride _stride_compatible stride index_strides raise NotImplementedError f Unsupported indexing name index index index strides index_strides layout stride stride _stride_compatible left Iterable sympy Expr right Iterable sympy Expr - bool all sympy Eq l r sympy Eq l sympy Eq r l r zip left right _render_input_signature - str arguments = join _ACCUMULATOR_ARG_NAME + name name reads name = accumulator_node_name f fn arguments _render_return_statement - str return_vars = OrderedSet op_v value op_v store_name_to_value values assert D return_vars f join return_vars _tmp_var - str f tmp_ next var_counter
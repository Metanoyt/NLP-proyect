Copyright c Meta Platforms Inc affiliates copy typing TYPE_CHECKING torch distributed dist torch distributed _shard sharded_tensor Shard ShardedTensor ShardMetadata torch distributed checkpoint metadata STATE_DICT_TYPE torch distributed remote_device _remote_device _traverse OBJ_PATH set_element STATE_DICT_ITEM traverse_state_dict utils _element_wise_add _normalize_device_info TYPE_CHECKING torch distributed _shard sharded_tensor metadata ShardedTensorMetadata TODO We need refactor code _flatten_sharded_tensors state_dict STATE_DICT_TYPE - STATE_DICT_TYPE r Transform ` ` state_dict ` ` flattening all nested ShardedTensor instances found The resulting ShardedTensor instances only correct regarding local shard MUST used any other purpose checkpointing no operator will work them This function should used conjunction state_dict produced FSDP s StateDictType SHARDED_STATE_DICT methods new_state_dict STATE_DICT_TYPE = rewrite_dict path OBJ_PATH value STATE_DICT_ITEM - None isinstance value ShardedTensor set_element new_state_dict path value shards = value local_shards len shards == len shards = set_element new_state_dict path value outer_shard = shards inner_st = outer_shard tensor isinstance inner_st ShardedTensor set_element new_state_dict path value len inner_st local_shards = raise ValueError Cannot handle inner tensor more than shard inner_shard = inner_st local_shards local_shards = Shard tensor=inner_shard tensor metadata=ShardMetadata shard_offsets=_element_wise_add outer_shard metadata shard_offsets inner_shard metadata shard_offsets shard_sizes=inner_shard metadata shard_sizes placement=f rank dist get_rank inner_shard tensor device st_meta ShardedTensorMetadata = copy deepcopy value metadata other_rank = dist get_rank device_info = _normalize_device_info inner_shard tensor device type Remove outer ST shard inner ST covers i shard_md enumerate st_meta shards_metadata shard_md shard_offsets == outer_shard metadata shard_offsets st_meta shards_metadata pop i break Attribute other rank other shards shard_md st_meta shards_metadata shard_md placement = _remote_device f rank other_rank device_info Add other inner shards inner tensor inner_md inner_st metadata shards_metadata inner_md shard_offsets = inner_shard metadata shard_offsets st_meta shards_metadata append ShardMetadata shard_offsets=_element_wise_add outer_shard metadata shard_offsets inner_md shard_offsets shard_sizes=inner_md shard_sizes placement=f rank other_rank device_info Finally add shard st_meta shards_metadata append local_shards metadata st = ShardedTensor _init_from_local_shards_and_global_metadata local_shards=local_shards sharded_tensor_metadata=st_meta set_element new_state_dict path st traverse_state_dict state_dict rewrite_dict new_state_dict
mypy allow-untyped-defs argparse time numpy np type ignore pandas pd type ignore dlrm_s_pytorch unpack_batch type ignore dlrm_utils type ignore dlrm_wrap fetch_model make_test_data_loader torch run_forward model batch The purpose function time forward run model The model forward happens times each pass timed The average runs returned avg_time time_list = X lS_o lS_i = batch X batch lS_o batch lS_i _ range start = time time torch no_grad model X lS_o lS_i end = time time time_taken = end - start pyrefly ignore bad-argument-type time_list append time_taken avg_time = np mean time_list avg_time make_sample_test_batch raw_data_path processed_data_path device Create test_data_loader sample batch This batch will used measure forward pass model throughout experiment test_data_loader = make_test_data_loader raw_data_path processed_data_path test_iter = iter test_data_loader test_batch = next test_iter X_test lS_o_test lS_i_test _ _ _ = unpack_batch test_batch X lS_o lS_i = dlrm_wrap X_test lS_o_test lS_i_test device batch = X X lS_o lS_o lS_i lS_i batch measure_forward_pass sparse_model_metadata device sparse_dlrm batch Measures tracks forward pass model all sparsity levels block shapes norms available sparse_model_metadata file If sparse_dlrm=True then SparseDLRM model loaded otherwise standard one time_taken_dict dict str list = norm sparse_block_shape sparsity_level time_taken metadata = pd read_csv sparse_model_metadata _ row metadata iterrows norm sbs sl = row norm row sparse_block_shape row sparsity_level model_path = row path model = fetch_model model_path device sparse_dlrm=sparse_dlrm time_taken = run_forward model batch out_str = f norm _ sbs _ sl = time_taken print out_str time_taken_dict norm append norm time_taken_dict sparse_block_shape append sbs time_taken_dict sparsity_level append sl time_taken_dict time_taken append time_taken time_df = pd DataFrame time_taken_dict sparse_dlrm time_df dlrm_type = with_torch_sparse time_df dlrm_type = without_torch_sparse time_df __name__ == __main__ parser = argparse ArgumentParser parser add_argument -- raw-data-file -- raw_data_file type=str parser add_argument -- processed-data-file -- processed_data_file type=str parser add_argument -- sparse-model-metadata -- sparse_model_metadata type=str args = parser parse_args device = torch device cuda torch cuda is_available torch device cpu print device batch = make_sample_test_batch args raw_data_file args processed_data_file device print Forward Time Sparse DLRM sparse_dlrm_time_df = measure_forward_pass args sparse_model_metadata device sparse_dlrm=True batch print sparse_dlrm_time_df print Forward Time Normal DLRM norm_dlrm_time_df = measure_forward_pass args sparse_model_metadata device sparse_dlrm=False batch print norm_dlrm_time_df forward_time_all = pd concat sparse_dlrm_time_df norm_dlrm_time_df forward_time_all to_csv dlrm_forward_time_info csv index=False
Owner s module inductor torch _inductor template_heuristics base TemplateConfigHeuristics torch _inductor template_heuristics registry _TEMPLATE_HEURISTIC_REGISTRY clear_registry get_template_heuristic register_template_heuristic torch _inductor test_case run_tests TestCase TestTemplateHeuristicsRegistry TestCase setUp super setUp Save original registry state original_registry = _TEMPLATE_HEURISTIC_REGISTRY copy clear_registry Test heuristic classes using decorator registration tearDown Restore original registry clear_registry _TEMPLATE_HEURISTIC_REGISTRY update original_registry super tearDown test_register_class Test basic registration heuristic Clear registry isolated test clear_registry register_template_heuristic test_mm cuda TestHeuristic TemplateConfigHeuristics pass Verify registration key = test_mm cuda None assertIn key _TEMPLATE_HEURISTIC_REGISTRY assertEqual _TEMPLATE_HEURISTIC_REGISTRY key TestHeuristic test_assertion_existing_class register_template_heuristic triton mm cuda _CrossOpHeuristic TemplateConfigHeuristics template device None - Cross-op specific device Test registered can retrieved The _CrossOpHeuristic registered module level mm cuda None Test retrieval - should match any op cuda device heuristic = get_template_heuristic triton mm cuda bmm assertIsInstance heuristic _CrossOpHeuristic test_hierarchy_lookup Test complete hierarchy template device op - template None None register_template_heuristic triton mm cuda op_name= scaled_mm _MostSpecificHeuristic TemplateConfigHeuristics template device op - Most specific register_template_heuristic triton mm None op_name= scaled_mm _CrossDeviceHeuristic TemplateConfigHeuristics template None op - Cross-device specific op register_template_heuristic triton mm cuda _CrossOpHeuristic TemplateConfigHeuristics template device None - Cross-op specific device register_template_heuristic triton mm None _MostGeneralHeuristic TemplateConfigHeuristics template None None - Most general All classes already registered via decorators _MostSpecificHeuristic mm cuda scaled_mm - Most specific _CrossDeviceHeuristic mm None scaled_mm - Cross-device specific op _CrossOpHeuristic mm cuda None - Cross-op specific device _MostGeneralHeuristic mm None None - Most general Test Exact match - should get most specific heuristic = get_template_heuristic triton mm cuda scaled_mm assertIsInstance heuristic _MostSpecificHeuristic Test Different device same op - should get cross-device heuristic = get_template_heuristic triton mm xpu scaled_mm assertIsInstance heuristic _CrossDeviceHeuristic Test Same device different op - should get cross-op heuristic = get_template_heuristic triton mm cuda bmm assertIsInstance heuristic _CrossOpHeuristic Test Different device op - should get most general heuristic = get_template_heuristic triton mm xpu bmm assertIsInstance heuristic _MostGeneralHeuristic test_partial_hierarchy_scenarios Test hierarchy behavior partial registrations Scenario Register partial hierarchy using decorators register_template_heuristic triton tma None op_name= scaled_tma _TestCrossDeviceHeuristic TemplateConfigHeuristics pass register_template_heuristic triton tma None _TestGeneralHeuristic TemplateConfigHeuristics pass Should get cross-device matching op regardless device heuristic = get_template_heuristic triton tma cuda scaled_tma assertIsInstance heuristic _TestCrossDeviceHeuristic Should fallback general different op heuristic = get_template_heuristic triton tma cuda scaled_mm assertIsInstance heuristic _TestGeneralHeuristic Scenario Only specific device exists register_template_heuristic triton bmm cuda _TestDeviceSpecificHeuristic TemplateConfigHeuristics pass Should get device-specific cuda heuristic = get_template_heuristic triton bmm cuda any_op assertIsInstance heuristic _TestDeviceSpecificHeuristic Should fallback instance other devices no specific heuristic registered heuristic = get_template_heuristic triton bmm xpu any_op assertIsInstance heuristic TemplateConfigHeuristics Make sure s registered specific heuristic assertNotIsInstance heuristic _TestDeviceSpecificHeuristic Scenario Only most general exists register_template_heuristic triton mm None _TestMostGeneralHeuristic TemplateConfigHeuristics pass Should always get general regardless device op heuristic = get_template_heuristic triton mm cuda scaled_addmm assertIsInstance heuristic _TestMostGeneralHeuristic heuristic = get_template_heuristic triton mm xpu regular_addmm assertIsInstance heuristic _TestMostGeneralHeuristic test_fallback_behavior Test fallback TemplateConfigHeuristics returned when no heuristic found Test Get fallback unregistered template heuristic = get_template_heuristic unknown_template cuda unknown_op assertIsInstance heuristic TemplateConfigHeuristics Make sure s base subclass assertEqual type heuristic TemplateConfigHeuristics Test Verify fallback instances NOT cached new instance each time heuristic = get_template_heuristic unknown_template cuda unknown_op assertIsInstance heuristic TemplateConfigHeuristics assertEqual type heuristic TemplateConfigHeuristics Should different instances cached assertIsNot heuristic heuristic Test After registering heuristic should get registered one instead register_template_heuristic unknown_template cuda op_name= unknown_op _NewlyRegisteredHeuristic TemplateConfigHeuristics pass Now should get registered heuristic fallback heuristic = get_template_heuristic unknown_template cuda unknown_op assertIsInstance heuristic _NewlyRegisteredHeuristic assertNotEqual type heuristic TemplateConfigHeuristics Test Verify registered instances ARE cached same instance each time heuristic = get_template_heuristic unknown_template cuda unknown_op assertIsInstance heuristic _NewlyRegisteredHeuristic assertIs heuristic heuristic Should same cached instance __name__ == __main__ run_tests
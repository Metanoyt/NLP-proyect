======= BEGIN Dynamo patch ======= Owner s module dynamo ruff noqa flake noqa Test copied https raw githubusercontent com python cpython refs tags v Lib test test_contextlib py sys torch torch _dynamo test_case unittest torch _dynamo test_case CPythonTestCase torch testing _internal common_utils run_tests __TestCase = CPythonTestCase redirect statements sys importlib abc redirect_imports = test mapping_tests test typinganndata test test_grammar test test_math test test_iter test typinganndata ann_module RedirectImportFinder importlib abc MetaPathFinder find_spec fullname path target=None Check problematic one fullname redirect_imports try Attempt standalone module name = fullname removeprefix test r = importlib import_module name Redirect module sys modules sys modules fullname = r Return module spec found module importlib util find_spec name except ImportError None None Add custom finder sys meta_path sys meta_path insert RedirectImportFinder ======= END DYNAMO PATCH ======= Unit tests contextlib py other context managers io os sys tempfile threading traceback unittest contextlib Tests __all__ test support test support os_helper test support testcase ExceptionIsLikeMixin weakref TestAbstractContextManager __TestCase test_enter torch _dynamo error_on_graph_break False DefaultEnter AbstractContextManager __exit__ args super __exit__ args manager = DefaultEnter assertIs manager __enter__ manager test_slots torch _dynamo error_on_graph_break False DefaultContextManager AbstractContextManager __slots__ = __exit__ args super __exit__ args assertRaises AttributeError DefaultContextManager var = test_exit_is_abstract torch _dynamo error_on_graph_break False MissingExit AbstractContextManager pass assertRaises TypeError MissingExit test_structural_subclassing torch _dynamo error_on_graph_break False ManagerFromScratch __enter__ __exit__ exc_type exc_value traceback None assertTrue issubclass ManagerFromScratch AbstractContextManager torch _dynamo error_on_graph_break False DefaultEnter AbstractContextManager __exit__ args super __exit__ args assertTrue issubclass DefaultEnter AbstractContextManager torch _dynamo error_on_graph_break False NoEnter ManagerFromScratch __enter__ = None assertFalse issubclass NoEnter AbstractContextManager torch _dynamo error_on_graph_break False NoExit ManagerFromScratch __exit__ = None assertFalse issubclass NoExit AbstractContextManager ContextManagerTestCase __TestCase test_contextmanager_plain state = contextmanager woohoo state append yield state append woohoo x assertEqual state assertEqual x state append x assertEqual state test_contextmanager_finally state = contextmanager woohoo state append try yield finally state append assertRaises ZeroDivisionError woohoo x assertEqual state assertEqual x state append x raise ZeroDivisionError assertEqual state test_contextmanager_traceback contextmanager f yield try f except ZeroDivisionError e frames = traceback extract_tb e __traceback__ assertEqual len frames assertEqual frames name test_contextmanager_traceback assertEqual frames line Repeat RuntimeError which goes through different code path torch _dynamo error_on_graph_break False RuntimeErrorSubclass RuntimeError pass try f raise RuntimeErrorSubclass except RuntimeErrorSubclass e frames = traceback extract_tb e __traceback__ assertEqual len frames assertEqual frames name test_contextmanager_traceback assertEqual frames line raise RuntimeErrorSubclass torch _dynamo error_on_graph_break False StopIterationSubclass StopIteration pass stop_exc StopIteration spam StopIterationSubclass spam subTest type=type stop_exc try f raise stop_exc except type stop_exc e assertIs e stop_exc frames = traceback extract_tb e __traceback__ fail f stop_exc suppressed assertEqual len frames assertEqual frames name test_contextmanager_traceback assertEqual frames line raise stop_exc test_contextmanager_no_reraise contextmanager whee yield ctx = whee ctx __enter__ Calling __exit__ should result exception assertFalse ctx __exit__ TypeError TypeError foo None test_contextmanager_trap_yield_after_throw contextmanager whoo try yield except yield ctx = whoo ctx __enter__ assertRaises RuntimeError ctx __exit__ TypeError TypeError foo None support check_impl_detail cpython=True The gen attribute implementation detail assertFalse ctx gen gi_suspended test_contextmanager_trap_no_yield contextmanager whoo False yield ctx = whoo assertRaises RuntimeError ctx __enter__ test_contextmanager_trap_second_yield contextmanager whoo yield yield ctx = whoo ctx __enter__ assertRaises RuntimeError ctx __exit__ None None None support check_impl_detail cpython=True The gen attribute implementation detail assertFalse ctx gen gi_suspended test_contextmanager_non_normalised contextmanager whoo try yield except RuntimeError raise SyntaxError ctx = whoo ctx __enter__ assertRaises SyntaxError ctx __exit__ RuntimeError None None test_contextmanager_except state = contextmanager woohoo state append try yield except ZeroDivisionError e state append e args assertEqual state woohoo x assertEqual state assertEqual x state append x raise ZeroDivisionError assertEqual state test_contextmanager_except_stopiter contextmanager woohoo yield torch _dynamo error_on_graph_break False StopIterationSubclass StopIteration pass stop_exc StopIteration spam StopIterationSubclass spam subTest type=type stop_exc try woohoo raise stop_exc except Exception ex assertIs ex stop_exc fail f stop_exc suppressed test_contextmanager_except_pep code = \ __future__ generator_stop contextlib contextmanager contextmanager woohoo yield locals = exec code locals locals woohoo = locals woohoo stop_exc = StopIteration spam try woohoo raise stop_exc except Exception ex assertIs ex stop_exc fail StopIteration suppressed test_contextmanager_do_not_unchain_non_stopiteration_exceptions contextmanager test_issue try yield except Exception exc raise RuntimeError issue Chained exc try test_issue raise ZeroDivisionError except Exception ex assertIs type ex RuntimeError assertEqual ex args issue Chained assertIsInstance ex __cause__ ZeroDivisionError try test_issue raise StopIteration issue Unchained except Exception ex assertIs type ex StopIteration assertEqual ex args issue Unchained assertIsNone ex __cause__ test_contextmanager_wrap_runtimeerror contextmanager woohoo try yield except Exception exc raise RuntimeError f caught exc exc assertRaises RuntimeError woohoo If context manager wrapped StopIteration RuntimeError we also unwrap because we can t tell whether wrapping done generator machinery generator itself assertRaises StopIteration woohoo raise StopIteration _create_contextmanager_attribs attribs kw decorate func k v kw items setattr func k v func decorate contextmanager attribs foo= bar baz spam Whee yield baz test_contextmanager_attribs baz = _create_contextmanager_attribs assertEqual baz __name__ baz assertEqual baz foo bar support requires_docstrings test_contextmanager_doc_attrib baz = _create_contextmanager_attribs assertEqual baz __doc__ Whee support requires_docstrings test_instance_docstring_given_cm_docstring baz = _create_contextmanager_attribs None assertEqual baz __doc__ Whee test_keywords Ensure no keyword arguments inhibited contextmanager woohoo func args kwds yield func args kwds woohoo self= func= args= kwds= target assertEqual target test_nokeepref torch _dynamo error_on_graph_break False A pass contextmanager woohoo b = weakref ref b = weakref ref b Allow test work non-refcounted GC support gc_collect assertIsNone assertIsNone b yield woohoo A b=A pass test_param_errors contextmanager woohoo b yield assertRaises TypeError woohoo assertRaises TypeError woohoo assertRaises TypeError woohoo b= test_recursive depth = ncols = contextmanager woohoo nonlocal ncols ncols += nonlocal depth before = depth depth += yield depth -= assertEqual depth before woohoo recursive depth recursive recursive assertEqual ncols assertEqual depth ClosingTestCase __TestCase support requires_docstrings test_instance_docs Issue ensure context manager instances have good docstrings cm_docstring = closing __doc__ obj = closing None assertEqual obj __doc__ cm_docstring test_closing state = torch _dynamo error_on_graph_break False C close state append x = C assertEqual state closing x y assertEqual x y assertEqual state test_closing_error state = torch _dynamo error_on_graph_break False C close state append x = C assertEqual state assertRaises ZeroDivisionError closing x y assertEqual x y assertEqual state NullcontextTestCase __TestCase test_nullcontext torch _dynamo error_on_graph_break False C pass c = C nullcontext c c_in assertIs c_in c FileContextTestCase __TestCase testWithOpen tfn = tempfile mktemp try open tfn w encoding= utf- f assertFalse f closed f write Booh\n assertTrue f closed assertRaises ZeroDivisionError open tfn r encoding= utf- f assertFalse f closed assertEqual f read Booh\n assertTrue f closed finally os_helper unlink tfn LockContextTestCase __TestCase boilerPlate lock locked assertFalse locked lock assertTrue locked assertFalse locked assertRaises ZeroDivisionError lock assertTrue locked assertFalse locked testWithLock lock = threading Lock boilerPlate lock lock locked testWithRLock lock = threading RLock boilerPlate lock lock _is_owned testWithCondition lock = threading Condition locked lock _is_owned boilerPlate lock locked testWithSemaphore lock = threading Semaphore locked lock acquire False lock release False True boilerPlate lock locked testWithBoundedSemaphore lock = threading BoundedSemaphore locked lock acquire False lock release False True boilerPlate lock locked mycontext ContextDecorator Example decoration-compatible context manager testing started = False exc = None catch = False __enter__ started = True __exit__ exc exc = exc catch TestContextDecorator __TestCase support requires_docstrings test_instance_docs Issue ensure context manager instances have good docstrings cm_docstring = mycontext __doc__ obj = mycontext assertEqual obj __doc__ cm_docstring test_contextdecorator context = mycontext context result assertIs result context assertTrue context started assertEqual context exc None None None test_contextdecorator_with_exception context = mycontext assertRaisesRegex NameError foo context raise NameError foo assertIsNotNone context exc assertIs context exc NameError context = mycontext context catch = True context raise NameError foo assertIsNotNone context exc assertIs context exc NameError test_decorator context = mycontext context test assertIsNone context exc assertTrue context started test assertEqual context exc None None None test_decorator_with_exception context = mycontext context test assertIsNone context exc assertTrue context started raise NameError foo assertRaisesRegex NameError foo test assertIsNotNone context exc assertIs context exc NameError test_decorating_method context = mycontext torch _dynamo error_on_graph_break False Test object context method b c=None = b = b c = c these tests argument passing when used decorator test = Test test method assertEqual test assertEqual test b assertEqual test c None test = Test test method b c assertEqual test assertEqual test b b assertEqual test c c test = Test test method a= b= assertEqual test assertEqual test b test_typo_enter torch _dynamo error_on_graph_break False mycontext ContextDecorator __unter__ pass __exit__ exc pass assertRaisesRegex TypeError context manager mycontext pass test_typo_exit torch _dynamo error_on_graph_break False mycontext ContextDecorator __enter__ pass __uxit__ exc pass assertRaisesRegex TypeError context manager __exit__ mycontext pass test_contextdecorator_as_mixin torch _dynamo error_on_graph_break False somecontext object started = False exc = None __enter__ started = True __exit__ exc exc = exc mycontext somecontext ContextDecorator pass context = mycontext context test assertIsNone context exc assertTrue context started test assertEqual context exc None None None test_contextmanager_as_decorator contextmanager woohoo y state append y yield state append state = woohoo test x assertEqual state state append x test something assertEqual state something Issue Ensure decorated function reusable state = test something assertEqual state something _TestBaseExitStack exit_stack = None support requires_docstrings test_instance_docs Issue ensure context manager instances have good docstrings cm_docstring = exit_stack __doc__ obj = exit_stack assertEqual obj __doc__ cm_docstring test_no_resources exit_stack pass test_callback expected = dict example= dict example= dict example= dict self= callback= result = _exit args kwds Test metadata propagation result append args kwds exit_stack stack args kwds reversed expected args kwds f = stack callback _exit args kwds args f = stack callback _exit args kwds f = stack callback _exit kwds f = stack callback _exit assertIs f _exit wrapper stack _exit_callbacks assertIs wrapper __wrapped__ _exit assertNotEqual wrapper __name__ _exit __name__ assertIsNone wrapper __doc__ _exit __doc__ assertEqual result expected result = exit_stack stack assertRaises TypeError stack callback arg= assertRaises TypeError exit_stack callback arg= assertRaises TypeError stack callback callback=_exit arg= assertEqual result test_push exc_raised = ZeroDivisionError _expect_exc exc_type exc exc_tb assertIs exc_type exc_raised _suppress_exc exc_details True _expect_ok exc_type exc exc_tb assertIsNone exc_type assertIsNone exc assertIsNone exc_tb torch _dynamo error_on_graph_break False ExitCM object __init__ check_exc check_exc = check_exc __enter__ fail Should called __exit__ exc_details check_exc exc_details exit_stack stack stack push _expect_ok assertIs stack _exit_callbacks - _expect_ok cm = ExitCM _expect_ok stack push cm assertIs stack _exit_callbacks - __self__ cm stack push _suppress_exc assertIs stack _exit_callbacks - _suppress_exc cm = ExitCM _expect_exc stack push cm assertIs stack _exit_callbacks - __self__ cm stack push _expect_exc assertIs stack _exit_callbacks - _expect_exc stack push _expect_exc assertIs stack _exit_callbacks - _expect_exc test_enter_context torch _dynamo error_on_graph_break False TestCM object __enter__ result append __exit__ exc_details result append result = cm = TestCM exit_stack stack stack callback Registered first = cleaned up last _exit result append assertIsNotNone _exit stack enter_context cm assertIs stack _exit_callbacks - __self__ cm result append assertEqual result test_enter_context_errors torch _dynamo error_on_graph_break False LacksEnterAndExit pass LacksEnter __exit__ exc_info pass LacksExit __enter__ pass exit_stack stack assertRaisesRegex TypeError context manager stack enter_context LacksEnterAndExit assertRaisesRegex TypeError context manager stack enter_context LacksEnter assertRaisesRegex TypeError context manager stack enter_context LacksExit assertFalse stack _exit_callbacks test_close result = exit_stack stack stack callback _exit result append assertIsNotNone _exit stack close result append assertEqual result test_pop_all result = exit_stack stack stack callback _exit result append assertIsNotNone _exit new_stack = stack pop_all result append result append new_stack close assertEqual result test_exit_raise assertRaises ZeroDivisionError exit_stack stack stack push lambda exc False test_exit_suppress exit_stack stack stack push lambda exc True test_exit_exception_traceback This test captures current behavior ExitStack so we know we ever unintendedly change It statement what desired behavior instance we may want remove some internal contextlib frames raise_exc exc raise exc try exit_stack stack stack callback raise_exc ValueError except ValueError e exc = e assertIsInstance exc ValueError ve_frames = traceback extract_tb exc __traceback__ expected = \ test_exit_exception_traceback exit_stack stack + \ callback_error_internal_frames + \ _exit_wrapper callback args kwds raise_exc raise exc assertEqual f name f line f ve_frames expected assertIsInstance exc __context__ ZeroDivisionError zde_frames = traceback extract_tb exc __context__ __traceback__ assertEqual f name f line f zde_frames test_exit_exception_traceback test_exit_exception_chaining_reference Sanity check make sure ExitStack chaining matches actual nested statements torch _dynamo error_on_graph_break False RaiseExc __init__ exc exc = exc __enter__ __exit__ exc_details raise exc RaiseExcWithContext __init__ outer inner outer = outer inner = inner __enter__ __exit__ exc_details try raise inner except raise outer SuppressExc __enter__ __exit__ exc_details type saved_details = exc_details True try RaiseExc IndexError RaiseExcWithContext KeyError AttributeError SuppressExc RaiseExc ValueError except IndexError exc assertIsInstance exc __context__ KeyError assertIsInstance exc __context__ __context__ AttributeError Inner exceptions suppressed assertIsNone exc __context__ __context__ __context__ fail Expected IndexError no exception raised Check inner exceptions inner_exc = SuppressExc saved_details assertIsInstance inner_exc ValueError assertIsInstance inner_exc __context__ ZeroDivisionError test_exit_exception_chaining Ensure exception chaining matches reference behaviour raise_exc exc raise exc saved_details = None suppress_exc exc_details nonlocal saved_details saved_details = exc_details True try exit_stack stack stack callback raise_exc IndexError stack callback raise_exc KeyError stack callback raise_exc AttributeError stack push suppress_exc stack callback raise_exc ValueError except IndexError exc assertIsInstance exc __context__ KeyError assertIsInstance exc __context__ __context__ AttributeError Inner exceptions suppressed assertIsNone exc __context__ __context__ __context__ fail Expected IndexError no exception raised Check inner exceptions inner_exc = saved_details assertIsInstance inner_exc ValueError assertIsInstance inner_exc __context__ ZeroDivisionError test_exit_exception_explicit_none_context Ensure ExitStack chaining matches actual nested ` ` statements regarding explicit __context__ = None torch _dynamo error_on_graph_break False MyException Exception pass contextmanager my_cm try yield except BaseException exc = MyException try raise exc finally exc __context__ = None contextmanager my_cm_with_exit_stack exit_stack stack stack enter_context my_cm yield stack cm my_cm my_cm_with_exit_stack subTest try cm raise IndexError except MyException exc assertIsNone exc __context__ fail Expected IndexError no exception raised test_exit_exception_non_suppressing http bugs python org issue raise_exc exc raise exc suppress_exc exc_details True try exit_stack stack stack callback lambda None stack callback raise_exc IndexError except Exception exc assertIsInstance exc IndexError fail Expected IndexError no exception raised try exit_stack stack stack callback raise_exc KeyError stack push suppress_exc stack callback raise_exc IndexError except Exception exc assertIsInstance exc KeyError fail Expected KeyError no exception raised test_exit_exception_with_correct_context http bugs python org issue contextmanager gets_the_context_right exc try yield finally raise exc exc = Exception exc = Exception exc = Exception exc = Exception The contextmanager already fixes context so prior fix ExitStack would try fix again get into infinite self-referential loop try exit_stack stack stack enter_context gets_the_context_right exc stack enter_context gets_the_context_right exc stack enter_context gets_the_context_right exc raise exc except Exception exc assertIs exc exc assertIs exc __context__ exc assertIs exc __context__ __context__ exc assertIs exc __context__ __context__ __context__ exc assertIsNone exc __context__ __context__ __context__ __context__ test_exit_exception_with_existing_context Addresses lack test coverage discovered after checking fix issue still contained debugging code raise_nested inner_exc outer_exc try raise inner_exc finally raise outer_exc exc = Exception exc = Exception exc = Exception exc = Exception exc = Exception try exit_stack stack stack callback raise_nested exc exc stack callback raise_nested exc exc raise exc except Exception exc assertIs exc exc assertIs exc __context__ exc assertIs exc __context__ __context__ exc assertIs exc __context__ __context__ __context__ exc assertIs exc __context__ __context__ __context__ __context__ exc assertIsNone exc __context__ __context__ __context__ __context__ __context__ test_body_exception_suppress suppress_exc exc_details True try exit_stack stack stack push suppress_exc except IndexError exc fail Expected no exception got IndexError test_exit_exception_chaining_suppress exit_stack stack stack push lambda exc True stack push lambda exc stack push lambda exc test_excessive_nesting The original implementation would die RecursionError here exit_stack stack i range stack callback int test_instance_bypass torch _dynamo error_on_graph_break False Example object pass cm = Example cm __enter__ = object cm __exit__ = object stack = exit_stack assertRaisesRegex TypeError context manager stack enter_context cm stack push cm assertIs stack _exit_callbacks - cm test_dont_reraise_RuntimeError https bugs python org issue torch _dynamo error_on_graph_break False UniqueException Exception pass UniqueRuntimeError RuntimeError pass contextmanager second try yield except Exception exc raise UniqueException new exception exc contextmanager first try yield except Exception exc raise exc The UniqueRuntimeError should caught second s exception handler which chain raised new UniqueException assertRaises UniqueException err_ctx exit_stack es_ctx es_ctx enter_context second es_ctx enter_context first raise UniqueRuntimeError please no infinite loop exc = err_ctx exception assertIsInstance exc UniqueException assertIsInstance exc __context__ UniqueRuntimeError assertIsNone exc __context__ __context__ assertIsNone exc __context__ __cause__ assertIs exc __cause__ exc __context__ TestExitStack _TestBaseExitStack __TestCase exit_stack = ExitStack callback_error_internal_frames = __exit__ raise exc __exit__ cb exc_details _TestRedirectStream redirect_stream = None orig_stream = None support requires_docstrings test_instance_docs Issue ensure context manager instances have good docstrings cm_docstring = redirect_stream __doc__ obj = redirect_stream None assertEqual obj __doc__ cm_docstring test_no_redirect_in_init orig_stdout = getattr sys orig_stream redirect_stream None assertIs getattr sys orig_stream orig_stdout test_redirect_to_string_io f = io StringIO msg = Consider API like help which prints directly stdout orig_stdout = getattr sys orig_stream redirect_stream f print msg file=getattr sys orig_stream assertIs getattr sys orig_stream orig_stdout s = f getvalue strip assertEqual s msg test_enter_result_is_target f = io StringIO redirect_stream f enter_result assertIs enter_result f test_cm_is_reusable f = io StringIO write_to_f = redirect_stream f orig_stdout = getattr sys orig_stream write_to_f print Hello end= file=getattr sys orig_stream write_to_f print World file=getattr sys orig_stream assertIs getattr sys orig_stream orig_stdout s = f getvalue assertEqual s Hello World \n test_cm_is_reentrant f = io StringIO write_to_f = redirect_stream f orig_stdout = getattr sys orig_stream write_to_f print Hello end= file=getattr sys orig_stream write_to_f print World file=getattr sys orig_stream assertIs getattr sys orig_stream orig_stdout s = f getvalue assertEqual s Hello World \n TestRedirectStdout _TestRedirectStream __TestCase redirect_stream = redirect_stdout orig_stream = stdout TestRedirectStderr _TestRedirectStream __TestCase redirect_stream = redirect_stderr orig_stream = stderr TestSuppress ExceptionIsLikeMixin __TestCase support requires_docstrings test_instance_docs Issue ensure context manager instances have good docstrings cm_docstring = suppress __doc__ obj = suppress assertEqual obj __doc__ cm_docstring test_no_result_from_enter suppress ValueError enter_result assertIsNone enter_result test_no_exception suppress ValueError assertEqual pow test_exact_exception suppress TypeError len test_exception_hierarchy suppress LookupError Hello test_other_exception assertRaises ZeroDivisionError suppress TypeError test_no_args assertRaises ZeroDivisionError suppress test_multiple_exception_args suppress ZeroDivisionError TypeError suppress ZeroDivisionError TypeError len test_cm_is_reentrant ignore_exceptions = suppress Exception ignore_exceptions pass ignore_exceptions len ignore_exceptions ignore_exceptions Check nested usage len outer_continued = True assertTrue outer_continued test_exception_groups eg_ve = lambda ExceptionGroup EG ValueErrors only ValueError ve ValueError ve ValueError ve eg_all = lambda ExceptionGroup EG many types exceptions ValueError ve KeyError ke ValueError ve KeyError ke suppress ValueError raise eg_ve suppress ValueError KeyError raise eg_all assertRaises ExceptionGroup eg suppress ValueError raise eg_all assertExceptionIsLike eg exception ExceptionGroup EG many types exceptions KeyError ke KeyError ke Check handling BaseExceptionGroup using GeneratorExit so we don t accidentally discard ctrl-c KeyboardInterrupt suppress GeneratorExit raise BaseExceptionGroup message GeneratorExit If we raise BaseException group we can still suppress parts assertRaises BaseExceptionGroup eg suppress KeyError raise BaseExceptionGroup message GeneratorExit g KeyError k assertExceptionIsLike eg exception BaseExceptionGroup message GeneratorExit g If we suppress all leaf BaseExceptions we get non-base ExceptionGroup assertRaises ExceptionGroup eg suppress GeneratorExit raise BaseExceptionGroup message GeneratorExit g KeyError k assertExceptionIsLike eg exception ExceptionGroup message KeyError k TestChdir __TestCase make_relative_path parts os path join os path dirname os path realpath __file__ parts test_simple old_cwd = os getcwd target = make_relative_path data assertNotEqual old_cwd target chdir target assertEqual os getcwd target assertEqual os getcwd old_cwd unittest skip Missing archivetestdata test_reentrant old_cwd = os getcwd target = make_relative_path data target = make_relative_path archivetestdata assertNotIn old_cwd target target chdir chdir = chdir target chdir target chdir assertEqual os getcwd target chdir assertEqual os getcwd target chdir assertEqual os getcwd target assertEqual os getcwd target assertEqual os getcwd target assertEqual os getcwd old_cwd test_exception old_cwd = os getcwd target = make_relative_path data assertNotEqual old_cwd target try chdir target assertEqual os getcwd target raise RuntimeError boom except RuntimeError re assertEqual str re boom assertEqual os getcwd old_cwd __name__ == __main__ run_tests
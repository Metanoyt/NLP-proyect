Owner s module unknown collections unittest torch torch testing _internal common_utils run_tests TestCase try psutil HAS_PSUTIL = True except ModuleNotFoundError HAS_PSUTIL = False psutil = None device = torch device cpu Network torch nn Module maxp = torch nn MaxPool d forward x maxp x unittest skipIf HAS_PSUTIL Requires psutil run TestOpenMP_ParallelFor TestCase batch = channels = side_dim = x = torch randn batch channels side_dim side_dim device=device model = Network func runs p = psutil Process warm up runs then things should stable last last_rss = collections deque maxlen= _ range _ range runs model x last_rss append p memory_info rss last_rss func_rss runs last_rss = list func runs Check sequence strictly increasing is_increasing = True idx range len last_rss idx == continue is_increasing = is_increasing last_rss idx last_rss idx - assertTrue is_increasing msg=f memory usage increasing str last_rss test_one_thread Make sure there no memory leak one thread issue gh- torch set_num_threads func_rss test_n_threads Make sure there no memory leak many threads ncores = min psutil cpu_count logical=False torch set_num_threads ncores func_rss __name__ == __main__ run_tests
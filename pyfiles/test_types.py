Owner s oncall jit ruff noqa F inspect os sys collections namedtuple textwrap dedent typing Dict Iterator List Optional Tuple torch torch testing _internal jit_utils jit test_module_interface TestModuleInterface noqa F torch testing FileCheck torch testing _internal common_utils raise_on_run_directly torch testing _internal jit_utils JitTestCase Make helper files test importable pytorch_test_dir = os path dirname os path dirname os path realpath __file__ sys path append pytorch_test_dir TestTypesAndAnnotation JitTestCase test_pep _type TODO add test use PEP type annotation type after py see https www python org dev peps pep- #id fn x torch Tensor - Tuple Tuple torch Tensor Dict str int xl list tuple torch Tensor = xd dict str int = xl append x xd foo = xl pop xd checkScript fn torch randn x = torch randn expected = fn x scripted = torch jit script fn x assertEqual expected scripted test_types_as_values fn m torch Tensor - torch device m device checkScript fn torch randn GG = namedtuple GG f g Foo torch nn Module torch jit ignore foo x torch Tensor z torch Tensor - Tuple GG GG GG x z GG x z forward x z foo x z foo = torch jit script Foo y = foo torch randn torch randn Foo torch nn Module torch jit ignore foo x z - Tuple GG GG GG x z forward x z foo x z foo = torch jit script Foo y = foo torch randn torch randn test_ignore_with_types torch jit ignore fn x Dict str Optional torch Tensor x + M torch nn Module forward in_batch Dict str Optional torch Tensor - torch Tensor dropout_modality in_batch fn in_batch torch tensor torch jit ignore dropout_modality in_batch Dict str Optional torch Tensor - Dict str Optional torch Tensor in_batch sm = torch jit script M FileCheck check dropout_modality check in_batch run str sm graph test_python_callable MyPythonClass torch jit ignore __call__ args - str str type args the_class = MyPythonClass torch jit script fn x the_class x This doesn t involve string frontend so don t use checkScript x = torch ones assertEqual fn x the_class x test_bad_types torch jit ignore fn my_arg my_arg + assertRaisesRegex RuntimeError argument my_arg torch jit script other_fn x fn test_type_annotate_py fn List int = b torch Tensor = torch ones c Optional torch Tensor = None d Optional torch Tensor = torch ones _ range append c = torch ones d = None b c d checkScript fn wrong_type wrong List int = wrong assertRaisesRegex RuntimeError List type annotation r ` List\ int\ ` did match types given list elements torch jit script wrong_type test_optional_no_element_type_annotation Test using optional no contained types produces error fn_with_comment x torch Tensor - Optional x x annotated_fn x torch Tensor - Optional x x assertRaisesRegex RuntimeError r Attempted use Optional without contained type cu = torch jit CompilationUnit cu define dedent inspect getsource fn_with_comment assertRaisesRegex RuntimeError r Attempted use Optional without contained type cu = torch jit CompilationUnit cu define dedent inspect getsource annotated_fn assertRaisesRegex RuntimeError r Attempted use Optional without contained type torch jit script fn_with_comment assertRaisesRegex RuntimeError r Attempted use Optional without contained type torch jit script annotated_fn test_tuple_no_element_type_annotation Test using tuple no contained types produces error fn_with_comment x torch Tensor - Tuple x x annotated_fn x torch Tensor - Tuple x x assertRaisesRegex RuntimeError r Attempted use Tuple without contained type cu = torch jit CompilationUnit cu define dedent inspect getsource fn_with_comment assertRaisesRegex RuntimeError r Attempted use Tuple without contained type cu = torch jit CompilationUnit cu define dedent inspect getsource annotated_fn assertRaisesRegex RuntimeError r Attempted use Tuple without contained type torch jit script fn_with_comment assertRaisesRegex RuntimeError r Attempted use Tuple without contained type torch jit script annotated_fn test_ignoring_module_attributes Test module attributes can ignored Sub torch nn Module forward int - int sum ModuleWithIgnoredAttr torch nn Module __jit_ignored_attributes__ = sub __init__ int b int super __init__ = b = b sub = Sub forward - int b torch jit ignore ignored_fn - int sub forward mod = ModuleWithIgnoredAttr scripted_mod = torch jit script mod assertEqual scripted_mod assertEqual scripted_mod ignored_fn Test error message ignored attributes ModuleUsesIgnoredAttr torch nn Module __jit_ignored_attributes__ = sub __init__ int super __init__ = sub = Sub forward - int sub b mod = ModuleUsesIgnoredAttr assertRaisesRegexWithHighlight RuntimeError r attribute ignored during compilation sub scripted_mod = torch jit script mod test_ignoring_fn_with_nonscriptable_types CFX __init__ List torch Tensor - None = forward x torch Tensor - torch Tensor torch sin x torch jit _drop __iter__ - Iterator torch Tensor iter torch jit _drop __fx_create_arg__ tracer torch fx Tracer - torch fx node Argument torch fx classes scriptable tracer create_node call_function CFX args= tracer create_arg features kwargs= torch jit script CFX test_unimported_type_resolution verify fallback python resolver c++ resolver torch jit script fn x type number - number x + FileCheck check Scalar run fn graph test_parser_bug parser_bug o Optional torch Tensor pass test_mismatched_annotation assertRaisesRegex RuntimeError annotated type torch jit script foo x str = x test_reannotate assertRaisesRegex RuntimeError declare annotate torch jit script foo x = == x Optional int = test_annotate_outside_init msg = annotations instance attributes must declared __init__ highlight = x int Simple case assertRaisesRegexWithHighlight ValueError msg highlight torch jit script BadModule __init__ x int x = x set val int x int = val Type annotation loop assertRaisesRegexWithHighlight ValueError msg highlight torch jit script BadModuleLoop __init__ x int x = x set val int _ range x int = val Type annotation __init__ should fail torch jit script GoodModule __init__ x int x int = x set val int x = val test_inferred_type_error_message inferred_type = torch _C InferredType ErrorReason assertRaisesRegex RuntimeError Tried get type InferredType type null t = inferred_type type assertRaisesRegex RuntimeError ErrorReason t = inferred_type type __name__ == __main__ raise_on_run_directly test test_jit py
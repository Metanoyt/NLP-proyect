token collections abc Sequence tokenize TokenInfo NO_TOKEN ParseError FSTRING_START int = getattr token FSTRING_START NO_TOKEN FSTRING_END int = getattr token FSTRING_END NO_TOKEN BRACKETS = BRACKETS_INV = j i i j BRACKETS items bracket_pairs tokens Sequence TokenInfo - dict int int Returns dictionary mapping opening closing brackets braces dict int int = stack list int = in_fstring = False i t enumerate tokens t type == token OP in_fstring t string BRACKETS stack append i inv = BRACKETS_INV get t string stack raise ParseError t Never opened begin = stack pop stack stack - == FSTRING_START braces begin = i b = tokens begin string b = inv raise ParseError t f Mismatched braces b begin t type == FSTRING_START stack append FSTRING_START in_fstring = True t type == FSTRING_END stack pop = FSTRING_START raise ParseError t Mismatched FSTRING_START FSTRING_END in_fstring = False stack raise ParseError t Left open braces
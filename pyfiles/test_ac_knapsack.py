Owner s module functorch torch _functorch _activation_checkpointing graph_info_provider GraphInfoProvider torch _functorch _activation_checkpointing knapsack_evaluator KnapsackEvaluator torch fx graph Graph torch testing _internal common_utils run_tests TestCase TestGraphInfoProvider TestCase Test GraphInfoProvider The test sets up small graph example tests methods validating graph building logic setUp - None super setUp graph_nodes_in_order = node node node node node output graph_edges = node node node node node node node node node output node output all_recomputable_banned_nodes = node node node recorded_knapsack_input_memories = recorded_knapsack_input_runtimes = graph_info_provider = GraphInfoProvider graph_nodes_in_order=self graph_nodes_in_order graph_edges=self graph_edges all_recomputable_banned_nodes=self all_recomputable_banned_nodes recorded_knapsack_input_memories=self recorded_knapsack_input_memories recorded_knapsack_input_runtimes=self recorded_knapsack_input_runtimes test_inialize_from_graph joint_graph = Graph node = joint_graph placeholder node node = joint_graph call_function lambda x x node node name = node node = joint_graph call_function lambda x x node node name = node node = joint_graph call_function lambda x x node node name = node node = joint_graph call_function lambda x x node node name = node output = joint_graph call_function lambda x y x y node node output name = output all_recomputable_banned_nodes = node node node recorded_knapsack_input_memories = recorded_knapsack_input_runtimes = graph_info_provider = GraphInfoProvider inialize_from_graph joint_graph=joint_graph all_recomputable_banned_nodes=all_recomputable_banned_nodes recorded_knapsack_input_memories=recorded_knapsack_input_memories recorded_knapsack_input_runtimes=recorded_knapsack_input_runtimes assertEqual graph_info_provider graph_nodes_in_order node node node node node output assertEqual sorted graph_info_provider graph_edges sorted node node node node node node node node node output node output assertEqual graph_info_provider all_recomputable_banned_nodes node node node test_get_non_ac_peak_memory assertEqual graph_info_provider get_non_ac_peak_memory sum recorded_knapsack_input_memories test_get_theoretical_max_runtime assertEqual graph_info_provider get_theoretical_max_runtime sum recorded_knapsack_input_runtimes test_get_knapsack_memory_input assertEqual graph_info_provider get_knapsack_memory_input recorded_knapsack_input_memories test_get_knapsack_runtime_input assertEqual graph_info_provider get_knapsack_runtime_input recorded_knapsack_input_runtimes test_recomputable_node_only_graph recomputable_node_only_graph = graph_info_provider recomputable_node_only_graph expected_nodes = all_recomputable_banned_nodes expected_edges = node node assertEqual list recomputable_node_only_graph nodes expected_nodes assertEqual sorted recomputable_node_only_graph edges sorted expected_edges test_recomputable_node_only_graph_with_larger_graph_context recomputable_node_only_graph_with_larger_graph_context = graph_info_provider recomputable_node_only_graph_with_larger_graph_context noqa B expected_nodes = all_recomputable_banned_nodes node does have indirect path node because node node has indirect path node expected_edges = node node node node assertEqual sorted recomputable_node_only_graph_with_larger_graph_context nodes sorted expected_nodes assertEqual sorted recomputable_node_only_graph_with_larger_graph_context edges sorted expected_edges test_full_joint_nx_graph graph_info_provider = GraphInfoProvider graph_nodes_in_order=self graph_nodes_in_order graph_edges=self graph_edges all_recomputable_banned_nodes=self all_recomputable_banned_nodes recorded_knapsack_input_memories=self recorded_knapsack_input_memories recorded_knapsack_input_runtimes=self recorded_knapsack_input_runtimes full_joint_nx_graph = graph_info_provider full_joint_nx_graph expected_nodes = node node graph_nodes_in_order node = output expected_edges = u v u v graph_edges u = output v = output assertEqual list full_joint_nx_graph nodes expected_nodes assertEqual sorted full_joint_nx_graph edges sorted expected_edges test_simplified_fx_joint_graph graph_info_provider = GraphInfoProvider graph_nodes_in_order=self graph_nodes_in_order graph_edges=self graph_edges all_recomputable_banned_nodes=self all_recomputable_banned_nodes recorded_knapsack_input_memories=self recorded_knapsack_input_memories recorded_knapsack_input_runtimes=self recorded_knapsack_input_runtimes simplified_fx_joint_graph = graph_info_provider simplified_fx_joint_graph expected_nodes = graph_nodes_in_order expected_edges = graph_edges assertEqual node name node simplified_fx_joint_graph nodes expected_nodes assertEqual sorted node name user name node simplified_fx_joint_graph nodes user node users sorted expected_edges TestKnapsackEvaluator TestCase Test KnapsackEvaluator The test sets up small graph example tests methods validating knapsack evaluation logic setUp - None super setUp graph_nodes_in_order = node node node node node output graph_edges = node node node node node node node node node output node output all_recomputable_banned_nodes = node node node recorded_knapsack_input_memories = recorded_knapsack_input_runtimes = graph_info_provider = GraphInfoProvider graph_nodes_in_order=self graph_nodes_in_order graph_edges=self graph_edges all_recomputable_banned_nodes=self all_recomputable_banned_nodes recorded_knapsack_input_memories=self recorded_knapsack_input_memories recorded_knapsack_input_runtimes=self recorded_knapsack_input_runtimes knapsack_evaluator = KnapsackEvaluator graph_info_provider=self graph_info_provider knapsack_algo = lambda memory_values runtime_values memory_budget get memory_budget test_evaluate_knapsack_output_not_accounting_for_backward_pass saved_nodes_idxs = recomputable_node_idxs = result = knapsack_evaluator evaluate_knapsack_output saved_nodes_idxs=saved_nodes_idxs recomputable_node_idxs=recomputable_node_idxs assertEqual result peak_memory assertEqual result recomputation_runtime test_evaluate_knapsack_output_accounting_for_backward_pass saved_nodes_idxs = recomputable_node_idxs = result = knapsack_evaluator evaluate_knapsack_output saved_nodes_idxs=saved_nodes_idxs recomputable_node_idxs=recomputable_node_idxs account_for_backward_pass=True assertEqual result peak_memory assertEqual result recomputation_runtime test_evaluate_knapsack_output_with_wrong_sized_values saved_nodes_idxs = recomputable_node_idxs = assertRaises AssertionError knapsack_evaluator evaluate_knapsack_output saved_nodes_idxs=saved_nodes_idxs recomputable_node_idxs=recomputable_node_idxs test_evaluate_distribution_of_results_for_knapsack_algo memory_budget_values = results = knapsack_evaluator evaluate_distribution_of_results_for_knapsack_algo knapsack_algo=self knapsack_algo memory_budget_values=memory_budget_values assertEqual len results len memory_budget_values assertEqual results memory_budget assertEqual results peak_memory assertEqual results recomputation_runtime assertEqual results non_ac_peak_memory assertEqual results theoretical_max_runtime assertEqual results percentage_of_theoretical_peak_memory assertEqual results percentage_of_theoretical_peak_runtime test_get_knee_point_memory_budget Checks method correctly estimates knee point memory budget where trade-off between memory usage recomputation runtime optimal If memory budget runtime considered equal cost then knee point where distance smallest max_mem_budget_to_expected_knee_point = provide same algo output so arbitrary max_mem_budget expected_knee_point max_mem_budget_to_expected_knee_point items knee_point_memory_budget = knapsack_evaluator get_knee_point_memory_budget knapsack_algo=self knapsack_algo max_mem_budget=max_mem_budget min_mem_budget= iterations= assertEqual knee_point_memory_budget expected_knee_point test_get_backward_memory_from_topologically_sorted_graph result = knapsack_evaluator _get_backward_memory_from_topologically_sorted_graph node_graph=self graph_info_provider recomputable_node_only_graph_with_larger_graph_context node_memories=self graph_info_provider all_node_memories saved_nodes_set= node peak_memory_after_forward_pass= expected_result = Initial Peak Current Memory Recomputing Node node Recomputing Predecessor node node Dropping Node node Dropping Node already saved node Dropping Node already saved node print result expected_result result_item expected_result_item zip result expected_result assertAlmostEqual result_item expected_result_item assertEqual result_item expected_result_item __name__ == __main__ run_tests
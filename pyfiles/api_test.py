usr bin env python Owner s oncall r p Copyright c Facebook Inc its affiliates All rights reserved This source code licensed under BSD-style license found LICENSE file root directory source tree multiprocessing mp os shutil signal sys tempfile time unittest uuid contextlib closing typing Any Optional unittest mock unittest mock MagicMock Mock patch torch torch distributed dist torch distributed elastic agent server api RunResult WorkerState torch distributed elastic multiprocessing api SignalException torch distributed elastic multiprocessing errors ChildFailedError torch distributed elastic rendezvous etcd_server EtcdServer torch distributed elastic utils get_socket_with_port torch distributed launcher api _get_entrypoint_name elastic_launch launch_agent LaunchConfig torch testing _internal common_utils skip_but_pass_in_sandcastle_if TEST_WITH_DEV_DBG_ASAN path script os path join os path dirname __file__ script simple_rank_scale rank = int os environ RANK + rank function_with_bug raise RuntimeError test error get_test_launch_config rdzv_endpoint str min_nodes int max_nodes int nproc_per_node int run_id str = rdzv_backend str = etcd config Optional dict str Any = None - LaunchConfig rdzv_configs = config rdzv_configs update config LaunchConfig min_nodes=min_nodes max_nodes=max_nodes nproc_per_node=nproc_per_node run_id=run_id rdzv_endpoint=rdzv_endpoint monitor_interval= rdzv_backend=rdzv_backend start_method= spawn max_restarts= rdzv_configs=rdzv_configs elastic_launch_wrapper test_dir str rdzv_endpoint str min_nodes int max_nodes int nproc_per_node int run_id str A wrapper function ` elastic_launch ` order make multiprocess returns correct exit code elastic_launch get_test_launch_config rdzv_endpoint min_nodes max_nodes nproc_per_node run_id sys executable -u path bin test_script py f -- touch-file-dir= test_dir _dist_sum wait= rank = int os environ RANK dist init_process_group backend= gloo t = torch tensor rank time sleep wait dist all_reduce t op=dist reduce_op SUM t item ELASTIC_AGENT_RUN = torch distributed launcher api LocalElasticAgent run EVENTS_RECORD = torch distributed launcher api events record GET_RDZV_HANDLER = torch distributed elastic rendezvous registry get_rendezvous_handler MockException Exception pass short_hash str uuid uuid split - ElasticLaunchTest unittest TestCase classmethod setUpClass cls start standalone single process etcd server use all tests cls _etcd_server = EtcdServer cls _etcd_server start cls _etcd_endpoint = cls _etcd_server get_endpoint classmethod tearDownClass cls stop standalone etcd server cls _etcd_server stop setUp test_dir = tempfile mkdtemp remove any lingering environment variables env os environ keys env startswith PET_ del os environ env set sentinel env var parent proc should present child gets asserted ` ` bin test_script py ` ` os environ TEST_SENTINEL_PARENT = FOOBAR os environ OMP_NUM_THREADS = str tearDown shutil rmtree test_dir check_works_ran world_size int assertSetEqual str i i range world_size set os listdir test_dir skip_but_pass_in_sandcastle_if TEST_WITH_DEV_DBG_ASAN test incompatible dev dbg asan test_launch_script_python nnodes = nproc_per_node = elastic_launch get_test_launch_config _etcd_endpoint nnodes nnodes nproc_per_node sys executable -u path bin test_script py f -- touch-file-dir= test_dir make sure all workers ran each worker touches file its global rank name world_size = nnodes nproc_per_node check_works_ran world_size skip_but_pass_in_sandcastle_if TEST_WITH_DEV_DBG_ASAN test incompatible dev dbg asan test_launch_script_python_local_rank_transfer nnodes = nproc_per_node = elastic_launch get_test_launch_config _etcd_endpoint nnodes nnodes nproc_per_node sys executable -u path bin test_script py f -- touch-file-dir= test_dir make sure all workers ran each worker touches file its global rank name world_size = nnodes nproc_per_node check_works_ran world_size skip_but_pass_in_sandcastle_if TEST_WITH_DEV_DBG_ASAN test incompatible dev dbg asan test_launch_script_bash nnodes = nproc_per_node = elastic_launch get_test_launch_config _etcd_endpoint nnodes nnodes nproc_per_node path bin test_script sh f test_dir world_size = nnodes nproc_per_node check_works_ran world_size skip_but_pass_in_sandcastle_if TEST_WITH_DEV_DBG_ASAN test incompatible dev dbg asan test_launch_function nnodes = nproc_per_node = res = elastic_launch get_test_launch_config _etcd_endpoint nnodes nnodes nproc_per_node simple_rank_scale expected_res = actual_res = sorted value value res values assertEqual expected_res actual_res skip_but_pass_in_sandcastle_if TEST_WITH_DEV_DBG_ASAN test incompatible dev dbg asan test_launch_dist_sum_with_static_rdzv nnodes = nproc_per_node = sock = get_socket_with_port closing sock master_port = sock getsockname rdzv_endpoint = f master_port rank = rdzv_config = rank rank res = elastic_launch get_test_launch_config rdzv_endpoint nnodes nnodes nproc_per_node rdzv_backend= static config=rdzv_config _dist_sum expected_res = sum range nproc_per_node nproc_per_node actual_res = sorted value value res values assertEqual expected_res actual_res skip_but_pass_in_sandcastle_if TEST_WITH_DEV_DBG_ASAN test incompatible dev dbg asan test_launch_elastic nproc_per_node = elastic_launch get_test_launch_config _etcd_endpoint nproc_per_node sys executable -u path bin test_script py f -- touch-file-dir= test_dir world_size = nproc_per_node check_works_ran world_size mock patch torch distributed elastic events record test_launch_elastic_worker_raise_exception record_mock Asserts when worker program fails lancher raieses exception indicate worker process failed nproc_per_node = assertRaises ChildFailedError elastic_launch get_test_launch_config _etcd_endpoint nproc_per_node sys executable -u path bin test_script py -- fail record_mock assert_called_once mock patch torch distributed elastic events record mock patch torch distributed elastic agent server local_elastic_agent LocalElasticAgent run test_launch_elastic_agent_raise_exception record_mock mock_agent_run Asserts when agent raises exception launcher re-raises original exception mock_agent_run side_effect = MockException assertRaises MockException elastic_launch get_test_launch_config _etcd_endpoint sys executable -u path bin test_script py f -- touch-file-dir= test_dir record_mock assert_called_once skip_but_pass_in_sandcastle_if TEST_WITH_DEV_DBG_ASAN test incompatible dev dbg asan test_launch_elastic_multiple_agents min_nodes = max_nodes = nproc_per_node = nnodes = run_id = str uuid uuid int procs = ctx = mp get_context spawn _ range nnodes - p = ctx Process target=elastic_launch_wrapper args= test_dir _etcd_endpoint min_nodes max_nodes nproc_per_node run_id procs append p p start elastic_launch_wrapper test_dir _etcd_endpoint min_nodes max_nodes nproc_per_node run_id i range nnodes - p = procs i p join assertEqual p exitcode make sure all workers ran each worker touches file its global rank name world_size = nnodes nproc_per_node assertSetEqual str i i range world_size set os listdir test_dir patch torch distributed launcher api LocalElasticAgent test_launch_shutdown agent_mock_cls agent_mock = Mock agent_mock run return_value = RunResult WorkerState SUCCEEDED agent_mock_cls return_value = agent_mock rdzv_handler_mock = Mock patch torch distributed elastic rendezvous registry get_rendezvous_handler param_mock param_mock return_value = rdzv_handler_mock elastic_launch get_test_launch_config _etcd_endpoint sys executable -u path bin test_script py f -- touch-file-dir= test_dir rdzv_handler_mock shutdown assert_called_once test_get_entrypoint_name assertEqual simple_rank_scale _get_entrypoint_name simple_rank_scale assertEqual _get_entrypoint_name sys executable assertEqual _get_entrypoint_name sys executable -u assertEqual test_script py _get_entrypoint_name sys executable -u test_script py assertEqual _get_entrypoint_name None patch ELASTIC_AGENT_RUN patch GET_RDZV_HANDLER test_rdzv_handler_shutdown_on_agent_signal mock_get_rdzv mock_agent_run config = get_test_launch_config _etcd_endpoint min_nodes= max_nodes= nproc_per_node= sigval signal SIGTERM signal SIGINT patch EVENTS_RECORD record_event_mock rdzv_handler_mock = MagicMock rdzv_handler_mock get_run_id return_value = short_hash mock_get_rdzv return_value = rdzv_handler_mock mock_agent_run side_effect = SignalException test sigval assertRaises SignalException launch_agent config simple_rank_scale rdzv_handler_mock shutdown assert_not_called record_event_mock assert_called_once patch ELASTIC_AGENT_RUN patch GET_RDZV_HANDLER test_rdzv_handler_shutdown_on_agent_error mock_get_rdzv mock_agent_run config = get_test_launch_config _etcd_endpoint min_nodes= max_nodes= nproc_per_node= patch EVENTS_RECORD record_event_mock rdzv_handler_mock = MagicMock rdzv_handler_mock get_run_id return_value = short_hash mock_get_rdzv return_value = rdzv_handler_mock mock_agent_run side_effect = RuntimeError any other exception assertRaises RuntimeError launch_agent config simple_rank_scale rdzv_handler_mock shutdown assert_called_once record_event_mock assert_called_once __name__ == __main__ raise RuntimeError This test currently used should enabled discover_tests py required
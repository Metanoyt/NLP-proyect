Owner s oncall export torch torch _dispatch python enable_python_dispatcher torch _subclasses schema_check_mode SchemaCheckMode torch fx operator_schemas normalize_function torch testing _internal common_device_type instantiate_device_type_tests ops torch testing _internal common_methods_invocations op_db torch testing _internal common_utils TestCase torch utils _pytree tree_map Simplified naming C++ classes SchemaArgument = torch _C _SchemaArgument SchemaArgType = torch _C _SchemaArgType SchemaInfo = torch _C _SchemaInfo test_classes = PreDispatchSchemaCheckMode SchemaCheckMode Dispatch mode built top SchemaCheckMode checks incorrect op schemas PreDispatch IR This meant run ops eager mode concrete inputs see they incorrectly claim functional aliasing mutating If op claimed functional either detected error raised Errors will silenced schema admits aliasing mutation - op may later decompose become functional __init__ - None _dispatch_key = torch _C DispatchKey PreDispatch super __init__ _may_alias_or_mutate func types args kwargs unwrap e isinstance e torch Tensor type e torch Tensor try e elem except AttributeError e e get arguments outputs schema_info = SchemaInfo func _schema pre_arguments = normalize_function func args kwargs normalize_to_only_use_kwargs=True kwargs schema_info add_argument_values pre_arguments out = func args kwargs tuple_out = out isinstance out tuple out tuple_out = tree_map unwrap tuple_out check schema i range len func _schema arguments j range len tuple_out schema_info may_contain_alias SchemaArgument SchemaArgType output j SchemaArgument SchemaArgType input i True schema_info is_mutable SchemaArgument SchemaArgType input i True False creating just so we have access offending op __torch_dispatch__ func types args= kwargs=None try super __torch_dispatch__ func types args=args kwargs=kwargs except RuntimeError e check schema claims either aliasing mutating alias_or_mutate = _may_alias_or_mutate func types args kwargs alias_or_mutate schema aliasing mutating will decompose further msg = e args e args = f SchemaCheckMode failed following error op func meaning op contains aliasing mutations despite claiming functional \n\n + msg raise e TestOpInfo TestCase ops op_db allowed_dtypes= torch float torch int test_schema_check_op device dtype op sample_inputs_itr = op sample_inputs device dtype requires_grad=False inputs = next sample_inputs_itr args = inputs input + list inputs args kwargs = inputs kwargs enable_python_dispatcher PreDispatchSchemaCheckMode op op args kwargs instantiate_device_type_tests TestOpInfo globals __name__ == __main__ torch _dynamo test_case run_tests run_tests
mypy allow-untyped-defs Copyright c Facebook Inc its affiliates All rights reserved This source code licensed under BSD-style license found LICENSE file root directory source tree datetime random time base b decode b encode typing Optional pyre-ignore Could find name ` Store ` ` torch distributed ` torch distributed Store try etcd type ignore except ModuleNotFoundError _etcd_stub etcd Delay sleep small random amount reduce CAS failures This does affect correctness will reduce requests etcd server cas_delay time sleep random uniform pyre-fixme Annotation ` Store ` defined type EtcdStore Store Implement c Store interface piggybacking rendezvous etcd instance This store object returned ` ` EtcdRendezvous ` ` __init__ etcd_client etcd_store_prefix Default timeout same c d Store hpp timeout Optional datetime timedelta = None super __init__ required pybind trampoline client = etcd_client prefix = etcd_store_prefix timeout None set_timeout timeout prefix endswith prefix += set key value Write key value pair into ` ` EtcdStore ` ` Both key value may either Python ` ` str ` ` ` ` bytes ` ` client set key=self prefix + _encode key value=self _encode value get key - bytes Get value key possibly doing blocking wait If key immediately present will do blocking wait most ` ` timeout ` ` duration until key published Returns value ` ` bytes ` ` Raises LookupError - If key still published after timeout b _key = prefix + _encode key kvs = _try_wait_get b _key kvs None raise LookupError f Key key found EtcdStore _decode kvs b _key add key num int - int Atomically increment value integer amount The integer represented string using base If key present default value ` ` ` ` will assumed Returns new incremented value b _key = _encode key c d Store assumes value integer represented decimal string try Assume default value key didn t yet node = client write key=self prefix + b _key value=self _encode str num i e + num prevExist=False int _decode node value except etcd EtcdAlreadyExist pass while True Note c d Store does have method delete keys so we can sure s still there node = client get key=self prefix + b _key new_value = _encode str int _decode node value + num try node = client test_and_set key=node key value=new_value prev_value=node value int _decode node value except etcd EtcdCompareFailed cas_delay wait keys override_timeout Optional datetime timedelta = None Wait until all keys published until timeout Raises LookupError - timeout occurs b _keys = prefix + _encode key key keys kvs = _try_wait_get b _keys override_timeout kvs None raise LookupError Timeout while waiting keys EtcdStore No value success check keys - bool Check all keys immediately present without waiting b _keys = prefix + _encode key key keys kvs = _try_wait_get b _keys override_timeout=datetime timedelta microseconds= no wait kvs None Encode key value data base so we can store arbitrary binary data EtcdStore Input can ` str ` ` bytes ` In case ` str ` utf- encoding assumed _encode value - str type value bytes b encode value decode type value str b encode value encode decode raise ValueError Value must type str bytes Decode base string type ` str ` ` bytes ` Return type ` bytes ` which more convenient Store interface _decode value - bytes type value bytes b decode value type value str b decode value encode raise ValueError Value must type str bytes Get all base -encoded etcd keys once wait until all keys published timeout occurs This helper method public interface methods On success dictionary etcd key - etcd value returned On timeout None returned _try_wait_get b _keys override_timeout=None timeout = timeout override_timeout None override_timeout type ignore attr-defined deadline = time time + timeout total_seconds while True Read whole directory keys filter only ones waited all_nodes = None try all_nodes = client get key=self prefix req_nodes = node key node value node all_nodes children node key b _keys len req_nodes == len b _keys All keys available req_nodes except etcd EtcdKeyNotFound pass watch_timeout = deadline - time time watch_timeout = None try index = all_nodes etcd_index + all_nodes client watch key=self prefix recursive=True timeout=watch_timeout index=index except etcd EtcdWatchTimedOut time time = deadline None continue except etcd EtcdEventIndexCleared continue
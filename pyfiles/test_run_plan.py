tests test_run_test_plan py importlib contextlib nullcontext types SimpleNamespace unittest mock MagicMock pytest MOD = cli lib core vllm lib We inside tests so MOD override above applies everywhere run_test_plan_import_path = f MOD run_test_plan _get_cmd c Support both kwargs positional args c kwargs get cmd c args c args None _get_check c check c kwargs c kwargs check If positional assume second arg check when present default False c args len c args False pytest fixture patch_module monkeypatch Patch helpers pip_install_packages temp_environ working_directory run_command logger inside target module expose them module = importlib import_module MOD Create fakes mocks pip_install_packages = MagicMock name= pip_install_packages run_command = MagicMock name= run_command return_value= temp_environ working_directory record calls act context managers temp_calls list dict = workdir_calls list str = fake_working_directory path str workdir_calls append path nullcontext fake_temp_env map dict str str temp_calls append map nullcontext logger = SimpleNamespace info=MagicMock name= logger info error=MagicMock name= logger error Apply patches raise attribute doesn t exist monkeypatch setattr module pip_install_packages pip_install_packages raising=True monkeypatch setattr module run_command run_command raising=True monkeypatch setattr module working_directory fake_working_directory raising=True monkeypatch setattr module temp_environ fake_temp_env raising=True monkeypatch setattr module logger logger raising=True SimpleNamespace module=module run_test_plan=module run_test_plan expose avoid getattr constant Ruff B pip_install_packages=pip_install_packages run_command=run_command temp_calls=temp_calls workdir_calls=workdir_calls logger=logger test_success_runs_all_steps_and_uses_env_and_workdir monkeypatch patch_module run_test_plan = patch_module run_test_plan tests_map = basic title Basic suite package_install working_directory tests env_vars GLOBAL_FLAG steps export A=x pytest -q export B=y pytest -q tests unit One exit code per step export + two pytest patch_module run_command side_effect = run_test_plan basic cpu tests_map calls = patch_module run_command call_args_list cmds = _get_cmd c c calls checks = _get_check c c calls assert cmds == export A=x pytest -q export B=y pytest -q tests unit assert all chk False chk checks assert patch_module workdir_calls == tests assert patch_module temp_calls == GLOBAL_FLAG test_installs_packages_when_present monkeypatch patch_module run_test_plan = patch_module module run_test_plan tests_map = with_pkgs title Needs deps package_install timm== flash-attn steps pytest -q patch_module run_command return_value = run_test_plan with_pkgs gpu tests_map patch_module pip_install_packages assert_called_once_with packages= timm== flash-attn prefer_uv=True test_raises_on_missing_plan patch_module run_test_plan = patch_module module run_test_plan pytest raises RuntimeError ei run_test_plan nope cpu tests_map= assert test nope found str ei value test_aggregates_failures_and_raises monkeypatch patch_module run_test_plan = patch_module module run_test_plan tests_map = mix title Some pass some fail steps pytest test_a py → pass pytest test_b py → fail pytest test_c py → fail Simulate pass fail fail patch_module run_command side_effect = pytest raises RuntimeError ei run_test_plan mix cpu tests_map msg = str ei value assert pytest runs failed msg Ensure logger captured failed tests list patch_module logger error assert_called_once And we attempted all three commands assert patch_module run_command call_count == test_custom_working_directory_used patch_module run_test_plan = patch_module module run_test_plan tests_map = customwd title Custom wd working_directory examples ci steps pytest -q patch_module run_command return_value = run_test_plan customwd cpu tests_map assert patch_module workdir_calls == examples ci
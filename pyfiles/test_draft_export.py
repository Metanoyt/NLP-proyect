Owner s oncall export copy re tempfile unittest torch torch _subclasses fake_tensor FakeTensorMode torch export Dim draft_export export torch export _draft_export FailureType torch fx experimental symbolic_shapes ShapeEnv torch testing FileCheck torch testing _internal common_utils IS_WINDOWS run_tests TestCase torch testing _internal torchbind_impls _empty_tensor_queue init_torchbind_implementations torch utils _pytree tree_leaves TestDraftExport TestCase setUp super setUp init_torchbind_implementations torch_bind_ops = torch ops _TorchScriptTesting queue_pop torch ops _TorchScriptTesting queue_push torch ops _TorchScriptTesting queue_size tearDown test_missing_meta_kernel_custom_op_basic torch library _scoped_library mylib FRAGMENT torch library custom_op mylib foo mutates_args= foo _impl torch Tensor b torch Tensor - torch Tensor + b M torch nn Module forward b res = torch ops mylib foo b res inp = torch ones torch ones ep = draft_export M inp report = ep _report assertEqual len report failures assertEqual report failures failure_type FailureType MISSING_FAKE_KERNEL inp = torch randn torch randn assertEqual ep module inp M inp torch _library fake_profile unsafe_generate_fake_kernels report op_profiles ep run_decompositions test_missing_meta_kernel_impl torch library _scoped_library mylib FRAGMENT lib torch library define mylib foo Tensor Tensor b - Tensor tags=torch Tag pt _compliant_tag lib=lib torch library impl mylib foo cpu lib=lib foo_impl torch Tensor b torch Tensor - torch Tensor + b M torch nn Module forward b res = torch ops mylib foo b res = torch ops mylib foo res b res inp = torch ones torch ones ep = draft_export M inp report = ep _report assertEqual len report failures assertEqual report failures failure_type FailureType MISSING_FAKE_KERNEL inp = torch randn torch randn assertEqual ep module inp M inp assertEqual len report op_profiles assertEqual len report op_profiles mylib foo default print report op_profiles torch _library fake_profile unsafe_generate_fake_kernels report op_profiles ep = ep run_decompositions assertEqual ep module inp M inp test_missing_meta_kernel_custom_op_multiple_profiles torch library _scoped_library mylib FRAGMENT torch library custom_op mylib foo mutates_args= foo _impl torch Tensor b torch Tensor - torch Tensor + b M torch nn Module forward b c d res = torch ops mylib foo b res = torch ops mylib foo c d res res inp = torch ones torch ones torch ones torch ones ep = draft_export M inp report = ep _report assertEqual len report failures assertEqual report failures failure_type FailureType MISSING_FAKE_KERNEL assertEqual len report op_profiles assertEqual len report op_profiles mylib foo default torch _library fake_profile unsafe_generate_fake_kernels report op_profiles ep run_decompositions test_missing_meta_kernel_custom_op_update_profile torch library _scoped_library mylib FRAGMENT torch library custom_op mylib foo mutates_args= foo _impl torch Tensor b torch Tensor - torch Tensor + b M torch nn Module forward b res = torch ops mylib foo b res inp = torch ones torch ones ep = draft_export M inp report = ep _report assertEqual len report op_profiles assertEqual len report op_profiles mylib foo default new_inp = torch ones torch ones torch _library fake_profile unsafe_generate_fake_kernels report op_profiles FakeTensorMode allow_non_fake_inputs=True shape_env=ShapeEnv torch ops mylib foo inp assertRaisesRegex RuntimeError no profiles match given inputs torch ops mylib foo new_inp ep = draft_export M new_inp report = ep _report assertEqual len report op_profiles assertEqual len report op_profiles mylib foo default torch _library fake_profile unsafe_generate_fake_kernels report op_profiles FakeTensorMode allow_non_fake_inputs=True shape_env=ShapeEnv torch ops mylib foo new_inp Existing registration has been updated match new profile traced draft-export assertRaisesRegex RuntimeError no profiles match given inputs torch ops mylib foo inp unittest skipIf torch cuda is_available Requires cuda test_missing_meta_kernel_guard torch library _scoped_library mylib FRAGMENT torch library custom_op mylib foo mutates_args= foo _impl torch Tensor b torch Tensor - torch Tensor + b M torch nn Module forward b res = torch ops mylib foo b res inp = torch ones torch ones ep = draft_export M inp dynamic_shapes= Dim DYNAMIC Dim DYNAMIC b Dim DYNAMIC Dim DYNAMIC inp = torch randn torch randn assertEqual ep module inp M inp m = ep module assertRaisesRegex RuntimeError Tensor device mismatch bad_device_inps = torch randn device=torch device cuda torch randn device=torch device cuda m bad_device_inps assertRaisesRegex RuntimeError Tensor dtype mismatch bad_dtype_inps = torch randn dtype=torch float torch randn dtype=torch float m bad_dtype_inps test_fake_infer_dense_in_memory_check torch library _scoped_library mylib FRAGMENT torch library custom_op mylib foo mutates_args= foo _impl torch Tensor - torch Tensor torch library custom_op mylib foo mutates_args= foo _impl torch Tensor - torch Tensor - - dense memory torch library custom_op mylib foo mutates_args= foo _impl torch Tensor - torch Tensor - non-zero storage offset Foo torch nn Module forward x opt opt == torch ops mylib foo x opt == torch ops mylib foo x torch ops mylib foo x draft_export Foo torch randn draft_export Foo torch randn draft_export Foo torch randn assertRaisesRegex RuntimeError dense memory draft_export Foo torch randn assertRaisesRegex RuntimeError has non-zero storage offset draft_export Foo torch randn test_data_dependent_failure torch library _scoped_library mylib FRAGMENT lib torch library define mylib foo Tensor Tensor b - Tensor tags=torch Tag pt _compliant_tag lib=lib torch library impl mylib foo cpu lib=lib foo_impl b + b M torch nn Module forward b c res = torch ops mylib foo b c_item = c item c_item res c_item inp = torch ones torch ones torch tensor ep = draft_export M inp report = ep _report assertTrue len report failures assertEqual report failures failure_type FailureType MISSING_FAKE_KERNEL assertEqual report failures failure_type FailureType DATA_DEPENDENT_ERROR inp = torch randn torch randn torch tensor assertEqual ep module inp M inp test_unbacked_div_mod_replacement M torch nn Module forward x x = torch zeros x item x = x unsqueeze repeat x view - ep = draft_export M torch tensor report = ep _report assertEqual len report failures test_dedup_data_dependent_failure M torch nn Module forward x y z res = v x y b = v item b res += v b res += v + b z res inp = torch tensor torch tensor torch tensor ep = draft_export M inp report = ep _report assertEqual len report failures assertEqual report failures failure_type FailureType DATA_DEPENDENT_ERROR inp = torch tensor torch tensor torch tensor assertEqual ep module inp M inp fake tensors node meta val should have real_tensor gm = ep module tensors = node meta get val real_tensor node gm graph nodes node op == placeholder assertTrue all isinstance t torch Tensor t tensors test_complex_data_dependent_expr M torch nn Module forward x y = x item = -a = = + z = torch cat y y z ep = draft_export M torch tensor torch randn dynamic_shapes= x None y Dim DYNAMIC report = ep _report assertTrue len report failures assertEqual report failures failure_type FailureType DATA_DEPENDENT_ERROR _ep ep ep run_decompositions unbacked bindings unbacked_binding_symbols = set node _ep graph nodes bindings = node meta get unbacked_bindings unbacked_binding_symbols update bindings keys assertEqual len unbacked_binding_symbols test_offsets M torch nn Module forward x = x item == raise RuntimeError bad x inp = torch tensor draft_export M inp test_shape_failure M torch nn Module forward assert shape == inp = torch ones ep = draft_export M inp dynamic_shapes= Dim prefer_deferred_runtime_asserts_over_guards=True report = ep _report assertEqual len report failures assertEqual report failures failure_type FailureType GUARD_ADDED inp = torch randn assertEqual ep module inp M inp inp = torch randn assertRaisesRegex AssertionError re escape Guard failed size = expected = got ep module inp test_side_effect M torch nn Module __init__ super __init__ register_buffer torch tensor forward b a_item = item a_item == res = a_item b res = a_item + b add_ a_item = item a_item == res = a_item res res = a_item + res res inp = torch ones mod = M ep = draft_export mod inp assertEqual mod torch tensor FileCheck check_count torch ops aten add default exactly=True run ep graph_module code test_side_effect_inps M torch nn Module __init__ super __init__ forward x x sin_ x inp = torch ones ep = draft_export M inp report = ep _report assertTrue report successful assertEqual inp torch ones test_masked_linear M torch nn Module forward x mask weight bias masked = x mask = torch nn functional linear masked weight bias x = torch zeros x += inp = torch randn x torch randn torch randn draft_ep = draft_export M inp ep = export M inp assertEqual draft_ep module inp ep module inp x += x += assertEqual draft_ep module inp ep module inp test_torchbind Model torch nn Module __init__ - None super __init__ linear = torch nn Linear forward tq x x_cos = tq pop + tq float_size + linear x tq is_empty x_sin = linear tq pop - tq size + x x_sin = tq pop + tq size + x x_sin x_cos tq mod = Model tq = _empty_tensor_queue tq = copy deepcopy tq = torch randn b = torch randn tq push tq push b tq = copy deepcopy tq inp = tq torch randn ep = draft_export mod inp report = ep _report assertTrue report successful assertEqual tq size assertEqual tq size assertEqual tq size test_override_size_and_dtype_mismatched_fake_kernels torch library _scoped_library mylib FRAGMENT M torch nn Module forward torch ops mylib foo torch library custom_op mylib foo mutates_args= foo torch Tensor - list torch Tensor x = y = repeat z = torch bfloat x y z torch library register_fake mylib foo foo_fake_impl x = torch empty_like good y = torch empty_like size mismatch z = torch empty_like dtype mismatch x y z mod = M inputs = torch randn assertRaises RuntimeError torch _functorch config patch fake_tensor_propagate_real_tensors=True export mod inputs strict=True ep = draft_export mod inputs report = ep _report ep_out eager_out zip ep module inputs mod inputs assertTrue torch allclose ep_out eager_out assertEqual ep_out dtype eager_out dtype assertEqual len report failures assertEqual report failures failure_type FailureType MISMATCHED_FAKE_KERNEL assertEqual report failures failure_type FailureType MISMATCHED_FAKE_KERNEL assertEqual sorted f data reason f report failures Dtypes torch bfloat torch float equal mismatch between fake value real value torch _library fake_profile unsafe_generate_fake_kernels report op_profiles ep run_decompositions test_override_incorrectly_aliasing_kernel torch library _scoped_library mylib FRAGMENT torch library custom_op mylib foo mutates_args= foo torch Tensor - tuple torch Tensor torch Tensor + torch library register_fake mylib foo foo_fake_impl torch empty_like incorrectly aliasing M torch nn Module forward torch ops mylib foo mod = M inputs = torch randn assertRaisesRegex RuntimeError Real tensor propagation found aliasing mismatch torch _functorch config patch fake_tensor_propagate_real_tensors=True export mod inputs strict=True ep = draft_export mod inputs report = ep _report ep_out eager_out zip tree_leaves ep module inputs tree_leaves mod inputs assertTrue torch allclose ep_out eager_out assertEqual ep_out dtype eager_out dtype assertEqual len report failures assertEqual report failures failure_type FailureType MISMATCHED_FAKE_KERNEL assertTrue Mismatched aliasing spec between fake kernel real kernel report failures data reason test_override_mismatched_fake_kernel_with_unbacked_symbols torch library _scoped_library mylib FRAGMENT torch library custom_op mylib foo mutates_args= foo torch Tensor b torch Tensor - torch Tensor b item torch bfloat torch library register_fake mylib foo foo_fake_impl b ctx = torch library get_ctx u = ctx new_dynamic_size torch empty u shape dtype=a dtype M torch nn Module forward b torch ops mylib foo b mod = M inputs = torch randn torch tensor ep = draft_export mod inputs report = ep _report ep_out eager_out zip ep module inputs mod inputs assertTrue torch allclose ep_out eager_out assertEqual ep_out dtype eager_out dtype assertEqual len report failures assertEqual report failures failure_type FailureType MISMATCHED_FAKE_KERNEL assertEqual report failures data reason Dtypes torch bfloat torch float equal torch _library fake_profile unsafe_generate_fake_kernels report op_profiles ep run_decompositions https github com pytorch pytorch issues unittest skipIf IS_WINDOWS aoti_compile_and_package supported Windows test_constantify_unbacked_symbol M torch nn Module forward x y xt = torch tensor x shape u = xt item y torch arange u mod = M example_inputs = torch randn torch randn draft_ep = draft_export mod example_inputs tempfile NamedTemporaryFile suffix= pt f torch _inductor aoti_compile_and_package draft_ep package_path=f name unittest skipIf torch cuda is_available torch cuda get_device_properties total_memory Requires MB GPU memory pass test setting higher catch violations test_cuda_memory_usage This used OOM Foo torch nn Module forward x _ range x = x + e- x measure base usage device = torch device cuda torch cuda reset_peak_memory_stats base_usage = torch cuda memory_allocated device usage input tensor allocated x = torch randn device x_usage = torch cuda memory_allocated device draft export peak memory usage draft_export Foo x strict=False peak_mem_usage = torch cuda memory_stats device allocated_bytes all peak right now s actually exactly x I guess original tensor tensors per add op clone stored node meta val assertTrue peak_mem_usage - base_usage = x_usage - base_usage __name__ == __main__ run_tests
Owner s oncall distributed checkpointing os shutil tempfile typing Any Optional unittest mock MagicMock torch torch distributed checkpoint _experimental checkpoint_writer CheckpointWriter CheckpointWriterConfig WriterHook torch distributed checkpoint _experimental types RankInfo torch testing _internal common_utils run_tests TestCase MockWriterHook WriterHook Mock implementation WriterHook testing __init__ pre_commit_called = False commit_called = False pre_commit_path Optional str = None commit_path Optional str = None pre_commit_kwargs Optional dict str Any = None commit_kwargs Optional dict str Any = None pre_commit path str kwargs Any pre_commit_called = True pre_commit_path = path pre_commit_kwargs = kwargs post_commit path str kwargs Any commit_called = True commit_path = path commit_kwargs = kwargs TestCheckpointWriterConfig TestCase test_default_values Test CheckpointWriterConfig has correct default values options = CheckpointWriterConfig assertEqual options write_barrier_timeout_secs test_custom_values Test CheckpointWriterConfig can initialized custom values options = CheckpointWriterConfig write_barrier_timeout_secs= assertEqual options write_barrier_timeout_secs TestCheckpointWriter TestCase setUp Create temporary directory test checkpoints temp_dir = tempfile mkdtemp Create test objects rank_info = RankInfo global_rank= global_world_size= options = CheckpointWriterConfig mock_barrier = MagicMock mock_hook = MockWriterHook Create checkpoint writer writer = CheckpointWriter config=self options rank_info=self rank_info barrier=self mock_barrier commit_hook=self mock_hook Create test state dictionary state_dict = model torch nn Linear state_dict optimizer param_groups lr epoch step tearDown Clean up temporary directory shutil rmtree temp_dir test_write_creates_checkpoint_file Test write creates checkpoint file correct content Set up checkpoint path checkpoint_path = os path join temp_dir checkpoint Call write writer write checkpoint_path state_dict Verify checkpoint file exists expected_file_path = os path join checkpoint_path f checkpoint_ rank_info global_rank pt assertTrue os path exists expected_file_path Load checkpoint verify its contents loaded_state_dict = torch load expected_file_path assertIn model loaded_state_dict assertIn optimizer loaded_state_dict assertEqual loaded_state_dict epoch assertEqual loaded_state_dict step test_write_calls_barrier Test write calls barrier correct parameters Set up checkpoint path checkpoint_path = os path join temp_dir checkpoint Call write writer write checkpoint_path state_dict Verify barrier called mock_barrier execute_barrier assert_called_once test_write_calls_commit_hooks Test write calls commit hooks correct parameters Set up checkpoint path checkpoint_path = os path join temp_dir checkpoint Call write additional kwargs kwargs = extra value writer write checkpoint_path state_dict kwargs Verify pre_commit hook called correct parameters assertTrue mock_hook pre_commit_called assertEqual mock_hook pre_commit_path checkpoint_path assertEqual mock_hook pre_commit_kwargs None mock_hook pre_commit_kwargs extra value Verify commit hook called correct parameters assertTrue mock_hook commit_called assertEqual mock_hook commit_path checkpoint_path assertEqual mock_hook commit_kwargs None mock_hook commit_kwargs extra value test_write_without_barrier Test write works correctly without barrier Create writer without barrier writer = CheckpointWriter config=self options rank_info=self rank_info barrier=None commit_hook=self mock_hook Set up checkpoint path checkpoint_path = os path join temp_dir checkpoint_no_barrier Call write writer write checkpoint_path state_dict Verify checkpoint file exists expected_file_path = os path join checkpoint_path f checkpoint_ rank_info global_rank pt assertTrue os path exists expected_file_path test_write_without_commit_hook Test write works correctly without commit hook Create writer without commit hook writer = CheckpointWriter config=self options rank_info=self rank_info barrier=self mock_barrier commit_hook=None Set up checkpoint path checkpoint_path = os path join temp_dir checkpoint_no_hook Call write writer write checkpoint_path state_dict Verify checkpoint file exists expected_file_path = os path join checkpoint_path f checkpoint_ rank_info global_rank pt assertTrue os path exists expected_file_path Verify barrier still called mock_barrier execute_barrier assert_called_once test_close Test close doesn t raise any exceptions This no-op base so just verify doesn t raise writer close __name__ == __main__ run_tests
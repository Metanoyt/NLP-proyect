mypy ignore-errors collections namedtuple torch torch utils _pytree pytree torch utils _python_dispatch return_and_correct_aliasing FancyNamedTuple = namedtuple FancyNamedTuple foo bar A simple tensor subclass holds tensor custom metadata custom method ConstantExtraMetadataTensor torch Tensor staticmethod __new__ cls elem shape = elem shape kwargs = kwargs strides = elem stride kwargs storage_offset = elem storage_offset kwargs device = elem device kwargs layout = elem layout kwargs requires_grad = elem requires_grad kwargs dtype = elem dtype torch Tensor _make_wrapper_subclass cls shape kwargs __init__ elem elem = elem constant_attribute = __repr__ inner_repr = repr elem f CustomTensor inner_repr get_complicated_metadata FancyNamedTuple constant_attribute constant_attribute __tensor_flatten__ elem constant_attribute add_constant constant_attribute += staticmethod __tensor_unflatten__ inner_tensors meta outer_size outer_stride assert meta None elem = inner_tensors elem out = ConstantExtraMetadataTensor elem out constant_attribute = meta out classmethod __torch_dispatch__ cls func types args kwargs kwargs None kwargs = args_inner = pytree tree_map_only ConstantExtraMetadataTensor lambda x x elem args kwargs_inner = pytree tree_map_only ConstantExtraMetadataTensor lambda x x elem kwargs out_inner = func args_inner kwargs_inner out_inner_flat spec = pytree tree_flatten out_inner aten ops non-tensors just assume our cust inner tensors same value out_flat = ConstantExtraMetadataTensor o_inner isinstance o_inner torch Tensor o_inner o_inner out_inner_flat out = pytree tree_unflatten out_flat spec return_and_correct_aliasing func args kwargs out A simple tensor subclass always returns plain tensor during __torch_dispatch__ It similar TwoTensor used simulate torchao quantized tensors CustomTensorPlainOut torch Tensor staticmethod __new__ cls elem elem shape = elem shape kwargs = kwargs strides = elem stride kwargs storage_offset = elem storage_offset kwargs device = elem device kwargs layout = elem layout kwargs requires_grad = elem requires_grad kwargs dtype = elem dtype torch Tensor _make_wrapper_subclass cls shape kwargs __init__ elem elem elem = elem elem = elem get_elem elem __repr__ inner_repr_ = repr elem inner_repr_ = repr elem f CustomTensorPlainOut inner_repr_ inner_repr_ __tensor_flatten__ elem elem None staticmethod __tensor_unflatten__ inner_tensors meta outer_size outer_stride elem = inner_tensors elem elem = inner_tensors elem out = CustomTensorPlainOut elem elem out classmethod __torch_dispatch__ cls func types args kwargs Don t use tensor view ops kwargs None kwargs = args_inner_ = pytree tree_map_only CustomTensorPlainOut lambda x x elem args kwargs_inner_ = pytree tree_map_only CustomTensorPlainOut lambda x x elem kwargs args_inner_ = pytree tree_map_only CustomTensorPlainOut lambda x x elem args kwargs_inner_ = pytree tree_map_only CustomTensorPlainOut lambda x x elem kwargs out_inner_ = func args_inner_ kwargs_inner_ out_inner_ = func args_inner_ kwargs_inner_ out_inner_flat_ spec = pytree tree_flatten out_inner_ out_inner_flat_ spec = pytree tree_flatten out_inner_ func is_view new_out = pytree tree_unflatten CustomTensorPlainOut tensor tensor tensor tensor zip out_inner_flat_ out_inner_flat_ strict=True spec return_and_correct_aliasing func args kwargs new_out out_new = out_inner_flat_ ix + out_inner_flat_ ix ix range len out_inner_flat_ pytree tree_unflatten out_new spec
Owner s oncall distributed copy torch torch distributed _shard sharded_tensor sharded_tensor torch distributed _shard sharding_spec ChunkShardingSpec torch testing _internal common_distributed requires_nccl skip_if_lt_x_gpu torch testing _internal common_utils run_tests torch testing _internal distributed _shard sharded_tensor ShardedTensorTestBase TEST_GPU_NUM with_comms TestTensorOps ShardedTensorTestBase with_comms init_rpc=False skip_if_lt_x_gpu TEST_GPU_NUM requires_nccl test_deep_copy spec = ChunkShardingSpec dim= placements= rank cuda rank cuda rank cuda rank cuda st = sharded_tensor rand spec copied_st = copy deepcopy st assertTrue type copied_st type st assertEqual copied_st local_tensor st local_tensor assertFalse copied_st st with_comms init_rpc=False skip_if_lt_x_gpu TEST_GPU_NUM requires_nccl test_inplace_copy spec = ChunkShardingSpec dim= placements= rank cuda rank cuda rank cuda rank cuda st = sharded_tensor rand spec ones_st = sharded_tensor ones spec assertFalse torch equal ones_st st st copy_ ones_st assertTrue torch equal st ones_st no grad inplace_copy should work between two different requires_grad st_with_grad = sharded_tensor rand spec requires_grad=True assertTrue st_with_grad requires_grad assertFalse ones_st requires_grad torch no_grad st_with_grad copy_ ones_st assertEqual st_with_grad local_tensor ones_st local_tensor with_comms init_rpc=False skip_if_lt_x_gpu TEST_GPU_NUM requires_nccl test_clone spec = ChunkShardingSpec dim= placements= rank cuda rank cuda rank cuda rank cuda st = sharded_tensor rand spec copied_st = st clone assertTrue type copied_st type st assertEqual copied_st local_tensor st local_tensor assertFalse copied_st st with_comms init_rpc=False skip_if_lt_x_gpu TEST_GPU_NUM requires_nccl test_detach spec = ChunkShardingSpec dim= placements= rank cuda rank cuda rank cuda rank cuda st = sharded_tensor rand spec requires_grad=True local_shards = st local_shards before set requires_grad all local shards should require grads local_shard local_shards assertTrue local_shard tensor requires_grad detached_st = st detach assertFalse detached_st requires_grad local_shard detached_st local_shards assertFalse local_shard tensor requires_grad with_comms init_rpc=False skip_if_lt_x_gpu TEST_GPU_NUM requires_nccl test_set_requires_grad spec = ChunkShardingSpec dim= placements= rank cuda rank cuda rank cuda rank cuda st = sharded_tensor rand spec local_shards = st local_shards before set requires_grad all local shards should require grads local_shard local_shards assertFalse local_shard tensor requires_grad st requires_grad_ assertTrue st requires_grad local_shard local_shards assertTrue local_shard tensor requires_grad __name__ == __main__ run_tests
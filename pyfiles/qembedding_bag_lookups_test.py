typing Optional numpy np operator_benchmark op_bench torch torch testing _internal common_quantization lengths_to_offsets torch ops load_library caffe torch fb sparsenn sparsenn_operators embedding_bag_rowwise_offsets_short_configs = op_bench cross_product_configs num_embeddings= embedding_dim= num_offsets=range enable_per_sample_weights= True False include_last_offset= True False is_pruned_weights= True False use_ bit_indices= True False use_ bit_offsets= True False tags= short embedding_bag_rowwise_offsets_long_configs = op_bench cross_product_configs num_embeddings= _ _ embedding_dim= num_offsets=range enable_per_sample_weights= True False include_last_offset= True False is_pruned_weights= True False use_ bit_indices= True False use_ bit_offsets= True False tags= long full_configs = embedding_bag_rowwise_offsets_short_configs + embedding_bag_rowwise_offsets_long_configs four_bit_rowwise_ops = op_bench op_list attrs= qembeddingbag_ bit_rowwise_offsets torch ops quantized embedding_bag_ bit_rowwise_offsets attr_names= op_name op_func byte_rowwise_ops = op_bench op_list attrs= qembeddingbag_byte_rowwise_offsets torch ops quantized embedding_bag_byte_rowwise_offsets attr_names= op_name op_func get_pruned_weights_and_mapping q_weights indicator = torch from_numpy np random uniform low=- high= size= q_weights shape astype np float q_pruned_weights compressed_indices_mapping = torch ops fb embedding_bag_rowwise_prune q_weights indicator torch int q_pruned_weights compressed_indices_mapping EmbedddingBag BitRowwiseOffsetsTest op_bench TorchBenchmarkBase init num_embeddings int embedding_dim int num_offsets int enable_per_sample_weights bool include_last_offset bool is_pruned_weights bool use_ bit_indices bool use_ bit_offsets bool op_func num_embeddings = num_embeddings embedding_dim = embedding_dim num_offsets = num_offsets enable_per_sample_weights = enable_per_sample_weights include_last_offset = include_last_offset max_segment_length = num_lengths = np random randint num_offsets + lengths = np random randint max_segment_length + size=self num_lengths astype np int num_indices = np sum lengths is_pruned_weights = is_pruned_weights use_ bit_indices = use_ bit_indices use_ bit_offsets = use_ bit_offsets offsets = lengths_to_offsets lengths indices = torch from_numpy np random randint low= high=num_embeddings size=self num_indices dtype=np int indices = indices int use_ bit_indices indices offsets = offsets int use_ bit_offsets offsets include_last_offset offsets = torch cat offsets torch tensor indices size dtype=torch long weights = torch from_numpy np random random_sample num_embeddings embedding_dim + astype np float indices = torch from_numpy np random randint low= high=self num_embeddings size=self num_indices dtype=np int prepack_func = torch ops quantized embedding_bag_ bit_prepack prepacked_weights = prepack_func weights per_sample_weights = torch from_numpy np random uniform low= high= size= len indices astype np float enable_per_sample_weights None compressed_indices = None is_pruned_weights prepacked_weights compressed_indices = get_pruned_weights_and_mapping prepacked_weights inputs = prepacked_weights prepacked_weights indices indices offsets offsets mode per_sample_weights per_sample_weights include_last_offset include_last_offset is_pruned_weights is_pruned_weights compressed_indices compressed_indices op_func = op_func forward prepacked_weights indices offsets mode int per_sample_weights Optional torch Tensor include_last_offset bool is_pruned_weights bool compressed_indices Optional torch Tensor op_func prepacked_weights indices offsets mode=mode per_sample_weights=per_sample_weights include_last_offset=include_last_offset pruned_weights=is_pruned_weights compressed_indices_mapping=compressed_indices EmbedddingBagByteRowwiseOffsetsTest op_bench TorchBenchmarkBase init num_embeddings int embedding_dim int num_offsets int enable_per_sample_weights bool include_last_offset bool is_pruned_weights bool use_ bit_indices bool use_ bit_offsets bool op_func num_embeddings = num_embeddings embedding_dim = embedding_dim num_offsets = num_offsets enable_per_sample_weights = enable_per_sample_weights include_last_offset = include_last_offset max_segment_length = num_lengths = np random randint num_offsets + lengths = np random randint max_segment_length + size=self num_lengths astype np int is_pruned_weights = is_pruned_weights use_ bit_indices = use_ bit_indices use_ bit_offsets = use_ bit_offsets num_indices = np sum lengths offsets = lengths_to_offsets lengths indices = torch from_numpy np random randint low= high=num_embeddings size=self num_indices dtype=np int indices = indices int use_ bit_indices indices offsets = offsets int use_ bit_offsets offsets include_last_offset offsets = torch cat offsets torch tensor indices size dtype=torch long weights = torch from_numpy np random random_sample num_embeddings embedding_dim + astype np float indices = torch from_numpy np random randint low= high=self num_embeddings size=self num_indices dtype=np int prepack_func = torch ops quantized embedding_bag_byte_prepack prepacked_weights = prepack_func weights per_sample_weights = torch from_numpy np random uniform low= high= size= len indices astype np float enable_per_sample_weights None compressed_indices = None is_pruned_weights prepacked_weights compressed_indices = get_pruned_weights_and_mapping prepacked_weights inputs = prepacked_weights prepacked_weights indices indices offsets offsets mode per_sample_weights per_sample_weights include_last_offset include_last_offset is_pruned_weights is_pruned_weights compressed_indices compressed_indices op_func = op_func forward prepacked_weights indices offsets mode int per_sample_weights Optional torch Tensor include_last_offset bool is_pruned_weights bool compressed_indices Optional torch Tensor op_func prepacked_weights indices offsets mode= per_sample_weights=per_sample_weights include_last_offset=self include_last_offset pruned_weights=self is_pruned_weights compressed_indices_mapping=self compressed_indices op_bench generate_pt_tests_from_op_list four_bit_rowwise_ops full_configs EmbedddingBag BitRowwiseOffsetsTest op_bench generate_pt_tests_from_op_list byte_rowwise_ops full_configs EmbedddingBagByteRowwiseOffsetsTest __name__ == __main__ op_bench benchmark_runner main
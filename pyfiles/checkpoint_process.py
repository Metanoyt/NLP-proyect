logging os traceback collections abc Callable concurrent futures Future ThreadPoolExecutor dataclasses dataclass enum Enum multiprocessing connection Connection typing Any Optional Union torch multiprocessing mp torch multiprocessing spawn ProcessExitedException checkpoint_writer CheckpointWriter types RankInfo STATE_DICT logger = logging getLogger __name__ dataclass CheckpointProcessConfig Configuration options CheckpointProcess This provides configuration options checkpoint process including initialization functions timeouts writer configuration Attributes subprocess_init_timeout_secs Maximum time seconds wait subprocess initialization subprocess_shutdown_timeout_secs Maximum time seconds wait subprocess shutdown subprocess_init_timeout_secs int = subprocess_shutdown_timeout_secs int = RequestType Enum PING = ping WRITE_CHECKPOINT = write_checkpoint TERMINATE_PROCESS = exit dataclass WorkerRequest A dataclass storing command sent worker process Note This relies pickling send command worker process Handle backward compatibility accordingly request_type RequestType payload dict str Any dataclass WorkerResponse request_type RequestType success bool error_msg Optional str = None payload Optional dict str Any = None CheckpointProcess A checkpoint writer writes checkpoints remote process __init__ rank_info RankInfo config CheckpointProcessConfig subprocess_init_fn Callable Any None subprocess_init_args tuple Any checkpoint_writer_init_fn Callable CheckpointWriter checkpoint_writer_init_args dict str Any _executor = ThreadPoolExecutor max_workers= _rank_info = rank_info _config = config _subprocess_init_fn = subprocess_init_fn _subprocess_init_args = subprocess_init_args _checkpoint_writer_init_fn = checkpoint_writer_init_fn _checkpoint_writer_init_args = checkpoint_writer_init_args process = None _parent_end Optional Connection = None _child_end Optional Connection = None process_creation_future = _executor submit _create_subprocess config _create_subprocess config CheckpointProcessConfig - None logger info Creating checkpoint subprocess rank d _rank_info global_rank spawn_context = mp get_context spawn _parent_end child_end = spawn_context Pipe Known workaround https github com pytorch pytorch issues os environ MKL_SERVICE_FORCE_INTEL = GNU logger debug Spawning subprocess rank_info= s _rank_info process = mp spawn fn=CheckpointProcess _subprocess args= _rank_info child_end _subprocess_init_fn _subprocess_init_args _checkpoint_writer_init_fn _checkpoint_writer_init_args nprocs= join=False daemon=True close child end pipe so recv will fail fast when child process terminated unexpectedly child_end close _send request_type=RequestType PING payload= logger debug Waiting checkpoint subprocess initialize timeout ds config subprocess_init_timeout_secs wait timeout response subprocess _parent_end None raise AssertionError Parent end pipe should initialized _parent_end poll timeout=config subprocess_init_timeout_secs msg = f Timed out after config subprocess_init_timeout_secs s waiting checkpoint subprocess initialize logger error msg raise TimeoutError msg _recv logger info Checkpoint subprocess initialized successfully staticmethod _subprocess sub_rank int rank_info RankInfo parent_pipe Connection subprocess_init_fn Callable Any None subprocess_init_args tuple Any checkpoint_writer_init_fn Callable CheckpointWriter checkpoint_writer_init_args dict str Any - None logger debug Checkpoint subprocess started rank d d PID d rank_info global_rank rank_info global_world_size os getpid sub_rank = raise AssertionError We need only one checkpointer per parent training request = WorkerRequest request_type=RequestType PING payload= try Calling initialize callback so we can perform app-specific initialization subprocess subprocess_init_fn subprocess_init_args Initialize checkpoint writer - automatically include rank_info init_args writer_init_args = dict checkpoint_writer_init_args rank_info writer_init_args writer_init_args rank_info = rank_info checkpoint_writer = checkpoint_writer_init_fn writer_init_args while True request = parent_pipe recv request request_type == RequestType PING parent_pipe send WorkerResponse request_type=RequestType PING success=True request request_type == RequestType WRITE_CHECKPOINT path = request payload path logger info Writing checkpoint s path checkpoint_writer write path=path state_dict=request payload state_dict request payload kwargs logger info Checkpoint written successfully s path parent_pipe send WorkerResponse RequestType WRITE_CHECKPOINT success=True request request_type == RequestType TERMINATE_PROCESS logger debug Received termination request parent_pipe send WorkerResponse RequestType TERMINATE_PROCESS success=True logger info Subprocess terminated gracefully break error_msg = f Unknown request type request request_type logger error error_msg raise ValueError error_msg except Exception e error_text = traceback format_exc logger error Exception subprocess s s type e __name__ error_text Communicating exception via queue main process parent_pipe send WorkerResponse request_type=request request_type success=False error_msg=error_text parent_pipe close logger exception Subprocess terminated due exception _send request_type RequestType payload dict str Any - None try _parent_end None raise AssertionError Parent end pipe should initialized _parent_end send WorkerRequest request_type=request_type payload=payload except OSError e error_msg = Child process terminated unexpectedly logger exception Communication failed during s request request_type value raise RuntimeError error_msg e _recv - Optional dict str Any try _parent_end None raise AssertionError Parent end pipe should initialized response = _parent_end recv response success False error_msg = f Unexpected response worker process response error_msg logger error error_msg raise RuntimeError error_msg response payload except EOFError BrokenPipeError ConnectionResetError e error_msg = f Child process terminated unexpectedly e logger error error_msg raise RuntimeError error_msg e write state_dict Union STATE_DICT Future STATE_DICT path str kwargs Any - Optional Future None logger debug Waiting subprocess initialization complete wait until process started process_creation_future result _executor submit _write state_dict path kwargs _write state_dict Union STATE_DICT Future STATE_DICT path str kwargs Any - None logger debug Starting checkpoint write s path wait staging state_dict available isinstance state_dict Future logger debug Waiting state_dict Future resolve sd = state_dict result sd = state_dict Log state_dict info only debug logging enabled performance-conscious logger isEnabledFor logging DEBUG hasattr sd keys logger debug State_dict contains d keys len sd keys _send request_type=RequestType WRITE_CHECKPOINT payload= state_dict sd path path kwargs kwargs logger debug Waiting write completion response wait response _recv logger debug Checkpoint write s completed successfully path close - None logger debug Closing CheckpointProcess rank d _rank_info global_rank _executor shutdown wait=True cancel_futures=True process process processes is_alive subprocess_pid = process processes pid send graceful termination sub process try pyrefly ignore missing-attribute _parent_end send WorkerRequest request_type=RequestType TERMINATE_PROCESS payload= except BrokenPipeError logger warning BrokenPipeError when sending termination request - subprocess PID d may have already terminated subprocess_pid subprocess terminated unexpectedly below code will raise ProcessExitedException logger debug Waiting subprocess terminate gracefully timeout ds _config subprocess_shutdown_timeout_secs try process join timeout=self _config subprocess_shutdown_timeout_secs graceful shutdown failed kill process logger warning Subprocess PID d did terminate gracefully within ds killing subprocess_pid _config subprocess_shutdown_timeout_secs process processes kill logger info Subprocess killed forcefully except ProcessExitedException logger exception ProcessExitedException during subprocess termination raise logger debug CheckpointProcess closed successfully
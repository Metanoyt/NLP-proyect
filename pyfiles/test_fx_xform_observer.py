Owner s module fx copy os tempfile torch torch fx subgraph_rewriter symbolic_trace torch fx passes graph_transform_observer GraphTransformObserver torch fx traceback NodeSourceAction torch testing _internal common_utils TestCase TestGraphTransformObserver TestCase test_graph_transform_observer M torch nn Module forward x val = torch neg x torch add val val pattern x torch neg x replacement x torch relu x traced = symbolic_trace M log_url = tempfile mkdtemp GraphTransformObserver traced replace_neg_with_relu log_url=log_url ob subgraph_rewriter replace_pattern traced pattern replacement assertTrue relu ob created_nodes assertTrue neg ob erased_nodes current_pass_count = GraphTransformObserver get_current_pass_count assertTrue os path isfile os path join log_url f pass_ current_pass_count _replace_neg_with_relu_input_graph dot assertTrue os path isfile os path join log_url f pass_ current_pass_count _replace_neg_with_relu_output_graph dot torch _inductor config patch trace provenance_tracking_level test_graph_transform_observer_node_tracking M torch nn Module forward x val = torch neg x torch add val val pattern x torch neg x replacement x torch relu x replacement x torch cos x traced = symbolic_trace M check_node_source node_source node_name target id pass_name action assertEqual node_source name node_name assertEqual node_source target target assertEqual node_source pass_name pass_name assertEqual node_source graph_id id assertEqual node_source action action GraphTransformObserver traced replace_neg_with_relu ob subgraph_rewriter replace_pattern traced pattern replacement assertTrue relu ob created_nodes assertTrue neg ob erased_nodes assertEqual len traced _replace_hooks assertEqual len traced _create_node_hooks assertEqual len traced _erase_node_hooks assertEqual len traced _deepcopy_hooks node traced graph nodes node name == relu from_node = node meta from_node assertTrue len from_node == check_node_source from_node neg str torch neg id traced graph replace_neg_with_relu NodeSourceAction REPLACE NodeSourceAction CREATE GraphTransformObserver traced replace_relu_with_cos ob subgraph_rewriter replace_pattern traced replacement replacement assertTrue cos ob created_nodes assertTrue relu ob erased_nodes node traced graph nodes node name == cos from_node = node meta from_node assertTrue len from_node == check_node_source from_node relu str torch relu id traced graph replace_relu_with_cos NodeSourceAction REPLACE NodeSourceAction CREATE check_node_source from_node from_node neg str torch neg id traced graph replace_neg_with_relu NodeSourceAction REPLACE NodeSourceAction CREATE SimpleLinearModel torch nn Module forward x torch neg x model = SimpleLinearModel gm = torch export export model torch rand strict=True module GraphTransformObserver gm test add_node = gm graph call_function torch ops aten add default neg_node = next iter node node gm graph nodes node name == neg neg_node replace_all_uses_with replace_with=add_node from_node = add_node meta from_node assertTrue len from_node == check_node_source from_node neg str torch ops aten neg default id gm graph test NodeSourceAction REPLACE NodeSourceAction CREATE torch _inductor config patch trace provenance_tracking_level test_graph_transform_observer_deepcopy SimpleLinearModel torch nn Module forward x torch neg x model = SimpleLinearModel gm = torch export export model torch rand strict=True module GraphTransformObserver gm test gm = copy deepcopy gm nodes = node name node gm graph nodes nodes = node name node gm graph nodes assertEqual nodes nodes deepcopied graph modules should have hooks after exiting context assertEqual len gm _replace_hooks assertEqual len gm _create_node_hooks assertEqual len gm _erase_node_hooks assertEqual len gm _deepcopy_hooks torch _inductor config patch trace provenance_tracking_level test_graph_transform_observer_replace node should should duplicated Model torch nn Module forward x y = x + z = y w = y z w model = Model gm = symbolic_trace model GraphTransformObserver gm test node gm graph nodes node name == add new_node = gm graph call_function torch ops aten add Tensor node args node args node replace_all_uses_with new_node new_node name = new_add assertEqual len new_node meta from_node assertEqual new_node meta from_node name add assertEqual new_node meta from_node pass_name test __name__ == __main__ raise RuntimeError This test currently used should enabled discover_tests py required
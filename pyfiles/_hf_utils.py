io json struct dataclasses dataclass typing Any Optional torch _metadata_fn str = model safetensors index json FILE_NAME = model- cpt_idx -of- num_files SHARDED_FILE_NAME = shard- shard_idx -model- cpt_idx -of- num_files SUFFIX = safetensors metadata keys CUSTOM_METADATA_KEY = DCP_SHARDING_INFO DEFAULT_EXTRA_METADATA_KEY = __metadata__ SAVED_OFFSETS_KEY = saved_offsets SHAPE_KEY = shape DATA_KEY = data DTYPE_KEY = dtype DATA_OFFSETS_KEY = data_offsets DTYPE_MAP = F torch float F torch float F torch float I torch int U torch uint I torch int I torch int I torch int BF torch bfloat HF_DCP_VERSION float = DCP_VERSION_KEY = DCP_VERSION DCP_SHARDING_INFO_KEY = DCP_SHARDING_INFO FORMAT_KEY = format FORMAT_VALUE = pt NUM_BYTES_FOR_HEADER_LEN = SHARDED_DIR_NAME = sharded dataclass _HFStorageInfo This per entry storage info relative_path str shape torch Size dtype torch dtype _gen_file_name index int largest_index int shard_index Optional int = None - str shard_index None SHARDED_FILE_NAME format shard_idx=f shard_index zfill cpt_idx=f index zfill num_files=f largest_index zfill + SUFFIX FILE_NAME format cpt_idx=f index zfill num_files=f largest_index zfill + SUFFIX _get_safetensors_file_metadata file_bytes io IOBase - tuple Any int uses same logic s done HF code base https github com huggingface_hub blob main src huggingface_hub hf_api py#L follows their documentation how their files serialized https huggingface co docs safetensors index#format header_len_bytes = file_bytes read NUM_BYTES_FOR_HEADER_LEN header_len = struct unpack Q header_len_bytes header_json = file_bytes read header_len metadata = json loads header_json metadata header_len + NUM_BYTES_FOR_HEADER_LEN _get_dtype dtype_str str - torch dtype try dtype = DTYPE_MAP dtype_str except KeyError dtype = torch get_default_dtype dtype _get_dcp_custom_metadata metadata Any - Optional Any DEFAULT_EXTRA_METADATA_KEY metadata custom_metadata = metadata DEFAULT_EXTRA_METADATA_KEY CUSTOM_METADATA_KEY custom_metadata json loads custom_metadata CUSTOM_METADATA_KEY None
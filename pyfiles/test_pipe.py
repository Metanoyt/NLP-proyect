Copyright c Meta Platforms Inc affiliates Owner s oncall distributed model_registry MLPModule ModelWithParamAlias torch torch distributed pipelining pipe_split pipeline torch testing _internal common_utils instantiate_parametrized_tests parametrize run_tests TestCase d_hid = microbatch_size = torch manual_seed Basic example ExampleCode torch nn Module __init__ - None super __init__ mm_param = torch nn Parameter torch randn d_hid d_hid mm_param = torch nn Parameter torch randn d_hid d_hid lin = torch nn Linear d_hid d_hid lin = torch nn Linear d_hid d_hid forward x y x = torch mm x mm_param mutli-use param skip_connection = x x = x + y x = torch relu x pipe_split x = torch mm x mm_param mutli-use param x = lin x pipe_split x = torch relu x x = x + skip_connection x = torch mm x mm_param pipe_split x = lin x x = torch relu x x MultiMLP torch nn Module __init__ - None super __init__ mlp = MLPModule d_hid mlp = MLPModule d_hid mlp = MLPModule d_hid mlp = MLPModule d_hid forward x y x = mlp x pipe_split x = mlp x pipe_split x = mlp x pipe_split x = mlp x x - y EXPECTED_N_STAGES = ExampleCode MultiMLP ModelWithParamAlias Currently we don t enforce full set equality FQNs between original pipelined models because multi-use param case PP will deduplicate FQNs state_dict TODO CHECK_FQN_SET_EQUALITY = False PipeTests TestCase parametrize ModelClass ExampleCode MultiMLP ModelWithParamAlias test_model_split ModelClass mod = ModelClass x = torch randn microbatch_size d_hid y = torch randn microbatch_size d_hid pipe = pipeline mod mb_args= x y assert pipe num_stages == EXPECTED_N_STAGES ModelClass f nstages = pipe num_stages expect EXPECTED_N_STAGES ModelClass ref_out = mod x y out = pipe x y torch testing assert_close out ref_out print f equivalence test passed torch sum out ref torch sum ref_out Check qualname state_dict keys include both parameters persistent buffers old_names = set mod state_dict keys new_names = set idx range pipe num_stages stage_mod = pipe get_stage_module idx stage_fqns = set stage_mod state_dict keys assert stage_fqns issubset old_names new_names update stage_fqns CHECK_FQN_SET_EQUALITY assert old_names == new_names f old names old_names new names new_names print Qualname check passed instantiate_parametrized_tests PipeTests __name__ == __main__ run_tests
mypy allow-untyped-defs CuteDSL-specific operation overrides pointwise operations This module provides CuteDSL implementations common operations used template kernels particularly flex attention modifications math typing Optional Union sympy torch torch _inductor codegen common CSEVariable OpOverrides torch _inductor virtualized OpsValue V torch utils _sympy value_ranges ValueRanges CuteDSLArg = Union CSEVariable str upcast_compute_type dtype torch dtype - torch dtype Maybe upcast b float float dtype torch float torch bfloat torch float dtype CuteDSLOpOverrides OpOverrides CuteDSL-specific operation overrides generate code using CuteDSL syntax CuteDSL TensorSSA objects have built-in operator overloads __add__ __mul__ etc math functions cute math exp cute math sqrt etc TORCH_TO_CUTE_DTYPE = torch float cutlass Float torch bfloat cutlass BFloat torch float cutlass Float torch float cutlass Float torch int cutlass Int torch int cutlass Int torch int cutlass Int torch int cutlass Int torch bool cutlass Boolean torch float _e m fn cutlass Float E M FN torch float _e m cutlass Float E M Math constants LOG _E = ln converting natural exp base- exp staticmethod _ensure_tensor_ssa arg CuteDSLArg template_tensor CuteDSLArg - str Convert scalar arguments TensorSSA using cute full_like needed Args arg The argument check CSEVariable tensors str scalars OpsValue wrapper template_tensor A tensor argument use template full_like Returns String representation suitable CuteDSL operations isinstance arg CSEVariable str arg isinstance arg OpsValue isinstance arg value CSEVariable str arg value isinstance template_tensor CSEVariable f cute full_like template_tensor arg str arg staticmethod _extract_dtype_and_bounds args CuteDSLArg - tuple Optional torch dtype ValueRanges sympy Expr Extract dtype bounds CSEVariable arguments arg args isinstance arg CSEVariable arg dtype arg bounds None ValueRanges unknown staticmethod _apply_binary_op CuteDSLArg b CuteDSLArg op_format str - CuteDSLArg Apply binary operation automatic scalar-to-tensor conversion CuteDSL requires both operands TensorSSA objects tensor operations This helper automatically converts scalar arguments TensorSSA using cute full_like when least one argument tensor CSEVariable Args First operand CSEVariable tensors str scalars b Second operand CSEVariable tensors str scalars op_format Format string b placeholders operation Returns CSEVariable least one operand CSEVariable otherwise string tensor_arg = isinstance CSEVariable b isinstance b CSEVariable None tensor_arg None a_ssa = CuteDSLOpOverrides _ensure_tensor_ssa tensor_arg b_ssa = CuteDSLOpOverrides _ensure_tensor_ssa b tensor_arg result_expr = op_format format a=a_ssa b=b_ssa dtype bounds = CuteDSLOpOverrides _extract_dtype_and_bounds b Create CSEVariable using CSE generation caching V kernel cse generate V kernel body result_expr bounds=bounds dtype=dtype op_format format a=a b=b staticmethod _apply_unary_op x CuteDSLArg op_format str - CuteDSLArg Apply unary operation returning CSEVariable input CSEVariable Args x Input operand CSEVariable tensors str scalars op_format Format string x placeholder operation Returns CSEVariable input CSEVariable otherwise string isinstance x CSEVariable result_expr = op_format format x=str x V kernel cse generate V kernel body result_expr bounds=x bounds dtype=x dtype op_format format x=x staticmethod constant value Union bool float int dtype torch dtype - str Generate CuteDSL constant representation value == float -inf float -inf value == float inf float inf math isnan value float nan repr value staticmethod add CuteDSLArg b CuteDSLArg - CuteDSLArg CuteDSLOpOverrides _apply_binary_op b + b staticmethod mul CuteDSLArg b CuteDSLArg - CuteDSLArg CuteDSLOpOverrides _apply_binary_op b b staticmethod sub CuteDSLArg b CuteDSLArg - CuteDSLArg CuteDSLOpOverrides _apply_binary_op b - b staticmethod truediv CuteDSLArg b CuteDSLArg - CuteDSLArg CuteDSLOpOverrides _apply_binary_op b b staticmethod mod CuteDSLArg b CuteDSLArg - CuteDSLArg CuteDSLOpOverrides _apply_binary_op b b staticmethod remainder b CuteDSLOpOverrides _apply_binary_op b b staticmethod exp x CuteDSLArg - CuteDSLArg Exponential using CuteDSL cute math exp function CuteDSLOpOverrides _apply_unary_op x f cute math exp x CuteDSLOpOverrides LOG _E staticmethod sqrt x CuteDSLArg - CuteDSLArg Square root using CuteDSL cute math sqrt function CuteDSLOpOverrides _apply_unary_op x cute math sqrt x staticmethod log x CuteDSLArg - CuteDSLArg Natural logarithm using CuteDSL cute math log function CuteDSLOpOverrides _apply_unary_op x cute math log x staticmethod cos x CuteDSLArg - CuteDSLArg Cosine using CuteDSL cute math cos function CuteDSLOpOverrides _apply_unary_op x cute math cos x staticmethod sin x CuteDSLArg - CuteDSLArg Sine using CuteDSL cute math sin function CuteDSLOpOverrides _apply_unary_op x cute math sin x staticmethod erf x CuteDSLArg - CuteDSLArg Error function using CuteDSL cute math erf function CuteDSLOpOverrides _apply_unary_op x cute math erf x staticmethod maximum CuteDSLArg b CuteDSLArg - CuteDSLArg raise NotImplementedError TODO maximum supported yet TensorSSA staticmethod minimum CuteDSLArg b CuteDSLArg - CuteDSLArg raise NotImplementedError TODO minimum supported yet TensorSSA staticmethod where condition CuteDSLArg CuteDSLArg b CuteDSLArg - CuteDSLArg Conditional selection - handles both CSEVariable string inputs Find tensor argument use template full_like Priority use s tensor use b condition tensor_arg = isinstance CSEVariable b isinstance b CSEVariable condition isinstance condition CSEVariable None tensor_arg None a_ssa = CuteDSLOpOverrides _ensure_tensor_ssa tensor_arg b_ssa = CuteDSLOpOverrides _ensure_tensor_ssa b tensor_arg result_expr = f cute where condition a_ssa b_ssa dtype bounds = CuteDSLOpOverrides _extract_dtype_and_bounds b condition V kernel cse generate V kernel body result_expr bounds=bounds dtype=dtype f cute where condition b staticmethod pow CuteDSLArg b CuteDSLArg CuteDSLOpOverrides _apply_binary_op b b staticmethod abs x CuteDSLArg - CuteDSLArg Absolute value using CuteDSL cute math abs function isinstance x CSEVariable x_dtype = x dtype isinstance x OpsValue isinstance x value CSEVariable x_dtype = x value dtype x_dtype = torch float abs_op = mlir_math absf x_dtype torch float torch bfloat torch float mlir_math absi CuteDSLOpOverrides _apply_unary_op pyrefly ignore bad-argument-type x f cute TensorSSA abs_op x x shape x dtype staticmethod neg x CuteDSLArg - CuteDSLArg Negation using CuteDSL TensorSSA __neg__ operator TODO See https github com NVIDIA cutlass issues CuteDSLOpOverrides _apply_unary_op x cute TensorSSA - x x shape x dtype staticmethod to_dtype x CuteDSLArg dtype torch dtype src_dtype=None use_compute_types=True - CuteDSLArg Type conversion using CuteDSL TensorSSA Type Numeric Maps torch dtypes cutlass cute typing numeric types emits ` x cute typing Type ` Raises NotImplementedError unsigned integer unsupported dtypes Always convert up bf fp TODO configuring dtype = upcast_compute_type dtype cute_type = CuteDSLOpOverrides TORCH_TO_CUTE_DTYPE get dtype cute_type None raise NotImplementedError f CuteDSL dtype cast implemented torch dtype dtype isinstance x CSEVariable result_expr = f str x cute_type V kernel cse generate V kernel body result_expr bounds=x bounds dtype=dtype f x cute_type staticmethod tanh x CuteDSLArg - CuteDSLArg Hyperbolic tangent using CuteDSL cute math tanh function CuteDSLOpOverrides _apply_unary_op x cute math tanh x Logical operations staticmethod logical_and x CuteDSLArg x CuteDSLArg - CuteDSLArg CuteDSLOpOverrides _apply_binary_op x x b staticmethod logical_or x CuteDSLArg x CuteDSLArg - CuteDSLArg CuteDSLOpOverrides _apply_binary_op x x b staticmethod logical_not Logical NOT CuteDSLOpOverrides _apply_unary_op x == Comparison operations staticmethod eq CuteDSLArg b CuteDSLArg - CuteDSLArg CuteDSLOpOverrides _apply_binary_op b operator eq b staticmethod ne CuteDSLArg b CuteDSLArg - CuteDSLArg CuteDSLOpOverrides _apply_binary_op b operator ne b staticmethod lt CuteDSLArg b CuteDSLArg - CuteDSLArg CuteDSLOpOverrides _apply_binary_op b operator lt b staticmethod le CuteDSLArg b CuteDSLArg - CuteDSLArg CuteDSLOpOverrides _apply_binary_op b operator le b staticmethod gt CuteDSLArg b CuteDSLArg - CuteDSLArg CuteDSLOpOverrides _apply_binary_op b operator gt b staticmethod ge CuteDSLArg b CuteDSLArg - CuteDSLArg CuteDSLOpOverrides _apply_binary_op b operator ge b
__future__ annotations atexit json os abc ABC abstractmethod ast literal_eval enum Enum functools partial wraps logging DEBUG getLogger Logger os PathLike pathlib Path threading Lock time time typing Any Callable TYPE_CHECKING typing_extensions override TypeAlias filelock FileLock config context exceptions implementations impls locks TYPE_CHECKING utils P R ideally we could annotate tuple P args P kwargs functionally doesn t work P defined specific scope P args P kwargs only valid scope Params TypeAlias = tuple Any Any logger Logger = getLogger __name__ _IntfCallbackOrigin Enum RECORD = record GET = get INSERT = insert _IntfCallbackAction Enum REPLAY = replay RECORD_INSERTED = record_inserted RECORD_NOT_INSERTED = record_not_inserted RECORD_NOT_INSERTED_REPLAY = record_not_inserted_replay HIT = hit MISS = miss INSERTED = inserted NOT_INSERTED = not_inserted _intf_callback origin _IntfCallbackOrigin action _IntfCallbackAction dur float fn Callable P R params Params args Any - None origin == _IntfCallbackOrigin RECORD result R = args action == _IntfCallbackAction REPLAY logger log DEBUG RECORD fn s params r cached returned result r f seconds fn __name__ params result dur action == _IntfCallbackAction RECORD_INSERTED fn_dur float = args logger log DEBUG RECORD fn s params r cached calculated cached result r f seconds which f seconds spent function call fn __name__ params result dur fn_dur action == _IntfCallbackAction RECORD_NOT_INSERTED fn_dur = args logger log DEBUG RECORD fn s params r cached calculated result r able insert into cache matching entry already exists returned calculated result f seconds which f seconds spent function call fn __name__ params result dur fn_dur action == _IntfCallbackAction RECORD_NOT_INSERTED_REPLAY fn_dur = args cached_result R = args logger log DEBUG RECORD fn s params r cached calculated result r able insert into synchronization cache matching entry already exists returned cached result r f seconds which f seconds spent function call fn __name__ params result cached_result dur fn_dur raise NotImplementedError origin == _IntfCallbackOrigin GET action == _IntfCallbackAction HIT result = args logger log DEBUG GET fn s params r cached returned result r f seconds fn __name__ params result dur action == _IntfCallbackAction MISS logger log DEBUG GET fn s params r cached returned nothing f seconds fn __name__ params dur raise NotImplementedError origin == _IntfCallbackOrigin INSERT result = args action == _IntfCallbackAction INSERTED logger log DEBUG INSERT fn s params r result r inserted f seconds fn __name__ params result dur action == _IntfCallbackAction NOT_INSERTED logger log DEBUG INSERT fn s params r result r inserted f seconds there already has matching entry fn __name__ params result dur raise NotImplementedError raise NotImplementedError _CacheIntf ABC __init__ - None _lock Lock = Lock _make_key fn Callable P R params Params ischema context IsolationSchema &#124; None = None custom_params_encoder Callable P Any &#124; None = None - Any callee str = fn __name__ fkey Any = callee params custom_params_encoder pyrefly ignore invalid-param-spec callee custom_params_encoder params params ikey Any = context _isolation_key ischema ischema None context _DEFAULT_ISOLATION_SCHEMA fkey ikey _make_dummy_record_wrapper fn Callable P R - Callable P R wraps fn dummy_wrapper args Any kwargs Any - R pyrefly ignore invalid-param-spec fn args kwargs pyrefly ignore bad-return dummy_wrapper abstractmethod _make_record_wrapper fn Callable P R ischema context IsolationSchema &#124; None = None custom_params_encoder Callable P Any &#124; None = None custom_result_encoder Callable R Any &#124; None = None custom_result_decoder Callable Any R &#124; None = None - Callable P R pass abstractmethod _get fn Callable P R params Params ischema context IsolationSchema &#124; None = None custom_params_encoder Callable P Any &#124; None = None custom_result_decoder Callable Any R &#124; None = None - impls Hit &#124; None pass abstractmethod _insert fn Callable P R params Params result R ischema context IsolationSchema &#124; None = None custom_params_encoder Callable P Any &#124; None = None custom_result_encoder Callable R Any &#124; None = None - bool pass property lock - locks _LockProtocol Get context manager acquiring file lock Uses file locking ensure thread safety across processes Args timeout Optional timeout seconds float acquiring file lock Returns A callable returns context manager file lock _lock_with_timeout timeout float &#124; None = None - locks _LockContextManager locks _acquire_lock_with_timeout _lock timeout _lock_with_timeout get fn Callable P R params Params ischema context IsolationSchema &#124; None = None custom_params_encoder Callable P Any &#124; None = None custom_result_decoder Callable Any R &#124; None = None - impls Hit &#124; None config IS_CACHING_MODULE_ENABLED None start_t float = time lock type ignore call-arg result impls Hit &#124; None = _get fn params ischema=ischema custom_params_encoder=custom_params_encoder custom_result_decoder=custom_result_decoder dur float = time - start_t _intf_callback _IntfCallbackOrigin GET _IntfCallbackAction HIT result _IntfCallbackAction MISS dur fn params result value result result insert fn Callable P R params Params result R ischema context IsolationSchema &#124; None = None custom_params_encoder Callable P Any &#124; None = None custom_result_encoder Callable R Any &#124; None = None - bool config IS_CACHING_MODULE_ENABLED False start_t float = time lock type ignore call-arg inserted bool = _insert fn params result ischema=ischema custom_params_encoder=custom_params_encoder custom_result_encoder=custom_result_encoder dur float = time - start_t _intf_callback _IntfCallbackOrigin INSERT _IntfCallbackAction INSERTED inserted _IntfCallbackAction NOT_INSERTED dur fn params result inserted record ischema context IsolationSchema &#124; None = None custom_params_encoder Callable P Any &#124; None = None custom_result_encoder Callable R Any &#124; None = None custom_result_decoder Callable Any R &#124; None = None - Callable Callable P R Callable P R custom_result_encoder custom_result_decoder raise exceptions CustomResultDecoderRequiredError Custom result encoder provided without custom result decoder custom_result_encoder custom_result_decoder raise exceptions CustomResultEncoderRequiredError Custom result decoder provided without custom result encoder config IS_CACHING_MODULE_ENABLED _make_dummy_record_wrapper partial _make_record_wrapper ischema=ischema custom_params_encoder=custom_params_encoder custom_result_encoder=custom_result_encoder custom_result_decoder=custom_result_decoder _FastCacheIntf _CacheIntf __init__ - None super __init__ _imc impls _InMemoryCacheImpl = impls _InMemoryCacheImpl _callee_to_odc dict str impls _OnDiskCacheImpl = _get_odc_from_callee callee str - impls _OnDiskCacheImpl odc = _callee_to_odc get callee callee_sub_dir PathLike str = Path callee odc = impls _OnDiskCacheImpl sub_dir=callee_sub_dir _callee_to_odc callee = odc pyrefly ignore unbound-name odc override _make_record_wrapper fn Callable P R ischema context IsolationSchema &#124; None = None custom_params_encoder Callable P Any &#124; None = None custom_result_encoder Callable R Any &#124; None = None custom_result_decoder Callable Any R &#124; None = None - Callable P R wraps fn wrapper args P args kwargs P kwargs - R start_t float = time params = args kwargs lock get impls Hit &#124; None = _get fn params ischema=ischema custom_params_encoder=custom_params_encoder custom_result_decoder=custom_result_decoder get dur float = time - start_t _intf_callback _IntfCallbackOrigin RECORD _IntfCallbackAction REPLAY dur fn params get value get value fn_start_t float = time result R = fn args kwargs fn_dur float = time - fn_start_t inserted bool = _insert fn params result ischema=ischema custom_params_encoder=custom_params_encoder custom_result_encoder=custom_result_encoder dur = time - start_t _intf_callback _IntfCallbackOrigin RECORD _IntfCallbackAction RECORD_INSERTED inserted _IntfCallbackAction RECORD_NOT_INSERTED dur fn params result fn_dur result wrapper override _get fn Callable P R params Params ischema context IsolationSchema &#124; None = None custom_params_encoder Callable P Any &#124; None = None custom_result_decoder Callable Any R &#124; None = None - impls Hit &#124; None key Any = _make_key fn params ischema=ischema custom_params_encoder=custom_params_encoder odc impls _OnDiskCacheImpl = _get_odc_from_callee fn __name__ locks _acquire_many_impl_locks_with_timeout _imc odc try we ll check memoization first since much faster than checking on-disk cache two should consistent regardless imc_get impls Hit &#124; None = _imc get key imc_get custom_result_decoder impls Hit value=custom_result_decoder imc_get value imc_get odc_get impls Hit &#124; None = odc get key odc_get custom_result_decoder impls Hit value=custom_result_decoder odc_get value odc_get None except exceptions KeyEncodingError err raise exceptions CustomParamsEncoderRequiredError fn params err override _insert fn Callable P R params Params result R ischema context IsolationSchema &#124; None = None custom_params_encoder Callable P Any &#124; None = None custom_result_encoder Callable R Any &#124; None = None - bool key Any = _make_key fn params ischema=ischema custom_params_encoder=custom_params_encoder odc impls _OnDiskCacheImpl = _get_odc_from_callee fn __name__ locks _acquire_many_impl_locks_with_timeout _imc odc try encoded_result Any = result custom_result_encoder custom_result_encoder result reverse order get we don t want memoize values we haven t actually inserted them into on-disk cache so memoization on-disk cache remain consistent odc insert key encoded_result assert _imc insert key encoded_result True False except exceptions KeyEncodingError err raise exceptions CustomParamsEncoderRequiredError fn params err except exceptions ValueEncodingError err raise exceptions CustomResultEncoderRequiredError f Custom result encoder required function fn parameters params result result err _DeterministicCacheIntf _CacheIntf __init__ - None super __init__ _imc impls _InMemoryCacheImpl = impls _InMemoryCacheImpl fpath = os environ get TORCHINDUCTOR_PRE_POPULATE_DETERMINISTIC_CACHE pyrefly ignore bad-assignment flock FileLock = FileLock str fpath + lock locks _acquire_flock_with_timeout flock open fpath fp dump_for_pre_population dict str str = json load fp key_r value_r dump_for_pre_population items key bytes = literal_eval key_r value bytes = literal_eval value_r _imc _memory key = value config STRICTLY_PRE_POPULATED_DETERMINISM we ll never need synchronization cache we re strictly pre-populated mode we ll only ever checking memoized pre-population _get_sc_from_callee Callable str None &#124; impls _OnDiskCacheImpl &#124; impls _RemoteCacheImpl = lambda callee None config GLOBAL_DETERMINISM we want global determinism we need use remote cache strong consistency synchronization cache _rc impls _RemoteCacheImpl = impls _RemoteCacheImpl _rc has_strong_consistency raise exceptions DeterministicCachingRequiresStrongConsistencyError _get_sc_from_callee = lambda callee _rc config LOCAL_DETERMINISM local determinism can use on-disk cache synchronization cache cleanliness on-disk cache we subdir based callee _callee_to_odc dict str impls _OnDiskCacheImpl = _get_sc_from_callee = _get_odc_from_callee raise exceptions DeterministicCachingInvalidConfigurationError Deterministic caching must specify least one STRICTLY_PRE_POPULATED_DETERMINISM GLOBAL_DETERMINISM LOCAL_DETERMINISM atexit register _dump_imc_to_disk __del__ - None atexit unregister _dump_imc_to_disk del _get_odc_from_callee callee str - impls _OnDiskCacheImpl odc = _callee_to_odc get callee callee_sub_dir PathLike str = Path callee odc = impls _OnDiskCacheImpl sub_dir=callee_sub_dir _callee_to_odc callee = odc pyrefly ignore unbound-name odc _dump_imc_to_disk - Path &#124; None lock type ignore call-arg to_dump dict str str = repr key repr value key value _imc _memory items to_dump None odc impls _OnDiskCacheImpl = impls _OnDiskCacheImpl sub_dir=Path dcache_dump fpath Path = odc _cache_dir imc save odc lock r_fp w_fp = None None try w_fp = open fpath x except FileExistsError open fpath r_fp existing_dump = json load r_fp key value existing_dump items key to_dump to_dump key = value raise exceptions DeterministicCachingIMCDumpConflictError None w_fp = open fpath w finally assert w_fp None try json dump to_dump w_fp indent= finally w_fp close fpath override _make_record_wrapper fn Callable P R ischema context IsolationSchema &#124; None = None custom_params_encoder Callable P Any &#124; None = None custom_result_encoder Callable R Any &#124; None = None custom_result_decoder Callable Any R &#124; None = None - Callable P R wraps fn wrapper args P args kwargs P kwargs - R config IS_DETERMINISTIC_CACHING_ENABLED raise exceptions DeterministicCachingDisabledError start_t float = time params = args kwargs lock get impls Hit &#124; None = _get fn params ischema=ischema custom_params_encoder=custom_params_encoder custom_result_decoder=custom_result_decoder get dur float = time - start_t _intf_callback _IntfCallbackOrigin RECORD _IntfCallbackAction REPLAY dur fn params get value get value fn_start_t float = time result R = fn args kwargs fn_dur float = time - fn_start_t _insert fn params result ischema custom_params_encoder custom_result_encoder we couldn t insert means some other callee has populated key entry remote cache within time between our first get insert attempt case deterministic we should call get again value assumption other compile workers will also use value get = _get fn params ischema custom_params_encoder=custom_params_encoder custom_result_decoder=custom_result_decoder assert get None remote cache should get key insert key _ failed dur = time - start_t _intf_callback _IntfCallbackOrigin RECORD _IntfCallbackAction RECORD_NOT_INSERTED_REPLAY dur fn params fn_dur get value get value dur = time - start_t _intf_callback _IntfCallbackOrigin RECORD _IntfCallbackAction RECORD_INSERTED dur fn params result fn_dur result wrapper override _get fn Callable P R params Params ischema context IsolationSchema &#124; None = None custom_params_encoder Callable P Any &#124; None = None custom_result_decoder Callable Any R &#124; None = None - impls Hit &#124; None key Any = _make_key fn params ischema=ischema custom_params_encoder=custom_params_encoder sc impls _OnDiskCacheImpl &#124; impls _RemoteCacheImpl &#124; None = _get_sc_from_callee fn __name__ locks _acquire_many_impl_locks_with_timeout _imc sc sc _imc try we ll check memoization first since much faster than checking remote cache two should consistent imc_get impls Hit &#124; None = _imc get key imc_get custom_result_decoder impls Hit value=custom_result_decoder imc_get value imc_get sc raise exceptions StrictDeterministicCachingKeyNotFoundError sc_get impls Hit &#124; None = sc get key sc_get custom_result_decoder impls Hit value=custom_result_decoder sc_get value sc_get config STRICTLY_CACHED_DETERMINISM raise exceptions StrictDeterministicCachingKeyNotFoundError None except exceptions KeyEncodingError err raise exceptions CustomParamsEncoderRequiredError fn params err override _insert fn Callable P R params Params result R ischema context IsolationSchema &#124; None = None custom_params_encoder Callable P Any &#124; None = None custom_result_encoder Callable R Any &#124; None = None - bool config STRICTLY_PRE_POPULATED_DETERMINISM config STRICTLY_CACHED_DETERMINISM raise exceptions StrictDeterministicCachingInsertionError key Any = _make_key fn params ischema=ischema custom_params_encoder=custom_params_encoder sc impls _OnDiskCacheImpl &#124; impls _RemoteCacheImpl &#124; None = _get_sc_from_callee fn __name__ assert sc sc should either on-disk cache remote cache we re inserting locks _acquire_many_impl_locks_with_timeout _imc sc try encoded_result Any = result custom_result_encoder custom_result_encoder result reverse order get we don t want memoize values we haven t actually inserted them into remote cache so memoization remote cache remain consistent sc insert key encoded_result _imc insert key encoded_result imc might have mapping already pre-populated assert _imc get key == encoded_result True False except exceptions KeyEncodingError err raise exceptions CustomParamsEncoderRequiredError fn params err except exceptions ValueEncodingError err raise exceptions CustomResultEncoderRequiredError f Custom result encoder required function fn parameters params result result err override get fn Callable P R params Params ischema context IsolationSchema &#124; None = None custom_params_encoder Callable P Any &#124; None = None custom_result_decoder Callable Any R &#124; None = None - impls Hit &#124; None config IS_DETERMINISTIC_CACHING_ENABLED raise exceptions DeterministicCachingDisabledError super get fn params ischema=ischema custom_params_encoder=custom_params_encoder custom_result_decoder=custom_result_decoder override insert fn Callable P R params Params result R ischema context IsolationSchema &#124; None = None custom_params_encoder Callable P Any &#124; None = None custom_result_encoder Callable R Any &#124; None = None - bool config IS_DETERMINISTIC_CACHING_ENABLED raise exceptions DeterministicCachingDisabledError super insert fn params result ischema=ischema custom_params_encoder=custom_params_encoder custom_result_encoder=custom_result_encoder
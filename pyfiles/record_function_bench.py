argparse sys benchmarks fastrnns factory lstm_creator torchvision models resnet torch torch utils benchmark benchmark_utils prepare_lstm_jit bench_args model_def = lstm_creator script=True seqLength=bench_args lstmSeqLength numLayers=bench_args lstmNumLayers inputSize=bench_args lstmInputSize hiddenSize=bench_args lstmHiddenSize miniBatch=bench_args lstmMiniBatch device= cpu model_def inputs model_def forward prepare_resnet _jit bench_args model = resnet inputs = torch randn model = torch jit trace model inputs inputs model MODELS = resnet _jit prepare_resnet _jit lstm_jit prepare_lstm_jit NUM_THREADS = run_bench model_names bench_args results = model_name model_names model_creator = MODELS model_name inputs model = model_creator bench_args print Benchmarking RecordFunction overhead model_name print Running warmup end= sys stdout flush _ range bench_args warmup model inputs print finished num_threads NUM_THREADS with_rec_fn True False torch autograd _enable_record_function with_rec_fn torch autograd _clear_callbacks with_rec_fn torch autograd _set_empty_test_observer True print Running RecordFunction num threads format with_rec_fn without num_threads end= sys stdout flush timer = benchmark_utils Timer stmt= model inputs globals= model model inputs inputs description=model_name label= Record function overhead sub_label=f with_rec_fn out _rec_fn num_threads num_threads num_threads=num_threads result = timer blocked_autorange min_run_time=bench_args timer_min_run_time print finished print result sys stdout flush results append result comparison = benchmark_utils Compare results comparison trim_significant_figures comparison highlight_warnings comparison print __name__ == __main__ parser = argparse ArgumentParser description= Benchmark RecordFunction overhead ResNet LSTM models parser add_argument -- models nargs= default= lstm_jit help= What model run + str MODELS keys parser add_argument -- lstmSeqLength default= type=int parser add_argument -- lstmNumLayers default= type=int parser add_argument -- lstmInputSize default= type=int parser add_argument -- lstmHiddenSize default= type=int parser add_argument -- lstmMiniBatch default= type=int parser add_argument -- warmup default= type=int parser add_argument -- nloops default= type=int parser add_argument -- timer-min-run-time -- timer_min_run_time default= type=int args = parser parse_args models = args models MODELS keys model models assert model MODELS run_bench models args
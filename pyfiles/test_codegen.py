__future__ annotations dataclasses typing unittest collections defaultdict yaml tools autograd gen_autograd_functions load_derivatives torchgen dest torchgen api types CppSignatureGroup DispatcherSignature torchgen context native_function_manager torchgen gen get_native_function_declarations get_native_function_schema_registrations LineLoader static_dispatch torchgen model BackendIndex BackendMetadata DispatchKey FunctionSchema Location NativeFunction OperatorName torchgen native_function_generation add_generated_native_functions torchgen selective_build selector SelectiveBuilder TestCreateDerivative unittest TestCase test_named_grads - None schema = FunctionSchema parse func Tensor Tensor b - Tensor x Tensor y native_function = dataclasses replace DEFAULT_NATIVE_FUNCTION func=schema derivative = load_derivatives create_derivative native_function formula= func_backward grad_x grad_y var_names= available_named_gradients= grad_x grad_y assertSetEqual derivative named_gradients grad_x grad_y test_non_differentiable_output - None specification = func Tensor Tensor b - Tensor x bool y Tensor z schema = FunctionSchema parse specification native_function = dataclasses replace DEFAULT_NATIVE_FUNCTION func=schema _ differentiability_info = load_derivatives create_differentiability_info defn_dict= name specification dispatch Default grads b grads functions_by_signature= schema signature native_function functions_by_schema= specification native_function op_counter=typing Counter str used_dispatch_keys=set assertSequenceEqual differentiability_info Default available_named_gradients grad_y present because y bool thus differentiable grad_x grad_z test_indexed_grads - None schema = FunctionSchema parse func Tensor Tensor b - Tensor x Tensor y native_function = dataclasses replace DEFAULT_NATIVE_FUNCTION func=schema derivative = load_derivatives create_derivative native_function formula= func_backward grads grads var_names= available_named_gradients= grad_x grad_y assertSetEqual derivative named_gradients set test_named_grads_and_indexed_grads - None specification = func Tensor Tensor b - Tensor x Tensor y schema = FunctionSchema parse specification native_function = dataclasses replace DEFAULT_NATIVE_FUNCTION func=schema assertRaisesRegex RuntimeError illegally mixes use grad_RETURN_NAME load_derivatives create_differentiability_info defn_dict= name specification Uh-oh derivatives reference gradients name index dispatch Default grad_x b grads functions_by_signature= schema signature native_function functions_by_schema= specification native_function op_counter=typing Counter str used_dispatch_keys=set TestGenAutogradFunctions unittest TestCase test_non_differentiable_output_invalid_type - None specification = func Tensor Tensor b - Tensor x bool y Tensor z schema = FunctionSchema parse specification native_function = dataclasses replace DEFAULT_NATIVE_FUNCTION func=schema _ differentiability_info = load_derivatives create_differentiability_info defn_dict= name specification dispatch Default grad_x b grad_z functions_by_signature= schema signature native_function functions_by_schema= specification native_function op_counter=typing Counter str used_dispatch_keys=set definition = gen_autograd_functions process_function differentiability_info Default gen_autograd_functions FUNCTION_DEFINITION grad_z should map grads grads because output y differentiable assert grad_z = grads definition assert grad_z = grads definition test_non_differentiable_output_output_differentiability - None specification = func Tensor Tensor b - Tensor x Tensor y Tensor z schema = FunctionSchema parse specification native_function = dataclasses replace DEFAULT_NATIVE_FUNCTION func=schema _ differentiability_info = load_derivatives create_differentiability_info defn_dict= name specification dispatch Default grad_x b grad_z AutogradNestedTensor grad_z b grad_x output_differentiability True False True functions_by_signature= schema signature native_function functions_by_schema= specification native_function op_counter=typing Counter str used_dispatch_keys=set default_definition = gen_autograd_functions process_function differentiability_info Default gen_autograd_functions FUNCTION_DEFINITION grad_z should map grads grads because output y differentiable assert grad_z = grads default_definition assert grad_z = grads default_definition nested_tensor_definition = gen_autograd_functions process_function differentiability_info AutogradNestedTensor gen_autograd_functions FUNCTION_DEFINITION assert grad_z = grads nested_tensor_definition assert grad_z = grads nested_tensor_definition test_register_bogus_dispatch_key - None specification = func Tensor Tensor b - Tensor x bool y Tensor z schema = FunctionSchema parse specification native_function = dataclasses replace DEFAULT_NATIVE_FUNCTION func=schema assertRaisesRegex RuntimeError Invalid dispatch key AutogradRandomTensor derivatives yaml load_derivatives create_differentiability_info defn_dict= name specification dispatch Default grad_x b grad_z AutogradRandomTensor grad_x b grad_z functions_by_signature= schema signature native_function functions_by_schema= specification native_function op_counter=typing Counter str used_dispatch_keys=set TestGenSchemaRegistration unittest TestCase setUp - None selector = SelectiveBuilder get_nop_selector custom_native_function _ = NativeFunction from_yaml func custom func - bool loc=Location __file__ valid_tags=set fragment_custom_native_function _ = NativeFunction from_yaml func quantized_decomposed func - bool loc=Location __file__ valid_tags=set test_default_namespace_schema_registration_code_valid - None native_functions = DEFAULT_NATIVE_FUNCTION registrations _ = get_native_function_schema_registrations native_functions=native_functions schema_selector=self selector assertEqual registrations m func - bool \n test_custom_namespace_schema_registration_code_valid - None _ registrations = get_native_function_schema_registrations native_functions= custom_native_function schema_selector=self selector assertEqual registrations TORCH_LIBRARY custom m m func - bool test_fragment_custom_namespace_schema_registration_code_valid - None Sometimes we want extend existing namespace example quantized namespace which already defined native quantized library cpp _ registrations = get_native_function_schema_registrations native_functions= fragment_custom_native_function schema_selector=self selector assertEqual registrations TORCH_LIBRARY_FRAGMENT quantized_decomposed m m func - bool test_mixed_namespace_schema_registration_code_valid - None aten_registrations custom_registrations = get_native_function_schema_registrations native_functions= DEFAULT_NATIVE_FUNCTION custom_native_function schema_selector=self selector assertEqual aten_registrations m func - bool \n assertEqual custom_registrations TORCH_LIBRARY custom m m func - bool test_ _namespaces_schema_registration_code_valid - None custom _native_function _ = NativeFunction from_yaml func custom func - bool loc=Location __file__ valid_tags=set aten_registrations custom_registrations = get_native_function_schema_registrations native_functions= DEFAULT_NATIVE_FUNCTION custom_native_function custom _native_function schema_selector=self selector assertEqual aten_registrations m func - bool \n assertEqual custom_registrations TORCH_LIBRARY custom m m func - bool TORCH_LIBRARY custom m m func - bool TestGenNativeFunctionDeclaration unittest TestCase setUp - None op_ _native_function op_ _backend_index = NativeFunction from_yaml func op_ - bool dispatch CPU kernel_ loc=Location __file__ valid_tags=set op_ _native_function op_ _backend_index = NativeFunction from_yaml func op_ - bool dispatch CPU kernel_ QuantizedCPU custom kernel_ loc=Location __file__ valid_tags=set backend_indices dict DispatchKey dict OperatorName BackendMetadata = DispatchKey CPU DispatchKey QuantizedCPU BackendIndex grow_index backend_indices op_ _backend_index BackendIndex grow_index backend_indices op_ _backend_index backend_indices = k BackendIndex dispatch_key=k use_out_as_primary=True external=False device_guard=False index=backend_indices k k backend_indices test_native_function_declaration_ _op_ _ns_error - None assertRaises AssertionError get_native_function_declarations grouped_native_functions= op_ _native_function op_ _native_function backend_indices=self backend_indices native_function_decl_gen=dest compute_native_function_declaration test_native_function_declaration_ _op_ _ns_valid - None assertIsInstance op_ _native_function NativeFunction declaration = get_native_function_declarations grouped_native_functions= op_ _native_function backend_indices=self backend_indices native_function_decl_gen=dest compute_native_function_declaration target = namespace namespace native TORCH_API bool kernel_ namespace native namespace assertEqual \n join declaration target Test native_function_generation TestNativeFunctionGeneratrion unittest TestCase setUp - None native_functions list NativeFunction = backend_indices dict DispatchKey dict OperatorName BackendMetadata = defaultdict dict yaml_entry = - func op Tensor - Tensor dispatch CompositeExplicitAutograd op autogen op out es = yaml load yaml_entry Loader=LineLoader one_return_func m = NativeFunction from_yaml es loc=Location __file__ valid_tags=set BackendIndex grow_index backend_indices m two_returns_func two_returns_backend_index = NativeFunction from_yaml func op_ - Tensor Tensor dispatch CPU kernel_ autogen op_ out loc=Location __file__ valid_tags=set BackendIndex grow_index backend_indices two_returns_backend_index core_func core_func_index = NativeFunction from_yaml func op_ vec Tensor input SymInt output_size float scale_factors - Tensor autogen op_ vec_out tags core loc=Location __file__ valid_tags= core BackendIndex grow_index backend_indices core_func_index test_functional_variant_autogen_out_variant - None native_functions = one_return_func add_generated_native_functions native_functions backend_indices assertEqual len native_functions assertEqual str native_functions func op out Tensor Tensor out - Tensor op_name = native_functions func name backend_metadata = backend_indices DispatchKey CompositeExplicitAutograd op_name assertEqual backend_metadata kernel op_out test_functional_variant_autogen_out_variant_two_returns - None native_functions = two_returns_func add_generated_native_functions native_functions backend_indices assertEqual len native_functions assertEqual str native_functions func op_ out Tensor out Tensor b out - Tensor Tensor b op_name = native_functions func name backend_metadata = backend_indices DispatchKey CompositeExplicitAutograd op_name assertEqual backend_metadata kernel op_ _out test_functional_variant_autogen_out_variant_core - None Tests autogen out variants core-tageed ops CompositeImplicitAutograd native_functions = core_func add_generated_native_functions native_functions backend_indices print native_functions assertEqual len native_functions assertEqual str native_functions func op_ vec_out Tensor input SymInt output_size float scale_factors Tensor out - Tensor Test static_dispatch TestStaticDispatchGeneratrion unittest TestCase setUp - None backend_indices dict DispatchKey dict OperatorName BackendMetadata = defaultdict dict yaml_entry = - func op out Tensor Tensor out - Tensor dispatch CompositeExplicitAutograd op es = yaml load yaml_entry Loader=LineLoader one_return_func m = NativeFunction from_yaml es loc=Location __file__ valid_tags=set BackendIndex grow_index backend_indices m dispatch_key = DispatchKey CompositeExplicitAutograd assertTrue dispatch_key backend_indices indices = BackendIndex dispatch_key=dispatch_key use_out_as_primary=True external=False device_guard=False index=self backend_indices dispatch_key test_op_with_ _backend_generates_static_dispatch - None disp_sig = DispatcherSignature from_schema one_return_func func native_function_manager one_return_func out = static_dispatch sig=disp_sig f=self one_return_func backend_indices=self indices assertEqual out compositeexplicitautograd op_out out test_op_with_cpp_sig_generates_static_dispatch - None sig_group = CppSignatureGroup from_native_function one_return_func method=False fallback_binding=self one_return_func manual_cpp_binding cpp signature puts out front native_function_manager one_return_func out = static_dispatch sig=sig_group signature f=self one_return_func backend_indices=self indices assertEqual out compositeexplicitautograd op_out out Represents most basic NativeFunction Use dataclasses replace edit use DEFAULT_NATIVE_FUNCTION _ = NativeFunction from_yaml func func - bool loc=Location __file__ valid_tags=set __name__ == __main__ unittest main
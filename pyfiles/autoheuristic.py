json os functools partial typing Any Callable Optional torch torch _inductor autoheuristic autoheuristic_utils AHContext AHMetadata AHOperation Choice CHOICE_COL Feedback FEEDBACK_COL get_metadata_str_from_log torch _inductor autoheuristic learned_heuristic_controller LearnedHeuristicController torch _inductor ir ChoiceCaller torch _inductor runtime runtime_utils cache_dir torch _inductor utils get_gpu_shared_memory LocalFeedback To able collect data choice function providing feedback given choice has provided LocalFeedback can used when AutoHeuristic should immediately run function collect feedback each choice see pad_mm py where autotuning happens locally example __init__ feedback_fn Callable Choice Feedback - None feedback_fn = feedback_fn __call__ choice Choice - Feedback feedback_fn choice InconsistentMetadata Exception Exception thrown when AutoHeuristic tries log data file where metadata stored file does match metadata would store file didn t exist AutoHeuristic AutoHeuristic framework allows one collect data learn heuristic i e regression tree generate heuristic code This allows one collect data The collected data can then used train heuristic see torchgen autoheuristic collected_feedback dict Choice Feedback __init__ fallback Callable Choice choices list Choice feedback Optional LocalFeedback context AHContext name str augment_context Optional list AHOperation = None precondition Optional Callable AHMetadata AHContext bool = None - None Initializes instance AutoHeuristic Args fallback A callable returns Choice when heuristic unsure which choice make AutoHeuristic data collection mode choices A list possible choices heuristic can make feedback An instance LocalFeedback provides feedback given choice context Context store each choice feedback name A string identifies heuristic augment_context An optional list AHOperation instances augment context precondition A callable returns boolean indicating whether AutoHeuristic should run fallback = fallback choices = choices feedback = feedback context = context name = name collected_feedback = augment_context = augment_context metadata = AHMetadata get_gpu_shared_memory torch cuda get_device_capability choices name precondition = precondition satisfies_precondition torch _inductor config autoheuristic_log_path == DEFAULT log_path = get_default_log_path log_path = torch _inductor config autoheuristic_log_path torch _inductor config collect_autoheuristic name feedback None choice choices feedback_val = feedback choice save_data choice feedback_val satisfies_precondition - bool precondition None precondition metadata context get_choice - Choice Returns chosen option based value autoheuristic_use If name one comma separated strings autoheuristic_use queries learned heuristic make decision Otherwise returns fallback option satisfies_precondition fallback torch _inductor config use_autoheuristic name augment_context None context apply_operations augment_context controller = LearnedHeuristicController metadata context decision = controller get_decision decision choices TODO AlnisM We might want allow future fallback decision None decision fallback get_top_k_choices top_k int always_included Optional list str = None - Optional list Choice satisfies_precondition None torch _inductor config use_autoheuristic name augment_context None context apply_operations augment_context controller = LearnedHeuristicController metadata context choices = controller get_decisions_ranked top_k choices None None always_included None choice always_included choice choices choices append choice choices None get_collected_feedback choice Choice - Any collected_feedback get choice None staticmethod get_device_identifier - str heuristic might work well one GPU another we store collected data per GPU model learn heuristic per GPU model TODO AlnisM just using device name now same GPU model can have different names device_name = torch cuda get_device_name replace _ device_name get_default_log_path - str device_name = get_device_identifier path = f cache_dir autoheuristic device_name os makedirs path exist_ok=True path += f name txt path serialize_metadata - str metadata_dict = metadata to_dict num_features cat_features = context get_numerical_and_categorical_features metadata_dict numerical_features = num_features metadata_dict categorical_features = cat_features json dumps metadata_dict save_data choice Choice feedback_val Feedback - None collected_feedback choice = feedback_val log_path = log_path lines = log_exists = os path exists log_path log_exists log already exists make sure consistent metadata = serialize_metadata existing_metadata = get_metadata_str_from_log log_path existing_metadata = metadata raise InconsistentMetadata Given metadata does match existing metadata lines append serialize_metadata feature_header = context get_feature_names_csv header = feature_header + + CHOICE_COL + + FEEDBACK_COL lines append header line = feature_values = context get_feature_values_csv line += feature_values + + choice + + str feedback_val lines append line open log_path f f write \n join lines + \n AutoHeuristicSelectAlgorithm AutoHeuristic AutoHeuristicSelectAlgorithm subclass AutoHeuristic allows one collect data learn heuristic when one wants use AutoHeuristic kernel choice selection __init__ fallback Callable Optional ChoiceCaller choices list ChoiceCaller input_nodes list Any context AHContext name str augment_context Optional list AHOperation = None precondition Optional Callable AHMetadata AHContext bool = None - None The arguments choices input_nodes name have match ones used call autotune_select_algorithm e g following call made autotune_select_algorithm name choices input_nodes layout same name choices input_nodes have used here input_nodes = input_nodes choicestr choice dict str ChoiceCaller = choice choices choicestr choice choice autoheuristic_id = choice choices_str = list choicestr choice keys fallback_str - str fallback_choice = fallback fallback_choice None TODO Find nicer way handle unsure fallback_choice autoheuristic_id super __init__ fallback_str choices_str None context name augment_context precondition torch _inductor config collect_autoheuristic name satisfies_precondition register_global_feedback input_nodes choices register_global_feedback input_nodes list Any choices list ChoiceCaller - None Registers callback select_algorithm which called timing each choice torch _inductor select_algorithm add_feedback_saver create_inputs_key create_precompile_key store_global_feedback ah_inputs_key str ah_precompile_key str timings dict ChoiceCaller float name str input_nodes list Any choices list ChoiceCaller - None current_inputs_key = create_inputs_key input_nodes current_inputs_key = ah_inputs_key current_precompile_key = create_precompile_key name current_inputs_key choices current_precompile_key = ah_precompile_key choice time timings items save_data choice autoheuristic_id time inputs_key = create_inputs_key input_nodes precompile_key = create_precompile_key name inputs_key choices feedback_saver = partial store_global_feedback inputs_key precompile_key add_feedback_saver feedback_saver get_choice_caller - Optional ChoiceCaller choice = get_choice choicestr choice get choice None get_top_k_choices_caller top_k int always_included Optional list str = None - Optional list ChoiceCaller choices = get_top_k_choices top_k always_included choices None None choicestr choice choice choice choices
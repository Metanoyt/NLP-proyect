Delete old branches os re datetime datetime functools lru_cache pathlib Path typing Any Callable github_utils gh_fetch_json_dict gh_graphql gitutils GitRepo SEC_IN_DAY = CLOSED_PR_RETENTION = SEC_IN_DAY NO_PR_RETENTION = SEC_IN_DAY PR_WINDOW = SEC_IN_DAY Set None look all PRs may take lot tokens REPO_OWNER = pytorch REPO_NAME = pytorch ESTIMATED_TOKENS = TOKEN = os environ GITHUB_TOKEN TOKEN raise Exception GITHUB_TOKEN set noqa TRY REPO_ROOT = Path __file__ parents Query all PRs instead just closed merged because s faster GRAPHQL_ALL_PRS_BY_UPDATED_AT = query $ owner String $ repo String $ cursor String repository owner $ owner name $ repo pullRequests first after $ cursor orderBy field UPDATED_AT direction DESC totalCount pageInfo hasNextPage endCursor nodes headRefName number updatedAt state GRAPHQL_OPEN_PRS = query $ owner String $ repo String $ cursor String repository owner $ owner name $ repo pullRequests first after $ cursor states OPEN totalCount pageInfo hasNextPage endCursor nodes headRefName number updatedAt state GRAPHQL_NO_DELETE_BRANCH_LABEL = query $ owner String $ repo String $ cursor String repository owner $ owner name $ repo label name no-delete-branch pullRequests first after $ cursor totalCount pageInfo hasNextPage endCursor nodes headRefName number updatedAt state is_protected branch str - bool try ESTIMATED_TOKENS += res = gh_fetch_json_dict f https api github com repos REPO_OWNER REPO_NAME branches branch bool res protected except Exception e print f branch Failed fetch branch protections e True convert_gh_timestamp date str - float datetime strptime date Y- m- dT H M SZ timestamp get_branches repo GitRepo - dict str Any Query locally branches group branch base name e g gh blah base - gh blah get most recent branch git_response = repo _run_git for-each-ref -- sort=creatordate -- format= refname committerdate iso-strict refs remotes origin branches_by_base_name dict str Any = line git_response splitlines branch date = line split re_branch = re match r refs remotes origin branch assert re_branch branch = branch_base_name = re_branch group x = re match r gh\ + \ head &#124; base &#124; orig branch branch_base_name = x group date = datetime fromisoformat date timestamp branch_base_name branches_by_base_name branches_by_base_name branch_base_name = date branch branches_by_base_name branch_base_name append branch date branches_by_base_name branch_base_name branches_by_base_name branch_base_name = date branches_by_base_name paginate_graphql query str kwargs dict str Any termination_func Callable list dict str Any bool get_data Callable dict str Any list dict str Any get_page_info Callable dict str Any dict str Any - list Any hasNextPage = True endCursor = None data list dict str Any = while hasNextPage ESTIMATED_TOKENS += res = gh_graphql query cursor=endCursor kwargs data extend get_data res hasNextPage = get_page_info res hasNextPage endCursor = get_page_info res endCursor termination_func data break data get_recent_prs - dict str Any now = datetime now timestamp Grab all PRs updated last CLOSED_PR_RETENTION days pr_infos list dict str Any = paginate_graphql GRAPHQL_ALL_PRS_BY_UPDATED_AT owner pytorch repo pytorch lambda data PR_WINDOW None now - convert_gh_timestamp data - updatedAt PR_WINDOW lambda res res data repository pullRequests nodes lambda res res data repository pullRequests pageInfo Get most recent PR each branch base group gh together prs_by_branch_base = pr pr_infos pr updatedAt = convert_gh_timestamp pr updatedAt branch_base_name = pr headRefName x = re match r gh\ + \ head &#124; base &#124; orig branch_base_name branch_base_name = x group branch_base_name prs_by_branch_base prs_by_branch_base branch_base_name = pr pr updatedAt prs_by_branch_base branch_base_name updatedAt prs_by_branch_base branch_base_name = pr prs_by_branch_base lru_cache maxsize= get_open_prs - list dict str Any paginate_graphql GRAPHQL_OPEN_PRS owner pytorch repo pytorch lambda data False lambda res res data repository pullRequests nodes lambda res res data repository pullRequests pageInfo get_branches_with_magic_label_or_open_pr - set str pr_infos list dict str Any = paginate_graphql GRAPHQL_NO_DELETE_BRANCH_LABEL owner pytorch repo pytorch lambda data False lambda res res data repository label pullRequests nodes lambda res res data repository label pullRequests pageInfo pr_infos extend get_open_prs Get most recent PR each branch base group gh together branch_bases = set pr pr_infos branch_base_name = pr headRefName x = re match r gh\ + \ head &#124; base &#124; orig branch_base_name branch_base_name = x group branch_bases add branch_base_name branch_bases delete_branch repo GitRepo branch str - None repo _run_git push origin -d branch delete_branches - None now = datetime now timestamp git_repo = GitRepo str REPO_ROOT origin debug=True branches = get_branches git_repo prs_by_branch = get_recent_prs keep_branches = get_branches_with_magic_label_or_open_pr delete = Do delete associated PR open closed updated recently contains magic string no associated PR branch updated last years protected Setting different values PR_WINDOW will change how branches closed PRs treated depending how old branch The default value will allow branches closed PRs deleted PR hasn t been updated days branch hasn t been updated years base_branch date sub_branches branches items print f base_branch Updated now - date SEC_IN_DAY days ago base_branch keep_branches print f base_branch Has magic label open PR skipping continue pr = prs_by_branch get base_branch pr print f base_branch Has PR pr number pr state updated now - pr updatedAt SEC_IN_DAY days ago now - pr updatedAt CLOSED_PR_RETENTION now - date CLOSED_PR_RETENTION continue now - date NO_PR_RETENTION continue print f base_branch Checking branch protections any is_protected sub_branch sub_branch sub_branches print f base_branch Is protected continue sub_branch sub_branches print f base_branch Deleting sub_branch delete append sub_branch ESTIMATED_TOKENS print Estimated tokens exceeded exiting break print f To delete len delete branch delete print f About delete branch branch delete_branch git_repo branch delete_old_tags - None Deletes ciflow tags they associated closed PR specific commit Lightweight tags don t have information about date they created so we can t check how old they The script just assumes ciflow tags should deleted regardless creation date git_repo = GitRepo str REPO_ROOT origin debug=True delete_tag tag str - None print f Deleting tag tag ESTIMATED_TOKENS += delete_branch git_repo f refs tags tag tags = git_repo _run_git tag splitlines CIFLOW_TAG_REGEX = re compile r ^ciflow\ \ \d &#124; - a-f $ AUTO_REVERT_TAG_REGEX = re compile r ^trunk\ - a-f $ tag tags try ESTIMATED_TOKENS print Estimated tokens exceeded exiting break CIFLOW_TAG_REGEX match tag AUTO_REVERT_TAG_REGEX match tag continue This checks date commit associated tag instead tag itself since lightweight tags don t have information I think should ok since only runs once day tag_info = git_repo _run_git show -s -- format= ct tag tag_timestamp = int tag_info strip Maybe some timezone issues few hours shouldn t matter tag_age_days = datetime now timestamp - tag_timestamp SEC_IN_DAY tag_age_days print f tag Tag older than days deleting delete_tag tag except Exception e print f Failed check tag tag e __name__ == __main__ delete_branches delete_old_tags
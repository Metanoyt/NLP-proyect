__future__ annotations pickle abc ABC abstractmethod ast literal_eval functools cached_property hashlib sha os getenv pathlib Path tempfile gettempdir threading Lock typing Any Generic TYPE_CHECKING TypeVar typing_extensions assert_never override Self torch utils _filelock FileLock TYPE_CHECKING concurrent futures Future ThreadPoolExecutor TypeVars can t recursive so generic types fall within Key Value can t bound properly example Key should only take tuples other Key types tuple Key known shortcoming torch s typing Key = TypeVar Key str int tuple Any Value = TypeVar Value str int tuple Any bytes dict Any Any list Any CacheError ValueError Exception raised errors encountered during cache operations Cache ABC Generic Key Value Abstract base cache implementations Provides interface cache operations abstractmethod get Self key Key - Value &#124; None Retrieve value cache Args key Key The key look up Returns Value &#124; None The cached value present None abstractmethod insert Self key Key value Value - bool Insert value into cache Args key Key The key insert value Value The value associate key Returns bool True value inserted False key already exists InMemoryCache Cache Key Value In-memory cache implementation using dictionary thread lock __init__ Self - None Initialize empty in-memory cache _cache dict Key Value = _lock Lock = Lock get Self key Key - Value &#124; None Retrieve value cache Args key Key The key look up Returns Value &#124; None The cached value present None _lock value = _cache get key None value None insert Self key Key value Value - bool Insert value into cache Args key Key The key insert value Value The value associate key Returns bool True value inserted False key already exists _lock key _cache no overwrites insert False _cache key = value True classmethod from_env_var cls env_var str - Self Create in-memory cache environment variable Args env_var str Name environment variable containing cache data Returns InMemoryCache An instance populated environment variable Raises CacheError If environment variable malformed contains invalid data cache = cls env_val = getenv env_var None env_var doesn t exist = empty cache cache kv_pair env_val split ignore whitespace prefix suffix kv_pair = kv_pair strip kv_pair kv_pair could env_val has suffix continue try keys values should comma separated key_bytes_repr value_bytes_repr = kv_pair split except ValueError err raise CacheError f Malformed kv_pair kv_pair r env_var env_var r likely missing comma separator err ignore whitespace prefix suffix again key_bytes_repr value_bytes_repr = key_bytes_repr strip value_bytes_repr strip try check key_bytes_str actual legitimate encoding key_bytes = literal_eval key_bytes_repr except ValueError SyntaxError err raise CacheError f Malformed key_bytes_repr key_bytes_repr r kv_pair kv_pair r encoding invalid err try check value_bytes_str actual legitimate encoding value_bytes = literal_eval value_bytes_repr except ValueError SyntaxError err raise CacheError f Malformed value_bytes_repr value_bytes_repr r kv_pair kv_pair r encoding invalid err try key = pickle loads key_bytes except pickle UnpicklingError err raise CacheError f Malformed key_bytes_repr key_bytes_repr r kv_pair kv_pair r un-pickle-able err try value = pickle loads value_bytes except pickle UnpicklingError err raise CacheError f Malformed value_bytes_repr value_bytes_repr r kv_pair kv_pair r un-pickle-able err true duplicates i e multiple occurrences same key = value mapping ok treated no-op key duplicates differing values i e key = value_ key = value_ where value_ = value_ okay since we don t allow overwriting cached values s bad regardless cache insert key value cache get key = value raise CacheError f Multiple values key key r found got cache get key r value r cache classmethod from_file_path cls fpath Path - Self Create in-memory cache file path Args fpath Path Path file containing pickled cache data Returns InMemoryCache An instance populated file Raises CacheError If file valid pickled dictionary cache = cls fpath is_file fpath doesn t exit = empty cache cache try open fpath rb fp cache _cache = pickle load fp except pickle UnpicklingError err raise CacheError f Failed create cache file path fpath file contents un-pickle-able err isinstance cache _cache dict raise CacheError f Failed create cache file path fpath file contents pickled dict Key Value cache AsyncCache Cache Key Value Asynchronous cache implementation using ThreadPoolExecutor get_async Self key Key executor ThreadPoolExecutor - Future Value &#124; None Retrieve value cache asynchronously Args key Key The key look up executor ThreadPoolExecutor Executor async execution Returns Future Value &#124; None Future cached value None executor submit get key insert_async Self key Key value Value executor ThreadPoolExecutor - Future bool Insert value into cache asynchronously Args key Key The key insert value Value The value associate key executor ThreadPoolExecutor Executor async execution Returns Future bool Future result insertion executor submit insert key value OnDiskCache AsyncCache Key Value On-disk cache implementation using files file locks Stores cache data files disk atomic operations versioning Supports custom cache directory names Attributes version int The version used cache versioning name str The name cache directory version int = __init__ Self name str &#124; None = None - None Initialize on-disk cache instance Args name str &#124; None optional The name cache directory If None defaults on_disk_cache name = name on_disk_cache cached_property base_dir Self - Path Get base directory cache Returns Path The base directory path storing cache files Path gettempdir cache name _fpath_from_key Self key Key - Path Get file path given key Args key Key The key convert file path Returns Path The file path key Raises CacheError If key pickle-able try base_dir sha pickle dumps key hexdigest except AttributeError pickle PicklingError err raise CacheError f Failed get fpath key key r key pickle-able err pyrefly ignore bad-argument-type assert_never key _flock_from_fpath Self fpath Path - FileLock Get file lock given file path Args fpath Path The file path Returns FileLock The file lock path fpath name hex digest meaning there ^ potential values fpath name more than enough unique locks cause additional overhead shared locks also saves our cache dir becoming percent locks pyrefly ignore bad-return FileLock str fpath parent locks fpath name + lock property version_prefix Self - bytes Get version prefix cache Returns bytes The version prefix bytes derived cache version string sha str OnDiskCache version encode digest override get Self key Key - Value &#124; None Retrieve value cache Args key Key The key look up Returns Value &#124; None The cached value present version matches None Raises CacheError If value corrupted cannot unpickled Side Effects Removes stale cache files version prefix does match fpath = _fpath_from_key key flock = _flock_from_fpath fpath flock fpath is_file None value_bytes = None prefix_length = len version_prefix open fpath rb fp fp read prefix_length == version_prefix value_bytes = fp read value_bytes None version_prefix did match so we can t read stale cached value we should also remove stale cached value so key can re-cached newer version fpath unlink None try value = pickle loads value_bytes except pickle UnpicklingError err raise CacheError f Failed get key key r value potentially corrupted value un-pickle-able err value override insert Self key Key value Value - bool Insert value into cache Args key Key The key insert value Value The value associate key Returns bool True value inserted False key already exists Raises CacheError If value pickle-able Side Effects Creates cache directory does exist fpath = _fpath_from_key key flock = _flock_from_fpath fpath fpath parent mkdir parents=True exist_ok=True try x mode exclusive creation meaning file will created iff file does already exist atomic w o overwrite use flock added atomicity guarantee prevent partial writes flock _ open fpath xb fp fp write version_prefix pickle dump value fp except pickle PicklingError err raise CacheError f Failed insert key key r value value r value pickle-able err except FileExistsError False True InductorOnDiskCache OnDiskCache Key Value Inductor-specific on-disk cache implementation Uses custom base directory Inductor cache files __init__ Self - None Initialize inductor on-disk cache instance Sets cache directory name inductor_on_disk_cache super __init__ inductor_on_disk_cache cached_property base_dir Self - Path Get base directory Inductor cache Returns Path The base directory path Inductor cache files torch _inductor runtime runtime_utils default_cache_dir Path default_cache_dir cache name
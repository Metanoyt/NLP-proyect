mypy allow-untyped-defs torch torch Tensor aten = torch ops aten inspect warnings collections abc Callable typing Optional TypeVar typing_extensions ParamSpec torch types Number decomposition_table dict str torch jit ScriptFunction = function_name_set set str = set _T = TypeVar _T _P = ParamSpec _P check_decomposition_has_type_annotations f inspect_empty = inspect _empty type ignore attr-defined sig = inspect signature f param sig parameters values assert param annotation = inspect_empty f No signature param param name function f name assert sig return_annotation = inspect_empty f No annotation function f name signatures_match decomposition_sig torch_op_sig decomp_params = decomposition_sig parameters op_params = torch_op_sig parameters len decomp_params = len op_params False decomp_param op_param zip decomp_params values op_params values can t check full equality yet because all fields correctly deduced torch_op_sig - like default value can t check kind bc kwarg-only values defaults yet supported TS inspect_empty = inspect _empty type ignore attr-defined field name annotation field == name decomp_param name == warnings warn PyTorch uses input instead public api stacklevel= getattr decomp_param field = getattr op_param field False decomp_default = decomp_param default op_default = op_param default default value always correctly inferred being present torch schema specified both they should equal decomp_default = inspect_empty op_default = inspect_empty decomp_default = op_default False decomposition_sig return_annotation == torch_op_sig return_annotation register_decomposition aten_op torch _ops OpOverload registry Optional dict str torch jit ScriptFunction = None - Callable Callable _P _T Callable _P _T decomposition_decorator f Callable _P _T - Callable _P _T nonlocal registry registry None registry = decomposition_table assert isinstance aten_op torch _ops OpOverload Need unique name jit function serialization assert f __name__ function_name_set f Duplicated function name f __name__ function_name_set add f __name__ scripted_func = torch jit script f torch _C _jit_pass_inline scripted_func graph _ range torch _C _jit_pass_peephole scripted_func graph torch _C _jit_pass_constant_propagation scripted_func graph registry str aten_op _schema = scripted_func f decomposition_decorator TODO replace torch sigmoid - aten sigmoid register_decomposition aten var correction var_decomposition input Tensor dim Optional list int = None correction Optional Number = None keepdim bool = False - Tensor dim None dim_i list int = dim = dim_i isinstance dim tuple list len dim == n = input numel n = dim_i dim type ignore assignment n = input shape dim_i type ignore call-overload mean = aten mean input dim True sub = input - mean sq = sub sub sum = aten sum sq dim keepdim correction None denom = float n - isinstance correction int denom = float n - correction isinstance correction float denom = float n - correction raise RuntimeError correction must int float pyrefly ignore no-matching-overload sum max denom register_decomposition aten var default var input Tensor unbiased bool = True - Tensor var_decomposition input correction= unbiased
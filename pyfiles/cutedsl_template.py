mypy allow-untyped-defs functools itertools collections abc Iterable typing Any Optional Union unittest mock patch torch _inductor ir ShapeAsConstantBuffer torch _inductor utils Placeholder torch _inductor virtualized V torch _logging getArtifactLogger autotune_process CuteDSLBenchmarkRequest TensorMeta ir Buffer ChoiceCaller CuteDSLTemplateBuffer IRNode Layout TensorBox common KernelTemplate cutedsl_kernel CuteDSLTemplateKernel log = getArtifactLogger __name__ output_code CuteDSLTemplate KernelTemplate Template generating CuteDSL CUTLASS Python DSL kernels kernel_type type Any = CuteDSLTemplateKernel index_counter = itertools count all_templates dict str CuteDSLTemplate = __init__ name str source str subgraph_fn Optional Any = None mask_fn Optional Any = None - None super __init__ name source = source subgraph_fn = subgraph_fn mask_fn = mask_fn template = CuteDSLTemplate _template_from_string source assert name all_templates f duplicate template name name CuteDSLTemplate all_templates name = staticmethod functools lru_cache None pyrefly ignore bad-override _template_from_string source str - Any KernelTemplate _template_from_string source maybe_append_choice choices list Any kwargs Any - Optional NotImplementedError Maybe generates new ChoiceCaller appends into existing choices Returns None success otherwise returns error try choices append generate kwargs None except NotImplementedError e log debug CuteDSL template choice generation failed s e noqa G e except Exception e log debug CuteDSL template choice generation error s e noqa G NotImplementedError f CuteDSL template failed e generate kwargs Any - ChoiceCaller Generate CuteDSL kernel caller input_nodes = kwargs pop input_nodes layout = kwargs pop layout mutated_inputs = kwargs pop mutated_inputs None subgraphs = kwargs pop subgraphs None kernel_name = f cutedsl_ name _ next index_counter template None raise RuntimeError Template compilation failed Jinja required output_node Buffer = Buffer name= buf_out layout=layout Patch V graph get_dtype handle fake buf_out buffer patch object V graph get_dtype KernelTemplate _fake_get_dtype output_node kernel = kernel_type kernel_name=kernel_name input_nodes=input_nodes output_node=self output_node subgraphs=subgraphs code = kernel render template kwargs log debug Generated CuteDSL Code \n s code bmreq = CuteDSLBenchmarkRequest kernel_name=kernel_name input_tensor_meta=TensorMeta from_irnodes input_nodes output_tensor_meta=TensorMeta from_irnodes output_node extra_args=tuple source_code=code make_kernel_render out_node hint_override Optional int = None Factory function creates kernel renderer final output This closure captures current template parameters allows output node specified later This used during final kernel selection phase when actual output buffer available render_kernel = kernel_type kernel_name=str Placeholder KERNEL_NAME input_nodes=input_nodes output_node=out_node subgraphs=subgraphs render render_kernel render template kwargs render_kernel render CuteDSLTemplateCaller name=kernel_name input_nodes=input_nodes layout=layout make_kernel_render=make_kernel_render bmreq=bmreq template=self mutated_inputs=mutated_inputs CuteDSLTemplateCaller ChoiceCaller Caller CuteDSL templates integrates autotuning system __init__ name str input_nodes list Buffer layout Layout make_kernel_render Any bmreq CuteDSLBenchmarkRequest template CuteDSLTemplate mutated_inputs Optional Iterable IRNode = None super __init__ name=name input_nodes=input_nodes layout=layout description=f CuteDSL template name make_kernel_render = make_kernel_render bmreq = bmreq template = template mutated_inputs = mutated_inputs __str__ - str f CuteDSLTemplateCaller name benchmark args out - float Benchmark kernel execution bmreq benchmark args out=out output_node - Union TensorBox ShapeAsConstantBuffer Create output node template choice TensorBox create CuteDSLTemplateBuffer layout=self layout inputs=self input_nodes make_kernel_render=self make_kernel_render template=self template mutated_inputs=self mutated_inputs call_name - str Return kernel call name name to_callable - Any Return callable can execute kernel make_kernel_render hash_key - str Return unique hash key choice - join name rsplit _ bmreq module_cache_key info_dict - dict str Any Return information about kernel name name backend CuteDSL template template name
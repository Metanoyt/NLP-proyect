Owner s oncall distributed datetime timedelta multiprocessing pool ThreadPool torch torch distributed dist torch testing _internal common_utils run_tests TestCase simple example user code takes base ControlCollectives executes multiple different collectives simple_user_func collectives dist _ControlCollectives rank int - int timeout = timedelta seconds= first barrier collectives barrier timeout True then all_sum out = collectives all_sum rank timeout out TestCollectives TestCase test_barrier - None store = dist HashStore world_size = f rank int - None collectives = dist _StoreCollectives store rank world_size collectives barrier foo timedelta seconds= True ThreadPool world_size pool pool map f range world_size test_broadcast - None store = dist HashStore world_size = timeout = timedelta seconds= f rank int - None collectives = dist _StoreCollectives store rank world_size rank == collectives broadcast_send foo b data timeout out = collectives broadcast_recv foo timeout assertEqual out b data ThreadPool world_size pool pool map f range world_size test_gather - None store = dist HashStore world_size = timeout = timedelta seconds= f rank int - None collectives = dist _StoreCollectives store rank world_size rank == out = collectives gather_recv foo str rank timeout assertEqual out b b b b collectives gather_send foo str rank timeout ThreadPool world_size pool pool map f range world_size test_scatter - None store = dist HashStore world_size = timeout = timedelta seconds= f rank int - None collectives = dist _StoreCollectives store rank world_size rank == out = collectives scatter_send foo str i i range world_size timeout out = collectives scatter_recv foo timeout assertEqual out str rank encode ThreadPool world_size pool pool map f range world_size test_all_sum - None store = dist HashStore world_size = timeout = timedelta seconds= f rank int - None collectives = dist _StoreCollectives store rank world_size out = collectives all_sum foo rank timeout assertEqual out sum range world_size ThreadPool world_size pool pool map f range world_size test_broadcast_timeout - None store = dist HashStore world_size = timeout = timedelta milliseconds= collectives = dist _StoreCollectives store world_size assertRaisesRegex Exception Wait timeout collectives broadcast_recv foo timeout test_gather_timeout - None store = dist HashStore world_size = timeout = timedelta milliseconds= collectives = dist _StoreCollectives store world_size assertRaisesRegex Exception gather failed -- missing ranks collectives gather_recv foo data timeout test_scatter_timeout - None store = dist HashStore world_size = timeout = timedelta milliseconds= collectives = dist _StoreCollectives store world_size assertRaisesRegex Exception Wait timeout collectives scatter_recv foo timeout test_all_gather_timeout - None store = dist HashStore world_size = timeout = timedelta milliseconds= collectives = dist _StoreCollectives store world_size assertRaisesRegex Exception all_gather failed -- missing ranks collectives all_gather foo data timeout test_barrier_timeout - None store = dist HashStore world_size = timeout = timedelta milliseconds= collectives = dist _StoreCollectives store world_size assertRaisesRegex Exception barrier failed -- missing ranks collectives barrier foo timeout True test_all_sum_timeout - None store = dist HashStore world_size = timeout = timedelta milliseconds= collectives = dist _StoreCollectives store world_size assertRaisesRegex Exception barrier failed -- missing ranks collectives all_sum foo timeout test_unique - None store = dist HashStore collectives = dist _StoreCollectives store collectives broadcast_send foo bar assertRaisesRegex Exception Key foo has already been used collectives broadcast_send foo bar assertRaisesRegex Exception Key foo has already been used collectives broadcast_recv foo assertRaisesRegex Exception Key foo has already been used collectives gather_send foo bar assertRaisesRegex Exception Key foo has already been used collectives gather_recv foo asdf assertRaisesRegex Exception Key foo has already been used collectives scatter_send foo asdf assertRaisesRegex Exception Key foo has already been used collectives scatter_recv foo assertRaisesRegex Exception Key foo has already been used collectives all_gather foo bar assertRaisesRegex Exception Key foo has already been used collectives all_sum foo test_simple_user_func - None store = dist HashStore world_size = f rank int - None user need create child collectives simple_user_func do need changed different child collectives store_collectives = dist _StoreCollectives store rank world_size out = simple_user_func store_collectives rank assertEqual out sum range world_size ThreadPool world_size pool pool map f range world_size __name__ == __main__ assert torch cuda _initialized test_distributed must have initialized CUDA context main process run_tests
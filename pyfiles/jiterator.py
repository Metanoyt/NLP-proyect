mypy allow-untyped-defs re collections abc Callable torch torch Tensor __all__ list str = _CodeParser __init__ code_string str optional_ws = r \s required_ws = r \s+ template_params = r P template_params \ +\ return_type = r P return_type \w+ function_name = r P function_name \w+ function_params = r P function_params \ +\ function_body = r P function_body \ +\ pattern = optional_ws + template + optional_ws + template_params + optional_ws + return_type + required_ws + function_name + optional_ws + function_params + optional_ws + function_body + optional_ws result = re match pattern code_string re DOTALL DOTALL matching multiline result None raise Exception noqa TRY f Couldn t parse code please check correctness \n code_string template_params = result template_params return_type = result return_type function_name = result function_name function_params = result function_params function_body = result function_body _JittedFunction __init__ code_string str return_by_ref bool num_outputs int kwargs code_string = code_string assert return_by_ref num_outputs == Return value only works single output return_by_ref = return_by_ref num_outputs = num_outputs parsed_code = _CodeParser code_string kernel_name = parsed_code function_name kwargs_dict = kwargs is_cuda_available = torch cuda is_available __call__ tensors Tensor kwargs Jiterator follow torch cuda s lazy initialization behavior Defer checking cuda s availability function invocation time assert is_cuda_available Jiterator only supported CUDA ROCm GPUs none available assert len tensors = jiterator only supports up tensor inputs expanded_kwargs = kwargs_dict copy key value kwargs items key kwargs_dict expanded_kwargs key = value raise KeyError f key declared function definition torch _C _cuda_jiterator_compile_and_launch_kernel code_string kernel_name return_by_ref num_outputs tensors expanded_kwargs _create_jit_fn code_string str kwargs - Callable Create jiterator-generated cuda kernel elementwise op The code string has valid CUDA function describes computation single element The code string has follow c++ template pattern shown example below This function will inlined into elementwise kernel template compiled fly Compiled kernel will cached memory well local temp dir Jiterator-generated kernels accepts noncontiguous tensors supports broadcasting type promotion Args code_string str CUDA code string compiled jiterator The entry functor must value kwargs Dict optional Keyword arguments generated function Example code_string = template typename T T my_kernel T x T y T alpha -x + alpha y jitted_fn = create_jit_fn code_string alpha= = torch rand device= cuda b = torch rand device= cuda invoke jitted function like regular python function result = jitted_fn b alpha= code_string also allows multiple function definitions last function will treated entry function Example code_string = template typename T T util_fn T x T y sin x + cos y code_string += template typename T T my_kernel T x T y T val min val util_fn x y jitted_fn = create_jit_fn code_string val= = torch rand device= cuda b = torch rand device= cuda invoke jitted function like regular python function result = jitted_fn b using default val= Jiterator can used together python registration override operator s cuda kernel Following example overriding gelu s cuda kernel relu Example code_string = template typename T T my_gelu T my_gelu = create_jit_fn code_string my_lib = torch library Library aten IMPL my_lib impl aten gelu my_gelu CUDA torch nn GELU torch nn function gelu now overridden = torch rand device= cuda torch allclose torch nn functional gelu torch nn functional relu warning This API beta may change future releases warning This API only supports up inputs output warning All input tensors must live CUDA device _JittedFunction code_string return_by_ref=False num_outputs= kwargs _create_multi_output_jit_fn code_string str num_outputs int kwargs - Callable Create jiterator-generated cuda kernel elementwise op supports returning one more outputs Args code_string str CUDA code string compiled jiterator The entry functor must value reference num_outputs int number outputs kernel kwargs Dict optional Keyword arguments generated function Example code_string = template typename T void my_kernel T x T y T alpha T out out = -x + alpha y jitted_fn = create_jit_fn code_string alpha= = torch rand device= cuda b = torch rand device= cuda invoke jitted function like regular python function result = jitted_fn b alpha= warning This API beta may change future releases warning This API only supports up inputs outputs _JittedFunction code_string return_by_ref=True num_outputs=num_outputs kwargs
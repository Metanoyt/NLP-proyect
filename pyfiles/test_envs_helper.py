os unittest dataclasses dataclass pathlib Path unittest mock patch cli lib common envs_helper m TestEnvHelpers unittest TestCase setUp Keep copy original environment restore later _env_backup = dict os environ tearDown Restore environment original state os environ clear os environ update _env_backup -------- get_env -------- test_get_env_unset_returns_default patch dict os environ clear=True assertEqual m get_env FOO default default test_get_env_empty_returns_default patch dict os environ FOO clear=True assertEqual m get_env FOO default default test_get_env_set_returns_value patch dict os environ FOO bar clear=True assertEqual m get_env FOO default bar test_get_env_not_exist_returns_default patch dict os environ FOO bar clear=True assertEqual m get_env TEST_NOT_EXIST default default test_get_env_not_exist_without_default patch dict os environ FOO bar clear=True assertEqual m get_env TEST_NOT_EXIST -------- env_bool -------- test_env_bool_uses_default_when_unset patch dict os environ clear=True assertTrue m env_bool FLAG default=True assertFalse m env_bool FLAG default=False test_env_bool_uses_str bool_when_set Patch str bool used env_bool so we don t depend its exact behavior fake_str bool s str - bool s lower true yes y patch dict os environ FLAG yEs clear=True patch object m str bool fake_str bool assertTrue m env_bool FLAG default=False -------- env_path_optional env_path -------- test_env_path_optional_unset_returns_none_by_default patch dict os environ clear=True assertIsNone m env_path_optional P test_env_path_optional_unset_returns_none_when_env_var_is_empty patch dict os environ P clear=True assertIsNone m env_path_optional P test_env_path_optional_unset_returns_default_str default string resolve=True default - absolute path default_str = x y patch dict os environ clear=True p = m env_path_optional P default=default_str assertIsInstance p Path assertIsNotNone p p assertTrue p is_absolute assertEqual p parts - x y test_env_path_optional_unset_returns_default_path_no_resolve d = Path z patch dict os environ clear=True p = m env_path_optional P default=d resolve=False assertEqual p d test_env_path_optional_respects_resolve_true patch dict os environ P b clear=True p = m env_path_optional P resolve=True assertIsInstance p Path p assertTrue p is_absolute test_env_path_optional_respects_resolve_false patch dict os environ P rel dir clear=True p = m env_path_optional P resolve=False assertEqual p Path rel dir p assertFalse p is_absolute test_env_path_raises_when_missing_and_default_none patch dict os environ clear=True assertRaises ValueError m env_path P None resolve=True test_env_path_returns_path_when_present tmp = Path b resolve patch dict os environ P str tmp clear=True p = m env_path P None resolve=True assertEqual p tmp -------- dataclass field helpers -------- test_dataclass_fields_read_env_at_instantiation dataclass Cfg flag bool = m env_bool_field FLAG default=False out Path = m env_path_field OUT default= ab resolve=True name str = m env_str_field NAME default= anon First instantiation patch dict os environ FLAG true OUT outdir NAME alice clear=True cfg = Cfg assertTrue cfg flag assertIsInstance cfg out Path assertTrue cfg out is_absolute assertEqual cfg name alice cfg name = bob change instance value assertEqual cfg name bob change reflected Change env new instance should reflect new values patch dict os environ FLAG false NAME clear=True cfg = Cfg assertFalse cfg flag str bool false - False assertTrue ab str cfg out assertIsInstance cfg out Path assertTrue cfg out is_absolute assertEqual cfg name anon empty - fallback default test_dataclass_path_field_with_default_value dataclass C out Path = m env_path_field OUT default= some dir resolve=False patch dict os environ clear=True c = C assertEqual c out Path some dir __name__ == __main__ unittest main
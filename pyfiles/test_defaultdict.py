======= BEGIN Dynamo patch ======= Owner s module dynamo ruff noqa flake noqa Test copied https raw githubusercontent com python cpython refs tags v Lib test test_defaultdict py sys torch torch _dynamo test_case unittest torch _dynamo test_case CPythonTestCase torch testing _internal common_utils run_tests __TestCase = CPythonTestCase redirect statements sys importlib abc redirect_imports = test mapping_tests test typinganndata test test_grammar test test_math test test_iter test typinganndata ann_module RedirectImportFinder importlib abc MetaPathFinder find_spec fullname path target=None Check problematic one fullname redirect_imports try Attempt standalone module name = fullname removeprefix test r = importlib import_module name Redirect module sys modules sys modules fullname = r Return module spec found module importlib util find_spec name except ImportError None None Add custom finder sys meta_path sys meta_path insert RedirectImportFinder ======= END DYNAMO PATCH ======= Unit tests collections defaultdict copy pickle unittest collections defaultdict foobar list TestDefaultDict __TestCase test_basic d = defaultdict assertEqual d default_factory None d default_factory = list d append assertEqual d d append assertEqual d d d assertEqual d assertTrue d d d d = defaultdict list foo= bar= assertEqual d default_factory list assertEqual d foo bar assertEqual d foo assertEqual d bar assertEqual d assertIn foo d assertIn foo d keys assertIn bar d assertIn bar d keys assertIn d assertIn d keys assertNotIn d assertNotIn d keys d default_factory = None assertEqual d default_factory None try d except KeyError err assertEqual err args fail d didn t raise KeyError assertRaises TypeError defaultdict test_missing d = defaultdict assertRaises KeyError d __missing__ d default_factory = list assertEqual d __missing__ test_repr d = defaultdict assertEqual d default_factory None assertEqual repr d defaultdict None assertEqual eval repr d d d = assertEqual repr d defaultdict None d = defaultdict int assertEqual d default_factory int d = assertEqual repr d defaultdict int foo d = defaultdict foo assertTrue d default_factory foo d assertEqual repr d defaultdict s repr foo test_copy d = defaultdict d = d copy assertEqual type d defaultdict assertEqual d default_factory None assertEqual d d default_factory = list d = d copy assertEqual type d defaultdict assertEqual d default_factory list assertEqual d d d = d copy assertEqual type d defaultdict assertEqual d default_factory list assertEqual d d assertEqual d Issue Copy fails empty default dict d = defaultdict d = e = d copy assertEqual e test_shallow_copy d = defaultdict foobar d = copy copy d assertEqual d default_factory foobar assertEqual d d d default_factory = list d = copy copy d assertEqual d default_factory list assertEqual d d test_deep_copy d = defaultdict foobar d = copy deepcopy d assertEqual d default_factory foobar assertEqual d d assertTrue d d d default_factory = list d = copy deepcopy d assertEqual d default_factory list assertEqual d d test_keyerror_without_factory d = defaultdict try d except KeyError err assertEqual err args fail expected KeyError test_recursive_repr Issue stack overflow when default_factory bound method torch _dynamo error_on_graph_break False sub defaultdict __init__ default_factory = _factory _factory d = sub assertRegex repr d r sub\ bound method sub\ _factory r sub\ \ \ \ \ \ \ \ \ \ test_callable_arg assertRaises TypeError defaultdict test_pickling d = defaultdict int d proto range pickle HIGHEST_PROTOCOL + s = pickle dumps d proto o = pickle loads s assertEqual d o test_union i = defaultdict int s = defaultdict str zero one i_s = i &#124; s assertIs i_s default_factory int assertDictEqual i_s one zero assertEqual list i_s s_i = s &#124; i assertIs s_i default_factory str assertDictEqual s_i zero assertEqual list s_i i_ds = i &#124; dict s assertIs i_ds default_factory int assertDictEqual i_ds one zero assertEqual list i_ds ds_i = dict s &#124; i assertIs ds_i default_factory int assertDictEqual ds_i zero assertEqual list ds_i assertRaises TypeError i &#124; list s items assertRaises TypeError list s items &#124; i We inherit fine &#124; = dict so just few sanity checks here i &#124; = list s items assertIs i default_factory int assertDictEqual i one zero assertEqual list i assertRaises TypeError i &#124; = None __name__ == __main__ run_tests
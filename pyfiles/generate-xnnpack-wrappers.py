usr bin env python __future__ print_function pathlib Path collections os sys logging BANNER = Auto-generated generate-wrappers py script Do modify WRAPPER_SRC_NAMES = PROD_SCALAR_MICROKERNEL_SRCS None PROD_FMA_MICROKERNEL_SRCS defined __riscv &#124; &#124; defined __riscv__ PROD_ARMSIMD _MICROKERNEL_SRCS defined __arm__ PROD_FP ARITH_MICROKERNEL_SRCS defined __arm__ PROD_NEON_MICROKERNEL_SRCS defined __arm__ &#124; &#124; defined __aarch __ PROD_NEONFP _MICROKERNEL_SRCS defined __arm__ &#124; &#124; defined __aarch __ PROD_NEONFMA_MICROKERNEL_SRCS defined __arm__ &#124; &#124; defined __aarch __ PROD_NEON_AARCH _MICROKERNEL_SRCS defined __aarch __ PROD_NEONV _MICROKERNEL_SRCS defined __arm__ &#124; &#124; defined __aarch __ PROD_NEONFP ARITH_MICROKERNEL_SRCS defined __arm__ &#124; &#124; defined __aarch __ PROD_NEONFP ARITH_AARCH _MICROKERNEL_SRCS defined __aarch __ PROD_NEONDOT_MICROKERNEL_SRCS defined __arm__ &#124; &#124; defined __aarch __ PROD_NEONDOT_AARCH _MICROKERNEL_SRCS defined __aarch __ PROD_NEONDOTFP ARITH_MICROKERNEL_SRCS defined __arm__ &#124; &#124; defined __aarch __ PROD_NEONDOTFP ARITH_AARCH _MICROKERNEL_SRCS defined __aarch __ PROD_NEONI MM_MICROKERNEL_SRCS defined __arm__ &#124; &#124; defined __aarch __ PROD_SSE_MICROKERNEL_SRCS defined __i __ &#124; &#124; defined __i __ &#124; &#124; defined __x _ __ PROD_SSE _MICROKERNEL_SRCS defined __i __ &#124; &#124; defined __i __ &#124; &#124; defined __x _ __ PROD_SSSE _MICROKERNEL_SRCS defined __i __ &#124; &#124; defined __i __ &#124; &#124; defined __x _ __ PROD_SSE _MICROKERNEL_SRCS defined __i __ &#124; &#124; defined __i __ &#124; &#124; defined __x _ __ PROD_AVX_MICROKERNEL_SRCS defined __i __ &#124; &#124; defined __i __ &#124; &#124; defined __x _ __ PROD_F C_MICROKERNEL_SRCS defined __i __ &#124; &#124; defined __i __ &#124; &#124; defined __x _ __ PROD_XOP_MICROKERNEL_SRCS defined __i __ &#124; &#124; defined __i __ &#124; &#124; defined __x _ __ PROD_FMA _MICROKERNEL_SRCS defined __i __ &#124; &#124; defined __i __ &#124; &#124; defined __x _ __ PROD_AVX _MICROKERNEL_SRCS defined __i __ &#124; &#124; defined __i __ &#124; &#124; defined __x _ __ PROD_AVX F_MICROKERNEL_SRCS defined __i __ &#124; &#124; defined __i __ &#124; &#124; defined __x _ __ PROD_AVX SKX_MICROKERNEL_SRCS defined __i __ &#124; &#124; defined __i __ &#124; &#124; defined __x _ __ PROD_AVX VBMI_MICROKERNEL_SRCS defined __i __ &#124; &#124; defined __i __ &#124; &#124; defined __x _ __ PROD_AVX VNNI_MICROKERNEL_SRCS defined __i __ &#124; &#124; defined __i __ &#124; &#124; defined __x _ __ PROD_AVX VNNIGFNI_MICROKERNEL_SRCS defined __i __ &#124; &#124; defined __i __ &#124; &#124; defined __x _ __ PROD_RVV_MICROKERNEL_SRCS defined __riscv &#124; &#124; defined __riscv__ PROD_AVXVNNI_MICROKERNEL_SRCS defined __i __ &#124; &#124; defined __i __ &#124; &#124; defined __x _ __ AARCH _ASM_MICROKERNEL_SRCS defined __arm__ AARCH _ASM_MICROKERNEL_SRCS defined __aarch __ add non-prod microkernel sources here SRC_NAMES = OPERATOR_SRCS SUBGRAPH_SRCS LOGGING_SRCS XNNPACK_SRCS TABLE_SRCS JIT_SRCS PROD_SCALAR_MICROKERNEL_SRCS PROD_FMA_MICROKERNEL_SRCS PROD_ARMSIMD _MICROKERNEL_SRCS PROD_FP ARITH_MICROKERNEL_SRCS PROD_NEON_MICROKERNEL_SRCS PROD_NEONFP _MICROKERNEL_SRCS PROD_NEONFMA_MICROKERNEL_SRCS PROD_NEON_AARCH _MICROKERNEL_SRCS PROD_NEONV _MICROKERNEL_SRCS PROD_NEONFP ARITH_MICROKERNEL_SRCS PROD_NEONFP ARITH_AARCH _MICROKERNEL_SRCS PROD_NEONDOT_MICROKERNEL_SRCS PROD_NEONDOT_AARCH _MICROKERNEL_SRCS PROD_NEONDOTFP ARITH_MICROKERNEL_SRCS PROD_NEONDOTFP ARITH_AARCH _MICROKERNEL_SRCS PROD_NEONI MM_MICROKERNEL_SRCS PROD_SSE_MICROKERNEL_SRCS PROD_SSE _MICROKERNEL_SRCS PROD_SSSE _MICROKERNEL_SRCS PROD_SSE _MICROKERNEL_SRCS PROD_AVX_MICROKERNEL_SRCS PROD_F C_MICROKERNEL_SRCS PROD_XOP_MICROKERNEL_SRCS PROD_FMA _MICROKERNEL_SRCS PROD_AVX _MICROKERNEL_SRCS PROD_AVX F_MICROKERNEL_SRCS PROD_AVX SKX_MICROKERNEL_SRCS PROD_AVX VBMI_MICROKERNEL_SRCS PROD_AVX VNNI_MICROKERNEL_SRCS PROD_AVX VNNIGFNI_MICROKERNEL_SRCS PROD_RVV_MICROKERNEL_SRCS PROD_AVXVNNI_MICROKERNEL_SRCS AARCH _ASM_MICROKERNEL_SRCS AARCH _ASM_MICROKERNEL_SRCS add non-prod microkernel sources here Source files needed buck build IGNORED_SOURCES = set \ $ PROJECT_BINARY_DIR build_identifier c\ Not currently used requires build-time codegen handle_singleline_parse line start_index = line find end_index = line find line = line start_index + end_index key_val = line split key_val x x key_val update_sources xnnpack_path cmakefile = XNNPACK CMakeLists txt print f Updating sources cmakefile sources = collections defaultdict list open os path join xnnpack_path cmakefile cmake lines = cmake readlines i = while i len lines line = lines i lines i startswith INCLUDE file _ = handle_singleline_parse line file startswith cmake gen path = Path xnnpack_path XNNPACK file local_sources = update_sources xnnpack_path path absolute as_posix k v local_sources items k sources sources k = sources k + local_sources k sources k = local_sources k lines i startswith SET src lines i name val = handle_singleline_parse line sources name extend val i+= continue line startswith SET line split strip \t\n\r set WRAPPER_SRC_NAMES keys &#124; set SRC_NAMES name = line split strip \t\n\r i += while i len lines len lines i lines i remove src beginning remove whitespaces newline value = lines i strip \t\n\r value IGNORED_SOURCES sources name append value i += i len lines len lines i remove src beginning possibly end value = lines i strip \t\n\r value IGNORED_SOURCES sources name append value i += sources gen_wrappers xnnpack_path xnnpack_sources = collections defaultdict list sources = update_sources xnnpack_path microkernels_sources = update_sources xnnpack_path XNNPACK cmake gen microkernels cmake key microkernels_sources sources key = microkernels_sources key name WRAPPER_SRC_NAMES xnnpack_sources WRAPPER_SRC_NAMES name extend sources name condition filenames xnnpack_sources items print condition filename filenames filepath = os path join xnnpack_path xnnpack_wrappers filename os path isdir os path dirname filepath os makedirs os path dirname filepath open filepath w wrapper print f BANNER file=wrapper print file=wrapper Architecture- platform-dependent preprocessor flags can defined here Note platform_preprocessor_flags can t used because they ignored arc focus buck project condition None print f #include filename file=wrapper Include source file only condition satisfied print f #if condition file=wrapper print f #include filename file=wrapper print f #endif condition file=wrapper update xnnpack_wrapper_defs bzl file under same folder open os path join os path dirname __file__ xnnpack_wrapper_defs bzl w wrapper_defs print file=wrapper_defs print BANNER file=wrapper_defs print file=wrapper_defs name WRAPPER_SRC_NAMES print \n + name + = file=wrapper_defs file_name sources name print f xnnpack_wrappers file_name file=wrapper_defs print file=wrapper_defs update xnnpack_src_defs bzl file under same folder open os path join os path dirname __file__ xnnpack_src_defs bzl w src_defs print file=src_defs print BANNER file=src_defs print file=src_defs name SRC_NAMES print \n + name + = file=src_defs file_name sources name print f XNNPACK src file_name file=src_defs print file=src_defs main argv print Generating wrappers argv None len argv == gen_wrappers gen_wrappers argv The first argument place where xnnpack_wrappers folder will created Run without arguments will generate xnnpack_wrappers current path The two bzl files will always generated current path __name__ == __main__ main sys argv
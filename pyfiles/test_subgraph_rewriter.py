Owner s oncall quantization Copied pytorch test fx test_subgraph_rewriter py os sys torch torch fx symbolic_trace subgraph_rewriter torch fx annotate annotate Make helper files test importable torch fx experimental rewriter RewritingTracer pytorch_test_dir = os path dirname os path dirname os path realpath __file__ sys path append pytorch_test_dir torch testing _internal jit_utils JitTestCase __name__ == __main__ raise RuntimeError This test file meant run directly use \n\n \tpython test test_fx py TESTNAME\n\n instead TestSubgraphRewriter JitTestCase test_subgraph_rewriter_preserves_logic M torch nn Module forward x val = torch neg x + torch relu x torch add val val pattern x torch neg x + torch relu x comparison x val = torch neg x + torch relu x torch add val val traced = symbolic_trace M comparison_fn = symbolic_trace comparison x = torch rand Replace ` pattern ` same pattern shouldn t change underlying logic subgraph_rewriter replace_pattern traced pattern pattern traced graph lint ref_output = comparison_fn x test_output = traced forward x assertEqual ref_output test_output test_subgraph_rewriter_with_oneliner_pattern M torch nn Module forward x val = torch neg x torch add val val pattern x torch neg x replacement x torch relu x comparison x val = torch relu x torch add val val traced = symbolic_trace M comparison_fn = symbolic_trace comparison x = torch rand subgraph_rewriter replace_pattern traced pattern replacement traced graph lint ref_output = comparison_fn x test_output = traced forward x assertEqual ref_output test_output test_subgraph_rewriter_single_pattern_match M torch nn Module forward x val = torch neg x + torch relu x torch add val val pattern x torch neg x + torch relu x replacement x torch relu x comparison x val = torch relu x torch add val val traced = symbolic_trace M comparison_fn = symbolic_trace comparison x = torch rand subgraph_rewriter replace_pattern traced pattern replacement traced graph lint ref_output = comparison_fn x test_output = traced forward x assertEqual ref_output test_output test_subgraph_rewriter_multiple_pattern_match M torch nn Module forward x w w m = torch cat w w sum m = torch cat w w sum x + torch max m + torch max m pattern w w torch cat w w sum replacement w w torch stack w w comparison x w w m = torch stack w w m = torch stack w w x + torch max m + torch max m traced = symbolic_trace M comparison_fn = symbolic_trace comparison x = torch rand w = torch rand w = torch rand subgraph_rewriter replace_pattern traced pattern replacement traced graph lint ref_outs = comparison_fn x w w test_outs = traced forward x w w assertEqual ref_outs test_outs test_subgraph_rewriter_graph_argument_order M torch nn Module forward x y torch mm x y pattern x y torch mm x y comparison x y torch mm x y traced = symbolic_trace M comparison_fn = symbolic_trace comparison x = torch randn y = torch randn subgraph_rewriter replace_pattern traced pattern pattern traced graph lint ref_outs = comparison_fn x y test_outs = traced forward x y assertEqual ref_outs test_outs test_subgraph_rewriter_correct_output_replacement M torch nn Module forward x y val = torch neg y + torch relu x torch add val val pattern x torch relu x replacement x torch neg x comparison x y val = torch neg y + torch neg x torch add val val traced = symbolic_trace M comparison_fn = symbolic_trace comparison x = torch randn y = torch randn subgraph_rewriter replace_pattern traced pattern replacement traced graph lint ref_outs = comparison_fn x y test_outs = traced forward x y assertEqual ref_outs test_outs test_subgraph_rewriter_traced_as_callable M torch nn Module forward x val = torch neg x + torch relu x torch add val val Pattern torch nn Module forward x torch neg x + torch relu x Replacement torch nn Module forward x torch sigmoid x comparison x val = torch sigmoid x torch add val val traced = symbolic_trace M traced_pattern = symbolic_trace Pattern traced_replacement = symbolic_trace Replacement comparison_fn = symbolic_trace comparison x = torch randn subgraph_rewriter replace_pattern traced traced_pattern traced_replacement traced graph lint ref_outs = comparison_fn x test_outs = traced forward x assertEqual ref_outs test_outs test_subgraph_rewriter_pattern_is_entire_graph M torch nn Module forward x = torch neg x torch add pattern x = torch neg x torch add replacement x = torch sigmoid x torch cat traced = symbolic_trace M comparison_fn = symbolic_trace replacement x = torch randn subgraph_rewriter replace_pattern traced pattern replacement traced graph lint ref_outs = comparison_fn x test_outs = traced forward x assertEqual ref_outs test_outs test_subgraph_rewriter_pattern_output_pattern_node_can_have_users_that_are_not_matched M torch nn Module forward x y = torch relu x torch neg y - y pattern x torch relu x replacement x torch sigmoid x comparison x y = torch sigmoid x torch neg y - y traced = symbolic_trace M comparison_fn = symbolic_trace comparison x = torch randn subgraph_rewriter replace_pattern traced pattern replacement traced graph lint ref_outs = comparison_fn x test_outs = traced forward x assertEqual ref_outs test_outs test_subgraph_rewriter_internal_pattern_nodes_cannot_have_users_that_are_not_matched M torch nn Module forward x w w b b m = torch cat w w noqa F m = torch cat w w m = torch cat x b t = torch addmm b m m t noqa F t = torch sum w t = torch addmm b m m t torch sum t torch sum t pattern x w w b b m = torch cat w w m = torch cat x b torch addmm b m m t replacement x w w b b torch cat x w w traced = symbolic_trace M Result should since no matches can found res = subgraph_rewriter replace_pattern traced pattern replacement traced graph lint assertEqual res test_subgraph_rewriter_placeholder_matching This tests placeholder Node can matched Node different number input Nodes In example below original traced Module looks like opcode target args kwargs ------------- ---------------------------------------------------------- ------------------------ -------- placeholder x call_function built-in function add x call_method dequantize add call_function built-in method sigmoid type object x f c f fe dequantize call_method sigmoid torch float output output while pattern we want match looks like opcode target args kwargs ------------- ---------------------------------------------------------- ------------------------ -------- placeholder x call_method dequantize x call_function built-in method sigmoid type object x f c f fe dequantize call_method sigmoid torch float output output Here we want able match original graph s ` call_function add ` Node pattern graph s ` plaeholder x ` Node Credit Jerry Zhang GitHub jerryzh test case M torch nn Module __init__ - None super __init__ dtype = torch float forward x x += x = x dequantize x = torch sigmoid x dtype = dtype x = x dtype x pattern x x = x dequantize x = torch sigmoid x x = x torch float x replacement x x comparison x x + traced = symbolic_trace M comparison_fn = symbolic_trace comparison x = torch randn subgraph_rewriter replace_pattern traced pattern replacement traced graph lint ref_outs = comparison_fn x test_outs = traced forward x assertEqual ref_outs test_outs test_subgraph_rewriter_replaces_referenced_submodules M torch nn Module __init__ - None super __init__ sigmoid = torch nn Sigmoid submod = torch nn ReLU forward x x = x + submod sigmoid x Pattern torch nn Module __init__ - None super __init__ sigmoid = torch nn Sigmoid submod = torch nn ReLU forward x submod sigmoid x Replacement torch nn Module __init__ - None super __init__ id = torch nn Identity submod = torch nn ReLU forward x submod id x Comparison torch nn Module __init__ - None super __init__ id = torch nn Identity submod = torch nn ReLU forward x x = x + submod id x traced = symbolic_trace M comparison = Comparison x = torch randn subgraph_rewriter replace_pattern traced Pattern Replacement traced graph lint ref_outs = comparison x test_outs = traced forward x assertEqual ref_outs test_outs traced get_submodule id assertRaisesRegex AttributeError has no attribute traced get_submodule sigmoid submod = traced get_submodule submod assertEqual type submod torch nn ReLU test_subgraph_rewriter_annotations_int M torch nn Module forward x y int = x torch add x y M torch nn Module forward x y = annotate x int torch add x y ast_rewriter = RewritingTracer graph = ast_rewriter trace M module = M symbolic_traced torch fx GraphModule = symbolic_trace module n m zip symbolic_traced graph nodes graph nodes n op == placeholder assert n type int assert m type int test_subgraph_writer_replace_consecutive_submodules f x x = torch sigmoid x x = torch sigmoid x torch sigmoid x pattern x torch sigmoid x replacement x torch exp x comparison x x = torch exp x x = torch exp x torch exp x traced = symbolic_trace f comparison_fn = symbolic_trace comparison x = torch randn subgraph_rewriter replace_pattern traced pattern replacement traced graph lint ref_outs = comparison_fn x test_outs = traced forward x assertEqual ref_outs test_outs
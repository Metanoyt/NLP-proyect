Owner s module inductor contextlib sys unittest torch torch _inductor config torch testing _internal common_utils instantiate_parametrized_tests MACOS_VERSION parametrize torch testing _internal inductor_utils GPU_TYPE RUN_CPU RUN_GPU try try test_torchinductor except ImportError test_torchinductor manual=fbcode caffe test inductor test_inductor-library except unittest SkipTest __name__ == __main__ sys exit raise TestCase = test_torchinductor TestCase check_model = test_torchinductor check_model check_model_gpu = test_torchinductor check_model_gpu skip_if_cpp_wrapper = test_torchinductor skip_if_cpp_wrapper copy_tests = test_torchinductor copy_tests define_custom_op_for_test = test_torchinductor define_custom_op_for_test instantiate_parametrized_tests CommonTemplate test_unaligned_input fn x torch nn functional relu x x = torch randn + device=self device - TODO malfet Investigate failures MacOS- contextlib nullcontext device = mps MACOS_VERSION = assertRaises AssertionError common fn x check_lowp=False test_unaligned_input_ d fn x torch nn functional relu x x = torch randn + device=self device - common fn x check_lowp=False test_alignment_without_custom_op fn x = torch nn functional relu x b = - c = torch cos b c x = torch randn + device=self device common fn x check_lowp=False config patch implicit_fallbacks=True test_no_align_for_custom_op slice d x x - slice d_meta x torch empty_like x - define_custom_op_for_test slice d slice d slice d_meta fn x = torch nn functional relu x b = torch ops test slice d c = torch cos b c x = torch randn + device=self device common fn x check_lowp=False config patch implicit_fallbacks=True test_no_align_for_custom_op_ d slice d x x - slice d_meta x torch empty_like x - define_custom_op_for_test slice d slice d slice d_meta fn x = torch nn functional relu x b = torch ops test slice d c = torch cos b c x = torch randn + device=self device common fn x check_lowp=False config patch implicit_fallbacks=True alignment_asserts=True skip_if_cpp_wrapper Inductor does generate alignment assertion cpp_wrapper right now test_incorrect_meta_for_custom_op_ d slice d x x - slice d_meta x torch empty_like x - define_custom_op_for_test slice d_incorrect_meta slice d slice d_meta fn x = torch nn functional relu x b = torch ops test slice d_incorrect_meta c = torch cos b c x = torch randn + device=self device expected_error = Expect tensor bytes aligned Fail due storage_offset= itemsize= assertRaisesRegex AssertionError expected_error common fn x check_lowp=False test_slice f x x + x = torch randn device=self device common f x test_view_dtype_slice f x x view dtype=torch float + x = torch randn dtype=torch bfloat device=self device common f x reference_in_float=False parametrize size wrapper size = https gist github com shunting f e b fc e aaa e ptx https gist github com shunting eb ee eef f b b e ad c ptx file uses ld global b load input buffer wrapper size = https gist github com shunting d f e f f b e ec e ce ptx https gist github com shunting ff bb b d b ab f b ptx file uses ld global v b load input buffer wrapper size = https gist github com shunting b cf b e c f c d ed ba ptx https gist github com shunting c b c fc ptx file uses ld global v b load input buffer test_slice_view_dtype size offset = f x x view dtype=torch float + x = torch randn size + offset dtype=torch bfloat device=self device common f x reference_in_float=False test_Q _K_dequantization Test alignment issue Q _K dequantization QK_K = K_SCALE_SIZE = get_scale_min scales n_blocks = scales shape scales = scales view torch uint scales = scales reshape n_blocks d m m_d = torch split scales scales shape - dim=- sc = torch cat d x F m_d x F &#124; d x dim=- min = torch cat m x F m_d &#124; m x dim=- sc reshape n_blocks min reshape n_blocks split_block_dims blocks args n_max = blocks shape dims = list args + n_max - sum args torch split blocks dims dim= dequantize_blocks_Q _K blocks block_size type_size n_blocks = blocks shape d dmin scales qs = split_block_dims blocks K_SCALE_SIZE d = d view torch float dmin = dmin view torch float sc m = get_scale_min scales d = d sc reshape n_blocks - dm = dmin m reshape n_blocks - qs = qs reshape n_blocks - torch tensor device=d device dtype=torch uint reshape qs = qs x F reshape n_blocks - d qs - dm reshape n_blocks QK_K data = torch randint device=self device dtype=torch uint dequantize data block_size type_size = rows = data reshape - data shape - view torch uint n_blocks = rows numel type_size blocks = rows reshape n_blocks type_size blocks = dequantize_blocks_Q _K blocks block_size type_size blocks reshape common dequantize data check_lowp=False atol= e- rtol= e- RUN_CPU CpuTests TestCase common = check_model device = cpu copy_tests CommonTemplate CpuTests cpu RUN_GPU GPUTests TestCase common = check_model_gpu device = GPU_TYPE copy_tests CommonTemplate GPUTests GPU_TYPE __name__ == __main__ torch _inductor test_case run_tests RUN_CPU RUN_GPU run_tests
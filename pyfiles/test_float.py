======= BEGIN Dynamo patch ======= Owner s module dynamo ruff noqa flake noqa Test copied https raw githubusercontent com python cpython refs tags v Lib test test_float py sys torch torch _dynamo test_case unittest torch _dynamo test_case CPythonTestCase torch testing _internal common_utils run_tests __TestCase = CPythonTestCase redirect statements sys importlib abc redirect_imports = test mapping_tests test typinganndata test test_grammar test test_math test test_iter test typinganndata ann_module RedirectImportFinder importlib abc MetaPathFinder find_spec fullname path target=None Check problematic one fullname redirect_imports try Attempt standalone module name = fullname removeprefix test r = importlib import_module name Redirect module sys modules sys modules fullname = r Return module spec found module importlib util find_spec name except ImportError None None Add custom finder sys meta_path sys meta_path insert RedirectImportFinder ======= END DYNAMO PATCH ======= fractions operator os random sys struct time unittest test support VALID_UNDERSCORE_LITERALS = _ _ _ _ _ b _ xffff_ffff o _ _ _ _ _ _ e _ _ e _ e _ _ _ e b_ x_f o_ _ _ j _ _ j _ _ e _ j _ j _ + _ j _ j INVALID_UNDERSCORE_LITERALS = Trailing underscores _ _ j_ x_ b _ xf_ o _ _Else Underscores base selector _b _xf _o Old-style octal still disallowed _ _ Multiple consecutive underscores _______ __ __ j b __ xffff__ffff x___ o __ e __ e __ j Underscore right before dot _ _ j Underscore right after dot _ _ j _ _ j Underscore right after sign e+_ e+_ j Underscore right before j _j e _j Underscore right before e _e _e _e j Underscore right after e e_ e_ e_ j Complex cases parens + _j_ + _j math isinf isnan copysign ldexp math try _testcapi except ImportError _testcapi = None INF = float inf NAN = float nan #locate file float format test values test_dir = os path dirname __file__ os curdir format_testfile = os path join test_dir mathdata formatfloat_testcases txt FloatSubclass float pass OtherFloatSubclass float pass GeneralFloatCases __TestCase test_float assertEqual float assertEqual float assertEqual float assertRaises ValueError float x assertRaises ValueError float - x p- assertRaises ValueError float + x p- assertRaises ValueError float ++ assertRaises ValueError float +- assertRaises ValueError float -+ assertRaises ValueError float -- assertRaises ValueError float nan assertRaises ValueError float + inf assertRaises ValueError float assertRaises ValueError float - assertRaises TypeError float assertRaisesRegex TypeError dict float Lone surrogate assertRaises ValueError float \uD F check we don t accept alternate exponent markers assertRaises ValueError float - d assertRaises ValueError float D- assertEqual float \u \u \u assertEqual float \N EM SPACE \N EN SPACE extra long strings should problem float b + b float + Invalid unicode string See bpo- assertRaises ValueError float \u \u \u b\u \u f test_noargs assertEqual float test_underscores lit VALID_UNDERSCORE_LITERALS any ch lit ch jJxXoObB assertEqual float lit eval lit assertEqual float lit float lit replace _ lit INVALID_UNDERSCORE_LITERALS lit _ _ octals recognized here continue any ch lit ch jJxXoObB assertRaises ValueError float lit Additional test cases nan inf never valid literals only float constructor we don t allow underscores around them assertRaises ValueError float _NaN assertRaises ValueError float Na_N assertRaises ValueError float IN_F assertRaises ValueError float -_INF assertRaises ValueError float -INF_ Check we handle bytes values correctly assertRaises ValueError float b _ \xff test_non_numeric_input_types Test possible non-numeric types argument x including subclasses explicitly documented accepted types torch _dynamo error_on_graph_break False CustomStr str pass CustomBytes bytes pass CustomByteArray bytearray pass factories = bytes bytearray lambda b CustomStr b decode CustomBytes CustomByteArray memoryview try array array except ImportError pass factories append lambda b array B b f factories x = f b subTest type x assertEqual float x assertRaisesRegex ValueError could convert float f b A x test_float_memoryview assertEqual float memoryview b assertEqual float memoryview b \x assertEqual float memoryview b assertEqual float memoryview b A assertEqual float memoryview b test_error_message check s assertRaises ValueError msg= float r s cm float s assertEqual str cm exception could convert string float r s check \xbd check \xbd check check b all whitespace cf https github com python cpython issues check check check \t \n non-ascii digits error came non-digit check \u \u \u embedded NUL check \x check \x check \x byte string embedded NUL check b \x non-UTF- byte string check b \xa support run_with_locale LC_NUMERIC fr_FR de_DE test_float_with_comma set locale something doesn t use decimal point float must accept locale specific decimal point still has accept normal python syntax locale locale localeconv decimal_point == skipTest decimal_point assertEqual float assertEqual float + assertEqual float - - assertEqual float assertEqual float assertEqual float e assertEqual float e assertEqual float e- assertEqual float e- assertRaises ValueError float assertRaises ValueError float + assertRaises ValueError float - assertRaises ValueError float x assertRaises ValueError float - x p- assertRaises ValueError float + x p- assertEqual float e- assertAlmostEqual float e- test_floatconversion Make sure calls __float__ work properly torch _dynamo error_on_graph_break False Foo object __float__ Foo float __float__ Foo float __new__ cls value= float __new__ cls value __float__ Foo float __float__ Issue __float__ called str subclasses though unicode subclasses FooStr str __float__ float str + assertEqual float Foo assertEqual float Foo assertWarns DeprecationWarning assertEqual float Foo assertRaises TypeError float Foo assertEqual float FooStr torch _dynamo error_on_graph_break False Foo __float__ assertRaises TypeError time sleep Foo torch _dynamo error_on_graph_break False Issue F __float__ OtherFloatSubclass assertWarns DeprecationWarning assertEqual float F assertWarns DeprecationWarning assertIs type float F float assertWarns DeprecationWarning assertEqual FloatSubclass F assertWarns DeprecationWarning assertIs type FloatSubclass F FloatSubclass torch _dynamo error_on_graph_break False MyIndex __init__ value value = value __index__ value assertEqual float MyIndex assertRaises OverflowError float MyIndex torch _dynamo error_on_graph_break False MyInt __int__ assertRaises TypeError float MyInt test_keyword_args assertRaisesRegex TypeError keyword argument float x= test_keywords_in_subclass torch _dynamo error_on_graph_break False subclass float pass u = subclass assertIs type u subclass assertEqual float u assertRaises TypeError subclass x= torch _dynamo error_on_graph_break False subclass_with_init float __init__ arg newarg=None newarg = newarg u = subclass_with_init newarg= assertIs type u subclass_with_init assertEqual float u assertEqual u newarg torch _dynamo error_on_graph_break False subclass_with_new float __new__ cls arg newarg=None = super __new__ cls arg newarg = newarg u = subclass_with_new newarg= assertIs type u subclass_with_new assertEqual float u assertEqual u newarg test_is_integer assertFalse is_integer assertTrue is_integer assertFalse float nan is_integer assertFalse float inf is_integer test_floatasratio f ratio - - assertEqual f as_integer_ratio ratio i range f = random random f = random randint - n d = f as_integer_ratio assertEqual float n __truediv__ d f R = fractions Fraction assertEqual R R float as_integer_ratio assertEqual R R float as_integer_ratio assertEqual R R float as_integer_ratio assertEqual R R float as_integer_ratio assertEqual R - R float - as_integer_ratio assertEqual R - R float - as_integer_ratio assertRaises OverflowError float inf as_integer_ratio assertRaises OverflowError float -inf as_integer_ratio assertRaises ValueError float nan as_integer_ratio test_float_containment floats = INF -INF NAN f floats assertIn f f assertIn f f assertIn f f assertIn f f None assertEqual f count f count r = f assertIn f floats f floats nonidentical containers same type same contents assertTrue f == f r = r f f assertTrue f == f r = r f f assertTrue f == f r = r f f assertTrue f None == f None r None = r None f f identical containers l t s d = f f f f None assertTrue l == l r equal itself f assertTrue t == t r equal itself f assertTrue s == s r equal itself f assertTrue d == d r None equal itself f assertEqualAndEqualSign b fail unless == b b have same sign bit only difference assertEqual test distinguishes - assertEqual copysign b copysign b test_float_floor assertIsInstance float __floor__ int assertEqual float __floor__ assertEqual float __floor__ assertEqual float __floor__ assertEqual float - __floor__ - assertEqual float - __floor__ - assertEqual float - __floor__ - assertEqual float e __floor__ e assertEqual float - e __floor__ - e assertRaises ValueError float nan __floor__ assertRaises OverflowError float inf __floor__ assertRaises OverflowError float -inf __floor__ test_float_ceil assertIsInstance float __ceil__ int assertEqual float __ceil__ assertEqual float __ceil__ assertEqual float __ceil__ assertEqual float - __ceil__ assertEqual float - __ceil__ - assertEqual float - __ceil__ - assertEqual float e __ceil__ e assertEqual float - e __ceil__ - e assertRaises ValueError float nan __ceil__ assertRaises OverflowError float inf __ceil__ assertRaises OverflowError float -inf __ceil__ support requires_IEEE_ test_float_mod Check behaviour operator IEEE special cases In particular check signs zeros mod = operator mod assertEqualAndEqualSign mod - assertEqualAndEqualSign mod - e- assertEqualAndEqualSign mod - assertEqualAndEqualSign mod assertEqualAndEqualSign mod e- e- assertEqualAndEqualSign mod assertEqualAndEqualSign mod - - - assertEqualAndEqualSign mod - e- - - e- assertEqualAndEqualSign mod - - - assertEqualAndEqualSign mod - - assertEqualAndEqualSign mod e- - - assertEqualAndEqualSign mod - - support requires_IEEE_ test_float_pow test builtin pow operator IEEE special cases Special cases taken section F C specification pow_op pow operator pow x NAN NAN any x except assertTrue isnan pow_op -INF NAN assertTrue isnan pow_op - NAN assertTrue isnan pow_op - NAN assertTrue isnan pow_op - NAN assertTrue isnan pow_op - NAN assertTrue isnan pow_op NAN assertTrue isnan pow_op NAN assertTrue isnan pow_op NAN assertTrue isnan pow_op INF NAN assertTrue isnan pow_op NAN NAN NAN y NAN any y except +- assertTrue isnan pow_op NAN -INF assertTrue isnan pow_op NAN - assertTrue isnan pow_op NAN - assertTrue isnan pow_op NAN - assertTrue isnan pow_op NAN assertTrue isnan pow_op NAN assertTrue isnan pow_op NAN assertTrue isnan pow_op NAN INF +- y raises ZeroDivisionError y negative odd integer assertRaises ZeroDivisionError pow_op - - assertRaises ZeroDivisionError pow_op - +- y raises ZeroDivisionError y finite negative odd integer assertRaises ZeroDivisionError pow_op - - assertRaises ZeroDivisionError pow_op - - assertRaises ZeroDivisionError pow_op - assertRaises ZeroDivisionError pow_op - +- y +- y positive odd integer assertEqualAndEqualSign pow_op - - assertEqualAndEqualSign pow_op +- y y finite positive odd integer assertEqualAndEqualSign pow_op - assertEqualAndEqualSign pow_op - assertEqualAndEqualSign pow_op assertEqualAndEqualSign pow_op - +-inf assertEqualAndEqualSign pow_op - -INF assertEqualAndEqualSign pow_op - INF y any y even y infinity nan assertEqualAndEqualSign pow_op -INF assertEqualAndEqualSign pow_op - assertEqualAndEqualSign pow_op - assertEqualAndEqualSign pow_op - assertEqualAndEqualSign pow_op - assertEqualAndEqualSign pow_op assertEqualAndEqualSign pow_op assertEqualAndEqualSign pow_op assertEqualAndEqualSign pow_op assertEqualAndEqualSign pow_op INF assertEqualAndEqualSign pow_op NAN x +- any x even x zero infinity nan assertEqualAndEqualSign pow_op -INF assertEqualAndEqualSign pow_op - assertEqualAndEqualSign pow_op - assertEqualAndEqualSign pow_op - assertEqualAndEqualSign pow_op - assertEqualAndEqualSign pow_op assertEqualAndEqualSign pow_op assertEqualAndEqualSign pow_op assertEqualAndEqualSign pow_op assertEqualAndEqualSign pow_op INF assertEqualAndEqualSign pow_op NAN assertEqualAndEqualSign pow_op -INF - assertEqualAndEqualSign pow_op - - assertEqualAndEqualSign pow_op - - assertEqualAndEqualSign pow_op - - assertEqualAndEqualSign pow_op - - assertEqualAndEqualSign pow_op - assertEqualAndEqualSign pow_op - assertEqualAndEqualSign pow_op - assertEqualAndEqualSign pow_op - assertEqualAndEqualSign pow_op INF - assertEqualAndEqualSign pow_op NAN - x y defers complex pow finite negative x non-integral y assertEqual type pow_op - - complex assertEqual type pow_op - complex assertEqual type pow_op - - complex assertEqual type pow_op - complex assertEqual type pow_op - - complex assertEqual type pow_op - complex x -INF INF abs x assertEqualAndEqualSign pow_op - -INF INF assertEqualAndEqualSign pow_op - -INF INF assertEqualAndEqualSign pow_op -INF INF assertEqualAndEqualSign pow_op -INF INF x -INF abs x assertEqualAndEqualSign pow_op -INF -INF assertEqualAndEqualSign pow_op - -INF assertEqualAndEqualSign pow_op -INF assertEqualAndEqualSign pow_op INF -INF x INF abs x assertEqualAndEqualSign pow_op - INF assertEqualAndEqualSign pow_op - INF assertEqualAndEqualSign pow_op INF assertEqualAndEqualSign pow_op INF x INF INF abs x assertEqualAndEqualSign pow_op -INF INF INF assertEqualAndEqualSign pow_op - INF INF assertEqualAndEqualSign pow_op INF INF assertEqualAndEqualSign pow_op INF INF INF -INF y - y negative odd integer assertEqualAndEqualSign pow_op -INF - - -INF y y negative odd integer assertEqualAndEqualSign pow_op -INF - assertEqualAndEqualSign pow_op -INF - -INF y -INF y positive odd integer assertEqualAndEqualSign pow_op -INF -INF -INF y INF y positive odd integer assertEqualAndEqualSign pow_op -INF INF assertEqualAndEqualSign pow_op -INF INF INF y INF y positive assertEqualAndEqualSign pow_op INF INF assertEqualAndEqualSign pow_op INF INF assertEqualAndEqualSign pow_op INF INF INF y y negative assertEqualAndEqualSign pow_op INF - assertEqualAndEqualSign pow_op INF - assertEqualAndEqualSign pow_op INF - basic checks covered special cases above assertEqualAndEqualSign pow_op - - assertEqualAndEqualSign pow_op - - - assertEqualAndEqualSign pow_op - - assertEqualAndEqualSign pow_op - assertEqualAndEqualSign pow_op - - assertEqualAndEqualSign pow_op - assertEqualAndEqualSign pow_op - - assertEqualAndEqualSign pow_op - - - assertEqualAndEqualSign pow_op - - assertEqualAndEqualSign pow_op - assertEqualAndEqualSign pow_op - - assertEqualAndEqualSign pow_op - assertEqualAndEqualSign pow_op - assertEqualAndEqualSign pow_op - assertEqualAndEqualSign pow_op - assertEqualAndEqualSign pow_op assertEqualAndEqualSign pow_op assertEqualAndEqualSign pow_op large - large some libms apparently have problems these assertEqualAndEqualSign pow_op - e assertEqualAndEqualSign pow_op e assertEqualAndEqualSign pow_op - - e assertEqualAndEqualSign pow_op - e check sign results underflow assertEqualAndEqualSign pow_op - - assertEqual type pow_op - - complex assertEqualAndEqualSign pow_op - - - assertEqualAndEqualSign pow_op - assertEqualAndEqualSign pow_op - assertEqualAndEqualSign pow_op - assertEqualAndEqualSign pow_op - assertEqual type pow_op - complex assertEqualAndEqualSign pow_op - - assertEqualAndEqualSign pow_op assertEqualAndEqualSign pow_op assertEqualAndEqualSign pow_op check we don t raise exception subnormal results validate signs Tests currently disabled since they fail systems where subnormal result pow flushed zero e g Debian ia #self assertTrue pow_op e- #self assertTrue pow_op - e- #self assertTrue pow_op e- #self assertTrue pow_op - - e- #self assertTrue pow_op - e- #self assertTrue pow_op - - e- #self assertTrue pow_op - e- #self assertTrue pow_op - - - e- test_hash x range - assertEqual hash float x hash x assertEqual hash float sys float_info max hash int sys float_info max assertEqual hash float inf sys hash_info inf assertEqual hash float -inf -sys hash_info inf test_hash_nan value = float nan assertEqual hash value object __hash__ value torch _dynamo error_on_graph_break False H __hash__ F float H pass value = F nan assertEqual hash value object __hash__ value unittest skipUnless hasattr float __getformat__ requires __getformat__ FormatFunctionsTestCase __TestCase test_getformat assertIn float __getformat__ double unknown IEEE big-endian IEEE little-endian assertIn float __getformat__ float unknown IEEE big-endian IEEE little-endian assertRaises ValueError float __getformat__ chicken assertRaises TypeError float __getformat__ BE_DOUBLE_INF = b \x f\xf \x \x \x \x \x \x LE_DOUBLE_INF = bytes reversed BE_DOUBLE_INF BE_DOUBLE_NAN = b \x f\xf \x \x \x \x \x \x LE_DOUBLE_NAN = bytes reversed BE_DOUBLE_NAN BE_FLOAT_INF = b \x f\x \x \x LE_FLOAT_INF = bytes reversed BE_FLOAT_INF BE_FLOAT_NAN = b \x f\xc \x \x LE_FLOAT_NAN = bytes reversed BE_FLOAT_NAN IEEE platform all we guarantee bit patterns representing infinities NaNs do raise exception all accident today let s also try guarantee - don t get confused IEEEFormatTestCase __TestCase support requires_IEEE_ test_double_specials_do_unpack fmt data d BE_DOUBLE_INF d BE_DOUBLE_NAN d LE_DOUBLE_INF d LE_DOUBLE_NAN struct unpack fmt data support requires_IEEE_ test_float_specials_do_unpack fmt data f BE_FLOAT_INF f BE_FLOAT_NAN f LE_FLOAT_INF f LE_FLOAT_NAN struct unpack fmt data support requires_IEEE_ unittest skipIf _testcapi None needs _testcapi test_serialized_float_rounding FLT_MAX = _testcapi FLT_MAX assertEqual struct pack f e struct pack f FLT_MAX assertEqual struct pack f - e struct pack f -FLT_MAX FormatTestCase __TestCase test_format these should rewritten use both format x spec x __format__ spec assertEqual format f default g except empty format spec assertEqual format assertEqual format assertEqual format g empty presentation type should format same way str issue x = assertEqual format x str x assertEqual format x - str x assertEqual format x str x assertEqual format x str x assertEqual format f assertEqual format - f - assertEqual format f assertEqual format - f - assertEqual format +f + assertEqual format - +f - formatting assertEqual format - - conversion string should fail assertRaises ValueError format s confirm format options expected fail floats such integer presentation types format_spec sbcdoxX assertRaises ValueError format format_spec assertRaises ValueError format format_spec assertRaises ValueError format - format_spec assertRaises ValueError format e format_spec assertRaises ValueError format - e format_spec assertRaises ValueError format e- format_spec assertRaises ValueError format - e- format_spec issue assertEqual format NAN f nan assertEqual format NAN F NAN assertEqual format INF f inf assertEqual format INF F INF support requires_IEEE_ test_format_testfile open format_testfile encoding= utf- testfile line testfile line startswith -- continue line = line strip line continue lhs rhs = map str strip line split - fmt arg = lhs split f = float arg assertEqual fmt f rhs assertEqual fmt -f - + rhs fmt = r fmt = fmt assertEqual format f fmt rhs assertEqual format -f fmt - + rhs test_issue assertEqual format assertEqual format e+ assertEqual format e+ test_issue assertEqual format assertEqual format f assertEqual format e e+ assertEqual format g assertEqual format f assertEqual format e e+ assertEqual format g assertEqual format f assertEqual format - - assertEqual format - f - assertEqual format - e - e+ assertEqual format - g - assertEqual format - f - assertEqual format - f - assertEqual format - e - e+ assertEqual format - g - ReprTestCase __TestCase test_repr open os path join os path split __file__ mathdata floating_points txt encoding= utf- floats_file line floats_file line = line strip line line startswith continue v = eval line assertEqual v eval repr v unittest skipUnless getattr sys float_repr_style == short applies only when using short float repr style test_short_repr test short float repr introduced Python One aspect repr we get some degree str - float - str roundtripping In particular any numeric string containing fewer significant digits those exact same digits modulo trailing zeros should appear output No more repr - test_strings = output always includes either decimal point least one digit after point exponent values = e get exponent e+ e+ so do values e- e- e- values designed provoke failure FPU rounding precision isn t set correctly e+ e+ e+ e+ e+ s test_strings negs = - +s assertEqual s repr float s assertEqual negs repr float negs Since Python repr str identical assertEqual repr float s str float s assertEqual repr float negs str float negs support requires_IEEE_ RoundTestCase __TestCase assertFloatsAreIdentical x y assert floats x y identical sense both x y nans both x y infinities same sign both x y zeros same sign x y both finite nonzero x == y msg = floats r r identical isnan x isnan y isnan x isnan y x == y x = both zero check signs match copysign x == copysign y msg += zeros have different signs fail msg format x y test_inf_nan assertRaises OverflowError round INF assertRaises OverflowError round -INF assertRaises ValueError round NAN assertRaises TypeError round INF assertRaises TypeError round -INF assertRaises TypeError round NAN ceci n est pas un integer assertRaises TypeError round - j test_inf_nan_ndigits assertEqual round INF INF assertEqual round -INF -INF assertTrue math isnan round NAN test_large_n n - assertEqual round n assertEqual round - n - assertEqual round e n e assertEqual round e- n e- assertEqual round e e assertEqual round e e assertEqual round - - assertEqual round e e assertEqual round e- e- test_small_n n - - - - - - - - assertFloatsAreIdentical round n assertFloatsAreIdentical round - n - assertFloatsAreIdentical round e n assertFloatsAreIdentical round e- n test_overflow assertRaises OverflowError round e - assertRaises OverflowError round - e - unittest skipUnless getattr sys float_repr_style == short applies only when using short float repr style test_previous_round_bugs particular cases have occurred bug reports assertEqual round assertEqual round round-half-even assertEqual round - assertEqual round - assertEqual round - assertEqual round - assertEqual round - assertEqual round - assertEqual round - assertEqual round - unittest skipUnless getattr sys float_repr_style == short applies only when using short float repr style test_matches_float_format round should give same results float formatting i range x = i assertEqual float format x f round x assertEqual float format x f round x assertEqual float format x f round x assertEqual float format x f round x i range x = i assertEqual float format x f round x assertEqual float format x f round x assertEqual float format x f round x assertEqual float format x f round x i range x = random random assertEqual float format x f round x assertEqual float format x f round x assertEqual float format x f round x assertEqual float format x f round x test_format_specials Test formatting nans infs test fmt value expected Test both format assertEqual fmt value expected fmt fmt = fmt strip off assertEqual format value fmt expected fmt fmt e f g e f g #e #f #g e f g pfmt = + + fmt sfmt = + fmt test fmt INF inf test fmt -INF -inf test fmt NAN nan test fmt -NAN nan When asking sign s always provided nans always positive test pfmt INF +inf test pfmt -INF -inf test pfmt NAN +nan test pfmt -NAN +nan When using sign code only infs can negative Others have space test sfmt INF inf test sfmt -INF -inf test sfmt NAN nan test sfmt -NAN nan test_None_ndigits x round round None round ndigits=None assertEqual x assertIsInstance x int x round round None round ndigits=None assertEqual x assertIsInstance x int Beginning Python float has cross platform compatible ways create represent inf nan InfNanTest __TestCase test_inf_from_str assertTrue isinf float inf assertTrue isinf float +inf assertTrue isinf float -inf assertTrue isinf float infinity assertTrue isinf float +infinity assertTrue isinf float -infinity assertEqual repr float inf inf assertEqual repr float +inf inf assertEqual repr float -inf -inf assertEqual repr float infinity inf assertEqual repr float +infinity inf assertEqual repr float -infinity -inf assertEqual repr float INF inf assertEqual repr float +Inf inf assertEqual repr float -iNF -inf assertEqual repr float Infinity inf assertEqual repr float +iNfInItY inf assertEqual repr float -INFINITY -inf assertEqual str float inf inf assertEqual str float +inf inf assertEqual str float -inf -inf assertEqual str float infinity inf assertEqual str float +infinity inf assertEqual str float -infinity -inf assertRaises ValueError float info assertRaises ValueError float +info assertRaises ValueError float -info assertRaises ValueError float assertRaises ValueError float +in assertRaises ValueError float -in assertRaises ValueError float infinit assertRaises ValueError float +Infin assertRaises ValueError float -INFI assertRaises ValueError float infinitys assertRaises ValueError float ++Inf assertRaises ValueError float -+inf assertRaises ValueError float +-infinity assertRaises ValueError float -- Infinity test_inf_as_str assertEqual repr e e inf assertEqual repr - e e -inf assertEqual str e e inf assertEqual str - e e -inf test_nan_from_str assertTrue isnan float nan assertTrue isnan float +nan assertTrue isnan float -nan assertEqual repr float nan nan assertEqual repr float +nan nan assertEqual repr float -nan nan assertEqual repr float NAN nan assertEqual repr float +NAn nan assertEqual repr float -NaN nan assertEqual str float nan nan assertEqual str float +nan nan assertEqual str float -nan nan assertRaises ValueError float nana assertRaises ValueError float +nana assertRaises ValueError float -nana assertRaises ValueError float na assertRaises ValueError float +na assertRaises ValueError float -na assertRaises ValueError float ++nan assertRaises ValueError float -+NAN assertRaises ValueError float +-NaN assertRaises ValueError float -- nAn test_nan_as_str assertEqual repr e e nan assertEqual repr - e e nan assertEqual str e e nan assertEqual str - e e nan test_inf_signs assertEqual copysign float inf assertEqual copysign float -inf - test_nan_signs The sign float nan should predictable assertEqual copysign float nan assertEqual copysign float -nan - fromHex = float fromhex toHex = float hex HexFloatTestCase __TestCase MAX = fromHex x fffffffffffff p+ max normal MIN = fromHex x p- min normal TINY = fromHex x p- min subnormal EPS = fromHex x p diff between next float up assertFloatsAreIdentical x y assert floats x y identical sense both x y nans both x y infinities same sign both x y zeros same sign x y both finite nonzero x == y msg = floats r r identical isnan x isnan y isnan x isnan y x == y x = both zero check signs match copysign x == copysign y msg += zeros have different signs fail msg format x y identical x y assertFloatsAreIdentical x y test_ends identical MIN ldexp - identical TINY ldexp - identical EPS ldexp - identical MAX ldexp - ldexp test_invalid_inputs invalid_inputs = infi misspelt infinities nans -Infinit ++inf -+Inf -- nan +-NaN snan NaNs nna nf nfinity inity iinity xnan x p xX p + x p internal whitespace - x p x p x p x p + x p x p - x p - x p + x p + x p - x p + x p+ - x p- ++ x p- double signs -- x p +- x p+ -+ x p x p++ + x p+- - x p-+ x p -- x p x p no hex digits before after point x p wrong decimal point character x pa x p\uff fullwidth Unicode digits \uff x p x\uff p x \uff p x p \n x p x p \ x p embedded null byte end string x invalid_inputs try result = fromHex x except ValueError pass fail Expected float fromhex r raise ValueError got r instead x result test_whitespace value_pairs = inf INF -Infinity -INF nan NAN - x - - - whitespace = \t \n \n \t \f \v \r inp expected value_pairs lead whitespace trail whitespace got = fromHex lead + inp + trail identical got expected test_from_hex MIN = MIN MAX = MAX TINY = TINY EPS = EPS two spellings infinity optional signs case-insensitive identical fromHex inf INF identical fromHex +Inf INF identical fromHex -INF -INF identical fromHex iNf INF identical fromHex Infinity INF identical fromHex +INFINITY INF identical fromHex -infinity -INF identical fromHex -iNFiNitY -INF nans optional sign case insensitive identical fromHex nan NAN identical fromHex +NaN NAN identical fromHex -NaN NAN identical fromHex -nAN NAN variations input format identical fromHex identical fromHex + identical fromHex identical fromHex identical fromHex p identical fromHex identical fromHex identical fromHex x identical fromHex x identical fromHex x identical fromHex + x identical fromHex x p identical fromHex X p identical fromHex X P identical fromHex x P identical fromHex x p identical fromHex x p identical fromHex x p identical fromHex x p identical fromHex x p identical fromHex x p+ identical fromHex x P- identical fromHex + x p identical fromHex x p identical fromHex x p identical fromHex x p identical fromHex \n x p identical fromHex x p \t identical fromHex xap identical fromHex xAp identical fromHex xaP identical fromHex xAP identical fromHex xbep identical fromHex xBep identical fromHex xbEp identical fromHex XBE P- identical fromHex xBEp identical fromHex xB Ep identical fromHex x BEp identical fromHex x BEp moving point around pi = fromHex x fb d p identical fromHex x ed b p pi identical fromHex x c fdaa cp pi identical fromHex x fb d p pi identical fromHex x f p pi identical fromHex x ed b p pi identical fromHex x c fdaa cp pi identical fromHex x fb d p pi identical fromHex x f p pi identical fromHex x ed b p pi identical fromHex x c fdaa cp pi identical fromHex x fb d p pi identical fromHex x f p pi identical fromHex x ed b p- pi identical fromHex xc fdaa cp- pi identical fromHex x fb d p- pi identical fromHex x f p- pi identical fromHex x ed b p- pi identical fromHex xc fdaa cp- pi identical fromHex x fb d p- pi identical fromHex x f p- pi identical fromHex x ed b p- pi identical fromHex xc fdaa cp- pi identical fromHex x fb d p- pi identical fromHex x fb d p- pi identical fromHex x f p- pi identical fromHex x ed b p- pi identical fromHex xc fdaa cp- pi identical fromHex x fb d p- pi identical fromHex x f p- pi identical fromHex x ed b p- pi identical fromHex xc fdaa c p- pi identical fromHex x fb d p- pi results should overflow assertRaises OverflowError fromHex - x p assertRaises OverflowError fromHex x p+ assertRaises OverflowError fromHex + X p assertRaises OverflowError fromHex - x p+ assertRaises OverflowError fromHex X p assertRaises OverflowError fromHex + X p+ assertRaises OverflowError fromHex + x p assertRaises OverflowError fromHex - x p assertRaises OverflowError fromHex X p+ assertRaises OverflowError fromHex x p assertRaises OverflowError fromHex - x p+ assertRaises OverflowError fromHex + X p+ assertRaises OverflowError fromHex x ffffffffffffffp+ assertRaises OverflowError fromHex - X fffffffffffff p assertRaises OverflowError fromHex X fffffffffffff p assertRaises OverflowError fromHex + x fffffffffffffp assertRaises OverflowError fromHex x fffffffffffffp+ assertRaises OverflowError fromHex x p assertRaises OverflowError fromHex - Xffffffffffffffffp those round +-max float identical fromHex + x fffffffffffffp+ MAX identical fromHex - X fffffffffffff p -MAX identical fromHex X fffffffffffff fffffffffffffp MAX zeros identical fromHex x p identical fromHex x p identical fromHex - x p - identical fromHex X p identical fromHex - x p - identical fromHex X p identical fromHex x p identical fromHex - X p- - identical fromHex - X p- - identical fromHex x p- identical fromHex - X p- - identical fromHex - x p- - identical fromHex - x p- - identical fromHex X p- identical fromHex - x p- - identical fromHex x p- identical fromHex X p- identical fromHex - X p- - identical fromHex - x p- - values should underflow identical fromHex X p- identical fromHex - X p- - identical fromHex - x p- - identical fromHex x p- TINY identical fromHex - x p- -TINY identical fromHex x fffffffffffffffffp- TINY check round-half-even working correctly near identical fromHex x p- identical fromHex X p- identical fromHex X p- TINY identical fromHex x p- TINY identical fromHex X p- TINY identical fromHex X p- TINY identical fromHex x p- TINY identical fromHex X p- TINY identical fromHex X p- TINY identical fromHex xap- TINY identical fromHex Xbp- TINY identical fromHex xcp- TINY identical fromHex Xdp- TINY identical fromHex Xep- TINY identical fromHex xfp- TINY identical fromHex x p- TINY identical fromHex - x p- - identical fromHex - X p- - identical fromHex - x p- -TINY identical fromHex - X p- -TINY identical fromHex - x p- -TINY identical fromHex - x p- - TINY identical fromHex - X p- - TINY identical fromHex - X p- - TINY identical fromHex - X p- - TINY identical fromHex - Xap- - TINY identical fromHex - xbp- - TINY identical fromHex - xcp- - TINY identical fromHex - Xdp- - TINY identical fromHex - xep- - TINY identical fromHex - Xfp- - TINY identical fromHex - X p- - TINY near MIN identical fromHex x ffffffffffffd p- MIN- TINY identical fromHex x ffffffffffffd p- MIN- TINY identical fromHex x ffffffffffffdap- MIN- TINY identical fromHex x ffffffffffffdcp- MIN- TINY identical fromHex x ffffffffffffdep- MIN- TINY identical fromHex x ffffffffffffe p- MIN- TINY identical fromHex x ffffffffffffe p- MIN- TINY identical fromHex x ffffffffffffe p- MIN- TINY identical fromHex x ffffffffffffe p- MIN- TINY identical fromHex x ffffffffffffe p- MIN- TINY identical fromHex x ffffffffffffeap- MIN-TINY identical fromHex x ffffffffffffecp- MIN-TINY identical fromHex x ffffffffffffeep- MIN-TINY identical fromHex x fffffffffffff p- MIN-TINY identical fromHex x fffffffffffff p- MIN-TINY identical fromHex x fffffffffffff p- MIN-TINY identical fromHex x fffffffffffff p- MIN-TINY identical fromHex x fffffffffffff p- MIN identical fromHex x fffffffffffffap- MIN identical fromHex x fffffffffffffcp- MIN identical fromHex x fffffffffffffep- MIN identical fromHex x p- MIN identical fromHex x p- MIN identical fromHex x p- MIN identical fromHex x p- MIN identical fromHex x p- MIN identical fromHex x ap- MIN+TINY identical fromHex x cp- MIN+TINY identical fromHex x ep- MIN+TINY identical fromHex x p- MIN+TINY identical fromHex x p- MIN+TINY identical fromHex x p- MIN+TINY identical fromHex x p- MIN+TINY identical fromHex x p- MIN+ TINY near identical fromHex x fffffffffffff p -EPS identical fromHex x fffffffffffff p -EPS identical fromHex X fffffffffffff p -EPS identical fromHex x fffffffffffff p -EPS identical fromHex X fffffffffffff p -EPS identical fromHex X fffffffffffff p -EPS identical fromHex X fffffffffffff p -EPS identical fromHex x fffffffffffff p -EPS identical fromHex x fffffffffffff p -EPS identical fromHex X fffffffffffff p -EPS identical fromHex X fffffffffffffap -EPS identical fromHex x fffffffffffffbp -EPS identical fromHex X fffffffffffffcp identical fromHex x fffffffffffffdp identical fromHex X fffffffffffffep identical fromHex x ffffffffffffffp identical fromHex X p identical fromHex X p identical fromHex x p identical fromHex X p identical fromHex x p identical fromHex X p identical fromHex X p identical fromHex X p identical fromHex x ffffffffffffffffffffp identical fromHex x p identical fromHex x p +EPS identical fromHex X p +EPS identical fromHex x ap +EPS identical fromHex x bp +EPS identical fromHex X cp +EPS identical fromHex x dp +EPS identical fromHex x ep +EPS identical fromHex X fp +EPS identical fromHex x p +EPS identical fromHex X p +EPS identical fromHex x p +EPS identical fromHex X p +EPS identical fromHex X p +EPS identical fromHex x p +EPS identical fromHex x p +EPS identical fromHex X p +EPS identical fromHex x ffffffffffffffffffffp +EPS identical fromHex x p + EPS identical fromHex X p + EPS identical fromHex x p + EPS identical fromHex X ap + EPS identical fromHex X bp + EPS identical fromHex x cp + EPS identical fromHex x dp + EPS identical fromHex x ep + EPS identical fromHex X fp + EPS identical fromHex x p + EPS Regression test corner-case bug reported b p o identical fromHex x p- identical fromHex x p- identical fromHex x p- TINY identical fromHex x p- identical fromHex x p- identical fromHex x p- TINY identical fromHex x p- identical fromHex x p- TINY identical fromHex p- identical fromHex p- identical fromHex - p- - identical fromHex + p- test_roundtrip roundtrip x fromHex toHex x x NAN INF MAX MIN MIN-self TINY TINY identical x roundtrip x identical -x roundtrip -x fromHex toHex x should exactly recover x any non-NaN float x random i range e = random randrange - m = random random s = random choice - try x = s ldexp m e except OverflowError pass identical x fromHex toHex x test_subclass torch _dynamo error_on_graph_break False F float __new__ cls value float __new__ cls value + f = F fromhex hex assertIs type f F assertEqual f torch _dynamo error_on_graph_break False F float __init__ value foo = bar f = F fromhex hex assertIs type f F assertEqual f assertEqual getattr f foo none bar __name__ == __main__ run_tests
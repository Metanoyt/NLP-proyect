Owner s oncall distributed copy math pathlib sys typing Any REPO_ROOT = pathlib Path __file__ resolve parent parent parent parent sys path insert str REPO_ROOT tools flight_recorder components builder build_db tools flight_recorder components config_manager JobConfig tools flight_recorder components types COLLECTIVES MatchInfo MatchState tools flight_recorder components utils match_one_event Make sure remove REPO_ROOT after done sys path remove str REPO_ROOT torch testing _internal common_utils run_tests TestCase create_one_event collective_name pg_info input_sizes output_sizes state= scheduled collective_seq_id= p p_seq_id= output_dtypes= float profiling_name f nccl collective_name state state process_group pg_info input_sizes input_sizes output_sizes output_sizes input_dtypes float output_dtypes output_dtypes collective_seq_id str collective_seq_id p p_seq_id str p p_seq_id time_created_ns frames FlightRecorderEventTest TestCase test_match_one_event e = create_one_event all_reduce default scheduled membership = assertEqual match_one_event e e membership state MatchState FULLY_MATCHED e = create_one_event all_gather default scheduled assertEqual match_one_event e e membership state MatchState COLLECTIVE_TYPE_MISMATCH e = create_one_event all_to_all default scheduled e = create_one_event all_to_all default scheduled assertEqual match_one_event e e membership state MatchState UNDECIDED e = create_one_event all_reduce default scheduled assertEqual match_one_event e e membership state MatchState SIZE_OR_SYNTAX_MISMATCH e = create_one_event all_reduce default scheduled assertEqual match_one_event e e membership state MatchState SIZE_OR_SYNTAX_MISMATCH e = create_one_event all_reduce default scheduled assertEqual match_one_event e e membership state MatchState SIZE_OR_SYNTAX_MISMATCH e = create_one_event all_reduce default completed assertEqual match_one_event e e membership state MatchState COLLECTIVE_STATE_MISMATCH e = create_one_event all_reduce default completed output_dtypes= float assertEqual match_one_event e e membership state MatchState COLLECTIVE_DTYPE_MISMATCH e = create_one_event gather default completed output_dtypes= float e = create_one_event gather default completed output_dtypes= assertEqual match_one_event e e membership state MatchState FULLY_MATCHED e = create_one_event gather default completed output_dtypes= assertEqual match_one_event e e membership state MatchState FULLY_MATCHED test_all_events collective sorted COLLECTIVES input_sizes = output_sizes = expectedState = MatchState FULLY_MATCHED collective reduce_scatter _reduce_scatter_base reduce_scatter_tensor_coalesced input_sizes = output_sizes = input_sizes collective all_gather _all_gather_base all_gather_into_tensor_coalesced output_sizes = math prod input_sizes collective == all_to_all expectedState = MatchState UNDECIDED event = create_one_event collective default input_sizes output_sizes scheduled membership = result = match_one_event event event membership state assertEqual result expectedState FlightMatchInfoTest TestCase test_match_info m = MatchInfo MatchState FULLY_MATCHED rank m = MatchInfo MatchState FULLY_MATCHED rank assertEqual m state MatchState FULLY_MATCHED assertEqual m state m state assertEqual str m Error type FULLY_MATCHED rank assertEqual str m Error type FULLY_MATCHED rank LOADED_FR_DETAIL_TEMPLATE dict str dict str Any = dump_file_rank_ entries pg_config name desc default_pg ranks name desc sub_pg ranks rank dump_file_rank_ entries pg_config name desc default_pg ranks name desc sub_pg ranks rank create_one_entry record_id collective_name input_sizes output_sizes state= completed collective_seq_id= p p_seq_id= output_dtypes= float pg_info= default event = create_one_event collective_name pg_info input_sizes output_sizes state collective_seq_id p p_seq_id output_dtypes event update record_id record_id event update is_p p False event FlightRecorderE ETest TestCase testBuildDB config = JobConfig args = config parse_args version = Same version FlightRecorder hpp LOADED_FR_DETAIL_TEMPLATE dump_file_rank_ version = version LOADED_FR_DETAIL_TEMPLATE dump_file_rank_ version = version Test case matched all_reduce case details = copy deepcopy LOADED_FR_DETAIL_TEMPLATE details dump_file_rank_ entries append create_one_entry all_reduce details dump_file_rank_ entries append create_one_entry all_reduce details dump_file_rank_ entries append create_one_entry all_reduce pg_info= sub_pg details dump_file_rank_ entries append create_one_entry all_reduce pg_info= sub_pg db = build_db details args version assertEqual len db collectives assertEqual db collectives record_id assertEqual db collectives collective_name nccl all_reduce assertEqual db collectives pass_check True assertEqual db collectives record_id assertEqual db collectives collective_name nccl all_reduce assertEqual db collectives pass_check True assertEqual db collectives pass_check True Test case matched allreduce_coalesced case details = copy deepcopy LOADED_FR_DETAIL_TEMPLATE details dump_file_rank_ entries append create_one_entry allreduce_coalesced details dump_file_rank_ entries append create_one_entry allreduce_coalesced db = build_db details args version assertEqual len db collectives assertEqual db collectives record_id assertEqual db collectives collective_name nccl allreduce_coalesced assertEqual db collectives pass_check True Test case matched slow path two broadcast coalesce case details = copy deepcopy LOADED_FR_DETAIL_TEMPLATE sequence ID should increase coalesced collectives details dump_file_rank_ entries append create_one_entry broadcast details dump_file_rank_ entries append create_one_entry broadcast details dump_file_rank_ entries append create_one_entry coalesced details dump_file_rank_ entries append create_one_entry broadcast details dump_file_rank_ entries append create_one_entry broadcast details dump_file_rank_ entries append create_one_entry coalesced db = build_db details args version assertEqual len db collectives assertEqual db collectives record_id assertEqual db collectives collective_name nccl coalesced assertEqual db collectives pass_check True Test case mis-matched uneven all-gather case details = copy deepcopy LOADED_FR_DETAIL_TEMPLATE sequence ID should increase coalesced collectives details dump_file_rank_ entries append create_one_entry _broadcast_oop details dump_file_rank_ entries append create_one_entry _broadcast_oop details dump_file_rank_ entries append create_one_entry ALLGATHER_coalesced details dump_file_rank_ entries append create_one_entry _broadcast_oop details dump_file_rank_ entries append create_one_entry _broadcast_oop details dump_file_rank_ entries append create_one_entry ALLGATHER_coalesced db = build_db details args version assertEqual len db collectives assertEqual db collectives record_id assertEqual db collectives collective_name nccl _broadcast_oop assertEqual db collectives pass_check False Test case matched uneven reduce scatter case details = copy deepcopy LOADED_FR_DETAIL_TEMPLATE sequence ID should increase coalesced collectives details dump_file_rank_ entries append create_one_entry _reduce_oop details dump_file_rank_ entries append create_one_entry _reduce_oop details dump_file_rank_ entries append create_one_entry REDUCE_SCATTER_coalesced details dump_file_rank_ entries append create_one_entry _reduce_oop details dump_file_rank_ entries append create_one_entry _reduce_oop details dump_file_rank_ entries append create_one_entry REDUCE_SCATTER_coalesced db = build_db details args version assertEqual len db collectives assertEqual db collectives record_id assertEqual db collectives collective_name nccl REDUCE_SCATTER_coalesced assertEqual db collectives pass_check True Test case empty coalesced call rank case details = copy deepcopy LOADED_FR_DETAIL_TEMPLATE sequence ID should increase coalesced collectives details dump_file_rank_ entries append create_one_entry all_reduce details dump_file_rank_ entries append create_one_entry all_reduce details dump_file_rank_ entries append create_one_entry _reduce_oop details dump_file_rank_ entries append create_one_entry _reduce_oop details dump_file_rank_ entries append create_one_entry REDUCE_SCATTER_coalesced db = build_db details args version assertEqual len db collectives assertEqual db collectives collective_name nccl _reduce_oop assertEqual db collectives record_id assertEqual db collectives pass_check True __name__ == __main__ run_tests
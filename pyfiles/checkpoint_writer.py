Checkpoint writer functionality machine learning models This module provides classes writing checkpoints storage including determining checkpoint layout configuring writer defining hooks custom actions during checkpoint writing process abc logging os concurrent futures Future dataclasses dataclass pathlib Path typing Any Optional torch barriers Barrier types RankInfo STATE_DICT logger = logging getLogger __name__ WriterHook abc ABC Abstract base checkpoint commit hooks A commit hook provides callbacks executed before after checkpoint committed storage This allows custom actions performed specific points checkpoint writing process such metadata updates cleanup operations notifications abc abstractmethod pre_commit path str kwargs dict str Any - None Performs actions before committing checkpoint abc abstractmethod post_commit path str kwargs dict str Any - None Performs actions after committing checkpoint dataclass CheckpointWriterConfig Configuration options CheckpointWriter Attributes write_barrier_timeout_secs Maximum time seconds wait all ranks reach checkpoint barrier before timing out Default seconds write_barrier_timeout_secs int = CheckpointWriter Handles writing state dictionaries storage This responsible writing model state dictionaries storage according specified checkpoint layout It supports synchronization barriers ensure all ranks distributed setting complete their checkpoint operations __init__ config CheckpointWriterConfig rank_info RankInfo barrier Optional Barrier = None commit_hook Optional WriterHook = None Initialize CheckpointWriter Args config Configuration options checkpoint writer rank_info Information about current rank distributed setting barrier Optional synchronization barrier distributed checkpointing Note The barrier should initialized appropriate barrier_prefix timeout_secs parameters commit_hook Optional hook custom actions before after checkpoint commits _config = config _rank_info = rank_info _commit_hook = commit_hook _barrier = barrier write path str state_dict STATE_DICT kwargs dict str Any - Optional Future None Writes state_dict storage Args path str The path write checkpoint state_dict STATE_DICT The state_dict write kwargs Additional keyword arguments passed hooks Returns Optional Future None A future tracking write operation applicable logger debug Writing checkpoint s rank s path _rank_info global_rank dir_path = Path path full_path = dir_path f checkpoint_ _rank_info global_rank pt os makedirs os path dirname full_path exist_ok=True torch save state_dict full_path logger debug Successfully saved checkpoint file s full_path Execute pre-commit hook available commit_hook = _commit_hook commit_hook None logger debug Executing pre-commit hook s path commit_hook pre_commit path kwargs Wait all ranks finish writing barrier available barrier = _barrier barrier None logger info Waiting all ranks barrier timeout ss _config write_barrier_timeout_secs barrier execute_barrier logger info All ranks passed barrier logger info No barrier configured skipping synchronization Execute commit hook available commit_hook None logger debug Executing commit hook s path commit_hook post_commit path kwargs logger info Successfully wrote checkpoint s rank s path _rank_info global_rank None close - None Close writer release any resources This no-op base CheckpointWriter may overridden subclasses need perform cleanup logger debug Closing checkpoint writer
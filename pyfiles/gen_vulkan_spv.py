usr bin env python __future__ annotations argparse array codecs copy glob io os re subprocess sys textwrap dataclasses dataclass itertools product pathlib Path typing Any yaml yaml constructor ConstructorError yaml nodes MappingNode try yaml CLoader Loader except ImportError yaml Loader type ignore assignment misc REPO_ROOT = Path __file__ absolute parent parent sys path append str REPO_ROOT CPP_H_NAME = spv h CPP_SRC_NAME = spv cpp DEFAULT_ENV dict str Any = PRECISION highp FLOAT_IMAGE_FORMAT rgba f INT_IMAGE_FORMAT rgba i UINT_IMAGE_FORMAT rgba ui TYPES_ENV dict str Any = IMAGE_FORMAT float rgba f half rgba f int rgba i uint rgba ui int rgba i uint rgba ui IMAGE_T float image D half image D int iimage D uint uimage D float image D half image D int iimage D uint uimage D SAMPLER_T float sampler D half sampler D int isampler D uint usampler D float sampler D half sampler D int isampler D uint usampler D VEC _T float vec half vec int ivec uint uvec int vec uint uvec T float float half float int int uint uint int int uint uint FUNCS_ENV dict str Any = GET_POS lambda pos pos lambda pos f pos xy extract_filename path str keep_ext bool = True - Any keep_ext os path basename path os path basename path split ############################ SPIR-V Code Generation ############################ https gist github com pypt d fe eb pyrefly ignore invalid-inheritance UniqueKeyLoader Loader construct_mapping node deep=False type ignore no-untyped-def isinstance node MappingNode raise ConstructorError None None f expected mapping node found node id node start_mark mapping = key_node value_node node value key = construct_object key_node deep=deep type ignore no-untyped-call try hash key except TypeError e raise ConstructorError while constructing mapping node start_mark found unacceptable key key_node start_mark e check duplicate keys key mapping raise ConstructorError while constructing mapping node start_mark found duplicate key key_node start_mark value = construct_object value_node deep=deep type ignore no-untyped-call mapping key = value mapping https github com google XNNPACK blob master tools xngen py extract_leading_whitespace line str - str match = re match r \s line match group match https github com google XNNPACK blob master tools xngen py escape line str - str output_parts = while $ line start_pos = line index $ end_pos = line index start_pos + start_pos = output_parts append + line start_pos replace \\ + output_parts append str + line start_pos + end_pos + line = line end_pos + line output_parts append + line replace \\ + + join output_parts https github com google XNNPACK blob master tools xngen py preprocess input_text str variables dict str Any input_path str = codegen - str input_lines = input_text splitlines python_lines = blank_lines = last_indent = List tuples total_index python_indent indent_stack = Indicates whether first line inside Python code block i e while python_block_start = True input_line input_lines input_line == blank_lines += continue Skip lint markers LINT input_line continue input_indent = extract_leading_whitespace input_line python_block_start assert input_indent startswith last_indent extra_python_indent = input_indent len last_indent python_indent = indent_stack - + extra_python_indent indent_stack append input_indent python_indent assert input_indent startswith indent_stack - while input_indent startswith indent_stack - del indent_stack - python_block_start = False python_indent = indent_stack - stripped_input_line = input_line strip stripped_input_line startswith $ stripped_input_line startswith $ stripped_input_line endswith python_block_start = True while blank_lines = python_lines append python_indent + print file=OUT_STREAM blank_lines -= python_lines append python_indent + stripped_input_line replace $ assert input_line startswith python_indent while blank_lines = python_lines append python_indent + print file=OUT_STREAM blank_lines -= python_lines append python_indent + f print escape input_line len python_indent file=OUT_STREAM last_indent = input_indent while blank_lines = pyrefly ignore unbound-name python_lines append python_indent + print file=OUT_STREAM blank_lines -= exec_globals = dict variables output_stream = io StringIO exec_globals OUT_STREAM = output_stream python_bytecode = compile \n join python_lines input_path exec exec python_bytecode exec_globals output_stream getvalue SPVGenerator __init__ src_dir_paths str &#124; list str env dict Any Any glslc_path str &#124; None - None isinstance src_dir_paths str src_dir_paths = src_dir_paths src_dir_paths = src_dir_paths env = env glslc_path = glslc_path glsl_src_files dict str str = template_yaml_files list str = addSrcAndYamlFiles src_dir_paths shader_template_params dict Any Any = yaml_file template_yaml_files parseTemplateYaml yaml_file output_shader_map dict str tuple str dict str str = constructOutputMap addSrcAndYamlFiles src_dir_paths list str - None src_path src_dir_paths Collect glsl source files glsl_files = glob glob os path join src_path glsl recursive=True file glsl_files len file glsl_src_files extract_filename file keep_ext=False = file Collect template yaml files yaml_files = glob glob os path join src_path yaml recursive=True file yaml_files len file template_yaml_files append file generateVariantCombinations iterated_params dict str Any exclude_params set str &#124; None = None - list Any exclude_params None exclude_params = set all_iterated_params = param_name value_list iterated_params items param_name exclude_params param_values = value value_list suffix = value get SUFFIX value VALUE param_values append param_name suffix value VALUE all_iterated_params append param_values list product all_iterated_params parseTemplateYaml yaml_file str - None open yaml_file f contents = yaml load f Loader=UniqueKeyLoader template_name params_dict contents items template_name shader_template_params raise KeyError f template_name params file defined twice default_params = params_dict parameter_names_with_default_values params_names = set default_params keys union NAME shader_template_params template_name = default_iterated_params = params_dict get generate_variant_forall None variant params_dict shader_variants variant_params_names = set variant keys invalid_keys = variant_params_names - params_names - generate_variant_forall assert len invalid_keys == iterated_params = variant get generate_variant_forall default_iterated_params iterated_params None variant_combinations = generateVariantCombinations iterated_params variant_params_names combination variant_combinations default_params_copy = copy deepcopy default_params key variant key = generate_variant_forall default_params_copy key = variant key variant_name = variant NAME param_value combination default_params_copy param_value = param_value len param_value variant_name = f variant_name _ param_value default_params_copy NAME = variant_name shader_template_params template_name append default_params_copy default_params_copy = copy deepcopy default_params key variant default_params_copy key = variant key shader_template_params template_name append default_params_copy create_shader_params variant_params dict str Any &#124; None = None - dict str str variant_params None variant_params = shader_params = copy deepcopy env key value variant_params items shader_params key = value shader_dtype = shader_params get DTYPE float shader_dtype == int shader_params FORMAT = env INT_IMAGE_FORMAT shader_dtype == uint shader_params FORMAT = env UINT_IMAGE_FORMAT shader_dtype == int shader_params FORMAT = rgba i shader_dtype == uint shader_params FORMAT = rgba ui shader_dtype == int shader_params FORMAT = rgba i shader_dtype == uint shader_params FORMAT = rgba ui shader_dtype == float shader_params FORMAT = rgba f Assume float default shader_params FORMAT = env FLOAT_IMAGE_FORMAT shader_params constructOutputMap - None shader_name params shader_template_params items variant params source_glsl = glsl_src_files shader_name output_shader_map variant NAME = source_glsl create_shader_params variant shader_name source_glsl glsl_src_files items shader_name shader_template_params output_shader_map shader_name = source_glsl create_shader_params generateSPV output_dir str - dict str str output_file_map = shader_name output_shader_map source_glsl = output_shader_map shader_name shader_params = output_shader_map shader_name codecs open source_glsl r encoding= utf- input_file input_text = input_file read output_text = preprocess input_text shader_params glsl_out_path = os path join output_dir f shader_name glsl codecs open glsl_out_path w encoding= utf- output_file output_file write output_text If no GLSL compiler specified then only write out generated GLSL shaders This mainly testing purposes glslc_path None spv_out_path = os path join output_dir f shader_name spv cmd = glslc_path -fshader-stage=compute glsl_out_path -o spv_out_path -- target-env=vulkan -Werror + arg src_dir_path src_dir_paths arg -I src_dir_path print glslc cmd cmd subprocess check_call cmd output_file_map spv_out_path = glsl_out_path output_file_map ############################################## Shader Info Shader Registry Handling ############################################## dataclass ShaderInfo tile_size list int layouts list str weight_storage_type str = bias_storage_type str = register_for tuple str list str &#124; None = None getName filePath str - str os path basename filePath replace _ replace _ isDescriptorLine lineStr str - bool descriptorLineId = r ^layout\ set re search descriptorLineId lineStr None isTileSizeLine lineStr str - bool tile_size_id = r ^ \ TILE_SIZE = \ re search tile_size_id lineStr None findTileSizes lineStr str - list int tile_size_id = r ^ \ TILE_SIZE = \ - + - + - + \ matches = re search tile_size_id lineStr matches None raise AssertionError matches None findTileSizes int matches group int matches group int matches group isWeightStorageTypeLine lineStr str - bool weight_storage_id = r ^ \ WEIGHT_STORAGE = re search weight_storage_id lineStr None getWeightStorageType lineStr str - str weight_storage_id = r ^ \ WEIGHT_STORAGE = a-zA-Z +_\dD matches = re search weight_storage_id lineStr matches None raise AssertionError matches None getWeightStorageType matches group isBiasStorageTypeLine lineStr str - bool weight_storage_id = r ^ \ BIAS_STORAGE = re search weight_storage_id lineStr None getBiasStorageType lineStr str - str weight_storage_id = r ^ \ BIAS_STORAGE = a-zA-Z +_\dD matches = re search weight_storage_id lineStr matches None raise AssertionError matches None getBiasStorageType matches group isRegisterForLine lineStr str - bool Check Shader Name list least one Registry Key register_for_id = r ^ \ REGISTER_FOR = \ A-Za-z - _ + \s \s \ A-Za-z - _ + \ \ re search register_for_id lineStr None findRegisterFor lineStr str - tuple str list str register_for_pattern = r A-Za-z - _ + matches = re findall register_for_pattern lineStr matches None raise AssertionError matches None getBiasStorageType matches_list = list matches matches_list matches_list typeIdMapping = r image D\b VK_DESCRIPTOR_TYPE_STORAGE_IMAGE r sampler D\b VK_DESCRIPTOR_TYPE_COMBINED_IMAGE_SAMPLER r \bbuffer\b VK_DESCRIPTOR_TYPE_STORAGE_BUFFER r \buniform\b VK_DESCRIPTOR_TYPE_UNIFORM_BUFFER storageTypeToEnum = TEXTURE_ D api StorageType TEXTURE_ D TEXTURE_ D api StorageType TEXTURE_ D BUFFER api StorageType BUFFER api StorageType UNKNOWN determineDescriptorType lineStr str - str identifier typeNum typeIdMapping items re search identifier lineStr typeNum raise AssertionError No matching descriptor type + lineStr + determineDescriptorType getShaderInfo srcFilePath str - ShaderInfo shader_info = ShaderInfo open srcFilePath srcFile line srcFile isDescriptorLine line shader_info layouts append determineDescriptorType line isTileSizeLine line shader_info tile_size = findTileSizes line isWeightStorageTypeLine line shader_info weight_storage_type = getWeightStorageType line isBiasStorageTypeLine line shader_info bias_storage_type = getBiasStorageType line isRegisterForLine line shader_info register_for = findRegisterFor line shader_info ########################## C++ File Generation ######################### cpp_template = #include ATen native vulkan api ShaderRegistry h #include stdint h #include vector using namespace native vulkan namespace namespace native namespace vulkan namespace spv_bin_arrays static void register_fn register_shader_infos shader_info_registry static const api ShaderRegisterInit register_shaders register_fn generateSpvBinStr spvPath str name str - tuple int str open spvPath rb fr next_bin = array array I fr read sizeBytes = len next_bin spv_bin_str = const uint _t _bin = \n \n format name textwrap indent \n join str x x next_bin sizeBytes spv_bin_str generateShaderInfoStr shader_info ShaderInfo name str sizeBytes int - str tile_size = f join str x x shader_info tile_size len shader_info tile_size std vector uint _t shader_info_layouts = format \n join shader_info layouts shader_info_args = f name f name _bin str sizeBytes shader_info_layouts tile_size storageTypeToEnum shader_info weight_storage_type storageTypeToEnum shader_info bias_storage_type shader_info_str = textwrap indent api shader_registry register_shader \n api ShaderInfo \n args \n format args=textwrap indent \n join shader_info_args shader_info_str generateShaderDispatchStr shader_info ShaderInfo name str - str shader_info register_for None op_name registry_keys = shader_info register_for registry_key registry_keys shader_dispatch_str = textwrap indent f api shader_registry register_op_dispatch op_name api DispatchKey registry_key upper name pyrefly ignore unbound-name shader_dispatch_str genCppFiles spv_files dict str str cpp_header_path str cpp_src_file_path str - None spv_bin_strs = register_shader_info_strs = shader_registry_strs = spvPath srcPath spv_files items name = getName spvPath replace _spv sizeBytes spv_bin_str = generateSpvBinStr spvPath name pyrefly ignore bad-argument-type spv_bin_strs append spv_bin_str shader_info = getShaderInfo srcPath register_shader_info_strs append pyrefly ignore bad-argument-type generateShaderInfoStr shader_info name sizeBytes shader_info register_for None pyrefly ignore bad-argument-type shader_registry_strs append generateShaderDispatchStr shader_info name spv_bin_arrays = \n join spv_bin_strs register_shader_infos = \n join register_shader_info_strs shader_info_registry = \n join shader_registry_strs cpp = cpp_template format spv_bin_arrays=spv_bin_arrays register_shader_infos=register_shader_infos shader_info_registry=shader_info_registry open cpp_src_file_path w fw fw write cpp ########## Main ########## parse_arg_env items dict Any Any - dict Any Any d = items item items tokens = item split = key = tokens strip value = tokens strip d key = value d main argv list str - int parser = argparse ArgumentParser description= parser add_argument -i -- glsl-paths nargs= + help= List paths look GLSL source files separated spaces Ex -- glsl-paths path path path default= parser add_argument -c -- glslc-path required=True help= parser add_argument -t -- tmp-dir-path required=True help= tmp parser add_argument -o -- output-path required=True help= parser add_argument -- env metavar= KEY=VALUE nargs= help= Set number key-value pairs options = parser parse_args DEFAULT_ENV update TYPES_ENV DEFAULT_ENV update FUNCS_ENV env = DEFAULT_ENV key value parse_arg_env options env items env key = value os path exists options output_path os makedirs options output_path os path exists options tmp_dir_path os makedirs options tmp_dir_path shader_generator = SPVGenerator options glsl_paths env options glslc_path output_spv_files = shader_generator generateSPV options tmp_dir_path genCppFiles output_spv_files f options output_path CPP_H_NAME f options output_path CPP_SRC_NAME invoke_main - None sys exit main sys argv __name__ == __main__ invoke_main pragma no cover
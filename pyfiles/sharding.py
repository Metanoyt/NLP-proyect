mypy allow-untyped-defs collections abc Sized enum IntEnum torch utils data datapipes _decorator functional_datapipe torch utils data datapipes datapipe IterDataPipe __all__ = SHARDING_PRIORITIES ShardingFilterIterDataPipe SHARDING_PRIORITIES IntEnum DEFAULT = DISTRIBUTED = MULTIPROCESSING = _ShardingIterDataPipe IterDataPipe apply_sharding num_of_instances int instance_id int sharding_group SHARDING_PRIORITIES raise NotImplementedError functional_datapipe sharding_filter ShardingFilterIterDataPipe _ShardingIterDataPipe r Wrapper allows DataPipe sharded functional name ` ` sharding_filter ` ` After ` ` apply_sharding ` ` called each instance DataPipe different workers will have every ` n ` -th element original DataPipe where ` n ` equals number instances Args source_datapipe Iterable DataPipe will sharded __init__ source_datapipe IterDataPipe sharding_group_filter=None source_datapipe = source_datapipe sharding_group_filter = sharding_group_filter groups dict int tuple int int = num_of_instances = instance_id = _update_num_of_instances apply_sharding num_of_instances instance_id sharding_group=SHARDING_PRIORITIES DEFAULT instance_id = num_of_instances raise ValueError f instance_id instance_id should smaller than num_of_instances num_of_instances sharding_group == SHARDING_PRIORITIES DEFAULT len groups SHARDING_PRIORITIES DEFAULT groups raise RuntimeError ShardingFilter cannot mix DEFAULT non DEFAULT groups SHARDING_PRIORITIES DEFAULT groups raise RuntimeError ShardingFilter cannot mix DEFAULT non DEFAULT groups groups sharding_group = num_of_instances instance_id _update_num_of_instances _update_num_of_instances sorted_sharding_groups = groups key key sorted groups keys sharding_group_filter None key == sharding_group_filter sorted_sharding_groups reverse num_of_instances = instance_id = group_num_of_instances group_instance_id sorted_sharding_groups instance_id += num_of_instances group_instance_id num_of_instances = group_num_of_instances __iter__ i item enumerate source_datapipe i num_of_instances == instance_id yield item __len__ isinstance source_datapipe Sized len source_datapipe num_of_instances + instance_id len source_datapipe num_of_instances raise TypeError f type __name__ instance doesn t have valid length
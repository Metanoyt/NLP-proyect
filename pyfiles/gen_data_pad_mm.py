random sys pathlib Path typing Any sys path append str Path __file__ absolute parents benchmark_runner BenchmarkRunner type ignore import-not-found benchmark_utils type ignore import-not-found fits_in_memory get_mm_tensors set_precision transpose_tensors torch torch _inductor fx_passes pad_mm type ignore import-not-found get_alignment_size_dtype torch _inductor utils fresh_cache BenchmarkRunnerPadMM BenchmarkRunner type ignore misc no-any-unimported BenchmarkRunner pad_mm Used generate collect training data AutoHeuristic learn heuristic __init__ - None super __init__ pad_mm create_input - tuple Any dtype = get_dtype set_precision dtype m k n = get_m_k_n dtype transpose_left transpose_right = transpose_tensors prepadded_left = prepadded prepadded_right = prepadded m k n transpose_left transpose_right dtype prepadded_left prepadded_right run_benchmark m int k int n int transpose_left bool transpose_right bool dtype Any prepadded_left bool prepadded_right bool - None b = get_mm_tensors m k n transpose_left transpose_right dtype_left=dtype dtype_right=dtype print Benchmarking following input print f m= m k= k n= n dtype= dtype print f transpose_left= transpose_left transpose_right= transpose_right print f prepadded_left= prepadded_left prepadded_right= prepadded_right fresh_cache mm Any b Any - Any torch mm b mm_mat _prepadded Any b Any - Any torch mm + b mm_mat _prepadded Any b Any - Any torch mm b + mm_mat _mat _prepadded Any b Any - Any torch mm + b + prepadded_left prepadded_right cf = torch compile mm_mat _mat _prepadded prepadded_left cf = torch compile mm_mat _prepadded prepadded_right cf = torch compile mm_mat _prepadded cf = torch compile mm cf b torch compiler reset get_random_dim min_power int = max_power int = p_unaligned float = - int aligned = random choices True False - p_unaligned p_unaligned aligned random randint min_power max_power type ignore no-any-return choose random number between ^i ^ i+ get_random_between_pow min_power max_power type ignore no-any-return is_aligned dim int align_size int - bool dim align_size == get_m_k_n dtype Any - tuple int int int uniform = random choices True False align_size = get_alignment_size_dtype dtype repeat until tensors fit memory while True uniform m = random randint k = random randint n = random randint m = get_random_dim k = get_random_dim n = get_random_dim all is_aligned dim align_size dim m k n skip already aligned continue fits_in_memory dtype m k n m k n prepadded p_prepadded float = - bool p_prepadded probability tensor prepadded i e pad_mm excludes time takes pad benchmarking random choices True False p_prepadded - p_prepadded get_dtype - Any dtype_choices = torch float torch bfloat torch float random choices dtype_choices __name__ == __main__ runner = BenchmarkRunnerPadMM runner run
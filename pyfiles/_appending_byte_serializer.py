base zlib collections abc Callable Iterable typing Generic TypeVar T = TypeVar T _ENCODING_VERSION int = __all__ = AppendingByteSerializer ####################################### Helper classes ####################################### CHECKSUM_DIGEST_SIZE = BytesWriter __init__ - None Reserve CHECKSUM_DIGEST_SIZE bytes checksum _data = bytearray CHECKSUM_DIGEST_SIZE write_uint i int - None _data extend i to_bytes byteorder= big signed=False write_str s str - None payload = base b encode s encode utf- write_bytes payload write_bytes b bytes - None write_uint len b _data extend b to_bytes - bytes digest = zlib crc _data CHECKSUM_DIGEST_SIZE to_bytes byteorder= big signed=False len digest = CHECKSUM_DIGEST_SIZE raise AssertionError Computed checksum digest has unexpected size _data CHECKSUM_DIGEST_SIZE = digest bytes _data BytesReader __init__ data bytes - None Check data corruption len data CHECKSUM_DIGEST_SIZE raise AssertionError Input data too short contain checksum digest = zlib crc data CHECKSUM_DIGEST_SIZE to_bytes byteorder= big signed=False len digest = CHECKSUM_DIGEST_SIZE raise AssertionError Computed checksum digest has unexpected size data CHECKSUM_DIGEST_SIZE = digest raise RuntimeError Bytes object corrupted checksum does match f Expected data CHECKSUM_DIGEST_SIZE r Got digest r _data = data _i = CHECKSUM_DIGEST_SIZE is_finished - bool len _data == _i read_uint - int result = int from_bytes _data _i _i + byteorder= big signed=False _i += result read_str - str base b decode read_bytes decode utf- read_bytes - bytes size = read_uint result = _data _i _i + size _i += size result ####################################### AppendingByteSerializer ####################################### AppendingByteSerializer Generic T Provides efficient serialization deserialization list bytes Note does provide any guarantees around byte order _serialize_fn Callable BytesWriter T None _writer BytesWriter __init__ serialize_fn Callable BytesWriter T None - None _serialize_fn = serialize_fn clear clear - None _writer = BytesWriter First -bytes version _writer write_uint _ENCODING_VERSION append data T - None _serialize_fn _writer data extend elems Iterable T - None elem elems append elem to_bytes - bytes _writer to_bytes staticmethod to_list data bytes deserialize_fn Callable BytesReader T - list T reader = BytesReader data reader read_uint = _ENCODING_VERSION raise AssertionError f Encoding version mismatch AppendingByteSerializer to_list \ got reader read_uint result list T = while reader is_finished result append deserialize_fn reader result
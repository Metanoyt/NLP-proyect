Owner s module inductor sympy torch torch _inductor codegen block_analysis BlockPatternMatcher torch _inductor utils sympy_dot torch _inductor virtualized V torch testing _internal common_utils instantiate_parametrized_tests parametrize run_tests TestCase torch testing _internal inductor_utils dummy_graph torch utils _sympy functions FloorDiv Identity ModularIndexing Some useful symbols x y = sympy symbols x y instantiate_parametrized_tests BlockAnalysisTest TestCase classmethod setUpClass cls super setUpClass Create GraphLowering so we can access V graph cls graph = dummy_graph parametrize stride symbol expr x Identity x y Identity y x Identity x test_affine_identity stride int symbol sympy Symbol expr sympy Expr Test we can handle identity expression affine indexing matched_stride = BlockPatternMatcher match_affine_block_expr expr symbol assertEqual matched_stride stride parametrize dims strides symbol expr x FloorDiv Identity x + ModularIndexing x x FloorDiv x + ModularIndexing Identity x x Identity FloorDiv x + ModularIndexing x test_mod_div_identity dims tuple int strides tuple int symbol sympy Symbol expr sympy Expr Test we can handle identity expression modular indexing numel = int torch prod torch Tensor dims num_dims = len dims V set_graph_handler graph match_result = BlockPatternMatcher match_mod_div_block_expr expr symbol numel num_dims Check matched block dimensions assertNotEqual match_result None matched_dims matched_strides matched_block_index_exprs = match_result assertEqual matched_dims dims assertEqual matched_strides strides parametrize symbol expr subexpr x Identity x x x Identity x + x y Identity x + y + y test_subexpr_identity symbol sympy Symbol expr sympy Expr subexpr sympy Expr matched_subexpr = BlockPatternMatcher get_subexpr_involving_symbol expr symbol assertEqual matched_subexpr subexpr test_index_with_dynamic_shapes s = sympy var s integer=True s = sympy var s integer=True dims = s sympy Integer num_dims = len dims numel = dims dims strides = sympy Integer s sympy Integer block_index_exprs = FloorDiv y sympy Integer ModularIndexing y sympy Integer sympy Integer index = sympy_dot strides block_index_exprs V set_graph_handler graph match = BlockPatternMatcher match_mod_div_block_expr index y numel num_dims sizevars = V graph sizevars expected actual zip dims strides block_index_exprs match assert isinstance expected list tuple isinstance actual list tuple expected_expr actual_expr zip expected actual assert isinstance expected_expr sympy Expr isinstance actual_expr sympy Expr assertTrue sizevars statically_known_equals sizevars remove_precomputed_replacements expected_expr sizevars remove_precomputed_replacements actual_expr __name__ == __main__ run_tests
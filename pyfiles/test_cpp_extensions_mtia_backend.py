Owner s module mtia os tempfile unittest torch torch testing _internal common_utils common torch utils cpp_extension torch testing _internal common_utils IS_ARM IS_LINUX skipIfTorchDynamo TEST_CUDA TEST_PRIVATEUSE TEST_XPU torch utils cpp_extension CUDA_HOME ROCM_HOME define TEST_ROCM before changing TEST_CUDA TEST_ROCM = TEST_CUDA torch version hip None ROCM_HOME None TEST_CUDA = TEST_CUDA CUDA_HOME None unittest skipIf IS_ARM IS_LINUX TEST_CUDA TEST_PRIVATEUSE TEST_ROCM TEST_XPU Only linux platform mutual exclusive other backends torch testing _internal common_utils markDynamoStrictTest TestCppExtensionMTIABackend common TestCase Tests MTIA backend C++ extensions module = None setUp super setUp cpp extensions use relative paths Those paths relative file so we ll change working directory temporarily old_working_dir = os getcwd os chdir os path dirname os path abspath __file__ tearDown super tearDown working directory see setUp os chdir old_working_dir classmethod tearDownClass cls torch testing _internal common_utils remove_cpp_extensions_build_root classmethod setUpClass cls torch testing _internal common_utils remove_cpp_extensions_build_root build_dir = tempfile mkdtemp Load fake device guard impl cls module = torch utils cpp_extension load name= mtia_extension sources= cpp_extensions mtia_extension cpp build_directory=build_dir extra_include_paths= cpp_extensions path spaces path quote is_python_module=False verbose=True skipIfTorchDynamo Not TorchDynamo suitable test test_get_device_module device = torch device mtia default_stream = torch get_device_module device current_stream assertEqual default_stream device_type int torch _C _autograd DeviceType MTIA print torch _C Stream __mro__ print torch cuda Stream __mro__ skipIfTorchDynamo Not TorchDynamo suitable test test_stream_basic default_stream = torch mtia current_stream user_stream = torch mtia Stream assertEqual torch mtia current_stream default_stream assertNotEqual default_stream user_stream Check mtia_extension cpp default stream id starts assertEqual default_stream stream_id assertNotEqual user_stream stream_id torch mtia stream user_stream assertEqual torch mtia current_stream user_stream assertTrue user_stream query default_stream synchronize assertTrue default_stream query skipIfTorchDynamo Not TorchDynamo suitable test test_stream_context mtia_stream_ = torch mtia Stream device= mtia mtia_stream_ = torch mtia Stream device= mtia print mtia_stream_ print mtia_stream_ torch mtia stream mtia_stream_ current_stream = torch mtia current_stream msg = f current_stream current_stream should mtia_stream_ assertTrue current_stream == mtia_stream_ msg=msg torch mtia stream mtia_stream_ current_stream = torch mtia current_stream msg = f current_stream current_stream should mtia_stream_ assertTrue current_stream == mtia_stream_ msg=msg skipIfTorchDynamo Not TorchDynamo suitable test test_stream_context_different_device device_ = torch device mtia device_ = torch device mtia mtia_stream_ = torch mtia Stream device=device_ mtia_stream_ = torch mtia Stream device=device_ print mtia_stream_ print mtia_stream_ orig_current_device = torch mtia current_device torch mtia stream mtia_stream_ current_stream = torch mtia current_stream assertTrue torch mtia current_device == device_ index msg = f current_stream current_stream should mtia_stream_ assertTrue current_stream == mtia_stream_ msg=msg assertTrue torch mtia current_device == orig_current_device torch mtia stream mtia_stream_ current_stream = torch mtia current_stream assertTrue torch mtia current_device == device_ index msg = f current_stream current_stream should mtia_stream_ assertTrue current_stream == mtia_stream_ msg=msg assertTrue torch mtia current_device == orig_current_device skipIfTorchDynamo Not TorchDynamo suitable test test_device_context device_ = torch device mtia device_ = torch device mtia torch mtia device device_ assertTrue torch mtia current_device == device_ index torch mtia device device_ assertTrue torch mtia current_device == device_ index __name__ == __main__ common run_tests
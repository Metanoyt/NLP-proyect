Owner s oncall distributed io copy deepcopy torch torch nn nn torch distributed _shard sharded_tensor ShardedTensor torch distributed device_mesh init_device_mesh torch distributed fsdp FullyShardedDataParallel FSDP torch distributed fsdp api ShardedOptimStateDictConfig ShardedStateDictConfig StateDictType torch distributed tensor DTensor Shard torch testing _internal common_device_type instantiate_device_type_tests torch testing _internal common_fsdp get_devtype torch testing _internal common_utils parametrize run_tests torch testing _internal distributed _tensor common_dtensor DTensorTestBase skip_if_lt_x_gpu with_comms device_type = torch device get_devtype Simple boring model test interface some corner cases do require complicated wrapping strategy TestDummyModel torch nn Module __init__ super __init__ torch manual_seed net = nn Sequential nn Linear nn ReLU net = nn Sequential nn Linear nn ReLU net = nn Sequential nn Linear nn ReLU net = nn Sequential nn ReLU nn Linear forward x net net net net x get_input torch rand device=device_type type TestDummyModelUneven torch nn Module __init__ super __init__ torch manual_seed net = nn Sequential nn Linear nn ReLU net = nn Sequential nn Linear nn ReLU net = nn Linear net = nn Sequential nn ReLU nn Linear forward x net net net net x get_input torch rand device=device_type type TestFSDPWithDeviceMeshAndDTensor DTensorTestBase _create_model is_even_sharded_model device_mesh=None dummy_model = TestDummyModel is_even_sharded_model TestDummyModelUneven model = FSDP dummy_model device_type device_mesh=device_mesh optim = torch optim Adam model parameters lr= model model get_input sum backward optim step model optim with_comms skip_if_lt_x_gpu parametrize is_even_sharded_model True False test_fsdp_init_with_device_mesh is_even_sharded_model device_mesh = init_device_mesh device_type type world_size model optim = _create_model is_even_sharded_model device_mesh FSDP set_state_dict_type model StateDictType SHARDED_STATE_DICT state_dict = model state_dict optim_state_dict = FSDP optim_state_dict model optim v state_dict values assertEqual type v DTensor assertEqual len v placements assertEqual v placements Shard dim= assertEqual v device_mesh device_mesh state optim_state_dict state values k v state items k = step assertEqual type v DTensor assertEqual len v placements assertEqual v placements Shard dim= assertEqual v device_mesh device_mesh state_dict_type = FSDP get_state_dict_type model If device_mesh used when initializing FSDP field _use_dtensor will automatically set True StateDictType set SHARDED_STATE_DICT assertEqual state_dict_type state_dict_config _use_dtensor True assertEqual state_dict_type optim_state_dict_config _use_dtensor True with_comms skip_if_lt_x_gpu parametrize offload_to_cpu True False parametrize is_even_sharded_model True False test_dtensor_sharded_tensor_state_dict_identical offload_to_cpu is_even_sharded_model device_mesh = init_device_mesh device_type type world_size model optim = _create_model is_even_sharded_model device_mesh FSDP set_state_dict_type model StateDictType SHARDED_STATE_DICT state_dict_config=ShardedStateDictConfig offload_to_cpu=offload_to_cpu optim_state_dict_config=ShardedOptimStateDictConfig offload_to_cpu=offload_to_cpu dtensor_sd = model state_dict dtensor_osd = FSDP optim_state_dict model optim ref_model ref_optim = _create_model is_even_sharded_model FSDP set_state_dict_type ref_model StateDictType SHARDED_STATE_DICT state_dict_config=ShardedStateDictConfig offload_to_cpu=offload_to_cpu optim_state_dict_config=ShardedOptimStateDictConfig offload_to_cpu=offload_to_cpu sharded_tensor_sd = ref_model state_dict sharded_tensor_osd = FSDP optim_state_dict ref_model ref_optim Check dtensor sharded_tensor model state dict values identical dtensor_sd_item sharded_tensor_sd_item zip dtensor_sd items sharded_tensor_sd items k v = dtensor_sd_item k v = sharded_tensor_sd_item assertEqual k k ShardedTensor empty shard then local tensor DTensor should local_tensor=tensor len v local_shards == assertEqual v to_local numel assertEqual type v DTensor assertEqual type v ShardedTensor check whether local_tensor same assertEqual v to_local v local_tensor check whether device same assertEqual v to_local device v local_tensor device Check dtensor sharde_tensor optim state dict values identical dtensor_osd_state sharded_tensor_osd_state zip dtensor_osd state items sharded_tensor_osd state items check FQN same assertEqual dtensor_osd_state sharded_tensor_osd_state dtensor_hyper_param sharded_tensor_hyper_param zip dtensor_osd_state items sharded_tensor_osd_state items k v = dtensor_hyper_param k v = sharded_tensor_hyper_param assertEqual k k k = step ShardedTensor empty shard then local tensor DTensor should local_tensor=tensor len v local_shards == assertEqual v to_local numel assertEqual type v DTensor assertEqual type v ShardedTensor check whether local_tensor same assertEqual v to_local v local_tensor check whether device same assertEqual v to_local device v local_tensor device assertEqual v v with_comms skip_if_lt_x_gpu parametrize offload_to_cpu True False parametrize is_even_sharded_model True False test_dtensor_sharded_optim_load_state_dict offload_to_cpu is_even_sharded_model device_mesh = init_device_mesh device_type type world_size model optim = _create_model is_even_sharded_model device_mesh FSDP set_state_dict_type model StateDictType SHARDED_STATE_DICT optim_state_dict_config=ShardedOptimStateDictConfig offload_to_cpu=offload_to_cpu checkpoint = io BytesIO torch save FSDP optim_state_dict model optim checkpoint Deepcopy save current optim_state_dict compare optim_state_dict loaded back below ref_optim_state_dict = deepcopy FSDP optim_state_dict model optim Update parameters so FSDP optim_state_dict will different ref_optim_state_dict model model get_input sum backward optim step Load ref_optim_state_dict back checkpoint seek load_ref_optim_state_dict = torch load checkpoint optim load_state_dict FSDP optim_state_dict_to_load model optim load_ref_optim_state_dict new_optim_state_dict = FSDP optim_state_dict model optim Check whether new_optim_state_dict same ref_optim_state_dict new_optim_state_dict_item ref_optim_state_dict_item zip new_optim_state_dict state items ref_optim_state_dict state items check FQN same assertEqual new_optim_state_dict_item ref_optim_state_dict_item new_optim_hyper_param ref_optim_hyper_param zip new_optim_state_dict_item items ref_optim_state_dict_item items k v = new_optim_hyper_param k v = ref_optim_hyper_param check whether keys same assertEqual k k check whether values same assertEqual v v k = step assertEqual type v DTensor assertEqual type v DTensor with_comms skip_if_lt_x_gpu parametrize offload_to_cpu True False parametrize is_even_sharded_model True False test_dtensor_sharded_model_load_state_dict offload_to_cpu is_even_sharded_model device_mesh = init_device_mesh device_type type world_size model optim = _create_model is_even_sharded_model device_mesh FSDP set_state_dict_type model StateDictType SHARDED_STATE_DICT state_dict_config=ShardedStateDictConfig offload_to_cpu=offload_to_cpu checkpoint = io BytesIO torch save model state_dict checkpoint Deepcopy save current state_dict compare state_dict loaded back below ref_state_dict = deepcopy model state_dict Update parameters so model state_dict will different ref_dtensor_sd model model get_input sum backward optim step Load ref_state_dict back checkpoint seek load_ref_state_dict = torch load checkpoint model load_state_dict load_ref_state_dict new_state_dict = model state_dict Check whether new_state_dict same ref_state_dict k v k v zip ref_state_dict items new_state_dict items check whether fqn same assertEqual k k assertEqual type v DTensor assertEqual type v DTensor check whether DTensor same assertEqual v v with_comms skip_if_lt_x_gpu test_raises_warning_or_errors device_mesh = init_device_mesh device_type type world_size model optim = _create_model is_even_sharded_model=True device_mesh=device_mesh initialize optim model model get_input sum backward optim step assertRaisesRegex RuntimeError DeviceMesh compatible LOCAL_STATE_DICT FSDP state_dict_type model StateDictType LOCAL_STATE_DICT model state_dict assertRaisesRegex RuntimeError DeviceMesh compatible LOCAL_STATE_DICT FSDP state_dict_type model StateDictType LOCAL_STATE_DICT FSDP optim_state_dict model optim devices = cuda hpu xpu instantiate_device_type_tests TestFSDPWithDeviceMeshAndDTensor globals only_for=devices allow_xpu=True __name__ == __main__ run_tests
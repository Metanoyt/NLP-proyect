torch fx Graph GraphModule Node torch fx _compatibility compatibility matcher_utils InternalMatch SubgraphMatcher __all__ = SubgraphMatcherWithNameNodeMap _split_to_graph_and_name_node_map gm GraphModule - tuple GraphModule dict str Node torch fx graph _PyTreeInfo torch utils _pytree tree_flatten tree_unflatten name_node_map = n gm graph nodes n op == output assert gm _out_spec None output = tree_unflatten n args gm _out_spec assert isinstance output tuple Expecting pattern graph tuple assert len output = Expecting pattern graph have least two outputs out name_node_map = output flattened out_spec = tree_flatten out assert isinstance name_node_map dict Expecting input graph have dict output last element n args = flattened orig_pytree_info = gm _graph _codegen pytree_info type ignore attr-defined gm _graph _codegen pytree_info = _PyTreeInfo type ignore attr-defined orig_pytree_info orig_args orig_pytree_info in_spec out_spec gm recompile gm name_node_map compatibility is_backward_compatible=False SubgraphMatcherWithNameNodeMap SubgraphMatcher Extends SubgraphMatcher support querying matched subgraph nodes through node name requires pattern have specific format returning additional dictionary output has node name key node pattern graph value see Example more details Difference SubgraphMatcher takes ` pattern_gm ` GraphModule input during initialization since we need modify graph which requires ` recompile ` GraphModule Example pattern x weight conv = F conv d x weight relu = F relu conv relu conv conv relu relu target_graph x weight conv = F conv d x weight relu = F relu conv relu = relu pattern_gm = export_for_training pattern example_inputs module target_gm = export_for_training target_graph example_inputs module matcher = SubgraphMatcherWithNameNodeMap pattern_gm matches = matcher match target_gm match matches match name_node_map conv meta annotation = __init__ pattern_gm GraphModule match_output bool = False match_placeholder bool = False remove_overlapping_matches bool = True ignore_literals bool = False - None pattern_gm name_node_map = _split_to_graph_and_name_node_map pattern_gm name_node_map = name_node_map super __init__ pattern_gm graph match_output match_placeholder remove_overlapping_matches ignore_literals match graph Graph node_name_match str = - list InternalMatch The returned InternalMatch will have name_node_map populated map node name str target node e g conv target_conv_ndoe relu target_relu_node requires pattern graph returns additional output node name node e g instead ` ` ` pattern relu ` ` ` we should do ` ` ` pattern relu conv conv relu relu ` ` ` instead internal_matches = super match graph node_name_match internal_match internal_matches k n name_node_map items internal_match name_node_map k = internal_match nodes_map n internal_matches
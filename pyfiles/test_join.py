Owner s oncall distributed contextlib os sys typing Any Optional torch torch distributed dist dist is_available print Distributed available skipping tests file=sys stderr sys exit torch distributed algorithms join Join Joinable JoinHook torch testing _internal common_distributed MultiProcessTestCase require_n_gpus_for_nccl_backend torch testing _internal common_utils run_tests TEST_WITH_DEV_DBG_ASAN TEST_WITH_DEV_DBG_ASAN print Skip dev-asan torch + multiprocessing spawn have known issues file=sys stderr sys exit BACKEND = dist Backend NCCL torch cuda is_available dist Backend GLOO WORLD_SIZE = min max torch cuda device_count Constants used testing post-hooks BEFORE_CONSTANT = AFTER_CONSTANT = AllReducerJoinHook JoinHook r Join hook ` AllReducer ` Arguments allreducer AllReducer ` AllReducer ` object using hook num_allreduces int number all-reduces shadow per iteration run_post_hook bool flag enabling post-hook logic __init__ allreducer num_allreduces run_post_hook allreducer = allreducer num_allreduces = num_allreduces run_post_hook = run_post_hook main_hook r Shadows each all-reduce number all-reduces passed into constructor ` ` num_allreduces ` ` device = allreducer device _ range num_allreduces t = torch zeros device=device dist all_reduce t post_hook is_last_joiner bool r Broadcasts tensor containing magic constant ` ` AFTER_CONSTANT ` ` last joiner all other processes run_post_hook rank = dist get_rank allreducer process_group common_rank = allreducer find_common_rank rank is_last_joiner device = allreducer device rank == common_rank allreducer post_hook_tensor = torch tensor AFTER_CONSTANT device=device dist broadcast allreducer post_hook_tensor src=common_rank AllReducer Joinable r Example ` Joinable ` performs some number all-reduces its per-iteration collective communication __init__ device process_group super __init__ device = device process_group = process_group post_hook_tensor = torch tensor BEFORE_CONSTANT device=self device __call__ num_allreduces= r All-reduces dim- one tensor ` ` num_allreduces ` ` -many times returns total result Join notify_join_context device = device total = _ range num_allreduces t = torch ones device=device dist all_reduce t total += t item total join_hook kwargs - JoinHook r Returns join hook shadows some number all-reduces default number num_allreduces = kwargs get num_allreduces run_post_hook = kwargs get run_post_hooks False AllReducerJoinHook num_allreduces run_post_hook property join_device - torch device device property join_process_group - Any process_group find_common_rank rank to_consider r Returns max rank ones consider over process group common_rank = torch tensor rank to_consider - device=self device dist all_reduce common_rank op=dist ReduceOp MAX group=self process_group common_rank = common_rank item assert common_rank = common_rank TestJoin MultiProcessTestCase r Test cases generic join context setUp super setUp os environ WORLD_SIZE = str world_size os environ BACKEND = BACKEND _spawn_processes property device torch device rank BACKEND == dist Backend NCCL torch device cpu property world_size WORLD_SIZE property process_group dist group WORLD tearDown try dist destroy_process_group except AssertionError pass try os remove file_name except OSError pass dist_init rank world_size backend=BACKEND store = dist FileStore file_name world_size dist init_process_group backend=backend store=store rank=rank world_size=world_size construct_uneven_inputs base offset device=None r Returns uneven inputs rank i gets ` ` base ` ` + i ` ` offset ` ` inputs device None device = device torch zeros device=device _ range base + rank offset construct_even_inputs base device=None r Returns even inputs each rank gets ` ` base ` ` inputs device None device = device torch zeros device=device _ range base property base_num_inputs r Base number inputs used all ranks property offset r Rank i gets i ` ` offset ` ` additional inputs _test_join_base uneven_inputs bool num_joinables int enable bool throw_on_early_termination bool num_allreduces int run_post_hooks bool expected_total Optional int = None r Skeleton all ` Join ` tests Arguments uneven_inputs bool ` ` True ` ` use uneven inputs ` ` False ` ` otherwise num_joinables int number ` AllReducer ` s construct enable bool ` ` True ` ` enable join context manager ` ` False ` ` otherwise throw_on_early_termination bool ` ` True ` ` raise exception upon detecting uneven inputs ` ` False ` ` otherwise num_allreduces int number all-reduces perform per input run_post_hooks bool ` ` True ` ` run post-hooks ` ` False ` ` otherwise expected_total Optional int ` ` None ` ` check expected all-reduce total otherwise expected total default ` ` None ` ` dist_init rank world_size allreducers = AllReducer device process_group _ range num_joinables allreducer allreducers assertEqual allreducer post_hook_tensor item BEFORE_CONSTANT inputs = construct_uneven_inputs base_num_inputs offset uneven_inputs construct_even_inputs base_num_inputs allreduce_total = Expect ` RuntimeError ` ` throw_on_early_termination=True ` Rank exhausts its inputs first expected_msg = Rank exhausted all inputs rank == Detected least one rank exhausted inputs Throwing across all ranks assertRaisesRegex RuntimeError expected_msg throw_on_early_termination contextlib nullcontext Join allreducers enable=enable throw_on_early_termination=throw_on_early_termination num_allreduces=num_allreduces run_post_hooks=run_post_hooks _ inputs allreducer allreducers allreduce_total += allreducer num_allreduces throw_on_early_termination Check ` expected_total ` ` None ` expected_total assertEqual allreduce_total expected_total All ` AllReduce ` instances should receive updated ` post_hook_tensor ` last-joined process run_post_hooks allreducer allreducers assertEqual allreducer post_hook_tensor item AFTER_CONSTANT require_n_gpus_for_nccl_backend WORLD_SIZE BACKEND test_single_joinable_main_hooks r Tests main hooks single ` Joinable ` num_joinables = num_allreduces = run_post_hooks = False Non-joined processes all-reduce so rank s all-reduce total should precisely equal total number inputs processed before joined expected_total = world_size base_num_inputs Rank i runs i additional iterations num_joined range rank + expected_total += world_size - num_joined offset _test_join_base uneven_inputs=True num_joinables=num_joinables enable=True throw_on_early_termination=False num_allreduces=num_allreduces run_post_hooks=run_post_hooks expected_total=expected_total require_n_gpus_for_nccl_backend WORLD_SIZE BACKEND test_single_joinable_post_hooks r Tests post-hooks single ` Joinable ` num_joinables = num_allreduces = set skip main hooks run_post_hooks = False _test_join_base uneven_inputs=True num_joinables=num_joinables enable=True throw_on_early_termination=False num_allreduces=num_allreduces run_post_hooks=run_post_hooks expected_total=None require_n_gpus_for_nccl_backend WORLD_SIZE BACKEND test_single_joinable r Tests main hooks post-hooks single ` Joinable ` together This combines ` ` test_single_joinable_main_hooks ` ` ` ` test_single_joinable_post_hooks ` ` into single test ensure main hooks post-hooks operate correctly together num_joinables = num_allreduces = run_post_hooks = True expected_total = world_size base_num_inputs num_joined range rank + expected_total += world_size - num_joined offset _test_join_base uneven_inputs=True num_joinables=num_joinables enable=True throw_on_early_termination=False num_allreduces=num_allreduces run_post_hooks=run_post_hooks expected_total=expected_total require_n_gpus_for_nccl_backend WORLD_SIZE BACKEND test_multiple_joinables r Tests main hooks post-hooks multiple ` Joinable ` s together This generalizes ` ` test_single_joinable ` ` multiple ` Joinable ` s num_joinables = num_allreduces = run_post_hooks = True expected_total = world_size base_num_inputs num_joined range rank + expected_total += world_size - num_joined offset The expected total now multiplied factor ` NUM_JOINABLES ` expected_total = num_joinables _test_join_base uneven_inputs=True num_joinables=num_joinables enable=True throw_on_early_termination=False num_allreduces=num_allreduces run_post_hooks=run_post_hooks expected_total=expected_total require_n_gpus_for_nccl_backend WORLD_SIZE BACKEND test_single_joinable_disable r Tests ` ` enable=False ` ` single ` Joinable ` num_joinables = num_allreduces = uneven_inputs = False enable = False run_post_hooks = False expected_total = world_size base_num_inputs _test_join_base uneven_inputs=uneven_inputs num_joinables=num_joinables enable=enable throw_on_early_termination=False num_allreduces=num_allreduces run_post_hooks=run_post_hooks expected_total=expected_total require_n_gpus_for_nccl_backend WORLD_SIZE BACKEND test_multiple_joinable_disable r Tests ` ` enable=False ` ` multiple ` Joinable ` s This generalizes ` ` test_single_joinable_disable ` ` multiple ` Joinable ` s num_joinables = num_allreduces = uneven_inputs = False enable = False run_post_hooks = False expected_total = world_size base_num_inputs num_joinables _test_join_base uneven_inputs=uneven_inputs num_joinables=num_joinables enable=enable throw_on_early_termination=False num_allreduces=num_allreduces run_post_hooks=run_post_hooks expected_total=expected_total require_n_gpus_for_nccl_backend WORLD_SIZE BACKEND test_single_joinable_throw r Tests ` ` throw_on_early_termination=True ` ` single ` Joinable ` num_joinables = num_allreduces = throw_on_early_termination = True run_post_hooks = False _test_join_base uneven_inputs=True num_joinables=num_joinables enable=True throw_on_early_termination=throw_on_early_termination num_allreduces=num_allreduces run_post_hooks=run_post_hooks expected_total=None require_n_gpus_for_nccl_backend WORLD_SIZE BACKEND test_multiple_joinables_throw r Tests ` ` throw_on_early_termination=True ` ` multiple ` Joinable ` s together This generalizes ` ` test_single_joinable_throw ` ` multiple ` Joinable ` s num_joinables = num_allreduces = throw_on_early_termination = True run_post_hooks = False _test_join_base uneven_inputs=True num_joinables=num_joinables enable=True throw_on_early_termination=throw_on_early_termination num_allreduces=num_allreduces run_post_hooks=run_post_hooks expected_total=None require_n_gpus_for_nccl_backend WORLD_SIZE BACKEND test_join_kwargs r Tests passing keyword arguments context manager num_joinables = num_allreduces = run_post_hooks = False expected_total = world_size base_num_inputs num_joined range rank + expected_total += world_size - num_joined offset The expected total now multiplied factor ` NUM_ALLREDUCES ` expected_total = num_allreduces _test_join_base uneven_inputs=True num_joinables=num_joinables enable=True throw_on_early_termination=False num_allreduces=num_allreduces run_post_hooks=run_post_hooks expected_total=expected_total __name__ == __main__ run_tests
Owner s oncall distributed checkpointing unittest mock mock torch distributed checkpoint _experimental barriers TCPStoreBarrier torch distributed checkpoint _experimental types RankInfo torch testing _internal common_utils run_tests TestCase TestBarriers TestCase mock patch torch distributed TCPStore mock patch torch distributed elastic utils store barrier test_tcpstore_barrier_initialization _ mock_tcpstore Test TCPStoreBarrier initializes correctly Setup timeout_barrier_init_secs = barrier_prefix = test_barrier world_size = use_checkpoint_barrier_tcpstore_libuv = True tcpstore_port = master_address = localhost rank = timeout_secs = Create rank_info rank_info = RankInfo global_rank=rank global_world_size=world_size Create barrier used verification _ = TCPStoreBarrier global_rank=rank_info global_rank global_world_size=rank_info global_world_size barrier_prefix=barrier_prefix timeout_barrier_init_secs=timeout_barrier_init_secs use_checkpoint_barrier_tcpstore_libuv=use_checkpoint_barrier_tcpstore_libuv tcpstore_port=tcpstore_port master_address=master_address timeout_secs=timeout_secs Verify TCPStore initialized correct parameters mock_tcpstore assert_called_once_with master_address tcpstore_port world_size=rank_info global_world_size timeout=mock ANY timedelta hard compare directly is_master= rank_info global_rank == mock patch torch distributed TCPStore mock patch torch distributed elastic utils store barrier test_execute_barrier mock_barrier mock_tcpstore Test execute_barrier calls barrier function correctly Setup barrier_prefix = test_barrier timeout_barrier_init_secs = world_size = use_checkpoint_barrier_tcpstore_libuv = True tcpstore_port = master_address = localhost rank = timeout_secs = Create rank_info rank_info = RankInfo global_rank=rank global_world_size=world_size Mock TCPStore instance mock_tcpstore_instance = mock MagicMock mock_tcpstore return_value = mock_tcpstore_instance Create barrier barrier = TCPStoreBarrier global_rank=rank_info global_rank global_world_size=rank_info global_world_size barrier_prefix=barrier_prefix timeout_barrier_init_secs=timeout_barrier_init_secs use_checkpoint_barrier_tcpstore_libuv=use_checkpoint_barrier_tcpstore_libuv tcpstore_port=tcpstore_port master_address=master_address timeout_secs=timeout_secs Execute barrier barrier execute_barrier Verify TCPStore s set method called correct parameters mock_tcpstore_instance set assert_called_once_with rank Verify barrier function called correct parameters mock_barrier assert_called_once_with store=mock_tcpstore_instance world_size=rank_info global_world_size key_prefix=barrier_prefix + Execute barrier again test sequence number increment barrier execute_barrier Verify TCPStore s set method called incremented sequence number mock_tcpstore_instance set assert_called_with rank Verify barrier function called incremented sequence number mock_barrier assert_called_with store=mock_tcpstore_instance world_size=rank_info global_world_size key_prefix=barrier_prefix + __name__ == __main__ run_tests
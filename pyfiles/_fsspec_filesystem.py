Mypy will try inferring types any rd party libraries installed mypy ignore-errors io os collections abc Generator Sequence contextlib contextmanager pathlib Path typing Optional TYPE_CHECKING Union fsspec core url_to_fs torch distributed checkpoint _extension StreamTransformExtension torch distributed checkpoint filesystem FileSystemBase FileSystemReader FileSystemWriter SerializationFormat TYPE_CHECKING fsspec AbstractFileSystem __all__ = FsspecWriter FsspecReader FileSystem FileSystemBase __init__ - None fs Optional AbstractFileSystem = None contextmanager create_stream path Union str os PathLike mode str - Generator io IOBase None None fs None raise AssertionError fs should None path = os fspath path fsspec does support concurrent transactions all AbstractFileSystem have working rollback implementations so just manually delete file necessary errors fs open path mode stream try yield stream except noqa B E any ch mode ch w+a cleanup file read-only try rm_file path except noqa B E pass raise concat_path path Union str os PathLike suffix str - Union str os PathLike os path join path suffix init_path path Union str os PathLike kwargs - Union str os PathLike fs _ = url_to_fs path kwargs path rename path Union str os PathLike new_path Union str os PathLike - None fs rename path new_path mkdir path Union str os PathLike - None fs makedirs path exist_ok=True classmethod validate_checkpoint_id cls checkpoint_id Union str os PathLike - bool isinstance checkpoint_id Path False try url_to_fs checkpoint_id except ValueError False True exists path Union str os PathLike - bool fs exists path rm_file path Union str os PathLike - None fs rm path ls path Union str os PathLike - list str setting detail False explicitly keep list str type instead list Dict type when detail=True fs ls path detail=False TODO add dcp async_save mixin FsspecWriter FileSystemWriter Basic implementation StorageWriter using FFspec This implementation makes following assumptions simplifications The checkpoint path empty non-existing directory File creation atomic The checkpoint consist one file per write request plus ` metadata ` file serialized metadata __init__ path Union str os PathLike single_file_per_rank bool = True sync_files bool = True thread_count int = per_thread_copy_ahead int = _ _ overwrite bool = True _extensions Optional Sequence StreamTransformExtension = None serialization_format SerializationFormat = SerializationFormat TORCH_SAVE kwargs - None Initialize writer pointing ` path ` Args path directory where checkpoint will written single_file_per_rank Produce one file per rank instead one file per tensor blob Default True sync_files force files synced permanent storage Default True thread_count Number IO threads use write Default per_thread_copy_ahead How many bytes copy GPU ahead saving then Default Mb overwrite Whether allow overwriting existing checkpoints Defaults True _extensions Extensions apply output streams EXPERIMENTAL N B If sync_files disabled there s no guarantee checkpoint will consistent case failure super __init__ path single_file_per_rank sync_files thread_count per_thread_copy_ahead overwrite=overwrite _extensions=_extensions serialization_format=serialization_format fs = FileSystem path = fs init_path path kwargs classmethod validate_checkpoint_id cls checkpoint_id Union str os PathLike - bool FileSystem validate_checkpoint_id checkpoint_id FsspecReader FileSystemReader __init__ path Union str os PathLike kwargs - None super __init__ path fs = FileSystem path = fs init_path path kwargs classmethod validate_checkpoint_id cls checkpoint_id Union str os PathLike - bool FileSystem validate_checkpoint_id checkpoint_id
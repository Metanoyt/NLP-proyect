mypy allow-untyped-defs math typing Optional torch torch Tensor torch distributions constraints torch distributions distribution Distribution torch distributions multivariate_normal _batch_mahalanobis _batch_mv torch distributions utils _standard_normal lazy_property torch types _size __all__ = LowRankMultivariateNormal _batch_capacitance_tril W D r Computes Cholesky math ` I + W T inv D W ` batch matrices math ` W ` batch vectors math ` D ` m = W size - Wt_Dinv = W mT D unsqueeze - K = torch matmul Wt_Dinv W contiguous K view - m m m + += add identity matrix K torch linalg cholesky K _batch_lowrank_logdet W D capacitance_tril r Uses matrix determinant lemma log &#124; W W T + D &#124; = log &#124; C &#124; + log &#124; D &#124; where math ` C ` capacitance matrix math ` I + W T inv D W ` compute log determinant capacitance_tril diagonal dim =- dim =- log sum - + D log sum - _batch_lowrank_mahalanobis W D x capacitance_tril r Uses Woodbury matrix identity inv W W T + D = inv D - inv D W inv C W T inv D where math ` C ` capacitance matrix math ` I + W T inv D W ` compute squared Mahalanobis distance math ` x T inv W W T + D x ` Wt_Dinv = W mT D unsqueeze - Wt_Dinv_x = _batch_mv Wt_Dinv x mahalanobis_term = x pow D sum - mahalanobis_term = _batch_mahalanobis capacitance_tril Wt_Dinv_x mahalanobis_term - mahalanobis_term LowRankMultivariateNormal Distribution r Creates multivariate normal distribution covariance matrix having low-rank form parameterized attr ` cov_factor ` attr ` cov_diag ` covariance_matrix = cov_factor cov_factor T + cov_diag Example xdoctest +REQUIRES env TORCH_DOCTEST_LAPACK xdoctest +IGNORE_WANT non-deterministic m = LowRankMultivariateNormal torch zeros torch tensor torch ones m sample normally distributed mean= ` ` cov_factor= ` ` cov_diag= ` ` tensor - - Args loc Tensor mean distribution shape ` batch_shape + event_shape ` cov_factor Tensor factor part low-rank form covariance matrix shape ` batch_shape + event_shape + rank ` cov_diag Tensor diagonal part low-rank form covariance matrix shape ` batch_shape + event_shape ` Note The computation determinant inverse covariance matrix avoided when ` cov_factor shape cov_factor shape ` thanks ` Woodbury matrix identity https en wikipedia org wiki Woodbury_matrix_identity ` _ ` matrix determinant lemma https en wikipedia org wiki Matrix_determinant_lemma ` _ Thanks these formulas we just need compute determinant inverse small size capacitance matrix capacitance = I + cov_factor T inv cov_diag cov_factor pyrefly ignore bad-override arg_constraints = loc constraints real_vector cov_factor constraints independent constraints real cov_diag constraints independent constraints positive support = constraints real_vector has_rsample = True __init__ loc Tensor cov_factor Tensor cov_diag Tensor validate_args Optional bool = None - None loc dim raise ValueError loc must least one-dimensional event_shape = loc shape - cov_factor dim raise ValueError cov_factor must least two-dimensional optional leading batch dimensions cov_factor shape - - = event_shape raise ValueError f cov_factor must batch matrices shape event_shape x m cov_diag shape - = event_shape raise ValueError f cov_diag must batch vectors shape event_shape loc_ = loc unsqueeze - cov_diag_ = cov_diag unsqueeze - try loc_ cov_factor cov_diag_ = torch broadcast_tensors loc_ cov_factor cov_diag_ except RuntimeError e raise ValueError f Incompatible batch shapes loc loc shape cov_factor cov_factor shape cov_diag cov_diag shape e loc = loc_ cov_diag = cov_diag_ batch_shape = loc shape - _unbroadcasted_cov_factor = cov_factor _unbroadcasted_cov_diag = cov_diag _capacitance_tril = _batch_capacitance_tril cov_factor cov_diag super __init__ batch_shape event_shape validate_args=validate_args expand batch_shape _instance=None new = _get_checked_instance LowRankMultivariateNormal _instance batch_shape = torch Size batch_shape loc_shape = batch_shape + event_shape new loc = loc expand loc_shape new cov_diag = cov_diag expand loc_shape new cov_factor = cov_factor expand loc_shape + cov_factor shape - new _unbroadcasted_cov_factor = _unbroadcasted_cov_factor new _unbroadcasted_cov_diag = _unbroadcasted_cov_diag new _capacitance_tril = _capacitance_tril super LowRankMultivariateNormal new __init__ batch_shape event_shape validate_args=False new _validate_args = _validate_args new property mean - Tensor loc property mode - Tensor loc lazy_property variance - Tensor type ignore override _unbroadcasted_cov_factor pow sum - + _unbroadcasted_cov_diag expand _batch_shape + _event_shape lazy_property scale_tril - Tensor The following identity used increase numerically computation stability Cholesky decomposition see http www gaussianprocess org gpml Section W W T + D = D I + D- W W T D- D The matrix I + D- W W T D- has eigenvalues bounded below hence well-conditioned safe take Cholesky decomposition n = _event_shape cov_diag_sqrt_unsqueeze = _unbroadcasted_cov_diag sqrt unsqueeze - Dinvsqrt_W = _unbroadcasted_cov_factor cov_diag_sqrt_unsqueeze K = torch matmul Dinvsqrt_W Dinvsqrt_W mT contiguous K view - n n n + += add identity matrix K scale_tril = cov_diag_sqrt_unsqueeze torch linalg cholesky K scale_tril expand _batch_shape + _event_shape + _event_shape lazy_property covariance_matrix - Tensor covariance_matrix = torch matmul _unbroadcasted_cov_factor _unbroadcasted_cov_factor mT + torch diag_embed _unbroadcasted_cov_diag covariance_matrix expand _batch_shape + _event_shape + _event_shape lazy_property precision_matrix - Tensor We use Woodbury matrix identity take advantage low rank form inv W W T + D = inv D - inv D W inv C W T inv D where math ` C ` capacitance matrix Wt_Dinv = _unbroadcasted_cov_factor mT _unbroadcasted_cov_diag unsqueeze - A = torch linalg solve_triangular _capacitance_tril Wt_Dinv upper=False precision_matrix = torch diag_embed _unbroadcasted_cov_diag reciprocal - A mT A precision_matrix expand _batch_shape + _event_shape + _event_shape rsample sample_shape _size = torch Size - Tensor shape = _extended_shape sample_shape W_shape = shape - + cov_factor shape - eps_W = _standard_normal W_shape dtype=self loc dtype device=self loc device eps_D = _standard_normal shape dtype=self loc dtype device=self loc device loc + _batch_mv _unbroadcasted_cov_factor eps_W + _unbroadcasted_cov_diag sqrt eps_D log_prob value _validate_args _validate_sample value diff = value - loc M = _batch_lowrank_mahalanobis _unbroadcasted_cov_factor _unbroadcasted_cov_diag diff _capacitance_tril log_det = _batch_lowrank_logdet _unbroadcasted_cov_factor _unbroadcasted_cov_diag _capacitance_tril - _event_shape math log math pi + log_det + M entropy log_det = _batch_lowrank_logdet _unbroadcasted_cov_factor _unbroadcasted_cov_diag _capacitance_tril H = _event_shape + math log math pi + log_det len _batch_shape == H H expand _batch_shape
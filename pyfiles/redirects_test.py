usr bin env python Owner s oncall r p Copyright c Facebook Inc its affiliates All rights reserved This source code licensed under BSD-style license found LICENSE file root directory source tree ctypes os shutil sys tempfile unittest torch distributed elastic multiprocessing redirects redirect redirect_stderr redirect_stdout libc = ctypes CDLL libc so c_stderr = ctypes c_void_p in_dll libc stderr RedirectsTest unittest TestCase setUp test_dir = tempfile mkdtemp prefix=f __class__ __name__ _ tearDown shutil rmtree test_dir test_redirect_invalid_std assertRaises ValueError redirect stdfoo os path join test_dir stdfoo log pass test_redirect_stdout stdout_log = os path join test_dir stdout log printing stdout before redirect should go console stdout log print foo first python libc printf b foo first c\n os system echo foo first cmd redirect_stdout stdout_log print foo python libc printf b foo c\n os system echo foo cmd make sure stdout restored print foo again python libc printf b foo again c\n os system echo foo again cmd open stdout_log f since we print python c cmd - stream ordered do set comparison lines = set f readlines assertEqual foo python\n foo c\n foo cmd\n lines test_redirect_stderr stderr_log = os path join test_dir stderr log print bar first python libc fprintf c_stderr b bar first c\n os system echo bar first cmd redirect_stderr stderr_log print bar python file=sys stderr libc fprintf c_stderr b bar c\n os system echo bar cmd print bar again python libc fprintf c_stderr b bar again c\n os system echo bar again cmd open stderr_log f lines = set f readlines assertEqual bar python\n bar c\n bar cmd\n lines test_redirect_both stdout_log = os path join test_dir stdout log stderr_log = os path join test_dir stderr log print first stdout python libc printf b first stdout c\n print first stderr python file=sys stderr libc fprintf c_stderr b first stderr c\n redirect_stdout stdout_log redirect_stderr stderr_log print redir stdout python print redir stderr python file=sys stderr libc printf b redir stdout c\n libc fprintf c_stderr b redir stderr c\n print again stdout python libc fprintf c_stderr b again stderr c\n open stdout_log f lines = set f readlines assertEqual redir stdout python\n redir stdout c\n lines open stderr_log f lines = set f readlines assertEqual redir stderr python\n redir stderr c\n lines _redirect_large_buffer print_fn num_lines= _ stdout_log = os path join test_dir stdout log redirect_stdout stdout_log i range num_lines print_fn i open stdout_log fp actual = int line split line fp expected = set range num_lines assertSetEqual expected actual test_redirect_large_buffer_py py_print i print f py i _redirect_large_buffer py_print test_redirect_large_buffer_c c_print i libc printf bytes f c i \n utf- _redirect_large_buffer c_print __name__ == __main__ raise RuntimeError This test currently used should enabled discover_tests py required
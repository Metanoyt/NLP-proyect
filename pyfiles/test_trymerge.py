usr bin env python Tests implemented file relying GitHub GraphQL APIs In order avoid test flakiness results queries cached gql_mocks json PyTorch Lint workflow does have GITHUB_TOKEN defined avoid flakiness so you making changes merge_rules GraphQL queries trymerge py please make sure delete ` gql_mocks json ` And re-run test locally ones PAT gzip json os warnings hashlib sha typing Any Optional unittest main mock skip TestCase urllib error HTTPError github_utils gh_graphql gitutils get_git_remote_name get_git_repo_dir GitRepo trymerge _revlist_to_prs categorize_checks DRCI_CHECKRUN_NAME find_matching_merge_rule get_classifications get_drci_classifications gh_get_team_members GitHubPR iter_issue_timeline_until_comment JobCheckState main trymerge_main MandatoryChecksMissingError MergeRule PostCommentError RE_GHSTACK_DESC read_merge_rules remove_job_name_suffix sha_from_committed_event sha_from_force_push_after validate_revert GIT_REMOTE_URL os environ os environ GIT_REMOTE_URL = https github com pytorch pytorch GQL_MOCKS = gql_mocks json gz DRCI_MOCKS = drci_mocks json gz mock_query fallback_function Any file_name str key_function Any args Any - Any gql_db_fname = os path join os path dirname __file__ file_name get_mocked_queries - Any os path exists gql_db_fname gzip open gql_db_fname encoding= utf- mode= rt f json load f save_mocked_queries obj Any - None gzip open gql_db_fname encoding= utf- mode= wt f json dump obj f indent= f write \n key = key_function args mocked_queries = get_mocked_queries key mocked_queries mocked_queries key TODO Remove me once https github com pytorch pytorch issues resolved raise ValueError f Key key could found gql_mocks try rc = fallback_function args except HTTPError err err code == err code == err_msg = f If you seeing message during workflow run please make sure update file_name err_msg += f locally deleting running os path basename __file__ err_msg += GitHub Personal Access Token passed via GITHUB_TOKEN err_msg += drci api key passed via DRCI_BOT_KEY environment variables os getenv GITHUB_TOKEN None os getenv DRCI_BOT_KEY None err_msg = Failed update cached queries GITHUB_TOKEN DRCI_BOT_KEY + defined + err_msg raise RuntimeError err_msg err mocked_queries key = rc save_mocked_queries mocked_queries rc mocked_gh_graphql query str kwargs Any - Any key_function query str kwargs Any - str f query_sha= sha query encode utf- hexdigest + join f k = kwargs k k sorted kwargs keys gh_graphql_wrapper query str kwargs Any - Any gh_graphql query kwargs mock_query gh_graphql_wrapper GQL_MOCKS key_function query kwargs mocked_drci_classifications pr_num int project str num_retries int = - Any mock_query get_drci_classifications DRCI_MOCKS lambda x y f x y pr_num project mock_parse_args revert bool = False force bool = False - Any Object __init__ - None revert = revert force = force pr_num = dry_run = True comment_id = Set non-zero value reason = testing ignore_current = False check_mergeability = False Object mock_remove_label org str repo str pr_num str label str dry_run bool - None pass mock_revert repo GitRepo pr GitHubPR dry_run bool = False comment_id Optional int = None reason Optional str = None - None pass mock_merge pr GitHubPR repo GitRepo comment_id int dry_run bool = False skip_mandatory_checks bool = False timeout_minutes int = stale_pr_days int = ignore_current bool = False - None pass mock_gh_get_info - Any closed False isCrossRepository False headRefName foo baseRefName bar baseRepository defaultBranchRef name bar files nodes pageInfo hasNextPage False changedFiles mocked_read_merge_rules_NE repo Any org str project str - list MergeRule MergeRule name= mock nonexistent check patterns= approved_by= mandatory_checks_name= Lint Facebook CLA Check nonexistent ignore_flaky_failures=True mocked_read_merge_rules repo Any org str project str - list MergeRule MergeRule name= super patterns= approved_by= pytorch metamates ngimel mandatory_checks_name= Lint pull linux-xenial-cuda -py -gcc build ignore_flaky_failures=True MergeRule name= xla patterns= github ci_commit_pins xla txt approved_by= pytorchbot mandatory_checks_name= Lint EasyCLA pull linux-focal-py _ -clang -xla build pull linux-focal-py _ -clang -xla test xla linux xlarge ignore_flaky_failures=True mocked_read_merge_rules_approvers repo Any org str project str - list MergeRule MergeRule name= Core Reviewers patterns= approved_by= mandatory_checks_name= Lint pull MergeRule name= Core Maintainers patterns= approved_by= malfet mandatory_checks_name= Lint pull mocked_read_merge_rules_raise repo Any org str project str - list MergeRule raise RuntimeError testing xla_merge_rules repo Any org str project str - list MergeRule MergeRule name= OSS CI pytorchbot XLA patterns= github ci_commit_pins xla txt approved_by= pytorchbot mandatory_checks_name= Lint EasyCLA pull linux-bionic-py _ -clang -xla build pull linux-bionic-py _ -clang -xla test xla linux xlarge inductor cuda -py -gcc -sm test inductor_torchbench_dynamic linux g xlarge nvidia gpu ignore_flaky_failures=False DummyGitRepo GitRepo __init__ - None super __init__ get_git_repo_dir get_git_remote_name commits_resolving_gh_pr pr_num int - list str FakeCommitSha commit_message ref str - str super awesome commit message mock patch trymerge gh_graphql side_effect=mocked_gh_graphql mock patch trymerge get_drci_classifications side_effect=mocked_drci_classifications TestTryMerge TestCase test_merge_rules_valid args Any - None Test merge_rules yaml can parsed repo = DummyGitRepo merge_rules = read_merge_rules repo pytorch pytorch assertGreater len merge_rules mock patch trymerge read_merge_rules side_effect=mocked_read_merge_rules test_match_rules args Any - None Tests PR passes merge rules pr = GitHubPR pytorch pytorch repo = DummyGitRepo assertTrue find_matching_merge_rule pr repo None mock patch trymerge read_merge_rules side_effect=mocked_read_merge_rules_raise test_read_merge_rules_fails args Any - None Tests PR fails read merge rules pr = GitHubPR pytorch pytorch repo = DummyGitRepo assertRaisesRegex RuntimeError testing lambda find_matching_merge_rule pr repo mock patch trymerge read_merge_rules side_effect=mocked_read_merge_rules_approvers test_match_rules_approvers args Any - None Tests PR has necessary approvers repo = DummyGitRepo pr = GitHubPR pytorch pytorch Test all potential approvers across all rules listed PR doesn t have one them mock_rule Core Reviewers Core Maintainers assertRaisesRegex RuntimeError mock_rule lambda find_matching_merge_rule pr repo pr = GitHubPR pytorch pytorch Test PR correct approvers doesn t raise any exception assertTrue find_matching_merge_rule pr repo None mock patch trymerge read_merge_rules side_effect=mocked_read_merge_rules test_lint_fails args Any - None Tests PR fails mandatory lint check pr = GitHubPR pytorch pytorch repo = DummyGitRepo assertRaises RuntimeError lambda find_matching_merge_rule pr repo test_get_last_comment args Any - None Tests last comment can fetched pr = GitHubPR pytorch pytorch comment = pr get_last_comment assertEqual comment author_login github-actions assertIsNone comment editor_login assertTrue You ve committed PR comment body_text test_get_author_null args Any - None Tests PR author can computed If reply contains NULL pr = GitHubPR pytorch pytorch author = pr get_author assertTrue author None assertTrue author assertTrue pr get_diff_revision None PR multiple contributors creator id among authors pr = GitHubPR pytorch pytorch assertEqual pr get_pr_creator_login mruberry author = pr get_author assertTrue author None test_large_diff args Any - None Tests PR + files can fetched pr = GitHubPR pytorch pytorch assertTrue pr get_changed_files_count flist = pr get_changed_files assertEqual len flist pr get_changed_files_count test_internal_changes args Any - None Tests PR internal changes detected pr = GitHubPR pytorch pytorch assertTrue pr has_internal_changes test_comments_pagination args Any - None Tests PR + comments can fetched pr = GitHubPR pytorch pytorch assertGreater len pr get_comments test_gql_complexity args Any - None Fetch comments conclusions PR commits Previous version GrapQL query used cause HTTP error see https gist github com malfet b bc eeddeaf d efc f c f pr = GitHubPR pytorch pytorch assertGreater len pr get_comments NS GitHub seems recycle older checkruns https github com pytorch pytorch pull checks shows runs assertGreater len pr get_checkrun_conclusions assertGreater pr get_commit_count skip GitHub doesn t keep data anymore test_gql_retrieve_checksuites args Any - None Fetch comments conclusions PR commits pr = GitHubPR pytorch pytorch assertEqual len pr get_checkrun_conclusions test_team_members args Any - None Test fetching team members works dev_infra_team = gh_get_team_members pytorch pytorch-dev-infra assertGreater len dev_infra_team assertWarns Warning non_existing_team = gh_get_team_members pytorch qwertyuiop assertEqual len non_existing_team test_get_author_many_commits args Any - None Tests authors all commits can fetched pr = GitHubPR pytorch pytorch authors = pr get_authors assertGreater pr get_commit_count assertGreater len authors assertTrue pr get_author mock patch trymerge read_merge_rules side_effect=mocked_read_merge_rules_NE test_pending_status_check args Any - None Tests PR nonexistent pending status checks fails right reason pr = GitHubPR pytorch pytorch repo = DummyGitRepo assertRaisesRegex MandatoryChecksMissingError pending yet run lambda find_matching_merge_rule pr repo test_get_author_many_reviews args Any - None Tests all reviews can fetched pr = GitHubPR pytorch pytorch approved_by = pr get_approved_by assertGreater len approved_by assert pr _reviews None pacify mypy assertGreater len pr _reviews get_co_authors args Any - None Tests co-authors recognized pr = GitHubPR pytorch pytorch authors = pr get_authors assertIn kit authors assertIn Co-authored-by pr gen_commit_message test_get_checkruns_many_runs args Any - None Tests all checkruns can fetched pr = GitHubPR pytorch pytorch conclusions = pr get_checkrun_conclusions assertEqual len conclusions assertTrue pull linux-docs build-docs-cpp-false conclusions keys test_cancelled_gets_ignored args Any - None Tests cancelled workflow does override existing successful status pr = GitHubPR pytorch pytorch conclusions = pr get_checkrun_conclusions lint_checks = name name conclusions keys Lint name assertTrue len lint_checks assertTrue all conclusions name status == SUCCESS name lint_checks test_get_review_comment_by_id args Any - None Tests even comment requested actually review instead simple comment we can still find pr = GitHubPR pytorch pytorch review_comment_id = comment = pr get_comment_by_id review_comment_id assertIsNotNone comment mock patch trymerge gh_get_pr_info return_value=mock_gh_get_info mock patch trymerge parse_args return_value=mock_parse_args True False mock patch trymerge try_revert side_effect=mock_revert test_main_revert mock_revert Any args Any - None trymerge_main mock_revert assert_called_once mock patch trymerge gh_get_pr_info return_value=mock_gh_get_info mock patch trymerge parse_args return_value=mock_parse_args False True mock patch trymerge gh_remove_label side_effect=mock_remove_label mock patch trymerge merge side_effect=mock_merge test_main_force mock_merge Any mock_parse_args Any args Any - None trymerge_main mock_merge assert_called_once_with mock ANY mock ANY comment_id=mock ANY dry_run=mock ANY skip_mandatory_checks=True ignore_current=False mock patch trymerge gh_get_pr_info return_value=mock_gh_get_info mock patch trymerge parse_args return_value=mock_parse_args False False mock patch trymerge gh_remove_label side_effect=mock_remove_label mock patch trymerge merge side_effect=mock_merge test_main_merge mock_merge Any args Any - None trymerge_main mock_merge assert_called_once_with mock ANY mock ANY comment_id=mock ANY dry_run=mock ANY skip_mandatory_checks=False ignore_current=False mock patch trymerge read_merge_rules side_effect=mocked_read_merge_rules test_revert_rules args Any - None Tests reverts collaborators allowed pr = GitHubPR pytorch pytorch repo = DummyGitRepo assertIsNotNone validate_revert repo pr comment_id= test_get_changed_files args Any - None Tests list changed files PR doesn t include duplicates pr = GitHubPR pytorch pytorch try changed_files = pr get_changed_files except RuntimeError error fail f get_changed_files throws exception error assertEqual len changed_files pr get_changed_files_count test_revert_codev_abandoned_diff_succeeds args Any - None pr = GitHubPR pytorch pytorch GitRepoCoDev DummyGitRepo commit_message ref str - str pr get_body repo = GitRepoCoDev validate_revert repo pr comment_id= test_pr_changed_submodule_detection args Any - None Updates submodule during dev-cycle reverts later pr = GitHubPR pytorch pytorch assertEqual pr get_changed_submodules assertFalse pr has_invalid_submodule_updates PR updates ideep pr = GitHubPR pytorch pytorch assertEqual pr get_changed_submodules third_party ideep assertTrue pr has_invalid_submodule_updates Automated submodule update pr = GitHubPR pytorch pytorch assertEqual pr get_changed_submodules third_party kineto assertFalse pr has_invalid_submodule_updates test_remove_job_name_suffix args Any - None test_cases = name linux-bionic-cuda -py -gcc -sm test default linux g xlarge nvidia gpu expected linux-bionic-cuda -py -gcc -sm test default name android-emulator-build-test build-and-test default ubuntu- - x expected android-emulator-build-test build-and-test default name linux-focal-rocm -py build expected linux-focal-rocm -py build name libtorch-cpu-shared-with-deps-release-build expected libtorch-cpu-shared-with-deps-release-build name manywheel-py _ -cuda _ -test test expected manywheel-py _ -cuda _ -test test name lintrunner linux-job expected lintrunner linux-job name Test ` run_test py ` usable without boto expected Test ` run_test py ` usable without boto case test_cases assertEqual case expected remove_job_name_suffix case name test_get_merge_base args Any - None pr = GitHubPR pytorch pytorch mock_merge_base = mocked-sha mock patch trymerge gh_fetch_merge_base return_value=mock_merge_base mocked_gh_fetch_merge_base assertEqual mock_merge_base pr get_merge_base Make sure consecutive calls will use same merge base instead making another query assertEqual mock_merge_base pr get_merge_base mocked_gh_fetch_merge_base assert_called_once test_app_can_revert args Any - None pr = GitHubPR pytorch pytorch repo = DummyGitRepo app_comment_id impostor_comment_id = Check app can revert assertIsNotNone validate_revert repo pr comment_id=app_comment_id But impostor can assertRaises PostCommentError lambda validate_revert repo pr comment_id=impostor_comment_id Despite s name being name bot assertEqual pr get_comment_by_id impostor_comment_id author_login pytorch-auto-revert mock patch trymerge gh_graphql side_effect=mocked_gh_graphql mock patch trymerge gh_fetch_merge_base return_value= mock patch trymerge get_drci_classifications side_effect=mocked_drci_classifications TestBypassFailures TestCase test_get_classifications args Any - None pr = GitHubPR pytorch pytorch checks = pr get_checkrun_conclusions checks = get_classifications pr pr_num pr project checks assertTrue checks pull linux-focal-py -clang test dynamo linux xlarge classification == BROKEN_TRUNK assertTrue checks trunk win-vs -cpu-py test default windows xlarge nonephemeral classification == FLAKY assertTrue checks pull linux-jammy-py -gcc test distributed linux xlarge classification == FLAKY assertTrue checks pull linux-focal-cuda -py -gcc test distributed linux xlarge nvidia gpu classification == FLAKY Set threshold larger equal number ok failures pending failed ignorable = categorize_checks checks list checks keys ok_failed_checks_threshold= assertTrue len pending == assertTrue len failed == assertTrue len ignorable FLAKY == assertTrue len ignorable BROKEN_TRUNK == Not set any threshold defaults - ignore all flaky broken trunk failures pending failed ignorable = categorize_checks checks list checks keys assertTrue len pending == assertTrue len failed == assertTrue len ignorable FLAKY == assertTrue len ignorable BROKEN_TRUNK == Set threshold lower than number ok failures pending failed ignorable = categorize_checks checks list checks keys ok_failed_checks_threshold= assertTrue len pending == assertTrue len failed == assertTrue len ignorable FLAKY == assertTrue len ignorable BROKEN_TRUNK == Set threshold like when ignore_flaky_failures pending failed ignorable = categorize_checks checks list checks keys ok_failed_checks_threshold= assertTrue len pending == assertTrue len failed == assertTrue len ignorable FLAKY == assertTrue len ignorable BROKEN_TRUNK == test_get_classifications_flaky_fullname args Any - None pr = GitHubPR pytorch pytorch checks = pr get_checkrun_conclusions checks = get_classifications pr pr_num pr project checks pending failed ignorable = categorize_checks checks list checks keys assertTrue len pending == assertTrue len failed == assertTrue len ignorable FLAKY == test_get_classifications_invalid_cancel args Any - None pr = GitHubPR pytorch pytorch checks = pr get_checkrun_conclusions checks = get_classifications pr pr_num pr project checks pending failed ignorable = categorize_checks checks list checks keys assertTrue len pending == assertTrue len failed == assertTrue len ignorable FLAKY == assertTrue len ignorable BROKEN_TRUNK == assertTrue len ignorable UNSTABLE == test_get_classifications_similar_failures args Any - None pr = GitHubPR pytorch pytorch checks = pr get_checkrun_conclusions checks = get_classifications pr pr_num pr project checks pending failed ignorable = categorize_checks checks list checks keys assertTrue len pending == assertTrue len failed == assertTrue len ignorable FLAKY == test_get_classifications_unstable args Any - None pr = GitHubPR pytorch pytorch checks = pr get_checkrun_conclusions checks = get_classifications pr pr_num pr project checks workflow_name = linux-bionic-cuda -py -gcc -bazel-test job_name = build-and-test default linux xlarge nvidia gpu unstable assertTrue checks f pull workflow_name job_name classification == UNSTABLE pending failed ignorable = categorize_checks checks list checks keys ok_failed_checks_threshold= assertTrue len pending == assertTrue len failed == assertTrue len ignorable UNSTABLE == Add another test case where there no unstable keyword job name job has already been marked unstable pr = GitHubPR pytorch executorch checks = pr get_checkrun_conclusions checks = get_classifications pr pr_num pr project checks print checks workflow_name = test-llama-app job_name = mobile-job android assertTrue checks f Android workflow_name job_name classification == UNSTABLE pending failed ignorable = categorize_checks checks list checks keys ok_failed_checks_threshold= assertTrue len pending == assertTrue len failed == assertTrue len ignorable UNSTABLE == test_get_classifications_broken_trunk args Any - None The mock merge base actual value returned gh_fetch_merge_base test_cases = This PR had one broken trunk failure run different shard than one base commit This should still count broken trunk pr_num related_failure_count flaky_or_broken_trunk This PR had one broken trunk failure used ghstack pr_num related_failure_count flaky_or_broken_trunk The failure merge base retried successfully its conclusion changed failure success We want keep failure record merge base so can used detect broken trunk pr_num related_failure_count flaky_or_broken_trunk This PR used Dr CI broken trunk classification pr_num related_failure_count flaky_or_broken_trunk case test_cases pr_num = case pr_num related_failure_count = case related_failure_count flaky_or_broken_trunk = case flaky_or_broken_trunk pr = GitHubPR pytorch pytorch pr_num checks = pr get_checkrun_conclusions checks = get_classifications pr pr_num pr project checks pending failed _ = categorize_checks checks list checks keys assertTrue len pending == assertTrue len failed == related_failure_count When ok_failed_checks_threshold set broken trunk failure won t ignored pending failed _ = categorize_checks checks list checks keys ok_failed_checks_threshold= assertTrue len pending == assertTrue len failed == flaky_or_broken_trunk + related_failure_count test_ignore_current args Any - None Test various interactions failure classifier ensure ignore current checks takes place after other classifications flaky unstable broken trunk Only actual new failures should kept list ignore current checks use record force merge actual failures flaky = pull linux-focal-cuda -py -gcc test distributed linux xlarge nvidia gpu broken_trunk = pull linux-focal-py -clang test dynamo linux xlarge pr = GitHubPR pytorch pytorch checks = pr get_checkrun_conclusions Known flaky failure takes precedence over ignore current need set merge base here get results Dr CI categorize broken trunk failure too checks = get_classifications pr pr_num pr project checks broken_trunk flaky assertTrue checks flaky classification == FLAKY assertTrue checks broken_trunk classification == BROKEN_TRUNK _ failed ignorable = categorize_checks checks list checks keys assertTrue len failed == assertTrue len ignorable IGNORE_CURRENT_CHECK == assertTrue len ignorable FLAKY == assertTrue len ignorable BROKEN_TRUNK == test_get_classifications_wrong_workflow_name args Any - None pr = GitHubPR pytorch pytorch checks = pr get_checkrun_conclusions check_name = linux-binary-conda conda-py _ -cuda _ -build build check_name_workflow_path = github workflows generated-linux-binary-conda-nightly yml conda-py _ -cuda _ -build build Mock check where workflow name uses full path checks check_name_workflow_path = JobCheckState check_name_workflow_path checks check_name url checks check_name status checks check_name classification checks check_name job_id checks check_name title checks check_name summary del checks check_name checks = get_classifications pr pr_num pr project checks pending failed ignorable = categorize_checks checks list checks keys assertTrue len pending == assertTrue len failed == assertTrue len ignorable FLAKY == assertTrue len ignorable BROKEN_TRUNK == test_ignore_failures_older_run_same_workflow args Any - None pr = GitHubPR pytorch pytorch checks = pr get_checkrun_conclusions checks = get_classifications pr pr_num pr project checks pending failed ignorable = categorize_checks checks list checks keys assertTrue len pending == assertTrue len failed == assertTrue len ignorable FLAKY == assertTrue len ignorable UNSTABLE == mock patch trymerge read_merge_rules side_effect=xla_merge_rules test_dont_ignore_flaky_failures args Any - None Regression test https github com pytorch test-infra issues pr = GitHubPR pytorch pytorch repo = DummyGitRepo Check failure classified flaky still raises exception warnings catch_warnings record=True w assertRaises RuntimeError find_matching_merge_rule pr repo assertEqual len w assertIn checks failed likely due flakiness broken trunk str w message mock patch trymerge gh_graphql side_effect=mocked_gh_graphql mock patch trymerge gh_fetch_merge_base return_value= mock patch trymerge get_drci_classifications return_value= TestBypassFailuresOnSandCastle TestCase test_get_classifications args Any - None pr = GitHubPR pytorch pytorch checks = pr get_checkrun_conclusions checks = get_classifications pr pr_num pr project checks pending failed ignorable = categorize_checks checks list checks keys assertTrue len pending == assertTrue len failed == assertTrue len ignorable FLAKY == assertTrue len ignorable BROKEN_TRUNK == test_get_classifications_drci_checkrun_not_found args Any - None pr = GitHubPR pytorch pytorch No summary checks = pr get_checkrun_conclusions checks DRCI_CHECKRUN_NAME = JobCheckState DRCI_CHECKRUN_NAME NEUTRAL None None checks = get_classifications pr pr_num pr project checks pending failed ignorable = categorize_checks checks list checks keys assertTrue len pending == assertTrue len failed == Empty summary checks = pr get_checkrun_conclusions checks DRCI_CHECKRUN_NAME = JobCheckState DRCI_CHECKRUN_NAME NEUTRAL None checks = get_classifications pr pr_num pr project checks pending failed ignorable = categorize_checks checks list checks keys assertTrue len pending == assertTrue len failed == No Dr CI checkrun checks = pr get_checkrun_conclusions del checks DRCI_CHECKRUN_NAME checks = get_classifications pr pr_num pr project checks pending failed ignorable = categorize_checks checks list checks keys assertTrue len pending == assertTrue len failed == mock patch trymerge gh_graphql side_effect=mocked_gh_graphql mock patch trymerge gh_fetch_merge_base return_value= mock patch trymerge get_drci_classifications side_effect=mocked_drci_classifications TestGitHubPRGhstackDependencies TestCase test_pr_dependencies args Any - None pr = GitHubPR pytorch pytorch msg = pr gen_commit_message filter_ghstack=True assertEqual msg f pr get_title \n\n RE_GHSTACK_DESC sub pr get_body \n Pull Request resolved https github com pytorch pytorch pull \n Approved https github com ezyang https github com fegin\n test_pr_dependencies_ghstack args Any - None pr = GitHubPR pytorch pytorch pr = GitHubPR pytorch pytorch pr = GitHubPR pytorch pytorch pr = GitHubPR pytorch pytorch msg = pr gen_commit_message filter_ghstack=True ghstack_deps= pr pr pr assertEqual msg f pr get_title \n\n RE_GHSTACK_DESC sub pr get_body \n Pull Request resolved https github com pytorch pytorch pull \n Approved https github com ezyang https github com fegin\n ghstack dependencies \n skip reason= This test run against mutable PR has changed so no longer works The test should changed mock patch trymerge read_merge_rules mock patch trymerge GitRepo mock patch trymerge get_ghstack_prs test_merge_ghstack_into mock_get_ghstack_prs mock MagicMock mock_repo mock MagicMock mock_merge_rules mock MagicMock args Any - None Test merge_ghstack_into method works correctly pr = GitHubPR pytorch pytorch pr = GitHubPR pytorch pytorch pr = GitHubPR pytorch pytorch pr = GitHubPR pytorch pytorch note reverse order e g pr last commit top stack mock_get_ghstack_prs return_value = pr rev pr rev pr rev pr rev mock_merge_rules return_value = MergeRule Mock title patterns= approved_by= mandatory_checks_name=None mock_repo cherry_pick return_value = None mock_repo amend_commit_message return_value = None Call method under test res = pr merge_ghstack_into mock_repo True assertEqual res pr pr mock_repo cherry_pick assert_any_call rev mock_repo cherry_pick assert_any_call rev assertTrue mock call rev mock_repo cherry_pick call_args_list Verify first call message = mock_repo amend_commit_message call_args_list args prefix = FSDP Optimize away intermediate ` div_ ` HSDP \n\n\r\n ### Background Gradient Pre-Divide suffix = \nPull Request resolved https github com pytorch pytorch pull \nApproved \nghstack dependencies \n assertTrue message startswith prefix assertTrue message endswith suffix Verify second call mock_repo amend_commit_message assert_any_call FSDP Break up ` _post_backward_hook ` into smaller funcs \n\n\n Differential Revision D https our internmc facebook com intern diff D \n Pull Request resolved https github com pytorch pytorch pull \n Approved \n ghstack dependencies \n mock patch trymerge gh_graphql side_effect=mocked_gh_graphql mock patch trymerge gh_fetch_merge_base return_value= mock patch trymerge get_drci_classifications side_effect=mocked_drci_classifications mock patch object DummyGitRepo commit_message TestRevListToPR TestCase Tests _revlist_to_prs function test__revlist_to_prs_zero_matches mock_commit_message mock MagicMock args Any - None If zero PRs mentioned commit message should raise error pr_num = pr = GitHubPR pytorch pytorch pr_num repo = DummyGitRepo mock_commit_message return_value = no PRs assertRaisesRegex RuntimeError PRs mentioned commit dummy lambda _revlist_to_prs repo pr dummy test__revlist_to_prs_two_prs mock_commit_message mock MagicMock args Any - None If two PRs mentioned commit message should raise error pr_num = pr = GitHubPR pytorch pytorch pr_num repo = DummyGitRepo https github com pytorch pytorch commit c e f fd aca b d d d f commit_message = add sticky cache pgo ghstack-source-id bc dee b f bfabccb ba f Pull-Request-resolved https github com pytorch pytorch pull ghstack-source-id bc dee b f bfabccb ba f Pull Request resolved https github com pytorch pytorch pull mock_commit_message return_value = commit_message assertRaisesRegex RuntimeError PRs mentioned commit dummy lambda _revlist_to_prs repo pr dummy mock patch trymerge gh_graphql side_effect=mocked_gh_graphql mock patch trymerge gh_fetch_merge_base return_value= mock patch trymerge get_drci_classifications side_effect=mocked_drci_classifications TestTimelineFunctions TestCase Tests new timeline-related functions test_sha_from_committed_event args Any - None Test extracting SHA committed event Based actual GitHub API format - committed events have sha top level event = event committed sha fb ce ded c d b c assertEqual sha_from_committed_event event fb ce ded c d b c Test missing SHA event_no_sha = event committed assertIsNone sha_from_committed_event event_no_sha test_sha_from_force_push_after args Any - None Test extracting SHA force push event NOTE The current function doesn t handle actual GitHub API format Real force push events have commit_id top level function looks after after_commit after_sha head_sha fields Test legacy format current function handles event_legacy = event head_ref_force_pushed after sha ef bcbc bb f e e ffd d df fc f e assertEqual sha_from_force_push_after event_legacy ef bcbc bb f e e ffd d df fc f e Test current GitHub API format should None current implementation event_real_api = event head_ref_force_pushed commit_id ef bcbc bb f e e ffd d df fc f e assertEqual sha_from_force_push_after event_real_api ef bcbc bb f e e ffd d df fc f e Current function doesn t handle commit_id Test missing SHA event_no_sha = event head_ref_force_pushed assertIsNone sha_from_force_push_after event_no_sha mock patch trymerge gh_fetch_json_list test_iter_issue_timeline_until_comment mock_gh_fetch_json_list Any args Any - None Test timeline iteration until target comment Mock timeline data based actual GitHub API format timeline_data = event commented id body first comment event committed sha fb ce ded c d b c event commented id body target comment event commented id body after target mock_gh_fetch_json_list return_value = timeline_data Test iteration stops target comment events = list iter_issue_timeline_until_comment pytorch pytorch assertEqual len events Should stop target comment assertEqual events event commented assertEqual events id assertEqual events event committed assertEqual events sha fb ce ded c d b c assertEqual events event commented assertEqual events id mock patch trymerge gh_fetch_json_list test_iter_issue_timeline_until_comment_not_found mock_gh_fetch_json_list Any args Any - None Test timeline iteration when target comment found Mock empty timeline mock_gh_fetch_json_list return_value = events = list iter_issue_timeline_until_comment pytorch pytorch assertEqual len events mock patch trymerge iter_issue_timeline_until_comment test_get_commit_sha_at_comment_commit_after_comment mock_iter_timeline Any args Any - None Test get_commit_sha_at_comment returns correct SHA after comment mock_iter_timeline return_value = event committed sha commit event committed sha commit event commented id event head_ref_force_pushed after sha commit pr = GitHubPR pytorch pytorch sha = pr get_commit_sha_at_comment assertEqual sha commit mock patch trymerge iter_issue_timeline_until_comment test_get_commit_sha_at_comment_force_push_before_comment mock_iter_timeline Any args Any - None mock_iter_timeline return_value = event committed sha commit event committed sha commit event head_ref_force_pushed commit_id commit event commented id pr = GitHubPR pytorch pytorch sha = pr get_commit_sha_at_comment assertEqual sha commit mock patch trymerge iter_issue_timeline_until_comment test_get_commit_sha_at_comment_force_push_before_comment_legacy_mode mock_iter_timeline Any args Any - None mock_iter_timeline return_value = event committed sha commit event committed sha commit event head_ref_force_pushed after sha commit event commented id pr = GitHubPR pytorch pytorch sha = pr get_commit_sha_at_comment assertEqual sha commit mock patch trymerge iter_issue_timeline_until_comment test_get_commit_sha_at_comment_multiple_comments mock_iter_timeline Any args Any - None mock_iter_timeline return_value = event committed sha commit event commented id event committed sha commit event commented id event head_ref_force_pushed after sha commit event commented id pr = GitHubPR pytorch pytorch sha = pr get_commit_sha_at_comment assertEqual sha commit sha = pr get_commit_sha_at_comment assertEqual sha commit mock patch trymerge iter_issue_timeline_until_comment test_get_commit_sha_at_comment_no_events mock_iter_timeline Any args Any - None mock_iter_timeline return_value = event commented id event labeled label name test pr = GitHubPR pytorch pytorch sha = pr get_commit_sha_at_comment assertIsNone sha mock patch trymerge iter_issue_timeline_until_comment test_get_commit_sha_at_comment_exception mock_iter_timeline Any args Any - None mock_iter_timeline side_effect = Exception API error pr = GitHubPR pytorch pytorch sha = pr get_commit_sha_at_comment assertIsNone sha __name__ == __main__ main
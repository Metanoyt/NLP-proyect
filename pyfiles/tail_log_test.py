usr bin env python Owner s oncall r p Copyright c Facebook Inc its affiliates All rights reserved This source code licensed under BSD-style license found LICENSE file root directory source tree io os shutil sys tempfile time unittest concurrent futures wait concurrent futures _base ALL_COMPLETED concurrent futures thread ThreadPoolExecutor unittest mock torch distributed elastic multiprocessing tail_log TailLog write max int sleep float file str open file w fp i range max print i file=fp flush=True time sleep sleep TailLogTest unittest TestCase setUp test_dir = tempfile mkdtemp prefix=f __class__ __name__ _ threadpool = ThreadPoolExecutor tearDown shutil rmtree test_dir test_tail writer writes - max number each line log file Run nprocs such writers tail log files into IOString validate all lines accounted nprocs = max = interval_sec = log_files = local_rank os path join test_dir f local_rank _stdout log local_rank range nprocs dst = io StringIO tail = TailLog name= writer log_files=log_files dst=dst interval_sec=interval_sec start sleep here intentional ensure log tail can gracefully handle wait non-existent log files time sleep interval_sec futs = local_rank file log_files items f = threadpool submit write max=max sleep=interval_sec local_rank file=file futs append f wait futs return_when=ALL_COMPLETED assertFalse tail stopped tail stop dst seek actual dict int set int = line dst readlines header num = line split nums = actual setdefault header set nums add int num assertEqual nprocs len actual assertEqual f writer i set range max i range nprocs actual assertTrue tail stopped test_tail_write_to_dst_file writer writes - max number each line log file Run nprocs such writers tail log files into temp file validate all lines accounted nprocs = max = interval_sec = log_files = local_rank os path join test_dir f local_rank _stdout log local_rank range nprocs dst = os path join test_dir tailed_stdout log tail = TailLog name= writer log_files=log_files dst=dst interval_sec=interval_sec start sleep here intentional ensure log tail can gracefully handle wait non-existent log files time sleep interval_sec futs = local_rank file log_files items f = threadpool submit write max=max sleep=interval_sec local_rank file=file futs append f wait futs return_when=ALL_COMPLETED assertFalse tail stopped tail stop actual dict int set int = open dst dst_file line dst_file header num = line split nums = actual setdefault header set nums add int num assertEqual nprocs len actual assertEqual f writer i set range max i range nprocs actual assertTrue tail stopped test_tail_with_custom_prefix writer writes - max number each line log file Run nprocs such writers tail log files into IOString validate all lines accounted nprocs = max = interval_sec = log_files = local_rank os path join test_dir f local_rank _stdout log local_rank range nprocs dst = io StringIO log_line_prefixes = n f worker n n n range nprocs tail = TailLog writer log_files dst interval_sec=interval_sec log_line_prefixes=log_line_prefixes start sleep here intentional ensure log tail can gracefully handle wait non-existent log files time sleep interval_sec futs = local_rank file log_files items f = threadpool submit write max=max sleep=interval_sec local_rank file=file futs append f wait futs return_when=ALL_COMPLETED assertFalse tail stopped tail stop dst seek headers set str = set line dst readlines header _ = line split headers add header assertEqual nprocs len headers i range nprocs assertIn f worker i i headers assertTrue tail stopped test_tail_with_custom_filter writer writes - max number each line log file Run nprocs such writers tail log files into IOString validate all lines accounted nprocs = max = interval_sec = log_files = local_rank os path join test_dir f local_rank _stdout log local_rank range nprocs dst = io StringIO tail = TailLog writer log_files dst interval_sec=interval_sec log_line_filter=lambda line line only print lines containing start sleep here intentional ensure log tail can gracefully handle wait non-existent log files time sleep interval_sec futs = local_rank file log_files items f = threadpool submit write max=max sleep=interval_sec local_rank file=file futs append f wait futs return_when=ALL_COMPLETED assertFalse tail stopped tail stop dst seek actual dict int set int = line dst readlines header num = line split nums = actual setdefault header set nums add int num assertEqual nprocs len actual assertEqual f writer i i range nprocs actual assertTrue tail stopped test_tail_no_files Ensures log tail can gracefully handle no log files which case does nothing tail = TailLog writer log_files= dst=sys stdout start assertFalse tail stopped tail stop assertTrue tail stopped test_tail_logfile_never_generates Ensures we properly shutdown threadpool even when logfile never generates tail = TailLog writer log_files= foobar log dst=sys stdout start tail stop assertTrue tail stopped assertTrue tail _threadpool _shutdown mock patch torch distributed elastic multiprocessing tail_log logger test_tail_logfile_error_in_tail_fn mock_logger Ensures when there error tail_fn one runs threadpool dealt raised properly try giving tail log directory should fail IsADirectoryError tail = TailLog writer log_files= test_dir dst=sys stdout start tail stop mock_logger error assert_called_once
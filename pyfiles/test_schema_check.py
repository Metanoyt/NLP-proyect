Owner s oncall jit ruff noqa F os sys torch torch utils _pytree tree_map unittest torch testing _internal common_utils run_tests TEST_WITH_TORCHDYNAMO torch fx operator_schemas normalize_function torch _subclasses schema_check_mode SchemaCheckMode torch utils _python_dispatch TorchDispatchMode torch testing _internal common_methods_invocations op_db torch testing _internal jit_utils JitTestCase torch testing _internal common_device_type ops OpDTypes instantiate_device_type_tests torch testing _internal common_utils IS_WINDOWS slowTestIf pytorch_test_dir = os path dirname os path dirname os path realpath __file__ sys path append pytorch_test_dir secretly_aliasing x x view - secretly_mutating x x mul_ x output_is_input x x custom_lib = torch library Library bad_schemas DEF noqa TOR custom_lib define secretly_aliasing Tensor x - Tensor custom_lib define secretly_mutating Tensor x - Tensor custom_lib define output_is_input Tensor x - Tensor custom_lib_cpu = torch library Library bad_schemas IMPL CPU noqa TOR custom_lib_cpu impl secretly_aliasing secretly_aliasing custom_lib_cpu impl secretly_mutating secretly_mutating custom_lib_cpu impl output_is_input output_is_input custom_lib_meta = torch library Library bad_schemas IMPL Meta noqa TOR custom_lib_meta impl secretly_aliasing secretly_aliasing custom_lib_meta impl secretly_mutating secretly_mutating custom_lib_meta impl output_is_input output_is_input This TorchDispatchTensor Subclass used simulate incorrect schema which then used test SchemaCheckMode behaves expected IncorrectAliasTensor torch Tensor ALIAS_ARG_OUT = aten add ALIAS_OUT_OUT = aten aminmax MUTATE_ARGS_OUT = aten sub elem torch Tensor __slots__ = elem staticmethod __new__ cls elem args kwargs The wrapping tensor IncorrectAliasTensor shouldn t hold any memory question should still advertise same device before r = torch Tensor _make_wrapper_subclass type ignore attr-defined cls elem size strides=elem stride storage_offset=elem storage_offset TODO clone storage aliasing dtype=elem dtype layout=elem layout device=elem device requires_grad=kwargs get requires_grad False real tensor held element tensor r elem = elem detach r requires_grad elem r __repr__ super __repr__ tensor_contents=f elem classmethod __torch_dispatch__ cls func types args= kwargs=None unwrap e e elem isinstance e cls e wrap e cls e isinstance e torch Tensor e unwrapped_args = tree_map unwrap args out = func unwrapped_args tree_map unwrap kwargs func _schema name IncorrectAliasTensor ALIAS_ARG_OUT args elem = out func _schema name IncorrectAliasTensor MUTATE_ARGS_OUT args elem = torch rand args elem shape func _schema name IncorrectAliasTensor ALIAS_OUT_OUT incorrect_out = list out incorrect_out = incorrect_out tree_map wrap tuple incorrect_out tree_map wrap out Tests various schema checking functionalities TestSchemaCheck JitTestCase setUp TEST_WITH_TORCHDYNAMO skipTest SchemaCheckMode ignored dynamo super setUp Tests SchemaCheckMode records operator order grad test_schema_check_mode_operator_order SchemaCheckMode schema_check x = torch rand requires_grad=True x relu sin assertEqual aten rand aten relu aten detach aten sin schema_check ops Tests SchemaCheckMode records operator order without grad test_schema_check_mode_operator_order_without_grad SchemaCheckMode schema_check x = torch rand requires_grad=False x relu sin assertEqual aten rand aten relu aten sin schema_check ops Tests SchemaCheckMode records mutations aliases none expected test_schema_check_mode_mutated_aliasing_none NB previously requires_grad=True induces detach saved variable x = torch rand SchemaCheckMode schema_check actual = x relu sin assertEqual schema_check mutated assertEqual schema_check aliasing Tests SchemaCheckMode records mutations aliases mutation expected test_schema_check_mode_mutated_aliasing_mutation actual = torch rand requires_grad=False SchemaCheckMode schema_check actual sinh_ assertEqual aten sinh_ input schema_check mutated assertEqual aten sinh_ input output_ schema_check aliasing Tests SchemaCheckMode records mutations aliases resize_ test_schema_check_mode_mutated_aliasing_resize_ actual = torch rand requires_grad=False SchemaCheckMode schema_check actual resize_ assertEqual aten resize_ input schema_check mutated assertEqual aten resize_ input output_ schema_check aliasing Tests SchemaCheckMode records mutations aliases aliasing inputs test_schema_check_mode_mutated_aliasing_aliasing_inputs actual = torch rand y = actual SchemaCheckMode schema_check actual add_ y assertEqual aten add_ input aten add_ other schema_check mutated assertEqual aten add_ input output_ aten add_ other output_ schema_check aliasing Tests SchemaCheckMode records mutations alias as_strided test_schema_check_mode_mutated_aliasing_as_strided x = torch rand SchemaCheckMode schema_check x as_strided_ assertEqual aten as_strided_ input schema_check mutated assertEqual aten as_strided_ input output_ schema_check aliasing Tests SchemaCheckMode records mutations aliases multiple outputs test_schema_check_mode_mutated_aliasing_multiple_outputs x = torch arange m_actual = torch arange e_actual = torch zeros dtype=torch int SchemaCheckMode schema_check torch frexp x out= m_actual e_actual assertEqual aten frexp mantissa aten frexp exponent schema_check mutated assertEqual aten frexp mantissa output_ aten frexp exponent output_ schema_check aliasing Tests SchemaCheckMode records mutations aliases aliasing outputs test_schema_check_mode_mutated_aliasing_aliasing_outputs x = torch rand actual = torch zeros SchemaCheckMode schema_check torch aminmax x dim= out= actual actual assertEqual aten aminmax min aten aminmax max schema_check mutated assertEqual aten aminmax min output_ aten aminmax min output_ aten aminmax max output_ aten aminmax max output_ schema_check aliasing Tests SchemaCheckMode wraps torch Tensor test_schema_check_mode_functionality x = torch rand requires_grad=True expected = x relu sin SchemaCheckMode actual = x relu sin assertEqual expected actual Tests SchemaCheckMode wraps torch Tensor when argument s default overridden test_schema_check_mode_functionality_default_replaced x = torch rand requires_grad=True expected = x add x alpha= SchemaCheckMode actual = x add x alpha= assertEqual expected actual Tests SchemaCheckMode wraps torch Tensor when there Tensor argument test_schema_check_mode_functionality_list_input = torch rand b = torch rand c = torch rand expected = torch linalg multi_dot b c SchemaCheckMode actual = torch linalg multi_dot b c assertEqual expected actual Tests SchemaCheckMode wraps torch Tensor op has - notation test_schema_check_mode_functionality_wildcard_after x = torch rand expected = x chunk SchemaCheckMode actual = x chunk assertEqual expected actual Tests SchemaCheckMode wraps torch Tensor when there kwarg tensor input unittest skipIf torch _C has_spectral ATen built FFT test_schema_check_mode_functionality_kwarg_tensor x = torch rand w = torch rand expected = torch stft x win_length= window=w return_complex=True SchemaCheckMode actual = torch stft x win_length= window=w return_complex=True assertEqual expected actual Tests SchemaCheckMode wraps torch Tensor mutable op test_schema_check_mode_functionality_mutable_inputs expected = torch rand requires_grad=False actual = torch clone expected expected sinh_ SchemaCheckMode actual sinh_ assertEqual expected actual Tests SchemaCheckMode wraps Torch tensor when inputs alias test_schema_check_mode_functionality_aliasing_inputs expected = torch rand x = expected actual = torch clone expected y = actual expected add_ x SchemaCheckMode actual add_ y assertEqual expected actual Tests SchemaCheckMode wraps Torch tensor multiple tensor outputs test_schema_check_mode_functionality_with_multiple_outputs x = torch arange m_expected e_expected = torch frexp x m_actual = torch arange e_actual = torch zeros dtype=torch int SchemaCheckMode torch frexp x out= m_actual e_actual assertEqual m_expected m_actual assertEqual e_expected e_actual Tests SchemaCheckMode wraps Torch tensor aliasing outputs due aliasing inputs test_schema_check_mode_functionality_with_multiple_outputs_aliasing x = torch rand actual = torch zeros SchemaCheckMode torch aminmax x dim= out= actual actual assertEqual torch amax x dim= actual Tests SchemaCheckMode wraps Torch tensor ops real Device input test_schema_check_mode_functionality_device_input SchemaCheckMode x = torch rand device= cpu dtype=torch double y = x + x assertEqual x + x y Tests SchemaCheckMode wraps Torch tensor special training op edge case test_schema_check_mode_functionality_training_op x = torch rand requires_grad=True batch = torch nn BatchNorm d track_running_stats=True expected = batch x SchemaCheckMode actual = batch x assertEqual expected actual Tests SchemaCheckMode wraps Torch tensor nested training op edge case test_schema_check_mode_functionality_nested_training_op actual = torch rand batch = torch nn BatchNorm d track_running_stats=True expected = torch clone actual expected sinh_ expected tanh_ expected relu_ expected = batch expected SchemaCheckMode actual sinh_ actual tanh_ actual relu_ actual = batch actual assertEqual expected actual Tests SchemaCheckMode wraps Torch tensor empty list input test_schema_check_mode_empty_list_input expected = torch atleast_ d SchemaCheckMode actual = torch atleast_ d assertEqual expected actual Tests exception raised mismatching mutation test_mutation_check_fail assertRaisesRegex RuntimeError Argument input defined mutable mutated x = torch rand y = torch rand SchemaCheckMode IncorrectAliasTensor x sub IncorrectAliasTensor y Tests exception raised mismatching mutation over multiple ops test_mutation_check_fail_multiple_operators assertRaisesRegex RuntimeError Argument input defined mutable mutated x = torch rand y = torch rand SchemaCheckMode IncorrectAliasTensor x sin cos sub IncorrectAliasTensor y Tests exception raised mismatching alias test_alias_check_fail_simple assertRaisesRegex RuntimeError Argument input defined alias output aliasing x = torch rand requires_grad=True y = torch rand SchemaCheckMode IncorrectAliasTensor x add IncorrectAliasTensor y alpha= Tests exception raised mismatching alias over multiple ops test_alias_check_fail_multiple_operators assertRaisesRegex RuntimeError Argument input defined alias output aliasing x = torch rand requires_grad=True y = torch zeros requires_grad=True SchemaCheckMode IncorrectAliasTensor x sin relu add IncorrectAliasTensor y alpha= Tests exception raised centered mismatching alias over multiple ops test_alias_check_fail_multiple_operators_centered assertRaisesRegex RuntimeError Argument input defined alias output aliasing x = torch rand requires_grad=True y = torch zeros requires_grad=True SchemaCheckMode IncorrectAliasTensor x sin add IncorrectAliasTensor y alpha= relu Tests exception raised centered mismatching alias over multiple ops test_alias_check_fail_outputs_unexpectedly_aliasing assertRaisesRegex RuntimeError Outputs alias unexpectedly x = torch rand SchemaCheckMode s IncorrectAliasTensor x aminmax dim= When file written python op registration didn t exist It s probably worth re-writing entire file use instead I just added extra tests test_alias_check_fail_custom_ops_secretly_aliasing f x torch ops bad_schemas secretly_aliasing x x = torch rand assertRaisesRegex RuntimeError defined alias output aliasing SchemaCheckMode s out = f x test_alias_check_fail_custom_ops_secretly_mutating f x torch ops bad_schemas secretly_mutating x x = torch rand assertRaisesRegex RuntimeError defined mutable mutated SchemaCheckMode s out = f x test_alias_check_fail_custom_ops_output_is_input f x torch ops bad_schemas output_is_input x x = torch rand assertRaisesRegex RuntimeError allowed directly inputs SchemaCheckMode s out = f x Tests is_alias_of returns expected test_is_alias_of_basic x = torch rand requires_grad=True y = torch rand requires_grad=True y = x add x alpha= assertTrue torch _C _is_alias_of x x assertFalse torch _C _is_alias_of x y Tests is_alias_of returns expected empty containers test_is_alias_of_empty_container x = y = torch rand requires_grad=True assertFalse torch _C _is_alias_of x x assertFalse torch _C _is_alias_of x y Tests overlaps returns expected test_overlaps_basic x = torch rand requires_grad=True y = torch rand requires_grad=True z = x y assertTrue torch _C _overlaps x x assertFalse torch _C _overlaps x y assertTrue torch _C _overlaps z x assertTrue torch _C _overlaps z y Tests overlaps returns correctly empty containers test_overlaps_empty_container x = y = torch rand requires_grad=True Empty containers false assertFalse torch _C _overlaps y x assertTrue torch _C _overlaps y y Tests SchemaInfo Bindings work expected test_schema_info_bind_basic SchemaInfoBindTestMode TorchDispatchMode __init__ test_self test_self = test_self __torch_dispatch__ func types args= kwargs=None named_arg_list = normalize_function func args kwargs normalize_to_only_use_kwargs=True kwargs schema_info_value_test = torch _C _SchemaInfo func _schema schema_info_values_test = torch _C _SchemaInfo func _schema test_self assertFalse schema_info_value_test may_alias torch _C _SchemaArgument torch _C _SchemaArgType input torch _C _SchemaArgument torch _C _SchemaArgType input test_self assertFalse schema_info_values_test may_alias torch _C _SchemaArgument torch _C _SchemaArgType input torch _C _SchemaArgument torch _C _SchemaArgType input i named_arg_list schema_info_value_test add_argument_value i named_arg_list i schema_info_values_test add_argument_values named_arg_list test_self assertTrue schema_info_value_test may_alias torch _C _SchemaArgument torch _C _SchemaArgType input torch _C _SchemaArgument torch _C _SchemaArgType input test_self assertTrue schema_info_values_test may_alias torch _C _SchemaArgument torch _C _SchemaArgType input torch _C _SchemaArgument torch _C _SchemaArgType input func args kwargs x = torch rand SchemaInfoBindTestMode schemaInfoCheck x add x TestSchemaCheckModeOpInfo JitTestCase ops op_db dtypes=OpDTypes supported slowTestIf IS_WINDOWS test_schema_correctness device dtype op Currently torch equal isn t supported torch complex There s also errors complex complex dtype == torch complex sample op sample_inputs device dtype requires_grad=False SchemaCheckMode op sample input sample args sample kwargs instantiate_device_type_tests TestSchemaCheckModeOpInfo globals only_for= cpu cuda __name__ == __main__ run_tests
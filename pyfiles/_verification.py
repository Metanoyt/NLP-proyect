__future__ annotations __all__ = VerificationInfo verify_onnx_program dataclasses logging math typing Any TYPE_CHECKING torch torch utils _pytree TYPE_CHECKING onnxscript ir torch onnx _internal exporter _onnx_program logger = logging getLogger __name__ dataclasses dataclass VerificationInfo Verification information value ONNX program This contains maximum absolute difference maximum relative difference histograms absolute relative differences between expected actual values It also includes expected actual data types The histograms represented tuples tensors where first tensor histogram counts second tensor bin edges Attributes name The name value output intermediate max_abs_diff The maximum absolute difference between expected actual values max_rel_diff The maximum relative difference between expected actual values abs_diff_hist A tuple tensors representing histogram absolute differences The first tensor histogram counts second tensor bin edges rel_diff_hist A tuple tensors representing histogram relative differences The first tensor histogram counts second tensor bin edges expected_dtype The data type expected value actual_dtype The data type actual value name str max_abs_diff float max_rel_diff float abs_diff_hist tuple torch Tensor torch Tensor rel_diff_hist tuple torch Tensor torch Tensor expected_dtype torch dtype actual_dtype torch dtype NOTE We don t need include shape because expected shape already known checked runtime classmethod from_tensors cls name str expected torch Tensor &#124; float &#124; int &#124; bool actual torch Tensor &#124; float &#124; int &#124; bool - VerificationInfo Create VerificationInfo object two tensors Args name The name value expected The expected tensor actual The actual tensor Returns VerificationInfo The VerificationInfo object isinstance expected torch Tensor expected = torch tensor expected isinstance actual torch Tensor actual = torch tensor actual max_abs_diff max_rel_diff abs_diff rel_diff = _compare_tensors expected actual bins = torch tensor e- e- e- e- e- e- dtype=torch float abs_diff_hist = torch histogram abs_diff float bins=bins rel_diff_hist = torch histogram rel_diff float bins=bins cls name=name max_abs_diff=max_abs_diff max_rel_diff=max_rel_diff abs_diff_hist=abs_diff_hist rel_diff_hist=rel_diff_hist expected_dtype=expected dtype actual_dtype=actual dtype asdict - dict str Any Convert VerificationInfo object dictionary Returns A dictionary representation VerificationInfo object name name max_abs_diff max_abs_diff max_rel_diff max_rel_diff abs_diff_hist abs_diff_hist tolist abs_diff_hist tolist rel_diff_hist rel_diff_hist tolist rel_diff_hist tolist expected_dtype str expected_dtype actual_dtype str actual_dtype _compare_tensors expected torch Tensor actual torch Tensor - tuple float float torch Tensor torch Tensor Move tensors same device expected = expected detach cpu actual = actual detach cpu expected numel == actual numel == math inf math inf torch tensor math inf torch tensor math inf expected dtype == torch bool expected = expected torch float actual = actual torch float torch is_complex expected expected = torch view_as_real expected abs_diff = torch abs expected - actual eps = e- normalizer = torch abs expected + eps rel_diff = abs_diff normalizer max_absolute_difference = abs_diff max item max_relative_difference = rel_diff max item max_absolute_difference max_relative_difference abs_diff rel_diff verify_onnx_program onnx_program _onnx_program ONNXProgram args tuple Any &#124; None = None kwargs dict str Any &#124; None = None compare_intermediates bool = False - list VerificationInfo Verify ONNX model comparing values expected values ExportedProgram Args onnx_program The ONNX program verify args The input arguments model kwargs The keyword arguments model compare_intermediates Whether verify intermediate values This going take longer time so disabled default Returns VerificationInfo objects containing verification information each value exported_program = onnx_program exported_program exported_program None raise ValueError The ONNX program does contain exported_program Please provide exported_program verify ONNX program args None kwargs None User did provide example inputs use default example inputs exported_program example_inputs None raise ValueError No example inputs provided exported_program does contain example inputs Please provide arguments verify ONNX program args kwargs = exported_program example_inputs args None args = kwargs None kwargs = Flatten args ONNX program VerificationInterpreter flat_args _ = exported_program _get_flat_args_with_check args kwargs compare_intermediates Compare output values torch_outputs _ = _pytree tree_flatten exported_program module args kwargs onnx_outputs = onnx_program flat_args results = torch_output onnx_output output_val zip torch_outputs onnx_outputs onnx_program model graph outputs results append VerificationInfo from_tensors name=str output_val name expected=torch_output actual=onnx_output results Use _VerificationInterpreter get intermediate values By design output values included too interpreter = _VerificationInterpreter onnx_program interpreter run flat_args interpreter verification_infos _create_value_mapping graph ir Graph - dict str ir Value Return dictionary mapping names values graph The mapping does include values subgraphs Args graph The graph extract mapping Returns A dictionary mapping names values values dict str ir Value = values update graph initializers The names values can None which we need exclude input graph inputs input name continue values input name = input node graph value node outputs value name continue values value name = value values _VerificationInterpreter torch fx Interpreter Interpreter verifying converted ONNX model accuracy comparing intermediate values To compare models first initialize interpreter ONNX program Then call meth ` run ` method input arguments execute model The meth ` run ` method will execute model populate attr ` verification_infos ` attribute verification information each value onnx_program = torch onnx export model args dynamo=True interpreter = _VerificationInterpreter onnx_program interpreter run args verification_infos = interpreter verification_infos info verification_infos print value name info name info The verification information includes maximum absolute difference maximum relative difference histograms absolute relative differences between expected actual values See ` VerificationInfo ` more details Attributes verification_infos A list verification information each value It populated when ` run ` method called __init__ onnx_program torch onnx ONNXProgram - None Initialize _VerificationInterpreter ONNX program Args onnx_program The ONNX program verify onnx_program exported_program None raise ValueError The ONNX program does contain exported_program Please provide exported_program verify ONNX program super __init__ onnx_program exported_program module _onnx_program = onnx_program _onnx_values = _create_value_mapping onnx_program model graph _args tuple Any = verification_infos list VerificationInfo = run args Any initial_env dict torch fx Node Any &#124; None = None enable_io_processing bool = True - Any Run interpreter given input arguments This method executes model populates attr ` verification_infos ` attribute verification information each value Args args The input arguments model initial_env The initial environment interpreter enable_io_processing Whether enable IO processing Returns Any The result executing model verification_infos = _args = args super run args initial_env=initial_env enable_io_processing=enable_io_processing run_node n torch fx Node - Any result = super run_node n n op = call_function result node_name = n name node_name _onnx_values result try onnx_result = _onnx_program compute_values node_name _args except Exception logger warning Failed compute value node s node_name exc_info=True result info = VerificationInfo from_tensors name=node_name expected=result actual=onnx_result verification_infos append info info max_abs_diff info max_rel_diff logger warning Verification info node s max_abs_diff s max_rel_diff s node_name info max_abs_diff info max_rel_diff logger info Verification info node s max_abs_diff s max_rel_diff s node_name info max_abs_diff info max_rel_diff result
Owner s module fx dataclasses collections defaultdict torch torch fx passes operator_support op_support torch fx passes splitter_base splitter_base torch fx passes split_utils split_by_tags torch testing _internal common_utils TestCase torch jit script dataclasses dataclass DummyDataClass int b int c int torch fx wrap wrapped_add _dataclass y _dataclass c + y TestFXSplit TestCase test_split_preserve_node_meta TestModule torch nn Module forward x y x = x + x y = y y x - y gm = torch fx symbolic_trace TestModule node gm graph nodes node meta name = node name node name == add node tag = node name == mul node tag = b node name == sub node tag = c split_gm = split_by_tags gm b c m split_gm children n m graph nodes n op = output assertIn name n meta assertEqual n meta name n name Validate metadata copied correctly graph placeholder nodes node split_gm graph nodes node op == placeholder assertIn name node meta assertEqual node meta name node name test_dataclass_as_graph_entry Test splitting works when graph entry dataclass instance wrapped function called resulting call_function node no input dependencies This tests edge case fixed D where call_function nodes no dependencies should handled properly starter_nodes method Graph visualization y input DummyDataClass no input deps result call_function_node \ \ wrapped_add &#124; z output noqa W TestModuleWithFunctionEntry torch nn Module forward y This creates call_function node no input dependencies dummy_data_class = DummyDataClass z = wrapped_add dummy_data_class y z mod = TestModuleWithFunctionEntry gm = torch fx symbolic_trace mod Create custom operator support mark wrapped_add supported CustomOpSupport op_support OperatorSupportBase is_node_supported submodules node - bool node target == wrapped_add Create simple splitter test edge case TestSplitter splitter_base _SplitterBase __init__ module sample_input operator_support settings = splitter_base _SplitterSettingBase super __init__ module sample_input operator_support settings Create splitter instance - tests fix where call_function nodes no input dependencies properly handled starter_nodes splitter = TestSplitter module=gm sample_input= torch randn operator_support=CustomOpSupport This should raise exception tests fix D The fix allows call_function nodes no dependencies valid starter nodes split_result = splitter Verify splitting worked correctly assertIsNotNone split_result Test split module produces same result original test_input = torch randn original_result = mod test_input split_module_result = split_result test_input assertTrue torch equal original_result split_module_result TestSplitByTags TestCase TestModule torch nn Module __init__ - None super __init__ linear = torch nn Linear linear = torch nn Linear linear = torch nn Linear linear = torch nn Linear forward x torch Tensor x torch Tensor x torch Tensor - torch Tensor v = linear x v = linear x v = linear x v = torch cat v v v linear v staticmethod trace_and_tag module torch nn Module tags list str - tuple torch fx GraphModule dict str list str Test simple gm consists nodes tag only show call_module nodes here linear - tag red linear - tag blue linear linear - tag green At beginning we have gm linear linear linear linear split_gm = split_by_tags gm tags Then we have split_gm red linear blue linear green linear linear tag_node = defaultdict list gm torch fx GraphModule = torch fx symbolic_trace module Add tag all nodes build dictionary record tag call_module nodes node gm graph nodes linear node name node tag = tags tag_node tags append node name linear node name node tag = tags tag_node tags append node name node tag = tags node op == call_module tag_node tags append node name gm tag_node test_split_by_tags - None tags = red blue green module = TestSplitByTags TestModule gm tag_node = TestSplitByTags trace_and_tag module tags split_gm orig_to_split_fqn_mapping = split_by_tags gm tags return_fqn_mapping=True Ensure split_gm has only has ordered submodules named red_ blue_ green_ idx name _ enumerate split_gm named_children idx len tags assertTrue name == tags idx f split_gm has incorrect submodule named name Ensure each submodule has expected ordered call_module node s For example submodule named split_gm red_ has only has linear split_gm green_ has only has linear linear order sub_graph_idx = sub_name sub_graph_module split_gm named_children node_idx = node sub_graph_module graph nodes node op = call_module continue assertTrue node name == tag_node f sub_name node_idx pyre-fixme ` name ` undefined always defined f sub_name has incorrectly include node name node_idx += sub_graph_idx += assertEqual orig_to_split_fqn_mapping linear red linear linear blue linear linear green linear linear green linear f orig_to_split_fqn_mapping= TestSplitOutputType TestCase TestModule torch nn Module __init__ - None super __init__ conv = torch nn Conv d stride= bias=True relu = torch nn ReLU forward x conv = conv x conv = conv relu = relu conv relu staticmethod trace_and_tag module torch nn Module inputs torch Tensor tags list str - tuple torch fx GraphModule dict str list str Test simple gm consists nodes tag only show call_module nodes here conv - tag red mul - tag blue relu - tag green At beginning we have gm conv mul relu split_gm = split_by_tags gm tags Then we have split_gm red conv blue mul green relu tag_node = defaultdict list gm torch fx GraphModule = torch export export module inputs strict=True module Add tag all nodes build dictionary record tag call_module nodes node gm graph nodes conv node name node tag = tags tag_node tags append node name mul node name node tag = tags tag_node tags append node name node tag = tags node op == call_module tag_node tags append node name gm tag_node test_split_by_tags - None tags = red blue green module = TestSplitOutputType TestModule inputs = torch randn gm _ = TestSplitOutputType trace_and_tag module inputs tags split_gm _ = split_by_tags gm tags return_fqn_mapping=True gm_output = module inputs split_gm_output = split_gm inputs assertTrue type gm_output type split_gm_output assertTrue torch equal gm_output split_gm_output __name__ == __main__ raise RuntimeError This test currently used should enabled discover_tests py required
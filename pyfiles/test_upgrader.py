Owner s oncall export json torch torch testing _internal common_utils TestCase TestUpgrader TestCase setUp - None Register example upgraders dynamically torch _C _export register_example_upgraders tearDown - None Clean up registered upgraders torch _C _export deregister_example_upgraders test_nn_module_stack_transformation_from_v Test nn_module_stack strings prepended test_upgrader_ when upgrading version Create mock JSON object simulates version schema nn_module_stack string needs upgraded mock_json = schema_version major minor graph_module graph nodes target aten add Tensor inputs outputs metadata nn_module_stack original_stack_info other_field some_value target aten mul Tensor inputs outputs metadata nn_module_stack another_stack stack_trace some trace Test upgrader using Python binding serialized_json = json dumps mock_json upgraded_json_str = torch _C _export upgrade serialized_json upgraded_json = json loads upgraded_json_str Verify schema version updated version - version due both v v upgraders assertEqual upgraded_json schema_version major assertEqual upgraded_json schema_version minor Verify nn_module_stack prepended test_upgrader_ nodes = upgraded_json graph_module graph nodes Check first node first_node_metadata = nodes metadata nn_stack = first_node_metadata nn_module_stack assertIsInstance nn_stack str assertEqual nn_stack test_upgrader_original_stack_info Other metadata should unchanged assertEqual first_node_metadata other_field some_value Check second node second_node_metadata = nodes metadata nn_stack = second_node_metadata nn_module_stack assertIsInstance nn_stack str assertEqual nn_stack test_upgrader_another_stack Other metadata should unchanged assertEqual second_node_metadata stack_trace some trace test_nn_module_stack_error_handling_invalid_type Test error handling when nn_module_stack string Test case nn_module_stack string mock_json_invalid_type = schema_version major minor graph_module graph nodes target aten add Tensor inputs outputs metadata nn_module_stack Invalid should string assertRaisesRegex RuntimeError Error upgrader version_ _upgrader_registered serialized_json = json dumps mock_json_invalid_type torch _C _export upgrade serialized_json test_nodes_without_metadata_handled_gracefully Test nodes without metadata nn_module_stack handled gracefully mock_json = schema_version major minor graph_module graph nodes target aten add Tensor inputs outputs No metadata field target aten mul Tensor inputs outputs metadata stack_trace some trace No nn_module_stack field Should raise error serialized_json = json dumps mock_json upgraded_json_str = torch _C _export upgrade serialized_json upgraded_json = json loads upgraded_json_str Verify schema version updated version - version due both v v upgraders assertEqual upgraded_json schema_version major assertEqual upgraded_json schema_version minor Verify nodes unchanged nodes = upgraded_json graph_module graph nodes assertEqual len nodes First node should have no metadata assertNotIn metadata nodes Second node should have unchanged metadata assertEqual nodes metadata stack_trace some trace assertNotIn nn_module_stack nodes metadata test_field_renaming_chain_from_v _complete Test complete field renaming chain v old_test_field - new_test_field - new_test_field mock_json = schema_version major minor graph_module graph inputs outputs nodes target aten add Tensor inputs outputs metadata nn_module_stack test_stack old_test_field original_value existing_field existing_value Test upgrader using Python binding serialized_json = json dumps mock_json upgraded_json_str = torch _C _export upgrade serialized_json upgraded_json = json loads upgraded_json_str Verify schema version updated version - version due both v v upgraders assertEqual upgraded_json schema_version major assertEqual upgraded_json schema_version minor Verify complete field transformation old_test_field - new_test_field - new_test_field graph = upgraded_json graph_module graph assertIn new_test_field graph assertEqual graph new_test_field original_value assertNotIn old_test_field graph assertNotIn new_test_field graph Verify existing fields preserved assertEqual graph existing_field existing_value assertIn inputs graph assertIn outputs graph assertIn nodes graph Verify nn_module_stack also upgraded other upgrader nodes = graph nodes assertEqual nodes metadata nn_module_stack test_upgrader_test_stack test_field_renaming_chain_from_v _missing_field Test upgraders work gracefully when old_test_field doesn t exist mock_json = schema_version major minor graph_module graph inputs outputs nodes existing_field existing_value Test upgrader using Python binding serialized_json = json dumps mock_json upgraded_json_str = torch _C _export upgrade serialized_json upgraded_json = json loads upgraded_json_str Verify schema version updated version - version due both v v upgraders assertEqual upgraded_json schema_version major assertEqual upgraded_json schema_version minor Verify no field transformations occurred since old_test_field didn t exist graph = upgraded_json graph_module graph assertNotIn new_test_field graph assertNotIn new_test_field graph assertNotIn old_test_field graph Verify existing fields preserved assertEqual graph existing_field existing_value assertIn inputs graph assertIn outputs graph assertIn nodes graph test_field_renaming_from_v _partial_chain Test partial upgrade chain starting v new_test_field - new_test_field mock_json = schema_version major minor graph_module graph inputs outputs nodes new_test_field test_value existing_field existing_value Test upgrader using Python binding serialized_json = json dumps mock_json upgraded_json_str = torch _C _export upgrade serialized_json upgraded_json = json loads upgraded_json_str Verify schema version updated version - version due v upgrader only assertEqual upgraded_json schema_version major assertEqual upgraded_json schema_version minor Verify new_test_field renamed new_test_field graph = upgraded_json graph_module graph assertIn new_test_field graph assertEqual graph new_test_field test_value assertNotIn new_test_field graph Verify existing fields preserved assertEqual graph existing_field existing_value assertIn inputs graph assertIn outputs graph assertIn nodes graph __name__ == __main__ torch _dynamo test_case run_tests run_tests
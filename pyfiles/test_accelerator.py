Owner s module tests gc sys unittest torch torch testing _internal common_utils NoTest run_tests TEST_MPS TestCase torch accelerator is_available print No available accelerator detected skipping tests file=sys stderr TestCase = NoTest noqa F Skip because failing when run cuda build no GPU see example sys exit TEST_MULTIACCELERATOR = torch accelerator device_count TestAccelerator TestCase test_current_accelerator assertTrue torch accelerator is_available accelerators = cuda xpu mps accelerator accelerators torch get_device_module accelerator is_available assertEqual torch accelerator current_accelerator type accelerator assertIsNone torch accelerator current_accelerator index assertRaisesRegex ValueError doesn t match current accelerator torch accelerator set_device_index cpu unittest skipIf TEST_MULTIACCELERATOR only one accelerator detected test_generic_multi_device_behavior orig_device = torch accelerator current_device_index target_device = orig_device + torch accelerator device_count torch accelerator set_device_index target_device assertEqual target_device torch accelerator current_device_index torch accelerator set_device_index orig_device assertEqual orig_device torch accelerator current_device_index s = torch Stream target_device torch accelerator set_stream s assertEqual target_device torch accelerator current_device_index torch accelerator synchronize orig_device assertEqual target_device torch accelerator current_device_index test_generic_stream_behavior s = torch Stream s = torch Stream torch accelerator set_stream s assertEqual torch accelerator current_stream s event = torch Event = torch randn b = torch randn c = + b torch accelerator set_stream s assertEqual torch accelerator current_stream s a_acc = torch accelerator current_accelerator non_blocking=True b_acc = b torch accelerator current_accelerator non_blocking=True torch accelerator set_stream s assertEqual torch accelerator current_stream s event record s event synchronize c_acc = a_acc + b_acc event record s torch accelerator synchronize assertTrue event query assertEqual c_acc cpu c test_current_stream_query s = torch accelerator current_stream assertEqual torch accelerator current_stream s device s assertEqual torch accelerator current_stream s device index s assertEqual torch accelerator current_stream str s device s other_device = torch device cpu assertRaisesRegex ValueError doesn t match current accelerator torch accelerator current_stream other_device test_device_context_manager prev_device = torch accelerator current_device_index torch accelerator device_index None assertEqual torch accelerator current_device_index prev_device assertEqual torch accelerator current_device_index prev_device torch accelerator device_index assertEqual torch accelerator current_device_index assertEqual torch accelerator current_device_index prev_device unittest skipIf TEST_MULTIACCELERATOR only one accelerator detected test_multi_device_context_manager src_device = dst_device = torch accelerator set_device_index src_device torch accelerator device_index dst_device assertEqual torch accelerator current_device_index dst_device assertEqual torch accelerator current_device_index src_device test_stream_context_manager prev_stream = torch accelerator current_stream torch Stream s assertEqual torch accelerator current_stream s assertEqual torch accelerator current_stream prev_stream unittest skipIf TEST_MULTIACCELERATOR only one accelerator detected test_multi_device_stream_context_manager src_device = dst_device = torch accelerator set_device_index src_device src_prev_stream = torch accelerator current_stream dst_prev_stream = torch accelerator current_stream dst_device torch Stream dst_device dst_stream assertEqual torch accelerator current_device_index dst_device assertEqual torch accelerator current_stream dst_stream assertEqual torch accelerator current_stream src_device src_prev_stream assertEqual torch accelerator current_device_index src_device assertEqual torch accelerator current_stream src_prev_stream assertEqual torch accelerator current_stream dst_device dst_prev_stream unittest skipIf TEST_MPS MPS doesn t support pin memory test_pin_memory_on_non_blocking_copy t_acc = torch randn torch accelerator current_accelerator t_host = t_acc cpu non_blocking=True torch accelerator synchronize assertTrue t_host is_pinned assertEqual t_acc cpu t_host test_generic_event_behavior event = torch Event enable_timing=False event = torch Event enable_timing=False assertRaisesRegex ValueError Both events must created argument enable_timing=True event elapsed_time event event = torch Event enable_timing=True event = torch Event enable_timing=True assertRaisesRegex ValueError Both events must recorded before calculating elapsed time event elapsed_time event check default value enable_timing False event = torch Event event = torch Event assertRaisesRegex ValueError Both events must created argument enable_timing=True event elapsed_time event unittest skipIf TEST_MPS MPS doesn t support torch accelerator memory API test_memory_stats Ensure device allocator initialized acc = torch accelerator current_accelerator tmp = torch randn device=acc del tmp gc collect assertTrue torch _C _accelerator_isAllocatorInitialized torch accelerator empty_cache pool_type = all small_pool large_pool metric_type = peak current allocated freed stats_type = allocated_bytes reserved_bytes active_bytes requested_bytes mem_stats = torch accelerator memory_stats expected_stats = f st pt mt st stats_type pt pool_type mt metric_type missing_stats = stat stat expected_stats stat mem_stats assertEqual len missing_stats f Missing expected memory statistics missing_stats prev_allocated = torch accelerator memory_allocated prev_reserved = torch accelerator memory_reserved prev_max_allocated = torch accelerator max_memory_allocated prev_max_reserved = torch accelerator max_memory_reserved assertGreaterEqual prev_allocated assertGreaterEqual prev_reserved assertGreater prev_max_allocated assertGreater prev_max_reserved tmp = torch ones device=acc assertGreater torch accelerator memory_allocated prev_allocated assertGreaterEqual torch accelerator memory_reserved prev_reserved del tmp gc collect torch accelerator empty_cache torch accelerator reset_peak_memory_stats assertEqual torch accelerator memory_allocated prev_allocated assertEqual torch accelerator memory_reserved prev_reserved torch accelerator reset_accumulated_memory_stats prev_max_allocated = torch accelerator max_memory_allocated prev_max_reserved = torch accelerator max_memory_reserved Activate kB memory prev_active_current = torch accelerator memory_stats active_bytes all current tmp = torch randn device=acc Detect current active memory kB assertEqual torch accelerator memory_stats active_bytes all current + prev_active_current assertEqual torch accelerator memory_stats active_bytes all freed del tmp gc collect torch accelerator empty_cache assertEqual torch accelerator memory_stats active_bytes all current prev_active_current assertEqual torch accelerator memory_stats active_bytes all freed torch accelerator reset_peak_memory_stats assertEqual torch accelerator max_memory_allocated prev_max_allocated assertEqual torch accelerator max_memory_reserved prev_max_reserved __name__ == __main__ run_tests
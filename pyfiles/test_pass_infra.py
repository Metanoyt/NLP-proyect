Owner s module fx torch torch fx fx torch fx passes infra pass_base PassBase PassResult torch fx passes infra pass_manager _topological_sort_passes pass_result_wrapper PassManager this_before_that_pass_constraint torch testing _internal common_utils raise_on_run_directly TestCase Pass uses PassBase returns PassResult best scenario ReplaceAddWithMulPass PassBase call gm - PassResult modified = False node gm graph nodes node op == call_function node target == torch add node target = torch mul modified = True PassResult gm modified Pass callable returns PassResult replace_mul_with_div_pass gm - PassResult modified = False node gm graph nodes node op == call_function node target == torch mul node target = torch div modified = True PassResult gm modified Pass PassBase does PassResult Need wrap pass_result_wrapper will fail ReplaceDivWithSubPass PassBase call gm - PassResult node gm graph nodes node op == call_function node target == torch div node target = torch sub Pass callable does PassResult Need wrap pass_result_wrapper will fail replace_sub_with_add_pass gm - PassResult node gm graph nodes node op == call_function node target == torch sub node target = torch add AddModule torch nn Module forward x y = torch add x x z = torch add y x z TestPassManager TestCase test_pass_manager Tests pass manager runs passes correctly m = AddModule traced_m = torch fx symbolic_trace m pm = PassManager passes= ReplaceAddWithMulPass replace_mul_with_div_pass pass_result_wrapper ReplaceDivWithSubPass pass_result_wrapper replace_sub_with_add_pass steps= pm validate_constraints assertEqual len pm passes res = pm traced_m modified_m = res graph_module assert isinstance modified_m fx GraphModule Check all call_function nodes divs node modified_m graph nodes node op == call_function assertEqual node target torch add test_this_before_that_pass_constraint Tests construction constraints passes = lambda x x _ range pm = PassManager passes add unfulfillable constraint pm add_constraint this_before_that_pass_constraint passes - passes assertRaises RuntimeError pm validate_constraints test_pass_manager_checks Tests users can add check functions correctly m = AddModule traced_m = fx symbolic_trace m pm = PassManager passes= ReplaceAddWithMulPass replace_mul_with_div_pass check_div_target graph_module node graph_module graph nodes node op == call_function node target = torch div raise ValueError Target should div pm add_checks check_div_target assertRaises ValueError pm traced_m test_pass_manager_bad_checks Checks we error we pass check function wrong parameters check_bad_args graph_module i pass pm = PassManager assertRaises TypeError pm add_checks check_bad_args test_topological_sort Tests passes correctly ordered based constraints pass x x pass x x + pass x x + pass x x + pass x x + pass x x + Not passing any constraints should keep original order passes = pass pass pass pass pass pass sorted = _topological_sort_passes passes assertEqual sorted passes Graph we constructing ---- ---- &#124; &#124; +- - - -+ Which has possible topological order passes = pass pass pass pass pass pass constraints = this_before_that_pass_constraint pass pass this_before_that_pass_constraint pass pass this_before_that_pass_constraint pass pass this_before_that_pass_constraint pass pass this_before_that_pass_constraint pass pass this_before_that_pass_constraint pass pass sorted = _topological_sort_passes passes constraints assertEqual sorted pass pass pass pass pass pass Circular dependency should result circular_dep flag being set passes = pass pass pass constraints = this_before_that_pass_constraint passes passes this_before_that_pass_constraint passes passes this_before_that_pass_constraint passes passes assertRaises RuntimeError e _topological_sort_passes passes constraints expected_error_msg = f Circular dependency detected within following passes passes assertEqual e exception args expected_error_msg test_pass_manager_error Tests error catching + debug pass_fail graph_module raise RuntimeError bad m = AddModule traced_m = torch fx symbolic_trace m pm = PassManager passes= ReplaceAddWithMulPass replace_mul_with_div_pass ReplaceDivWithSubPass pass_result_wrapper replace_sub_with_add_pass Comment out line see actual error message error_msg = ReplaceDivWithSubPass ReplaceAddWithMulPass replace_mul_with_div_pass assertRaisesRegex Exception error_msg pm traced_m pm = PassManager passes= ReplaceAddWithMulPass replace_mul_with_div_pass pass_result_wrapper ReplaceDivWithSubPass pass_result_wrapper replace_sub_with_add_pass pass_fail Comment out line see actual error message error_msg = pass_fail ReplaceAddWithMulPass replace_mul_with_div_pass ReplaceDivWithSubPass replace_sub_with_add_pass assertRaisesRegex Exception error_msg pm traced_m __name__ == __main__ raise_on_run_directly test test_fx py
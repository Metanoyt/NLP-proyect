mypy allow-untyped-defs io time typing Any torch torch distributed dist torch distributed rpc rpc torch Tensor torch autograd profiler record_function torch autograd profiler_legacy profile _profile torch distributed rpc RRef torch distributed rpc internal _build_rpc_profiling_key RPCExecMode torch futures Future torch testing _internal common_utils TemporaryFileName torch testing _internal dist_utils dist_init get_function_event initialize_pg worker_name torch testing _internal distributed rpc rpc_agent_test_fixture RpcAgentTestFixture rref_isinstance rref cls_to_check isinstance rref local_value cls_to_check sleep t time sleep t rpc_return_rref dst rpc remote dst torch add args= torch ones torch jit script rref_local_value rref RRef Tensor - Tensor rref local_value torch jit script list_create - list int global_list = global_list torch jit script rref_list_mutate rref RRef list int - None rref local_value append rref to_here append rref to_here append return_value value int - int value RRefAPITest dist_init test_rref_is_owner dst_worker_name = worker_name rank + world_size rref_var = rpc_return_rref dst_worker_name torch jit script rref_tensor_is_owner rref_var RRef Tensor - bool rref_var is_owner res = rref_tensor_is_owner rref_var assertEqual res False dist_init test_rref_local_value rank = dst_worker_name = worker_name rank + world_size rref = rpc_return_rref dst_worker_name assertRaisesRegex RuntimeError r Can t call RRef local_value\ \ non-owner RRef rref_local_value rref ret = rpc rpc_sync dst_worker_name rref_local_value rref assertEqual ret torch add torch ones dist_init test_local_rref_local_value rank = dst_worker_name = worker_name rank rref = rpc remote dst_worker_name return_value ret = rref_local_value rref assertEqual ret _create_rref owner_rank = rank + world_size rpc remote worker_name owner_rank torch add args= torch zeros dist_init test_user_rrefs_confirmed dst_rank = rank + world_size rref = _create_rref ret = rpc rpc_sync worker_name dst_rank script_check_rref_confirmed args= rref assertEqual ret True dist_init test_user_rrefs_confirmed_remote dst_rank = rank + world_size rref = _create_rref ret_rref = rpc remote worker_name dst_rank script_check_rref_confirmed args= rref assertEqual ret_rref to_here True dist_init test_rref_list_mutate dst = worker_name rank + world_size list_rref = rpc remote dst list_create rpc rpc_sync dst rref_list_mutate args= list_rref assertEqual list_rref to_here torch jit script no_arg torch jit script one_arg value value + torch jit script script_add_ones x torch add x torch ones torch jit script script_add_ones_with_record_function x block str record_function block torch add x torch ones torch jit script record_function_on_caller_rpc_async dst_worker_name str block str - Tensor t Tensor = torch ones record_function block fut = rpc rpc_async dst_worker_name script_add_ones t Extra operator call avoid de-duplication next async call see https github com pytorch pytorch pull #discussion_r zero = torch zeros_like t fut = rpc rpc_async dst_worker_name script_add_ones t res = fut wait + fut wait + zero res torch jit script script_fork_wait_udf tensor fut = torch jit _fork script_add_ones tensor x = torch jit _wait fut x torch jit script rref_to_here rref_var RRef Tensor - Tensor rref_var to_here torch jit script return_rref rref_var RRef Tensor - RRef Tensor rref_var torch jit script script_raise_func value value numel == raise ValueError Expected error value + torch jit script script_fork_wait_throw invalue fut = torch jit _fork script_raise_func invalue value = torch jit _wait fut value torch jit script call_rpc_with_profiling record torch classes profiler _RecordFunction dst_worker_name str - Tensor Call rpc_async within ScriptFunction ensure we can attach profiling callbacks Note handle here Tensor representation RecordFunction fut = rpc rpc_async dst_worker_name one_arg torch tensor torch ops profiler _call_end_callbacks_on_jit_fut record fut ret = fut wait ret torch jit script call_rpc_torchscript_with_record_function dst_worker_name str block str - Tensor fut = rpc rpc_async dst_worker_name script_add_ones_with_record_function torch tensor block fut wait torch jit script call_fork_with_profiling record torch classes profiler _RecordFunction - Tensor Call fork within ScriptFunction ensure we can attach profiling callbacks resulting future Note handle here Tensor representation RecordFunction fut = torch jit _fork one_arg torch tensor torch ops profiler _call_end_callbacks_on_jit_fut record fut ret = fut wait ret MyScriptModuleWithRRefs torch jit ScriptModule __init__ dst_worker super __init__ rrefs = _ range rrefs append rpc_return_rref dst_worker torch jit script_method forward - Tensor res_tensor = torch ones rref rrefs res_tensor += rref to_here res_tensor torch jit ignore rref_python_annotation rref_var RRef Tensor - RRef Tensor rref_var torch jit script rref_script_annotation rref_var RRef Tensor - Tensor rref_python_annotation rref_var to_here RRefTypingTest dist_init test_rref_as_arg_and_return n = rank + dst_rank = n world_size local_ret = one_arg torch ones create rref current rank rref = rpc remote worker_name rank one_arg args= torch ones pass rref another user rpc call ret = rpc rpc_sync worker_name dst_rank rref_to_here args= rref assertEqual ret local_ret rref rpc call rref = rpc rpc_sync worker_name dst_rank return_rref args= rref assertEqual rref to_here local_ret pass rref another user remote call rref = rpc remote worker_name dst_rank rref_to_here args= rref assertEqual rref to_here local_ret rref remote call rref = rpc remote worker_name dst_rank return_rref args= rref assertEqual rref to_here to_here local_ret dist_init test_my_script_module_with_rrefs n = rank + dst_rank = n world_size module_with_rrefs = MyScriptModuleWithRRefs worker_name dst_rank res = module_with_rrefs assertEqual res torch ones dist_init test_rref_python_annotation n = rank + dst_rank = n world_size rref_var = rpc_return_rref worker_name dst_rank res = rref_script_annotation rref_var assertEqual res torch ones + FutureTypingTest dist_init test_future_passed_between_python_and_jit dst_rank = rank + world_size inputs = torch tensor torch tensor ret_fut = rpc rpc_async worker_name dst_rank two_args_two_kwargs args=inputs expected_res = torch tensor torch jit script future_wait_in_script fut Future Tensor - Tensor fut wait assertEqual future_wait_in_script ret_fut expected_res torch jit script future_return_to_python dst_rank int inputs tuple Tensor Tensor - Future Tensor rpc rpc_async f worker dst_rank two_args_two_kwargs inputs fut_res = future_return_to_python dst_rank inputs assertEqual fut_res wait expected_res dist_init test_future_python_annotation rank = dst_worker_name = worker_name rank + world_size input_ = torch ones input_ = expected_res = torch add input_ input_ torch jit ignore python_return_future - Future Tensor fut = rpc rpc_async dst_worker_name torch add input_ input_ fut torch jit script script_use_future - Tensor fut = python_return_future fut wait res = script_use_future assertEqual res expected_res torch jit script MyScriptClass __init__ int = get_value - int torch jit interface MyModuleInterface torch nn Module forward - Tensor pyre-ignore Pyre torch jit interface don t mix well pass MyScriptModule torch jit ScriptModule __init__ rank super __init__ = torch ones rank torch jit script_method forward - Tensor torch jit script_method custom_func - Tensor owner_create_rref_my_script_class rpc RRef MyScriptClass owner_create_rref_my_script_module rpc RRef MyScriptModule type_hint=MyModuleInterface torch jit script script_rref_get_value_my_script_class rref RRef MyScriptClass - int rref to_here get_value torch jit script script_rref_run_forward_my_script_module rref RRef MyModuleInterface - Tensor rref to_here forward LocalRRefTest dist_init test_create_local_script_class_rref_in_py rank = Create local RRef MyScriptClass rref_script_class = rpc RRef MyScriptClass rank ret = rref_script_class to_here get_value assertEqual ret rank dist_init test_create_local_script_module_rref_in_py rank = Create local RRef MyModuleInterface rref_script_module = rpc RRef MyScriptModule rank MyModuleInterface ret = rref_script_module to_here forward assertEqual ret torch ones rank Create local RRef MyModuleInterface without type hint assertRaisesRegex RuntimeError The RRef being created contains ScriptModule must provide its ModuleInterface type hint rref_script_module = rpc RRef MyScriptModule rank dist_init test_return_local_script_class_rref_in_py_and_use_in_script rank = dst_worker_name = worker_name rank + world_size Create local RRef MyScriptClass remotely Python rref = rpc rpc_sync dst_worker_name owner_create_rref_my_script_class args= rank use_rref_on_owner rref RRef MyScriptClass - int args = rref kwargs dict str Any = fut = rpc rpc_async rref owner script_rref_get_value_my_script_class args kwargs ret = fut wait ret Use RRef MyScriptClass local Python RPC remote Script run ret = use_rref_on_owner rref assertEqual ret rank Use RRef MyScriptClass local Script RPC remote Script run use_rref_on_owner_script = torch jit script use_rref_on_owner ret = use_rref_on_owner_script rref assertEqual ret rank dist_init test_return_local_script_module_rref_in_py_and_use_in_script rank = dst_worker_name = worker_name rank + world_size Create local RRef MyModuleInterface remotely Python rref = rpc rpc_sync dst_worker_name owner_create_rref_my_script_module args= rank use_rref_on_owner rref RRef MyModuleInterface - Tensor args = rref kwargs dict str Any = fut = rpc rpc_async rref owner_name script_rref_run_forward_my_script_module args kwargs ret = fut wait ret Use RRef MyScriptClass local Python RPC remote Script run ret = use_rref_on_owner rref assertEqual ret torch ones rank Use RRef MyScriptClass local Script RPC remote Script run use_rref_on_owner_script = torch jit script use_rref_on_owner ret = use_rref_on_owner_script rref assertEqual ret torch ones rank python_function torch jit script two_args_two_kwargs first_arg second_arg first_kwarg=torch tensor second_kwarg=torch tensor first_arg + second_arg + first_kwarg + second_kwarg torch jit script assorted_types_args_kwargs tensor_arg Tensor noqa E str_arg str int_arg int tensor_kwarg Tensor = torch tensor str_kwarg str = str_kwarg int_kwarg int = tensor_arg + tensor_kwarg str_arg + str_kwarg int_arg + int_kwarg torch jit script raise_script raise RuntimeError Expected error torch jit script script_rpc_async_call dst_worker_name str args tuple Tensor Tensor kwargs dict str Tensor fut = rpc rpc_async dst_worker_name two_args_two_kwargs args kwargs ret = fut wait ret torch jit script script_rpc_sync_call dst_worker_name str args tuple Tensor Tensor kwargs dict str Tensor res = rpc rpc_sync dst_worker_name two_args_two_kwargs args kwargs res torch jit script script_rpc_remote_call dst_worker_name str args tuple Tensor Tensor kwargs dict str Tensor rref_res = rpc remote dst_worker_name two_args_two_kwargs args kwargs rref_res to_here JitRpcOpTest Call functions remotely Script dist_init test_all_kwargs_are_populated_by_defaults rank = dst_worker_name = worker_name rank + world_size args = torch tensor torch tensor kwargs = script_op script_rpc_async_call script_rpc_sync_call script_rpc_remote_call ret = script_op dst_worker_name args kwargs assertEqual ret torch tensor dist_init test_some_kwargs_are_populated_by_defaults rank = dst_worker_name = worker_name rank + world_size args = torch tensor torch tensor kwargs = first_kwarg torch tensor script_op script_rpc_async_call script_rpc_sync_call script_rpc_remote_call ret = script_op dst_worker_name args kwargs assertEqual ret torch tensor dist_init test_no_kwargs_are_populated_by_defaults rank = dst_worker_name = worker_name rank + world_size args = torch tensor torch tensor kwargs = first_kwarg torch tensor second_kwarg torch tensor script_op script_rpc_async_call script_rpc_sync_call script_rpc_remote_call ret = script_op dst_worker_name args kwargs assertEqual ret torch tensor dist_init test_args_and_kwargs_contain_different_types rank = dst_worker_name = worker_name rank + world_size torch jit script script_rpc_async_call_with_assorted_types dst_worker_name str args = torch tensor str_arg Must annotate value type ` Any ` because JIT type inference does support multiple types when defining Dict The error JIT gives Dict values must contain only single type expected Tensor found str instead kwargs dict str Any = tensor_kwarg torch tensor str_kwarg _str_kwarg int_kwarg fut = rpc rpc_async dst_worker_name assorted_types_args_kwargs args kwargs ret = fut wait ret ret = script_rpc_async_call_with_assorted_types dst_worker_name assertEqual ret torch tensor str_arg_str_kwarg dist_init test_kwargs_not_passed rank = dst_worker_name = worker_name rank + world_size torch jit script script_rpc_async_call_without_kwargs_passed dst_worker_name str args = fut = rpc rpc_async dst_worker_name no_arg args ret = fut wait ret ret = script_rpc_async_call_without_kwargs_passed dst_worker_name assertEqual ret dist_init test_args_kwargs_are_neither_passed rank = dst_worker_name = worker_name rank + world_size torch jit script script_rpc_async_call_without_args_kwargs_passed dst_worker_name str fut = rpc rpc_async dst_worker_name no_arg ret = fut wait ret ret = script_rpc_async_call_without_args_kwargs_passed dst_worker_name assertEqual ret dist_init test_less_than_needed_args_are_specified rank = Notice args matching happens during scripting assertRaisesRegex RuntimeError Argument second_arg provided torch jit script script_rpc_async_call_with_less_args dst_worker_name str noqa E args = torch tensor kwargs = fut = rpc rpc_async dst_worker_name two_args_two_kwargs args kwargs ret = fut wait ret dist_init test_more_than_needed_args_are_specified rank = Notice args matching happens during scripting assertRaisesRegex RuntimeError Expected most arguments found positional arguments torch jit script script_rpc_async_call_with_more_args dst_worker_name str args = torch tensor torch tensor torch tensor torch tensor torch tensor kwargs = fut = rpc rpc_async dst_worker_name two_args_two_kwargs args kwargs ret = fut wait ret dist_init test_unexepected_kwarg_is_specified rank = dst_worker_name = worker_name rank + world_size Notice kwargs matching happens during execution torch jit script script_rpc_async_call_with_unexpected_kwarg dst_worker_name str noqa E args = torch tensor torch tensor kwargs = third_kwarg torch tensor fut = rpc rpc_async dst_worker_name two_args_two_kwargs args kwargs ret = fut wait ret assertRaisesRegex RuntimeError Unknown keyword argument third_kwarg ret = script_rpc_async_call_with_unexpected_kwarg dst_worker_name assertEqual ret dist_init test_call_python_function_remotely_from_script_not_supported rank = dst_worker_name = worker_name rank + world_size torch jit script rpc_async_call_remote_py_function_in_torchscript dst_worker_name str args = kwargs = fut = rpc rpc_async dst_worker_name python_function args kwargs ret = fut wait ret assertRaisesRegex RuntimeError attempted get undefined function ret = rpc_async_call_remote_py_function_in_torchscript dst_worker_name assertEqual ret dist_init test_call_script_function_that_raises_remotely_from_script rank = dst_worker_name = worker_name rank + world_size Notice TorchScript always translates emits Python ` raise ` statement exception message string Exception no matter what exception type exception message statement torch jit script rpc_async_call_remote_raising_torchscript_in_torchscript dst_worker_name str args = kwargs = fut = rpc rpc_async dst_worker_name raise_script args kwargs ret = fut wait ret assertRaisesRegex RuntimeError Expected error ret = rpc_async_call_remote_raising_torchscript_in_torchscript dst_worker_name assertEqual ret dist_init test_call_script_function_that_not_exists_remotely_from_script rank = dst_worker_name = worker_name rank + world_size torch jit script nonexisting_script torch jit script rpc_async_call_remote_nonexisting_torchscript_in_torchscript dst_worker_name str args = kwargs = fut = rpc rpc_async dst_worker_name nonexisting_script args kwargs ret = fut wait ret assertRaisesRegex RuntimeError attempted get undefined function nonexisting_script ret = rpc_async_call_remote_nonexisting_torchscript_in_torchscript dst_worker_name assertEqual ret torch jit ignore my_script_module_init rank int - MyModuleInterface MyScriptModule rank torch jit script construct_my_script_module rank int - MyModuleInterface my_script_module_init rank torch jit script run_ref_script_module ref_script_module RRef MyModuleInterface t Tensor - Tensor module = ref_script_module to_here module forward + t torch jit script script_check_rref_confirmed rref RRef Tensor - bool rref confirmed_by_owner torch jit script save_rref rref_var RRef Tensor fname str - None torch save rref_var fname torch jit script script_add x Tensor y Tensor - Tensor x + y rpc functions async_execution torch jit script async_add str x Tensor y Tensor - Future Tensor rpc rpc_async script_add x y rpc functions async_execution torch jit script async_wrong_type - Tensor torch zeros load_script_module_with_pickled_rref pickled_script_module f = io BytesIO pickled_script_module m = torch jit load f m JitRpcTest RRefAPITest RRefTypingTest LocalRRefTest JitRpcOpTest FutureTypingTest RpcAgentTestFixture dist_init test_torchscript_function dst_worker_name = worker_name rank + world_size local_ret = one_arg torch ones ret = rpc rpc_sync dst_worker_name one_arg args= torch ones assertEqual ret local_ret rref = rpc remote dst_worker_name one_arg args= torch ones assertEqual rref to_here local_ret create rref itself local_rref = rpc remote worker_name rank one_arg args= torch ones assertEqual local_rref to_here local_ret dist_init test_torchscript_function_exception dst_worker_name = worker_name rank + world_size assertRaisesRegex RuntimeError r one_arg\ \ expected most rpc rpc_sync dst_worker_name one_arg args= assertRaisesRegex RuntimeError r one_arg\ \ expected most rpc remote dst_worker_name one_arg args= dist_init test_torchscript_functions_not_supported dst_worker_name = worker_name rank + world_size my_local_script_module = MyScriptModule rank It thread safe instantiate MyScriptModule multiple threads wait local MyScriptModule instantiation finish otherwise could instantiate MyScriptModule parallel server thread below initialize_pg file_init_method rank world_size dist barrier rpc_sync still accepts script run same code path python call rpc rpc_sync dst_worker_name MyScriptClass args= rank rpc_sync does accept script module method Python Python throw different error message only common word can greped pickle assertRaisesRegex TypeError pickle rpc rpc_async dst_worker_name my_local_script_module forward args= dist_init test_remote_script_module TODO need more investigation there rref leak when shutting down suspect because ref arg passed pybind boundary ref garbage collected python when calling shutdown torch distributed rpc api api api _ignore_rref_leak = True local_ret = torch ones rank + torch ones rank n = rank + dst_rank = n world_size remote_ref = rpc remote worker_name dst_rank construct_my_script_module args= rank pass rref arg owner ret = rpc rpc_sync worker_name dst_rank run_ref_script_module args= remote_ref torch ones rank assertEqual ret local_ret pass rref arg user assertRaisesRegex RuntimeError RRef ScriptModule It can t sent through RPC owner ret = rpc rpc_sync worker_name rank run_ref_script_module args= remote_ref torch ones rank dist_init test_create_script_module_on_remote dst_name = worker_name rank + world_size Construct remote end rpc_sync created_script_module = rpc rpc_sync dst_name MyScriptModule args= rank Forward should output ones tensor rank assertTrue isinstance created_script_module torch jit ScriptModule rank_ones_tensor = created_script_module assertEqual torch ones rank rank_ones_tensor Construct ScriptModule rpc remote remote_script_module = rpc remote dst_name MyScriptModule args= rank Verify instance ScriptModule remote end remote_end_is_script = rpc rpc_sync remote_script_module owner rref_isinstance args= remote_script_module torch jit ScriptModule assertTrue remote_end_is_script Run forward pass remotely remote_forward_output = remote_script_module rpc_sync forward assertEqual remote_forward_output torch ones rank Run function defined ScriptModule remotely remote_func_output = remote_script_module rpc_sync custom_func assertEqual remote_func_output torch ones rank Ensure we can transfer ScriptModule RRef rank run forward pass local_script_module = remote_script_module to_here assertTrue isinstance local_script_module torch jit ScriptModule rank_ones_tensor = local_script_module assertEqual rank_ones_tensor torch ones rank local_script_func_output = local_script_module custom_func assertEqual local_script_func_output torch ones rank dist_init test_load_script_module_with_pickled_rref dst_name = worker_name rank + world_size m = MyScriptModuleWithRRefs dst_name m = MyScriptModuleWithRRefs dst_name f = io BytesIO rpc _enable_jit_rref_pickle torch jit save m f rpc _disable_jit_rref_pickle out = rpc rpc_sync dst_name load_script_module_with_pickled_rref args= f getvalue out = m assertEqual out out dist_init test_rref_jit_pickle_not_supported n = rank + dst_rank = n world_size rref_var = rpc_return_rref worker_name dst_rank TemporaryFileName fname assertRaisesRegex RuntimeError RRef jit pickling only allowed inside RPC calls save_rref rref_var fname dist_init test_remote_script_throw rref = rpc remote worker_name rank + world_size script_raise_func args= torch ones assertRaisesRegex Exception Expected error rref to_here dist_init test_remote_script_udf rref = rpc remote worker_name rank + world_size script_fork_wait_udf args= torch ones assertEqual rref to_here torch ones dist_init test_async_script_udf future = rpc rpc_async worker_name rank + world_size script_fork_wait_udf args= torch ones assertEqual future wait torch ones dist_init test_callback_simple callback fut fut wait + future = rpc rpc_async worker_name rank + world_size script_fork_wait_udf args= torch ones then callback assertEqual future wait torch ones + dist_init test_callback_chain n = rank + callback fut fut wait + fut = rpc rpc_async worker_name n world_size one_arg args= torch ones n n num_cbs = _ range num_cbs fut = fut then callback assertEqual fut wait torch ones n n + + num_cbs dist_init test_add_done_callback callback_called = None callback fut nonlocal callback_called callback_called = fut wait future = rpc rpc_async worker_name rank + world_size script_fork_wait_udf args= torch ones future add_done_callback callback future_then = future then lambda _ True assertEqual future wait torch ones We have no guarantee add_done_callback fn will execute before test finishes Adding then callback runs afterwards guarantee we wait first callback future_then wait assertEqual callback_called torch ones dist_init test_async_script_throw future = rpc rpc_async worker_name rank + world_size script_fork_wait_throw args= torch ones assertRaisesRegex Exception Expected error future wait dist_init test_callback_with_exception callback fut assertRaisesRegex Exception Expected error fut wait raise RuntimeError Another expected error future = rpc rpc_async worker_name rank + world_size script_fork_wait_throw args= torch ones then callback assertRaisesRegex RuntimeError Another expected error future wait dist_init test_call_rpc_with_profiling Ensures we can call torch ops profiler _call_end_callbacks_on_jit_fut jit future within script function calls rpc_async rank == _profile prof prof_key = _build_rpc_profiling_key RPCExecMode ASYNC torch _jit_internal _qualified_name one_arg worker worker torch autograd profiler record_function prof_key rf call_rpc_with_profiling rf record worker TODO Can t get reliable time profiling event since s hard estimate execution time remote end non-UDFs This can resolved https github com pytorch pytorch issues After test should modified validate function time events = prof function_events function_event = get_function_event events prof_key assertTrue torch _jit_internal _qualified_name one_arg function_event name dist_init test_rpc_async_jit_profiled Tests rpc_async calls made within TorchScript function profiled rank == dst_rank = rank + world_size dst_worker_name = worker_name dst_rank args = torch tensor torch tensor kwargs = _profile prof script_rpc_async_call dst_worker_name args kwargs Ensure rpc_async call profiled function_events = prof function_events qual_name = torch _jit_internal _qualified_name two_args_two_kwargs rpc_async_jit_event = event event function_events qual_name event name event node_id == rank assertEqual len rpc_async_jit_event rpc_async_jit_event = rpc_async_jit_event profiled_name = _build_rpc_profiling_key RPCExecMode ASYNC_JIT qual_name worker_name rank dst_worker_name assertEqual profiled_name rpc_async_jit_event name remote_events = event event function_events event is_remote All remote events should have taken place dst_rank remote_event_node_ids = remote_event node_id remote_event remote_events assertEqual remote_event_node_ids dst_rank script_rpc_async_call invokes add operator so we should see remote event remote_add = next remote_event remote_event remote_events aten add remote_event name remote_add_profiled_name = f profiled_name #remote_op aten add assertEqual remote_add name remote_add_profiled_name dist_init test_record_function_on_caller_rpc_async rank == dst_rank = rank + world_size dst_worker_name = worker_name dst_rank block_scope = foo _profile prof Runs rpc_async calls within JIT under record_function record_function_on_caller_rpc_async dst_worker_name block_scope Ensure record_function event profiled function_events = prof function_events record_function_scope_event = event event function_events event name == block_scope assertEqual len record_function_scope_event record_function_scope_event = record_function_scope_event Ensure RPC future profiled expected_key = _build_rpc_profiling_key RPCExecMode ASYNC_JIT torch _jit_internal _qualified_name script_add_ones worker_name rank dst_worker_name jit_rpc_events = event event function_events event name == expected_key assertEqual len jit_rpc_events Validate record_function scope time greater than both individual RPC async call times The reason necessarily greater than sum because two can execute parallel jit_rpc_event jit_rpc_events assertTrue record_function_scope_event cpu_time_total jit_rpc_event cpu_time_total dist_init test_rpc_torchscript_record_function tests torchscript functions can profiled using record_function over RPC REMOTE_OP_STR = #remote_op rank == dst_rank = rank + world_size dst_worker_name = worker_name dst_rank block_scope = foo _profile prof call_rpc_torchscript_with_record_function dst_worker_name block_scope Need call below populate CPU children prof key_averages function_events = prof function_events expected_key = _build_rpc_profiling_key RPCExecMode ASYNC_JIT torch _jit_internal _qualified_name script_add_ones_with_record_function worker_name rank dst_worker_name + REMOTE_OP_STR + block_scope remote_record_function_event = next evt evt function_events evt name == expected_key assertTrue block_scope remote_record_function_event name remote_children = remote_record_function_event cpu_children assertTrue aten add child name child remote_children test_record_function_jit_end_callbacks_with_fork Ensures we can call rf _call_end_callbacks_on_future jit future python eager mode torch jit fork sleep_interval = _profile prof torch autograd profiler record_function foo rf fut = torch jit _fork sleep sleep_interval rf _call_end_callbacks_on_future fut fut wait function_events = prof function_events sleep_event = get_function_event function_events foo assertEqual sleep_event name foo Validate callbacks fired right time checking profiling event cpu time assertGreaterAlmostEqual sleep_event cpu_time e- sleep_interval test_call_fork_in_jit_with_profiling Ensures we can call torch ops profiler _call_end_callbacks_on_jit_fut jit future within script function torch jit fork _profile prof torch autograd profiler record_function foo rf call_fork_with_profiling rf record events = prof function_events function_event = get_function_event events foo assertEqual function_event name foo dist_init test_async_function_simple dst = worker_name rank + world_size dst = worker_name rank + world_size ret = rpc rpc_sync dst async_add args= dst torch ones torch ones assertEqual ret torch ones + dist_init test_async_function_wrong_return_type assertRaisesRegex RuntimeError Async functions must IValue Future type got Tensor rpc rpc_sync worker_name rank + world_size async_wrong_type dist_init test_async_function_wrong_decorator_order torch jit script complains about undefined value rpc Error shown below The reason checking error string avoid making JIT error handling code depend RPC tests we don t have any restrictions error message here RuntimeError undefined value rpc async_wrong_decorator_order x y type str Tensor Tensor - Future Tensor rpc rpc_async script_add x y ~~~ --- HERE assertRaises RuntimeError torch jit script rpc functions async_execution async_wrong_decorator_order str x Tensor y Tensor - Future Tensor rpc rpc_async script_add x y dist_init test_async_function_remote dst = worker_name rank + world_size dst = worker_name rank + world_size rref = rpc remote dst async_add args= dst torch ones torch ones assertEqual rref to_here torch ones + dist_init test_async_function_remote_multi dst = worker_name rank + world_size dst = worker_name rank + world_size num = rrefs = rpc remote dst async_add args= dst torch ones torch ones i i range num i range num assertEqual rrefs i to_here torch ones + i dist_init test_async_function_wrong_return_type_remote rref = rpc remote worker_name rank + world_size async_wrong_type assertRaisesRegex RuntimeError Async functions must IValue Future type got Tensor rref to_here
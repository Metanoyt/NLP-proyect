argparse io unittest contextlib redirect_stderr unittest mock patch cli lib common cli_helper BaseRunner register_targets RichHelp TargetSpec ---- Dummy runners unittests ---- FooRunner BaseRunner Foo description docstring run - None replaced mock pass BarRunner BaseRunner run - None replaced mock pass add_foo_args p argparse ArgumentParser - None p add_argument -- x type=int required=True help= x value common_args p argparse ArgumentParser - None p add_argument -- verbose action= store_true help= verbose flag build_parser specs dict str TargetSpec - argparse ArgumentParser parser = argparse ArgumentParser prog= app formatter_class=RichHelp register_targets parser=parser target_specs=specs common_args=common_args parser get_subparser parser argparse ArgumentParser name str - argparse ArgumentParser subparsers_action = next parser _subparsers _group_actions type ignore attr-defined isinstance argparse _SubParsersAction subparsers_action choices name TestRegisterTargets unittest TestCase test_metavar_lists_targets specs dict str TargetSpec = foo runner FooRunner add_arguments add_foo_args bar runner BarRunner parser = build_parser specs subparsers_action = next parser _subparsers _group_actions type ignore attr-defined isinstance argparse _SubParsersAction assertEqual subparsers_action metavar foo bar test_add_arguments_and_common_args_present specs dict str TargetSpec = foo runner FooRunner add_arguments add_foo_args parser = build_parser specs foo = get_subparser parser foo help_text = foo format_help assertIn -- x help_text assertIn -- verbose help_text test_runner_constructed_with_ns_and_run_called specs dict str TargetSpec = foo runner FooRunner add_arguments add_foo_args parser = build_parser specs patch object FooRunner __init__ return_value=None mock_init patch object FooRunner run return_value=None mock_run ns = parser parse_args foo -- x -- verbose ns func ns set register_targets __init__ received Namespace assertEqual mock_init call_count called_ns _ = mock_init call_args assertIsInstance called_ns argparse Namespace run called no args mock_run assert_called_once_with test_runner_docstring_used_as_description_when_missing specs dict str TargetSpec = foo runner FooRunner add_arguments add_foo_args parser = build_parser specs foo = get_subparser parser foo help_text = foo format_help assertIn Foo description docstring help_text test_missing_target_raises_systemexit_with_usage specs dict str TargetSpec = foo runner FooRunner parser = build_parser specs buf = io StringIO assertRaises SystemExit redirect_stderr buf parser parse_args err = buf getvalue assertIn usage err __name__ == __main__ unittest main
Copyright c Meta Platforms Inc affiliates Owner s oncall distributed unittest mock patch torch torch distributed tensor distribute_tensor DTensor torch distributed tensor placement_types Replicate torch testing _internal common_utils instantiate_parametrized_tests parametrize run_tests torch testing _internal distributed _tensor common_dtensor create_local_tensor_test_class DTensorTestBase with_comms torch testing _internal inductor_utils GPU_TYPE torch testing _internal triton_utils requires_gpu TestDynamic DTensorTestBase requires_gpu with_comms parametrize fake_tensor_cache_enabled False True test_embedding fake_tensor_cache_enabled patch object torch _dynamo config fake_tensor_cache_enabled fake_tensor_cache_enabled device_mesh = build_device_mesh placements = Replicate num_embeddings = embedding_dim = weight = distribute_tensor torch rand num_embeddings embedding_dim dtype=torch float device=GPU_TYPE requires_grad=True device_mesh placements Replicate forward input_batch_inputs_ = weight torch float emb = torch nn functional embedding input_batch_inputs_ emb arg = torch randint low= high= size= dtype=torch int device=GPU_TYPE arg = DTensor from_local arg device_mesh placements compiled_forward = torch compile forward fullgraph=True dynamic=True _out = compiled_forward arg instantiate_parametrized_tests TestDynamic TestDynamicWithLocalTensor = create_local_tensor_test_class TestDynamic __name__ == __main__ run_tests
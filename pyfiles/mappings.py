operator typing Optional TYPE_CHECKING torch torch ao nn intrinsic nni torch ao nn intrinsic qat nniqat torch ao nn intrinsic quantized nniq torch ao nn intrinsic quantized dynamic nniqd torch ao nn qat nnqat torch ao nn qat dynamic nnqatd torch ao nn quantized nnq torch ao nn quantized dynamic nnqd torch ao quantization fx _lower_to_native_backend _lower_to_native_backend torch ao quantization quantization_mappings quantization_mappings torch nn nn torch nn functional F torch ao quantization backend_config get_native_backend_config ns_types NSNodeTargetType TYPE_CHECKING collections abc Callable toq = torch ops quantized get_base_name_to_sets_of_related_ops - dict str set NSNodeTargetType note set modified below items backend_config sets_of_related_ops list set NSNodeTargetType = conv modules nn Conv d nn Conv d nn Conv d conv functionals F conv d F conv d F conv d linear modules nn Linear linear functionals F linear average pool nn AvgPool d torch avg_pool d nn AvgPool d torch _C _nn avg_pool d nn AvgPool d torch _C _nn avg_pool d adaptive average pool nn AdaptiveAvgPool d F adaptive_avg_pool d nn AdaptiveAvgPool d F adaptive_avg_pool d nn AdaptiveAvgPool d F adaptive_avg_pool d LSTM nn LSTM add torch add operator add x + y cat torch cat mul torch mul operator mul relu F relu nn ReLU relu relu_ torch relu maxpool nn MaxPool d F max_pool d nn MaxPool d F max_pool d nn MaxPool d F max_pool d sigmoid torch sigmoid sigmoid sigmoid_ nn Sigmoid F sigmoid BatchNorm nn BatchNorm d nn BatchNorm d ConvTranspose nn ConvTranspose d nn ConvTranspose d nn ConvTranspose d functional transposed conv F conv_transpose d F conv_transpose d F conv_transpose d ELU nn ELU Embedding nn Embedding EmbeddingBag nn EmbeddingBag GroupNorm nn GroupNorm Hardswish nn Hardswish InstanceNorm nn InstanceNorm d nn InstanceNorm d nn InstanceNorm d LayerNorm nn LayerNorm LeakyReLU nn LeakyReLU ReLU nn ReLU F relu F elu F elu F hardswish F hardswish F group_norm F group_norm F instance_norm F instance_norm F layer_norm F layer_norm F leaky_relu F leaky_relu F silu nn SiLU F silu F mish nn Mish F mish F tanh nn Tanh F tanh torch tanh tanh_ tanh F hardsigmoid hardsigmoid_ hardsigmoid F hardsigmoid nn Hardsigmoid F hardtanh nn Hardtanh F hardtanh F hardtanh_ floordiv operator floordiv unsqueeze torch unsqueeze stack torch stack squeeze torch squeeze sort torch sort repeat_interleave torch repeat_interleave min torch min mean torch mean max torch max transpose torch transpose flatten torch flatten clamp torch clamp chunk torch chunk interpolate torch nn functional interpolate dropout nn Dropout F dropout F dropout matmul torch matmul Softmax nn Softmax PReLU nn PReLU nnq PReLU F prelu F prelu toq prelu pixel shuffle nn PixelShuffle F pixel_shuffle pixel unshuffle nn PixelUnshuffle F pixel_unshuffle narrow torch narrow each floating point op add versions op added backend_config backend_config = get_native_backend_config new_connections list tuple Callable Callable = technical debt edge case nn Linear nn modules linear NonDynamicallyQuantizableLinear pattern config backend_config _pattern_complex_format_to_config items pattern format c b first_element = pattern look end because pattern reverse order while isinstance first_element list tuple first_element = first_element - config fused_module None case pattern fuses pattern ops into op example nn Conv d nn ReLU fused into nni ConvReLU d new_connections append first_element config fused_module config qat_module None case pattern swaps module into QAT module example nni ConvReLU d swapped into nniqat ConvReLU d new_connections append first_element config qat_module config reference_quantized_module None case reference version floating point module such nn Conv d nnqr Conv d new_connections append first_element config reference_quantized_module Add reference module swaps default lowering path source_to_target _lower_to_native_backend STATIC_LOWER_MODULE_MAP _lower_to_native_backend DYNAMIC_LOWER_MODULE_MAP _lower_to_native_backend WEIGHT_ONLY_LOWER_MODULE_MAP _lower_to_native_backend SPECIAL_PATTERN_LOWER_MODULE_MAP source target source_to_target items type ignore attr-defined new_connections append source target source_to_double_target _lower_to_native_backend STATIC_LOWER_FUSED_MODULE_MAP _lower_to_native_backend STATIC_LOWER_FUSED_MODULE_TWO_INPUTS_MAP _lower_to_native_backend DYNAMIC_LOWER_FUSED_MODULE_MAP source target target source_to_double_target items type ignore attr-defined new_connections append source target new_connections append source target Add function swaps default lowering path source type ignore assignment target target _lower_to_native_backend STATIC_LOWER_FUNCTIONAL_MAP items new_connections append source target pyrefly ignore bad-argument-type new_connections append source target source_to_target _lower_to_native_backend QBIN_OP_MAPPING _lower_to_native_backend QBIN_RELU_OP_MAPPING quantization_mappings DEFAULT_FLOAT_TO_QUANTIZED_OPERATOR_MAPPINGS source target source_to_target items type ignore assignment pyrefly ignore bad-argument-type new_connections append source target Add other swaps ideally future could removed after lowering code stops using these source_to_target quantization_mappings DEFAULT_DYNAMIC_QUANT_MODULE_MAPPINGS source target source_to_target items type ignore assignment new_connections append source target add new connections backend_config item item new_connections set_of_related_ops sets_of_related_ops item set_of_related_ops item set_of_related_ops set_of_related_ops add item set_of_related_ops add item break base_name_to_sets_of_related_ops dict str set NSNodeTargetType = counter set_of_related_ops enumerate sets_of_related_ops base_name = str counter base_name_to_sets_of_related_ops base_name = set_of_related_ops base_name_to_sets_of_related_ops get_base_name_for_op base_name_to_sets_of_related_ops dict str set NSNodeTargetType op NSNodeTargetType - Optional str base_name set_of_related_ops base_name_to_sets_of_related_ops items op set_of_related_ops base_name None add_op_to_sets_of_related_ops base_name_to_sets_of_related_ops dict str set NSNodeTargetType op NSNodeTargetType related_op Optional NSNodeTargetType - None related_op None set_of_related_ops base_name_to_sets_of_related_ops values related_op set_of_related_ops set_of_related_ops add op we got here related_op found raise AssertionError f related_op found counter = while str counter base_name_to_sets_of_related_ops counter += base_name_to_sets_of_related_ops str counter = op TODO future PR clean up get_node_type_to_io_type_map - dict str set NSNodeTargetType FUNS_IO_TYPE_FP set NSNodeTargetType = F linear F conv d F conv d F conv d torch cat F elu F hardswish F instance_norm F layer_norm F leaky_relu F dropout F silu F mish operator add torch add operator mul torch mul torch sum F prelu FUNS_IO_TYPE_FP set NSNodeTargetType = set FUNS_IO_TYPE_INT set NSNodeTargetType = toq linear toq linear_relu toq conv d toq conv d_relu toq conv d toq conv d_relu toq conv d toq conv d_relu toq cat toq elu toq hardswish toq instance_norm toq layer_norm toq leaky_relu toq dropout toq prelu TODO future PR implement shadowing binary ops uncomment below toq add toq mul FUNS_IO_TYPE_FP _OR_INT set NSNodeTargetType = F relu F tanh torch tanh F sigmoid torch sigmoid F hardsigmoid operator floordiv torch adaptive_avg_pool d F adaptive_avg_pool d F adaptive_avg_pool d F dropout F hardtanh F hardtanh_ F interpolate F max_pool d F max_pool d F max_pool d F relu F pixel_shuffle F pixel_unshuffle torch avg_pool d torch _C _nn avg_pool d torch _C _nn avg_pool d torch cat torch chunk torch clamp torch flatten torch transpose torch max torch mean torch min torch narrow torch repeat_interleave torch sort torch squeeze torch stack torch unsqueeze operator add MODS_IO_TYPE_FP set NSNodeTargetType = nn Linear nnqat Linear nnqatd Linear nnqd Linear torch nn modules linear NonDynamicallyQuantizableLinear nn Conv d nn Conv d nn Conv d nnqat Conv d nnqat Conv d nnqat Conv d nnqat Embedding nnqat EmbeddingBag nn LSTM note nnqd Linear instance nnq Linear so check has happen before int module check nnqd LSTM nn BatchNorm d nn BatchNorm d nn Dropout nn ConvTranspose d nn ConvTranspose d nn ConvTranspose d nn ELU nn GroupNorm nn InstanceNorm d nn InstanceNorm d nn InstanceNorm d nn LayerNorm nn Hardswish nn LeakyReLU nn ReLU nn SiLU nn Mish nn Softmax nn PReLU nni BNReLU d nni BNReLU d nni ConvReLU d nni ConvReLU d nni ConvReLU d nni LinearReLU nni LinearBn d nni ConvBn d nni ConvBn d nni ConvBn d nniqat ConvBn d nniqat ConvBn d nniqat ConvBn d nniqat ConvBnReLU d nniqat ConvBnReLU d nniqat ConvBnReLU d nniqat ConvReLU d nniqat ConvReLU d nniqat ConvReLU d nniqat LinearReLU nniqat LinearBn d nniqd LinearReLU nni LinearLeakyReLU nni LinearTanh nni ConvAdd d nni ConvAddReLU d MODS_IO_TYPE_INT set NSNodeTargetType = nnq Linear nnq Conv d nnq Conv d nnq Conv d nnq BatchNorm d nnq BatchNorm d nnq Dropout nnq ConvTranspose d nnq ConvTranspose d nnq ELU nnq InstanceNorm d nnq InstanceNorm d nnq InstanceNorm d nnq LayerNorm nnq Hardswish nnq LeakyReLU nnq Embedding nnq EmbeddingBag nnq Dropout nnq Softmax nnq PReLU nniq BNReLU d nniq BNReLU d nniq ConvReLU d nniq ConvReLU d nniq ConvReLU d nniq LinearReLU nniq LinearLeakyReLU nniq LinearTanh nniq ConvAdd d nniq ConvAddReLU d MODS_IO_TYPE_FP _OR_INT set NSNodeTargetType = nn ReLU nn Tanh nn Sigmoid nn Hardsigmoid nn AdaptiveAvgPool d nn AdaptiveAvgPool d nn AdaptiveAvgPool d nn AvgPool d nn AvgPool d nn AvgPool d nn Dropout nn Hardtanh nn Identity nn MaxPool d nn MaxPool d nn MaxPool d nn PixelShuffle nn PixelUnshuffle nn ReLU METHS_IO_TYPE_FP _OR_INT set NSNodeTargetType = sigmoid_ sigmoid tanh_ tanh hardsigmoid_ hardsigmoid relu_ relu funs_io_type_fp FUNS_IO_TYPE_FP funs_io_type_fp FUNS_IO_TYPE_FP funs_io_type_int FUNS_IO_TYPE_INT funs_io_type_fp _or_int FUNS_IO_TYPE_FP _OR_INT mods_io_type_fp MODS_IO_TYPE_FP mods_io_type_int MODS_IO_TYPE_INT mods_io_type_fp _or_int MODS_IO_TYPE_FP _OR_INT meths_io_type_fp _or_int METHS_IO_TYPE_FP _OR_INT get_unmatchable_types_map - dict str set NSNodeTargetType FUNS_UNMATCHABLE set NSNodeTargetType = torch quantize_per_tensor operator getitem MODS_UNMATCHABLE set NSNodeTargetType = nn Identity METHS_UNMATCHABLE set NSNodeTargetType = dequantize reshape view unsqueeze_ unsqueeze transpose squeeze_ squeeze size shape resize_ repeat_interleave repeat permute numel mean detach_ detach contiguous clamp chunk funs_unmatchable FUNS_UNMATCHABLE mods_unmatchable MODS_UNMATCHABLE meths_unmatchable METHS_UNMATCHABLE
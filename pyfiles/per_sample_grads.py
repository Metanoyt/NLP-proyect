time opacus PrivacyEngine opacus utils module_modification convert_batchnorm_modules torchvision models torch torch nn nn functorch grad make_functional vmap device = cuda batch_size = torch manual_seed model_functorch = convert_batchnorm_modules models resnet num_classes= model_functorch = model_functorch device criterion = nn CrossEntropyLoss images = torch randn batch_size device=device targets = torch randint batch_size device=device func_model weights = make_functional model_functorch compute_loss weights image target images = image unsqueeze targets = target unsqueeze output = func_model weights images loss = criterion output targets loss functorch_per_sample_grad compute_grad = grad compute_loss compute_per_sample_grad = vmap compute_grad None start = time time result = compute_per_sample_grad weights images targets torch cuda synchronize end = time time result end - start end - start seconds torch manual_seed model_opacus = convert_batchnorm_modules models resnet num_classes= model_opacus = model_opacus device criterion = nn CrossEntropyLoss p_f p_o zip model_functorch parameters model_opacus parameters assert torch allclose p_f p_o Sanity check privacy_engine = PrivacyEngine model_opacus sample_rate= alphas= noise_multiplier= max_grad_norm= opacus_per_sample_grad start = time time output = model_opacus images loss = criterion output targets loss backward torch cuda synchronize end = time time expected = p grad_sample p model_opacus parameters p model_opacus parameters delattr p grad_sample p grad = None expected end - start _ range _ seconds = functorch_per_sample_grad print seconds result seconds = functorch_per_sample_grad print seconds _ range _ seconds = opacus_per_sample_grad print seconds expected seconds = opacus_per_sample_grad print seconds result = r detach r result print len result TODO The following shows per-sample-grads computed different This concerns me little we should compare source truth i r e enumerate list zip result expected - torch allclose r e rtol= e- continue print - i+ r - e e + abs max
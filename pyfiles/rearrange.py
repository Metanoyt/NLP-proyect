__future__ annotations functools typing TYPE_CHECKING Union torch functorch dim dims noqa F _parsing _ellipsis AnonymousAxis comma_separate parse_pattern validate_rearrange_expressions TYPE_CHECKING collections abc Callable Sequence __all__ = rearrange functools lru_cache _create_rearrange_callable tensor_ndim int pattern str axes_lengths int - Callable torch Tensor torch Tensor r Translate ` einops ` -style pattern into callable performs rearrange using first-class dimensions Since equivalent result computed tensors same number dimensions same pattern specified axes lengths function can memoized Args tensor_ndim int number dimensions tensor rearrange pattern str ` einops ` -style rearrangement pattern axes_lengths int any additional length specifications dimensions Returns Callable torch Tensor torch Tensor callable performs rearrangement left right = parse_pattern pattern axes_lengths validate_rearrange_expressions left right axes_lengths n_anon_dims = sum dim dim left composition left has_ellipsis n_ellipsis_dims = tensor_ndim - len left composition - n_named_dims = len left identifiers - pattern_ndim = n_anon_dims + n_named_dims tensor_ndim raise ValueError f Number dimensions pattern pattern_ndim must less than equal number f dimensions tensor tensor_ndim n_ellipsis_dims = n_named_dims = len left identifiers pattern_ndim = len left composition = tensor_ndim raise ValueError f Number dimensions pattern pattern_ndim must equal number dimensions f tensor tensor_ndim n_dims = n_named_dims + n_ellipsis_dims + n_anon_dims n_dims == identity rearrangement -dimension tensor lambda tensor tensor first_class_dims tuple str = tuple f d i i range n_dims identifier_dim_map dict Union str AnonymousAxis tuple str = anon_axes list AnonymousAxis = map left-hand side identifiers strings representing first dims dims_i = dimension left composition isinstance dimension list identifier dimension non-unitary anon axes allowed rearrange unitary anon axes represented empty lists assert isinstance identifier str identifier_dim_map identifier = first_class_dims dims_i dims_i += dimension unitary anonymous axis anon_axis = AnonymousAxis identifier_dim_map anon_axis = first_class_dims dims_i anon_axes append anon_axis dimension append anon_axis dims_i += dimension == _ellipsis identifier = _ellipsis identifier_dim_map identifier = tuple first_class_dims dims_i + j j range n_ellipsis_dims dims_i += n_ellipsis_dims raise ValueError f Unexpected dimension dimension composition_to_dims composition Sequence Union list Union str AnonymousAxis str - list Union str tuple str Convert ` ParsedExpression composition ` into ` Tensor __getitem__ ` index strings representing first dims dim_composition list Union str tuple str = dimension composition isinstance dimension list dim_composition append tuple dim identifier dimension dim identifier_dim_map identifier dimension == _ellipsis dim_composition extend identifier_dim_map _ellipsis raise ValueError f Unexpected dimension dimension dim_composition left_dims = composition_to_dims left composition right_dims = composition_to_dims right composition anon_dims = tuple identifier_dim_map axis axis anon_axes specified_lengths = tuple identifier_dim_map axis length axis length axes_lengths items custom_rearrange_callable_name = do_rearrange custom_rearrange_callable_code = f custom_rearrange_callable_name tensor \n f comma_separate first_class_dims = dims n_dims \n + join f dim size = length \n dim length specified_lengths specified_lengths + f tensor = tensor comma_separate left_dims order comma_separate right_dims \n + f tensor sum comma_separate anon_dims keepdim=False \n anon_dims tensor\n exec custom_rearrange_callable_code locals custom_rearrange_callable_name rearrange tensor Union torch Tensor list torch Tensor tuple torch Tensor pattern str axes_lengths int - torch Tensor r A native implementation ` einops rearrange ` reader-friendly smart element reordering multidimensional tensors This operation includes functionality transpose axes permutation reshape view squeeze unsqueeze stack concatenate other operations See https einops rocks api rearrange Args tensor Tensor sequence Tensor tensor s rearrange pattern str rearrangement pattern axes_lengths int any additional length specifications dimensions Returns Tensor rearranged tensor Examples suppose we have set images h w c format height-width-channel images = torch randn stack along first batch axis output single array rearrange images b h w c - b h w c shape torch Size concatenate images along height vertical axis = rearrange images b h w c - b h w c shape torch Size concatenated images along horizontal axis = rearrange images b h w c - h b w c shape torch Size reordered axes b c h w format deep learning rearrange images b h w c - b c h w shape torch Size flattened each image into vector = rearrange images b h w c - b c h w shape torch Size split each image into smaller top-left top-right bottom-left bottom-right = rearrange images b h h w w c - b h w h w c h = w = shape torch Size space-to-depth operation rearrange images b h h w w c - b h w c h w h = w = shape torch Size isinstance tensor torch Tensor tensor = torch stack tensor rearrange_callable = _create_rearrange_callable tensor ndim pattern axes_lengths rearrange_callable tensor
dataclasses importlib io pickle abc abstractmethod collections abc Callable typing Any NewType Optional TypeVar Union typing_extensions override Self torch torch utils _pytree pytree torch _guards TracingContext torch _inductor standalone_compile AOTCompiledArtifact torch _subclasses fake_tensor FakeTensor FakeTensorMode Tensor torch _subclasses meta_utils MetaConverter MetaTensorDesc MetaTensorDescriber torch fx experimental sym_node SymNode torch fx experimental symbolic_shapes ShapeEnv torch utils _mode_utils no_dispatch _SymNodeT = TypeVar _SymNodeT torch SymInt torch SymFloat _ops_filter_safe name str - bool An ops filter which allows pickle-safe ops Pickle-safe ops built-in ones where will possible unpickle any machine which has PyTorch TODO This list pretty pessimistic right now What s full list name startswith torch ops aten torch ops fbgemm dataclasses dataclass Options A filter which ops will cause pickler raise BypassFxGraphCache exception If None then all ops allowed ops_filter Optional Callable str bool = _ops_filter_safe GraphPickler pickle Pickler GraphPickler Pickler which helps pickling fx graph - particular GraphModule __init__ file io BytesIO options Optional Options = None - None super __init__ file options = options Options This abomination so we can pass external decoding state unpickler functions We serialize _unpickle_state persistent external item when we deserialize we common state object _unpickle_state = _UnpickleStateToken object This used describe tensors It needs common across pickle so duplicates views properly handled _meta_tensor_describer = MetaTensorDescriber copy_data=False override pyrefly ignore bad-override reducer_override obj object - tuple Callable Any tuple Any This function supposed either NotImplemented meaning do default pickle behavior pair unpickle callable data pass unpickle We could instead teach individual classes how pickle themselves has few problems If we have some special needs maybe use-case we don t want fully serialize every field then we re adding private details public interface If we need have some common shared data such FakeTensorMode which passed each value s harder support These types need special handling See individual PickleData classes details pickling particular type isinstance obj FakeTensor _TensorPickleData reduce_helper obj isinstance obj torch fx GraphModule _GraphModulePickleData reduce_helper obj isinstance obj torch _ops OperatorBase torch _ops OpOverloadPacket _OpPickleData reduce_helper obj isinstance obj ShapeEnv _ShapeEnvPickleData reduce_helper obj isinstance obj torch SymInt _SymNodePickleData reduce_helper obj isinstance obj torch _guards TracingContext _TracingContextPickleData reduce_helper obj We should never get raw Node assert isinstance obj torch fx Node reduce = _TorchNumpyPickleData reduce_helper obj reduce returning ` NotImplemented ` causes pickle revert default behavior object NotImplemented override persistent_id obj object - Optional str obj _unpickle_state unpickle_state None classmethod dumps cls obj object options Optional Options = None - bytes Pickle object io BytesIO stream pickler = cls stream options pickler dump obj stream getvalue staticmethod loads data bytes fake_mode FakeTensorMode - object Unpickle object state = _UnpickleState fake_mode io BytesIO data stream unpickler = _GraphUnpickler stream state unpickler load _UnpickleState __init__ fake_mode FakeTensorMode - None fake_mode = fake_mode meta_converter MetaConverter FakeTensor = MetaConverter This token passed when pickling indicate we want use unpickler s _UnpickleState parameter position _UnpickleStateToken = NewType _UnpickleStateToken object _GraphUnpickler pickle Unpickler __init__ stream io BytesIO unpickle_state _UnpickleState - None super __init__ stream _unpickle_state = unpickle_state override persistent_load pid object - object pid == unpickle_state _unpickle_state raise pickle UnpicklingError Invalid persistent ID _ShapeEnvPickleData data dict str object classmethod reduce_helper cls pickler GraphPickler obj ShapeEnv - tuple Callable Self _UnpickleState ShapeEnv tuple Self _UnpickleStateToken cls unpickle cls obj pickler _unpickle_state __init__ env ShapeEnv - None In theory pickle should recognize given ShapeEnv already pickled reuse resulting _ShapeEnvPickleData so two objects pointing same ShapeEnv get same ShapeEnv out assert env _translation_validation_enabled data = env __dict__ copy del data tracked_fakes del data fake_tensor_cache unpickle unpickle_state _UnpickleState - ShapeEnv Fill existing ShapeEnv rather than creating new one assert unpickle_state fake_mode assert unpickle_state fake_mode shape_env k v data items setattr unpickle_state fake_mode shape_env k v unpickle_state fake_mode shape_env _SymNodePickleData classmethod reduce_helper cls pickler GraphPickler obj _SymNodeT - tuple Callable Self _UnpickleState _SymNodeT tuple Self _UnpickleStateToken args = cls obj node pickler _unpickle_state isinstance obj torch SymInt pyrefly ignore bad-return _SymNodePickleData unpickle_sym_int args raise NotImplementedError f Unhandled SymNode type type obj __init__ node SymNode - None expr = node _expr shape_env = node shape_env pytype = node pytype hint = node _hint _to_sym_node - SymNode assert shape_env None SymNode expr shape_env pytype hint unpickle_sym_int unpickle_state _UnpickleState - torch SymInt torch SymInt _to_sym_node _TensorPickleData metadata MetaTensorDesc FakeTensor classmethod reduce_helper cls pickler GraphPickler obj FakeTensor - tuple Callable Self _UnpickleState FakeTensor tuple Self _UnpickleStateToken cls unpickle cls pickler _meta_tensor_describer obj pickler _unpickle_state __init__ describer MetaTensorDescriber t Tensor - None THINGS TO WORRY ABOUT Need make sure two tensors same id end up same id other side wire metadata = describer describe_tensor t view_func fine s either None _FakeTensorViewFunc A custom one which basically lambda can t serialized assert metadata view_func isinstance metadata view_func torch _subclasses meta_utils _FakeTensorViewFunc metadata = dataclasses replace metadata fake_mode=None Some debugging verification k MetaTensorDesc _UNSERIALIZABLE k fake_mode view_func continue assert getattr metadata k None f None k getattr metadata k unpickle unpickle_state _UnpickleState - FakeTensor TODO make common w _output_from_cache_entry fake_tensor py metadata = dataclasses replace metadata fake_mode=unpickle_state fake_mode also need set fake_mode base tensor s view metadata is_view metadata base None new_base = dataclasses replace metadata base fake_mode=unpickle_state fake_mode metadata = dataclasses replace metadata base=new_base with_fake make_meta_t Callable torch Tensor device Union torch device str - FakeTensor no_dispatch FakeTensor unpickle_state fake_mode make_meta_t pyrefly ignore bad-argument-type device unpickle_state meta_converter meta_tensor metadata unpickle_state fake_mode shape_env with_fake None None _TorchNumpyPickleData classmethod reduce_helper cls pickler GraphPickler obj object - Optional tuple Callable Self _UnpickleState object tuple Self _UnpickleStateToken data = cls from_object obj cls unpickle data pickler _unpickle_state None __init__ mod str name str - None mod = mod name = name unpickle unpickle_state _UnpickleState - Callable object np = getattr importlib import_module mod name torch _dynamo variables misc get_np_to_tnp_map np classmethod from_object cls tnp object - Optional Self callable tnp None tnp_to_np = torch _dynamo variables misc get_tnp_to_np_map try np = tnp_to_np get tnp None except TypeError None mod = getattr np __module__ None mod = numpy name = getattr np __name__ None None pyrefly ignore unbound-name assert np == getattr importlib import_module mod name pyrefly ignore unbound-name cls mod name _GraphModulePickleData classmethod reduce_helper cls pickler GraphPickler obj torch fx GraphModule - tuple Callable Self _UnpickleState torch fx GraphModule tuple Self _UnpickleStateToken cls unpickle cls obj pickler options pickler _unpickle_state __init__ gm torch fx GraphModule options Options - None Need do ensure code created later pickling isinstance gm torch fx _lazy_graph_module _LazyGraphModule _python_code = gm _real_recompile _python_code = gm recompile gm_dict = gm __dict__ copy del gm_dict _graph graph = _GraphPickleData gm _graph options unpickle unpickle_state _UnpickleState - torch fx GraphModule gm = torch fx GraphModule __new__ torch fx GraphModule gm __dict__ = gm_dict gm _graph = graph unpickle gm unpickle_state gm _NodePickleData __init__ node torch fx Node mapping dict torch fx Node _NodePickleData options Options - None args = pytree tree_map_only torch fx Node lambda n mapping n node args kwargs = pytree tree_map_only torch fx Node lambda n mapping n node kwargs -- graph = node graph name = node name op = node op target = _OpPickleData pickle node target options input_nodes = node _input_nodes users = node users type = node type sort_key = node _sort_key repr_fn = node _repr_fn meta = node meta meta = node meta unpickle graph torch fx Graph mapping dict _NodePickleData torch fx Node unpickle_state _UnpickleState - torch fx Node args = pytree tree_map_only _NodePickleData lambda n mapping n args kwargs = pytree tree_map_only _NodePickleData lambda n mapping n kwargs target = target unpickle unpickle_state assert callable target isinstance target str node = graph create_node op target args kwargs name type node meta = meta node _OpPickleData classmethod reduce_helper cls pickler GraphPickler op object - tuple Callable _UnpickleState object tuple _UnpickleStateToken result = cls pickle op pickler options result unpickle pickler _unpickle_state classmethod pickle cls op object options Options - _OpPickleData isinstance op str _OpStrPickleData op isinstance getattr op __wrapped__ None AOTCompiledArtifact assert hasattr op __wrapped__ artifact = op __wrapped__ assert isinstance artifact AOTCompiledArtifact _OpPrecompiledPickleData artifact name = torch fx Node _pretty_print_target op isinstance op torch _ops OpOverload cls _pickle_op name _OpOverloadPickleData options isinstance op torch _ops OpOverloadPacket cls _pickle_op name _OpOverloadPacketPickleData options name startswith _OpFunctionPickleData SUPPORTED_ROOTS root detail = name split _OpFunctionPickleData root detail TODO raise BypassFxGraphCache so we will just bypass one raise NotImplementedError f TARGET type op op name staticmethod _pickle_op name str datacls Union type _OpOverloadPickleData type _OpOverloadPacketPickleData options Options - _OpPickleData ops_filter = options ops_filter ops_filter name torch _inductor codecache BypassFxGraphCache raise BypassFxGraphCache f Unable pickle non-standard op name datacls name abstractmethod unpickle unpickle_state _UnpickleState - object pass classmethod _lookup_global_by_name cls name str - object Like ` globals name ` supports dotted names name mod rest = name split root = globals mod cls _getattr_by_name root rest globals name staticmethod _getattr_by_name root object name str - object Like ` getattr root name ` supports dotted names while name mod name = name split root = getattr root mod getattr root name _OpStrPickleData _OpPickleData __init__ name str - None name = name unpickle unpickle_state _UnpickleState - str name _OpOverloadPickleData _OpPickleData __init__ name str - None name = name unpickle unpickle_state _UnpickleState - torch _ops OpOverload obj = _lookup_global_by_name name assert isinstance obj torch _ops OpOverload obj _OpOverloadPacketPickleData _OpPickleData __init__ name str - None name = name unpickle unpickle_state _UnpickleState - torch _ops OpOverloadPacket obj = _lookup_global_by_name name assert isinstance obj torch _ops OpOverloadPacket obj _OpPrecompiledPickleData _OpPickleData __init__ artifact AOTCompiledArtifact - None contents = artifact serialize unpickle unpickle_state _UnpickleState - object precompiled_artifact = AOTCompiledArtifact deserialize contents functools functools wraps precompiled_artifact wrapped args Any - Any precompiled_artifact args wrapped _OpFunctionPickleData _OpPickleData Supports pickling set standard common functions These must prefixed full namespace order properly pickled i e ` einops rearrange ` ` einops rearrange ` Static variable listing supported root names SUPPORTED_ROOTS = builtins math torch operator einops __init__ root str name str - None root = root name = name unpickle unpickle_state _UnpickleState - object root == builtins __builtins__ get name type ignore attr-defined root == math math _getattr_by_name math name root == torch _getattr_by_name torch name root == operator operator _getattr_by_name operator name root == einops einops _getattr_by_name einops name raise NotImplementedError _GraphPickleData __init__ graph torch fx Graph options Options - None tracer_cls = graph _tracer_cls tracer_extras = graph _tracer_extras nodes dict torch fx Node _NodePickleData = node graph nodes nodes node = _NodePickleData node nodes options nodes = tuple nodes values Unpickled variables _used_names = graph _used_names -- _insert = _root prepend _len = graph _len _graph_namespace = graph _graph_namespace _owning_module = graph _owning_module _codegen = graph _codegen _co_fields Dict str Any = graph _co_fields -- _find_nodes_lookup_table = _FindNodesLookupTable unpickle gm torch fx GraphModule unpickle_state _UnpickleState - torch fx Graph graph = torch fx Graph gm tracer_cls tracer_extras nodes dict _NodePickleData torch fx Node = nd nodes nodes nd = nd unpickle graph nodes unpickle_state graph _TracingContextPickleData classmethod reduce_helper cls pickler GraphPickler obj torch _guards TracingContext - tuple Callable Self _UnpickleState torch _guards TracingContext tuple Self _UnpickleStateToken cls unpickle cls obj pickler _unpickle_state __init__ context TracingContext - None TODO Do we really need all module_context = context module_context frame_summary_stack = context frame_summary_stack loc_in_frame = context loc_in_frame aot_graph_name = context aot_graph_name params_flat = context params_flat params_flat_unwrap_subclasses = context params_flat_unwrap_subclasses params_unwrapped_to_flat_index = context params_unwrapped_to_flat_index output_strides = context output_strides force_unspec_int_unbacked_size_like = context force_unspec_int_unbacked_size_like Not saved because s difficult maybe needed fw_metadata = context fw_metadata guards_context = None global_context = None fake_mode = None fakify_first_call = None hop_dispatch_set_cache = None tensor_to_context = context tensor_to_context unpickle unpickle_state _UnpickleState - TracingContext context = TracingContext unpickle_state fake_mode context module_context = module_context context frame_summary_stack = frame_summary_stack context loc_in_frame = loc_in_frame context aot_graph_name = aot_graph_name context params_flat = params_flat context params_flat_unwrap_subclasses = params_flat_unwrap_subclasses context params_unwrapped_to_flat_index = params_unwrapped_to_flat_index context output_strides = output_strides context force_unspec_int_unbacked_size_like = force_unspec_int_unbacked_size_like context
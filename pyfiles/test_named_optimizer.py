Owner s oncall distributed Copyright c Meta Platforms Inc affiliates All rights reserved This source code licensed under BSD-style license found LICENSE file root directory source tree unittest torch torch nn nn torch distributed optim _NamedOptimizer _run_model_training model_optim_lists _ range x = torch rand model_optim_list model_optim_lists model = model_optim_list optim_list = model_optim_list y = model x y sum backward optim optim_list optim step TestDummyModel torch nn Module __init__ - None super __init__ torch manual_seed net = nn Sequential nn Linear nn ReLU net = nn Sequential nn Linear nn ReLU net = nn Linear net = nn Sequential nn ReLU nn Linear forward x net net net net x NamedOptimizerTest unittest TestCase _compare_state_dict_group group named_group assert_equal=True key val group items key = params assertTrue key named_group f key named optimizer state dict err_msg = f key state equal assert_equal f key state equal isinstance val torch Tensor fn = assertTrue assert_equal assertFalse fn torch allclose val named_group key err_msg fn = assertEqual assert_equal assertNotEqual fn val named_group key err_msg _compare_param_groups param_groups_ param_groups_ assertTrue isinstance param_groups_ list assertTrue isinstance param_groups_ list groups zip param_groups_ param_groups_ _compare_param_group groups groups _compare_param_group group_ group_ assertTrue isinstance group_ dict assertTrue isinstance group_ dict key val group_ items assertTrue key group_ key = params assertEqual val group_ key tensors zip val group_ key assertTrue torch allclose tensors tensors test_state_dict Check NamedOptimizer exposes expected state dict interface m = TestDummyModel m_dup = TestDummyModel optim = torch optim SGD m parameters lr= e- momentum= named_optim = _NamedOptimizer m_dup named_parameters torch optim SGD lr= e- momentum= _compare_param_groups optim param_groups named_optim param_groups _run_model_training m optim m_dup named_optim _compare_param_groups optim param_groups named_optim param_groups sd = optim state_dict named_sd = named_optim state_dict Compare state optim state dict _compare_state_dict_group sd state named_sd state net weight assert_equal=True _compare_state_dict_group sd state named_sd state net bias assert_equal=True _compare_state_dict_group sd state named_sd state net weight assert_equal=True _compare_state_dict_group sd state named_sd state net bias assert_equal=True test_state_dict_multi_param_group Check NamedOptimizer exposes expected state dict interface when multiple param groups specified m = TestDummyModel m_dup = TestDummyModel optim_ = torch optim SGD params m net parameters params m net parameters lr e- lr= e- momentum= optim_ = torch optim Adam params m net parameters params m net parameters lr e- named_optim_ = _NamedOptimizer m_dup named_parameters torch optim SGD params m_dup net parameters params m_dup net parameters lr e- lr= e- momentum= named_optim_ = _NamedOptimizer m_dup named_parameters torch optim Adam params m_dup net parameters params m_dup net parameters lr e- _compare_param_groups optim_ param_groups named_optim_ param_groups _compare_param_groups optim_ param_groups named_optim_ param_groups _run_model_training m optim_ optim_ m_dup named_optim_ named_optim_ _compare_param_groups optim_ param_groups named_optim_ param_groups _compare_param_groups optim_ param_groups named_optim_ param_groups sd_ = optim_ state_dict sd_ = optim_ state_dict named_sd_ = named_optim_ state_dict named_sd_ = named_optim_ state_dict Compare state optim state dict _compare_state_dict_group sd_ state named_sd_ state net weight assert_equal=True _compare_state_dict_group sd_ state named_sd_ state net bias assert_equal=True _compare_state_dict_group sd_ state named_sd_ state net weight assert_equal=True _compare_state_dict_group sd_ state named_sd_ state net bias assert_equal=True Compare param_groups optim state dict _compare_state_dict_group sd_ param_groups named_sd_ param_groups assert_equal=True _compare_state_dict_group sd_ param_groups named_sd_ param_groups assert_equal=True test_load_state_dict Check NamedOptimizer s load_state_dict works expected m = TestDummyModel named_optim_ = _NamedOptimizer m named_parameters torch optim SGD lr= e- momentum= _run_model_training m named_optim_ state_dict_to_load = named_optim_ state_dict named_optim_ = _NamedOptimizer m named_parameters torch optim SGD lr= e- momentum= _run_model_training m named_optim_ state_dict_before_load = named_optim_ state_dict Compare state optim state dict _compare_state_dict_group state_dict_to_load state net weight state_dict_before_load state net weight assert_equal=False _compare_state_dict_group state_dict_to_load state net bias state_dict_before_load state net bias assert_equal=False _compare_state_dict_group state_dict_to_load state net weight state_dict_before_load state net weight assert_equal=False _compare_state_dict_group state_dict_to_load state net bias state_dict_before_load state net bias assert_equal=False named_optim_ load_state_dict state_dict_to_load state_dict_after_load = named_optim_ state_dict Compare state optim state dict _compare_state_dict_group state_dict_to_load state net weight state_dict_after_load state net weight assert_equal=True _compare_state_dict_group state_dict_to_load state net bias state_dict_after_load state net bias assert_equal=True _compare_state_dict_group state_dict_to_load state net weight state_dict_after_load state net weight assert_equal=True _compare_state_dict_group state_dict_to_load state net bias state_dict_after_load state net bias assert_equal=True test_load_state_dict_conditional_training Check NamedOptimizer load_state_dict works under conditional training case m = TestDummyModel named_optim_ = _NamedOptimizer m named_parameters torch optim SGD params m net parameters params m net parameters lr e- lr= e- momentum= _run_model_training m named_optim_ state_dict_to_load = named_optim_ state_dict named_optim_ = _NamedOptimizer m named_parameters torch optim SGD lr= e- momentum= _run_model_training m named_optim_ named_optim_ load_state_dict state_dict_to_load state_dict_after_load = named_optim_ state_dict Compare state optim state dict _compare_state_dict_group state_dict_to_load state net weight state_dict_after_load state net weight assert_equal=True _compare_state_dict_group state_dict_to_load state net weight state_dict_after_load state net weight assert_equal=True test_load_state_dict_error m = TestDummyModel named_optim_ = _NamedOptimizer m named_parameters torch optim SGD lr= e- momentum= _run_model_training m named_optim_ state_dict_to_load = named_optim_ state_dict named_optim_ = _NamedOptimizer m named_parameters torch optim SGD lr= e- momentum= err_msg = Expects optim initialized before load found initialized assertRaisesRegex ValueError err_msg named_optim_ load_state_dict state_dict_to_load test_add_param_group m = TestDummyModel m_dup = TestDummyModel optim = torch optim SGD params m net parameters params m net parameters lr e- lr= e- momentum= named_optim = _NamedOptimizer m_dup named_parameters torch optim SGD params m_dup net parameters params m_dup net parameters lr e- lr= e- momentum= _run_model_training m optim m_dup named_optim _compare_param_groups optim param_groups named_optim param_groups optim add_param_group params m net parameters lr e- named_optim add_param_group params m_dup net parameters lr e- _run_model_training m optim m_dup named_optim _compare_param_groups optim param_groups named_optim param_groups optim add_param_group params m net weight lr e- named_optim add_param_group params m_dup net weight lr e- _run_model_training m optim m_dup named_optim _compare_param_groups optim param_groups named_optim param_groups test_add_param_group_error m = TestDummyModel named_optim = _NamedOptimizer m named_parameters torch optim SGD params m net parameters params m net parameters lr e- lr= e- momentum= err_msg = some parameters module assertRaisesRegex ValueError err_msg named_optim add_param_group params torch ones lr e- test_init_state m = TestDummyModel named_optim = _NamedOptimizer m named_parameters torch optim SGD params m net parameters params m net parameters lr e- lr= e- momentum= named_sd = named_optim state_dict assertTrue m net weight grad None assertTrue len named_sd state == named_optim init_state named_sd = named_optim state_dict assertTrue m net weight grad None assertTrue momentum_buffer named_sd state net weight assertFalse torch all named_sd state net weight momentum_buffer item assertFalse torch all named_sd state net bias momentum_buffer item assertTrue m net bias grad None assertTrue momentum_buffer named_sd state net bias assertFalse torch all named_sd state net bias momentum_buffer item assertFalse torch all named_sd state net weight momentum_buffer item
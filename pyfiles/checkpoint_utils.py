mypy allow-untyped-defs Copyright c Meta Platforms Inc affiliates io logging os shutil tempfile collections abc Callable functools wraps typing Any cast IO Optional introduced collections abc Buffer Python typing_extensions Buffer torch distributed dist torch distributed checkpoint _extension ExtensionRegistry StreamTransformExtension Rot Example StreamTransformExtension This example stream transform extension which just does rot each alphanumeric character stream It mainly intended demonstration testing there isn t production use case __init__ chunk_size int = io DEFAULT_BUFFER_SIZE - None super __init__ _chunk_size = chunk_size staticmethod from_descriptor version str - Rot Example version partition = raise ValueError f Unknown extension version= Rot Example staticmethod registry_name - str stream rot get_descriptor - str f registry_name staticmethod _rot bytes b Buffer count int - None b = memoryview b i range count ch = b i ch = ord A ch = ord Z ch += ord - ord A ch = ord ch = ord z ch += ord A - ord b i = ch transform_to output IO bytes - IO bytes Writer io RawIOBase __init__ output IO bytes - None output = output writeable - bool True write b Buffer - Optional int Don t mutate input chunk = bytearray b Rot Example _rot bytes chunk len chunk output write chunk flush - None output flush cast IO bytes Writer output transform_from input IO bytes - IO bytes Reader io RawIOBase __init__ input IO bytes - None input = input readable - bool True readinto b Buffer - Optional int hasattr input readinto count = input readinto b It s possible input IO bytes no readinto method In case we emulate read copy In practice all current concrete extensions have readinto view = memoryview b r = input read len view r None count = None count = len r view count = r count == count None count Rot Example _rot bytes b count count seekable - bool input seekable seek offset int whence int = os SEEK_SET - int input seek offset whence tell - int input tell cast IO bytes Reader input get_test_extension_registry - ExtensionRegistry registry = ExtensionRegistry registry register Rot Example registry with_temp_dir func Optional Callable = None - Optional Callable Wrapper initialize temp directory distributed checkpoint assert func None wraps func wrapper args tuple object kwargs dict str Any - None dist is_initialized Only create temp_dir when rank dist get_rank == temp_dir = tempfile mkdtemp print f Using temp directory temp_dir temp_dir = object_list = temp_dir Broadcast temp_dir all other ranks os sync dist broadcast_object_list object_list temp_dir = object_list os sync temp_dir = tempfile mkdtemp print f No process group initialized using temp directory temp_dir temp_dir = temp_dir try func args kwargs finally dist is_initialized dist get_rank == shutil rmtree temp_dir ignore_errors=True shutil rmtree temp_dir ignore_errors=True wrapper with_checkpoint_logging func Optional Callable = None logger_name str = torch distributed checkpoint level int = logging INFO - Optional Callable Wrapper configure checkpoint logging distributed tests Args func The test function wrap logger_name Name logger configure default torch distributed checkpoint level Logging level set default logging INFO assert func None wraps func wrapper args tuple object kwargs dict str Any - None Get logger store original level target_logger = logging getLogger logger_name original_level = target_logger level Set desired logging level target_logger setLevel level try func args kwargs finally Restore original logging level target_logger setLevel original_level wrapper
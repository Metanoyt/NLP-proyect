dataclasses typing Any Optional Union torch torch _dynamo exc UserError UserErrorType torch export dynamic_shapes _check_dynamic_shapes _DerivedDim _DimHint _tree_map_with_path Dim torch utils _pytree tree_map serialize _dataclass_to_dict dataclasses dataclass RootDim This represents Dim object min int max Union int None derived list str dataclasses dataclass DynamicShapesSpec This stores dynamic_shapes spec de serialization dynamic_shapes Union dict str Any tuple Any list Any None dims dict str RootDim _postprocess_serialized_shapes dynamic_shapes Union dict str Any tuple Any list Any None dims dict str dict str Union int list str None to_dict Optional bool = False - Union DynamicShapesSpec dict str Any Sorts dims dumps dictionary format torch utils _sympy numbers int_oo dims = k RootDim min=v min type ignore arg-type max=None v max int_oo v max type ignore arg-type derived=sorted v derived type ignore arg-type k v sorted dims items pyrefly ignore bad-argument-type spec = DynamicShapesSpec dynamic_shapes=dynamic_shapes dims=dims to_dict _dataclass_to_dict spec spec _dump_dynamic_shapes dynamic_shapes Union dict str Any tuple Any list Any None args tuple Any kwargs Optional dict str Any = None to_dict Optional bool = False - Union DynamicShapesSpec dict str Any Utility function dynamic shapes serialization serializing dynamic_shapes spec Returns DynamicShapesSpec dataclass containing fields dynamic_shapes dims Uses args kwargs distinguish between tensor-level dim-level specs only Nones dynamic_shapes A pytree structure mirroring dynamic_shapes input export - Each tensor input represented list values non-tensor inputs None - dynamic dimensions i e symbols tensors Dim enums represented strings - static dimensions represented ints dims A dictionary mapping each symbol name min max range derived dim names For example ` ` ` dx = Dim dx min= max= dy = dx + inputs = torch randn torch randn torch randn torch randn hello dynamic_shapes = dx dy b Dim STATIC c None d None out = _dump_dynamic_shapes dynamic_shapes inputs to_dict=True ` ` ` would generate following output ` ` ` dynamic_shapes dx dx + _DimHint STATIC _DimHint STATIC _DimHint STATIC None dims dx min max derived dx + ` ` ` dims dict str dict str Any = _standardize_shapes path tensor shape type ignore no-untyped-def Helps standardize dynamic_shapes tree structure we serialize returning lists each tensor shape handling tensor-level Nones isinstance tensor torch Tensor None shape None Dim STATIC len tensor shape out = isinstance shape dict i s enumerate tensor shape out append s shape get i None shape get i assert isinstance shape tuple list i s enumerate tensor shape out append s shape i None shape i out _track_dim_from_dims val Union None int _DimHint Dim - Union None int str Tracks dims ranges derived dims standardized dynamic_shapes spec val None isinstance val int non-tensor input static val isinstance val _DimHint store enum string val __class__ __name__ + + val type name assert isinstance val Dim track root dim root = val root isinstance val _DerivedDim val type ignore attr-defined root __name__ dims dims root __name__ = min root min type ignore attr-defined union-attr max root max type ignore attr-defined union-attr derived set track derived dims isinstance val _DerivedDim dims root __name__ derived add val __name__ val __name__ dynamic_shapes None dynamic_shapes None dims convert tuple specs each arg kwarg kwargs = kwargs isinstance dynamic_shapes dict dynamic_shapes = dynamic_shapes values type ignore assignment pyrefly ignore bad-assignment bad-argument-type dynamic_shapes = tuple dynamic_shapes combined_args = tuple args + tuple kwargs values run same check when we re processing shapes export - too lazy _check_dynamic_shapes dict enumerate combined_args dynamic_shapes type ignore arg-type tree_shapes = _tree_map_with_path _standardize_shapes combined_args dynamic_shapes tree_name= inputs serialized_shapes = tree_map _track_dim_from_dims tree_shapes _postprocess_serialized_shapes serialized_shapes dims to_dict=to_dict _load_dynamic_shapes spec Union DynamicShapesSpec dict str Any from_dict Optional bool = False - Union dict str Any tuple Any list Any None Utility function dynamic shapes serialization Deserializes DynamicShapesSpec corresponding dictionary into dynamic_shapes input export sympy torch fx experimental symbolic_shapes _is_supported_equivalence from_dict isinstance spec dict raise UserError UserErrorType INVALID_INPUT f With from_dict=True expected ` spec ` dict got type spec sorted spec keys = dims dynamic_shapes raise UserError UserErrorType INVALID_INPUT With from_dict=True expected ` spec ` have keys ` dims ` ` dynamic_shapes ` f instead found spec keys dims = k v spec dims items isinstance k str raise UserError UserErrorType INVALID_INPUT f Expected ` spec dims ` keys strings symbols got key type k sorted v keys = derived max min raise UserError UserErrorType INVALID_INPUT f Expected ` spec dims ` values have keys ` derived ` ` max ` ` min ` f instead found v keys isinstance v min int raise UserError UserErrorType INVALID_INPUT f Expected dims ` spec dims ` map ` min ` int got k v min isinstance v max int v max None raise UserError UserErrorType INVALID_INPUT f Expected dims ` spec dims ` map ` max ` int None got k v max isinstance v derived list any isinstance d str d v derived raise UserError UserErrorType INVALID_INPUT Expected dims ` spec dims ` map ` derived ` list derived expressions f got k v derived dims k = RootDim v dynamic_shapes = spec dynamic_shapes isinstance spec DynamicShapesSpec raise UserError UserErrorType INVALID_INPUT f Expected ` spec ` DynamicShapesSpec got type spec dims = spec dims dynamic_shapes = spec dynamic_shapes dynamic_shapes None None dim_cache = name info dims items symbol = sympy sympify name isinstance symbol sympy Symbol raise UserError UserErrorType INVALID_INPUT f Expected ` spec dims ` keys symbols got name dim_cache name = Dim name min=info min max=info max cache root dim _expr info derived expr = sympy sympify _expr len expr free_symbols = symbol expr free_symbols raise UserError UserErrorType INVALID_INPUT f Expected derived expressions have name only free symbol got expr _is_supported_equivalence expr raise UserError UserErrorType INVALID_INPUT f Expected derived expressions linear expressions got expr modulus remainder = sympy polys polytools div expr symbol ddim = dim_cache name modulus = ddim = int modulus ddim type ignore assignment operator remainder = ddim = ddim + int remainder type ignore assignment operator dim_cache _expr = ddim cache derived dims deserialize_shape val Union None int str - Union None int Dim _DimHint val None isinstance val int val val == _DimHint AUTO _DimHint AUTO val == _DimHint DYNAMIC _DimHint DYNAMIC val == _DimHint STATIC _DimHint STATIC isinstance val str raise UserError UserErrorType INVALID_INPUT Expected leaves ` spec dynamic_shapes ` ints None Dim AUTO STATIC symbols f derived expressions got val val dim_cache raise UserError UserErrorType INVALID_INPUT Expected dims ` spec dynamic_shapes ` tracked ` spec dims ` f got val which dims keys dim_cache val type ignore return-value tree_map deserialize_shape dynamic_shapes
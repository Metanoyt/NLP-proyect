functools logging math os collections Counter defaultdict collections abc Generator Iterable functools partial typing Any torch torch testing make_tensor torch utils _pytree pytree torch utils _python_dispatch TorchDispatchMode torch utils _pytree tree_map log = logging getLogger __name__ OP_INP_DIRECTORY = os path join os path dirname __file__ operator_inp_logs TIMM_DIR = os path join OP_INP_DIRECTORY timm_train HF_DIR = os path join OP_INP_DIRECTORY hf_train TORCHBENCH_DIR = os path join OP_INP_DIRECTORY torchbench_train aten = torch ops aten tensor_type = torch _C TensorType get dtype_abbrs = torch bfloat bf torch float f torch float f torch float f torch complex c torch complex c torch complex c torch int i torch int i torch int i torch int i torch bool b torch uint u dtype_abbrs_parsing = value key key value dtype_abbrs items truncate_inp arg arg dtype_abbrs dtype_abbrs arg isinstance arg torch device arg type arg Serialize Function Call FuncCallWrapper __init__ call args kwargs call = call args = tree_map truncate_inp args kwargs = tree_map truncate_inp kwargs kwargs None __repr__ args = join repr arg arg args kwargs = join f str key = value key value kwargs items out = f call args kwargs strip f strings introduce quotations we dont want key dtype_abbrs_parsing out = out replace f key key out serialize_sparse_tensor e isinstance e torch _subclasses FakeTensor FuncCallWrapper ST list e shape e dtype e layout e is_coalesced FuncCallWrapper ST list e shape e dtype e layout e is_coalesced e _nnz deserialize_sparse_tensor size dtype layout is_coalesced nnz=None raise NotImplementedError deserialize_tensor size dtype stride=None stride None out = torch empty_strided size stride dtype=dtype out = torch empty size dtype=dtype try out copy_ make_tensor size dtype=dtype device= cpu except Exception e print e out out serialize_tensor e e is_contiguous FuncCallWrapper T list e shape e dtype stride=e stride FuncCallWrapper T list e shape e dtype serialize_torch_args e isinstance e torch Tensor e is_sparse serialize_sparse_tensor e serialize_tensor e truncate_inp e contains_tensor elems elem pytree tree_leaves elems isinstance elem torch Tensor True False skip_args elems i pytree tree_leaves elems only shows up constructors ops like isinstance i torch memory_format torch storage UntypedStorage True False contains_tensor_types type type isSubtypeOf tensor_type any contains_tensor_types e e type containedTypes functools cache non_compute_operator op schema = op _schema skip constructors any contains_tensor_types arg type arg schema arguments True _like op name True allow place writes schema is_mutable False tensor_inps = arg arg schema arguments arg type tensor_type tensor_outputs = ret ret schema returns ret type tensor_type skip aliasing unless there multiple outputs len tensor_outputs = False inp tensor_inps inp alias_info tensor_outputs alias_info inp alias_info before_set intersection tensor_outputs alias_info after_set True False OperatorInputsMode TorchDispatchMode __init__ func_db=None func_db = defaultdict Counter func_db None func_db __torch_dispatch__ func_overload types args= kwargs=None kwargs = kwargs kwargs arg_meta kwarg_meta = tree_map serialize_torch_args args kwargs out = func_overload args kwargs inps = args kwargs contains_tensor inps skip_args inps contains_tensor out serialized_str = repr arg_meta kwarg_meta func_db str func_overload serialized_str += out log_to_file output_filename skip_non_compute_operators=True sorted_operators = sorted func_db keys open output_filename w f operator sorted_operators skip_non_compute_operators non_compute_operator eval operator continue f write f Operator operator \n operator_inputs = func_db operator inps count operator_inputs items f write f cnt count repr will add quotation marks around dtype strings dtype_abbr dtype_abbrs values inps = inps replace + dtype_abbr + dtype_abbr f write inps f write \n map_to_device e device isinstance e torch Tensor e device isinstance e torch device device isinstance e str e == cuda e == cpu device type e map_to_dtype e dtype isinstance e torch Tensor e is_floating_point e dtype isinstance e torch dtype dtype e deserialize_args inps inps = inps strip strip global_vals = T deserialize_tensor ST deserialize_sparse_tensor th torch inf math inf torch torch dtype_abbrs_parsing f strings introduce quotations we dont want key dtype_abbrs_parsing inps = inps replace f key key eval inps strip strip strip global_vals OperatorInputsLoader __init__ json_file_path operator_db = defaultdict Counter open json_file_path f lines = f readlines i = while i len lines op_line = lines i strip \n assert Operator op_line op_line operator = op_line len Operator operator = operator operator = aten sum SymInt aten sum dim_IntList op_inps = Counter i += while i len lines Operator lines i line = lines i cnt = eval line len cnt line find inps = line line find + strip op_inps inps += cnt i += operator_db operator = op_inps get_inputs_for_operator operator dtype=None device= cuda - Generator tuple Iterable Any dict str Any None None assert str operator operator_db f Could find operator must provide overload embedding str operator log warning Embedding inputs NYI input data cannot randomized yield line represents number times these inputs occurred ignored now line operator_db str operator items inps = line args kwargs = deserialize_args inps Backwards require some inputs float some float So we record half upcast float when specified dtype dtype = torch float to_dtype = partial map_to_dtype dtype=dtype args kwargs = tree_map to_dtype args kwargs device to_device = partial map_to_device device=torch device device args kwargs = tree_map to_device args kwargs yield args kwargs get_all_ops key operator_db keys try op = eval key except AttributeError log warning Evaluating op name into OpOverload exc_info=True continue yield op get_call_frequency op assert str op operator_db f Could find op must provide overload count = counter operator_db str op values count += counter count merge other operator counter_dict other operator_db items inps cnt counter_dict items operator_db operator inps += cnt staticmethod get_timm_loader OperatorInputsLoader _load_directory TIMM_DIR staticmethod get_huggingface_loader OperatorInputsLoader _load_directory HF_DIR staticmethod get_torchbench_loader OperatorInputsLoader _load_directory TORCHBENCH_DIR staticmethod _load_directory inp_dir assert os path isdir inp_dir inp_dir union = None inp os listdir inp_dir inp - = txt continue path = os path join inp_dir inp union None union = OperatorInputsLoader path union merge OperatorInputsLoader path union
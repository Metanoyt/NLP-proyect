======= BEGIN Dynamo patch ======= Owner s module dynamo ruff noqa flake noqa Test copied https raw githubusercontent com python cpython refs tags v Lib test mapping_tests py sys torch torch _dynamo test_case unittest torch _dynamo test_case CPythonTestCase torch testing _internal common_utils run_tests __TestCase = CPythonTestCase redirect statements sys importlib abc redirect_imports = test mapping_tests test typinganndata test test_grammar test test_math test test_iter test typinganndata ann_module RedirectImportFinder importlib abc MetaPathFinder find_spec fullname path target=None Check problematic one fullname redirect_imports try Attempt standalone module name = fullname removeprefix test r = importlib import_module name Redirect module sys modules sys modules fullname = r Return module spec found module importlib util find_spec name except ImportError None None Add custom finder sys meta_path sys meta_path insert RedirectImportFinder ======= END DYNAMO PATCH ======= tests common dict UserDict unittest collections test support get_c_recursion_limit BasicTestMappingProtocol __TestCase This base can used check object conforms mapping protocol Functions can useful override adapt dictionary semantics type test = None which being tested overwrite subclasses _reference Return dictionary values which invariant storage object under test key value key _empty_mapping Return empty mapping object type test _full_mapping data Return mapping object value contained data dictionary x = _empty_mapping key value data items x key = value x __init__ args kw unittest TestCase __init__ args kw reference = _reference copy A key value pair mapping key value = reference popitem other = key value A key value pair mapping key value = reference popitem inmapping = key value reference key = value test_read Test read only operations mapping p = _empty_mapping p = dict p #workaround singleton objects d = _full_mapping reference d p p = p #Indexing key value reference items assertEqual d key value knownkey = list other keys assertRaises KeyError lambda d knownkey #len assertEqual len p assertEqual len d len reference #__contains__ k reference assertIn k d k other assertNotIn k d #cmp assertEqual p p assertEqual d d assertNotEqual p d assertNotEqual d p #bool p fail Empty mapping must compare False d fail Full mapping must compare True keys items iterkeys check_iterandlist iter lst ref assertTrue hasattr iter __next__ assertTrue hasattr iter __iter__ x = list iter assertTrue set x ==set lst ==set ref check_iterandlist iter d keys list d keys reference keys check_iterandlist iter d list d keys reference keys check_iterandlist iter d values list d values reference values check_iterandlist iter d items list d items reference items #get key value = next iter d items knownkey knownvalue = next iter other items assertEqual d get key knownvalue value assertEqual d get knownkey knownvalue knownvalue assertNotIn knownkey d test_write Test write operations mapping p = _empty_mapping #Indexing key value reference items p key = value assertEqual p key value key reference keys del p key assertRaises KeyError lambda p key p = _empty_mapping #update p update reference assertEqual dict p reference items = list p items p = _empty_mapping p update items assertEqual dict p reference d = _full_mapping reference #setdefault key value = next iter d items knownkey knownvalue = next iter other items assertEqual d setdefault key knownvalue value assertEqual d key value assertEqual d setdefault knownkey knownvalue knownvalue assertEqual d knownkey knownvalue #pop assertEqual d pop knownkey knownvalue assertNotIn knownkey d assertRaises KeyError d pop knownkey default = d knownkey = knownvalue assertEqual d pop knownkey default knownvalue assertNotIn knownkey d assertEqual d pop knownkey default default #popitem key value = d popitem assertNotIn key d assertEqual value reference key p=self _empty_mapping assertRaises KeyError p popitem test_constructor assertEqual _empty_mapping _empty_mapping test_bool assertTrue _empty_mapping assertTrue reference assertTrue bool _empty_mapping False assertTrue bool reference True test_keys d = _empty_mapping assertEqual list d keys d = reference assertIn list inmapping keys d keys assertNotIn list other keys d keys assertRaises TypeError d keys None test_values d = _empty_mapping assertEqual list d values assertRaises TypeError d values None test_items d = _empty_mapping assertEqual list d items assertRaises TypeError d items None test_len d = _empty_mapping assertEqual len d test_getitem d = reference assertEqual d list inmapping keys list inmapping values assertRaises TypeError d __getitem__ test_update mapping argument d = _empty_mapping d update other assertEqual list d items list other items No argument d = _empty_mapping d update assertEqual d _empty_mapping item sequence d = _empty_mapping d update other items assertEqual list d items list other items Iterator d = _empty_mapping d update other items assertEqual list d items list other items FIXME Doesn t work UserDict assertRaises TypeError AttributeError d update None assertRaises TypeError AttributeError d update outerself = torch _dynamo error_on_graph_break False SimpleUserDict __init__ d = outerself reference keys d keys __getitem__ i d i d clear d update SimpleUserDict i = sorted d items i = sorted reference items assertEqual i i torch _dynamo error_on_graph_break False Exc Exception pass d = _empty_mapping torch _dynamo error_on_graph_break False FailingUserDict keys raise Exc assertRaises Exc d update FailingUserDict d clear torch _dynamo error_on_graph_break False FailingUserDict keys BogonIter __init__ i = __iter__ __next__ i i = raise Exc BogonIter __getitem__ key key assertRaises Exc d update FailingUserDict torch _dynamo error_on_graph_break False FailingUserDict keys BogonIter __init__ i = ord __iter__ __next__ i = ord z rtn = chr i i += rtn raise StopIteration BogonIter __getitem__ key raise Exc assertRaises Exc d update FailingUserDict d = _empty_mapping torch _dynamo error_on_graph_break False badseq object __iter__ __next__ raise Exc assertRaises Exc d update badseq assertRaises ValueError d update no test_fromkeys test_copy both os environ selves don t support test_get d = _empty_mapping assertTrue d get list other keys None assertEqual d get list other keys d = reference assertTrue d get list other keys None assertEqual d get list other keys assertEqual d get list inmapping keys list inmapping values assertEqual d get list inmapping keys list inmapping values assertRaises TypeError d get assertRaises TypeError d get None None None test_setdefault d = _empty_mapping assertRaises TypeError d setdefault test_popitem d = _empty_mapping assertRaises KeyError d popitem assertRaises TypeError d popitem test_pop d = _empty_mapping k v = list inmapping items d k = v assertRaises KeyError d pop list other keys assertEqual d pop k v assertEqual len d assertRaises KeyError d pop k TestMappingProtocol BasicTestMappingProtocol test_constructor BasicTestMappingProtocol test_constructor assertTrue _empty_mapping _empty_mapping assertEqual type test x= y= x y test_bool BasicTestMappingProtocol test_bool assertTrue _empty_mapping assertTrue _full_mapping x y assertTrue bool _empty_mapping False assertTrue bool _full_mapping x y True test_keys BasicTestMappingProtocol test_keys d = _empty_mapping assertEqual list d keys d = _full_mapping b k = d keys assertIn k assertIn b k assertNotIn c k test_values BasicTestMappingProtocol test_values d = _full_mapping assertEqual list d values test_items BasicTestMappingProtocol test_items d = _full_mapping assertEqual list d items test_contains d = _empty_mapping assertNotIn d assertTrue d assertTrue d d = _full_mapping b assertIn d assertIn b d assertNotIn c d assertRaises TypeError d __contains__ test_len BasicTestMappingProtocol test_len d = _full_mapping b assertEqual len d test_getitem BasicTestMappingProtocol test_getitem d = _full_mapping b assertEqual d assertEqual d b d c = d = assertEqual d c assertEqual d del d b assertEqual d c assertRaises TypeError d __getitem__ test_clear d = _full_mapping d clear assertEqual d assertRaises TypeError d clear None test_update BasicTestMappingProtocol test_update mapping argument d = _empty_mapping d update d update d update assertEqual d no argument d update assertEqual d keyword arguments d = _empty_mapping d update x= d update y= d update x= y= z= assertEqual d x y z item sequence d = _empty_mapping d update x y assertEqual d x y Both item sequence keyword arguments d = _empty_mapping d update x y x= y= assertEqual d x y iterator d = _full_mapping d update _full_mapping items assertEqual d torch _dynamo error_on_graph_break False SimpleUserDict __init__ d = keys d keys __getitem__ i d i d clear d update SimpleUserDict assertEqual d test_fromkeys assertEqual type test fromkeys abc None b None c None d = _empty_mapping assertTrue d fromkeys abc d assertEqual d fromkeys abc None b None c None assertEqual d fromkeys assertEqual d fromkeys g yield assertEqual d fromkeys g None assertRaises TypeError fromkeys torch _dynamo error_on_graph_break False dictlike type test pass assertEqual dictlike fromkeys None assertEqual dictlike fromkeys None assertTrue dictlike fromkeys __class__ dictlike assertTrue dictlike fromkeys __class__ dictlike assertTrue type dictlike fromkeys dictlike torch _dynamo error_on_graph_break False mydict type test __new__ cls collections UserDict ud = mydict fromkeys ab assertEqual ud None b None assertIsInstance ud collections UserDict assertRaises TypeError dict fromkeys torch _dynamo error_on_graph_break False Exc Exception pass baddict type test __init__ args kwargs raise Exc assertRaises Exc baddict fromkeys torch _dynamo error_on_graph_break False BadSeq object __iter__ __next__ raise Exc assertRaises Exc type test fromkeys BadSeq torch _dynamo error_on_graph_break False baddict type test __setitem__ key value raise Exc assertRaises Exc baddict fromkeys test_copy d = _full_mapping assertEqual d copy d = _empty_mapping assertEqual d copy d assertIsInstance d copy d __class__ assertRaises TypeError d copy None test_get BasicTestMappingProtocol test_get d = _empty_mapping assertTrue d get c None assertEqual d get c d = _full_mapping b assertTrue d get c None assertEqual d get c assertEqual d get assertEqual d get test_setdefault BasicTestMappingProtocol test_setdefault d = _empty_mapping assertTrue d setdefault key None d setdefault key assertTrue d setdefault key None d setdefault key append assertEqual d key d setdefault key append assertEqual len d key test_popitem BasicTestMappingProtocol test_popitem copymode - + - b has same structure + b copy log size range size = log size = _empty_mapping b = _empty_mapping i range size repr i = i copymode b repr i = i copymode b = copy i range size ka va = ta = popitem assertEqual va int ka kb vb = tb = b popitem assertEqual vb int kb assertTrue copymode ta = tb assertTrue assertTrue b test_pop BasicTestMappingProtocol test_pop Tests pop specified key d = _empty_mapping k v = abc assertEqual d pop k v v d k = v assertEqual d pop k v TestHashMappingProtocol TestMappingProtocol test_getitem TestMappingProtocol test_getitem torch _dynamo error_on_graph_break False Exc Exception pass BadEq object __eq__ other raise Exc __hash__ d = _empty_mapping d BadEq = assertRaises KeyError d __getitem__ torch _dynamo error_on_graph_break False BadHash object fail = False __hash__ fail raise Exc d = _empty_mapping x = BadHash d x = x fail = True assertRaises Exc d __getitem__ x test_fromkeys TestMappingProtocol test_fromkeys torch _dynamo error_on_graph_break False mydict type test __new__ cls collections UserDict ud = mydict fromkeys ab assertEqual ud None b None assertIsInstance ud collections UserDict test_pop TestMappingProtocol test_pop torch _dynamo error_on_graph_break False Exc Exception pass BadHash object fail = False __hash__ fail raise Exc d = _empty_mapping x = BadHash d x = x fail = True assertRaises Exc d pop x test_mutatingiteration d = _empty_mapping d = try count = i d d i+ = count = fail changing dict size during iteration doesn t raise Error count += except RuntimeError pass test_repr d = _empty_mapping assertEqual repr d d = assertEqual repr d d = _empty_mapping d = d assertEqual repr d torch _dynamo error_on_graph_break False Exc Exception pass BadRepr object __repr__ raise Exc d = _full_mapping BadRepr assertRaises Exc repr d test_repr_deep d = _empty_mapping i range get_c_recursion_limit + d = d d = _empty_mapping d = d assertRaises RecursionError repr d test_eq assertEqual _empty_mapping _empty_mapping assertEqual _full_mapping _full_mapping torch _dynamo error_on_graph_break False Exc Exception pass BadCmp object __eq__ other raise Exc __hash__ d = _full_mapping BadCmp d = _full_mapping assertRaises Exc lambda BadCmp == assertRaises Exc lambda d ==d test_setdefault TestMappingProtocol test_setdefault torch _dynamo error_on_graph_break False Exc Exception pass BadHash object fail = False __hash__ fail raise Exc d = _empty_mapping x = BadHash d x = x fail = True assertRaises Exc d setdefault x
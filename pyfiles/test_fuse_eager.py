Owner s oncall quantization copy torch torch ao nn intrinsic nni torch ao nn intrinsic qat nniqat torch ao nn intrinsic quantized nniq torch ao nn quantized nnq torch nn nn torch ao quantization convert default_qat_qconfig default_qconfig fuse_modules fuse_modules_qat prepare prepare_qat QConfig quantize quantize_qat torch testing _internal common_quantization ModelForConvTransposeBNFusion ModelForFusion ModelForFusionWithBias ModelForLinearBNFusion ModelWithSequentialFusion QuantizationTestCase SingleLayerLinearModel skipIfNoFBGEMM test_only_eval_fn test_only_train_fn torch testing _internal common_quantized override_quantized_engine supported_qengines skipIfNoFBGEMM TestFuseEager QuantizationTestCase test_fuse_module_train model = ModelForFusion default_qat_qconfig train Test step step fusion model = fuse_modules_qat model conv bn relu model = fuse_modules_qat model sub conv sub bn assertEqual type model conv nni ConvBnReLU d msg= Fused Conv + BN + Relu first layer assertEqual type model bn torch nn Identity msg= Fused Conv + BN + Relu skipped BN assertEqual type model relu torch nn Identity msg= Fused Conv + BN + Relu skipped Relu assertEqual type model sub conv nni ConvBn d msg= Fused submodule Conv + BN assertEqual type model sub bn torch nn Identity msg= Fused submodule Conv + BN skipped BN assertEqual type model sub conv torch nn Conv d msg= Non-fused submodule Conv assertEqual type model sub relu torch nn ReLU msg= Non-fused submodule ReLU model = prepare_qat model checkObservers model checkQAT model assertEqual type model conv nniqat ConvBnReLU d assertEqual type model bn nn Identity assertEqual type model relu nn Identity assertEqual type model sub conv nniqat ConvBn d assertEqual type model sub bn nn Identity assertEqual type model sub conv nn Conv d assertEqual type model sub relu nn ReLU checkQAT model test_only_train_fn model img_data_ d_train model = convert model checkQuantized model assertEqual type model conv nniq ConvReLU d assertEqual type model bn nn Identity assertEqual type model relu nn Identity assertEqual type model sub conv nnq Conv d assertEqual type model sub bn nn Identity assertEqual type model sub conv nn Conv d assertEqual type model sub relu nn ReLU test_only_eval_fn model img_data_ d checkNoQconfig model assertRaisesRegex RuntimeError Could run aten native_batch_norm arguments QuantizedCPU checkQuantized model model = ModelForFusion default_qat_qconfig train model = fuse_modules_qat model conv bn relu sub conv sub bn model = quantize_qat model test_only_train_fn img_data_ d_train assertRaisesRegex RuntimeError Could run aten native_batch_norm arguments QuantizedCPU checkQuantized model test_fuse_module_eval model = ModelForFusion default_qconfig model eval model = fuse_modules model conv bn relu conv bn relu conv relu bn relu sub conv sub bn assertEqual type model conv nni ConvReLU d msg= Fused Conv + BN + Relu first layer BN folded assertEqual type model conv nn Conv d msg= Fused Conv + BN + Relu Conv + folded BN only assertEqual type model conv nn ReLU msg= Fused Conv + BN + Relu second layer Relu only assertEqual type model bn nn Identity msg= Fused Conv + BN + Relu second layer Skipped BN assertEqual type model relu nn Identity msg= Fused Conv + BN + Relu second layer Skipped Relu assertEqual type model conv nni ConvReLU d msg= Fused Conv + BN + Relu first layer BN folded assertEqual type model bn nni BNReLU d msg= Fused BN + Relu first layer Relu folded assertEqual type model relu nn Identity msg= Fused BN + Relu second layer Skipped Relu assertEqual type model conv nn Conv d msg= Fused Conv + BN + Relu Conv + folded BN only assertEqual type model conv nn ReLU msg= Fused Conv + BN + Relu second layer Relu only assertEqual type model relu nn Identity msg= Fused Conv + BN + Relu second layer Skipped Relu assertEqual type model conv nni ConvReLU d msg= Fused Conv + Relu Conv d folded BN assertEqual type model conv nn Conv d msg= Fused Conv + Relu Conv d assertEqual type model conv nn ReLU msg= Fused Conv + Relu Conv d assertEqual type model bn nn Identity msg= Fused Conv + BN + Relu Conv d Skipped BN assertEqual type model sub conv nn Conv d msg= Fused submodule Conv + folded BN assertEqual type model sub bn nn Identity msg= Fused submodule skipped BN assertEqual type model sub conv nn Conv d msg= Non-fused submodule Conv assertEqual type model sub relu torch nn ReLU msg= Non-fused submodule ReLU model = prepare model checkObservers model test_only_eval_fn model img_data_ d model = convert model checkQuantized model assertEqual type model conv nniq ConvReLU d assertEqual type model conv nniq ConvReLU d assertEqual type model bn nn Identity assertEqual type model relu nn Identity assertEqual type model sub conv nnq Conv d assertEqual type model sub bn nn Identity assertEqual type model sub conv nn Conv d assertEqual type model sub relu nn ReLU assertEqual type model bn nniq BNReLU d test_only_eval_fn model img_data_ d checkNoQconfig model checkQuantized model model = ModelForFusion default_qconfig eval model = fuse_modules model conv bn relu conv relu bn relu sub conv sub bn conv bn relu model = quantize model test_only_eval_fn img_data_ d checkQuantized model test_fusion_sequential_model_train qengine supported_qengines override_quantized_engine qengine model = ModelWithSequentialFusion train model torch float fuse_modules_qat model conv relu features features features features features features features features features classifier classifier inplace=True assertEqual type model conv nni ConvReLU d msg= Fused Conv + Relu nni ConvReLU d assertEqual type model conv nn Conv d msg= Fused Conv + Relu Conv d assertEqual type model conv nn ReLU msg= Fused Conv + Relu Relu assertEqual type model relu nn Identity msg= Fused Conv + Relu Identity i range assertEqual type model features i nni ConvBnReLU d msg= Fused submodule Conv + folded BN assertEqual type model features i nn Identity msg= Fused submodule skipped BN assertEqual type model features i nn Identity msg= Non-fused submodule Conv assertEqual type model classifier nni LinearReLU assertEqual type model classifier nn Identity model qconfig = torch ao quantization get_default_qat_qconfig qengine prepare_qat model inplace=True checkObservers model model img_data_ d checkQAT model assertEqual type model conv nniqat ConvReLU d assertEqual type model relu nn Identity i range assertEqual type model features i nniqat ConvBnReLU d msg= Fused submodule Conv + folded BN assertEqual type model features i nn Identity msg= Fused submodule skipped BN assertEqual type model features i nn Identity msg= Non-fused submodule Conv assertEqual type model classifier nniqat LinearReLU assertEqual type model classifier nn Identity checkQAT model model img_data_ d convert model inplace=True model img_data_ d checkModelWithSequentialQuantized model test_fusion_sequential_model_eval qengine supported_qengines override_quantized_engine qengine model = ModelWithSequentialFusion eval model torch float fuse_modules model conv relu features features features features features features features features features classifier classifier inplace=True assertEqual type model conv nni ConvReLU d msg= Fused Conv + Relu nni ConvReLU d assertEqual type model conv nn Conv d msg= Fused Conv + Relu Conv d assertEqual type model conv nn ReLU msg= Fused Conv + Relu Relu assertEqual type model relu nn Identity msg= Fused Conv + Relu Identity i range assertEqual type model features i nni ConvReLU d msg= Fused submodule Conv + folded BN assertEqual type model features i nn Identity msg= Fused submodule skipped BN assertEqual type model features i nn Identity msg= Non-fused submodule Conv assertEqual type model classifier nni LinearReLU assertEqual type model classifier nn Identity model qconfig = torch ao quantization get_default_qconfig qengine prepare model inplace=True checkObservers model model img_data_ d convert model inplace=True model img_data_ d checkModelWithSequentialQuantized model checkModelWithSequentialQuantized model assertEqual type model conv nniq ConvReLU d assertEqual type model relu nn Identity i range assertEqual type model features i nniq ConvReLU d assertEqual type model features i nn Identity assertEqual type model features i nn Identity assertEqual type model classifier nniq LinearReLU assertEqual type model classifier nn Identity test_fusion_conv_with_bias qengine supported_qengines override_quantized_engine qengine model_orig = ModelForFusionWithBias train reference model model_ref = copy deepcopy model_orig output no fusion out_ref = model_ref img_data_ d fused model model_orig qconfig = QConfig activation=torch nn Identity weight=torch nn Identity model = fuse_modules_qat model_orig conv bn relu conv bn prep_model = prepare_qat model inplace=False output fusion no observers out_fused = prep_model img_data_ d assertEqual out_ref out_fused checkBN bn_ref bn assertEqual bn_ref weight bn weight assertEqual bn_ref bias bn bias assertEqual bn_ref running_mean bn running_mean assertEqual bn_ref running_var bn running_var checkBN model_ref bn prep_model conv bn checkBN model_ref bn prep_model conv bn model qconfig = torch ao quantization get_default_qconfig qengine prepare_qat model inplace=True model img_data_ d checkQAT model assertEqual type model conv nniqat ConvBnReLU d assertEqual type model bn nn Identity assertEqual type model relu nn Identity assertEqual type model conv nniqat ConvBn d assertEqual type model bn nn Identity checkQAT model test_fusion_linear_bn_eval model = ModelForLinearBNFusion train inp = torch randn inp = torch randn Get some interesting values into running mean variance model inp model eval golden = model inp model = fuse_modules model fc bn assertEqual type model bn nn Identity assertEqual golden model inp test_fusion_convtranspose_bn_eval model = ModelForConvTransposeBNFusion train inp = torch randn inp = torch randn Get some interesting values into running mean variance model inp model eval golden = model inp model = fuse_modules model conv bn conv bn conv bn assertEqual type model bn nn Identity assertEqual type model bn nn Identity assertEqual type model bn nn Identity assertEqual golden model inp test_fuse_function_customization dummy_model = SingleLayerLinearModel train dummy_model eval A custom fuse funct custom_fuse_func module is_qat add_fuser_mapping torch nn Identity dummy_model = fuse_modules dummy_model fc fuser_func=custom_fuse_func assertEqual type dummy_model fc nn Identity test_forward_hooks_preserved r Test case checks whether forward pre hooks first module post forward hooks last module modules list passed fusion function preserved e g before fusion nn Conv d pre forward hooks nn BatchNorm d nn ReLU post forward hooks after fusion nni ConvBnReLU d pre post hooks nn Identity nn Identity model = ModelForFusion default_qat_qconfig train counter = pre_forwards forwards fused = False fw_pre_hook fused_module_class h_module input fused assertEqual type h_module fused_module_class After fusion owner first module s forward pre hook fused module counter pre_forwards += fw_hook fused_module_class h_module input output fused assertEqual type h_module fused_module_class After fusion owner last module s forward hook fused module counter forwards += Registering two pre two post forward hooks thus expecting counter increment two each inference model conv register_forward_pre_hook lambda args fw_pre_hook nni ConvBnReLU d args model sub conv register_forward_pre_hook lambda args fw_pre_hook nni ConvBn d args model relu register_forward_hook lambda args fw_hook nni ConvBnReLU d args model sub bn register_forward_hook lambda args fw_hook nni ConvBn d args test_only_eval_fn model img_data_ d assertEqual counter pre_forwards len img_data_ d assertEqual counter forwards len img_data_ d model = fuse_modules_qat model conv bn relu model = fuse_modules_qat model sub conv sub bn fused = True before_fusion_pre_count = counter pre_forwards before_fusion_post_count = counter forwards test_only_eval_fn model img_data_ d assertEqual counter pre_forwards - before_fusion_pre_count len img_data_ d assertEqual counter forwards - before_fusion_post_count len img_data_ d test_fuse_modules_with_nested_hooks r Test case checks whether nested module sub-sub modules registered hooks can safely fused Safeguard issues similar https github com pytorch pytorch issues future myhook x qengine supported_qengines override_quantized_engine qengine model = ModelWithSequentialFusion eval sub_model model modules isinstance sub_model nn Sequential layer sub_model hasattr layer register_forward_hook layer register_forward_hook myhook fuse_modules model features features features inplace=True assertEqual type model features nni ConvReLU d msg= Fused submodule Conv + folded BN assertEqual type model features nn Identity msg= Fused submodule skipped BN assertEqual type model features nn Identity msg= Non-fused submodule Conv __name__ == __main__ raise RuntimeError This test file meant run directly use \n\n \tpython test test_quantization py TESTNAME\n\n instead
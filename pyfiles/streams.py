collections typing Any Callable Optional torch torch _dynamo variables dicts ConstDictVariable torch _dynamo variables lists TupleVariable torch fx Proxy graph_break_hints bytecode_transformation create_call_function exc TYPE_CHECKING unimplemented_v base VariableTracker constant ConstantVariable ctx_manager FxTracebackAnnotateVariable lazy LazyVariableTracker TYPE_CHECKING torch _dynamo symbolic_convert InstructionTranslator codegen PyCodegen torch _library custom_ops custom_op Tensor = torch Tensor custom_op streams fork mutates_args= fork_stream from_index int from_device torch device to_index int to_device torch device - None pass fork_stream register_fake _ from_index int from_device torch device to_index int to_device torch device - None pass custom_op streams join mutates_args= join_stream from_index int from_device torch device to_index int to_device torch device - None pass join_stream register_fake _ from_index int from_device torch device to_index int to_device torch device - None pass SymbolicStreamState Track currently entered stream any __init__ - None source CurrentStreamSource cur_stack list StreamVariable = torch accelerator is_available stream_var = LazyVariableTracker create torch accelerator current_stream source=CurrentStreamSource torch accelerator current_stream device cur_stack = stream_var type ignore list-item cur_stream_stack collections deque StreamVariable = collections deque cur_stack enter_stream stream StreamVariable - None cur_stream_stack append stream exit_stream - None cur_stream_stack pop cur_stream device Optional torch device = None - StreamVariable device None stream reversed cur_stream_stack stream device == device stream cur_stream_stack - in_stream_context - bool len cur_stream_stack StreamContextVariable FxTracebackAnnotateVariable This represents torch cuda StreamContext staticmethod create tx InstructionTranslator stream_to_enter StreamVariable kwargs dict str Any - StreamContextVariable StreamContextVariable stream_to_enter kwargs __init__ stream Optional StreamVariable kwargs dict str Any - None stream = stream super __init__ target_values= stream get_stream user_object_index initial_values=None kwargs enter tx InstructionTranslator args tuple Any - VariableTracker stream stream order arguments we entering target leaving initial stream tx symbolic_stream_state enter_stream get_stream super enter tx exit tx InstructionTranslator args tuple Any - VariableTracker stream stream order arguments we leaving target entering initial stream tx symbolic_stream_state exit_stream super exit tx args supports_graph_breaks - bool True get_stream - StreamVariable assert stream Stream context should have separate stream stream StreamVariable StreamContextVariable Represents device-agnostic torch Stream __init__ proxy Proxy value torch Stream kwargs Any - None Index into user object table used pass arbitrary objects graph user_object_index = kwargs pop user_obj_index None proxy None example_value proxy node meta assert proxy node meta example_value == value proxy = proxy value = value pyrefly ignore read-only device = value device pyrefly ignore read-only user_object_index = user_object_index super __init__ None kwargs python_type - type torch Stream call_method tx InstructionTranslator name str args list VariableTracker kwargs dict str VariableTracker - VariableTracker assert hasattr value name f no stream method found named name utils cmp_name_to_op_mapping proxy_args_kwargs builder wrap_fx_proxy_cls name wait_stream synchronize wait_event tx output create_proxy call_method name proxy_args_kwargs + args kwargs ConstantVariable None name == query wrap_fx_proxy_cls target_cls=ConstantVariable tx=tx proxy=tx output create_proxy call_method name proxy_args_kwargs + args kwargs name == record_event wrap_fx_proxy_cls target_cls=EventVariable tx=tx proxy=tx output create_proxy call_method name proxy_args_kwargs + args kwargs name cmp_name_to_op_mapping len args == kwargs guards GuardBuilder install_guard source install_guard source make_guard GuardBuilder EQUALS_MATCH NB Checking mutation necessary because we compare constant values other = args isinstance other StreamVariable ConstantVariable create NotImplemented other source assert source None install_guard source make_guard GuardBuilder EQUALS_MATCH ConstantVariable create cmp_name_to_op_mapping name value other value type ignore arg-type super call_method tx name args kwargs as_proxy - Proxy proxy module_name - str torch _C fn_name - str Stream reconstruct codegen PyCodegen - None If we got here stream fully subsumed graph - means input global assert source user_object_index None codegen add_push_null lambda codegen load_import_from torch _dynamo graph_bytecode_inputs __name__ get_external_object_by_index codegen append_output codegen create_load_const user_object_index codegen extend_output create_call_function False TODO mlazos evaluate we still need prefix = f _stream_ device name = codegen tx output install_global_by_id prefix value codegen append_output codegen create_load_global name add=True get_stream - StreamVariable staticmethod make_construct_in_graph_stream_fn args TupleVariable kwargs ConstDictVariable - Callable int PyCodegen None fn index int codegen PyCodegen - None codegen add_push_null lambda codegen load_import_from torch _dynamo utils __name__ build_stream codegen args codegen kwargs codegen extend_output create_call_function False fn EventVariable VariableTracker __init__ proxy Proxy value torch Event kwargs Any - None proxy None example_value proxy node meta assert proxy node meta example_value == value super __init__ kwargs proxy = proxy value = value call_method tx InstructionTranslator name str args list VariableTracker kwargs dict str VariableTracker - VariableTracker utils proxy_args_kwargs builder wrap_fx_proxy_cls name wait record synchronize tx output create_proxy call_method name proxy_args_kwargs + args kwargs ConstantVariable None name == query wrap_fx_proxy_cls target_cls=ConstantVariable tx=tx proxy=tx output create_proxy call_method name proxy_args_kwargs + args kwargs method_name = f type value __module__ type value __qualname__ name unimplemented_v gb_type= Unsupported event method context=str name explanation=f Dynamo doesn t support tracing method_name method f We currently support wait record synchronize query hints= graph_break_hints SUPPORTABLE as_proxy - Proxy proxy reconstruct codegen PyCodegen - None If we got here event fully subsumed graph - means input global assert source Similar stream handling we lift event into global then codegen bytecode load there prefix = _event name = codegen tx output install_global_by_id prefix value codegen append_output codegen create_load_global name add=True
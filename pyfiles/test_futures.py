mypy allow-untyped-defs Owner s module unknown threading time torch unittest torch futures Future torch testing _internal common_utils IS_WINDOWS TestCase TemporaryFileName run_tests typing TypeVar T = TypeVar T add_one fut fut wait + TestFuture TestCase test_set_exception - None This test ensure errors can propagate across futures error_msg = Intentional Value Error value_error = ValueError error_msg f = Future T type ignore valid-type Set exception f set_exception value_error Exception should throw wait assertRaisesRegex ValueError Intentional f wait Exception should also throw value f = Future T type ignore valid-type f set_exception value_error assertRaisesRegex ValueError Intentional f value cb fut fut value f = Future T type ignore valid-type f set_exception value_error assertRaisesRegex RuntimeError Got following error cb_fut = f then cb cb_fut wait test_set_exception_multithreading - None Ensure errors can propagate when one thread waits future result other sets error error_msg = Intentional Value Error value_error = ValueError error_msg wait_future f assertRaisesRegex ValueError Intentional f wait f = Future T type ignore valid-type t = threading Thread target=wait_future args= f t start f set_exception value_error t join cb fut fut value then_future f fut = f then cb assertRaisesRegex RuntimeError Got following error fut wait f = Future T type ignore valid-type t = threading Thread target=then_future args= f t start f set_exception value_error t join test_done - None f = Future torch Tensor assertFalse f done f set_result torch ones assertTrue f done test_done_exception - None err_msg = Intentional Value Error raise_exception unused_future raise RuntimeError err_msg f = Future torch Tensor assertFalse f done f set_result torch ones assertTrue f done f = f then raise_exception assertTrue f done assertRaisesRegex RuntimeError err_msg f wait test_wait - None f = Future torch Tensor f set_result torch ones assertEqual f wait torch ones test_wait_multi_thread - None slow_set_future fut value time sleep fut set_result value f = Future torch Tensor t = threading Thread target=slow_set_future args= f torch ones t start assertEqual f wait torch ones t join test_mark_future_twice - None fut = Future int fut set_result assertRaisesRegex RuntimeError Future can only marked completed once fut set_result test_pickle_future fut = Future int errMsg = Can pickle torch futures Future TemporaryFileName fname assertRaisesRegex RuntimeError errMsg torch save fut fname test_then fut = Future torch Tensor then_fut = fut then lambda x x wait + fut set_result torch ones assertEqual fut wait torch ones assertEqual then_fut wait torch ones + test_chained_then fut = Future torch Tensor futs = last_fut = fut _ range last_fut = last_fut then add_one futs append last_fut fut set_result torch ones i range len futs assertEqual futs i wait torch ones + i + _test_then_error cb errMsg fut = Future int then_fut = fut then cb fut set_result assertEqual fut wait assertRaisesRegex RuntimeError errMsg then_fut wait test_then_wrong_arg wrong_arg tensor tensor + _test_then_error wrong_arg unsupported operand type Future int test_then_no_arg no_arg True _test_then_error no_arg takes positional arguments given test_then_raise raise_value_error fut raise ValueError Expected error _test_then_error raise_value_error Expected error test_add_done_callback_simple callback_result = False callback fut nonlocal callback_result fut wait callback_result = True fut = Future torch Tensor fut add_done_callback callback assertFalse callback_result fut set_result torch ones assertEqual fut wait torch ones assertTrue callback_result test_add_done_callback_maintains_callback_order callback_result = callback_set fut nonlocal callback_result fut wait callback_result = callback_set fut nonlocal callback_result fut wait callback_result = fut = Future torch Tensor fut add_done_callback callback_set fut add_done_callback callback_set fut set_result torch ones assertEqual fut wait torch ones set called last callback_result = assertEqual callback_result _test_add_done_callback_error_ignored cb fut = Future int fut add_done_callback cb fut set_result error msg logged stdout assertEqual fut wait test_add_done_callback_error_is_ignored raise_value_error fut raise ValueError Expected error _test_add_done_callback_error_ignored raise_value_error test_add_done_callback_no_arg_error_is_ignored no_arg True Adding another level function indirection here purpose Otherwise mypy will pick up no_arg having incompatible type fail CI _test_add_done_callback_error_ignored no_arg test_interleaving_then_and_add_done_callback_maintains_callback_order callback_result = callback_set fut nonlocal callback_result fut wait callback_result = callback_set fut nonlocal callback_result fut wait callback_result = callback_then fut nonlocal callback_result fut wait + callback_result fut = Future torch Tensor fut add_done_callback callback_set then_fut = fut then callback_then fut add_done_callback callback_set fut set_result torch ones assertEqual fut wait torch ones then_fut s callback called callback_result = assertEqual then_fut wait torch ones + set called last callback_result = assertEqual callback_result test_interleaving_then_and_add_done_callback_propagates_error raise_value_error fut raise ValueError Expected error fut = Future torch Tensor then_fut = fut then raise_value_error fut add_done_callback raise_value_error fut set_result torch ones error add_done_callback s callback swallowed error then s callback assertEqual fut wait torch ones assertRaisesRegex RuntimeError Expected error then_fut wait test_collect_all fut = Future int fut = Future int fut_all = torch futures collect_all fut fut slow_in_thread fut value time sleep fut set_result value t = threading Thread target=slow_in_thread args= fut fut set_result t start res = fut_all wait assertEqual res wait assertEqual res wait t join unittest skipIf IS_WINDOWS TODO need fix testcase Windows test_wait_all fut = Future int fut = Future int No error version fut set_result fut set_result res = torch futures wait_all fut fut print res assertEqual res Version exception raise_in_fut fut raise ValueError Expected error fut = fut then raise_in_fut assertRaisesRegex RuntimeError Expected error torch futures wait_all fut fut test_wait_none fut = Future int assertRaisesRegex RuntimeError Future can t None torch jit wait None assertRaisesRegex RuntimeError Future can t None torch futures wait_all None type ignore arg-type assertRaisesRegex RuntimeError Future can t None torch futures collect_all fut None type ignore arg-type __name__ == __main__ run_tests
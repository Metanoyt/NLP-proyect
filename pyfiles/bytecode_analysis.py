This module provides utilities analyzing optimizing Python bytecode Key functionality includes - Dead code elimination - Jump instruction optimization - Stack size analysis verification - Live variable analysis - Line number propagation cleanup - Exception table handling Python + The utilities module used analyze transform bytecode better performance while maintaining correct semantics bisect dataclasses dis itertools sys typing Any TYPE_CHECKING Union TYPE_CHECKING TODO lucaskabela consider moving Instruction into file refactoring callsite way we don t have guard bytecode_transformation Instruction TERMINAL_OPCODES = dis opmap RETURN_VALUE dis opmap JUMP_FORWARD dis opmap RAISE_VARARGS TODO jansel double check exception handling TERMINAL_OPCODES add dis opmap RERAISE sys version_info = TERMINAL_OPCODES add dis opmap JUMP_BACKWARD TERMINAL_OPCODES add dis opmap JUMP_FORWARD TERMINAL_OPCODES add dis opmap JUMP_ABSOLUTE pyrefly ignore unsupported-operation = sys version_info TERMINAL_OPCODES add dis opmap RETURN_CONST sys version_info = TERMINAL_OPCODES add dis opmap JUMP_BACKWARD_NO_INTERRUPT JUMP_OPCODES = set dis hasjrel + dis hasjabs JUMP_OPNAMES = dis opname opcode opcode JUMP_OPCODES HASLOCAL = set dis haslocal HASFREE = set dis hasfree stack_effect = dis stack_effect get_indexof insts list Instruction - dict Instruction int Get mapping instruction memory address index instruction list Additionally checks each instruction only appears once list indexof = i inst enumerate insts assert inst indexof indexof inst = i indexof remove_dead_code instructions list Instruction - list Instruction Dead code elimination indexof = get_indexof instructions live_code = set find_live_code start int - None i range start len instructions i live_code live_code add i inst = instructions i inst exn_tab_entry find_live_code indexof inst exn_tab_entry target inst opcode JUMP_OPCODES assert inst target None find_live_code indexof inst target inst opcode TERMINAL_OPCODES find_live_code change exception table entries start end instructions dead assumes exception table entries have been propagated e g bytecode_transformation propagate_inst_exn_table_entries instructions exn_tab_entry lies within its start end sys version_info = live_idx = sorted live_code i inst enumerate instructions i live_code inst exn_tab_entry find leftmost live instruction = start start_idx = bisect bisect_left live_idx indexof inst exn_tab_entry start assert start_idx len live_idx find rightmost live instruction = end end_idx = bisect bisect_right live_idx indexof inst exn_tab_entry end - assert end_idx = assert live_idx start_idx = i = live_idx end_idx inst exn_tab_entry start = instructions live_idx start_idx inst exn_tab_entry end = instructions live_idx end_idx inst i inst enumerate instructions i live_code remove_pointless_jumps instructions list Instruction - list Instruction Eliminate jumps next instruction pointless_jumps = id b itertools pairwise instructions opname == JUMP_ABSOLUTE target b inst inst instructions id inst pointless_jumps propagate_line_nums instructions list Instruction - None Ensure every instruction has line number set case some removed cur_line_no = None populate_line_num inst Instruction - None nonlocal cur_line_no inst starts_line cur_line_no = inst starts_line inst starts_line = cur_line_no inst instructions populate_line_num inst remove_extra_line_nums instructions list Instruction - None Remove extra starts line properties before packing bytecode cur_line_no = None remove_line_num inst Instruction - None nonlocal cur_line_no inst starts_line None inst starts_line == cur_line_no inst starts_line = None cur_line_no = inst starts_line inst instructions remove_line_num inst dataclasses dataclass ReadsWrites reads set Any writes set Any visited set Any livevars_analysis instructions list Instruction instruction Instruction - set Any indexof = get_indexof instructions must = ReadsWrites set set set may = ReadsWrites set set set walk state ReadsWrites start int - None start state visited state visited add start i range start len instructions inst = instructions i inst opcode HASLOCAL inst opcode HASFREE LOAD inst opname DELETE inst opname inst argval must writes state reads add inst argval STORE inst opname state writes add inst argval inst opname == MAKE_CELL pass raise NotImplementedError f unhandled inst opname inst exn_tab_entry walk may indexof inst exn_tab_entry target inst opcode JUMP_OPCODES assert inst target None walk may indexof inst target state = may inst opcode TERMINAL_OPCODES walk must indexof instruction must reads &#124; may reads dataclasses dataclass FixedPointBox value bool = True dataclasses dataclass StackSize low Union int float high Union int float fixed_point FixedPointBox zero - None low = high = fixed_point value = False offset_of other StackSize n int - None prior = low high low = min low other low + n high = max high other high + n low high = prior fixed_point value = False exn_tab_jump depth int - None prior = low high low = min low depth high = max high depth low high = prior fixed_point value = False stacksize_analysis instructions list Instruction - Union int float assert instructions fixed_point = FixedPointBox stack_sizes = inst StackSize float inf float -inf fixed_point inst instructions stack_sizes instructions zero _ range fixed_point value break fixed_point value = True inst next_inst zip instructions instructions + None stack_size = stack_sizes inst inst opcode TERMINAL_OPCODES assert next_inst None f missing next inst inst eff = stack_effect inst opcode inst arg jump=False stack_sizes next_inst offset_of stack_size eff inst opcode JUMP_OPCODES assert inst target None f missing target inst stack_sizes inst target offset_of stack_size stack_effect inst opcode inst arg jump=True inst exn_tab_entry see https github com python cpython blob Objects exception_handling_notes txt why depth computed way depth = inst exn_tab_entry depth + int inst exn_tab_entry lasti + stack_sizes inst exn_tab_entry target exn_tab_jump depth low = min x low x stack_sizes values high = max x high x stack_sizes values assert fixed_point value failed reach fixed point assert low = high
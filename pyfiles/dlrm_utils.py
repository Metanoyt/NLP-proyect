mypy allow-untyped-defs os zipfile numpy np type ignore dlrm_data_pytorch type ignore collate_wrapper_criteo_offset CriteoDataset dlrm_s_pytorch DLRM_Net type ignore torch SparseDLRM DLRM_Net The SparseDLRM model wrapper around DLRM_Net model tries use torch sparse tensors features obtained after ` ` ` interact_features ` ` ` call The idea do simple torch mm weight matrix first linear layer top layer __init__ args super __init__ args forward dense_x lS_o lS_i pyrefly ignore missing-attribute x = apply_mlp dense_x bot_l dense features pyrefly ignore missing-attribute ly = apply_emb lS_o lS_i emb_l v_W_l apply embedding bag pyrefly ignore missing-attribute z = interact_features x ly z = z to_sparse_coo pyrefly ignore missing-attribute z = torch mm z top_l weight T add top_l bias pyrefly ignore missing-attribute layer top_l z = layer z z get_valid_name name Replaces _ names invalid data sparsifier name replace _ get_dlrm_model sparse_dlrm=False Obtain dlrm model The configs specified based script bench dlrm_s_criteo_kaggle sh The same config used train model benchmarking data sparsifier dlrm_model_config = m_spa ln_emb np array dtype=np int ln_bot np array ln_top np array arch_interaction_op dot arch_interaction_itself False sigmoid_bot - sigmoid_top sync_dense_params True loss_threshold ndevices qr_flag False qr_operation mult qr_collisions qr_threshold md_flag False md_threshold weighted_pooling None loss_function bce sparse_dlrm dlrm_model = SparseDLRM dlrm_model_config dlrm_model = DLRM_Net dlrm_model_config dlrm_model dlrm_wrap X lS_o lS_i device ndevices= Rewritten simpler version ` ` ` dlrm_wrap ` ` ` found dlrm_s_pytorch py This function simply moves input tensors into device without forward pass ndevices == lS_i = S_i device S_i lS_i isinstance lS_i list lS_i device lS_o = S_o device S_o lS_o isinstance lS_o list lS_o device X device lS_o lS_i make_test_data_loader raw_data_file_path processed_data_file Function create dataset dataloaders test dataset Rewritten simpler version ` ` ` make_criteo_and_loaders ` ` ` dlrm_data_pytorch py makes test dataset dataloaders only kaggle criteo dataset test_data = CriteoDataset kaggle - total test raw_data_file_path processed_data_file False False test_loader = torch utils data DataLoader test_data batch_size= shuffle=False num_workers= collate_fn=collate_wrapper_criteo_offset pin_memory=False drop_last=False test_loader fetch_model model_path device sparse_dlrm=False This function unzips zipped model checkpoint zipped returns model object Args model_path str path pointing zipped raw model checkpoint file dumped evaluate disk savings device torch device device which model needs loaded zipfile is_zipfile model_path zipfile ZipFile model_path r zipfile ZIP_DEFLATED zip_ref zip_ref extractall os path dirname model_path unzip_path = model_path replace zip ckpt unzip_path = model_path model = get_dlrm_model sparse_dlrm=sparse_dlrm model load_state_dict torch load unzip_path map_location=device model = model device model eval If there zip file clean up unzipped files zipfile is_zipfile model_path os remove unzip_path model
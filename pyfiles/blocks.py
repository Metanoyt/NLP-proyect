__future__ annotations token typing NamedTuple TYPE_CHECKING EMPTY_TOKENS ParseError block Block TYPE_CHECKING collections abc Sequence tokenize TokenInfo BlocksResult NamedTuple blocks list Block errors dict str str blocks tokens Sequence TokenInfo - BlocksResult blocks list Block = indent_to_dedent = _make_indent_dict tokens errors dict str str = starts_block t TokenInfo - bool t type == token NAME t string = i i t enumerate tokens starts_block t blocks = _make_block tokens i indent_to_dedent errors i i parent enumerate blocks j range i + len blocks parent contains child = blocks j child parent = i parent children append j break i b enumerate blocks b index = i parents = b while p = parents - parent None parents append blocks p parents = parents b is_local = all p is_class p parents b is_method = b is_class bool parents parents is_class _add_full_names blocks b b blocks b parent None BlocksResult blocks errors _make_indent_dict tokens Sequence TokenInfo - dict int int dedents = dict int int stack = list int i t enumerate tokens t type == token INDENT stack append i t type == token DEDENT dedents stack pop = i dedents _docstring tokens Sequence TokenInfo start int - str i range start + len tokens tk = tokens i tk type == token STRING tk string tk type EMPTY_TOKENS _add_full_names blocks Sequence Block children Sequence Block prefix str = - None Would trivial except there can duplicate names any level dupes dict str list Block = b children dupes setdefault b name append b dl dupes values i b enumerate dl suffix = f i + len dl b full_name = prefix + b name + suffix b children kids = blocks i i b children _add_full_names blocks kids b full_name + _make_block tokens Sequence TokenInfo begin int indent_to_dedent dict int int errors dict str str - Block next_token start int token_type int error str - int i range start len tokens tokens i type == token_type i raise ParseError tokens - error t = tokens begin category = Block Category t string upper indent = - dedent = - docstring = name = found try ni = next_token begin + token NAME Definition no name name = tokens ni string indent = next_token ni + token INDENT Definition no indent dedent = indent_to_dedent indent docstring = _docstring tokens indent except ParseError e errors t line = join e args Block begin=begin category=category dedent=dedent docstring=docstring indent=indent name=name tokens=tokens
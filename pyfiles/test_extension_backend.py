Owner s module inductor os sys unittest torch torch _dynamo torch utils cpp_extension torch _C FileCheck torch testing _internal common_utils skipIfWindows try extension_backends cpp extension_codegen_backend manual=fbcode caffe test inductor extension_backends extension_codegen_backend noqa B ExtensionCppWrapperCodegen ExtensionScheduling ExtensionWrapperCodegen except ImportError extension_backends cpp extension_codegen_backend ExtensionCppWrapperCodegen ExtensionScheduling ExtensionWrapperCodegen filelock FileLock Timeout torch _inductor config config torch _inductor cpu_vec_isa metrics torch _inductor codegen cpp_utils torch _inductor codegen common get_scheduling_for_device get_wrapper_codegen_for_device register_backend_for_device torch testing _internal common_utils IS_FBCODE IS_MACOS xfailIfS X try try test_torchinductor except ImportError test_torchinductor manual=fbcode caffe test inductor test_inductor-library except unittest SkipTest __name__ == __main__ sys exit raise run_and_get_cpp_code = test_torchinductor run_and_get_cpp_code TestCase = test_torchinductor TestCase xfailIfS X BaseExtensionBackendTests TestCase module = None Use lock file so only one test can build extension time lock_file = extension_device lock lock = FileLock lock_file classmethod setUpClass cls super setUpClass try cls lock acquire timeout= except Timeout This shouldn t happen still attempt build extension anyway pass Build Extension torch testing _internal common_utils remove_cpp_extensions_build_root source_file_path = os path dirname os path abspath __file__ source_file = os path join source_file_path extension_backends cpp extension_device cpp cls module = torch utils cpp_extension load name= extension_device sources= str source_file extra_cflags= -g verbose=True classmethod tearDownClass cls cls _stack close super tearDownClass torch testing _internal common_utils remove_cpp_extensions_build_root cls lock release os path exists cls lock_file os remove cls lock_file setUp torch _dynamo reset super setUp cpp extensions use relative paths Those paths relative file so we ll change working directory temporarily old_working_dir = os getcwd os chdir os path dirname os path abspath __file__ assert module None tearDown super tearDown torch _dynamo reset working directory see setUp os chdir old_working_dir unittest skipIf IS_FBCODE cpp_extension doesn t work fbcode right now ExtensionBackendTests BaseExtensionBackendTests skipIfWindows test_open_device_registration torch utils rename_privateuse _backend extension_device torch _register_device_module extension_device module register_backend_for_device extension_device ExtensionScheduling ExtensionWrapperCodegen ExtensionCppWrapperCodegen assertTrue get_scheduling_for_device extension_device == ExtensionScheduling assertTrue get_wrapper_codegen_for_device extension_device == ExtensionWrapperCodegen assertTrue get_wrapper_codegen_for_device extension_device True == ExtensionCppWrapperCodegen assertFalse module custom_op_called device = module custom_device x = torch empty device=device fill_ assertTrue module custom_op_called y = torch empty device=device fill_ z = torch empty device=device fill_ ref = torch empty fill_ assertTrue x device == device assertTrue y device == device assertTrue z device == device fn b c b + c cpp_utils DEVICE_TO_ATEN extension_device = kPrivateUse cpp_wrapper_flag True False config patch cpp_wrapper cpp_wrapper_flag metrics reset opt_fn = torch compile fn _ code = run_and_get_cpp_code opt_fn x y z cpu_vec_isa valid_vec_isa_list os getenv ATEN_CPU_CAPABILITY = default load_expr = loadu load_expr = = in_ptr static_cast long i FileCheck check void check load_expr check extension_device run code opt_fn x y z res = opt_fn x y z assertEqual ref res device= cpu __name__ == __main__ torch _inductor test_case run_tests torch testing _internal inductor_utils HAS_CPU cpp_extension doesn t work fbcode right now HAS_CPU IS_MACOS IS_FBCODE run_tests needs= filelock
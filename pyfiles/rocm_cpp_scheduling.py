mypy allow-untyped-defs logging collections abc Sequence typing cast config codecache code_hash get_path scheduler BaseSchedulerNode BaseScheduling SchedulerNode utils get_fused_kernel_name get_kernel_metadata sympy_product virtualized V common IndentedBuffer rocm_template_buffer ROCmTemplateBuffer log = logging getLogger __name__ ROCmCPPScheduling BaseScheduling Partial Scheduling implementation ROCm C++ Kernels This intended used combination TritonScheduling delegated CUDACombinedScheduling It handles fusion decisions ROCm C++ specific template code generation group_fn sizes tuple V graph sizevars simplify sympy_product s s sizes staticmethod is_rocm_cpp_template node BaseSchedulerNode - bool isinstance node SchedulerNode isinstance node node ROCmTemplateBuffer can_fuse_vertical node BaseSchedulerNode node BaseSchedulerNode - bool False define_kernel src_code str node_schedule - str wrapper = V graph wrapper_code src_code wrapper src_to_kernel kernel_name = wrapper src_to_kernel src_code fused_name = get_fused_kernel_name node_schedule config triton descriptive_names config triton descriptive_names kernel_name = _ join rocm fused_name wrapper next_kernel_suffix use original src_code key wrapper src_to_kernel src_code = kernel_name src_code = src_code replace KERNEL_NAME kernel_name _ _ kernel_path = get_path code_hash src_code py compile_wrapper = IndentedBuffer compile_wrapper writeline async_compile rocm r compile_wrapper splice src_code strip=True compile_wrapper writeline f so aot_compile= str V graph aot_mode metadata_comment = f kernel path kernel_path origins detailed_origins = get_kernel_metadata node_schedule wrapper metadata_comment += \n + origins + \n + detailed_origins wrapper define_kernel kernel_name compile_wrapper getvalue metadata_comment kernel_name codegen_template template_node BaseSchedulerNode epilogue_nodes Sequence BaseSchedulerNode prologue_nodes Sequence BaseSchedulerNode Codegen ROCm template possibly fused epilogues assert is_rocm_cpp_template template_node Template node passed ROCmScheduler codegen_template must SchedulerNode wraps ROCmTemplateBuffer template_node = cast SchedulerNode template_node _ _numel rnumel = template_node group assert rnumel == ctb ROCmTemplateBuffer = cast ROCmTemplateBuffer template_node node kernel render = ctb make_kernel_render ctb type ignore misc kernel template_node mark_run src_code = render V set_kernel_handler kernel node_schedule = template_node kernel_name = define_kernel src_code node_schedule codegen_comment node_schedule kernel_name kernel call_kernel kernel_name ctb V graph removed_buffers &#124; = kernel removed_buffers free_buffers_in_scheduler
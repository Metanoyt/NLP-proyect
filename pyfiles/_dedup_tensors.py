Copyright c Meta Platforms Inc affiliates dataclasses logging typing TYPE_CHECKING torch distributed checkpoint planner SavePlan TYPE_CHECKING torch distributed checkpoint metadata MetadataIndex __all__ = dedup_tensors init_logger - logging Logger logger = logging getLogger __name__ level = logging INFO logger setLevel level console = logging StreamHandler formatter = logging Formatter asctime s filename s lineno s levelname s p processName s t threadName s message s console setFormatter formatter console setLevel level logger addHandler console logger propagate = False logger logger = init_logger TODO add docstring dedup_tensors dedup_tensors all_plans list SavePlan - list SavePlan all_plans = list all_plans key_to_plan dict MetadataIndex list int = plan_idx plan enumerate all_plans write_item plan items key_to_plan setdefault write_item index append plan_idx replicated_items = k v k v key_to_plan items len v Remove duplicates always keeping first entry Compute per-rank remove set plan_to_keys dict int list MetadataIndex = key plans replicated_items items plan_idx plans plan_to_keys setdefault plan_idx append key len plan_to_keys logger info Duplicate keys remove s plan_to_keys plan_idx keys plan_to_keys items key_set = set keys rewrite items remove elements new_items = write_item write_item all_plans plan_idx items write_item index key_set all_plans plan_idx = dataclasses replace all_plans plan_idx items=new_items all_plans
Owner s oncall jit ruff noqa F os sys typing Any List torch torch nn nn torch Tensor torch testing _internal common_utils raise_on_run_directly torch testing _internal jit_utils JitTestCase make_global Make helper files test importable pytorch_test_dir = os path dirname os path dirname os path realpath __file__ sys path append pytorch_test_dir OrigModule nn Module one inp Tensor inp Tensor - Tensor inp + inp + two input Tensor - Tensor input + forward input Tensor - Tensor input + one input input + NewModule nn Module one inp Tensor inp Tensor - Tensor inp inp + forward input Tensor - Tensor one input input + TestModuleInterface JitTestCase test_not_submodule_interface_call torch jit interface ModuleInterface nn Module one inp Tensor inp Tensor - Tensor pass TestNotModuleInterfaceCall nn Module proxy_mod ModuleInterface __init__ - None super __init__ proxy_mod = OrigModule forward input Tensor - Tensor proxy_mod two input assertRaisesRegexWithHighlight RuntimeError object has no attribute method proxy_mod two torch jit script TestNotModuleInterfaceCall test_module_interface torch jit interface OneTwoModule nn Module one x Tensor y Tensor - Tensor pass two x Tensor - Tensor pass forward x Tensor - Tensor pass torch jit interface OneTwoClass one x Tensor y Tensor - Tensor pass two x Tensor - Tensor pass FooMod nn Module one x Tensor y Tensor - Tensor x + y two x Tensor - Tensor x forward x Tensor - Tensor one two x x BarMod nn Module one x Tensor y Tensor - Tensor x y two x Tensor - Tensor x forward x Tensor - Tensor two one x x torch jit export forward x Tensor - Tensor two one x x + make_global OneTwoModule OneTwoClass use_module_interface mod_list List OneTwoModule x torch Tensor mod_list forward x + mod_list forward x use_class_interface mod_list List OneTwoClass x Tensor - Tensor mod_list two x + mod_list one x x scripted_foo_mod = torch jit script FooMod scripted_bar_mod = torch jit script BarMod checkScript use_module_interface scripted_foo_mod scripted_bar_mod torch rand checkScript use_class_interface scripted_foo_mod scripted_bar_mod torch rand call_module_interface_on_other_method mod_interface OneTwoModule x Tensor - Tensor mod_interface forward x ensure error out when we call module method other than interface specified assertRaisesRegexWithHighlight RuntimeError object has no attribute method mod_interface forward checkScript call_module_interface_on_other_method scripted_bar_mod torch rand test_module_doc_string torch jit interface TestInterface nn Module one inp inp type Tensor Tensor - Tensor pass forward input type Tensor - Tensor r stuff r stuff pass noqa PIE r stuff TestModule nn Module proxy_mod TestInterface __init__ - None super __init__ proxy_mod = OrigModule forward input type Tensor - Tensor proxy_mod forward input input = torch randn checkModule TestModule input test_module_interface_subtype torch jit interface OneTwoModule nn Module one x Tensor y Tensor - Tensor pass two x Tensor - Tensor pass forward x Tensor - Tensor pass make_global OneTwoModule torch jit script as_module_interface x OneTwoModule - OneTwoModule x torch jit script Foo one x Tensor y Tensor - Tensor x + y two x Tensor - Tensor x forward x Tensor - Tensor one two x x check object subtype module interface assertRaisesRegex RuntimeError ScriptModule can subtype module interface as_module_interface Foo WrongMod nn Module two x int - int x forward x Tensor - Tensor x + torch randn two scripted_wrong_mod = torch jit script WrongMod wrong module compatible module interface assertRaisesRegex RuntimeError compatible interface as_module_interface scripted_wrong_mod Check interface implementations can contravariant argument types covariant type torch jit interface TensorToAny nn Module forward input torch Tensor - Any pass make_global TensorToAny torch jit script as_tensor_to_any x TensorToAny - TensorToAny x torch jit interface AnyToAny nn Module forward input Any - Any pass make_global AnyToAny torch jit script as_any_to_any x AnyToAny - AnyToAny x TensorToAnyImplA nn Module forward input Any - Any input TensorToAnyImplB nn Module forward input Any - torch Tensor torch tensor AnyToAnyImpl nn Module forward input Any - torch Tensor torch tensor as_tensor_to_any torch jit script TensorToAnyImplA as_tensor_to_any torch jit script TensorToAnyImplB as_any_to_any torch jit script AnyToAnyImpl test_module_interface_inheritance assertRaisesRegex RuntimeError does support inheritance yet Please directly torch jit interface InheritMod nn ReLU three x Tensor - Tensor x test_module_swap torch jit interface ModuleInterface nn Module one inp Tensor inp Tensor - Tensor pass forward input Tensor - Tensor pass TestModule nn Module proxy_mod ModuleInterface __init__ - None super __init__ proxy_mod = OrigModule forward input Tensor - Tensor proxy_mod forward input scripted_mod = torch jit script TestModule input = torch randn assertEqual scripted_mod input input + module swap module have same interface scripted_mod proxy_mod = torch jit script NewModule assertEqual scripted_mod input input input + + module swap non-scripted module should throw error assertRaisesRegex RuntimeError ScriptModule non-scripted module scripted_mod proxy_mod = NewModule test_module_swap_wrong_module torch jit interface ModuleInterface nn Module one inp Tensor inp Tensor - Tensor pass forward input Tensor - Tensor pass NewModuleWrong nn Module forward input int - int input + TestModule nn Module proxy_mod ModuleInterface __init__ - None super __init__ proxy_mod = OrigModule forward input Tensor - Tensor proxy_mod forward input scripted_mod = torch jit script TestModule module swap in-compatible interface assertRaisesRegex RuntimeError compatible interface scripted_mod proxy_mod = torch jit script NewModuleWrong test_module_swap_no_lazy_compile torch jit interface ModuleInterface nn Module one inp Tensor inp Tensor - Tensor pass forward input Tensor - Tensor pass TestModule nn Module proxy_mod ModuleInterface __init__ - None super __init__ proxy_mod = OrigModule forward input Tensor - Tensor proxy_mod forward input NewModuleMethodNotLazyCompile nn Module one inp Tensor inp Tensor - Tensor inp inp + forward input Tensor - Tensor input + scripted_mod = torch jit script TestModule module swap module have same interface method get lazily compiled forward user need export explicitly swap work assertRaisesRegex RuntimeError compatible interface scripted_mod proxy_mod = torch jit script NewModuleMethodNotLazyCompile NewModuleMethodManualExport nn Module torch jit export one inp Tensor inp Tensor - Tensor inp inp + forward input Tensor - Tensor input + scripted_mod proxy_mod = torch jit script NewModuleMethodManualExport input = torch randn assertEqual scripted_mod input input + test_module_swap_no_module_interface test module swapping no module interface TestNoModuleInterface nn Module __init__ - None super __init__ proxy_mod = OrigModule forward input Tensor - Tensor proxy_mod input scripted_no_module_interface = torch jit script TestNoModuleInterface proxy mod swapped new ScriptModule share same JIT type should succeed scripted_no_module_interface proxy_mod = torch jit script OrigModule proxy_mod neither module interface have same JIT type should fail assertRaisesRegex RuntimeError r Expected value type __torch__ jit test_module_interface OrigModule \ \ + r field proxy_mod found __torch__ jit test_module_interface NewModule \ \ scripted_no_module_interface proxy_mod = torch jit script NewModule test_script_module_as_interface_swap torch jit interface ModuleInterface nn Module one inp Tensor inp Tensor - Tensor pass forward input Tensor - Tensor pass OrigScriptModule torch jit ScriptModule torch jit script_method one inp Tensor inp Tensor - Tensor inp + inp + torch jit script_method forward input Tensor - Tensor input + one input input + NewScriptModule torch jit ScriptModule torch jit script_method one inp Tensor inp Tensor - Tensor inp inp + torch jit script_method forward input Tensor - Tensor one input input + TestNNModuleWithScriptModule nn Module proxy_mod ModuleInterface __init__ - None super __init__ proxy_mod = OrigScriptModule forward input Tensor - Tensor proxy_mod forward input input = torch randn scripted_mod = torch jit script TestNNModuleWithScriptModule assertEqual scripted_mod input input + scripted_mod proxy_mod = NewScriptModule assertEqual scripted_mod input input input + + The call forward proxy_mod cannot inlined Making sure Freezing throwing error now test_freeze_module_with_interface SubModule torch nn Module __init__ - None super __init__ b = forward x b OrigMod torch nn Module __init__ - None super __init__ = forward x torch jit interface ModInterface torch nn Module forward x Tensor - int pass TestModule torch nn Module proxy_mod ModInterface __init__ - None super __init__ proxy_mod = OrigMod sub = SubModule folded forward x proxy_mod x + sub x m = torch jit script TestModule m eval mf = torch _C _freeze_module m _c Assume interface has no aliasing mf = torch _C _freeze_module m _c freezeInterfaces=True input = torch tensor out_s = m forward input out_f = mf forward input assertEqual out_s out_f test_freeze_module_with_setattr_in_interface SubModule torch nn Module __init__ - None super __init__ b = forward x b += b torch jit export getb x b OrigMod torch nn Module __init__ - None super __init__ = forward x torch jit interface ModInterface torch nn Module forward x Tensor - int pass TestModule torch nn Module proxy_mod ModInterface __init__ - None super __init__ proxy_mod = OrigMod sub = SubModule forward x proxy_mod x + sub getb x m = torch jit script TestModule m proxy_mod = m sub m eval mf = torch _C _freeze_module m _c freezeInterfaces=True test_freeze_module_with_inplace_mutation_in_interface SubModule torch nn Module __init__ - None super __init__ b = torch tensor forward x b += b torch jit export getb x b OrigMod torch nn Module __init__ - None super __init__ = torch tensor forward x torch jit interface ModInterface torch nn Module forward x Tensor - Tensor pass TestModule torch nn Module proxy_mod ModInterface __init__ - None super __init__ proxy_mod = OrigMod sub = SubModule forward x y = proxy_mod x z = sub getb x y + z m = torch jit script TestModule m proxy_mod = m sub m sub b = m proxy_mod b m eval mf = torch _C _freeze_module m _c freezeInterfaces=True test_freeze_module_with_mutated_interface SubModule torch nn Module __init__ - None super __init__ b = torch tensor forward x b torch jit export getb x b OrigMod torch nn Module __init__ - None super __init__ = torch tensor forward x torch jit interface ModInterface torch nn Module forward x Tensor - Tensor pass TestModule torch nn Module proxy_mod ModInterface __init__ - None super __init__ proxy_mod = OrigMod sub = SubModule forward x proxy_mod = sub y = proxy_mod x z = sub getb x y + z m = torch jit script TestModule m eval assertRaisesRegex RuntimeError Freezing does support SetAttr interface type mf = torch _C _freeze_module m _c freezeInterfaces=True test_freeze_module_with_interface_and_fork SubModule torch nn Module __init__ - None super __init__ b = torch tensor forward x b += b OrigMod torch nn Module __init__ - None super __init__ = torch tensor forward x torch jit interface ModInterface torch nn Module forward x Tensor - Tensor pass TestModule torch nn Module proxy_mod ModInterface __init__ - None super __init__ proxy_mod = OrigMod sub = SubModule forward x y = proxy_mod x z = sub x y + z MainModule torch nn Module __init__ - None super __init__ test = TestModule forward x fut = torch jit _fork test forward x y = test x z = torch jit _wait fut y + z m = torch jit script MainModule m eval mf = torch _C _freeze_module m _c freezeInterfaces=True test_module_apis_interface torch jit interface ModuleInterface nn Module one inp Tensor inp Tensor - Tensor pass TestModule nn Module proxy_mod ModuleInterface __init__ - None super __init__ proxy_mod = OrigModule forward input input torch jit export method input module modules input = module input input assertRaisesRegex Exception Could compile scripted_mod = torch jit script TestModule __name__ == __main__ raise_on_run_directly test test_jit py
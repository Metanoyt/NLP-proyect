Owner s oncall distributed checkpointing os shutil tempfile torch torch distributed checkpoint _experimental barriers BarrierConfig torch distributed checkpoint _experimental builder make_async_checkpointer make_sync_checkpointer torch distributed checkpoint _experimental checkpointer AsyncCheckpointer SyncCheckpointer torch distributed checkpoint _experimental config CheckpointerConfig torch distributed checkpoint _experimental staging CheckpointStagerConfig torch distributed checkpoint _experimental types RankInfo torch testing _internal common_utils run_tests TestCase TestMakeCheckpointer TestCase setUp - None Create temporary directory checkpoints temp_dir = tempfile mkdtemp Create real objects testing rank_info = RankInfo global_world_size= global_rank= Create test state dictionary state_dict = model torch nn Linear state_dict optimizer param_groups lr epoch step tearDown - None Clean up temporary directory shutil rmtree temp_dir test_make_sync_checkpointer - None Test creating synchronous checkpointer using make_sync_checkpointer Create sync checkpointer using factory function no barrier config = CheckpointerConfig barrier_config=BarrierConfig barrier_type=None checkpointer = make_sync_checkpointer config=config rank_info=self rank_info Verify s SyncCheckpointer instance assertIsInstance checkpointer SyncCheckpointer Test works sync operations checkpoint_path = os path join temp_dir checkpoint_factory_sync result = checkpointer save checkpoint_path state_dict assertIsNone result Sync mode returns None Verify checkpoint created checkpoint_file = os path join checkpoint_path f checkpoint_ rank_info global_rank pt assertTrue os path exists checkpoint_file Test loading loaded_state_dict = checkpointer load checkpoint_path assertEqual loaded_state_dict epoch test_make_sync_checkpointer_with_config_first - None Test creating synchronous checkpointer config first parameter Create sync checkpointer config first parameter config = CheckpointerConfig barrier_config=BarrierConfig barrier_type=None checkpointer = make_sync_checkpointer config=config rank_info=self rank_info Verify s SyncCheckpointer instance assertIsInstance checkpointer SyncCheckpointer Test works sync operations checkpoint_path = os path join temp_dir checkpoint_factory_sync_config_first result = checkpointer save checkpoint_path state_dict assertIsNone result Sync mode returns None Verify checkpoint created checkpoint_file = os path join checkpoint_path f checkpoint_ rank_info global_rank pt assertTrue os path exists checkpoint_file test_make_sync_checkpointer_with_custom_config - None Test creating synchronous checkpointer custom config Create custom config no barrier config = CheckpointerConfig barrier_config=BarrierConfig barrier_type=None Create sync checkpointer custom config checkpointer = make_sync_checkpointer rank_info=self rank_info config=config Verify s SyncCheckpointer instance assertIsInstance checkpointer SyncCheckpointer Test works sync operations checkpoint_path = os path join temp_dir checkpoint_factory_sync_custom_config result = checkpointer save checkpoint_path state_dict assertIsNone result Sync mode returns None Verify checkpoint created checkpoint_file = os path join checkpoint_path f checkpoint_ rank_info global_rank pt assertTrue os path exists checkpoint_file Test loading loaded_state_dict = checkpointer load checkpoint_path assertEqual loaded_state_dict epoch test_make_async_checkpointer - None Test creating asynchronous checkpointer using make_async_checkpointer Create async checkpointer using factory function default parameters config CheckpointerConfig = CheckpointerConfig config staging_config = CheckpointStagerConfig use_non_blocking_copy=torch accelerator is_available use_pinned_memory=torch accelerator is_available checkpointer = make_async_checkpointer config=config rank_info=self rank_info try Verify s AsyncCheckpointer instance assertIsInstance checkpointer AsyncCheckpointer Test works async operations checkpoint_path = os path join temp_dir checkpoint_factory_async stage_future write_future = checkpointer save checkpoint_path state_dict Verify futures returned assertIsNotNone stage_future assertIsNotNone write_future Wait completion stage_future result write_future result Verify checkpoint created checkpoint_file = os path join checkpoint_path f checkpoint_ rank_info global_rank pt assertTrue os path exists checkpoint_file Test loading loaded_state_dict = checkpointer load checkpoint_path assertEqual loaded_state_dict epoch finally Clean up checkpointer close __name__ == __main__ run_tests
mypy allow-untyped-defs logging os typing Optional torch _inductor config torch _inductor utils is_linux try_import_ck_lib log = logging getLogger __name__ _rocm_include_paths dst_file_ext str - list str torch utils cpp_extension rocm_include = os path join config rocm rocm_home include config rocm rocm_home cpp_extension _join_rocm_home include config is_fbcode libfb py parutil ck_path = parutil get_dir_path composable-kernel-headers config rocm ck_dir ck_dir _ _ _ = try_import_ck_lib ck_dir log warning Unspecified Composable Kernel directory config rocm ck_dir = ck_dir ck_path = config rocm ck_dir cpp_extension _join_rocm_home composable_kernel log debug Using ck path s ck_path ck_include = os path join ck_path include ck_library_include = os path join ck_path library include CK has take priority over ROCm include paths Since CK potentially more up-to-date paths = os path realpath p p ck_include ck_library_include rocm_include dst_file_ext == exe ck_utility_include = os path join ck_path library src utility paths append os path realpath ck_utility_include paths _rocm_lib_options dst_file_ext str - list str torch utils cpp_extension rocm_lib_dir = os path join config rocm rocm_home lib config rocm rocm_home cpp_extension _join_rocm_home lib hip_lib_dir = os path join config rocm rocm_home hip lib config rocm rocm_home cpp_extension _join_rocm_home hip lib opts = -include __clang_hip_runtime_wrapper h f -L os path realpath rocm_lib_dir f -L os path realpath hip_lib_dir -lamdhip dst_file_ext == exe opts += -lpthread -lstdc++ opts _rocm_compiler_options - list str arch_list = config rocm arch native gpu_arch_flags = f -- offload-arch= arch arch arch_list opts = config rocm compile_opt_level -x hip -std=c++ gpu_arch_flags -fno-gpu-rdc -fPIC -fvisibility=hidden -mllvm -amdgpu-early-inline-all=true -mllvm -amdgpu-function-calls=false -mllvm -enable-post-misched= config rocm is_debug opts += -DDEBUG_LOG= -g config rocm save_temps opts += -- save-temps=obj config rocm print_kernel_resource_usage opts += -Rpass-analysis=kernel-resource-usage config rocm flush_denormals opts += -fgpu-flush-denormals-to-zero config rocm use_fast_math opts += -ffast-math opts rocm_compiler - Optional str is_linux config rocm rocm_home os path realpath os path join config rocm rocm_home llvm bin clang try torch utils cpp_extension os path realpath cpp_extension _join_rocm_home llvm bin clang except OSError neither config rocm rocm_home nor env variable ROCM_HOME set clang None rocm_compile_command src_files list str dst_file str dst_file_ext str extra_args Optional list str = None - str include_paths = _rocm_include_paths dst_file_ext lib_options = _rocm_lib_options dst_file_ext compiler_options = _rocm_compiler_options compiler = rocm_compiler options = compiler_options + extra_args + f -I path path include_paths + lib_options src_file = join src_files supported extensions o so exe dst_file_ext == o options append -c dst_file_ext == so options append -shared dst_file_ext == exe options append -DGENERATE_CK_STANDALONE_RUNNER raise NotImplementedError f Unsupported output file suffix dst_file_ext f compiler join options -o dst_file src_file
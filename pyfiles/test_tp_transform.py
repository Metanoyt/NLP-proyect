Owner s oncall distributed collections defaultdict torch torch distributed tensor experimental _tp_transform tensor_parallel_transformation torch distributed tensor parallel style ColwiseParallel ParallelStyle RowwiseParallel torch testing _internal common_utils run_tests torch testing _internal distributed _tensor common_dtensor DTensorTestBase with_comms MLPListModule torch nn Module A dummy model list MLPs __init__ num_mlps= bias=True super __init__ mlps = torch nn ModuleList _ range num_mlps mlps append torch nn Sequential torch nn Linear torch nn ReLU torch nn Linear bias=bias forward x torch Tensor - torch Tensor x = torch chunk x dim= mlp mlps x = mlp x x + torch ones_like x DummyModel torch nn Module __init__ - None super __init__ fc = torch nn Linear bn = torch nn BatchNorm d forward x bn fc x TensorParallelTest DTensorTestBase setUp - None super setUp assert_has_c d_ops gm torch fx GraphModule expected_ops_count dict str int - None actual_ops_count dict str int = defaultdict int node gm graph nodes node op == call_function c d_functional str node target actual_ops_count str node target += assertDictEqual expected_ops_count actual_ops_count with_comms test_tp_transform_with_uncovered_op model = DummyModel device=self device_type inputs = torch randn requires_grad=False device=self device_type torch no_grad res = model inputs exported_program = torch export export model inputs strict=True run_decompositions tp_exported_program = tensor_parallel_transformation exported_program rank world_size device_type fc ColwiseParallel tp_model = tp_exported_program module torch no_grad tp_res = tp_model inputs assertEqual res tp_res Expect all_gather inserted distributed sharded fc results assert_has_c d_ops tp_exported_program graph_module _c d_functional all_gather_into_tensor default _c d_functional wait_tensor default with_comms test_tp_transform_e e torch manual_seed model = MLPListModule device=self device_type inputs = torch randn device=self device_type parallel_strategies dict str ParallelStyle = mlps ColwiseParallel mlps RowwiseParallel mlps ColwiseParallel mlps RowwiseParallel torch inference_mode res = model inputs exported_program = torch export export model inputs strict=True run_decompositions tp_exported_program = tensor_parallel_transformation exported_program rank world_size device_type parallel_strategies tp_model = tp_exported_program module torch inference_mode tp_res = tp_model inputs assertEqual res tp_res Expect all_reduce inserted end each MLP assert_has_c d_ops tp_exported_program graph_module _c d_functional all_reduce default _c d_functional wait_tensor default with_comms test_tp_transform_no_bias torch manual_seed model = MLPListModule bias=False device=self device_type inputs = torch randn device=self device_type parallel_strategies dict str ParallelStyle = mlps ColwiseParallel mlps RowwiseParallel torch inference_mode res = model inputs exported_program = torch export export model inputs strict=True run_decompositions tp_exported_program = tensor_parallel_transformation exported_program rank world_size device_type parallel_strategies tp_model = tp_exported_program module torch inference_mode tp_res = tp_model inputs assertEqual res tp_res assert_has_c d_ops tp_exported_program graph_module _c d_functional all_reduce default _c d_functional wait_tensor default __name__ == __main__ run_tests
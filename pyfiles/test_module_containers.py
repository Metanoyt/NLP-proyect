Owner s oncall jit os sys collections OrderedDict typing Any List Tuple torch torch nn nn torch testing _internal common_utils raise_on_run_directly torch testing _internal jit_utils JitTestCase Make helper files test importable pytorch_test_dir = os path dirname os path dirname os path realpath __file__ sys path append pytorch_test_dir TestModuleContainers JitTestCase test_sequential_intermediary_types A torch nn Module forward x x + B torch nn Module forward x x C torch nn Module __init__ - None super __init__ foo = torch nn Sequential A B forward x foo x checkModule C torch tensor test_moduledict Inner torch nn Module forward x x + Inner torch nn Module forward x x Inner torch nn Module forward x x - M torch nn Module __init__ - None super __init__ modules = OrderedDict one Inner two Inner three Inner moduledict = nn ModuleDict modules forward x skip_name type Tensor str names = torch jit annotate List str values = name moduledict names append name name mod moduledict items name = skip_name names append name x = mod x values append x mod moduledict values x = mod x values append x key moduledict keys names append key x names M M forward x skip_name type Tensor str names = torch jit annotate List str values = x = x iter = name moduledict names append name i name mod enumerate moduledict items iter += i name = skip_name names append name x = mod x values append x i mod enumerate moduledict values iter += i x = mod x values append x i key enumerate moduledict keys iter += i names append key mod mod zip moduledict values moduledict values iter += i x = mod mod x x x names iter name one two three inp = torch tensor checkModule M inp name checkModule M inp name test_custom_container_forward Inner torch nn Module forward x x + CustomSequential nn Sequential __init__ - None super __init__ nn ReLU Inner forward x x = x + mod x = mod x x - checkModule CustomSequential torch tensor CustomModuleList nn ModuleList __init__ - None super __init__ nn ReLU Inner forward x x = x + mod x = mod x x - checkModule CustomModuleList torch tensor CustomModuleDict nn ModuleDict __init__ - None super __init__ OrderedDict one Inner two nn ReLU three Inner forward x x = x + names = torch jit annotate List str name mod items x = mod x names append name names x - checkModule CustomModuleDict torch tensor test_script_module_list_sequential M torch jit ScriptModule __init__ mod_list super __init__ mods = mod_list torch jit script_method forward v m mods v = m v v torch jit optimized_execution False m = M nn Sequential nn ReLU assertExportImportModule m torch randn test_script_modulelist_index Sub torch nn Module __init__ i super __init__ i = i forward thing thing - i M torch nn Module __init__ - None super __init__ mods = nn ModuleList Sub i i range forward v v = mods forward v v = mods - forward v v = mods - forward v v x = torch tensor checkModule M x MForward torch nn Module __init__ - None super __init__ mods = nn ModuleList Sub i i range forward v v = mods v v = mods - v v = mods - v v checkModule MForward torch tensor M M forward v mods - forward v assertRaisesRegexWithHighlight Exception Index - out range mods - torch jit script M M M forward v i = mods i forward v assertRaisesRegexWithHighlight Exception Enumeration supported mods i torch jit script M M M forward v i = mods i forward v assertRaisesRegex Exception will fail because i literal torch jit script M test_module_interface_special_methods CustomModuleInterface torch nn Module pass CustomModuleList CustomModuleInterface torch nn ModuleList __init__ modules=None CustomModuleInterface __init__ torch nn ModuleList __init__ modules CustomSequential CustomModuleInterface torch nn Sequential __init__ modules=None CustomModuleInterface __init__ torch nn Sequential __init__ modules CustomModuleDict CustomModuleInterface torch nn ModuleDict __init__ modules=None CustomModuleInterface __init__ torch nn ModuleDict __init__ modules MyModule torch nn Module __init__ - None super __init__ work around aliasing issue operator scripting ReLU up front submod = torch jit script torch nn ReLU modulelist = CustomModuleList submod sequential = CustomSequential submod moduledict = CustomModuleDict submod submod forward inputs assert modulelist submod __getitem__ failing ModuleList assert len modulelist == __len__ failing ModuleList module modulelist assert module submod __iter__ failing ModuleList assert sequential submod __getitem__ failing Sequential assert len sequential == __len__ failing Sequential module sequential assert module submod __iter__ failing Sequential assert moduledict submod submod __getitem__ failing ModuleDict assert len moduledict == __len__ failing ModuleDict note unable index moduledict string variable currently i = _ moduledict i += assert i == len moduledict iteration failing ModuleDict assert submod moduledict __contains__ fails ModuleDict key moduledict keys assert key == submod keys fails ModuleDict item moduledict items assert item == submod items fails ModuleDict assert item submod items fails ModuleDict value moduledict values assert value submod values fails ModuleDict inputs m = MyModule checkModule m torch randn test_special_method_with_override CustomModuleInterface torch nn Module pass CustomModuleList CustomModuleInterface torch nn ModuleList __init__ modules=None CustomModuleInterface __init__ torch nn ModuleList __init__ modules __len__ arbitrary just check overridden py __len__ CustomModuleList takes precedence over automatically generated __len__ added jit compiler MyModule torch nn Module __init__ - None super __init__ work around aliasing issue operator scripting ReLU up front submod = torch jit script torch nn ReLU modulelist = CustomModuleList submod forward inputs assert len modulelist == __len__ failing ModuleList inputs m = MyModule checkModule m torch randn torch jit script m test_moduledict_getitem MyModule torch nn Module __init__ - None super __init__ relu = torch jit script torch nn ReLU tanh = torch jit script torch nn Tanh moduledict = torch nn ModuleDict relu relu tanh tanh forward input assert moduledict relu relu assert moduledict tanh tanh input m = MyModule checkModule m torch randn test_moduledict_keyerror BadModule torch nn Module __init__ - None super __init__ moduledict = torch nn ModuleDict foo None bar None forward input assert moduledict blah == blah keyerror assertRaisesRegexWithHighlight RuntimeError Key Error blah moduledict blah b = BadModule torch jit script b AnotherBadModule torch nn Module __init__ - None super __init__ moduledict = torch nn ModuleDict foo None bar None forward input idx = blah assert moduledict idx == blah string literal error assertRaisesRegexWithHighlight RuntimeError Unable extract string literal index ModuleDict indexing only supported string literals For example i = \ a\ layers\\ i\\ \\ x\\ will fail because i literal moduledict idx b = AnotherBadModule torch jit script b test_normal_list_attribute_with_modules_error Test attempt script module regular list attribute containing other modules fails relevant error message Mod torch nn Module __init__ - None super __init__ = torch nn ReLU torch nn ReLU forward len error_msg = Could infer type list element Cannot infer concrete type torch nn Module assertRaisesRegexWithHighlight RuntimeError error_msg torch jit script Mod test_empty_dict_override_contains CustomModuleInterface torch nn Module pass CustomModuleDict CustomModuleInterface torch nn ModuleDict __init__ modules=None CustomModuleInterface __init__ torch nn ModuleDict __init__ modules MyModule torch nn Module __init__ - None super __init__ work around aliasing issue operator scripting ReLU up front submod = torch jit script torch nn ReLU moduledict = CustomModuleDict forward inputs assert submod moduledict __contains__ fails ModuleDict inputs m = MyModule checkModule m torch randn test_typed_module_dict Test type annotation can provided ModuleDict allows non-static indexing torch jit interface ModuleInterface torch nn Module forward inp Any - Any pass ImplementsInterface torch nn Module forward inp Any - Any isinstance inp torch Tensor torch max inp dim= inp DoesNotImplementInterface torch nn Module forward inp torch Tensor - Tuple torch Tensor torch Tensor torch max inp dim= Test annotation submodule Mod torch nn Module __init__ - None super __init__ d = torch nn ModuleDict module ImplementsInterface forward x torch Tensor key str - Any value ModuleInterface = d key value forward x m = Mod checkModule m torch randn module Test annotation ModDict torch nn ModuleDict __init__ - None super __init__ module ImplementsInterface forward x torch Tensor key str - Any submodule ModuleInterface = key submodule forward x m = ModDict checkModule m torch randn module Test error message thrown when annotated attribute does comply annotation ModWithWrongAnnotation torch nn ModuleDict __init__ - None super __init__ d = torch nn ModuleDict module DoesNotImplementInterface forward x torch Tensor key str - Any submodule ModuleInterface = d key submodule forward x assertRaisesRegexWithHighlight RuntimeError r Attribute module annotated type d key torch jit script ModWithWrongAnnotation test_typed_module_list Test type annotation can provided ModuleList allows non-static indexing torch jit interface ModuleInterface torch nn Module forward inp Any - Any pass ImplementsInterface torch nn Module forward inp Any - Any isinstance inp torch Tensor torch max inp dim= inp DoesNotImplementInterface torch nn Module forward inp torch Tensor - Tuple torch Tensor torch Tensor torch max inp dim= Test annotation submodule Mod torch nn Module __init__ - None super __init__ l = torch nn ModuleList ImplementsInterface forward x torch Tensor idx int - Any value ModuleInterface = l idx value forward x m = Mod checkModule m torch randn Test annotation ModList torch nn ModuleList __init__ - None super __init__ ImplementsInterface forward x torch Tensor idx int - Any submodule ModuleInterface = idx submodule forward x m = ModList checkModule m torch randn Test error message thrown when annotated attribute does comply annotation ModWithWrongAnnotation torch nn ModuleList __init__ - None super __init__ l = torch nn ModuleList DoesNotImplementInterface forward x torch Tensor idx int - Any submodule ModuleInterface = l idx submodule forward x assertRaisesRegexWithHighlight RuntimeError r Attribute annotated type l idx torch jit script ModWithWrongAnnotation test_module_properties ModuleWithProperties torch nn Module __jit_unused_properties__ = ignored_attr __init__ int super __init__ = forward int b int attr = + b attr property attr property ignored_attr sum torch jit unused property ignored_attr_ sum ignored_attr_ setter ignored_attr_ value = sum attr setter attr int = = ModuleWithNoSetter torch nn Module __init__ int super __init__ = forward int b int attr + + b property attr + checkModule ModuleWithProperties checkModule ModuleWithProperties - - checkModule ModuleWithNoSetter checkModule ModuleWithNoSetter - - mod = ModuleWithProperties scripted_mod = torch jit script mod assertRaisesRegex AttributeError has no attribute scripted_mod ignored_attr test_module_inplace_construct M nn Module __init__ start int super __init__ linear = nn Linear attribute = start parameter = nn Parameter torch tensor dtype=torch float method - int attribute torch jit unused unused_method attribute + attribute forward x linear linear x N nn Module __init__ - None super __init__ linear = nn Linear torch jit ignore ignored_method x x forward x linear x m = torch jit script M n = torch jit script N n _reconstruct m _c inp = torch rand Check both modules produce same output torch no_grad m_out = m inp n_out = n inp assertEqual m_out n_out Check ignored method still intact assertEqual inp n ignored_method inp test_parameterlist_script_getitem MyModule nn Module __init__ - None super __init__ module_list = nn ModuleList nn Linear _ range parameter_list = nn ParameterList nn Parameter torch zeros _ range forward x module_list parameter_list x checkModule MyModule torch zeros test_parameterlist_script_iter MyModule nn Module __init__ - None super __init__ module_list = nn ModuleList nn Linear _ range parameter_list = nn ParameterList nn Parameter torch zeros _ range forward x r = x i p enumerate parameter_list r = r + p + i r checkModule MyModule torch zeros test_parameterdict_script_getitem MyModule nn Module __init__ - None super __init__ parameter_dict = nn ParameterDict k nn Parameter torch zeros k b c forward x parameter_dict x + parameter_dict b parameter_dict c checkModule MyModule torch ones __name__ == __main__ raise_on_run_directly test test_jit py
mypy disallow-untyped-defs functools logging os re subprocess time collections abc Callable Sequence threading Lock timeit default_timer timer typing Any Optional TypeVar typing_extensions ParamSpec logger = logging getLogger strobelight_function_profiler console_handler = logging StreamHandler formatter = logging Formatter name s line lineno d asctime s levelname s message s console_handler setFormatter formatter logger addHandler console_handler logger setLevel logging INFO logger propagate = False _P = ParamSpec _P _R = TypeVar _R StrobelightCLIProfilerError Exception Raised when error happens during strobelight profiling _pid_namespace_link pid Optional int = None - str Returns link process s namespace example pid PID_NAMESPACE_PATH = proc ns pid pid = pid os getpid os readlink PID_NAMESPACE_PATH format pid _pid_namespace pid Optional int = None - int Returns process s namespace id pid = pid os getpid link = _pid_namespace_link pid int link link find + - _command_to_string command Sequence str - str join command StrobelightCLIFunctionProfiler Note Meta only tool StrobelightCLIFunctionProfiler can used profile python function generate strobelight link results It works meta servers does requires fbcode target When stop_at_error false default error during profiling does prevent work function running Check function_profiler_example py example This lock used make sure only one thread running profiler any point _lock = Lock __init__ stop_at_error bool = False max_profile_duration_sec int = sample_each float = e sample each sample_each cycles run_user_name str = pytorch-strobelight-ondemand timeout_wait_for_running_sec int = timeout_wait_for_finished_sec int = recorded_env_variables Optional list str = None sample_tags Optional list str = None stack_max_len int = async_stack_max_len int = stop_at_error = stop_at_error max_profile_duration_sec = max_profile_duration_sec sample_each = sample_each run_user_name = run_user_name timeout_wait_for_running_sec = timeout_wait_for_running_sec timeout_wait_for_finished_sec = timeout_wait_for_finished_sec Results most recent run Tracks strobelight run id most recent run current_run_id Optional int = None profile_result Optional list str = None sample_tags = sample_tags _run_async - None processId = os getpid namespace = _pid_namespace processId command = strobeclient run -- profiler pyperf -- event cycles -- async -- sample-interval f int sample_each -- duration-ms f int max_profile_duration_sec -- pid f namespace processId sample_tags command append -- sample-tags command append join sample_tags logger debug running command s _command_to_string command result = subprocess run command capture_output=True output = result stderr decode utf- logger debug output \n s output result returncode = raise StrobelightCLIProfilerError f failed start strobelight profiling error run_async output match = re search r INFO Run Id - \d+ output current_run_id = int match group raise StrobelightCLIProfilerError f failed start strobelight profiling unexpected result output _wait_for_running counter int = - None counter raise StrobelightCLIProfilerError wait_for_running called more than times command = strobeclient getRunStatus -- run-id f current_run_id logger debug running command s _command_to_string command result = subprocess run command capture_output=True output = result stderr decode utf- logger debug output \n s output result returncode = raise StrobelightCLIProfilerError f failed start strobelight profiling error wait_for_running output match = re search Profile run status output current_status = match group current_status == RUNNING current_status == PREPARING time sleep _wait_for_running counter + raise StrobelightCLIProfilerError f unexpected current_status phase raise StrobelightCLIProfilerError f unexpected output\n output _stop_run - None command = strobeclient stopRun -- run-id str current_run_id logger debug running command s _command_to_string command result = subprocess run command capture_output=True output = result stderr decode utf- logger debug output \n s output result returncode = raise StrobelightCLIProfilerError f failed stop strobelight profiling code output match = re search INFO output current_status = match group current_status __contains__ Success raise StrobelightCLIProfilerError f failed stop strobelight profiling got current_status result raise StrobelightCLIProfilerError f unexpected output\n output _get_results - None command = strobeclient getRunStatus -- run-id str current_run_id logger debug running command s _command_to_string command result = subprocess run command capture_output=True output = result stderr decode utf- logger debug output \n s output result returncode = raise StrobelightCLIProfilerError f failed extract profiling results code output match = re search INFO output current_status = match group current_status __contains__ Profile run status PROCESSING time sleep _get_results current_status __contains__ Profile run finished SUCCESS raise StrobelightCLIProfilerError f failed extract profiling results unexpected response output profile_result = item re findall r Total samples &#124; GraphProfiler &#124; Icicle view \ python stack\ output profile_result += item logger info item _stop_strobelight_no_throw collect_results bool - None try call stop run _stop_run logger info strobelight profiling stopped logger debug collection stopped collect_results _get_results except Exception logger warning error during stop_strobelight exc_info=True Return true strobelight started running Never throw _start_strobelight - bool strobelight_started = False try _run_async strobelight_started = True logger info strobelight run id s current_run_id _wait_for_running logger info strobelight profiling running True except Exception logger warning error during start_strobelight exc_info=True strobelight_started _stop_strobelight_no_throw collect_results=False False profile work_function Callable _P _R args _P args kwargs _P kwargs - Optional _R current_run_id = None profile_result = None locked = StrobelightCLIFunctionProfiler _lock acquire False locked stop_at_error raise StrobelightCLIProfilerError concurrent runs supported logger warning concurrent runs supported work_function args kwargs started = _start_strobelight started stop_at_error StrobelightCLIFunctionProfiler _lock release raise StrobelightCLIProfilerError failed start strobelight profiling result = work_function args kwargs StrobelightCLIFunctionProfiler _lock release result try logger debug collection started start = timer result = work_function args kwargs end = timer total_time = end - start Time seconds e g logger info work function took s seconds total_time _stop_strobelight_no_throw collect_results=True StrobelightCLIFunctionProfiler _lock release result except Exception error logger warning work function throw exception exc_info=True _stop_strobelight_no_throw collect_results=False StrobelightCLIFunctionProfiler _lock release raise error None A function decorator wraps profile no profiler provided one default args created A function can annotated strobelight strobelight profiler = StrobelightFunctionProfiler stop_at_error=True strobelight stop_at_error=True strobelight profiler Optional StrobelightCLIFunctionProfiler = None kwargs Any - Callable Callable _P _R Callable _P Optional _R profiler profiler = StrobelightCLIFunctionProfiler kwargs strobelight_inner work_function Callable _P _R - Callable _P Optional _R functools wraps work_function wrapper_function args _P args kwargs _P kwargs - Optional _R pyrefly ignore bad-argument-type profiler profile work_function args kwargs wrapper_function strobelight_inner
Owner s module sparse copy warnings torch torch nn torch ao pruning _experimental data_scheduler BaseDataScheduler torch ao pruning _experimental data_sparsifier DataNormSparsifier torch testing _internal common_utils raise_on_run_directly TestCase ImplementedDataScheduler BaseDataScheduler __init__ sparsifier sparsifier_hyperparam last_epoch=- verbose=False super __init__ sparsifier sparsifier_hyperparam last_epoch verbose get_schedule_param last_epoch name config sparsity_level name config data_sparsifier data_groups items base_param TestBaseDataScheduler TestCase _get_data tensor param emb = torch randn nn Parameter torch randn nn Embedding data_list = tensor tensor param param emb emb defaults = sparsity_level sparse_block_shape zeros_per_block data_with_config = name tensor data torch randn config sparsity_level data_list data_with_config defaults _get_sparsifier data_list data_with_config defaults sparsifier = DataNormSparsifier data_list defaults data_config_dict data_with_config name data config = data_config_dict name data_config_dict data data_config_dict config sparsifier add_data name=name data=data config sparsifier _get_scheduler sparsifier schedule_param scheduler = ImplementedDataScheduler sparsifier schedule_param scheduler _get_schedule_param sparsity_level _get_name_data_config some_data defaults config = copy deepcopy defaults isinstance some_data tuple dealing data_list name data = some_data dealing data_with_config name data new_config = some_data name some_data data some_data config config update new_config name data config test_constructor Checks warning thrown scheduler step called before sparsifier step data_list data_with_config defaults = _get_data sparsifier = _get_sparsifier data_list data_with_config defaults schedule_param = _get_schedule_param scheduler = _get_scheduler sparsifier schedule_param assert scheduler data_sparsifier == sparsifier assert scheduler _step_count == name config sparsifier data_groups items assert scheduler base_param name == config get schedule_param None test_order_of_steps data_list data_with_config defaults = _get_data sparsifier = _get_sparsifier data_list data_with_config defaults schedule_param = _get_schedule_param scheduler = _get_scheduler sparsifier schedule_param Sparsifier step called assertWarns UserWarning scheduler step Correct order has no warnings Note This will trigger other warnings present warnings catch_warnings record=True w sparsifier step scheduler step Make sure there no warning related base_data_scheduler warning w fname = warning filename fname = join fname split - assert fname = torch ao sparsity experimental scheduler data_scheduler base_data_scheduler py test_step data_list data_with_config defaults = _get_data sparsifier = _get_sparsifier data_list data_with_config defaults schedule_param = _get_schedule_param scheduler = _get_scheduler sparsifier schedule_param all_data = data_list + data_with_config some_data all_data name _ config = _get_name_data_config some_data defaults assert sparsifier data_groups name schedule_param == config schedule_param sparsifier step scheduler step some_data all_data name _ config = _get_name_data_config some_data defaults assert sparsifier data_groups name schedule_param == config schedule_param checking step count step_cnt = _ range step_cnt sparsifier step scheduler step assert scheduler _step_count == step_cnt + step_cnt + step above + step constructor test_state_dict data_list data_with_config defaults = _get_data sparsifier = _get_sparsifier data_list data_with_config defaults schedule_param = _get_schedule_param scheduler = _get_scheduler sparsifier schedule_param sparsifier step scheduler step scheduler = _get_scheduler sparsifier schedule_param all_data = data_list + data_with_config some_data all_data name _ _ = _get_name_data_config some_data defaults assert scheduler base_param name = scheduler base_param name assert scheduler _last_param name == scheduler base_param name scheduler _state = scheduler state_dict scheduler load_state_dict scheduler _state some_data all_data name _ _ = _get_name_data_config some_data defaults assert scheduler base_param name == scheduler base_param name assert scheduler _last_param name == scheduler _last_param name __name__ == __main__ raise_on_run_directly test test_ao_sparsity py
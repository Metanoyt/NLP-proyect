mypy allow-untyped-defs time torch torch distributed rpc rpc torch distributed rpc api _delete_all_user_and_unforked_owner_rrefs torch testing _internal dist_utils dist_init wait_until_owners_and_forks_on_rank wait_until_pending_futures_and_users_flushed worker_name torch testing _internal distributed rpc rpc_agent_test_fixture RpcAgentTestFixture my_sleep_func seconds= time sleep seconds torch mul torch tensor torch tensor torch jit script my_script_func tensor torch add tensor tensor add_rref_to_value rref value rref to_here + value FaultyAgentRpcTest RpcAgentTestFixture no faulty_messages defined so fails all retryable messages - see faulty_rpc_agent_test_fixture py list retryable messages dist_init messages_to_delay= test_check_failed_messages rank == dst_worker_b = worker_name rank + world_size dst_worker_c = worker_name rank + world_size Worker sends RPC Worker creates RRef there rref = rpc remote dst_worker_b torch add args= torch ones torch ones Worker sends RPC Worker RRef arg rpc remote dst_worker_c add_rref_to_value args= rref torch ones check output expected assertEqual rref to_here torch add torch ones torch ones explicitly delete all User RRefs _delete_all_user_and_unforked_owner_rrefs dist_init test_verify_backend_options assertEqual rpc_backend rpc backend_registry BackendType FAULTY_TENSORPIPE assertEqual rpc_backend_options num_worker_threads assertEqual rpc_backend_options num_fail_sends assertEqual len rpc_backend_options messages_to_fail assertEqual len rpc_backend_options messages_to_delay assertEqual rpc_backend_options rpc_timeout rpc constants DEFAULT_RPC_TIMEOUT_SEC dist_init faulty_messages= RREF_FORK_REQUEST RREF_CHILD_ACCEPT test_custom_faulty_messages assertEqual RREF_FORK_REQUEST RREF_CHILD_ACCEPT set rpc_backend_options messages_to_fail dist_init faulty_messages= test_no_faulty_messages assertEqual len rpc_backend_options messages_to_fail dist_init messages_to_delay= SCRIPT_CALL test_custom_messages_to_delay assertEqual rpc_backend_options messages_to_delay SCRIPT_CALL _test_remote_message_dropped_pickle dst=None rank = dst_rank = dst dst None rank + world_size dst_worker = f worker dst_rank Since we fail python_remote_call messages synchronously future corresponding remote call will marked error when function returns rref = rpc remote dst_worker my_sleep_func args= Call ensure pending callbacks run wait_until_pending_futures_and_users_flushed Attempt fork RRef should raise error indicating rpc remote timeout assertRaisesRegex RuntimeError RRef creation rref _serialize Test using RRef arg over RPC which forks results same error assertRaisesRegex RuntimeError RRef creation rpc rpc_async dst_worker add_rref_to_value args= rref dist_init faulty_messages= PYTHON_REMOTE_CALL test_remote_message_dropped_pickle _test_remote_message_dropped_pickle dist_init faulty_messages= PYTHON_REMOTE_CALL test_remote_message_dropped_pickle_to_self _test_remote_message_dropped_pickle rank _test_remote_message_dropped_timeout func args dst=None rank = test case where rpc remote message creation completely dropped dst_rank = dst dst None rank + world_size dst_worker = f worker dst_rank Since we fail python_remote_call messages synchronously future corresponding remote call will marked error when function returns rref = rpc remote dst_worker func args=args Call ensure pending callbacks run wait_until_pending_futures_and_users_flushed assertRaisesRegex RuntimeError RRef creation rref to_here Note during shutdown logs will indicate Could find OwnerRRef owning nodes expected because OwnerRRef never successfully created Therefore delAllUsers will work expected dist_init faulty_messages= SCRIPT_REMOTE_CALL test_builtin_remote_message_dropped_timeout func = torch add args = torch tensor torch tensor _test_remote_message_dropped_timeout func args dist_init faulty_messages= SCRIPT_REMOTE_CALL test_builtin_remote_message_dropped_timeout_to_self func = torch add args = torch tensor torch tensor _test_remote_message_dropped_timeout func args dst= dist_init faulty_messages= PYTHON_REMOTE_CALL test_udf_remote_message_dropped_timeout func = my_sleep_func args = _test_remote_message_dropped_timeout func args dist_init faulty_messages= PYTHON_REMOTE_CALL test_udf_remote_message_dropped_timeout_to_self func = my_sleep_func args = _test_remote_message_dropped_timeout func args dst= _test_remote_message_delay_timeout func args dst=None rank = Test case where remote message eventually processed owner future creator times out before response comes back dst_rank = dst dst None rank + world_size dst_worker = f worker dst_rank ms timeout rref = rpc remote dst_worker func args=args timeout= Future corresponding remote creation should time out expected_error = get_timeout_error_regex assertRaisesRegex RuntimeError expected_error rref _get_future wait Call ensure pending callbacks run wait_until_pending_futures_and_users_flushed to_here should now pick up rpc remote creation has failed assertRaisesRegex RuntimeError RRef creation rref to_here Test case where rpc remote times out to_here has already started blocking before NOTE we only test when sending to_here calls calls localValue which does send RPC thus does have timeout This can supported allowing future wait take optional timeout https github com pytorch pytorch issues dst_rank = rank slow_rref = rpc remote dst_worker func args=args timeout= assertRaisesRegex RuntimeError expected_error to_here should raise timeout error since does know about status rpc remote slow_rref to_here Note If we proceed shutdown UserRRef will send out RRefUserDelete can noop since may exist owner yet Later owner can process RRef creation wait delete message thus leading timeout Therefore we wait until we get notification pending owners have been confirmed before sending out RRefUserDeletes dst_rank = rank wait_until_owners_and_forks_on_rank rank=dst_rank dist_init faulty_messages= messages_to_delay= PYTHON_REMOTE_CALL test_udf_remote_message_delay_timeout func = my_sleep_func args = _test_remote_message_delay_timeout func args dist_init faulty_messages= messages_to_delay= PYTHON_REMOTE_CALL test_udf_remote_message_delay_timeout_to_self func = my_sleep_func args = _test_remote_message_delay_timeout func args dst= dist_init faulty_messages= messages_to_delay= SCRIPT_REMOTE_CALL SCRIPT_RREF_FETCH_CALL test_remote_message_builtin_delay_timeout func = torch add args = torch tensor torch tensor _test_remote_message_delay_timeout func args dist_init faulty_messages= messages_to_delay= SCRIPT_REMOTE_CALL SCRIPT_RREF_FETCH_CALL test_remote_message_builtin_delay_timeout_to_self func = torch add args = torch tensor torch tensor _test_remote_message_delay_timeout func args dst= dist_init faulty_messages= messages_to_delay= SCRIPT_REMOTE_CALL SCRIPT_RREF_FETCH_CALL test_remote_message_script_delay_timeout func = my_script_func args = torch tensor _test_remote_message_delay_timeout func args dist_init faulty_messages= messages_to_delay= SCRIPT_REMOTE_CALL SCRIPT_RREF_FETCH_CALL test_remote_message_script_delay_timeout_to_self func = my_script_func args = torch tensor _test_remote_message_delay_timeout func args dst= dist_init faulty_messages= messages_to_delay= SCRIPT_RREF_FETCH_CALL test_rref_to_here_timeout rank = dst_rank = rank + world_size dst_worker = f worker dst_rank rref = rpc remote dst_worker torch add args= torch tensor torch tensor expected_error = get_timeout_error_regex assertRaisesRegex RuntimeError expected_error rref to_here rref to_here dist_init faulty_messages= test_rpc_builtin_timeout next_rank = rank + world_size dst_worker = worker_name next_rank expected_error = get_timeout_error_regex PYTHON_CALL message types which correspond Python UDF over RPC default get delay see faulty_rpc_agent_test_fixture assertRaisesRegex RuntimeError expected_error rpc rpc_sync dst_worker torch add args= torch tensor torch tensor timeout= fut = rpc rpc_async dst_worker torch add args= torch tensor torch tensor timeout= assertRaisesRegex RuntimeError expected_error fut wait Ensure currently set default timeout large enough such RPCs delays still complete fut = rpc rpc_async dst_worker torch add args= torch tensor torch tensor fut wait Ensure timeout we set new default don t override rpc _set_rpc_timeout fut = rpc rpc_async dst_worker torch add args= torch tensor torch tensor assertRaisesRegex RuntimeError expected_error fut wait Ensure run completion we specify timeout fut = rpc rpc_async dst_worker torch add args= torch tensor torch tensor timeout= fut wait Reset clean shutdown rpc _set_rpc_timeout rpc constants DEFAULT_RPC_TIMEOUT_SEC dist_init faulty_messages= messages_to_delay= SCRIPT_CALL test_rpc_script_timeout next_rank = rank + world_size dst_worker = worker_name next_rank expected_error = get_timeout_error_regex assertRaisesRegex RuntimeError expected_error rpc rpc_sync dst_worker my_script_func args= torch tensor timeout= fut = rpc rpc_async dst_worker my_script_func args= torch tensor timeout= assertRaisesRegex RuntimeError expected_error fut wait Ensure currently set default timeout large enough such RPCs delays still complete fut = rpc rpc_async dst_worker my_script_func args= torch tensor fut wait Ensure timeout we set new default don t override rpc _set_rpc_timeout fut = rpc rpc_async dst_worker my_script_func args= torch tensor assertRaisesRegex RuntimeError expected_error fut wait Ensure run completion we specify timeout rpc _set_rpc_timeout fut = rpc rpc_async dst_worker my_script_func args= torch tensor timeout= fut wait Reset clean shutdown rpc _set_rpc_timeout rpc constants DEFAULT_RPC_TIMEOUT_SEC
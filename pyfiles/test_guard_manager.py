Owner s module dynamo abc functools inspect unittest weakref torch torch _dynamo torch _dynamo test_case torch _C _dynamo guards torch _dynamo convert_frame GlobalStateGuard torch _dynamo eval_frame _debug_get_cache_entry_list torch testing _internal common_utils set_default_dtype RootGuardManager = guards RootGuardManager DictGuardManager = guards DictGuardManager GetAttrGuardAccessor = guards GetAttrGuardAccessor GetItemGuardAccessor = guards GetItemGuardAccessor TypeGuardAccessor = guards TypeGuardAccessor OBJECT_ALIASING = guards OBJECT_ALIASING install_object_aliasing_guard = guards install_object_aliasing_guard NO_TENSOR_ALIASING = guards NO_TENSOR_ALIASING install_no_tensor_aliasing_guard = guards install_no_tensor_aliasing_guard x = torch tensor weakref_x = weakref ref x default_mgr_enum = torch _dynamo guards GuardManagerType GUARD_MANAGER Pair __init__ x y x = x y = y global_pair = Pair torch randn id_type x id type x equals_match x expected x == expected equals_match_verbose_code_parts expected f x == expected ge_match x expected x = expected ge_match_verbose_code_parts expected f expected = expected less_match x expected x expected less_match_verbose_code_parts expected f expected expected GuardManagerTests torch _dynamo test_case TestCase test_global_state_guard root = RootGuardManager guard = guards GLOBAL_STATE root global_state_check assertTrue guard None set_default_dtype torch double assertFalse guard None assertExpectedInline str guard check_verbose None \ GuardDebugInfo result= verbose_code_parts= GLOBAL_STATE changed default_dtype num_guards_executed= assertTrue guard None assertTrue guard check_verbose None result _orig = torch are_deterministic_algorithms_enabled try torch use_deterministic_algorithms _orig assertFalse guard None assertExpectedInline str guard check_verbose None \ GuardDebugInfo result= verbose_code_parts= GLOBAL_STATE changed deterministic_algorithms num_guards_executed= finally torch use_deterministic_algorithms _orig assertTrue guard None assertTrue guard check_verbose None result test_global_state_reason torch enable_grad guards = GlobalStateGuard torch no_grad assertIs guards check False assertEqual guards reason grad_mode test_python_lambda_leaf_guard root = RootGuardManager const_guard = guards LAMBDA_GUARD root functools partial equals_match expected= equals_match_verbose_code_parts assertTrue const_guard assertFalse const_guard assertFalse const_guard foo test_type_guard root = RootGuardManager foo = guard = guards TYPE_MATCH root id_type foo type x == int assertTrue guard assertTrue guard assertFalse guard foo foo = guard = guards TYPE_MATCH root id_type foo type x == dict assertTrue guard foo assertTrue guard assertFalse guard assertFalse guard foo Foo __init__ x y x = x y = y foo = Foo guard = guards TYPE_MATCH root id_type foo type x == Foo assertTrue guard foo assertFalse guard assertFalse guard assertFalse guard foo test_id_guard root = RootGuardManager foo = guard = guards ID_MATCH root id foo id x == id foo assertTrue guard foo assertFalse guard assertFalse guard foo foo = guard = guards ID_MATCH root id foo id x == id foo assertTrue guard foo assertFalse guard assertFalse guard assertFalse guard test_equals_guard root = RootGuardManager foo = guard = guards EQUALS_MATCH root foo x == assertTrue guard assertFalse guard assertFalse guard foo tuple foo = guard = guards EQUALS_MATCH root foo x == foo assertTrue guard foo assertTrue guard assertFalse guard assertFalse guard list foo = guard = guards EQUALS_MATCH root foo x == foo assertTrue guard foo assertTrue guard assertFalse guard type foo = int guard = guards EQUALS_MATCH root foo x == foo assertTrue guard foo assertTrue guard int assertFalse guard float test_default_device_guard root = RootGuardManager foo = guard = guards DEFAULT_DEVICE root cpu device assertTrue guard foo try torch set_default_device cuda assertFalse guard foo finally torch set_default_device None test_length_check_guard root = RootGuardManager foo = guard = guards LENGTH_CHECK root len foo len x == len foo assertTrue guard foo assertFalse guard test_no_hasattr_guard root = RootGuardManager Bar __init__ - None bar = bar = Bar Foo __init__ - None foo = foo = Foo guard = guards NO_HASATTR root foo hasattr x foo == False assertTrue guard bar assertFalse guard foo test_tensor_aliasing_guard guard_manager = RootGuardManager = torch randn Foo __init__ x y x = x y = y f_locals = Foo x_guard_mgr = guard_manager getattr_manager x default_mgr_enum y_guard_mgr = guard_manager getattr_manager y default_mgr_enum install_object_aliasing_guard x_guard_mgr y_guard_mgr x y Check structure x_guards = x_guard_mgr get_leaf_guards y_guards = y_guard_mgr get_leaf_guards assertEqual len x_guards assertEqual len y_guards assertTrue isinstance x_guards OBJECT_ALIASING assertTrue isinstance y_guards OBJECT_ALIASING Check two guards same object assertTrue x_guards y_guards f_locals_unaliased = Foo torch randn torch randn assertEqual len x_guard_mgr get_leaf_guards assertEqual len y_guard_mgr get_leaf_guards assertTrue guard_manager check f_locals assertFalse guard_manager check f_locals_unaliased test_dict_version_guard root = RootGuardManager foo = b guard = guards DICT_VERSION root foo x version == foo version assertTrue guard foo assertFalse guard dict foo foo = assertFalse guard foo assertFalse guard b assertFalse guard test_dynamic_indices_guard root = RootGuardManager guard = guards DYNAMIC_INDICES root set x size == y size guard = guards DYNAMIC_INDICES root set x size == y size x = torch randn assertTrue guard x assertTrue guard x x _dynamo_dynamic_indices = set assertFalse guard x assertTrue guard x x _dynamo_dynamic_indices = set assertFalse guard x assertFalse guard x test_tensor_match_guard guard_manager = RootGuardManager x = torch randn size = list x size stride = list x stride guard_manager add_tensor_match_guard x size stride x check_tensor x type x torch _C _dispatch_keys x assertTrue guard_manager check x assertTrue guard_manager check_verbose x result assertTrue guard_manager check torch randn assertTrue guard_manager check_verbose torch randn result assertFalse guard_manager check x t_ x = torch randn x t_ debug_info = guard_manager check_verbose x print debug_info verbose_code_parts assertTrue tensor x stride mismatch debug_info verbose_code_parts test_no_tensor_aliasing_guard guard_manager = RootGuardManager = torch randn Foo __init__ x y z x = x y = y z = z f_locals = Foo x_guard_mgr = guard_manager getattr_manager x default_mgr_enum y_guard_mgr = guard_manager getattr_manager y default_mgr_enum z_guard_mgr = guard_manager getattr_manager z default_mgr_enum install_no_tensor_aliasing_guard x_guard_mgr y_guard_mgr z_guard_mgr x y z no_aliasing x y z Check structure x_guards = x_guard_mgr get_leaf_guards y_guards = y_guard_mgr get_leaf_guards z_guards = z_guard_mgr get_leaf_guards assertEqual len x_guards assertEqual len y_guards assertEqual len z_guards assertTrue isinstance x_guards NO_TENSOR_ALIASING assertTrue isinstance y_guards NO_TENSOR_ALIASING assertTrue isinstance z_guards NO_TENSOR_ALIASING Check two guards same object assertTrue x_guards y_guards z_guards assertFalse guard_manager check f_locals assertFalse guard_manager check_verbose f_locals result f_locals_unaliased = Foo torch randn torch randn torch randn assertTrue guard_manager check f_locals_unaliased assertTrue guard_manager check_verbose f_locals_unaliased result Check hash map cleared assertTrue guard_manager check f_locals_unaliased f_locals_unaliased = Foo torch randn assertFalse guard_manager check f_locals_unaliased assertFalse guard_manager check_verbose f_locals_unaliased result test_weakref_alive_guard root = RootGuardManager x = torch rand weakref_x = weakref ref x guard = guards NOT_NONE root weakref_x None assertTrue guard weakref_x del x assertFalse guard weakref_x unittest skipIf torch cuda is_available requires cuda test_call_function_no_args_guard root = RootGuardManager x = torch cuda current_device guard = guards EQUALS_MATCH root x assertTrue guard assertFalse guard assertFalse guard test_guard_manager_leaf_guard guard_manager = RootGuardManager guard_manager add_type_match_guard id_type type x == int guard_manager add_lambda_guard functools partial ge_match expected= ge_match_verbose_code_parts expected= guard_manager add_lambda_guard functools partial less_match expected= less_match_verbose_code_parts expected= assertEqual len guard_manager get_leaf_guards assertEqual len guard_manager get_accessors assertTrue guard_manager check assertFalse guard_manager check assertFalse guard_manager check foo test_attr_guard_manager Foo __init__ x y x = x y = y foo = Foo guard_manager = RootGuardManager guard_manager add_type_match_guard id_type foo type x == Foo guard_manager getattr_manager x x default_mgr_enum add_lambda_guard functools partial equals_match expected=foo x equals_match_verbose_code_parts foo x guard_manager getattr_manager y y default_mgr_enum add_lambda_guard functools partial equals_match expected=foo y equals_match_verbose_code_parts foo y assertEqual len guard_manager get_leaf_guards child managers one x one y assertEqual len guard_manager get_accessors assertTrue isinstance guard_manager get_accessors GetAttrGuardAccessor assertTrue isinstance guard_manager get_accessors GetAttrGuardAccessor Check leaf guards child managers assertEqual len guard_manager getattr_manager attr= x source= x example_value=None guard_manager_enum=default_mgr_enum get_leaf_guards assertEqual len guard_manager getattr_manager y y None default_mgr_enum get_leaf_guards assertTrue guard_manager check foo assertFalse guard_manager check Foo assertFalse guard_manager check foo test_item_guard_manager foo = guard_manager = RootGuardManager guard_manager add_type_match_guard id_type foo type x == Foo guard_manager getitem_manager default_mgr_enum add_lambda_guard functools partial equals_match expected=foo equals_match_verbose_code_parts foo guard_manager getitem_manager default_mgr_enum add_lambda_guard functools partial equals_match expected=foo equals_match_verbose_code_parts foo assertEqual len guard_manager get_leaf_guards child managers one x one y assertEqual len guard_manager get_accessors assertTrue isinstance guard_manager get_accessors GetItemGuardAccessor assertTrue isinstance guard_manager get_accessors GetItemGuardAccessor Check leaf guards child managers assertEqual len guard_manager getitem_manager None default_mgr_enum get_leaf_guards assertEqual len guard_manager getitem_manager None default_mgr_enum get_leaf_guards assertTrue guard_manager check foo assertFalse guard_manager check assertFalse guard_manager check foo test_framelocals_accessor foo = b guards_manager = RootGuardManager guards_manager add_type_match_guard id_type foo type x == Foo guards_manager framelocals_manager default_mgr_enum add_equals_match_guard == guards_manager framelocals_manager b default_mgr_enum add_equals_match_guard b == assertTrue guards_manager check foo assertFalse guards_manager check b test_framelocals_guard_e e fn x y z x + y + z opt_fn = torch compile fn backend= eager ref = opt_fn torch ones torch _dynamo set_stance fail_on_recompile res = opt_fn torch ones assertEqual ref res c = _debug_get_cache_entry_list fn __code__ assertEqual len c guard_str = str c guard_manager assertIn source=L x accessed_by=FrameLocalsGuardAccessor key= x framelocals_idx= guard_str assertIn source=L y accessed_by=FrameLocalsGuardAccessor key= y framelocals_idx= guard_str assertIn source=L z accessed_by=FrameLocalsGuardAccessor key= z framelocals_idx= guard_str test_dict_getitem_accessor foo = b guards_manager = RootGuardManager guards_manager add_type_match_guard id_type foo type x == Foo guards_manager dict_getitem_manager default_mgr_enum add_equals_match_guard == guards_manager dict_getitem_manager b default_mgr_enum add_equals_match_guard b == assertTrue guards_manager check foo assertFalse guards_manager check b test_globals global global_pair Pair guard_manager = RootGuardManager gpair_mgr = guard_manager globals_dict_manager globals None default_mgr_enum getitem_manager global_pair global_pair default_mgr_enum gpair_mgr add_lambda_guard lambda x isinstance x Pair isinstance x x torch Tensor isinstance x y int global guard fail assertTrue guard_manager check global_pair global_pair y = foo assertFalse guard_manager check global_pair test_type_manager guard_manager = RootGuardManager A = B A mul x super mul x foo = B f_locals = foo foo len type foo __mro__ == foo_mgr = guard_manager getitem_manager foo foo default_mgr_enum type_manager = foo_mgr type_manager type foo default_mgr_enum assertTrue isinstance foo_mgr get_accessors TypeGuardAccessor mro_manager = type_manager getattr_manager __mro__ type foo __mro__ default_mgr_enum assertTrue isinstance type_manager get_accessors GetAttrGuardAccessor mro_manager add_length_check_guard Expected len type foo __mro__ == type foo __mro__ = item_manager = mro_manager getitem_manager type foo __mro__ default_mgr_enum assertTrue isinstance mro_manager get_accessors GetItemGuardAccessor attr_manager = item_manager getattr_manager type foo __mro__ default_mgr_enum assertTrue isinstance item_manager get_accessors GetAttrGuardAccessor attr_manager add_lambda_guard lambda x x == Expected value assertTrue guard_manager check f_locals test_tuple_iterator_getitem = foo = iter next foo foo points index= guard_manager = RootGuardManager Check which tuple_iterator_getitem foo guard_manager add_tuple_iterator_length_guard id_type iter len == guard_manager tuple_iterator_getitem_manager foo default_mgr_enum add_equals_match_guard x== Check type match works assertFalse guard_manager check False assertTrue guard_manager check foo Check index error fails gracefully b = b_foo = iter b assertFalse guard_manager check b_foo test_global_weakref guard_manager = RootGuardManager globals_manager = guard_manager globals_dict_manager globals None default_mgr_enum weakref_manager = globals_manager global_weakref_manager weakref_x None default_mgr_enum weakref_manager add_lambda_guard lambda x isinstance x torch Tensor global weakref fail assertTrue guard_manager check None global x del x assertFalse guard_manager check None test_lambda_manager = guard_manager = RootGuardManager Check we can use same accessor foo_mgr = guard_manager lambda_manager lambda x x None default_mgr_enum foo_mgr add_lambda_guard lambda x x == Expected value assertTrue guard_manager check test exception works guard_manager = RootGuardManager fn x raise AssertionError Test x foo_mgr = guard_manager lambda_manager fn None default_mgr_enum assertFalse guard_manager check None debug_info = guard_manager check_verbose None assertFalse debug_info result assertTrue Test debug_info verbose_code_parts test_dict_contains_guard root = RootGuardManager foo = b guard = guards DICT_CONTAINS root True has assertTrue guard foo assertTrue guard b assertFalse guard b c assertFalse guard guard = guards DICT_CONTAINS root False c has c assertTrue guard foo assertTrue guard b assertFalse guard b c assertTrue guard test_dict_guard_manager root = RootGuardManager nothing pass f_locals = d nothing z torch randn its getitem_manager just f_locals But child guard manager should DictGuardManager dict_mgr = root getitem_manager d f_locals d torch _dynamo guards GuardManagerType DICT_GUARD_MANAGER assertTrue isinstance dict_mgr DictGuardManager assertTrue root check f_locals Check no one can add leaf guard assertRaises RuntimeError dict_mgr add_id_match_guard id_type f_locals id match Check no one can add arbitrary accessor assertRaises RuntimeError dict_mgr getitem_manager f_locals d Check fails different length dict f_locals_prime = d b assertFalse root check f_locals_prime Add key-value manager assertTrue root check f_locals dict_mgr get_key_manager default_mgr_enum add_equals_match_guard dict keys == assertTrue root check f_locals dict_mgr get_value_manager default_mgr_enum add_equals_match_guard d == assertTrue root check f_locals Add key-value manager nothing z assertTrue root check f_locals dict_mgr get_key_manager nothing default_mgr_enum add_lambda_guard lambda x x nothing x nothing assertTrue root check f_locals value_mgr = dict_mgr get_value_manager f_locals d nothing torch _dynamo guards GuardManagerType DICT_GUARD_MANAGER assertTrue isinstance value_mgr DictGuardManager assertTrue root check f_locals Check structure Check we only guarding two keys This common LazyVariableTracker assertEqual len dict_mgr get_key_value_managers f_locals d = assertFalse root check f_locals assertFalse root check_verbose f_locals result f_locals d = assertTrue root check f_locals f_locals d pop fails because len check assertFalse root check f_locals test_clone try utils install_guard_manager_testing_hook except ImportError utils install_guard_manager_testing_hook hook guard_wrapper f_locals builder root = guard_wrapper root Check full cloning works expected cloned_root = root clone_manager lambda x True assertTrue cloned_root check f_locals f_locals foo = assertFalse cloned_root check f_locals f_locals foo = Skip guarding foo cloned_root = root clone_manager lambda x foo x get_source f_locals foo = Original root should fail new root should pass because absence guards foo assertFalse root check f_locals assertTrue cloned_root check f_locals Bar x = y = torch randn foo = bar = Bar fn x foo bar x + foo + bar x bar y x = torch randn opt_fn = torch compile fn backend= eager fullgraph=True install_guard_manager_testing_hook hook opt_fn x foo bar test_diff_guard_manager try utils install_guard_manager_testing_hook except ImportError utils install_guard_manager_testing_hook counter = hook guard_wrapper f_locals builder nonlocal counter root = guard_wrapper root diff_guard_root = guard_wrapper diff_guard_root Check full cloning works expected assertTrue root check f_locals assertTrue diff_guard_root check f_locals Check tensor guards run well old_tensor = f_locals bar y f_locals bar y = torch randn assertFalse root check f_locals assertFalse diff_guard_root check f_locals f_locals bar y = old_tensor Original root should fail foo changes diff_guard_root should pass because does have foo guards counter = On counter = should pass because we have caused recompile because foo causing recompile foo f_locals foo = assertFalse root check f_locals counter == assertTrue diff_guard_root check f_locals assertFalse diff_guard_root check f_locals counter += Bar __init__ x = y = torch randn bar = Bar fn x foo bar x + foo + bar x bar y x = torch randn opt_fn = torch compile fn backend= eager fullgraph=True install_guard_manager_testing_hook hook foo = opt_fn x foo bar foo = opt_fn x foo bar TypePropagationTests torch _dynamo test_case TestCase torch _dynamo config patch skip_tensor_guards_with_matching_dict_tags=True test_basic_types Foo __init__ x = y = torch randn z = foo = Foo mod = torch nn Linear fn x x + foo x + foo y + mod x try utils install_guard_manager_testing_hook except ImportError utils install_guard_manager_testing_hook hook guard_wrapper f_locals builder torch _dynamo source AttrSource DictGetItemSource LocalSource foo_source = LocalSource foo foo_x_source = AttrSource foo_source x assertTrue builder get foo_source name foo assertTrue builder get foo_x_source name foo x Check types foo x foo_x_mgr = builder get_guard_manager_from_source foo_x_source assertTrue issubclass foo_x_mgr get_type_of_guarded_value dict Check types foo x foo_x_a_source = DictGetItemSource foo_x_source foo_x_a_mgr = builder get_guard_manager_from_source foo_x_a_source assertTrue foo_x_a_mgr is_guarded_value_immutable Check types foo y foo_y_source = AttrSource foo_source y foo_y_mgr = builder get_guard_manager_from_source foo_y_source assertTrue foo_y_mgr is_guarded_value_immutable Check types foo z foo_z_source = AttrSource foo_source z foo_z_mgr = builder get_guard_manager_from_source foo_z_source assertTrue issubclass foo_z_mgr get_type_of_guarded_value dict Check types mod mod_source = LocalSource mod mod_mgr = builder get_guard_manager_from_source mod_source assertTrue issubclass mod_mgr get_type_of_guarded_value torch nn Module opt_fn = torch compile fn backend= eager fullgraph=True install_guard_manager_testing_hook hook opt_fn torch randn DuplicateGuardTest torch _dynamo test_case TestCase test_duplicate_guard Foo __init__ x = bar = foo = Foo fn x hasattr foo y x = torch sin x hasattr foo y x = torch sin x hasattr foo bar x = torch cos x hasattr foo bar x = torch cos x x + foo x try utils install_guard_manager_testing_hook except ImportError utils install_guard_manager_testing_hook hook guard_wrapper f_locals builder guard_str = str guard_wrapper One tensor one y assertEqual guard_str count NO_HASATTR opt_fn = torch compile fn backend= eager fullgraph=True install_guard_manager_testing_hook hook opt_fn torch randn RecursiveDictTagTests torch _dynamo test_case TestCase setUp _prev = torch _dynamo config use_recursive_dict_tags_for_guards torch _dynamo config use_recursive_dict_tags_for_guards = True tearDown torch _dynamo config use_recursive_dict_tags_for_guards = _prev TagSafetyChecks RecursiveDictTagTests setUp _prev = torch _dynamo config use_recursive_dict_tags_for_guards torch _dynamo config use_recursive_dict_tags_for_guards = True tearDown torch _dynamo config use_recursive_dict_tags_for_guards = _prev test_immutable_tag_safe Bar pass Foo __init__ = Bar b = torch randn c = d = e = Bar foo = Foo fn x foo x = torch sin x x = x foo b + foo c + foo d + foo d + foo e foo e x = torch sin x x try utils install_guard_manager_testing_hook except ImportError utils install_guard_manager_testing_hook hook guard_wrapper f_locals builder torch _dynamo source AttrSource LocalSource foo_source = LocalSource foo foo_mgr = builder get_guard_manager_from_source foo_source accessor foo_mgr get_accessors isinstance accessor GetAttrGuardAccessor assertTrue accessor get_attr_name b c d e Check types foo foo_a_source = AttrSource foo_source foo_a_mgr = builder get_guard_manager_from_source foo_a_source assertFalse foo_a_mgr is_tag_safe assertFalse foo_a_mgr is_tag_safe_root Check types foo b foo_b_source = AttrSource foo_source b foo_b_mgr = builder get_guard_manager_from_source foo_b_source torch _dynamo config skip_tensor_guards_with_matching_dict_tags assertTrue foo_b_mgr is_tag_safe assertFalse foo_b_mgr is_tag_safe assertFalse foo_b_mgr is_tag_safe_root Check types foo c foo_c_source = AttrSource foo_source c foo_c_mgr = builder get_guard_manager_from_source foo_c_source assertTrue foo_c_mgr is_tag_safe assertFalse foo_c_mgr is_tag_safe_root Check types foo d foo_d_source = AttrSource foo_source d foo_d_mgr = builder get_guard_manager_from_source foo_d_source assertTrue foo_d_mgr is_tag_safe assertFalse foo_d_mgr is_tag_safe_root Check types foo e foo_e_source = AttrSource foo_source e foo_e_mgr = builder get_guard_manager_from_source foo_e_source assertFalse foo_e_mgr is_tag_safe assertFalse foo_e_mgr is_tag_safe_root opt_fn = torch compile fn backend= eager fullgraph=True install_guard_manager_testing_hook hook opt_fn torch randn test_dict_tag_safe Foo __init__ = foo = Foo terminal_dict = tag_safe_dict = const tup nested_dict terminal_dict tag_unsafe_dict = const foo foo outer_dict = safe tag_safe_dict unsafe tag_unsafe_dict terminal_dict fn x x = x + outer_dict safe const x = x + outer_dict safe tup x = x + outer_dict safe tup x = x + outer_dict safe nested_dict x = x + outer_dict unsafe const x = x + outer_dict unsafe foo outer_dict terminal_dict x = torch sin x x try utils install_guard_manager_testing_hook except ImportError utils install_guard_manager_testing_hook hook guard_wrapper f_locals builder torch _dynamo source DictGetItemSource LocalSource outer_source = LocalSource outer_dict Check tagness outer dict outer_mgr = builder get_guard_manager_from_source outer_source assertFalse outer_mgr is_tag_safe assertFalse outer_mgr is_tag_safe_root Check tagness outer safe outer_safe_source = DictGetItemSource outer_source safe outer_safe_mgr = builder get_guard_manager_from_source outer_safe_source assertTrue outer_safe_mgr is_tag_safe assertFalse outer_safe_mgr is_tag_safe_root Check tagness outer unsafe outer_unsafe_source = DictGetItemSource outer_source unsafe outer_unsafe_mgr = builder get_guard_manager_from_source outer_unsafe_source assertFalse outer_unsafe_mgr is_tag_safe assertFalse outer_unsafe_mgr is_tag_safe_root Check tagness outer terminal_dict outer_terminal_source = DictGetItemSource outer_source terminal_dict outer_terminal_mgr = builder get_guard_manager_from_source outer_terminal_source assertTrue outer_terminal_mgr is_tag_safe assertFalse outer_terminal_mgr is_tag_safe_root Check tagness outer safe nested_dict outer_safe_nested_source = DictGetItemSource outer_safe_source nested_dict outer_safe_nested_mgr = builder get_guard_manager_from_source outer_safe_nested_source assertTrue outer_safe_nested_mgr is_tag_safe This should marked root assertFalse outer_safe_nested_mgr is_tag_safe_root opt_fn = torch compile fn backend= eager fullgraph=True install_guard_manager_testing_hook hook opt_fn torch randn test_nn_module_tag_safe Foo torch nn Module c = __init__ super __init__ = check x True forward x inspect signature check parameters items x + + c foo = Foo Env metaclass=abc ABCMeta noqa B pass Baz torch nn Module Env __init__ super __init__ foo = foo forward x Foo str type __mro__ x = torch sin x foo x baz = Baz fn x x = x + baz x x try utils install_guard_manager_testing_hook except ImportError utils install_guard_manager_testing_hook hook guard_wrapper f_locals builder torch _dynamo source LocalSource baz_source = LocalSource baz Check tagness baz baz_mgr = builder get_guard_manager_from_source baz_source assertTrue baz_mgr is_tag_safe assertTrue baz_mgr is_tag_safe_root opt_fn = torch compile fn backend= eager fullgraph=True install_guard_manager_testing_hook hook opt_fn torch randn test_nn_module_tag_overridden_getattr_safe Baz torch nn Module metaclass=abc ABCMeta __init__ super __init__ norm = __getattr__ key key == super __getattr__ key forward x x + + norm baz = Baz fn x x = x + baz x x try utils install_guard_manager_testing_hook except ImportError utils install_guard_manager_testing_hook hook guard_wrapper f_locals builder torch _dynamo source LocalSource baz_source = LocalSource baz Check tagness baz baz_mgr = builder get_guard_manager_from_source baz_source assertTrue baz_mgr is_tag_safe assertTrue baz_mgr is_tag_safe_root opt_fn = torch compile fn backend= eager fullgraph=True install_guard_manager_testing_hook hook opt_fn torch randn RecursiveDictGuardTests RecursiveDictTagTests test_disabling Mod torch nn Module __init__ super __init__ = forward x x + mod = Mod mod_to_fail = Mod fn x mod x x = torch randn try utils install_guard_manager_testing_hook except ImportError utils install_guard_manager_testing_hook basic_hook_test guard_wrapper f_locals builder torch _dynamo source LocalSource mod_source = LocalSource mod Check tagness mod mod_mgr = builder get_guard_manager_from_source mod_source assertTrue mod_mgr is_tag_safe assertTrue mod_mgr is_tag_safe_root assertFalse mod_mgr is_recursive_dict_tag_matching_disabled _ range assertTrue guard_wrapper check mod mod x x assertFalse mod_mgr is_recursive_dict_tag_matching_disabled Let guard pass dict matching fail should add new cached entry assertTrue guard_wrapper check mod mod_to_fail x x assertFalse mod_mgr is_recursive_dict_tag_matching_disabled Let guard fail should disable dict tag optimization well mod_to_fail = assertFalse guard_wrapper check mod mod_to_fail x x assertTrue mod_mgr is_recursive_dict_tag_matching_disabled opt_fn = torch compile fn backend= eager fullgraph=True install_guard_manager_testing_hook basic_hook_test opt_fn x Test dict tag matching failure leads disable dict tag optimization torch compiler reset mod = Mod mod_to_fail = Mod disable_on_dict_tag_match_failure guard_wrapper f_locals builder torch _dynamo source LocalSource mod_source = LocalSource mod Check tagness mod mod_mgr = builder get_guard_manager_from_source mod_source assertTrue mod_mgr is_tag_safe assertTrue mod_mgr is_tag_safe_root assertFalse mod_mgr is_recursive_dict_tag_matching_disabled _ range assertTrue guard_wrapper check mod mod x x assertFalse mod_mgr is_recursive_dict_tag_matching_disabled Change mod attr cause dict tag matching fail still get guard pass This should disable dict tag optimization mod = mod = assertTrue guard_wrapper check mod mod x x assertTrue mod_mgr is_recursive_dict_tag_matching_disabled opt_fn = torch compile fn backend= eager fullgraph=True install_guard_manager_testing_hook disable_on_dict_tag_match_failure opt_fn x Test max size limit breach disables dict tag optimization torch compiler reset mod = Mod mod_to_fail = Mod max_size_test guard_wrapper f_locals builder torch _dynamo source LocalSource mod_source = LocalSource mod Check tagness mod mod_mgr = builder get_guard_manager_from_source mod_source assertTrue mod_mgr is_tag_safe assertTrue mod_mgr is_tag_safe_root assertFalse mod_mgr is_recursive_dict_tag_matching_disabled _ range assertTrue guard_wrapper check mod mod x x assertFalse mod_mgr is_recursive_dict_tag_matching_disabled Let guard pass dict matching fail since cache size set would cause dict tag optimization disabled assertTrue guard_wrapper check mod mod_to_fail x x assertTrue mod_mgr is_recursive_dict_tag_matching_disabled opt_fn = torch compile fn backend= eager fullgraph=True torch _dynamo config patch max_saved_pointers_for_recursive_dict_tags_check= install_guard_manager_testing_hook max_size_test opt_fn x __name__ == __main__ torch _dynamo test_case run_tests run_tests
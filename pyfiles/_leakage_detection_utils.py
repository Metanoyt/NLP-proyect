gc types typing weakref torch These functions used detect potential fake tensor leakage when using PT export See NOTE export non-strict fake tensor leak detection There some complications made logic overly complicated Python Python have different ways implementing referrer so we need account whether ref __dict__ real ref object There some internal PT references fake tensors like ` TrackedFake ` closures generators bound methods can hold fake tensors global object can hold onto fake tensor In general these utils our last resort detect fake tensors leak happens within model attributes we have separate mechanism detect This tool relies bit garbage collector internal details so I think unsafe turn default hence tool should used debugging tool Things we never want flag leaks _SKIP_TYPES = types FrameType types ModuleType _is_globals_or_locals obj typing Any - bool These comparisons only make sense within frame still cheap check obj globals obj locals _is_tracked_fake obj typing Any - bool isinstance obj torch fx experimental symbolic_shapes TrackedFake _is_gm_meta_like_dict d dict o typing Any - bool Hope gm meta custom dict we can assert d get val o _dict_is_attr_of_tracked_fake d dict - bool Python quirk sometimes referrer obj __dict__ instead obj Check dict exactly __dict__ TrackedFake parent gc get_referrers d hasattr parent __dict__ parent __dict__ d _is_tracked_fake parent True False find_legit_leaks_from_referrers active_fakes weakref WeakSet - weakref WeakSet legit_leak weakref WeakSet = weakref WeakSet This so we don t falsely flag generator holding fake tensor fake_list = list active_fakes fake_list_id = id fake_list act fake_list Track id avoid processing duplicate referrers seen = set Assume s leak unless we find only ignorable referrers flagged = False r gc get_referrers act rid = id r rid seen continue seen add rid Skip our own fake_list rid == fake_list_id continue Fast-path skip obvious non-owners _is_globals_or_locals r continue isinstance r _SKIP_TYPES continue _is_tracked_fake r TrackedFake should ignored continue Handle dicts carefully Python sometimes shows __dict__ isinstance r dict _is_gm_meta_like_dict r act continue _dict_is_attr_of_tracked_fake r continue flagged = True break Any other referrer we don t explicitly whitelist counts leak flagged = True break flagged legit_leak add act legit_leak
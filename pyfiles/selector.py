__future__ annotations collections defaultdict collections abc Iterable dataclasses dataclass typing TYPE_CHECKING yaml torchgen selective_build operator merge_debug_info merge_operator_dicts SelectiveBuildOperator strip_operator_overload_name TYPE_CHECKING torchgen model NativeFunction A SelectiveBuilder holds information extracted selective build YAML specification It includes information about build s selectivity debug_info associated selective build opaque string set operators should included build dataclass frozen=True SelectiveBuilder If true then build selective includes all operators include_all_operators bool Debug Information selective custom build level _debug_info tuple str &#124; None A dictionary operator - operator metadata operators dict str SelectiveBuildOperator A dictionary selected kernel tags dtypes Typically PyTorch Operator Kernel function may have many code paths specialized many many Tensor dtypes so s one per kernel function there could many per kernel function The tag isn t kernel function name some fragment kernel function implementation itself kernel_metadata dict str list str ExecuTorch only A dictionary kernel tag - list list input dtypes tensor-like input args This selective yaml et_kernel_metadata dict str list str A set all custom torch bind classes used selected models Stored set internally remove duplicates proactively written list yamls custom_classes set str A set all build features used selected models Stored set internally remove duplicates proactively written list yamls build_features set str If true then fragments all dtypes all kernel functions included well all custom classes This typically set when any one operator lists generated mechanism other than tracing based selective build include_all_non_op_selectives bool staticmethod get_nop_selector - SelectiveBuilder SelectiveBuilder from_yaml_dict include_all_operators True staticmethod from_yaml_dict data dict str object - SelectiveBuilder valid_top_level_keys = include_all_non_op_selectives include_all_operators debug_info operators kernel_metadata et_kernel_metadata custom_classes build_features top_level_keys = set data keys len top_level_keys - valid_top_level_keys raise Exception noqa TRY Got unexpected top level keys format join top_level_keys - valid_top_level_keys include_all_operators = data get include_all_operators False assert isinstance include_all_operators bool debug_info = None debug_info data di_list = data debug_info assert isinstance di_list list debug_info = tuple str x x di_list operators = operators_dict = data get operators assert isinstance operators_dict dict k v operators_dict items operators k = SelectiveBuildOperator from_yaml_dict k v kernel_metadata = kernel_metadata_dict = data get kernel_metadata assert isinstance kernel_metadata_dict dict k v kernel_metadata_dict items kernel_metadata str k = str dtype dtype v et_kernel_metadata = data get et_kernel_metadata assert isinstance et_kernel_metadata dict custom_classes = data get custom_classes assert isinstance custom_classes Iterable custom_classes = set custom_classes build_features = data get build_features assert isinstance build_features Iterable build_features = set build_features include_all_non_op_selectives = data get include_all_non_op_selectives False assert isinstance include_all_non_op_selectives bool SelectiveBuilder include_all_operators debug_info operators kernel_metadata et_kernel_metadata custom_classes type ignore arg-type build_features type ignore arg-type include_all_non_op_selectives staticmethod from_yaml_str config_contents str - SelectiveBuilder contents = yaml safe_load config_contents SelectiveBuilder from_yaml_dict contents staticmethod from_yaml_path config_path str - SelectiveBuilder open config_path f contents = yaml safe_load f SelectiveBuilder from_yaml_dict contents staticmethod from_legacy_op_registration_allow_list allow_list set str is_root_operator bool is_used_for_training bool - SelectiveBuilder operators = op allow_list operators op = name op is_root_operator is_root_operator is_used_for_training is_used_for_training include_all_overloads True SelectiveBuilder from_yaml_dict operators operators include_all_non_op_selectives True is_operator_selected name str - bool include_all_operators True name operators True name = strip_operator_overload_name name name operators operators name include_all_overloads is_native_function_selected func NativeFunction - bool op_name = op_name_from_native_function func is_operator_selected op_name is_operator_selected_for_training name str - bool is_operator_selected name False include_all_operators True not_training_op = SelectiveBuildOperator name= is_root_operator=False is_used_for_training=False include_all_overloads=False _debug_info=None op = not_training_op name operators op = operators name name = strip_operator_overload_name name base_op = not_training_op name operators base_op = operators name op is_used_for_training base_op include_all_overloads base_op is_used_for_training is_native_function_selected_for_training func NativeFunction - bool op_name = op_name_from_native_function func is_operator_selected_for_training op_name is_root_operator name str - bool is_operator_selected name False include_all_operators True name operators op SelectiveBuildOperator = operators name op is_root_operator name = strip_operator_overload_name name name operators False base_op SelectiveBuildOperator = operators name base_op include_all_overloads base_op is_root_operator is_kernel_dtype_selected kernel_tag str dtype str - bool include_all_operators include_all_non_op_selectives True kernel_tag kernel_metadata dtype kernel_metadata kernel_tag et_get_selected_kernels op_name str kernel_key list str - list str Return list kernel keys cover used ops If no kernel metadata either s implied include_all_operators=True op used op_name et_kernel_metadata kernel_key include_all_operators Otherwise only specific kernel keys result_set = set model_kernel_keys et_kernel_metadata op_name key_found = False key kernel_key Don t compare version now key = default key split == model_kernel_keys split result_set add key key_found = True break key_found default kernel_key raise Exception Missing kernel model noqa TRY result_set add default list result_set to_dict - dict str object ret dict str object = include_all_non_op_selectives include_all_non_op_selectives include_all_operators include_all_operators operators = op_name op operators items operators op_name = op to_dict ret operators = operators _debug_info None ret debug_info = sorted _debug_info ret kernel_metadata = k sorted v k v kernel_metadata items ret et_kernel_metadata = et_kernel_metadata ret custom_classes = sorted custom_classes ret build_features = sorted build_features ret merge_kernel_metadata lhs dict str list str rhs dict str list str - dict str list str kernel_metadata dict str list str = tag_name dtypes list lhs items + list rhs items dtypes_copy = set dtypes tag_name kernel_metadata dtypes_copy &#124; = set kernel_metadata tag_name kernel_metadata tag_name = list dtypes_copy kernel_metadata merge_et_kernel_metadata lhs dict str list str rhs dict str list str - dict str list str merge_et_kernel_metadata dict str set str = defaultdict set op list lhs keys + list rhs keys merge_et_kernel_metadata op update lhs get op merge_et_kernel_metadata op update rhs get op op sorted val op val merge_et_kernel_metadata items combine_selective_builders lhs SelectiveBuilder rhs SelectiveBuilder - SelectiveBuilder include_all_operators = lhs include_all_operators rhs include_all_operators debug_info = merge_debug_info lhs _debug_info rhs _debug_info operators = merge_operator_dicts lhs operators rhs operators kernel_metadata = merge_kernel_metadata lhs kernel_metadata rhs kernel_metadata et_kernel_metadata = merge_et_kernel_metadata lhs et_kernel_metadata rhs et_kernel_metadata include_all_non_op_selectives = lhs include_all_non_op_selectives rhs include_all_non_op_selectives custom_classes = lhs custom_classes union rhs custom_classes build_features = lhs build_features union rhs build_features SelectiveBuilder include_all_operators debug_info operators kernel_metadata et_kernel_metadata custom_classes build_features include_all_non_op_selectives op_name_from_native_function f NativeFunction - str This originally read operator_name_with_overload field declaration dict which part before first schema_string f f namespace f func name
Owner s oncall package deploy pickle io BytesIO sys version_info textwrap dedent unittest skipIf torch torch package PackageExporter PackageImporter sys_importer torch testing _internal common_utils run_tests try common PackageTestCase except ImportError Support case where we run file directly common PackageTestCase pathlib Path packaging_directory = Path __file__ parent TestSaveLoad PackageTestCase Core save_ loading API tests test_saving_source buffer = BytesIO PackageExporter buffer he he save_source_file foo str packaging_directory module_a py he save_source_file foodir str packaging_directory package_a buffer seek hi = PackageImporter buffer foo = hi import_module foo s = hi import_module foodir subpackage assertEqual foo result module_a assertEqual s result package_a subpackage test_saving_string buffer = BytesIO PackageExporter buffer he src = dedent \ math the_math = math he save_source_string my_mod src buffer seek hi = PackageImporter buffer m = hi import_module math math assertIs m math my_mod = hi import_module my_mod assertIs my_mod math math test_save_module buffer = BytesIO PackageExporter buffer he module_a package_a he save_module module_a __name__ he save_module package_a __name__ buffer seek hi = PackageImporter buffer module_a_i = hi import_module module_a assertEqual module_a_i result module_a assertIsNot module_a module_a_i package_a_i = hi import_module package_a assertEqual package_a_i result package_a assertIsNot package_a_i package_a test_dunder_imports buffer = BytesIO PackageExporter buffer he package_b obj = package_b PackageBObject he intern he save_pickle res obj pkl obj buffer seek hi = PackageImporter buffer hi load_pickle res obj pkl package_b = hi import_module package_b assertEqual package_b result package_b math = hi import_module math assertEqual math __name__ math xml_sub_sub_package = hi import_module xml sax xmlreader assertEqual xml_sub_sub_package __name__ xml sax xmlreader subpackage_ = hi import_module package_b subpackage_ assertEqual subpackage_ result subpackage_ subpackage_ = hi import_module package_b subpackage_ assertEqual subpackage_ result subpackage_ subsubpackage_ = hi import_module package_b subpackage_ subsubpackage_ assertEqual subsubpackage_ result subsubpackage_ test_bad_dunder_imports Test ensure bad __imports__ don t cause PackageExporter fail buffer = BytesIO PackageExporter buffer e e save_source_string m __import__ these unresolvable things wont crash me test_save_module_binary f = BytesIO PackageExporter f he module_a package_a he save_module module_a __name__ he save_module package_a __name__ f seek hi = PackageImporter f module_a_i = hi import_module module_a assertEqual module_a_i result module_a assertIsNot module_a module_a_i package_a_i = hi import_module package_a assertEqual package_a_i result package_a assertIsNot package_a_i package_a test_pickle package_a subpackage obj = package_a subpackage PackageASubpackageObject obj = package_a PackageAObject obj buffer = BytesIO PackageExporter buffer he he intern he save_pickle obj obj pkl obj buffer seek hi = PackageImporter buffer check we got dependencies sp = hi import_module package_a subpackage check we didn t get other stuff assertRaises ImportError hi import_module module_a obj_loaded = hi load_pickle obj obj pkl assertIsNot obj obj_loaded assertIsInstance obj_loaded obj sp PackageASubpackageObject assertIsNot package_a subpackage PackageASubpackageObject sp PackageASubpackageObject test_pickle_long_name_with_protocol_ package_a long_name container = Indirectly grab function avoid pasting character function into test package_a long_name add_function container buffer = BytesIO PackageExporter buffer exporter exporter intern exporter save_pickle container container pkl container pickle_protocol= buffer seek importer = PackageImporter buffer unpickled_container = importer load_pickle container container pkl assertIsNot container unpickled_container assertEqual len unpickled_container assertEqual container unpickled_container test_exporting_mismatched_code If object same qualified name loaded different packages user should get error they try re-save object wrong package s source code package_a subpackage obj = package_a subpackage PackageASubpackageObject obj = package_a PackageAObject obj b = BytesIO PackageExporter b pe pe intern pe save_pickle obj obj pkl obj b seek importer = PackageImporter b loaded = importer load_pickle obj obj pkl b seek importer = PackageImporter b loaded = importer load_pickle obj obj pkl make_exporter pe = PackageExporter BytesIO importer= importer sys_importer Ensure importer finds PackageAObject defined importer first pe This succeeds because OrderedImporter get_name properly falls back sys_importer which can find original PackageAObject pe = make_exporter pe save_pickle obj obj pkl obj This should also fail The PackageAObject type defined importer necessarily same one defined importer pe = make_exporter assertRaises pickle PicklingError pe save_pickle obj obj pkl loaded This should succeed The PackageAObject type defined importer match one used loaded pe = make_exporter pe save_pickle obj obj pkl loaded test_save_imported_module Saving module came another PackageImporter should work package_a subpackage obj = package_a subpackage PackageASubpackageObject obj = package_a PackageAObject obj buffer = BytesIO PackageExporter buffer exporter exporter intern exporter save_pickle model model pkl obj buffer seek importer = PackageImporter buffer imported_obj = importer load_pickle model model pkl imported_obj _module = imported_obj __class__ __module__ Should export without error buffer = BytesIO PackageExporter buffer importer= importer sys_importer exporter exporter intern exporter save_module imported_obj _module test_save_imported_module_using_package_importer Exercise corner case re-packaging module uses ` torch_package_importer ` package_a use_torch_package_importer noqa F buffer = BytesIO PackageExporter buffer exporter exporter intern exporter save_module package_a use_torch_package_importer buffer seek importer = PackageImporter buffer Should export without error buffer = BytesIO PackageExporter buffer importer= importer sys_importer exporter exporter intern exporter save_module package_a use_torch_package_importer skipIf version_info = https github com pytorch pytorch issues test_save_load_fp tensor = torch rand torch float _e m fn buffer = BytesIO PackageExporter buffer exporter exporter save_pickle fp _model model pkl tensor buffer seek importer = PackageImporter buffer loaded_tensor = importer load_pickle fp _model model pkl assertTrue torch equal tensor loaded_tensor __name__ == __main__ run_tests
Owner s oncall quantization ruff noqa F unittest torch torch ao nn quantized nnq torch nn nn torch ao ns _numeric_suite compare_model_outputs compare_model_stub compare_weights get_matching_activations OutputLogger prepare_model_outputs Shadow ShadowLogger torch ao quantization convert default_qconfig DeQuantStub prepare quantize quantize_dynamic QuantStub torch testing _internal common_quantization AnnotatedConvBnReLUModel AnnotatedConvModel AnnotatedConvTransposeModel AnnotatedSingleLayerLinearModel AnnotatedTwoLayerLinearModel LSTMwithHiddenDynamicModel QuantizationTestCase SingleLayerLinearDynamicModel skip_if_no_torchvision test_only_eval_fn torch testing _internal common_quantized override_qengines torch testing _internal common_utils IS_ARM raise_on_run_directly SubModule torch nn Module __init__ - None super __init__ qconfig = default_qconfig mod = torch nn Conv d bias=False dtype=torch float mod = nn ReLU quant = QuantStub dequant = DeQuantStub forward x x = quant x x = mod x x = mod x x = dequant x x ModelWithSubModules torch nn Module __init__ - None super __init__ mod = SubModule conv = torch nn Conv d bias=False dtype=torch float forward x x = mod x x = conv x x ModelWithFunctionals torch nn Module __init__ - None super __init__ mycat = nnq FloatFunctional myadd = nnq FloatFunctional mymul = nnq FloatFunctional myadd_relu = nnq FloatFunctional my_scalar_add = nnq FloatFunctional my_scalar_mul = nnq FloatFunctional quant = QuantStub dequant = DeQuantStub forward x x = quant x x = mycat cat x x x x = myadd add x x x = mymul mul x x x = myadd_relu add_relu x x w = my_scalar_add add_scalar x - w = my_scalar_mul mul_scalar w w = dequant w w TestNumericSuiteEager QuantizationTestCase override_qengines test_compare_weights_conv_static r Compare weights float static quantized conv layer qengine = torch backends quantized engine compare_and_validate_results float_model q_model weight_dict = compare_weights float_model state_dict q_model state_dict assertEqual len weight_dict v weight_dict values assertTrue v float shape == v quantized shape model_list = AnnotatedConvModel qengine AnnotatedConvBnReLUModel qengine model model_list model eval hasattr model fuse_model model fuse_model q_model = quantize model test_only_eval_fn img_data_ d compare_and_validate_results model q_model override_qengines test_compare_weights_linear_static r Compare weights float static quantized linear layer qengine = torch backends quantized engine compare_and_validate_results float_model q_model weight_dict = compare_weights float_model state_dict q_model state_dict assertEqual len weight_dict v weight_dict values assertTrue v float shape == v quantized shape model_list = AnnotatedSingleLayerLinearModel qengine model model_list model eval hasattr model fuse_model model fuse_model q_model = quantize model test_only_eval_fn calib_data compare_and_validate_results model q_model override_qengines test_compare_weights_linear_dynamic r Compare weights float dynamic quantized linear layer qengine = torch backends quantized engine compare_and_validate_results float_model q_model weight_dict = compare_weights float_model state_dict q_model state_dict assertEqual len weight_dict v weight_dict values assertTrue len v float == len v quantized i val enumerate v quantized assertTrue v float i shape == val shape model_list = SingleLayerLinearDynamicModel qengine model model_list model eval hasattr model fuse_model model fuse_model q_model = quantize_dynamic model compare_and_validate_results model q_model override_qengines test_compare_weights_lstm_dynamic r Compare weights float dynamic quantized LSTM layer qengine = torch backends quantized engine compare_and_validate_results float_model q_model weight_dict = compare_weights float_model state_dict q_model state_dict assertEqual len weight_dict v weight_dict values assertTrue len v float == len v quantized i val enumerate v quantized assertTrue v float i shape == val shape model_list = LSTMwithHiddenDynamicModel qengine model model_list model eval hasattr model fuse_model model fuse_model q_model = quantize_dynamic model compare_and_validate_results model q_model override_qengines test_compare_model_stub_conv_static r Compare output static quantized conv layer its float shadow module qengine = torch backends quantized engine compare_and_validate_results float_model q_model module_swap_list data ob_dict = compare_model_stub float_model q_model module_swap_list data assertEqual len ob_dict v ob_dict values assertTrue len v float == len v quantized i val enumerate v quantized assertTrue v float i shape == val shape model_list = AnnotatedConvModel qengine AnnotatedConvTransposeModel qnnpack ConvT cannot use per channel weights AnnotatedConvBnReLUModel qengine module_swap_list = nn Conv d nn intrinsic modules fused ConvReLU d nn ConvTranspose d model model_list model eval hasattr model fuse_model model fuse_model q_model = quantize model test_only_eval_fn img_data_ d compare_and_validate_results model q_model module_swap_list img_data_ d override_qengines test_compare_model_stub_linear_static r Compare output static quantized linear layer its float shadow module qengine = torch backends quantized engine compare_and_validate_results float_model q_model module_swap_list data ob_dict = compare_model_stub float_model q_model module_swap_list data assertEqual len ob_dict v ob_dict values assertTrue len v float == len v quantized i val enumerate v quantized assertTrue v float i shape == val shape linear_data = calib_data module_swap_list = nn Linear model_list = AnnotatedSingleLayerLinearModel qengine model model_list model eval hasattr model fuse_model model fuse_model q_model = quantize model test_only_eval_fn calib_data compare_and_validate_results model q_model module_swap_list linear_data override_qengines test_compare_model_stub_partial r Compare output static quantized linear layer its float shadow module qengine = torch backends quantized engine TODO Rebase top PR remove compare validate results here compare_and_validate_results float_model q_model module_swap_list data ob_dict = compare_model_stub float_model q_model module_swap_list data assertEqual len ob_dict v ob_dict values assertTrue len v float == len v quantized i val enumerate v quantized assertTrue v float i shape == val shape linear_data = calib_data module_swap_list = nn Linear model_list = AnnotatedTwoLayerLinearModel model model_list model eval hasattr model fuse_model model fuse_model q_model = quantize model test_only_eval_fn calib_data compare_and_validate_results model q_model module_swap_list linear_data override_qengines test_compare_model_stub_submodule_static r Compare output static quantized submodule its float shadow module qengine = torch backends quantized engine model = ModelWithSubModules eval q_model = quantize model test_only_eval_fn img_data_ d module_swap_list = SubModule nn Conv d ob_dict = compare_model_stub model q_model module_swap_list img_data_ d Since conv quantized we do insert shadow module mod contains linear quantized so we insert shadow module assertTrue isinstance q_model mod Shadow assertFalse isinstance q_model conv Shadow override_qengines test_compare_model_stub_functional_static r Compare output static quantized functional layer its float shadow module qengine = torch backends quantized engine model = ModelWithFunctionals eval model qconfig = torch ao quantization get_default_qconfig fbgemm q_model = prepare model inplace=False q_model img_data_ d q_model = convert q_model module_swap_list = nnq FloatFunctional ob_dict = compare_model_stub model q_model module_swap_list img_data_ d assertEqual len ob_dict assertTrue isinstance q_model mycat Shadow assertTrue isinstance q_model myadd Shadow assertTrue isinstance q_model mymul Shadow assertTrue isinstance q_model myadd_relu Shadow assertTrue isinstance q_model my_scalar_add Shadow assertTrue isinstance q_model my_scalar_mul Shadow v ob_dict values assertTrue len v float == len v quantized i val enumerate v quantized assertTrue v float i shape == val shape override_qengines test_compare_model_stub_linear_dynamic r Compare output dynamic quantized linear layer its float shadow module qengine = torch backends quantized engine compare_and_validate_results float_model q_model module_swap_list data ob_dict = compare_model_stub float_model q_model module_swap_list data assertEqual len ob_dict v ob_dict values assertTrue len v float == len v quantized i val enumerate v quantized assertTrue v float i shape == val shape linear_data = calib_data model_list = SingleLayerLinearDynamicModel qengine module_swap_list = nn Linear nn LSTM model model_list model eval hasattr model fuse_model model fuse_model q_model = quantize_dynamic model compare_and_validate_results model q_model module_swap_list linear_data override_qengines test_compare_model_stub_lstm_dynamic r Compare output dynamic quantized LSTM layer its float shadow module qengine = torch backends quantized engine compare_and_validate_results float_model q_model module_swap_list input hidden ob_dict = compare_model_stub float_model q_model module_swap_list input hidden assertEqual len ob_dict v ob_dict values assertTrue len v float == len v quantized i val enumerate v quantized assertTrue v float i shape == val shape lstm_input = torch rand lstm_hidden = torch rand torch rand model_list = LSTMwithHiddenDynamicModel qengine module_swap_list = nn Linear nn LSTM model model_list model eval hasattr model fuse_model model fuse_model q_model = quantize_dynamic model compare_and_validate_results model q_model module_swap_list lstm_input lstm_hidden override_qengines test_compare_model_outputs_conv_static r Compare output conv layer stataic quantized model corresponding output conv layer float model qengine = torch backends quantized engine compare_and_validate_results float_model q_model data act_compare_dict = compare_model_outputs float_model q_model data expected_act_compare_dict_keys = conv stats quant stats assertTrue act_compare_dict keys == expected_act_compare_dict_keys v act_compare_dict values assertTrue v float shape == v quantized shape model_list = AnnotatedConvModel qengine AnnotatedConvBnReLUModel qengine model model_list model eval hasattr model fuse_model model fuse_model q_model = quantize model test_only_eval_fn img_data_ d compare_and_validate_results model q_model img_data_ d override_qengines test_compare_model_outputs_linear_static r Compare output linear layer static quantized model corresponding output conv layer float model qengine = torch backends quantized engine compare_and_validate_results float_model q_model data act_compare_dict = compare_model_outputs float_model q_model data expected_act_compare_dict_keys = fc quant stats fc module stats assertTrue act_compare_dict keys == expected_act_compare_dict_keys v act_compare_dict values assertTrue len v float == len v quantized i val enumerate v quantized assertTrue v float i shape == val shape linear_data = calib_data model_list = AnnotatedSingleLayerLinearModel qengine model model_list model eval hasattr model fuse_model model fuse_model q_model = quantize model test_only_eval_fn calib_data compare_and_validate_results model q_model linear_data override_qengines test_compare_model_outputs_functional_static r Compare output functional layer static quantized model corresponding output conv layer float model qengine = torch backends quantized engine model = ModelWithFunctionals eval model qconfig = torch ao quantization get_default_qconfig fbgemm q_model = prepare model inplace=False q_model img_data_ d q_model = convert q_model act_compare_dict = compare_model_outputs model q_model img_data_ d assertEqual len act_compare_dict expected_act_compare_dict_keys = mycat stats myadd stats mymul stats myadd_relu stats quant stats assertTrue act_compare_dict keys == expected_act_compare_dict_keys v act_compare_dict values assertTrue len v float == len v quantized i val enumerate v quantized assertTrue v float i shape == val shape override_qengines test_compare_model_outputs_linear_dynamic r Compare output linear layer dynamic quantized model corresponding output conv layer float model qengine = torch backends quantized engine compare_and_validate_results float_model q_model data act_compare_dict = compare_model_outputs float_model q_model data expected_act_compare_dict_keys = fc stats assertTrue act_compare_dict keys == expected_act_compare_dict_keys v act_compare_dict values assertTrue len v float == len v quantized i val enumerate v quantized assertTrue v float i shape == val shape linear_data = calib_data model_list = SingleLayerLinearDynamicModel qengine model model_list model eval hasattr model fuse_model model fuse_model q_model = quantize_dynamic model compare_and_validate_results model q_model linear_data override_qengines test_compare_model_outputs_lstm_dynamic r Compare output LSTM layer dynamic quantized model corresponding output conv layer float model qengine = torch backends quantized engine compare_and_validate_results float_model q_model input hidden act_compare_dict = compare_model_outputs float_model q_model input hidden expected_act_compare_dict_keys = lstm stats assertTrue act_compare_dict keys == expected_act_compare_dict_keys v act_compare_dict values assertTrue len v float == len v quantized i val enumerate v quantized assertTrue len v float i == len val i == assertTrue v float i shape == val shape assertTrue v float i shape == val shape assertTrue v float i shape == val shape lstm_input = torch rand lstm_hidden = torch rand torch rand model_list = LSTMwithHiddenDynamicModel qengine model model_list model eval hasattr model fuse_model model fuse_model q_model = quantize_dynamic model compare_and_validate_results model q_model lstm_input lstm_hidden override_qengines test_output_logger r Compare output OutputLogger expected results x = torch rand y = torch rand l = l append x l append y logger = OutputLogger logger forward x logger forward y assertEqual l logger stats tensor_val override_qengines test_shadow_logger r Compare output ShawdowLogger expected results a_float = torch rand a_quantized = torch rand b_float = torch rand b_quantized = torch rand logger = ShadowLogger logger forward a_float a_quantized logger forward b_float b_quantized assertEqual len logger stats float assertEqual len logger stats quantized skip_if_no_torchvision _test_vision_model float_model float_model cpu float_model eval float_model fuse_model float_model qconfig = torch ao quantization default_qconfig img_data = torch rand dtype=torch float torch randint dtype=torch long _ range qmodel = quantize float_model torch ao quantization default_eval_fn img_data inplace=False wt_compare_dict = compare_weights float_model state_dict qmodel state_dict compute_error x y Ps = torch norm x Pn = torch norm x - y torch log Ps Pn data = img_data Take floating point quantized model well input data returns dict keys corresponding quantized module names each entry being dictionary two keys float quantized containing activations floating point quantized model matching locations act_compare_dict = compare_model_outputs float_model qmodel data key act_compare_dict compute_error act_compare_dict key float act_compare_dict key quantized dequantize prepare_model_outputs float_model qmodel data img_data float_model data qmodel data Find matching activation between floating point quantized modules dict key corresponding quantized module names each entry being dictionary two keys float quantized containing matching floating point quantized activations logged logger act_compare_dict = get_matching_activations float_model qmodel skip_if_no_torchvision unittest skipIf IS_ARM Not working arm right now test_mobilenet_v torchvision models quantization mobilenet_v _test_vision_model mobilenet_v pretrained=True quantize=False skip_if_no_torchvision unittest skipIf IS_ARM Not working arm right now test_mobilenet_v torchvision models quantization mobilenet_v _large _test_vision_model mobilenet_v _large pretrained=True quantize=False __name__ == __main__ raise_on_run_directly test test_quantization py
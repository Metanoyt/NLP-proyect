usr bin env python Owner s oncall r p Copyright c Facebook Inc its affiliates All rights reserved This source code licensed under BSD-style license found LICENSE file root directory source tree argparse os torch torch distributed dist torch nn functional F parse_args parser = argparse ArgumentParser description= test script parser add_argument -- init-method -- init_method type=str required=True help= init_method pass ` dist init_process_group ` e g env parser add_argument -- world-size -- world_size type=int default=os getenv WORLD_SIZE - help= world_size pass ` dist init_process_group ` parser add_argument -- rank type=int default=os getenv RANK - help= rank pass ` dist init_process_group ` parser parse_args main args = parse_args dist init_process_group backend= gloo init_method=args init_method world_size=args world_size rank=args rank rank = dist get_rank world_size = dist get_world_size one hot rank tensor size world_size example rank world_size = rank world_size = t = F one_hot torch tensor rank num_classes=world_size after all_reduce t = tensor ones size=world_size dist all_reduce t adding all elements t should equal world_size derived_world_size = torch sum t item derived_world_size = world_size raise RuntimeError f Wrong world size derived Expected world_size Got derived_world_size print Done __name__ == __main__ main
os tempfile unittest pathlib Path unittest mock MagicMock patch cli lib core vllm vllm_build vllm_build _VLLM_BUILD_MODULE = cli lib core vllm vllm_build TestVllmBuildParameters unittest TestCase patch f _VLLM_BUILD_MODULE local_image_exists return_value=True patch f _VLLM_BUILD_MODULE is_path_exist return_value=True patch cli lib common envs_helper env_path_optional side_effect=lambda name default=None resolve=True DOCKERFILE_PATH Path abs vllm Dockerfile TORCH_WHEELS_PATH Path abs dist OUTPUT_DIR Path abs shared get name Path default default None None patch dict os environ USE_TORCH_WHEEL USE_LOCAL_BASE_IMAGE USE_LOCAL_DOCKERFILE BASE_IMAGE my image tag DOCKERFILE_PATH vllm Dockerfile TORCH_WHEELS_PATH dist OUTPUT_DIR shared clear=True test_params_success_normalizes_and_validates mock_env_path mock_is_path mock_local_img params = vllm_build VllmBuildParameters assertEqual params torch_whls_path Path abs dist assertEqual params dockerfile_path Path abs vllm Dockerfile assertEqual params output_dir Path abs shared assertEqual params base_image my image tag patch f _VLLM_BUILD_MODULE is_path_exist return_value=False patch dict os environ USE_TORCH_WHEEL TORCH_WHEELS_PATH dist clear=True test_params_missing_torch_whls_raises _is_path tempfile TemporaryDirectory td os chdir td assertRaises ValueError cm vllm_build VllmBuildParameters use_local_base_image=False use_local_dockerfile=False err = cm exception assertIn TORCH_WHEELS_PATH str err patch f _VLLM_BUILD_MODULE local_image_exists return_value=False patch dict os environ USE_LOCAL_BASE_IMAGE BASE_IMAGE img tag clear=True test_params_missing_local_base_image_raises _local_img tempfile TemporaryDirectory td os chdir td assertRaises ValueError cm vllm_build VllmBuildParameters use_torch_whl=False use_local_dockerfile=False err = cm exception assertIn BASE_IMAGE str err patch f _VLLM_BUILD_MODULE is_path_exist return_value=False patch dict os environ USE_LOCAL_DOCKERFILE DOCKERFILE_PATH Dockerfile clear=True test_params_missing_dockerfile_raises _is_path tempfile TemporaryDirectory td os chdir td assertRaises ValueError cm vllm_build VllmBuildParameters use_torch_whl=False use_local_base_image=False err = cm exception assertIn DOCKERFILE_PATH str err patch f _VLLM_BUILD_MODULE is_path_exist return_value=False patch dict os environ OUTPUT_DIR clear=True test_params_missing_output_dir _is_path assertRaises FileNotFoundError vllm_build VllmBuildParameters TestBuildCmdAndRun unittest TestCase patch f _VLLM_BUILD_MODULE local_image_exists return_value=True test_generate_docker_build_cmd_includes_bits _exists runner = vllm_build VllmBuildRunner inputs = MagicMock inputs output_dir = Path abs out inputs use_local_base_image = True inputs base_image = img tag inputs torch_whls_path = Path vllm tmp inputs max_jobs = inputs cuda_version = inputs python_version = inputs sccache_bucket = my-bucket inputs sccache_region = us-west- inputs torch_cuda_arch_list = inputs target_stage = export-wheels inputs tag_name = vllm-wheels cmd = runner _generate_docker_build_cmd inputs squashed = join cmd split assertIn -- output type=local dest= abs out squashed assertIn -f docker Dockerfile nightly_torch squashed assertIn -- pull=false squashed assertIn -- build-arg TORCH_WHEELS_PATH=tmp squashed assertIn -- build-arg BUILD_BASE_IMAGE=img tag squashed assertIn -- build-arg FINAL_BASE_IMAGE=img tag squashed assertIn -- build-arg max_jobs= squashed assertIn -- build-arg CUDA_VERSION= squashed assertIn -- build-arg PYTHON_VERSION= squashed assertIn -- build-arg USE_SCCACHE= squashed assertIn -- build-arg SCCACHE_BUCKET_NAME=my-bucket squashed assertIn -- build-arg SCCACHE_REGION_NAME=us-west- squashed assertIn -- build-arg torch_cuda_arch_list= squashed assertIn -- target export-wheels squashed assertIn -t vllm-wheels squashed patch f _VLLM_BUILD_MODULE run_command patch f _VLLM_BUILD_MODULE ensure_dir_exists patch f _VLLM_BUILD_MODULE clone_vllm patch object vllm_build VllmBuildRunner _generate_docker_build_cmd return_value= docker buildx patch dict os environ USE_TORCH_WHEEL USE_LOCAL_BASE_IMAGE USE_LOCAL_DOCKERFILE OUTPUT_DIR shared clear=True test_run_calls_clone_prepare_and_build mock_gen mock_clone mock_ensure mock_run params = MagicMock params output_dir = Path shared params use_local_dockerfile = False params use_torch_whl = False patch f _VLLM_BUILD_MODULE VllmBuildParameters return_value=params runner = vllm_build VllmBuildRunner runner run mock_clone assert_called_once mock_ensure assert_called_once_with Path shared mock_gen assert_called_once_with params mock_run assert_called_once _ kwargs = mock_run call_args assert kwargs get cwd == vllm
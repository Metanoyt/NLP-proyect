Owner s module dynamo contextlib torch torch fx torch _dynamo test_case TestCase torch _dynamo testing extract_graph_and_tracker torch utils _pytree tree_map GraphRegionTrackerTests TestCase setUp exit_stack = contextlib ExitStack exit_stack enter_context torch _dynamo config patch track_nodes_for_deduplication True super setUp tearDown exit_stack close super tearDown get_result fn args kwargs graph region_tracker = extract_graph_and_tracker fn args kwargs region_groups = region_tracker get_identical_regions graph region_groups = tree_map lambda n n name region_groups str region_groups get_mutation_tracking fn args kwargs _ region_tracker = extract_graph_and_tracker fn args kwargs str region_tracker node_to_mutated_arg_positions test_get_regions_single_region_group inner_fn x y x = x + y = y + z = x sum + y sum z fn x y o = inner_fn x y o = torch sin y o = inner_fn x o o = inner_fn x y o = o o o o + o assertExpectedInline get_result fn torch rand torch ones x y sum_ sum_ z x _ y _ sum_ sum_ z_ \ x _ y _ sum_ sum_ z_ test_get_regions_multiple_region_groups inner_fn x y x = x + y = y + z = x sum + y sum z inner_fn b += b += c = b cos sum c fn x y x = torch cos x y = torch sin y o = inner_fn x y o = inner_fn x y o = torch sin o o = inner_fn x y o = inner_fn x y o = inner_fn x y o o + o assertExpectedInline get_result fn torch rand torch ones x y sum_ sum_ z x _ y _ sum_ sum_ z_ \ x _ y _ sum_ sum_ z_ b cos_ sum_ c a_ b_ cos_ sum_ c_ test_no_single_node_regions inner_fn x x + fn x o = inner_fn x o = inner_fn x o = inner_fn x o + o + o assertExpectedInline get_result fn torch ones test_mismatched_arg_shapes inner_fn x y x = x + y = y + z = x sum + y sum z inner_fn b += b += c = b cos sum c fn x y x = torch cos x y = torch sin y o = inner_fn x y o = inner_fn x o o = torch sin o o = inner_fn x y o = inner_fn o y o = inner_fn x y o o + o assertExpectedInline get_result fn torch rand torch ones y _ sum_ y _ sum_ x sum_ z x _ sum_ z_ \ x _ sum_ z_ b cos_ sum_ b_ cos_ sum_ test_mismatched_dtypes inner_fn x y x = x y = y + x + y sum fn x y x = torch sin x y = torch cos y o = inner_fn x y o = inner_fn x y o = inner_fn x y o = inner_fn x y o = inner_fn x torch bfloat y torch bfloat o = o + o o o + o + o assertExpectedInline get_result fn torch rand torch ones x y sum_ o x _ y _ sum_ o \ x _ y _ sum_ o x _ y _ sum_ o test_nested_args inner_fn xs ys out = torch _foreach_add xs ys out + out sum fn x y z x = torch sin x y = torch cos y z = torch sin z o = inner_fn x z x y o = inner_fn x z x y o = inner_fn x z x y o = inner_fn x z x y o = inner_fn x torch bfloat z torch bfloat x torch bfloat y torch bfloat o = o + o o o + o + o assertExpectedInline get_result fn torch rand torch rand torch ones _foreach_add getitem getitem_ sum_ o _foreach_add_ \ getitem_ getitem_ sum_ o _foreach_add_ getitem_ getitem_ sum_ \ o _foreach_add_ getitem_ getitem_ sum_ o test_mismatched_global_state inner_fn x y x = x y = y + x + y sum fn x y c x = torch sin x y = torch cos y o = inner_fn x y o = inner_fn x y isinstance c tuple c o = inner_fn x y o = inner_fn x y c c o = inner_fn x y o = inner_fn x y o + o + o + o create_toggle_fns property old_value = getattr torch backends cuda matmul property toggle_property setattr torch backends cuda matmul property old_value reset_property setattr torch backends cuda matmul property old_value toggle_property reset_property old_dtype = torch get_default_dtype set_default_dtype_bfloat torch set_default_dtype torch bfloat reset_default_dtype torch set_default_dtype old_dtype ctx lambda torch set_grad_enabled False torch autograd grad_mode inference_mode lambda torch autograd graph disable_saved_tensors_hooks This supported lambda torch set_num_threads Unsupported set_default_dtype_bfloat reset_default_dtype lambda torch use_deterministic_algorithms True lambda torch use_deterministic_algorithms False lambda torch use_deterministic_algorithms True warn_only=True lambda torch use_deterministic_algorithms False Unsupported create_toggle_fns allow_bf _reduced_precision_reduction create_toggle_fns allow_fp _reduced_precision_reduction create_toggle_fns allow_tf assertExpectedInline get_result fn torch rand torch ones ctx x _ y _ sum_ o x _ y _ sum_ o \ x y sum_ o x _ y _ sum_ o test_mutation_tracking_simple fn x y z x = torch sin x y = torch cos y z sin_ y add_ z x sum + y sum assertExpectedInline get_mutation_tracking fn torch rand torch rand torch ones sin_ OrderedSet add_ OrderedSet test_mutation_tracking_setitem fn x y = x + y = y assertExpectedInline get_mutation_tracking fn torch rand setitem OrderedSet test_mutation_tracking_allow_in_graph torch _dynamo allow_in_graph fn_mut x y x add_ y x sum + y sum fn x y z = x + y o = fn_mut z y z sin_ x + o assertExpectedInline get_mutation_tracking fn torch rand torch rand o OrderedSet sin_ OrderedSet test_non_tensor_arg_hashing inner x w t y = x + x torch conv d y w None t fn x y o = inner x y o = inner x y o = inner x y o = inner x y o sum + o sum + o sum + o sum assertExpectedInline get_result fn torch rand torch nn Parameter torch rand y o y_ o y_ o test_region_sorting torch _dynamo graph_region_tracker _sort_with_ref_region index_to_rank = regions = _sort_with_ref_region index_to_rank regions assertExpectedInline regions test_no_duplicate_tracking inner_fn x y x = x + y = y + z = x sum + y sum z fn x y o = inner_fn x y o = torch sin y o = inner_fn x o o = inner_fn x y o = o o o o + o graph tracker = extract_graph_and_tracker fn torch rand torch ones assertExpectedInline tracker node_to_duplicates l_x_ l_x_ x x x _ x _ l_y_ l_y_ y y y _ y _ sum_ \ sum_ sum_ sum_ sum_ sum_ sum_ sum_ z z z_ z_ o o x _ x x _ x _ y _ y y _ y _ \ sum_ sum_ sum_ sum_ sum_ sum_ sum_ sum_ \ z_ z z_ z_ x _ x x _ x _ y _ y y _ y _ sum_ sum_ sum_ sum_ sum_ sum_ sum_ sum_ \ z_ z z_ z_ o o mul_ mul_ add_ add_ key = next iter tracker node_to_duplicates keys tracker track_node None key will fail node added again __name__ == __main__ torch _dynamo test_case run_tests run_tests
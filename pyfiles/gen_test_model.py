io sys yaml android_api_module AndroidAPIModule builtin_ops TSBuiltinOpsModule TSCollectionOpsModule math_ops BlasLapackOpsModule ComparisonOpsModule OtherMathOpsModule PointwiseOpsModule ReductionOpsModule SpectralOpsModule nn_ops NNActivationModule NNConvolutionModule NNDistanceModule NNDropoutModule NNLinearModule NNLossFunctionModule NNNormalizationModule NNPaddingModule NNPoolingModule NNRecurrentModule NNShuffleModule NNSparseModule NNTransformerModule NNUtilsModule NNVisionModule quantization_ops FusedQuantModule GeneralQuantModule StaticQuantModule sampling_ops SamplingOpsModule tensor_ops TensorCreationOpsModule TensorIndexingOpsModule TensorOpsModule TensorTypingOpsModule TensorViewOpsModule torchvision_models MobileNetV Module MobileNetV VulkanModule Resnet Module torch torch jit mobile _load_for_lite_interpreter test_path_ios = ios TestApp models test_path_android = android pytorch_android src androidTest assets production_ops_path = test mobile model_test model_ops yaml coverage_out_path = test mobile model_test coverage yaml all_modules = math ops pointwise_ops PointwiseOpsModule reduction_ops ReductionOpsModule comparison_ops ComparisonOpsModule spectral_ops SpectralOpsModule other_math_ops OtherMathOpsModule blas_lapack_ops BlasLapackOpsModule sampling sampling_ops SamplingOpsModule tensor ops tensor_general_ops TensorOpsModule tensor_creation_ops TensorCreationOpsModule tensor_indexing_ops TensorIndexingOpsModule tensor_typing_ops TensorTypingOpsModule tensor_view_ops TensorViewOpsModule nn ops convolution_ops NNConvolutionModule pooling_ops NNPoolingModule padding_ops NNPaddingModule activation_ops NNActivationModule normalization_ops NNNormalizationModule recurrent_ops NNRecurrentModule transformer_ops NNTransformerModule linear_ops NNLinearModule dropout_ops NNDropoutModule sparse_ops NNSparseModule distance_function_ops NNDistanceModule loss_function_ops NNLossFunctionModule vision_function_ops NNVisionModule shuffle_ops NNShuffleModule nn_utils_ops NNUtilsModule quantization ops general_quant_ops GeneralQuantModule TODO sdym fb com fix re-enable dynamic_quant_ops dynamic_quant_ops DynamicQuantModule static_quant_ops StaticQuantModule fused_quant_ops FusedQuantModule TorchScript buildin ops torchscript_builtin_ops TSBuiltinOpsModule torchscript_collection_ops TSCollectionOpsModule vision mobilenet_v MobileNetV Module mobilenet_v _vulkan MobileNetV VulkanModule resnet Resnet Module android api module android_api_module AndroidAPIModule models_need_trace = static_quant_ops calcOpsCoverage ops open production_ops_path input_yaml_file production_ops_dict = yaml safe_load input_yaml_file production_ops = set production_ops_dict root_operators keys all_generated_ops = set ops covered_ops = production_ops intersection all_generated_ops uncovered_ops = production_ops - covered_ops coverage = round len covered_ops len production_ops weighted coverage take op occurrences into account total_occurrences = sum production_ops_dict root_operators values covered_ops_dict = op production_ops_dict root_operators op op covered_ops uncovered_ops_dict = op production_ops_dict root_operators op op uncovered_ops covered_occurrences = sum covered_ops_dict values occurrences_coverage = round covered_occurrences total_occurrences print f \n len uncovered_ops uncovered ops uncovered_ops \n print f Generated len all_generated_ops ops print f Covered len covered_ops len production_ops coverage production ops print f Covered covered_occurrences total_occurrences occurrences_coverage occurrences print f pytorch ver torch __version__ \n open coverage_out_path w f yaml safe_dump _covered_ops len covered_ops _production_ops len production_ops _generated_ops len all_generated_ops _uncovered_ops len uncovered_ops _coverage round coverage uncovered_ops uncovered_ops_dict covered_ops covered_ops_dict all_generated_ops sorted all_generated_ops f getModuleFromName model_name model_name all_modules print Cannot find test model + model_name None module = all_modules model_name isinstance module torch nn Module module = module getModule model_name models_need_trace module = torch jit trace module module = torch jit script module ops = torch jit export_opnames module print ops try run model runModule module module ops runModule module buffer = io BytesIO module _save_to_buffer_for_lite_interpreter buffer seek lite_module = _load_for_lite_interpreter buffer lite_module find_method get_all_bundled_inputs run first bundled input input = lite_module run_method get_all_bundled_inputs lite_module forward input assuming model has no input lite_module generate all models given folder If s fly mode add _temp suffix model file generateAllModels folder on_the_fly=False all_ops = name all_modules module ops = getModuleFromName name all_ops = all_ops + ops path = folder + name + _temp ptl on_the_fly ptl module _save_for_lite_interpreter path print model saved + path calcOpsCoverage all_ops generate update given model storage generateModel name module _ = getModuleFromName name module None path_ios = test_path_ios + name + ptl path_android = test_path_android + name + ptl module _save_for_lite_interpreter path_ios module _save_for_lite_interpreter path_android print model saved + path_ios + + path_android main argv argv None len argv = print This script generate models mobile test For each model we have storage version on-the-fly version The on-the-fly version will generated during test should committed repo The storage version back compatibility test model generated today should run master branch next months We can use script update model no longer supported - use python gen_test_model py android-test generate on-the-fly models android - use python gen_test_model py ios-test generate on-the-fly models ios - use python gen_test_model py android generate checked-in models android - use python gen_test_model py ios generate on-the-fly models ios - use python gen_test_model py model_name_no_suffix update given storage model argv == android generateAllModels test_path_android on_the_fly=False argv == ios generateAllModels test_path_ios on_the_fly=False argv == android-test generateAllModels test_path_android on_the_fly=True argv == ios-test generateAllModels test_path_ios on_the_fly=True generateModel argv __name__ == __main__ main sys argv
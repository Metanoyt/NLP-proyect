Owner s module dynamo unittest unittest mock Mock torch torch _dynamo test_case torch _dynamo testing torch _dynamo device_interface CudaInterface DeviceGuard torch testing _internal common_cuda TEST_CUDA TEST_MULTIGPU TestDeviceGuard torch _dynamo test_case TestCase Unit tests DeviceGuard using mock DeviceInterface setUp super setUp device_interface = Mock device_interface exchange_device = Mock return_value= device_interface maybe_exchange_device = Mock return_value= test_device_guard device_guard = DeviceGuard device_interface device_guard _ device_interface exchange_device assert_called_once_with assertEqual device_guard prev_idx assertEqual device_guard idx device_interface maybe_exchange_device assert_called_once_with assertEqual device_guard prev_idx assertEqual device_guard idx test_device_guard_no_index device_guard = DeviceGuard device_interface None device_guard _ device_interface exchange_device assert_not_called assertEqual device_guard prev_idx - assertEqual device_guard idx None device_interface maybe_exchange_device assert_not_called assertEqual device_guard prev_idx - assertEqual device_guard idx None unittest skipIf TEST_CUDA No CUDA available TestCUDADeviceGuard torch _dynamo test_case TestCase Unit tests DeviceGuard using CudaInterface setUp super setUp device_interface = CudaInterface unittest skipIf TEST_MULTIGPU need multiple GPU test_device_guard current_device = torch cuda current_device device_guard = DeviceGuard device_interface device_guard _ assertEqual torch cuda current_device assertEqual device_guard prev_idx assertEqual device_guard idx assertEqual torch cuda current_device current_device assertEqual device_guard prev_idx assertEqual device_guard idx test_device_guard_no_index current_device = torch cuda current_device device_guard = DeviceGuard device_interface None device_guard _ assertEqual torch cuda current_device current_device assertEqual device_guard prev_idx - assertEqual device_guard idx None assertEqual device_guard prev_idx - assertEqual device_guard idx None __name__ == __main__ torch _dynamo test_case run_tests run_tests
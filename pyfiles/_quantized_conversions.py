mypy allow-untyped-defs torch Pack pairs int values into int row major order first int value goes into lower order bits second int value into higher order bits resulting int value pack_int _to_int weight assert weight dim == assert weight shape == assert weight dtype == torch int weight xF &#124; weight xF Unpack quandruples bits int values into int values row major order lower bits go into first int value goes upper bits go into second int value unpack_int _to_int weight assert weight dim == assert weight dtype == torch int torch stack weight xF weight xF dim= view weight shape weight shape Transpose weight matrix then reorder its elements according underlying requirements CUTLASS library so could used CUTLASS-based mixed datatypes linear operation quantized_weight_reorder_for_mixed_dtypes_linear_cutlass weight dtypeq transpose=False assert weight dim == assert weight dtype == torch int assert dtypeq == torch int dtypeq == torch quint x assert weight device type == cuda device = weight device subbyte_transpose transpose dtypeq == torch int outp = weight T dtypeq == torch quint x outp = pack_int _to_int unpack_int _to_int weight view torch int T outp = weight ncols nrows = outp shape type ignore possibly-undefined assert nrows dtypeq == torch quint x == assert ncols == permute_B_rows_for_mixed_gemm permute cols actually transpose applied first here dtypeq == torch quint x cols_permuted = torch tensor device=device + torch arange nrows device=device reshape - expand nrows view - cols_permuted = torch tensor device=device + torch arange nrows device=device reshape - expand nrows view - pyrefly ignore unbound-name outp = outp index_copy cols_permuted outp interleave_column_major_tensor magic = dtypeq == torch quint x magic = magic tmp = torch arange ncols magic device=device nrows magic view - repeat nrows magic view - tmp = torch arange nrows magic device=device magic magic view - repeat magic view - repeat ncols tmp = torch arange magic device=device magic view - repeat nrows view - repeat ncols magic tmp = torch arange magic device=device repeat nrows ncols magic outp_offsets = tmp + tmp + tmp + tmp tmp = outp view - view torch int outp = torch zeros_like tmp outp scatter_ outp_offsets tmp outp = outp view weight dtype add_bias_and_interleave_quantized_tensor_inplace tmp = outp view - outp = torch empty_like tmp dtypeq == torch int tmp = tmp torch int + tmp dtype outp = tmp outp = tmp outp = tmp outp = tmp dtypeq == torch quint x tmp = tmp xF + xF tmp = tmp &#124; tmp tmp = tmp xF + xF tmp = tmp &#124; tmp outp = tmp outp = tmp outp = tmp outp = tmp dtypeq == torch quint x nrows = ncols = outp view nrows ncols view torch uint
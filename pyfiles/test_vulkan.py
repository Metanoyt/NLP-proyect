Owner s oncall mobile unittest torch torch nn functional F torch testing _internal common_utils TestCase run_tests torch testing FileCheck io unittest skipUnless torch is_vulkan_available Vulkan backend must available these tests TestVulkanRewritePass TestCase staticmethod validate_transformed_module To please flake pattern_count_map data_shape prepack_removal=False fuse_clamping_ops=False module_instance = scripted_model = torch jit script module_instance scripted_model eval input_data = torch normal size=data_shape scripted_model input_data torch _C _jit_pass_vulkan_insert_prepacked_ops scripted_model _c fuse_clamping_ops prepack_removal scripted_model _c = torch _C _freeze_module scripted_model _c fuse_clamping_ops torch _C _jit_pass_vulkan_fuse_clamp_w_prepacked_conv scripted_model _c prepack_removal torch _C _jit_pass_vulkan_fold_prepacking_ops scripted_model _c buffer = io BytesIO torch jit save scripted_model buffer buffer seek deserialized_scripted_model = torch jit load buffer pattern v pattern_count_map items v == FileCheck check pattern run deserialized_scripted_model graph v == - FileCheck check_not pattern run deserialized_scripted_model graph FileCheck check_count pattern v exactly=True run deserialized_scripted_model graph test_conv Conv params batch_size = input_channels_per_group = height = width = output_channels_per_group = groups = kernel_h = kernel_w = stride_h = stride_w = pad_h = pad_w = dilation = input_channels = input_channels_per_group groups output_channels = output_channels_per_group groups strides = stride_h stride_w paddings = pad_h pad_w dilations = dilation dilation conv_weight_shape = output_channels input_channels_per_group kernel_h kernel_w conv_bias_shape = output_channels Conv D torch nn Module __init__ - None super __init__ weight = torch nn Parameter torch rand conv_weight_shape requires_grad=False bias = torch nn Parameter torch rand conv_bias_shape requires_grad=False strides = strides paddings = paddings dilations = dilations groups = groups forward x F conv d x weight bias strides paddings dilations groups data_shape = batch_size input_channels height width pattern_count_map = Tensor = aten conv d - vulkan_prepack conv d_clamp_prepack vulkan_prepack conv d_clamp_run TestVulkanRewritePass validate_transformed_module Conv D pattern_count_map data_shape Conv DRelu torch nn Module __init__ - None super __init__ weight = torch nn Parameter torch rand conv_weight_shape requires_grad=False bias = torch nn Parameter torch rand conv_bias_shape requires_grad=False strides = strides paddings = paddings dilations = dilations groups = groups forward x o = F conv d x weight bias strides paddings dilations groups o = F relu o o data_shape = batch_size input_channels height width pattern_count_map = Tensor = aten conv d - vulkan_prepack conv d_clamp_prepack vulkan_prepack conv d_clamp_run TestVulkanRewritePass validate_transformed_module Conv DRelu pattern_count_map data_shape pattern_count_map aten relu = pattern_count_map vulkan_prepack conv d_clamp_prepack = - TestVulkanRewritePass validate_transformed_module Conv DRelu pattern_count_map data_shape prepack_removal=True pattern_count_map aten relu = - TestVulkanRewritePass validate_transformed_module Conv DRelu pattern_count_map data_shape prepack_removal=True fuse_clamping_ops=True Conv DHardtanh torch nn Module __init__ - None super __init__ weight = torch nn Parameter torch rand conv_weight_shape requires_grad=False bias = torch nn Parameter torch rand conv_bias_shape requires_grad=False strides = strides paddings = paddings dilations = dilations groups = groups forward x o = F conv d x weight bias strides paddings dilations groups o = F hardtanh o o data_shape = batch_size input_channels height width pattern_count_map = Tensor = aten conv d - vulkan_prepack conv d_clamp_prepack vulkan_prepack conv d_clamp_run TestVulkanRewritePass validate_transformed_module Conv DHardtanh pattern_count_map data_shape pattern_count_map aten hardtanh = pattern_count_map vulkan_prepack conv d_clamp_prepack = - TestVulkanRewritePass validate_transformed_module Conv DHardtanh pattern_count_map data_shape prepack_removal=True pattern_count_map aten hardtanh = - TestVulkanRewritePass validate_transformed_module Conv DRelu pattern_count_map data_shape prepack_removal=True fuse_clamping_ops=True __name__ == __main__ run_tests
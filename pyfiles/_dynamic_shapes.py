Compatibility functions torch onnx export API mypy allow-untyped-defs __future__ annotations inspect warnings typing Any TYPE_CHECKING torch torch export dynamic_shapes _DimHint Dim torch onnx _internal _lazy_import onnxscript_ir ir torch utils _pytree TYPE_CHECKING collections abc Sequence from_dynamic_axes_to_dynamic_shapes model args tuple Any kwargs dict str Any &#124; None dynamic_axes=None output_names set str input_names Sequence str &#124; None = None - tuple dict str Any &#124; None &#124; None tuple Any dict str Any &#124; None Converts dynamic_axes into dynamic_shapes wrapping axis names ` ` torch export Dim DYNAMIC ` ` dynamic_axes examples dynamic_axes = x my_custom_axis_name_ y my_custom_axis_name_ dynamic_axes = x y these will converted dynamic_shapes respectively dynamic_shapes = x Dim DYNAMIC y Dim DYNAMIC dynamic_shapes = x Dim DYNAMIC y Dim DYNAMIC Detail Dim DYNAMIC ` https github com pytorch pytorch pull ` _ warnings warn from_dynamic_axes_to_dynamic_shapes deprecated will removed future release This function converts dynamic_axes format including custom axis names dynamic_shapes format Instead relying conversion provide dynamic_shapes directly custom names DeprecationWarning stacklevel= https github com pytorch pytorch pull The function does need provide dynamic_shapes torch export export dynamic_axes None None args kwargs input_names None input_names = kwargs None kwargs = dynamic_shapes dict str Any &#124; None = input_name axes dynamic_axes items NOTE torch export Dim DYNAMIC does its best infer min max values model s guaranteed dynamic input_name output_names output names needed dynamic_shapes continue isinstance axes dict any isinstance k int k axes keys raise ValueError The axis dynamic_axes must form dict int str list int str will converted Dim DYNAMIC convert_str_to_export_dim dynamic_shapes input_name = axes isinstance axes list any isinstance k int k axes raise ValueError The axis dynamic_axes must form dict int str list int dynamic_shapes input_name = dict fromkeys axes torch export Dim DYNAMIC axes None dynamic_shapes input_name = None raise ValueError Unsupported dynamic_axes format Please provide dict list input_name input_names input_name dynamic_shapes dynamic_shapes input_name = None Order inputs according signature model sig = _signature model inputs = idx param_name enumerate sig parameters idx len args inputs append args idx param_name kwargs inputs append kwargs param_name We need tree structure represent dynamic_shapes dynamic_shapes = _unflatten_dynamic_shapes_with_inputs_tree inputs dynamic_shapes Since dynamic_shapes now order model parameters we need convert args kwargs order model parameters dynamic_shapes tuple inputs from_dynamic_shapes_to_dynamic_axes dynamic_shapes dict str Any &#124; tuple Any &#124; list Any input_names Sequence str exception Exception - dict str Any &#124; None Converts dynamic_shapes into dynamic_axes removing torch export Dim wrapping converting list dict form based whether dimension names present dynamic_shapes examples dynamic_shapes = x Dim my_custom_axis_name_ y Dim my_custom_axis_name_ dynamic_shapes = Dim my_custom_axis_name_ Dim my_custom_axis_name_ these will converted dynamic_axes respectively dynamic_axes = x y dynamic_axes = x y NOTE If model input nested so dynamic_shapes we need flatten dynamic_shapes then assign axes input names order they provided NOTE input_names used assign axes correct input names If input names provided less than dynamic inputs axes raises error flat_dynamic_shapes _ = _flatten_dynamic_shapes_to_axes dynamic_shapes len input_names len flat_dynamic_shapes raise ValueError To construct dynamic_axes dynamic_shapes f number input names len input_names should greater than equal f number graph inputs flat len flat_dynamic_shapes exception dynamic_axes dict str list int = input names assigned order input_name axes zip input_names flat_dynamic_shapes axes None continue converted_axes list int = isinstance axes dict axis dim axes items dim None continue converted_axes append axis dynamic_axes input_name = converted_axes isinstance axes list tuple idx dim enumerate axes dim None continue converted_axes append idx dynamic_axes input_name = converted_axes dynamic_axes _any_str_or_dim_in_dynamic_shapes dynamic_shapes dict str Any &#124; tuple Any &#124; list Any - bool Check there any string Dim dynamic_shapes flat_dynamic_shapes _ = _flatten_dynamic_shapes_to_axes dynamic_shapes This indicates dynamic_shapes includes something we don t support axes s flattened itself Otherwise flat_dynamic_shapes should list dict list tuple None any isinstance axes dict list tuple axes None axes flat_dynamic_shapes False both str Dim can provide custom names axes flat_dynamic_shapes isinstance axes dict dim axes values isinstance dim str Dim True isinstance axes list tuple dim axes isinstance dim str Dim True False convert_str_to_export_dim dynamic_shapes dict str Any &#124; tuple Any &#124; list Any &#124; None - tuple dict str Any &#124; tuple Any &#124; list Any &#124; None bool If there no string dynamic_shapes we do touch dynamic_shapes dynamic_shapes None _any_str_or_dim_in_dynamic_shapes dynamic_shapes dynamic_shapes False Convert name Dim DYNAMIC flattening identify there any string replaced Dim DYNAMIC then unflatten back original structure example y dim_ x dim_ y Dim DYNAMIC x Dim DYNAMIC dynamic_shapes_with_export_dim list list Dim &#124; _DimHint &#124; None &#124; dict int Dim &#124; _DimHint &#124; None &#124; None = flat_dynamic_shapes tree_structure = _flatten_dynamic_shapes_to_axes dynamic_shapes axes flat_dynamic_shapes axes None dynamic_shapes_with_export_dim append None isinstance axes dict converted_axes_dict dict int Dim &#124; _DimHint &#124; None = axis dim axes items isinstance dim str converted_axes_dict axis = torch export Dim DYNAMIC converted_axes_dict axis = dim dynamic_shapes_with_export_dim append converted_axes_dict isinstance axes list tuple converted_axes_list list Dim &#124; _DimHint &#124; None = dim axes isinstance dim str converted_axes_list append torch export Dim DYNAMIC converted_axes_list append dim dynamic_shapes_with_export_dim append converted_axes_list dynamic_shapes_with_export_dim = _pytree tree_unflatten dynamic_shapes_with_export_dim tree_structure dynamic_shapes_with_export_dim True create_rename_mapping inputs dynamic_shapes dict str Any &#124; tuple Any &#124; list Any - dict str str Create mapping old names new names dynamic axes NOTE There s no need handle cases where kwargs out order model signature torch export export supports dynamism only when kwargs dynamic_shapes provided order Reference https github com pytorch pytorch blob f dba b cb ddbe c cc torch export _trace py#L flat_dynamic_shapes _ = _flatten_dynamic_shapes_to_axes dynamic_shapes len inputs = len flat_dynamic_shapes warnings warn ONNX model has different number inputs than flatten dynamic_shapes The dynamic axes will renamed UserWarning stacklevel= rename_mapping dict str str = NOTE We assume flat_dynamic_shapes same order inputs When axis static connects _DimHint dynamic shapes we skip renaming idx axes enumerate flat_dynamic_shapes input = inputs idx isinstance axes dict dim axis axes items isinstance input shape dim ir SymbolicDim continue old_name = input shape dim value old_name None continue _DimHint int None exists dynamic shapes we skip renaming isinstance axis _DimHint int axis None continue NOTE ExportedProgram could give axes same name they share same shape constraints custom_name = _get_custom_axis_name axis input shape dim value rename_mapping warnings warn f The axis name custom_name will used since shares f same shape constraints another axis rename_mapping input shape dim value stacklevel= continue rename_mapping input shape dim value = custom_name isinstance axes list tuple dim axis enumerate axes isinstance input shape dim ir SymbolicDim continue old_name = input shape dim value old_name None continue _DimHint int None exists dynamic shapes we skip renaming isinstance axis _DimHint int axis None continue NOTE ExportedProgram could give axes same name they share same shape constraints custom_name = _get_custom_axis_name axis input shape dim value rename_mapping warnings warn f The axis name custom_name will used since shares f same shape constraints another axis rename_mapping input shape dim value UserWarning stacklevel= continue rename_mapping input shape dim value = _get_custom_axis_name axis rename_mapping _get_custom_axis_name axis Dim &#124; str - str Get custom axis name torch export Dim isinstance axis Dim axis __name__ axis _unflatten_dynamic_shapes_with_inputs_tree inputs list Any dynamic_shapes dict str Any - dict str Any &#124; None _ tree_structure = _pytree tree_flatten inputs _pytree tree_unflatten dynamic_shapes values tree_structure _flatten_dynamic_shapes_to_axes dynamic_shapes dict str Any &#124; None &#124; tuple Any &#124; list Any - tuple list Any _pytree TreeSpec If s dict list tuple torch export Dim we consider s axis dim mapping is_axes x - bool isinstance x dict all isinstance k int v None isinstance v Dim _DimHint str int k v x items isinstance x list tuple all v None isinstance v Dim _DimHint str int v x _pytree tree_flatten dynamic_shapes is_leaf=is_axes _signature model - inspect Signature should_be_callable = getattr model forward model callable should_be_callable inspect signature should_be_callable raise ValueError model has no forward method callable
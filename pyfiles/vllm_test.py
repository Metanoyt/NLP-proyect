logging os re subprocess sys collections abc Iterable dataclasses dataclass enum Enum pathlib Path typing Any cli lib common cli_helper BaseRunner cli lib common envs_helper env_path_field env_str_field get_env cli lib common path_helper copy get_path remove_dir cli lib common pip_helper pip_install_first_match pip_install_packages pkg_exists run_python cli lib common utils run_command working_directory cli lib core vllm lib clone_vllm run_test_plan sample_vllm_test_library logger = logging getLogger __name__ dataclass VllmTestParameters Parameters defining vllm external test input DO NOT ADD SECRETS IN THIS CLASS you can put environment variable name VllmTestParameters s same secret one fetch secrests directly env variables during runtime torch_whls_path Path = env_path_field WHEELS_PATH dist vllm_whls_path Path = env_path_field VLLM_WHEELS_PATH dist external vllm wheels torch_cuda_arch_list str = env_str_field TORCH_CUDA_ARCH_LIST cleaning_script Path = env_path_field cleaning_script github ci_configs vllm use_existing_torch py __post_init__ torch_whls_path exists raise ValueError missing torch_whls_path vllm_whls_path exists raise ValueError missing vllm_whls_path TestInpuType Enum TEST_PLAN = test_plan UNKNOWN = unknown VllmTestRunner BaseRunner __init__ args Any work_directory = vllm test_plan = test_type = TestInpuType UNKNOWN shard_id = args shard_id num_shards = args num_shards args test_plan test_plan = args test_plan test_type = TestInpuType TEST_PLAN Matches structeur artifacts zip torcb build TORCH_WHL_PATH_REGEX = torch whl TORCH_WHL_EXTRA = opt-einsum TORCH_ADDITIONAL_WHLS_REGEX = vision torchvision whl audio torchaudio whl Match structure artifacts zip vllm external build VLLM_TEST_WHLS_REGEX = xformers whl vllm vllm whl flashinfer-python flashinfer whl prepare prepare test environment vllm This includes clone vllm repo install all wheels test dependencies set env params = VllmTestParameters logger info Display VllmTestParameters s params _set_envs params clone_vllm dst=self work_directory cp_torch_cleaning_script params working_directory work_directory remove_dir Path vllm _install_wheels params _install_dependencies verify torches overridden test dependencies check_versions run main function run vllm test prepare try working_directory work_directory test_type == TestInpuType TEST_PLAN num_shards run_test_plan test_plan vllm sample_vllm_test_library shard_id num_shards run_test_plan test_plan vllm sample_vllm_test_library raise ValueError f Unknown test type test_type finally double check torches overridden other packages check_versions cp_torch_cleaning_script params VllmTestParameters script = get_path params cleaning_script resolve=True vllm_script = Path f work_directory use_existing_torch py copy script vllm_script _install_wheels params VllmTestParameters logger info Running vllm test inputs s params pkg_exists torch install torch local whls s installed yet torch_p = f str params torch_whls_path TORCH_WHL_PATH_REGEX pip_install_first_match torch_p TORCH_WHL_EXTRA torch_whls_path = f str params torch_whls_path whl_path whl_path TORCH_ADDITIONAL_WHLS_REGEX torch_whl torch_whls_path pip_install_first_match torch_whl logger info Done Installed torch other torch-related wheels logger info Installing vllm wheels vllm_whls_path = f str params vllm_whls_path whl_path whl_path VLLM_TEST_WHLS_REGEX vllm_whl vllm_whls_path pip_install_first_match vllm_whl logger info Done Installed vllm wheels _install_test_dependencies This method replaces torch dependencies local torch wheel info requirements test file vllm repo then generates test txt runtime logger info generate test txt requirements test local torch whls preprocess_test_in copy requirements test txt snapshot_constraint txt run_command f sys executable -m uv pip compile requirements test -o test txt -- index-strategy unsafe-best-match -- constraint snapshot_constraint txt -- torch-backend cu pip_install_packages requirements= test txt prefer_uv=True logger info Done installed requirements test dependencies _install_dependencies pip_install_packages packages= -e tests vllm_test_utils prefer_uv=True pip_install_packages packages= hf_transfer prefer_uv=True os environ HF_HUB_ENABLE_HF_TRANSFER = using script vllm repo remove all torch packages requirements txt run_python use_existing_torch py install common packages requirements requirements common txt requirements build txt pip_install_packages requirements=requirements prefer_uv=True install test packages _install_test_dependencies _set_envs inputs VllmTestParameters os environ TORCH_CUDA_ARCH_LIST = inputs torch_cuda_arch_list validate_cuda get_env TORCH_CUDA_ARCH_LIST logger warning Missing supported TORCH_CUDA_ARCH_LIST Currently support TORCH_CUDA_ARCH_LIST env var supported arch os environ HF_TOKEN = os getenv VLLM_TEST_HUGGING_FACE_TOKEN get_env HF_TOKEN raise ValueError missing required HF_TOKEN please set VLLM_TEST_HUGGING_FACE_TOKEN env var get_env TORCH_CUDA_ARCH_LIST raise ValueError missing required TORCH_CUDA_ARCH_LIST please set TORCH_CUDA_ARCH_LIST env var preprocess_test_in target_file str = requirements test additional_packages Iterable str = This modifies target_file file place vllm work directory It removes torch unwanted packages target_file replace local torch whls package format $ WHEEL_PACKAGE_NAME file LOCAL_PATH additional_package_to_move = list additional_packages pkgs_to_remove = torch torchvision torchaudio xformers mamba_ssm + additional_package_to_move Read current requirements target_path = Path target_file lines = target_path read_text splitlines pkgs_to_add = Remove lines starting package names == = â€” case-insensitive pattern = re compile rf ^ &#124; join pkgs_to_remove \s == &#124; &#124; = re IGNORECASE kept_lines = line line lines pattern match line Get local installed torch vision audio pip freeze This hacky works pip_freeze = subprocess check_output pip freeze text=True header_lines = line line pip_freeze splitlines re match r ^ torch &#124; torchvision &#124; torchaudio \s \s file line re IGNORECASE Write back header_lines + blank + kept_lines out_lines = header_lines + + kept_lines pkgs_to_add out_lines += + pkgs_to_add out = \n join out_lines + \n target_path write_text out logger info INFO Updated s target_file validate_cuda value str - bool VALID_VALUES = all v VALID_VALUES v value split check_versions check installed packages version logger info Double check installed packages patterns = torch xformers torchvision torchaudio vllm pkg patterns pkg_exists pkg logger info Done checked installed packages
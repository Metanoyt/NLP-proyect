Owner s oncall jit unittest itertools product torch torch jit _passes _property_propagation apply_input_props_using_example torch testing _internal common_utils raise_on_run_directly TEST_CUDA torch testing _internal jit_utils JitTestCase try torchvision models except ImportError models = None TestDeviceAnalysis JitTestCase classmethod setUpClass cls cls cpu = torch device cpu cls cuda = torch device cuda cls vulkan = torch device vulkan cls mkldnn = torch device mkldnn MKLDNN can t mix other device types all cls device_types = cls cpu cls cuda cls vulkan staticmethod node_output_device graph graph_out = list graph outputs assert len graph_out == graph_out type device prop_device_on_graph graph example_devices in_shapes=None graph_inputs = list graph inputs torch _C _jit_pass_erase_shape_information graph assertEqual len graph_inputs len example_devices graph_i device_i zip graph_inputs example_devices device_i None graph_i setType graph_i type with_device device_i in_shapes graph_i shapes_i zip graph_inputs in_shapes shapes_i None graph_i setType graph_i type with_sizes shapes_i torch _C _jit_pass_propagate_shapes_on_graph graph torch _C _jit_pass_propagate_device graph assert_device_equal fn in_devices expected_device in_shapes=None subtest_str= subTest f In device in_devices expected expected_device \n subtest_str graph = torch jit script fn graph prop_device_on_graph graph in_devices in_shapes actual_device = node_output_device graph expected_device None actual_device None assertEqual actual_device expected_device assertEqual actual_device type expected_device type Failed Verification test_device_apply Test device properly applied input add_self x x + x graph = torch jit script add_self graph graph_input = next graph inputs graph_input setType graph_input type with_device cpu prop_device_on_graph graph cpu assertEqual graph_input type device cpu unittest skipIf models None Requires torchvision test_mobilenet in_cpu = torch randn device=self cpu in_example = in_cpu expected_device = cpu m = torch jit script models mobilenet_v _small m eval graph = torch jit freeze m graph torch _C _jit_pass_erase_shape_information graph apply_input_props_using_example graph in_example torch _C _jit_pass_propagate_shapes_on_graph graph torch _C _jit_pass_propagate_device graph actual_device = node_output_device graph expected_device None actual_device None assertEqual actual_device expected_device assertEqual actual_device type expected_device type Failed Verification test_simple add_self x x + x relu_ x torch nn functional relu_ x functions = add_self relu_ in_device fn product device_types functions assert_device_equal fn in_device in_device test_set_dtype set_device x x cpu in_device device_types assert_device_equal set_device in_device cpu test_device_arg Test no device gets propagated when arg passed set_device x device_name torch device x device=device_name in_device device_types assert_device_equal set_device in_device None None test_tensor_as_fns view_as_fn x y x view_as y expand_as_fn x y x expand_as y reshape_as_fn x y x reshape_as y test_fn view_as_fn expand_as_fn reshape_as_fn assert_device_equal test_fn cpu cpu cpu assert_device_equal test_fn cuda None cuda assert_device_equal test_fn None mkldnn None type_as_fn x y x type_as y assert_device_equal type_as_fn cpu cpu cpu assert_device_equal type_as_fn cuda None None assert_device_equal type_as_fn None mkldnn mkldnn zerodim_test_core device_pairs Test support zerodim tensors non-zerodim tensors mul x y x y add x y x + y fns = mul add input_shapes = Different dim non-zerodim one zerodim both zerodim fn shapes devices product fns input_shapes device_pairs subtest_str = f fn __name__ \n shapes shapes \n devices devices = torch rand shapes device=devices = torch rand shapes device=devices try out = fn except Exception e Don t expect eager failures CPU zerodim tensors i range len devices shapes i == devices i == cpu raise e only expect eager failures different devices devices == devices raise e Expect result device None failure cases assert_device_equal fn devices None shapes subtest_str continue assert_device_equal fn devices out device shapes subtest_str Test without shapes we either get same device None device Aka code convservative tensor shapes graph = torch jit script fn graph prop_device_on_graph graph devices actual_device = node_output_device graph assertTrue actual_device None actual_device type == out device type test_zerodim_cpu Allow minimal testing locally zerodim_test_core cpu cpu test_zerodim_no_device If device missing you should never able infer device type mul x y x y add x y x + y fns = mul add device_pairs = cpu None None cpu None None input_shapes = Different dim non-zerodim one zerodim both zerodim fn shapes devices product fns input_shapes device_pairs assert_device_equal fn devices None shapes unittest skipIf TEST_CUDA No CUDA test_zerodim_gpu device_pairs = cpu cuda cuda cpu cuda cuda zerodim_test_core device_pairs test_custom_device_op Test both custom functions check devicetype correctly applied set_cuda x x cuda set_cpu x x cpu set_mkldnn x x to_mkldnn device_pairs = set_cuda cuda set_cpu cpu set_mkldnn mkldnn fn out_device device_pairs in_device device_types assert_device_equal fn in_device out_device test_device_if_propagation test_fn x y z bool z x + y assert_device_equal test_fn cpu cpu None cpu assert_device_equal test_fn mkldnn mkldnn None mkldnn assert_device_equal test_fn cpu cuda None None test_loop_simple test_fn x y z int _ range z y = x y assert_device_equal test_fn cpu cpu None cpu assert_device_equal test_fn cpu cuda None None assert_device_equal test_fn cpu None None None test_loop_device_change test_fn x z int _ range z x = x cuda x assert_device_equal test_fn cpu None None assert_device_equal test_fn cuda None cuda assert_device_equal test_fn None None None test_while_change test_fn x z int while z x = x cuda z = x assert_device_equal test_fn cpu None None assert_device_equal test_fn cuda None cuda assert_device_equal test_fn None None None test_nested_loops test_fn x z int i range z x = x cpu _ range i x = x + x assert_device_equal test_fn cpu None cpu assert_device_equal test_fn cuda None None assert_device_equal test_fn None None None test_if_loop_mix test_fn x y z bool bool c = x while z c = x + c = y = False c assert_device_equal test_fn cpu cpu None None cpu assert_device_equal test_fn mkldnn mkldnn None None mkldnn assert_device_equal test_fn cpu cuda None None None __name__ == __main__ raise_on_run_directly test test_jit py
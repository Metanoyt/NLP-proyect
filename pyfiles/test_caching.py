Owner s module inductor pyre-strict __future__ annotations atexit os pickle concurrent futures Future ThreadPoolExecutor TimeoutError wait contextlib contextmanager functools wraps itertools combinations random Random shutil rmtree threading Lock time sleep time typing Any Generator Sequence TYPE_CHECKING Union typing_extensions TypeVar unittest mock patch filelock FileLock torch torch _inductor runtime caching config context exceptions implementations impls interfaces intfs locks utils torch _inductor test_case run_tests TestCase torch testing _internal common_utils instantiate_parametrized_tests parametrize TYPE_CHECKING pathlib Path set_caching_module_enabled = lambda enabled patch object noqa E config IS_CACHING_MODULE_ENABLED lambda enabled set_deterministic_caching_enabled = lambda enabled patch object noqa E config IS_DETERMINISTIC_CACHING_ENABLED lambda enabled set_strictly_pre_populated_determinism = lambda enabled patch object noqa E config STRICTLY_PRE_POPULATED_DETERMINISM enabled set_strictly_cached_determinism = lambda enabled patch object noqa E config STRICTLY_CACHED_DETERMINISM enabled set_local_determinism = lambda enabled patch object noqa E config LOCAL_DETERMINISM enabled set_global_determinism = lambda enabled patch object noqa E config GLOBAL_DETERMINISM enabled patch_on_disk_cache_base_dir fn wraps fn wrapper args kwargs default_base_dir = impls _OnDiskCacheImpl _base_dir patch object impls _OnDiskCacheImpl _base_dir default_base_dir f sub_dir rng- random_string fn args kwargs wrapper patch_deterministic_cache_intf_no_dump_on_exit fn wraps fn wrapper args kwargs default_init = intfs _DeterministicCacheIntf __init__ patched_init intf intfs _DeterministicCacheIntf args Any kwargs dict str Any - None default_init intf args kwargs atexit unregister intf _dump_imc_to_disk patch object intfs _DeterministicCacheIntf __init__ patched_init fn args kwargs wrapper patch_remote_cache_with_on_disk_cache fn impls _OnDiskCacheImpl has_strong_consistency = True patch object impls _RemoteCacheImpl impls _OnDiskCacheImpl fn TestMixin impl_typenames list str = _InMemoryCacheImpl _OnDiskCacheImpl cls_id int = Random randint impl_from_typename impl_typename str - impls _CacheImpl getattr impls impl_typename property random_string - str f s- Random randint instantiate_parametrized_tests ConfigTest TestCase FOO_THIS_VERSION int = FOO_JK_NAME str = foo_jk_name FOO_OSS_DEFAULT bool = False FOO_ENV_VAR_OVERRIDE str = foo_env_var_override FOO_ENV_VAR_OVERRIDE_LOCK_FPATH str = f tmp testing FOO_ENV_VAR_OVERRIDE lock FOO_ENV_VAR_OVERRIDE_LOCK FileLock = FileLock FOO_ENV_VAR_OVERRIDE_LOCK_FPATH classmethod setUpClass cls - None rmtree cls FOO_ENV_VAR_OVERRIDE_LOCK_FPATH ignore_errors=True classmethod tearDownClass cls - None rmtree cls FOO_ENV_VAR_OVERRIDE_LOCK_FPATH ignore_errors=True assert_versioned_config expected_enabled bool - None config _versioned_config cache_clear actual_enabled bool = config _versioned_config FOO_JK_NAME FOO_THIS_VERSION FOO_OSS_DEFAULT env_var_override=self FOO_ENV_VAR_OVERRIDE assertEqual actual_enabled expected_enabled parametrize enabled True False test_versioned_config_env_var_override enabled bool - None Test environment variable overrides take precedence over other configuration sources Verifies when environment variable override set _versioned_config function returns corresponding boolean value regardless other configuration settings FOO_ENV_VAR_OVERRIDE_LOCK acquire timeout= patch dict os environ FOO_ENV_VAR_OVERRIDE enabled patch torch _inductor runtime caching config is_fbcode return_value=False patch object FOO_OSS_DEFAULT enabled assert_versioned_config enabled parametrize enabled True False test_versioned_config_version_check enabled bool - None Test _versioned_config responds correctly version changes Facebook environments Verifies when running fbcode environments is_fbcode=True configuration enabled when JustKnobs version matches expected version disabled when version differs This ensures proper rollout control through version management FOO_ENV_VAR_OVERRIDE_LOCK acquire timeout= patch dict os environ clear=True patch torch _inductor runtime caching config is_fbcode return_value=True patch torch _utils_internal justknobs_getval_int return_value=self FOO_THIS_VERSION + - enabled assert_versioned_config enabled parametrize enabled True False test_versioned_config_oss_default enabled bool - None Test _versioned_config uses OSS default values non-Facebook environments Verifies when running non-fbcode environments is_fbcode=False no environment variable overrides configuration falls back OSS default value This ensures proper behavior open-source PyTorch distributions FOO_ENV_VAR_OVERRIDE_LOCK acquire timeout= patch dict os environ clear=True patch torch _inductor runtime caching config is_fbcode return_value=False patch object FOO_OSS_DEFAULT enabled assert_versioned_config enabled test_versioned_config_jk_failure - None Test _versioned_config uses OSS default values non-Facebook environments Verifies when running non-fbcode environments is_fbcode=False no environment variable overrides configuration falls back OSS default value This ensures proper behavior open-source PyTorch distributions FOO_ENV_VAR_OVERRIDE_LOCK acquire timeout= patch dict os environ clear=True patch torch _inductor runtime caching config is_fbcode return_value=True patch torch _utils_internal justknobs_getval_int return_value= assert_versioned_config False instantiate_parametrized_tests ContextTest TestCase isolation_schema_from_forms_of_context_selected runtime_forms_of_context_selected Sequence str compile_forms_of_context_selected Sequence str - context IsolationSchema context IsolationSchema runtime_context= form_of_context form_of_context set runtime_forms_of_context_selected form_of_context context _RuntimeContext forms_of_context compile_context= form_of_context form_of_context set compile_forms_of_context_selected form_of_context context _CompileContext forms_of_context parametrize runtime_forms_of_context_selected list combinations context _RuntimeContext forms_of_context parametrize compile_forms_of_context_selected list combinations context _CompileContext forms_of_context test_selected_isolation_context runtime_forms_of_context_selected Sequence str compile_forms_of_context_selected Sequence str - None Tests isolation context generation works correctly specific combinations runtime compile context forms Verifies _isolation_context function properly creates isolation contexts based selected forms runtime compile context ensuring only specified context forms included resulting isolation context ischema context IsolationSchema = isolation_schema_from_forms_of_context_selected runtime_forms_of_context_selected compile_forms_of_context_selected assertEqual context _isolation_context ischema runtime_context form_of_context getattr context _RuntimeContext form_of_context form_of_context runtime_forms_of_context_selected None compile_context form_of_context getattr context _CompileContext form_of_context form_of_context compile_forms_of_context_selected None parametrize all_runtime_context True False parametrize all_compile_context True False test_all_or_none_isolation_context all_runtime_context bool all_compile_context bool - None Tests isolation context generation when using all no context forms Verifies isolation context correctly includes all forms context when set True excludes all forms when set False both runtime compile contexts ischema context IsolationSchema = context IsolationSchema runtime_context=all_runtime_context compile_context=all_compile_context assertEqual context _isolation_context ischema runtime_context form_of_context getattr context _RuntimeContext form_of_context form_of_context context _RuntimeContext forms_of_context all_runtime_context None compile_context form_of_context getattr context _CompileContext form_of_context form_of_context context _CompileContext forms_of_context all_compile_context None test_isolation_key_is_distinct - None Tests different combinations runtime compile context forms generate unique isolation keys Verifies each possible combination context forms produces distinct isolation key ensuring no collisions occur between different contexts ikeys set str = set num_runtime_forms_of_context_selected range len context _RuntimeContext forms_of_context num_compile_forms_of_context_selected range len context _CompileContext forms_of_context runtime_forms_of_context_selected combinations context _RuntimeContext forms_of_context num_runtime_forms_of_context_selected compile_forms_of_context_selected combinations context _CompileContext forms_of_context num_compile_forms_of_context_selected ischema context IsolationSchema = isolation_schema_from_forms_of_context_selected runtime_forms_of_context_selected compile_forms_of_context_selected ikey str = context _isolation_key ischema assertFalse ikey ikeys ikeys add ikey test_isolation_key_is_repeatable - None Tests calling isolation key function multiple times same parameters produces same result Verifies isolation key generation deterministic consistent across multiple invocations identical inputs assertEqual context _isolation_key context _isolation_key test_select_runtime_context_matches_forms_of_context - None Tests selected runtime context matches forms context Verifies selected runtime context includes only forms context specified isolation schema ensuring isolation context properly selected configured assertEqual set context SelectedRuntimeContext __required_keys__ set context _RuntimeContext forms_of_context test_select_compile_context_matches_forms_of_context - None Tests selected compile context matches forms context Verifies selected compile context includes only forms context specified isolation schema ensuring isolation context properly selected configured assertEqual set context SelectedCompileContext __required_keys__ set context _CompileContext forms_of_context instantiate_parametrized_tests ExceptionsTest TestCase exception_typenames list str = CacheError SystemError LockTimeoutError FileLockTimeoutError UserError KeyEncodingError KeyPicklingError ValueEncodingError ValuePicklingError ValueDecodingError ValueUnPicklingError CustomParamsEncoderRequiredError CustomResultEncoderRequiredError CustomResultDecoderRequiredError DeterministicCachingRequiresStrongConsistencyError parametrize exception_typename exception_typenames test_exception_is_CacheError exception_typename str - None Test all custom cache exceptions inherit base CacheError Verifies every exception type defined caching exceptions module properly derived CacheError ensuring consistent exception hierarchy enabling unified exception handling throughout caching system assertTrue issubclass getattr exceptions exception_typename exceptions CacheError test_exception_other - None Test inheritance relationships among custom cache exception classes Verifies exception classes caching exceptions module have correct subclass relationships ensuring exception hierarchy intended This includes checks both direct indirect inheritance between base derived exception types assertTrue issubclass exceptions SystemError exceptions CacheError assertTrue issubclass exceptions LockTimeoutError exceptions SystemError assertTrue issubclass exceptions FileLockTimeoutError exceptions SystemError assertTrue issubclass exceptions UserError exceptions CacheError assertTrue issubclass exceptions KeyEncodingError exceptions UserError assertTrue issubclass exceptions KeyPicklingError exceptions KeyEncodingError assertTrue issubclass exceptions ValueEncodingError exceptions UserError assertTrue issubclass exceptions ValuePicklingError exceptions ValueEncodingError assertTrue issubclass exceptions ValueDecodingError exceptions UserError assertTrue issubclass exceptions ValueUnPicklingError exceptions ValueDecodingError assertTrue issubclass exceptions CustomParamsEncoderRequiredError exceptions UserError assertTrue issubclass exceptions CustomResultEncoderRequiredError exceptions UserError assertTrue issubclass exceptions CustomResultDecoderRequiredError exceptions UserError assertTrue issubclass exceptions DeterministicCachingRequiresStrongConsistencyError exceptions UserError instantiate_parametrized_tests ImplementationsTest TestMixin TestCase classmethod sub_dir cls - str f testing-impls-instance- cls cls_id classmethod setUpClass cls - None rmtree impls _OnDiskCacheImpl sub_dir=cls sub_dir _cache_dir ignore_errors=True classmethod tearDownClass cls - None rmtree impls _OnDiskCacheImpl sub_dir=cls sub_dir _cache_dir ignore_errors=True assert_key_in key Any impl impls _CacheImpl - None assertTrue impl get key None assert_key_not_in key Any impl impls _CacheImpl - None assertTrue impl get key None assert_key_value_inserted_in key Any value Any impl impls _CacheImpl - None assertTrue impl insert key value assert_key_value_not_inserted_in key Any value Any impl impls _CacheImpl - None assertFalse impl insert key value assert_key_has_value_in key Any value Any impl impls _CacheImpl - None assertTrue get = impl get key None get value == value patch_on_disk_cache_base_dir patch_remote_cache_with_on_disk_cache parametrize impl_typename TestMixin impl_typenames test_get impl_typename str - None Test cache get operation returns cache miss non-existent keys Verifies both in-memory on-disk cache implementations correctly handle get operations keys do exist cache This test ensures cache properly returns cache miss hit=False when attempting retrieve non-existent key Args impl_typename The cache implementation type test _InMemoryCacheImpl _OnDiskCacheImpl impl impls _CacheImpl = impl_from_typename impl_typename impl lock assert_key_not_in random_string impl patch_on_disk_cache_base_dir patch_remote_cache_with_on_disk_cache parametrize impl_typename TestMixin impl_typenames test_insert impl_typename str - None Test cache insert operation successfully stores retrieves key-value pairs Verifies both in-memory on-disk cache implementations correctly handle insert operations new key-value pairs This test ensures Keys initially don t exist cache cache miss Insert operations succeed new keys The stored value can retrieved correctly after insertion Args impl_typename The cache implementation type test _InMemoryCacheImpl _OnDiskCacheImpl impl impls _CacheImpl = impl_from_typename impl_typename impl lock key str = random_string assert_key_not_in key impl value str = random_string assert_key_value_inserted_in key value impl assert_key_has_value_in key value impl patch_on_disk_cache_base_dir patch_remote_cache_with_on_disk_cache parametrize impl_typename TestMixin impl_typenames test_insert_will_not_overwrite impl_typename str - None Test cache insert operation does overwrite existing keys Verifies both in-memory on-disk cache implementations correctly handle insert operations keys already exist cache This test ensures Keys initially don t exist cache cache miss First insert operation succeeds new keys Subsequent insert operations same key fail inserted=False The original value preserved overwritten Args impl_typename The cache implementation type test _InMemoryCacheImpl _OnDiskCacheImpl impl impls _CacheImpl = impl_from_typename impl_typename impl lock key str = random_string assert_key_not_in key impl value str = random_string assert_key_value_inserted_in key value impl assert_key_value_not_inserted_in key random_string impl assert_key_has_value_in key value impl patch_on_disk_cache_base_dir patch_remote_cache_with_on_disk_cache parametrize impl_typename TestMixin impl_typenames test_key_encoding impl_typename str - None Test cache implementations properly handle non-serializable keys Verifies both in-memory on-disk cache implementations correctly raise KeyPicklingError when attempting insert keys cannot pickled such lambda functions This ensures proper error handling invalid key types would break caching system Args impl_typename The cache implementation type test _InMemoryCacheImpl _OnDiskCacheImpl impl impls _CacheImpl = impl_from_typename impl_typename impl lock assertRaises exceptions KeyPicklingError impl insert lambda None None patch_on_disk_cache_base_dir patch_remote_cache_with_on_disk_cache parametrize impl_typename TestMixin impl_typenames test_value_encoding impl_typename str - None Test on-disk cache implementations properly handle non-serializable values Verifies on-disk cache implementations correctly raise ValuePicklingError when attempting insert values cannot pickled such lambda functions This test only applies on-disk implementations since in-memory caches don t require serialization Ensures proper error handling invalid value types Args impl_typename The cache implementation type test _InMemoryCacheImpl _OnDiskCacheImpl impl impls _CacheImpl = impl_from_typename impl_typename impl lock isinstance impl impls _OnDiskCacheImpl assertRaises exceptions ValuePicklingError impl insert None lambda None patch_on_disk_cache_base_dir patch_remote_cache_with_on_disk_cache parametrize impl_typename TestMixin impl_typenames test_value_decoding impl_typename str - None Test on-disk cache implementations properly handle corrupted cached values Verifies on-disk cache implementations correctly raise ValueUnPicklingError when attempting retrieve values cache files contain corrupted invalid pickled data This test ensures proper error handling when cached data becomes corrupted disk Only applies on-disk implementations since in-memory caches don t involve serialization deserialization Args impl_typename The cache implementation type test _InMemoryCacheImpl _OnDiskCacheImpl impl impls _CacheImpl = impl_from_typename impl_typename impl lock isinstance impl impls _OnDiskCacheImpl key str = random_string assert_key_not_in key impl fpath Path = impl _fpath_from_key key open fpath xb fp impl _write_version_header fp fp write b foo assertRaises exceptions ValueUnPicklingError impl get key patch_on_disk_cache_base_dir patch_remote_cache_with_on_disk_cache parametrize impl_typename TestMixin impl_typenames test_version_mismatch impl_typename str - None Test on-disk cache implementations properly handle version mismatches Verifies on-disk cache implementations correctly handle cached data when cache version changes This test ensures Data can stored retrieved current version When version changes previously cached data becomes inaccessible cache miss New data can stored new version After version change old cached data remains inaccessible This version checking mechanism prevents corruption compatibility issues when cache formats change between software versions Only applies on-disk implementations since in-memory caches don t persist across version changes Args impl_typename The cache implementation type test _InMemoryCacheImpl _OnDiskCacheImpl impl impls _CacheImpl = impl_from_typename impl_typename impl lock isinstance impl impls _OnDiskCacheImpl key str = random_string assert_key_not_in key impl value str = random_string assert_key_value_inserted_in key value impl assert_key_has_value_in key value impl patch object impls _OnDiskCacheImpl _version impl _version + assert_key_not_in key impl assert_key_value_inserted_in key value impl assert_key_has_value_in key value impl assert_key_not_in key impl assert_key_value_inserted_in key value impl assert_key_has_value_in key value impl instantiate_parametrized_tests InterfacesTest TestMixin TestCase intf_typenames list str = _FastCacheIntf _DeterministicCacheIntf classmethod sub_dir cls - str f testing-intfs-instance- cls cls_id classmethod setUpClass cls - None rmtree impls _OnDiskCacheImpl _base_dir cls sub_dir ignore_errors=True classmethod tearDownClass cls - None rmtree impls _OnDiskCacheImpl _base_dir cls sub_dir ignore_errors=True intf_from_typename intf_typename str - intfs _CacheIntf getattr intfs intf_typename assert_call_is_cached fn params intf args kwargs - None assertTrue intf get fn params args kwargs None assert_call_is_not_cached fn params intf args kwargs - None assertTrue intf get fn params args kwargs None assert_call_was_cached fn params result intf args kwargs - None assertTrue intf insert fn params result args kwargs assert_call_was_not_cached fn params result intf args kwargs - None assertFalse intf insert fn params result args kwargs assert_cached_call_is fn params result intf args kwargs - None assertTrue get = intf get fn params args kwargs None get value == result set_caching_module_enabled True set_deterministic_caching_enabled True set_strictly_pre_populated_determinism False set_strictly_cached_determinism False patch_on_disk_cache_base_dir patch_remote_cache_with_on_disk_cache patch_deterministic_cache_intf_no_dump_on_exit parametrize intf_typename intf_typenames test_defaults intf_typename str - None intf intfs _CacheIntf = intf_from_typename intf_typename sleep_t int = intf record foo args kwargs - None sleep sleep_t args kwargs args kwargs = bar bar params = args kwargs assertEqual foo args kwargs params start_t float = time assertEqual foo args kwargs params assertTrue time - start_t sleep_t assert_cached_call_is foo params params intf ischema=context _DEFAULT_ISOLATION_SCHEMA set_caching_module_enabled True set_deterministic_caching_enabled True set_strictly_pre_populated_determinism False set_strictly_cached_determinism False patch_on_disk_cache_base_dir patch_remote_cache_with_on_disk_cache patch_deterministic_cache_intf_no_dump_on_exit parametrize intf_typename intf_typenames test_custom_params_encoder intf_typename str - None intf intfs _CacheIntf = intf_from_typename intf_typename sleep_t int = intf record custom_params_encoder=lambda params bar foo _lambda - None sleep sleep_t hash _lambda _lambda = lambda None noqa E assertEqual foo _lambda hash _lambda start_t float = time assertEqual foo _lambda hash _lambda assertTrue time - start_t sleep_t set_caching_module_enabled True set_deterministic_caching_enabled True set_strictly_pre_populated_determinism False set_strictly_cached_determinism False patch_on_disk_cache_base_dir patch_remote_cache_with_on_disk_cache patch_deterministic_cache_intf_no_dump_on_exit parametrize intf_typename intf_typenames test_custom_result_encoder_and_decoder intf_typename str - None intf intfs _CacheIntf = intf_from_typename intf_typename sleep_t int = intf record custom_result_encoder=lambda value bar custom_result_decoder=lambda encoded_value bar foo - None sleep sleep_t foo assertEqual foo foo start_t float = time assertEqual foo bar assertTrue time - start_t sleep_t set_caching_module_enabled True set_deterministic_caching_enabled True set_strictly_pre_populated_determinism False set_strictly_cached_determinism False patch_on_disk_cache_base_dir patch_remote_cache_with_on_disk_cache patch_deterministic_cache_intf_no_dump_on_exit parametrize intf_typename intf_typenames test_custom_ischema intf_typename str - None intf intfs _CacheIntf = intf_from_typename intf_typename sleep_t int = intf record ischema=context IsolationSchema runtime_context=context SelectedRuntimeContext inductor_configs=True torch_determinism_configs=False cuda_matmul_precision_configs=False compile_context=False foo args kwargs - None sleep sleep_t args kwargs patch object torch _inductor config max_autotune True assertEqual foo foo foo start_t float = time assertEqual foo foo foo assertTrue time - start_t sleep_t patch object torch _inductor config max_autotune False start_t float = time assertEqual foo foo foo assertTrue time - start_t = sleep_t set_caching_module_enabled True set_deterministic_caching_enabled True set_strictly_pre_populated_determinism False set_strictly_cached_determinism False patch_on_disk_cache_base_dir patch_remote_cache_with_on_disk_cache patch_deterministic_cache_intf_no_dump_on_exit parametrize intf_typename intf_typenames test_params_encoder_required intf_typename str - None intf intfs _CacheIntf = intf_from_typename intf_typename intf record foo args kwargs - None args kwargs assertRaises exceptions CustomParamsEncoderRequiredError foo lambda None set_caching_module_enabled True set_deterministic_caching_enabled True set_strictly_pre_populated_determinism False set_strictly_cached_determinism False patch_on_disk_cache_base_dir patch_remote_cache_with_on_disk_cache patch_deterministic_cache_intf_no_dump_on_exit parametrize intf_typename intf_typenames test_result_encoder_required intf_typename str - None intf intfs _CacheIntf = intf_from_typename intf_typename intf record foo args kwargs - None lambda None assertRaises exceptions CustomResultEncoderRequiredError foo set_caching_module_enabled True set_deterministic_caching_enabled True set_strictly_pre_populated_determinism False set_strictly_cached_determinism False patch_on_disk_cache_base_dir patch_remote_cache_with_on_disk_cache patch_deterministic_cache_intf_no_dump_on_exit parametrize intf_typename intf_typenames test_result_encoder_and_decoder_required intf_typename str - None intf intfs _CacheIntf = intf_from_typename intf_typename assertRaises exceptions CustomResultEncoderRequiredError intf record custom_result_decoder=lambda None foo - None None otherwise flake complains about foo unused _ = foo assertRaises exceptions CustomResultDecoderRequiredError intf record custom_result_encoder=lambda None foo - None None otherwise flake complains about foo unused _ = foo set_caching_module_enabled True set_deterministic_caching_enabled True set_strictly_pre_populated_determinism False set_strictly_cached_determinism False patch_on_disk_cache_base_dir patch_deterministic_cache_intf_no_dump_on_exit patch_remote_cache_with_on_disk_cache test_strictly_pre_populated_determinism - None intf intfs _DeterministicCacheIntf = intf_from_typename _DeterministicCacheIntf intf record foo args Any kwargs dict str Any - None None args kwargs = bar bar params result = args kwargs None assertEqual foo args kwargs result assertTrue get = intf get foo params None get value == result assertTrue fpath = intf _dump_imc_to_disk None set_strictly_pre_populated_determinism True patch dict os environ TORCHINDUCTOR_PRE_POPULATE_DETERMINISTIC_CACHE str fpath intf intfs _DeterministicCacheIntf = intf_from_typename _DeterministicCacheIntf intf record foo args Any kwargs dict str Any - None None assertEqual foo args kwargs result assertRaises exceptions StrictDeterministicCachingKeyNotFoundError foo assertRaises exceptions StrictDeterministicCachingKeyNotFoundError intf get foo assertRaises exceptions StrictDeterministicCachingInsertionError intf insert foo None set_caching_module_enabled True set_deterministic_caching_enabled True set_strictly_pre_populated_determinism False set_strictly_cached_determinism False patch_on_disk_cache_base_dir patch_deterministic_cache_intf_no_dump_on_exit patch_remote_cache_with_on_disk_cache test_strictly_cached_determinism - None intf intfs _DeterministicCacheIntf = intf_from_typename _DeterministicCacheIntf intf record foo args Any kwargs dict str Any - None None args kwargs = bar bar params result = args kwargs None assertEqual foo args kwargs result assertTrue get = intf get foo params None get value == result set_strictly_cached_determinism True assertEqual foo args kwargs result assertRaises exceptions StrictDeterministicCachingKeyNotFoundError foo assertRaises exceptions StrictDeterministicCachingKeyNotFoundError intf get foo assertRaises exceptions StrictDeterministicCachingInsertionError intf insert foo None set_caching_module_enabled False set_deterministic_caching_enabled True patch_on_disk_cache_base_dir patch_deterministic_cache_intf_no_dump_on_exit patch_remote_cache_with_on_disk_cache parametrize intf_typename intf_typenames test_caching_module_disabled intf_typename str - None intf intfs _CacheIntf = intf_from_typename intf_typename sleep_t int = intf record foo args kwargs - None sleep sleep_t args kwargs args kwargs = bar bar params = args kwargs assertIsNone intf get foo params assertFalse intf insert foo params params foo args kwargs start_t float = time foo args kwargs assertTrue time - start_t = sleep_t set_caching_module_enabled True set_deterministic_caching_enabled False patch_on_disk_cache_base_dir patch_deterministic_cache_intf_no_dump_on_exit patch_remote_cache_with_on_disk_cache test_deterministic_caching_disabled - None intf intfs _DeterministicCacheIntf = intf_from_typename _DeterministicCacheIntf intf record foo args kwargs - None args kwargs args kwargs = bar bar params = args kwargs assertRaises exceptions DeterministicCachingDisabledError intf get foo params assertRaises exceptions DeterministicCachingDisabledError intf insert foo params params assertRaises exceptions DeterministicCachingDisabledError foo args kwargs instantiate_parametrized_tests LocksTest TestMixin TestCase T = TypeVar T contextmanager executor - Generator ThreadPoolExecutor None None executor ThreadPoolExecutor = ThreadPoolExecutor try yield executor finally executor shutdown is_lock lock_or_flock Union Lock FileLock - bool hasattr lock_or_flock locked is_flock lock_or_flock Union Lock FileLock - bool hasattr lock_or_flock is_locked lock_or_flock_locked lock_or_flock Union Lock FileLock - bool is_lock lock_or_flock lock_or_flock locked is_flock lock_or_flock lock_or_flock is_locked raise NotImplementedError test_BLOCKING - None assertEqual locks _BLOCKING - test_NON_BLOCKING - None assertEqual locks _NON_BLOCKING test_BLOCKING_WITH_TIMEOUT - None assertGreater locks _BLOCKING_WITH_TIMEOUT patch object locks _BLOCKING_WITH_TIMEOUT patch object locks _DEFAULT_TIMEOUT parametrize lock_typename Lock FileLock parametrize lock_timeout BLOCKING NON_BLOCKING BLOCKING_WITH_TIMEOUT parametrize acquisition_mode safe unsafe parametrize release unlocked never before_timeout after_timeout test_acquire_with_timeout lock_typename str lock_timeout str acquisition_mode str release str - None Test lock acquisition behavior various timeout configurations release scenarios This comprehensive test verifies lock acquisition functionality both threading Lock FileLock objects across different timeout modes acquisition patterns release timings The test validates proper exception handling timeout behavior correct lock state management Test parameters - lock_typename Tests both Lock threading Lock FileLock filelock FileLock types - lock_timeout Tests BLOCKING NON_BLOCKING BLOCKING_WITH_TIMEOUT modes - acquisition_mode Tests both safe context manager unsafe manual acquisition - release Tests unlocked never before_timeout after_timeout scenarios The test ensures - Safe acquisition properly manages lock lifecycle through context managers - Unsafe acquisition requires manual release behaves correctly - Timeout exceptions raised appropriately different timeout configurations - Lock states correctly maintained throughout acquisition release cycles - Different lock types Lock vs FileLock behave consistently their respective APIs inner lock_or_flock Union Lock FileLock timeout int - None is_lock lock_or_flock lock Lock = lock_or_flock acquisition_mode == safe locks _acquire_lock_with_timeout lock timeout=timeout assertTrue lock_or_flock_locked lock acquisition_mode == unsafe locks _unsafe_acquire_lock_with_timeout lock timeout=timeout assertTrue lock_or_flock_locked lock lock release raise NotImplementedError is_flock lock_or_flock flock FileLock = lock_or_flock acquisition_mode == safe locks _acquire_flock_with_timeout flock timeout=timeout assertTrue lock_or_flock_locked flock acquisition_mode == unsafe locks _unsafe_acquire_flock_with_timeout flock timeout=timeout assertTrue lock_or_flock_locked flock flock release raise NotImplementedError raise NotImplementedError assertFalse lock_or_flock_locked lock_or_flock assert lock_typename Lock FileLock flock_fpath Path = impls _OnDiskCacheImpl _cache_dir f testing-locks-instance- random_string lock lock_or_flock Union Lock FileLock = Lock lock_typename == Lock FileLock str flock_fpath lock_exception_type type = exceptions LockTimeoutError lock_typename == Lock exceptions FileLockTimeoutError release == unlocked assertFalse lock_or_flock_locked lock_or_flock release never before_timeout after_timeout assertTrue lock_or_flock acquire timeout=locks _NON_BLOCKING assertTrue lock_or_flock_locked lock_or_flock raise NotImplementedError executor executor assert lock_timeout BLOCKING NON_BLOCKING BLOCKING_WITH_TIMEOUT lock_or_flock_future Future None = executor submit inner lock_or_flock timeout= BLOCKING locks _BLOCKING NON_BLOCKING locks _NON_BLOCKING BLOCKING_WITH_TIMEOUT locks _BLOCKING_WITH_TIMEOUT lock_timeout release == unlocked assertIsNone lock_or_flock_future result release == never wait lock_or_flock_future timeout= locks _BLOCKING_WITH_TIMEOUT lock_timeout == BLOCKING assertRaises TimeoutError lock_or_flock_future result timeout=locks _BLOCKING_WITH_TIMEOUT lock_timeout NON_BLOCKING BLOCKING_WITH_TIMEOUT assertRaises lock_exception_type lock_or_flock_future result raise NotImplementedError lock_or_flock release release == before_timeout wait lock_or_flock_future timeout= locks _BLOCKING_WITH_TIMEOUT lock_or_flock release lock_timeout BLOCKING BLOCKING_WITH_TIMEOUT assertIsNone lock_or_flock_future result lock_timeout == NON_BLOCKING assertRaises lock_exception_type lock_or_flock_future result raise NotImplementedError release == after_timeout wait lock_or_flock_future timeout= locks _BLOCKING_WITH_TIMEOUT lock_or_flock release lock_timeout == BLOCKING assertIsNone lock_or_flock_future result lock_timeout NON_BLOCKING BLOCKING_WITH_TIMEOUT assertRaises lock_exception_type lock_or_flock_future result raise NotImplementedError flock_fpath unlink missing_ok=True patch object locks _BLOCKING_WITH_TIMEOUT patch object locks _DEFAULT_TIMEOUT parametrize impl_typename_combos list combinations TestMixin impl_typenames + list combinations TestMixin impl_typenames test_acquire_many_impl_locks_with_timeout impl_typename_combos tuple str - None impls list impls _CacheImpl = impl_typename impl_typename_combos impl impls _CacheImpl = impl_from_typename impl_typename impls append impl locks _acquire_many_impl_locks_with_timeout impls impl impls hasattr impl _lock assertTrue impl _lock locked hasattr impl _flock assertTrue impl _flock is_locked impl impls hasattr impl _lock assertFalse impl _lock locked hasattr impl _flock assertFalse impl _flock is_locked instantiate_parametrized_tests UtilsTest TestMixin TestCase test_lru_cache - None Test LRU cache decorator works correctly various argument types Verifies _lru_cache decorator properly caches function results handles different types arguments including integers floats strings keyword arguments Tests cached calls identical results non-cached calls proper argument preservation utils _lru_cache foo args kwargs args kwargs assertEqual foo assertEqual foo assertEqual foo foo foo assertEqual foo foo bar= bar foo bar bar parametrize pickle_able True False test_try_pickle_key pickle_able bool - None Test cache key pickling works correctly raises appropriate exceptions Verifies _try_pickle_key function successfully pickles serializable cache keys raises KeyPicklingError non-serializable keys like lambda functions Tests both successful pickling path error handling pickle_able key str = random_string assertEqual pickle loads utils _try_pickle_key key key assertRaises exceptions KeyPicklingError _ = utils _try_pickle_key lambda None parametrize pickle_able True False test_try_pickle_value pickle_able bool - None Test cache value pickling works correctly raises appropriate exceptions Verifies _try_pickle_value function successfully pickles serializable cache values raises ValuePicklingError non-serializable values like lambda functions Tests both successful pickling proper error handling pickle_able value str = random_string assertEqual pickle loads utils _try_pickle_value value value assertRaises exceptions ValuePicklingError _ = utils _try_pickle_value lambda None parametrize unpickle_able True False test_try_unpickle_value unpickle_able bool - None Test cache value unpickling works correctly raises appropriate exceptions Verifies _try_unpickle_value function successfully unpickles valid pickled data raises ValueUnPicklingError invalid data like None Tests both successful unpickling proper error handling corrupted data unpickle_able value str = random_string assertEqual utils _try_unpickle_value pickle dumps value value assertRaises exceptions ValueUnPicklingError _ = utils _try_unpickle_value b foo __name__ == __main__ run_tests
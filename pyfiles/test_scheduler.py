Owner s module sparse warnings torch nn torch ao pruning BaseScheduler CubicSL LambdaSL WeightNormSparsifier torch testing _internal common_utils raise_on_run_directly TestCase ImplementedScheduler BaseScheduler get_sl last_epoch group sparsity_level group sparsifier groups list base_sl TestScheduler TestCase test_constructor model = nn Sequential nn Linear sparsifier = WeightNormSparsifier sparsifier prepare model config=None scheduler = ImplementedScheduler sparsifier assert scheduler sparsifier sparsifier assert scheduler _step_count == assert scheduler base_sl == sparsifier groups sparsity_level test_order_of_steps Checks warning thrown scheduler step called before sparsifier step model = nn Sequential nn Linear sparsifier = WeightNormSparsifier sparsifier prepare model config=None scheduler = ImplementedScheduler sparsifier Sparsifier step called assertWarns UserWarning scheduler step Correct order has no warnings Note This will trigger other warnings present warnings catch_warnings record=True w sparsifier step scheduler step Make sure there no warning related base_scheduler warning w fname = warning filename fname = join fname split - assert fname = torch ao sparsity scheduler base_scheduler py test_step model = nn Sequential nn Linear sparsifier = WeightNormSparsifier sparsifier prepare model config=None assert sparsifier groups sparsity_level == scheduler = ImplementedScheduler sparsifier assert sparsifier groups sparsity_level == sparsifier step scheduler step assert sparsifier groups sparsity_level == test_lambda_scheduler model = nn Sequential nn Linear sparsifier = WeightNormSparsifier sparsifier prepare model config=None assert sparsifier groups sparsity_level == scheduler = LambdaSL sparsifier lambda epoch epoch assert sparsifier groups sparsity_level == Epoch scheduler step assert sparsifier groups sparsity_level == Epoch TestCubicScheduler TestCase setUp model_sparse_config = tensor_fqn weight sparsity_level tensor_fqn weight sparsity_level sorted_sparse_levels = conf sparsity_level conf model_sparse_config initial_sparsity = initial_step = _make_model kwargs model = nn Sequential nn Linear nn Dropout nn Linear model _make_scheduler model kwargs sparsifier = WeightNormSparsifier sparsifier prepare model config=self model_sparse_config scheduler_args = init_sl initial_sparsity init_t initial_step scheduler_args update kwargs scheduler = CubicSL sparsifier scheduler_args sparsifier scheduler staticmethod _get_sparsity_levels sparsifier precision= r Gets current levels sparsity sparsifier round group sparsity_level precision group sparsifier groups test_constructor model = _make_model sparsifier scheduler = _make_scheduler model=model initially_zero=True assertIs scheduler sparsifier sparsifier msg= Sparsifier properly attached assertEqual scheduler _step_count msg= Scheduler initialized incorrect step count assertEqual scheduler base_sl sorted_sparse_levels msg= Scheduler did store target sparsity levels correctly Value before t_ assertEqual _get_sparsity_levels sparsifier scheduler _make_sure_a_list msg= Sparsifier reset correctly after attaching Scheduler Value before t_ s_ model = _make_model sparsifier scheduler = _make_scheduler model=model initially_zero=False assertEqual _get_sparsity_levels sparsifier scheduler _make_sure_a_list initial_sparsity msg= Sparsifier reset correctly after attaching Scheduler test_step For n= dt= there will totally steps between s_ s_f starting t_ model = _make_model sparsifier scheduler = _make_scheduler model=model initially_zero=True init_t= delta_t= total_t= scheduler step scheduler step assertEqual scheduler _step_count msg= Scheduler step_count expected increment Value before t_ supposed assertEqual _get_sparsity_levels sparsifier scheduler _make_sure_a_list msg= Scheduler step updating sparsity level before t_ scheduler step Step = = sparsity = initial_sparsity assertEqual _get_sparsity_levels sparsifier scheduler _make_sure_a_list initial_sparsity msg= Sparsifier reset initial sparsity first step scheduler step Step = = sparsity ~ assertEqual _get_sparsity_levels sparsifier msg= Sparsity level set correctly after first step current_step = scheduler _step_count - scheduler init_t - more_steps_needed = scheduler delta_t scheduler total_t - current_step _ range more_steps_needed More steps needed final sparsity level scheduler step assertEqual _get_sparsity_levels sparsifier sorted_sparse_levels msg= Sparsity level reaching target level after delta_t n steps __name__ == __main__ raise_on_run_directly test test_ao_sparsity py
Owner s module dynamo unittest mock patch torch torch _dynamo torch _dynamo test_case torch _dynamo testing CompileCounter _variable = _variable_ = user_function torch compiler is_compiling user_generator _ range yield torch compiler is_compiling MyModule torch nn Module __init__ mode int super __init__ mode = mode register_forward_pre_hook pre_forward with_kwargs=True pre_forward module args kwargs mode == user_function global _variable _variable += args kwargs forward x global _variable _variable_ mode == torch compiler is_compiling _variable += _variable_ += mode == user_function _variable += mode == lambda_f = lambda torch compiler is_compiling noqa E lambda_f _variable += mode == cond user_generator cond _variable += mode == x += mode == user_function torch _dynamo graph_break _variable += x SkipNonTensorTests torch _dynamo test_case TestCase test_add_tensor fn b + b counter = CompileCounter x = torch randn y = opt_fn = torch _dynamo optimize_assert counter fn opt_fn x y assert counter op_count == test_add_tensor fn b torch add b counter = CompileCounter x = torch randn y = opt_fn = torch _dynamo optimize_assert counter fn opt_fn x y assert counter op_count == test_add_tensor_list fn lst lst + lst counter = CompileCounter x = torch randn y = opt_fn = torch _dynamo optimize_assert counter fn opt_fn x y assert counter op_count == test_add_tensor_dict fn dt dt + dt b counter = CompileCounter x = torch randn y = opt_fn = torch _dynamo optimize_assert counter fn opt_fn x b y assert counter op_count == test_add_skip fn b + b counter = CompileCounter opt_fn = torch _dynamo optimize_assert counter fn x = y = opt_fn x y assert counter op_count == patch object torch _dynamo config raise_on_ctx_manager_usage False test_recursive_list fn x x counter = CompileCounter x = x append x torch _dynamo optimize_assert counter fn x assert counter op_count == patch object torch _dynamo config raise_on_ctx_manager_usage False test_custom_list fn x x + x counter = CompileCounter Foo list __iter__ raise Exception noqa TRY __len__ raise Exception noqa TRY x = Foo x append torch randn x append torch randn torch _dynamo optimize_assert counter fn x assert counter op_count == test_do_not_skip_side_effects https github com pytorch pytorch issues By invoking torch compiler is_compiling there may side-effects inconsistent eager when compiling Thus we force dynamo commit graph even does perform any tensor operation global _variable _variable_ mode range torch _dynamo reset _variable = _variable_ = mod = MyModule mode=mode model = torch compile mod backend= eager fullgraph=mode = assert _variable == assert _variable_ == model torch tensor assert _variable == assert _variable_ == model torch tensor assert _variable == assert _variable_ == __name__ == __main__ torch _dynamo test_case run_tests run_tests
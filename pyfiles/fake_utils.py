mypy ignore-errors functools warnings collections abc Callable typing Any Union torch torch utils _pytree pytree torch _ops OpOverload torch _subclasses fake_tensor FakeTensor FakeTensorMode MetadataMismatchError tree_flatten_only UnsupportedFakeTensorException torch utils _python_dispatch TorchDispatchMode aten = torch _ops ops aten outputs_alias_inputs outputs inputs input_storages = inp _typed_storage _cdata inp tree_flatten_only torch Tensor inputs torch _C _has_storage inp any torch _C _has_storage out out _typed_storage _cdata input_storages out tree_flatten_only torch Tensor outputs outputs_are_inputs outputs inputs input_ids = id inp inp tree_flatten_only torch Tensor inputs any id out input_ids out tree_flatten_only torch Tensor outputs output_alias_each_other outputs storages = set out tree_flatten_only torch Tensor outputs torch _C _has_storage out continue stor = out _typed_storage _cdata stor storages True storages add stor False _check_alias_info context real_out real_in fake_out fake_in r_aliasing = outputs_alias_inputs real_out real_in f_aliasing = outputs_alias_inputs fake_out fake_in r_aliasing = f_aliasing raise MetadataMismatchError f context mismatch outputs_alias_inputs check f_aliasing = r_aliasing r_identity_eq = outputs_are_inputs real_out real_in f_identity_eq = outputs_are_inputs fake_out fake_in r_identity_eq = f_identity_eq raise MetadataMismatchError f context mismatch outputs_are_inputs check f_identity_eq = r_identity_eq r_output_alias_each_other = output_alias_each_other real_out f_output_alias_each_other = output_alias_each_other fake_out r_output_alias_each_other = f_output_alias_each_other raise MetadataMismatchError f context mismatch outputs_alias_each_other check f f_output_alias_each_other = r_output_alias_each_other is_sdpa_error func idx e func aten _scaled_dot_product_flash_attention default func aten _flash_attention_forward default idx Devices repr e True func aten _scaled_dot_product_efficient_attention default func aten _efficient_attention_forward default idx Devices repr e True func aten _scaled_dot_product_cudnn_attention default idx Devices repr e True False try_convert_fake_to_real ten_list list Union FakeTensor Any - list Union FakeTensor torch Tensor Any Attempt convert fake tensors corresponding real tensor correct underlying storage looking up FakeTensorMode meta real storage mapping On failure find storage mapping FakeTensor will remain list Note currently optimized makes copies meta converter internal dictionaries fake_tensor = next item item ten_list isinstance item FakeTensor None fake_tensor None ten_list fake_mode = fake_tensor fake_mode meta_converter = fake_mode fake_tensor_converter meta_converter desc = meta_converter describer storage_to_key = v k k v meta_converter storage_memo items key_to_real_storage = v k k v desc lookup_storage items out = t ten_list isinstance t FakeTensor t layout = torch strided out append t continue key = storage_to_key get t untyped_storage real_storage = None key None key_to_real_storage get key real_storage None out append t continue unhinted = False map_symint s nonlocal unhinted isinstance s torch SymInt s unhinted = unhinted unhinted s node has_hint s node hint stor_offset = map_symint t storage_offset size = map_symint s s t shape stride = map_symint s s t stride unhinted out append t continue new_tensor = torch empty dtype=t dtype device=t device new_tensor set_ real_storage storage_offset=stor_offset size=size stride=stride out append new_tensor clone out _check_fake_real_tensors real_out torch Tensor fake_out FakeTensor context= sizes=True strides=False storage_offset=True requires_grad=True requires_grad real_out requires_grad = fake_out requires_grad raise MetadataMismatchError f context mismatched requires_grad-ness outputs f This usually means you have added autograd support f your operator dispatch key other than Autograd f which will lead problems torch _C _has_storage real_out r_offset = real_out storage_offset f_offset = fake_out storage_offset r_offset = f_offset raise MetadataMismatchError f context mismatched storage offset torch _prims utils compare_tensor_meta real_out fake_out check_sizes=sizes check_strides=strides allow_rhs_unbacked=True CrossRefFakeMode TorchDispatchMode __init__ ignore_op_fn Union Callable OpOverload bool None = None check_strides=True check_aliasing=True only_check_ops_with_meta=True super __init__ ignore_op_fn = ignore_op_fn ignore_op_fn None lambda fn False check_strides = check_strides check_aliasing = check_aliasing only_check_ops_with_meta = only_check_ops_with_meta __torch_dispatch__ func types args= kwargs=None kwargs = kwargs fake_r = None empty_like excluded now due sparse complex aten _to_dense default one getting called csc func aten lift_fresh default aten lift_fresh_copy default aten set_ source_Storage_storage_offset ignore_op_fn func only_check_ops_with_meta torch _subclasses fake_impls has_meta func torch Tag dynamic_output_shape func tags torch Tag inplace_view func tags torch Tag data_dependent_output func tags Do symbolic_shapes top module imports sympy s slow torch fx experimental symbolic_shapes ShapeEnv try TODO enable_python_dispatcher here FakeTensorMode shape_env=ShapeEnv fake_mode fake_args fake_kwargs = pytree tree_map_only torch Tensor functools partial fake_mode from_tensor static_shapes=True args kwargs warnings catch_warnings fake_r = func fake_args fake_kwargs except UnsupportedFakeTensorException pass context = f When comparing output func FakeTensor concrete Tensors f found r = func args kwargs fake_r None r_flat = pytree tree_leaves r f_flat = pytree tree_leaves fake_r assert len f_flat == len r_flat f context mismatch number returns len f_flat = len r_flat check_aliasing _check_alias_info context r args kwargs fake_r fake_args fake_kwargs idx r_out f_out enumerate zip pytree tree_leaves r pytree tree_leaves fake_r r_is_ten = isinstance r_out torch Tensor assert r_is_ten == isinstance f_out torch Tensor f context mismatched number tensor outputs r_is_ten try _check_fake_real_tensors r_out f_out sizes=True strides=self check_strides storage_offset=True requires_grad=True except Exception e is_sdpa_error func idx e continue error_message = f context mismatched tensor metadata e len r_flat == f context mismatched tensor metadata output idx e raise MetadataMismatchError error_message e r
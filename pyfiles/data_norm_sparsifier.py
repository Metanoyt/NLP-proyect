mypy allow-untyped-defs operator functools reduce typing Any Optional torch torch nn functional F base_data_sparsifier BaseDataSparsifier __all__ = DataNormSparsifier DataNormSparsifier BaseDataSparsifier r L -Norm Sparsifier This sparsifier computes L -norm every sparse block zeroes-out ones lowest norm The level sparsity defines how many blocks removed This sparsifier controlled three variables ` sparsity_level ` defines number sparse blocks zeroed-out ` sparse_block_shape ` defines shape sparse blocks Note sparse blocks originate zero-index tensor ` zeros_per_block ` number zeros we expecting each sparse block By default we assume all elements within block zeroed-out However setting variable sets target number zeros per block The zeros within each block chosen smallest absolute values Args sparsity_level The target level sparsity sparse_block_shape The shape sparse block zeros_per_block Number zeros sparse block Note All arguments DataNormSparsifier constructor default arguments could overridden configuration provided ` add_data ` step __init__ data_list Optional list tuple str Any = None sparsity_level float = sparse_block_shape tuple int int = zeros_per_block Optional int = None norm str = L zeros_per_block None zeros_per_block = reduce operator mul sparse_block_shape norm L L raise AssertionError only L L norm supported moment defaults = sparsity_level sparsity_level sparse_block_shape sparse_block_shape zeros_per_block zeros_per_block norm = norm super __init__ data_list=data_list defaults __get_scatter_folded_mask data dim indices output_size sparse_block_shape mask = torch ones_like data mask scatter_ dim=dim index=indices value= zeroing out mask = F fold mask output_size=output_size kernel_size=sparse_block_shape stride=sparse_block_shape mask = mask torch int mask __get_block_level_mask data sparse_block_shape zeros_per_block Assume data squeezed tensor height width = data shape - data shape - block_height block_width = sparse_block_shape values_per_block = block_height block_width just zeros zeroing all elements block values_per_block == zeros_per_block torch zeros_like data dtype=torch int creating additional height width support padding dh = block_height - height block_height block_height dw = block_width - width block_width block_width create new padded tensor like data match block_shape padded_data = torch ones height + dh width + dw dtype=data dtype device=data device padded_data = padded_data torch nan can also replaced stop removal edge data padded_data height width = data unfolded_data = F unfold padded_data None None kernel_size=sparse_block_shape stride=sparse_block_shape _ sorted_idx = torch sort unfolded_data dim= sorted_idx = sorted_idx zeros_per_block zero out zeros_per_block number elements mask = __get_scatter_folded_mask data=unfolded_data dim= indices=sorted_idx output_size=padded_data shape sparse_block_shape=sparse_block_shape mask = mask squeeze squeeze height width contiguous remove padding make contiguous mask __get_data_level_mask data sparsity_level sparse_block_shape height width = data shape - data shape - block_height block_width = sparse_block_shape dh = block_height - height block_height block_height dw = block_width - width block_width block_width data_norm = F avg_pool d data None None kernel_size=sparse_block_shape stride=sparse_block_shape ceil_mode=True values_per_block = reduce operator mul sparse_block_shape data_norm = data_norm flatten num_blocks = len data_norm data_norm = data_norm repeat values_per_block get similar shape after unfold _ sorted_idx = torch sort data_norm dim= threshold_idx = round sparsity_level num_blocks number blocks remove sorted_idx = sorted_idx threshold_idx mask = __get_scatter_folded_mask data=data_norm dim= indices=sorted_idx output_size= height + dh width + dw sparse_block_shape=sparse_block_shape mask = mask squeeze squeeze height width squeeze only first dimension mask update_mask type ignore override name data sparsity_level sparse_block_shape zeros_per_block kwargs values_per_block = reduce operator mul sparse_block_shape zeros_per_block values_per_block raise ValueError Number zeros per block cannot more than total number elements block zeros_per_block raise ValueError Number zeros per block should positive norm == L data_norm = torch abs data squeeze absolute value based L data_norm = data data squeeze square every element L len data_norm shape only supports dimensional data moment raise ValueError only supports -D moment len data_norm shape == case data bias D data_norm = data_norm None mask = get_mask name sparsity_level = zeros_per_block == mask data = torch ones_like mask sparsity_level = zeros_per_block == values_per_block mask data = torch zeros_like mask Fetch high level mask zeros out entire blocks data_lvl_mask = __get_data_level_mask data=data_norm sparsity_level=sparsity_level sparse_block_shape=sparse_block_shape Fetch block level mask zeros out zeros_per_block number elements every block block_lvl_mask = __get_block_level_mask data=data_norm sparse_block_shape=sparse_block_shape zeros_per_block=zeros_per_block zero out entries inside those blocks whose block sparsified mask data = torch where data_lvl_mask == data_lvl_mask block_lvl_mask
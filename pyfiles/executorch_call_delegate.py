mypy allow-untyped-defs Copyright c Meta Platforms Inc affiliates All rights reserved This source code licensed under BSD-style license found LICENSE file root directory source tree pyre-strict __future__ annotations typing Any cast torch torch utils _pytree pytree torch _ops HigherOrderOperator torch _subclasses fake_tensor FakeTensorMode torch fx experimental proxy_tensor disable_proxy_modes_tracing get_proxy_slot ProxyTorchDispatchMode track_tensor_tree torch utils _pytree tree_flatten ExecutorchCallDelegate HigherOrderOperator __init__ super __init__ executorch_call_delegate __call__ lowered_module args super __call__ lowered_module args executorch_call_delegate = ExecutorchCallDelegate executorch_call_delegate fallthrough torch _C DispatchKey PythonDispatcher executorch_call_delegate fallthrough torch _C DispatchKey PythonTLSSnapshot executorch_call_delegate fallthrough torch _C DispatchKey ADInplaceOrView executorch_call_delegate fallthrough torch _C DispatchKey AutocastCPU LOWERED_BACKEND_MODULE_TYPE = LoweredBackendModule pyre-ignore trace_call_delegate proxy_mode func_overload lowered_module args pyre-ignore _unwrap_proxy e isinstance e torch Tensor torch SymInt torch SymFloat e get_proxy_slot cast torch Tensor e proxy_mode tracer e lambda e e proxy type ignore attr-defined is_lowered_module lowered_module raise ValueError executorch_call_delegate s first argument must LoweredBackendModule disable_proxy_modes_tracing out = call_delegate_cpu lowered_module args get_lowered_module_name proxy_mode tracer root lowered_module node_args = lowered_module args proxy_args = pytree tree_map _unwrap_proxy node_args out_proxy = proxy_mode tracer create_proxy call_function func_overload proxy_args name= executorch_call_delegate track_tensor_tree out out_proxy constant=None tracer=proxy_mode tracer executorch_call_delegate py_impl torch _C DispatchKey CompositeExplicitAutograd pyre-ignore call_delegate_cpu lowered_module args FX creates immutable_dict list concept Get rid map_types dict type type = torch fx immutable_collections immutable_dict dict torch fx immutable_collections immutable_list list new_args = pytree tree_map_only tuple map_types keys lambda map_types type args lambda isinstance tuple map_types keys lowered_module original_module module new_args executorch_call_delegate py_autograd_impl pyre-ignore call_delegate_autograd lowered_module args TODO support autograd flat_operands _ = tree_flatten lowered_module args requires_grad = any f requires_grad f flat_operands isinstance f torch Tensor torch _C _ExcludeDispatchKeyGuard torch _C DispatchKeySet torch _C DispatchKey AutogradCPU res = executorch_call_delegate lowered_module args requires_grad Create aliases output has requires_grad=True We need least one inputs err_fn require grad so output will have grad_fn pyre-ignore fake_requires_grad var var None var = var detach torch is_floating_point var torch is_complex var var requires_grad = True var pytree tree_map_only torch Tensor fake_requires_grad res res executorch_call_delegate py_impl ProxyTorchDispatchMode pyre-ignore call_delegate_proxy_torch_dispatch_mode mode lowered_module args res = trace_call_delegate mode executorch_call_delegate lowered_module args res executorch_call_delegate py_impl FakeTensorMode pyre-ignore call_delegate_fake_tensor_mode mode lowered_module args mode call_delegate_cpu lowered_module args executorch_call_delegate py_functionalize_impl pyre-ignore call_delegate_functionalize ctx lowered_module args unwrapped_args = tuple ctx unwrap_tensors arg arg args ctx redispatch_to_next res = executorch_call_delegate lowered_module unwrapped_args ctx wrap_tensors res pyre-ignore Missing parameter annotation Parameter ` obj ` must have type other than ` Any ` Pyre is_lowered_module obj Any - bool This function added avoid using isinstance obj LoweredBackendModule will LoweredBackendModule which may cause circular type obj __name__ == LOWERED_BACKEND_MODULE_TYPE get_lowered_module_name root torch nn Module pyre-ignore Undefined invalid type Annotation ` LoweredBackendModule ` defined type lowered_module LOWERED_BACKEND_MODULE_TYPE type ignore valid-type - str Adds given lowered_module into given root module returns name module added Find qualifying name lowered submodule qualname = None i = while True qualname = f lowered_module_ i hasattr root qualname break i += assert qualname None root add_module qualname lowered_module qualname
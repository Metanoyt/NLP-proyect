dataclasses importlib inspect io logging pickle types collections abc Callable contextlib AbstractContextManager ExitStack dataclasses dataclass typing Any Optional TYPE_CHECKING torch torch fx torch _dynamo graph_utils _graph_device_type torch _dynamo package SystemInfo convert_frame aot_compile_types BundledAOTAutogradSerializableCallable SerializableCallable hooks Hooks TYPE_CHECKING guards GuardManagerWrapper package SourceInfo log = logging getLogger __name__ bind_locals signature inspect Signature args Any kwargs Any - dict str Any bound_arguments = signature bind args kwargs bound_arguments apply_defaults bound_arguments arguments dataclass CompileArtifacts signature inspect Signature bytecode types CodeType guard_manager Optional GuardManagerWrapper guards_state bytes import_sources dict str str backend_id str compiled_fn SerializableCallable original_code types CodeType closure Optional tuple Any argdefs Optional tuple Any source_info SourceInfo device_type str system_info SystemInfo = dataclasses field default_factory=SystemInfo current check_compatibility - None current_system = SystemInfo current current_system check_compatibility system_info device_type AOTCompilePickler pickle Pickler classmethod _unpickle_cell cls val Any - Any _ - Any val assert _ __closure__ None _ __closure__ pyrefly ignore bad-override reducer_override obj Any - Any isinstance obj type lambda x lambda x __closure__ type ignore index noqa PLC type _unpickle_cell obj cell_contents NotImplemented dataclass AOTCompiledFunction _artifacts CompileArtifacts _guard_check_enabled bool = True guard_check args Any kwargs Any - bool f_locals dict str Any = _artifacts closure assert _artifacts bytecode co_freevars len _artifacts closure == len _artifacts bytecode co_freevars f_locals = name cell cell_contents name cell zip _artifacts bytecode co_freevars _artifacts closure f_locals update bind_locals _artifacts signature args kwargs assert _artifacts guard_manager None _artifacts guard_manager check f_locals __post_init__ - None package load_guard_manager load_guards_state _artifacts check_compatibility import_sources = alias importlib import_module module_name alias module_name _artifacts import_sources items f_globals = import_sources _artifacts backend_id _artifacts compiled_fn pyrefly ignore read-only fn = types FunctionType _artifacts bytecode f_globals closure=self _artifacts closure argdefs=self _artifacts argdefs _artifacts guard_manager None guards_state = load_guards_state _artifacts guards_state _artifacts guard_manager = load_guard_manager guards_state _artifacts original_code f_globals __call__ args Any kwargs Any - Any assert _artifacts guard_manager None _guard_check_enabled guard_check args kwargs f_locals = bind_locals _artifacts signature args kwargs reason = str _artifacts guard_manager check_verbose f_locals raise RuntimeError f GuardManager check failed reason reason fn args kwargs source_info - SourceInfo _artifacts source_info save_compiled_function path str - None open path wb f f write type serialize classmethod serialize cls fn AOTCompiledFunction - bytes torch _dynamo package SerializedCode state = fn _artifacts __dict__ copy state guard_manager = None state bytecode = SerializedCode from_code_object state bytecode compiled_fn = state compiled_fn state compiled_fn = type compiled_fn deserialize_compile_artifacts type compiled_fn serialize_compile_artifacts compiled_fn state original_code = SerializedCode from_code_object state original_code buf = io BytesIO pickler = AOTCompilePickler buf pickler dump state buf getvalue classmethod deserialize cls data bytes - AOTCompiledFunction torch _dynamo package SerializedCode state = pickle loads data state bytecode = SerializedCode to_code_object state bytecode deserializer compiled_fn_state = state compiled_fn state compiled_fn = deserializer compiled_fn_state state original_code = SerializedCode to_code_object state original_code artifacts = CompileArtifacts state cls artifacts disable_guard_check - None _guard_check_enabled = False aot_compile_fullgraph model Any example_inputs tuple tuple Any dict str Any hooks Hooks backend Callable torch fx GraphModule list torch Tensor SerializableCallable - AOTCompiledFunction torch _dynamo guards CheckFunctionManager torch _dynamo package SourceInfo torch _dynamo utils dynamo_timed get_metrics_context torch _guards TracingContext args kwargs = example_inputs get_metrics_context dynamo_timed fullgraph_capture capture_output = convert_frame fullgraph_capture model args kwargs graph_capture_output = capture_output graph_capture_output assert graph_capture_output output_graph None hooks guard_filter_fn torch _dynamo types GuardFilterEntry new_guard_filter_fn guard_entries list GuardFilterEntry - list bool g is_global g guard_type CheckFunctionManager UNSUPPORTED_SERIALIZATION_GUARD_TYPES g guard_entries hooks guard_filter_fn = new_guard_filter_fn fn _ = convert_frame get_traced_fn model check_fn = graph_capture_output build_guards fn __code__ hooks=hooks save=True strict_error=True assert check_fn guards_state None backend_input = capture_output backend_input assert backend_input None backend_input graph_module _backend_id = backend_input backend_id type ignore assignment device_type = _graph_device_type backend_input graph_module graph tracing_context = TracingContext backend_input fake_mode tracing_context tensor_to_context = backend_input tensor_to_context torch _guards tracing tracing_context torch _functorch config patch bundled_autograd_cache True force_non_lazy_backward_lowering True compiled_fn = backend backend_input graph_module backend_input example_inputs If Inductor backend used grab compiled_fn PrecompileContext TODO should replaced once we make backend SerializableCallable directly isinstance backend torch _TorchCompileInductorWrapper compiled_fn = BundledAOTAutogradSerializableCallable compiled_fn isinstance compiled_fn SerializableCallable hasattr backend compiler_fn compiler_fn = backend compiler_fn compiler_fn = backend raise RuntimeError f Compiled function type type compiled_fn produced + f backend compiler_fn does implement SerializableCallable source_info = SourceInfo inlined_sources=set traced_code graph_capture_output traced_code source_info add_code traced_code artifacts = CompileArtifacts signature=convert_frame _get_signature fn bytecode=graph_capture_output bytecode guard_manager=check_fn guard_manager guards_state=check_fn guards_state import_sources=graph_capture_output import_sources backend_id=backend_input backend_id compiled_fn=compiled_fn original_code=fn __code__ closure=fn __closure__ argdefs=fn __defaults__ source_info=source_info device_type=device_type aot_compiled_fn = AOTCompiledFunction _artifacts=artifacts aot_compiled_fn dataclass ModelInput WIP type represents single model input Which consists tuple arguments set contexts which run model For each ModelInput we ll compile one full graph model then use guards generated dispatch between compiled graphs args tuple Any kwargs dict str Any contexts list AbstractContextManager Any dataclass AOTCompiledModel Represents single forward function model along dispatch compiled_results serializable We require model deserialize again model torch nn Module compiled_results list AOTCompiledFunction __call__ args Any kwargs Any - Any result compiled_results result guard_check model args kwargs result model args kwargs All guards failed just run one them throw guard check error compiled_results model args kwargs serialize - bytes data list bytes = result compiled_results data append AOTCompiledFunction serialize result pickle dumps data classmethod deserialize cls model torch nn Module data bytes - AOTCompiledModel torch _dynamo utils get_metrics_context torch _guards compile_context CompileContext results list bytes = pickle loads data compiled_results = result results compile_context CompileContext convert_frame get_compile_id get_metrics_context compiled_results append AOTCompiledFunction deserialize result cls model compiled_results aot_compile_module model torch nn Module inputs list ModelInput hooks Hooks backend Callable torch fx GraphModule list torch Tensor SerializableCallable - AOTCompiledModel Compiles single nn Module any number inputs returns compiled forward function compile_single_graph model_input ModelInput - AOTCompiledFunction example_inputs = model_input args model_input kwargs orig_forward = model forward ExitStack stack ctx model_input contexts stack enter_context ctx aot_compile_fullgraph orig_forward example_inputs hooks=hooks backend=backend compiled_results = model_input inputs log info Compiling input s model_input compiled_results append compile_single_graph model_input assert len compiled_results AOTCompiledModel model compiled_results
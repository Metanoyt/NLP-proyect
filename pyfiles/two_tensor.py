mypy ignore-errors torch torch utils _pytree pytree torch _export wrappers mark_subclass_constructor_exportable_experimental torch utils _python_dispatch return_and_correct_aliasing A simple tensor subclass holds two tensors internally runs every op both tensors TwoTensor torch Tensor staticmethod __new__ cls b outer_size=None outer_stride=None requires_grad=None outer_size None outer_size = size outer_stride None outer_stride = stride assert device == b device layout == b layout requires_grad == b requires_grad dtype == b dtype I guess would more accurate represent shape torch cat b shape shape = outer_size kwargs = kwargs strides = outer_stride kwargs storage_offset = storage_offset kwargs device = device kwargs layout = layout kwargs requires_grad = requires_grad requires_grad kwargs dtype = dtype out = torch Tensor _make_wrapper_subclass cls shape kwargs assert shape == b shape assert stride == b stride assert storage_offset == b storage_offset out torch _disable_dynamo mark_subclass_constructor_exportable_experimental __init__ b outer_size=None outer_stride=None requires_grad=None = b = b __repr__ a_repr = repr b_repr = repr b f TwoTensor a_repr b_repr __tensor_flatten__ b None staticmethod __tensor_unflatten__ inner_tensors meta outer_size outer_stride assert meta None b = inner_tensors inner_tensors b type torch Tensor assert outer_size None assert outer_stride None TwoTensor b outer_size outer_stride classmethod __torch_dispatch__ cls func types args kwargs kwargs None kwargs = args_a = pytree tree_map_only TwoTensor lambda x x args args_b = pytree tree_map_only TwoTensor lambda x x b args kwargs_a = pytree tree_map_only TwoTensor lambda x x kwargs kwargs_b = pytree tree_map_only TwoTensor lambda x x b kwargs out_a = func args_a kwargs_a out_b = func args_b kwargs_b out_a_flat spec = pytree tree_flatten out_a out_b_flat = pytree tree_leaves out_b aten ops non-tensors just assume our two inner tensors same value out_flat = cls o_a o_b isinstance o_a torch Tensor o_a o_a o_b zip out_a_flat out_b_flat strict=True out = pytree tree_unflatten out_flat spec torch _higher_order_ops cond cond_op func cond_op out return_and_correct_aliasing func args kwargs out get_elem_a TwoTensorMode torch utils _python_dispatch TorchDispatchMode __torch_dispatch__ func types args= kwargs=None out = func args kwargs torch _subclasses fake_tensor _is_tensor_constructor func out = TwoTensor out out clone out
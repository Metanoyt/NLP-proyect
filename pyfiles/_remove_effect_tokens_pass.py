mypy allow-untyped-defs operator torch torch _higher_order_ops effects _get_schema with_effects exported_program ExportedProgram graph_signature CustomObjArgument InputKind InputSpec OutputKind OutputSpec TokenArgument _remove_effect_tokens_from_graph_helper ep num_tokens input_token_names output_token_names inputs_to_lifted_custom_objs = ep graph_signature inputs_to_lifted_custom_objs output_node = None with_effect_nodes list torch fx Node = Output node need check its args against output_token_names collected output_spec Therefore we only need find top-levele output node output_node = next reversed ep graph_module graph find_nodes op= output module ep graph_module modules isinstance module torch fx GraphModule continue node module graph nodes node op == call_function node target with_effects continue with_effect_nodes append node Remove tokens outputs assert output_node None output_args = output_node args assert len output_args = num_tokens out_token_nodes = output_args num_tokens output_node args = tuple output_args num_tokens out_token out_token_nodes assert out_token name output_token_names out_token users clear ep graph erase_node out_token Replace with_effects token func args just func args node reversed with_effect_nodes func = node args assert isinstance func torch _ops OpOverload torch _ops HigherOrderOperator func torch ops higher_order call_torchbind custom_obj_meta = node args meta val type ignore union-attr assert isinstance custom_obj_meta CustomObjArgument custom_obj_meta fake_val custom_obj = custom_obj_meta fake_val node args name inputs_to_lifted_custom_objs type ignore union-attr custom_obj = ep constants inputs_to_lifted_custom_objs node args name type ignore union-attr raise RuntimeError f Unable find custom obj node node schema = _get_schema func custom_obj + node args schema = _get_schema func node args ep graph inserting_before node new_node = ep graph call_function func node args node kwargs k v node meta items new_node meta k = v k == unbacked_bindings Remove extra layer effect token old_bindings = new_node meta k new_bindings = k path path path k path old_bindings items new_node meta k = new_bindings node replace_all_uses_with new_node Update user getitem nodes user list new_node users keys assert user target operator getitem getitem with_effects == token user args == ep graph erase_node user len schema returns == If function has then will just directly result -- we don t need getitem So we can replace all getitem with_effects just note itself user list new_node users keys assert user args == user replace_all_uses_with new_node new_node meta val = node meta val len schema returns If function has more than then since we got rid st value token we need bump all other getitem calls down user list new_node users keys assert user args = user args = user args user args - new_node meta val = node meta val assert len schema returns == assert len new_node users == new_node meta val = None ep graph erase_node node Remove tokens inputs placeholders = node node ep graph nodes node op == placeholder assert len placeholders = num_tokens inp_token_nodes = placeholders num_tokens inp_token inp_token_nodes assert inp_token name input_token_names ep graph erase_node inp_token ep graph eliminate_dead_code _remove_effect_tokens ep ExportedProgram - ExportedProgram Removes existence tokens exported program including - Removes input output tokens - Replaces with_effects token func args just func args This function does inplace modification given ExportedProgram num_tokens int = input_token_names list str = new_input_specs list InputSpec = inp ep graph_signature input_specs inp kind == InputKind TOKEN num_tokens += assert isinstance inp arg TokenArgument input_token_names append inp arg name new_input_specs append inp num_out_tokens int = new_output_specs list OutputSpec = output_token_names list OutputSpec = out ep graph_signature output_specs out kind == OutputKind TOKEN num_out_tokens += output_token_names append out arg name new_output_specs append out Update graph signature ep graph_signature input_specs = new_input_specs ep graph_signature output_specs = new_output_specs assert num_tokens == num_out_tokens ep graph_module _set_replace_hook ep graph_signature get_replace_hook _remove_effect_tokens_from_graph_helper ep num_tokens input_token_names output_token_names ep
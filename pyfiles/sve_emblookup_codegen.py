mypy allow-untyped-defs argparse sys Unroll loops when block_size multiple vector length unroll num_unrolls IndexType InType OutType compute_output num_unrolls InType is_main code = pred = svAll is_main pg InType == float i range num_unrolls code append f output = svmla_x pred output svld svAll ip i k wgt i InType == Half i range num_unrolls code append f auto input i = svcvt_f _x pred svreinterpret_f \n f svld uh_u pred reinterpret_cast const uint _t ip i k i range num_unrolls code append f output = svmla_x pred output input i wgt i InType == BFloat i range num_unrolls code append f auto input i = svreinterpret_f svlsl_x pred \n f svld uh_u pred reinterpret_cast const uint _t ip i k i range num_unrolls code append f output = svmla_x pred output input i wgt i InType == uint _t code append f output = svadd_x pred output bio i range num_unrolls code append f auto input i = svcvt_f _x pred svld ub_u pred ip i k i range num_unrolls code append f output = svmla_x pred output input i wgt i raise ValueError f Unknown datatype InType code code = num_unrolls == code append tail loop code append j end_offset code append f unrolling num_unrolls times code append f while j + num_unrolls - end_offset i range num_unrolls code append f const auto idx i = indices pos + i check indices i range num_unrolls code append f idx i &#124; &#124; idx i = data_size \n + false \n + InType == uint _t i range num_unrolls code append f OutType wgt i = f code append f OutType bio = f i range num_unrolls code append f OutType wgt i = f code append weights i range num_unrolls code append f wgt i = weights IS_WEIGHT_POSITIONAL j + i - start_offset pos + i code append InType == uint _t code append scale_bias i range num_unrolls code append f bio += wgt i scale_bias idx i + code append f wgt i = wgt i scale_bias idx i code append i range num_unrolls code append f const InType const ip i = input idx i block_size compute store code append svbool_t pg code append int _t k = main loop code append while k + vLen - block_size code append auto output = svld svAll op k code extend compute_output num_unrolls InType True code append svst svAll op k output code append k += vLen code append tail loop code append k block_size code append pg = svwhilelt_b _s k block_size code append auto output = svld pg op k code extend compute_output num_unrolls InType False code append svst pg op k output code append k += vLen code append num_unrolls == code append pos ++ code append f j += num_unrolls code append f pos += num_unrolls code append code main parser = argparse ArgumentParser parser add_argument -f -- filename help= file name opts = parser parse_args opts filename filename = opts filename filename = embedding_lookup_idx_sve cc options = int _t int _t float float float float int _t int _t float float float float int _t int _t half Half float float int _t int _t half Half float float int _t int _t bfloat BFloat float float int _t int _t bfloat BFloat float float int _t int _t uint _t uint _t float float int _t int _t uint _t uint _t float float code = includes code append -------------------------- code append ATTENTION code append THIS CODE IS AUTOGENERATED code append f BY join sys argv code append DO NOT MODIFY code append -------------------------- \n code append #include arm_sve h code append #include c util BFloat h code append #include c util Half h code append #include cstdint code append #include cstring code append namespace caffe \n o options IndexTypeName IndexType InTypeName InType OutTypeName OutType = o code append template bool IS_WEIGHT_POSITIONAL fn_base = f EmbeddingLookupIdx_ IndexTypeName _ InTypeName _ OutTypeName suffix = __sve fn = static bool + fn_base + suffix code append fn + args = args append const int _t block_size args append const int _t output_size args append const int _t index_size args append const int _t data_size args append const + InType + input args append const + IndexType + indices args append const + IndexType + offsets args append const float weights args append const float scale_bias args append bool normalize_by_lengths args append + OutType + out code += args code append const svbool_t svAll = svptrue_b code append const auto vLen = static_cast int _t svcntw code append int _t pos = code append int _t i = i output_size ++i code append + OutType + const op = out i block_size initialize code append memset op sizeof float block_size inner loop code append pos = offsets i - offsets \n + false \n + code append int _t start_offset = offsets i \n + int _t end_offset = offsets i + code append int _t j = start_offset code += unroll IndexType InType OutType code += unroll IndexType InType OutType code += unroll IndexType InType OutType code += unroll IndexType InType OutType code += unroll IndexType InType OutType code append const int _t length = end_offset - start_offset \n code append normalize_by_lengths length = code append const float len_inv = f length code append svbool_t pg code append int _t j = code append while j + vLen - block_size code append svst svAll op j svmul_x svAll svld svAll op j len_inv code append j += vLen code append code append j block_size code append pg = svwhilelt_b _s j block_size code append svst pg op j svmul_x pg svld pg op j len_inv code append code append code append code append pos == index_size code append is_weight_positional false true code append bool + fn_base + _ + is_weight_positional + suffix + code += args Resolve Lint warnings Limit characters one line extra_space = \n ret_string = + fn_base + suffix + + is_weight_positional + len ret_string = code append ret_string code append + fn_base + suffix + + extra_space + is_weight_positional + code append block_size code append output_size code append index_size code append data_size code append input code append indices code append offsets code append weights code append scale_bias code append normalize_by_lengths code append out code append code append code append namespace caffe open filename w fout fout write \n join code + \n print Created + filename __name__ == __main__ main
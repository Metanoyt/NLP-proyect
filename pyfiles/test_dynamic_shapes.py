Owner s module onnx Unit tests _dynamic_shapes module __future__ annotations os tempfile onnx torch torch onnx _internal exporter _dynamic_shapes torch testing _internal common_utils torch utils _pytree SampleModelForDynamicShapes torch nn Module forward x b x relu b sigmoid NestedModelForDynamicShapes torch nn Module forward x torch Tensor ys list torch Tensor zs dict str torch Tensor c torch Tensor y = ys + ys + zs + zs b w = x shape c shape = x + w x + y c x - w x - y c SingnatureOnlyLlamaModel torch nn Module forward input_ids torch LongTensor = None attention_mask torch Tensor &#124; None = None position_ids torch LongTensor &#124; None = None past_key_values list torch FloatTensor &#124; None = None inputs_embeds torch FloatTensor &#124; None = None labels torch LongTensor &#124; None = None use_cache bool &#124; None = None output_attentions bool &#124; None = None output_hidden_states bool &#124; None = None return_dict bool &#124; None = None cache_position torch LongTensor &#124; None = None num_logits_to_keep int = kwargs pass common_utils instantiate_parametrized_tests TestDynamicShapes common_utils TestCase common_utils parametrize dynamic_shapes input_names expected_dynamic_axes It still passes when dynamic_shapes uses input_names input_x torch export Dim customx_dim_ torch export Dim customx_dim_ input_b torch export Dim customb_dim_ input_x input_b input_x input_b dynamic_shapes without names supported torch export Dim customx_dim_ torch export Dim customx_dim_ torch export Dim customb_dim_ None torch export Dim customb_dim_ input_x input_b input_x input_b partial dynamic_shapes only needs partial input_names torch export Dim customx_dim_ torch export Dim customx_dim_ x x test_from_dynamic_shapes_to_dynamic_axes_success dynamic_shapes input_names expected_dynamic_axes dynamic_axes = _dynamic_shapes from_dynamic_shapes_to_dynamic_axes dynamic_shapes=dynamic_shapes input_names=input_names exception=Exception assertEqual dynamic_axes expected_dynamic_axes test_from_dynamic_shapes_to_dynamic_axes_fails_when_input_names_is_less_than_flat_dynamic_shapes dynamic_shapes = torch export Dim dim torch export Dim dim torch export Dim dim torch export Dim dim input_names = input_x input_y input_z assertRaises ValueError _dynamic_shapes from_dynamic_shapes_to_dynamic_axes dynamic_shapes=dynamic_shapes input_names=input_names exception=Exception common_utils parametrize dynamic_shapes When dynamic_shapes one input None torch export Dim dim min= torch export Dim dim min= torch export Dim dim min= torch export Dim dim min= b torch export Dim dim min= None When dynamic_shapes axes None torch export Dim dim min= None torch export Dim dim min= None torch export Dim dim min= torch export Dim dim min= None b torch export Dim dim min= None test_dynamic_shapes_supports_nested_input_model_with_input_names_assigned dynamic_shapes kwargs can still renamed long s order input_names = input_x input_y input_z d e f dynamic_axes = _dynamic_shapes from_dynamic_shapes_to_dynamic_axes dynamic_shapes=dynamic_shapes input_names=input_names exception=Exception expected_dynamic_axes = input_x input_y input_z d e assertEqual dynamic_axes expected_dynamic_axes model = NestedModelForDynamicShapes input = torch ones torch zeros torch ones torch zeros b torch ones torch ones Test model converted dynamic_axes tempfile TemporaryDirectory temp filename = os path join temp model onnx torch onnx export model input filename dynamic_axes=dynamic_axes input_names=input_names dynamo=False onnx_model = onnx load filename assertTrue all input type tensor_type shape dim dim_param input onnx_model graph input - The test can t parametrized because torch export Dim generates objects we need exact same object compare them test__unflatten_dynamic_shapes_with_inputs_tree_succeeds_on_tuple inputs = torch randn torch randn x_dim = torch export Dim x_dim_ y_dim = torch export Dim y_dim_ dynamic_shapes = x x_dim y y_dim unflatten_dynamic_shapes = _dynamic_shapes _unflatten_dynamic_shapes_with_inputs_tree inputs dynamic_shapes expected_dynamic_shapes = x_dim y_dim assertEqual unflatten_dynamic_shapes expected_dynamic_shapes test__unflatten_dynamic_shapes_with_inputs_tree_succeeds_on_dict inputs = x torch randn y torch randn x_dim = torch export Dim x_dim_ y_dim = torch export Dim y_dim_ dynamic_shapes = x x_dim y y_dim unflatten_dynamic_shapes = _dynamic_shapes _unflatten_dynamic_shapes_with_inputs_tree inputs dynamic_shapes expected_dynamic_shapes = x x_dim y y_dim assertEqual unflatten_dynamic_shapes expected_dynamic_shapes test__unflatten_dynamic_shapes_with_inputs_tree_succeeds_on_tuple_of_mixed_structure inputs = torch randn x torch randn x torch randn torch randn torch randn torch randn torch randn w_dim_ = torch export Dim w_dim_ x _dim_ = torch export Dim x _dim_ x _dim_ = torch export Dim x _dim_ x _dim_ = torch export Dim x _dim_ y _dim_ = torch export Dim y _dim_ y _dim_ = torch export Dim y _dim_ y _dim_ = torch export Dim y _dim_ z _dim_ = torch export Dim z _dim_ z _dim_ = torch export Dim z _dim_ dynamic_shapes = w w_dim_ x x _dim_ x _dim_ x x _dim_ y y _dim_ y _dim_ y y _dim_ z z _dim_ z z _dim_ unflatten_dynamic_shapes = _dynamic_shapes _unflatten_dynamic_shapes_with_inputs_tree inputs dynamic_shapes expected_dynamic_shapes = w_dim_ x x _dim_ x _dim_ x x _dim_ y _dim_ y _dim_ y _dim_ z _dim_ z _dim_ assertEqual unflatten_dynamic_shapes expected_dynamic_shapes test__unflatten_dynamic_shapes_with_inputs_tree_succeeds_on_dict_of_mixed_structure inputs = w torch randn x x torch randn x torch randn y torch randn torch randn z torch randn torch randn w_dim_ = torch export Dim w_dim_ x _dim_ = torch export Dim x _dim_ x _dim_ = torch export Dim x _dim_ x _dim_ = torch export Dim x _dim_ y _dim_ = torch export Dim y _dim_ y _dim_ = torch export Dim y _dim_ y _dim_ = torch export Dim y _dim_ z _dim_ = torch export Dim z _dim_ z _dim_ = torch export Dim z _dim_ dynamic_shapes = w w_dim_ x x _dim_ x _dim_ x x _dim_ y y _dim_ y _dim_ y y _dim_ z z _dim_ z z _dim_ unflatten_dynamic_shapes = _dynamic_shapes _unflatten_dynamic_shapes_with_inputs_tree inputs dynamic_shapes expected_dynamic_shapes = w w_dim_ x x x _dim_ x _dim_ x x _dim_ y y _dim_ y _dim_ y _dim_ z z _dim_ z _dim_ assertEqual unflatten_dynamic_shapes expected_dynamic_shapes test__flatten_dynamic_shapes_to_axes_with_leaves_that_are_supported_by_exported_program dim = torch export Dim dim dynamic_shapes = input_a dim None input_b torch export Dim AUTO torch export Dim STATIC torch export Dim DYNAMIC None dim flatten_dynamic_shapes _ = _dynamic_shapes _flatten_dynamic_shapes_to_axes dynamic_shapes expected_flattened = dim None torch export Dim AUTO torch export Dim STATIC torch export Dim DYNAMIC None dim assertEqual flatten_dynamic_shapes expected_flattened common_utils parametrize model args kwargs input_names output_names dynamic_axes expected_dynamic_shapes llama- - B-Instruct trimmed SingnatureOnlyLlamaModel input_ids torch randn attention_mask torch randn position_ids torch randn past_key_values torch randn torch randn torch randn torch randn input_ids attention_mask position_ids past_key_values key past_key_values value past_key_values key past_key_values value logits present key present value present key present value input_ids batch_size sequence_length attention_mask batch_size past_sequence_length + sequence_length position_ids batch_size sequence_length past_key_values key batch_size past_sequence_length past_key_values value batch_size past_sequence_length past_key_values key batch_size past_sequence_length past_key_values value batch_size past_sequence_length logits batch_size sequence_length present key batch_size past_sequence_length + sequence_length present value batch_size past_sequence_length + sequence_length present key batch_size past_sequence_length + sequence_length present value batch_size past_sequence_length + sequence_length torch export Dim batch_size torch export Dim sequence_length torch export Dim batch_size torch export Dim past_sequence_lengthsequence_length torch export Dim batch_size torch export Dim sequence_length torch export Dim batch_size torch export Dim past_sequence_length torch export Dim batch_size torch export Dim past_sequence_length torch export Dim batch_size torch export Dim past_sequence_length torch export Dim batch_size torch export Dim past_sequence_length test_from_dynamic_axes_to_dynamic_shapes_succeeds_on_llm model args kwargs input_names output_names dynamic_axes expected_dynamic_shapes dynamic_shapes _ _ = _dynamic_shapes from_dynamic_axes_to_dynamic_shapes model args kwargs input_names=input_names output_names=output_names dynamic_axes=dynamic_axes NOTE torch export Dim being object makes impossible compare objects directly And s unrealistic test whole model so we testing structure dynamic_shapes _ tree = _pytree tree_flatten dynamic_shapes _ tree = _pytree tree_flatten expected_dynamic_shapes assertEqual tree tree test_convert_str_to_export_dim_returns_the_original_dynamic_shapes_when_there_is_no_str_and_dim Dict dynamic_shapes = input_x torch export Dim AUTO torch export Dim AUTO torch export Dim AUTO torch export Dim AUTO input_b torch export Dim AUTO dynamic_shapes_with_export_dim need_axis_mapping = _dynamic_shapes convert_str_to_export_dim dynamic_shapes assertEqual dynamic_shapes_with_export_dim dynamic_shapes assertFalse need_axis_mapping Tuple dynamic_shapes = torch export Dim AUTO torch export Dim AUTO torch export Dim AUTO torch export Dim AUTO torch export Dim AUTO dynamic_shapes_with_export_dim need_axis_mapping = _dynamic_shapes convert_str_to_export_dim dynamic_shapes assertEqual dynamic_shapes_with_export_dim dynamic_shapes assertFalse need_axis_mapping test_convert_str_to_export_dim_returns_the_converted_dynamic_shapes_when_there_is_str_or_dim dimx = torch export Dim customx_dim_ Dict dynamic_shapes = input_x customx_dim_ torch export Dim STATIC torch export Dim AUTO dimx input_b customb_dim_ expected_dynamic_shapes = input_x torch export Dim DYNAMIC torch export Dim STATIC torch export Dim AUTO dimx input_b torch export Dim DYNAMIC dynamic_shapes_with_export_dim need_axis_mapping = _dynamic_shapes convert_str_to_export_dim dynamic_shapes assertEqual dynamic_shapes_with_export_dim expected_dynamic_shapes assertTrue need_axis_mapping dimx = torch export Dim customx_dim_ Tuple dynamic_shapes = dimx torch export Dim DYNAMIC torch export Dim AUTO customx_dim_ torch export Dim STATIC expected_dynamic_shapes = dimx torch export Dim DYNAMIC torch export Dim AUTO torch export Dim DYNAMIC torch export Dim STATIC dynamic_shapes_with_export_dim need_axis_mapping = _dynamic_shapes convert_str_to_export_dim dynamic_shapes assertEqual dynamic_shapes_with_export_dim expected_dynamic_shapes assertTrue need_axis_mapping test__any_str_or_dim_in_dynamic_shapes_returns_true dynamic_shapes = input_x torch export Dim AUTO torch export Dim abc torch export Dim AUTO torch export Dim STATIC input_b customb_dim_ input_c None assertTrue _dynamic_shapes _any_str_or_dim_in_dynamic_shapes dynamic_shapes __name__ == __main__ common_utils run_tests
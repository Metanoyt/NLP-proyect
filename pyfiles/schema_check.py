mypy allow-untyped-defs dataclasses hashlib inspect re typing enum IntEnum typing Annotated Any ForwardRef Optional Union torch _export serde schema torch _export serde union _Union SchemaUpdateError Exception pass _check x msg x raise SchemaUpdateError msg _CPP_TYPE_MAP = str std string int int _t float F bool bool _THRIFT_TYPE_MAP = str string int i float double bool bool _staged_schema yaml_ret dict str Any = defs = cpp_enum_defs dict str str = cpp_class_defs dict str str = cpp_type_decls list str = cpp_json_defs list str = thrift_enum_defs list str = thrift_type_defs dict str str = _handle_aggregate ty - tuple dict str Any dict str Any dict str Any dump_type t level int - tuple str str str getattr t __name__ None cpp_enum_defs t __name__ int _t t __name__ t _CPP_TYPE_MAP t __name__ _CPP_TYPE_MAP t _THRIFT_TYPE_MAP t isinstance t str assert t defs assert t cpp_enum_defs assert t t f ForwardRef t t isinstance t ForwardRef t __forward_arg__ f ForwardRef t __forward_arg__ t __forward_arg__ o = typing get_origin t Lemme know there s better way do o list yaml_head cpp_head thrift_head thrift_tail = List std vector list o dict yaml_head cpp_head thrift_head thrift_tail = Dict std unordered_map map o == Union assert level == Optional only supported top level args = typing get_args t assert len args == args type None yaml_type cpp_type thrift_type = dump_type args level + f Optional yaml_type f std optional cpp_type f optional thrift_type o Annotated dump_type t __origin__ level raise AssertionError f Type t supported export schema yaml_arg_types cpp_arg_types thrift_arg_types = zip dump_type x level + x typing get_args t f yaml_head join yaml_arg_types f cpp_head join cpp_arg_types f thrift_head join thrift_arg_types thrift_tail isinstance t type t __name__ t __name__ t __name__ raise AssertionError f Type t supported export schema dump_cpp_value v - str v None std nullopt v True true v False false v == v == v == isinstance v str f v raise AssertionError f Default value v supported yet export schema dump_field f - tuple dict str Any str Optional str str int t cpp_type thrift_type = dump_type f type ret = type t cpp_default Optional str = None assert typing get_origin f type Annotated f Field f name must annotated integer id thrift_id = f type __metadata__ assert type thrift_id int f Field f name must annotated integer id value = dataclasses MISSING f default dataclasses MISSING value = f default f default_factory dataclasses MISSING value = f default_factory value dataclasses MISSING default = str value ret default = default cpp_default = dump_cpp_value value t startswith Optional value None raise AssertionError f Optional field ty __name__ f name must have default value None ret cpp_type cpp_default thrift_type thrift_id yaml_ret = cpp_ret = thrift_ret = thrift_ids = set f dataclasses fields ty yaml_res cpp_type cpp_default thrift_type thrift_id = dump_field f yaml_ret f name = yaml_res cpp_ret f name = cpp_type cpp_type cpp_default cpp_default thrift_ret f name = thrift_type thrift_type thrift_id thrift_id thrift_id thrift_ids raise AssertionError f Duplicate thrift id thrift_id field f name ty __name__ thrift_ids add thrift_id yaml_ret cpp_ret thrift_ret _handle_int_enum name ty yaml_ret name = kind enum fields x name x value x ty cpp_enum_defs name = f enum name chr join f x name = x value x ty inline std string_view printEnum const name e switch e chr join f case name x name chr x name chr x ty default throw std runtime_error Unknown enum value inline void parseEnum std string_view s name t chr join f s == chr x name chr t = name x name x ty throw std runtime_error Unknown enum value + std string s thrift_enum_defs append f enum name chr join f x name = x value x ty _handle_struct name ty fields cpp_fields thrift_fields = _handle_aggregate ty yaml_ret name = kind struct fields fields field_decls = \n join f f cpp_type name = + f cpp_default f cpp_default None name f cpp_fields items accessor name ty type_name = fields name type type_name cpp_enum_defs f type_name get_ name const static_cast type_name name void set_ name type_name name = static_cast int _t f const ty get_ name const name void set_ name ty name = std move to_json_decl = f void to_json nlohmann json nlohmann_json_j const name nlohmann_json_t to_json_def = f chr join f nlohmann_json_j name = nlohmann_json_t name name f cpp_fields items from_json_decl = f void from_json const nlohmann json nlohmann_json_j name nlohmann_json_t from_json_def = f name nlohmann_json_default_obj chr join f nlohmann_json_t name = nlohmann_json_j value name nlohmann_json_default_obj name name f cpp_fields items cpp_class_defs name = f name private field_decls public join accessor name f cpp_type name f cpp_fields items friend to_json_decl friend from_json_decl cpp_json_defs append f inline to_json_decl to_json_def cpp_json_defs append f inline from_json_decl from_json_def cpp_type_decls append f name thrift_type_defs name = f struct name chr join f f thrift_id f thrift_type n n f thrift_fields items _handle_union name ty fields cpp_fields thrift_fields = _handle_aggregate ty yaml_ret name = kind union fields fields accessor name ty idx f const ty get_ name const std get idx + variant_ void set_ name ty variant_ emplace idx + std move tag_ = Tag name upper to_json_branches = join f nlohmann_json_t tag_ == Tag name upper nlohmann_json_j name = nlohmann_json_t get_ name idx name f enumerate cpp_fields items from_json_branches = join f nlohmann_json_j contains name nlohmann_json_t variant_ emplace idx + nlohmann_json_j name template get f cpp_type nlohmann_json_t tag_ = Tag name upper idx name f enumerate cpp_fields items cpp_class_defs name = f name struct Void public enum Tag join name upper name cpp_fields private std variant Void join f cpp_type f cpp_fields values variant_ Tag tag_ public Tag tag const tag_ join accessor name f cpp_type idx idx name f enumerate cpp_fields items friend void to_json nlohmann json nlohmann_json_j const name nlohmann_json_t to_json_branches friend void from_json const nlohmann json nlohmann_json_j name nlohmann_json_t from_json_branches inline std string_view printEnum const name Tag e switch e chr join f case name Tag x upper chr x upper chr x cpp_fields default throw std runtime_error Unknown enum value inline void parseEnum std string_view s name Tag t chr join f s == chr x upper chr t = name Tag x upper x cpp_fields throw std runtime_error Unknown enum value + std string s cpp_type_decls append f name thrift_type_defs name = f union name chr join f f thrift_id f thrift_type n n f thrift_fields items name dir schema name startswith _ continue value = getattr schema name hasattr value __module__ value __module__ = schema __name__ continue defs name = value class_ordering = name value defs items isinstance value type issubclass value IntEnum _handle_int_enum name value dataclasses is_dataclass value class_ordering name = inspect findsource value issubclass value _Union _handle_union name value _handle_struct name value raise AssertionError f Unknown schema type name value isinstance value int tuple assert name SCHEMA_VERSION TREESPEC_VERSION raise AssertionError f Unknown variable name value yaml_ret SCHEMA_VERSION = list defs SCHEMA_VERSION assert all x x yaml_ret SCHEMA_VERSION yaml_ret TREESPEC_VERSION = defs TREESPEC_VERSION assert yaml_ret TREESPEC_VERSION cpp_header = f #pragma once #include optional #include stdexcept #include string #include unordered_map #include variant #include vector #include nlohmann json hpp #ifndef NLOHMANN_JSON_NAMESPACE_BEGIN #define NLOHMANN_JSON_NAMESPACE_BEGIN namespace nlohmann #endif #ifndef NLOHMANN_JSON_NAMESPACE_END #define NLOHMANN_JSON_NAMESPACE_END #endif https github com nlohmann json pull NLOHMANN_JSON_NAMESPACE_BEGIN template typename T struct adl_serializer std optional T static void to_json json j const std optional T opt opt == std nullopt j = nullptr j = opt will call adl_serializer T to_json which will find free function to_json T s namespace static void from_json const json j std optional T opt j is_null opt = std nullopt opt = j template get T same above adl_serializer T from_json NLOHMANN_JSON_NAMESPACE_END namespace torch namespace _export template typename T ForwardRef static_assert std is_reference_v T ForwardRef cannot reference type public ForwardRef ptr_ std make_unique T ForwardRef ForwardRef T ForwardRef const ForwardRef T other ptr_ std make_unique T other ptr_ ForwardRef T operator= ForwardRef T ForwardRef T operator= const ForwardRef T other ptr_ = std make_unique T other ptr_ ~ForwardRef const T operator const ptr_ const T operator- const ptr_ get void emplace T t ptr_ = std make_unique T std move t private std unique_ptr T ptr_ template typename T void to_json nlohmann json j const ForwardRef T p j = p template typename T void from_json const nlohmann json j ForwardRef T p p emplace j template get T F public double get const value_ void set double value value_ = value private double value_ inline void to_json nlohmann json j const F f std isinf f get j = Infinity std isinf -f get j = -Infinity std isnan f get j = NaN j = f get inline void from_json const nlohmann json j F f j == Infinity f set std numeric_limits double infinity j == -Infinity f set -std numeric_limits double infinity j == NaN f set std numeric_limits double quiet_NaN f set j get double chr join cpp_type_decls join cpp_enum_defs values join dict sorted cpp_class_defs items key=lambda x class_ordering x values chr join cpp_json_defs template typename T ForwardRef T ForwardRef ForwardRef T = default template typename T ForwardRef T ForwardRef T operator= ForwardRef T = default template typename T ForwardRef T ~ForwardRef = default namespace _export namespace torch thrift_schema = f namespace py torch _export namespace cpp torch _export schema chr join thrift_enum_defs chr join dict sorted thrift_type_defs items key=lambda x class_ordering x values yaml_ret cpp_header thrift_schema _diff_schema dst src additions = key src key key src keys - dst keys subtractions = key dst key key dst keys - src keys common_keys = src keys dst keys versions = SCHEMA_VERSION TREESPEC_VERSION common_keys -= versions key common_keys src_kind = src key kind src_fields = src key fields dst_kind = dst key kind dst_fields = dst key fields _check src_kind == dst_kind f Type key changed kind dst_kind src_kind assert isinstance src_fields dict isinstance dst_fields dict added_fields = key src_fields key key src_fields keys - dst_fields keys subtracted_fields = key dst_fields key key dst_fields keys - src_fields keys common_fields = src_fields keys dst_fields keys field common_fields src_field = src_fields field dst_field = dst_fields field src_kind == struct _check src_field type == dst_field type f Type field key field changed dst_field type src_field type default src_field default dst_field added_fields field = added_fields field default = src_field default default src_field default dst_field subtracted_fields field = subtracted_fields field default = dst_field default src_kind == enum _check src_field == dst_field f Value enum field key field changed dst_field src_field src_kind == union _check src_field type == dst_field type f Type field key field changed dst_field type src_field type raise AssertionError f Unknown kind src_kind key len added_fields assert key additions additions key = additions key fields = added_fields len subtracted_fields assert key subtractions subtractions key = subtractions key fields = subtracted_fields additions subtractions _hash_content s str hashlib sha s strip encode utf- hexdigest dataclasses dataclass _Commit result dict str Any checksum_next str yaml_path str additions dict str Any subtractions dict str Any base dict str Any checksum_head Optional str cpp_header str cpp_header_path str thrift_checksum_head Optional str thrift_checksum_real Optional str thrift_checksum_next str thrift_schema str thrift_schema_path str update_schema importlib resources pyrefly ignore bad-argument-type importlib resources is_resource __package__ schema yaml pyrefly ignore bad-argument-type content = importlib resources read_text __package__ schema yaml match = re search checksum A-Fa-f - content _check match None checksum found schema yaml assert match None checksum_head = match group thrift_content = importlib resources read_text pyrefly ignore bad-argument-type __package__ export_schema thrift match = re search checksum A-Fa-f - thrift_content _check match None checksum found export_schema thrift assert match None thrift_checksum_head = match group thrift_content = thrift_content splitlines assert thrift_content startswith + generated assert thrift_content startswith checksum thrift_checksum_real = _hash_content \n join thrift_content yaml load Loader dst = load content Loader=Loader assert isinstance dst dict checksum_head = None thrift_checksum_head = None thrift_checksum_real = None dst = SCHEMA_VERSION None TREESPEC_VERSION None src cpp_header thrift_schema = _staged_schema additions subtractions = _diff_schema dst src pyrefly ignore missing-attribute yaml_path = __package__ replace + schema yaml pyrefly ignore missing-attribute thrift_schema_path = __package__ replace + export_schema thrift torch_prefix = torch assert yaml_path startswith torch_prefix sanity check assert thrift_schema_path startswith torch_prefix sanity check _Commit result=src checksum_next=_hash_content repr src yaml_path=yaml_path additions=additions subtractions=subtractions base=dst checksum_head=checksum_head cpp_header=cpp_header cpp_header_path=torch_prefix + csrc utils generated_serialization_types h thrift_checksum_head=thrift_checksum_head thrift_checksum_real=thrift_checksum_real thrift_checksum_next=_hash_content thrift_schema thrift_schema=thrift_schema thrift_schema_path=thrift_schema_path check commit _Commit force_unsafe bool = False next_version = None reason = Step Detect major schema updates len commit additions k v commit additions items k commit base continue kind = commit result k kind fields = v fields f d fields items kind == struct default d reason += f Field k f added schema py without default value incompatible change + which requires major version bump \n next_version = commit base SCHEMA_VERSION + len commit subtractions k v commit subtractions items k commit result continue f v fields reason = f Field k f removed schema py incompatible change which requires major version bump \n next_version = commit base SCHEMA_VERSION + force_unsafe reason += -- force-unsafe used next_version = commit result SCHEMA_VERSION Step Detect minor schema updates next_version None len commit additions k v commit additions items f v fields reason += f Field k f added schema py compatible change + which still requires minor version bump \n next_version = commit base SCHEMA_VERSION commit base SCHEMA_VERSION + next_version None len commit subtractions k v commit subtractions items f v fields reason += f Field k f removed schema py compatible change + which still requires minor version bump \n next_version = commit base SCHEMA_VERSION commit base SCHEMA_VERSION + next_version reason
Owner s module dynamo functools unittest expectedFailure xfail skipIf skipif numpy pytest pytest raises assert_raises torch testing _internal common_utils instantiate_parametrized_tests parametrize run_tests TEST_WITH_TORCHDYNAMO TestCase xpassIfTorchDynamo_np If we going trace through these we should use NumPy If testing eager mode we use torch _numpy TEST_WITH_TORCHDYNAMO numpy np numpy array atleast_ d atleast_ d atleast_ d concatenate hstack newaxis stack vstack int numpy __version__ = numpy exceptions AxisError numpy AxisError numpy testing assert_ assert_array_equal assert_equal torch _numpy np torch _numpy array atleast_ d atleast_ d atleast_ d AxisError concatenate hstack newaxis stack vstack torch _numpy testing assert_ assert_array_equal assert_equal skip = functools partial skipif True IS_PYPY = False TestAtleast d TestCase test_ D_array = array b = array res = atleast_ d atleast_ d b desired = array array assert_array_equal res desired test_ D_array = array b = array res = atleast_ d atleast_ d b desired = array array assert_array_equal res desired test_ D_array = array b = array res = atleast_ d atleast_ d b desired = b assert_array_equal res desired test_ D_array = array b = array = array b = array b b res = atleast_ d atleast_ d b desired = b assert_array_equal res desired test_r array Test make sure equivalent Travis O s r array function assert atleast_ d shape == assert atleast_ d j shape == assert atleast_ d shape == assert atleast_ d shape == TestAtleast d TestCase test_ D_array = array b = array res = atleast_ d atleast_ d b desired = array array assert_array_equal res desired test_ D_array = array b = array res = atleast_ d atleast_ d b desired = array array assert_array_equal res desired test_ D_array = array b = array res = atleast_ d atleast_ d b desired = b assert_array_equal res desired test_ D_array = array b = array = array b = array b b res = atleast_ d atleast_ d b desired = b assert_array_equal res desired test_r array Test make sure equivalent Travis O s r array function assert atleast_ d shape == assert atleast_ d j shape == assert atleast_ d shape == TestAtleast d TestCase test_ D_array = array b = array res = atleast_ d atleast_ d b desired = array array assert_array_equal res desired test_ D_array = array b = array res = atleast_ d atleast_ d b desired = array array assert_array_equal res desired test_ D_array = array b = array res = atleast_ d atleast_ d b desired = newaxis b newaxis assert_array_equal res desired test_ D_array = array b = array = array b = array b b res = atleast_ d atleast_ d b desired = b assert_array_equal res desired TestHstack TestCase test_non_iterable assert_raises TypeError hstack test_empty_input assert_raises ValueError hstack test_ D_array = array b = array res = hstack b desired = array assert_array_equal res desired test_ D_array = array b = array res = hstack b desired = array assert_array_equal res desired test_ D_array = array b = array res = hstack b desired = array assert_array_equal res desired test_generator numpy emits warnings we don t assert_warns FutureWarning hstack np arange _ range assert_warns FutureWarning hstack x x np ones noqa C skipif numpy __version__ reason= NP_VER fails NumPy x test_casting_and_dtype = np array b = np array res = np hstack np append b casting= unsafe dtype=np int expected_res = np array assert_array_equal res expected_res test_casting_and_dtype_type_error = np array b = np array pytest raises TypeError hstack b casting= safe dtype=np int TestVstack TestCase test_non_iterable assert_raises TypeError vstack test_empty_input assert_raises ValueError vstack test_ D_array = array b = array res = vstack b desired = array assert_array_equal res desired test_ D_array = array b = array res = vstack b desired = array assert_array_equal res desired test_ D_array = array b = array res = vstack b desired = array assert_array_equal res desired test_ D_array = array b = array res = vstack b desired = array assert_array_equal res desired xfail reason= vstack w generators test_generator pytest raises TypeError match= arrays stack must vstack np arange _ range skipif numpy __version__ reason= casting kwarg new NumPy test_casting_and_dtype = np array b = np array res = np vstack b casting= unsafe dtype=np int expected_res = np array assert_array_equal res expected_res skipif numpy __version__ reason= casting kwarg new NumPy test_casting_and_dtype_type_error = np array b = np array pytest raises TypeError vstack b casting= safe dtype=np int instantiate_parametrized_tests TestConcatenate TestCase test_out_and_dtype_simple numpy raises TypeError both out= dtype= b out = np ones np ones np ones + pytest raises TypeError np concatenate b out=out dtype=float test_returns_copy = np eye b = np concatenate b = assert b = test_exceptions test axis must bounds ndim = np ones ndim np concatenate axis= OK assert_raises IndexError np AxisError np concatenate axis=ndim assert_raises IndexError np AxisError np concatenate axis=- ndim + Scalars cannot concatenated assert_raises RuntimeError ValueError concatenate assert_raises RuntimeError ValueError concatenate np array dimensionality must match assert_raises RuntimeError ValueError assert_raises_regex ValueError r all input arrays must have same number dimensions r array index has dimension\ s\ array r index has dimension\ s\ np concatenate np zeros np zeros test shapes must match except concatenation axis = np ones b = np ones axis = list range _ range np concatenate b axis=axis OK assert_raises_regex assert_raises RuntimeError ValueError all input array dimensions except concatenation axis must match exactly along dimension array index has size array index has size format i np concatenate b axis=axis assert_raises RuntimeError ValueError np concatenate b axis=axis = np moveaxis - b = np moveaxis b - axis append axis pop No arrays concatenate raises ValueError assert_raises ValueError concatenate test_concatenate_axis_None = np arange dtype=np float reshape b = list range r = np concatenate axis=None assert r dtype == dtype assert r ndim == r = np concatenate b axis=None assert r size == size + len b assert r dtype == dtype out = np zeros size + len b r = np concatenate b axis=None rout = np concatenate b axis=None out=out assert out rout assert np all r == rout xpassIfTorchDynamo_np reason= concatenate x axis=None relies x being sequence test_large_concatenate_axis_None When no axis given concatenate uses flattened versions This also had bug many arrays see gh- x = np arange r = np concatenate x None assert np all x == r This should probably deprecated r = np concatenate x axis = MAXDIMS assert_array_equal x r test_concatenate Test concatenate function One sequence returns unmodified array XXX single argument relies ndarray being sequence r = list range assert_array_equal concatenate r r Any sequence assert_array_equal concatenate tuple r r assert_array_equal concatenate array r r D default concatenation r = list range assert_array_equal concatenate r r r + r Mixed sequence types assert_array_equal concatenate tuple r r r + r assert_array_equal concatenate array r r r + r Explicit axis specification assert_array_equal concatenate r r r + r Including negative assert_array_equal concatenate r r - r + r D = array = array res = array assert_array_equal concatenate res assert_array_equal concatenate res assert_array_equal concatenate T T res T assert_array_equal concatenate T T - res T Arrays much match shape assert_raises RuntimeError ValueError concatenate T T D res = np arange reshape = res = res = res assert_array_equal concatenate res assert_array_equal concatenate - res assert_array_equal concatenate T T T res T out = res copy rout = concatenate out=out assert_ out rout assert_equal res rout skip reason= concat arrays sequence skipif IS_PYPY reason= PYPY handles sq_concat nb_add differently than cpython test_operator_concat operator = array b = array n = assert_raises TypeError operator concat b assert_raises TypeError operator concat n assert_raises TypeError operator concat n assert_raises TypeError operator concat assert_raises TypeError operator concat test_bad_out_shape = array b = array assert_raises ValueError concatenate b out=np empty assert_raises ValueError concatenate b out=np empty assert_raises ValueError concatenate b out=np empty concatenate b out=np empty parametrize axis None parametrize out_dtype c f f i torch does have f S parametrize casting no equiv safe same_kind unsafe test_out_and_dtype axis out_dtype casting Compare usage ` out=out ` ` dtype=out dtype ` out = np empty dtype=out_dtype to_concat = array array np can_cast to_concat out_dtype casting=casting assert_raises TypeError concatenate to_concat out=out axis=axis casting=casting assert_raises TypeError concatenate to_concat dtype=out dtype axis=axis casting=casting res_out = concatenate to_concat out=out axis=axis casting=casting res_dtype = concatenate to_concat dtype=out dtype axis=axis casting=casting assert res_out out assert_array_equal out res_dtype assert res_dtype dtype == out_dtype assert_raises TypeError concatenate to_concat out=out dtype=out_dtype axis=axis instantiate_parametrized_tests TestStackMisc TestCase skipif numpy __version__ reason= NP_VER fails NumPy x test_stack non-iterable input assert_raises TypeError stack d input input_ np int np int np int np array np array np array assert_array_equal stack input_ d input examples = np array b = np array r = array assert_array_equal np stack b r assert_array_equal np stack b axis= r T all input types assert_array_equal np stack b r assert_array_equal np stack array b r all shapes d input arrays = np random randn _ range axes = - - expected_shapes = axis expected_shape zip axes expected_shapes assert_equal np stack arrays axis shape expected_shape assert_raises AxisError stack arrays axis= assert_raises AxisError stack arrays axis=- all shapes d input arrays = np random randn _ range axes = - - - expected_shapes = axis expected_shape zip axes expected_shapes assert_equal np stack arrays axis shape expected_shape empty arrays assert stack shape == assert stack axis= shape == out out = np zeros_like r np stack b out=out assert_array_equal out r edge cases assert_raises ValueError stack assert_raises ValueError stack assert_raises RuntimeError ValueError stack np arange assert_raises RuntimeError ValueError stack np arange assert_raises RuntimeError ValueError stack np arange axis= assert_raises RuntimeError ValueError stack np zeros np zeros axis= assert_raises RuntimeError ValueError stack np arange np arange generator deprecated numpy emits warning we don t assert_warns FutureWarning result = stack x x range assert_array_equal result np array casting dtype test = np array b = np array res = np stack b axis= casting= unsafe dtype=np int expected_res = np array assert_array_equal res expected_res casting dtype TypeError assert_raises TypeError stack b dtype=np int axis= casting= safe skipif numpy __version__ reason= NP_VER fails NumPy x parametrize axis parametrize out_dtype c f f i torch does have f parametrize casting no equiv safe same_kind unsafe test_stack_out_and_dtype axis out_dtype casting to_concat = array array res = array out = np zeros_like res np can_cast to_concat out_dtype casting=casting assert_raises TypeError stack to_concat dtype=out_dtype axis=axis casting=casting res_out = stack to_concat out=out axis=axis casting=casting res_dtype = stack to_concat dtype=out_dtype axis=axis casting=casting assert res_out out assert_array_equal out res_dtype assert res_dtype dtype == out_dtype assert_raises TypeError stack to_concat out=out dtype=out_dtype axis=axis xfail reason= TODO implement block instantiate_parametrized_tests TestBlock TestCase pytest fixture params= block force_concatenate force_slicing block request blocking small arrays large arrays go through different paths algorithm triggered depending number element copies required We define test fixture forces most tests go through both code paths Ultimately should removed single algorithm found faster both small large arrays _block_force_concatenate arrays arrays list_ndim result_ndim _ = _block_setup arrays _block_concatenate arrays list_ndim result_ndim _block_force_slicing arrays arrays list_ndim result_ndim _ = _block_setup arrays _block_slicing arrays list_ndim result_ndim request param == force_concatenate _block_force_concatenate request param == force_slicing _block_force_slicing request param == block block raise ValueError Unknown blocking request There typo tests test_returns_copy block = np eye b = block b = assert b = test_block_total_size_estimate block _ _ _ total_size = _block_setup assert total_size == _ _ _ total_size = _block_setup assert total_size == _ _ _ total_size = _block_setup assert total_size == _ _ _ total_size = _block_setup assert total_size == _ _ _ total_size = _block_setup assert total_size == test_block_simple_row_wise block a_ d = np ones b_ d = a_ d desired = np array result = block a_ d b_ d assert_equal desired result test_block_simple_column_wise block a_ d = np ones b_ d = a_ d expected = np array result = block a_ d b_ d assert_equal expected result test_block_with_ d_arrays_row_wise block -D vectors treated row arrays = np array b = np array expected = np array result = block b assert_equal expected result test_block_with_ d_arrays_multiple_rows block = np array b = np array expected = np array result = block b b assert_equal expected result test_block_with_ d_arrays_column_wise block -D vectors treated row arrays a_ d = np array b_ d = np array expected = np array result = block a_ d b_ d assert_equal expected result test_block_mixed_ d_and_ d block a_ d = np ones b_ d = np array result = block a_ d b_ d expected = np array assert_equal expected result test_block_complicated block bit more complicated one_ d = np array two_ d = np array three_ d = np array four_ d = np array five_ d = np array six_ d = np array zero_ d = np zeros expected = np array result = block one_ d two_ d three_ d four_ d five_ d six_ d zero_ d assert_equal result expected test_nested block one = np array two = np array three = np array four = np array five = np array six = np array zero = np zeros result = block block one three four two five six zero expected = np array assert_equal result expected test_ d block = np ones int = np ones int = np ones int = np ones int = np ones int = np ones int = np ones int = np ones int result = block expected = array assert_array_equal result expected test_block_with_mismatched_shape block = np array b = np eye assert_raises ValueError block b assert_raises ValueError block b to_block = np ones np ones np ones np ones assert_raises ValueError block to_block test_no_lists block assert_equal block np array assert_equal block np eye np eye test_invalid_nesting block msg = depths mismatched assert_raises_regex ValueError msg block assert_raises_regex ValueError msg block assert_raises_regex ValueError msg block assert_raises_regex ValueError msg block assert_raises_regex ValueError msg block missing brackets test_empty_lists block assert_raises_regex ValueError empty block assert_raises_regex ValueError empty block assert_raises_regex ValueError empty block test_tuple block assert_raises_regex TypeError tuple block assert_raises_regex TypeError tuple block test_different_ndims block = b = np ones c = np ones result = block b c expected = np array assert_equal result expected test_different_ndims_depths block = b = np ones c = np ones result = block b c expected = np array assert_equal result expected test_block_memory_order block D arr_c = np zeros order= C arr_f = np zeros order= F b_c = arr_c arr_c arr_c arr_c arr_c arr_c arr_c arr_c b_f = arr_f arr_f arr_f arr_f arr_f arr_f arr_f arr_f assert block b_c flags C_CONTIGUOUS assert block b_f flags F_CONTIGUOUS arr_c = np zeros order= C arr_f = np zeros order= F D b_c = arr_c arr_c arr_c arr_c b_f = arr_f arr_f arr_f arr_f assert block b_c flags C_CONTIGUOUS assert block b_f flags F_CONTIGUOUS __name__ == __main__ run_tests
mypy allow-untyped-defs __future__ annotations typing TYPE_CHECKING torch torch _higher_order_ops wrap wrap_with_autocast utils node_inline_ nodes_filter nodes_first sequential_split replace_with_hop_pass_util _replace_with_hop_helper _replace_with_hop_pass_helper _sequential_split_and_maybe_inline_subgraphs_helper TYPE_CHECKING torch export graph_signature ExportGraphSignature _is_autocast_node node torch fx Node - torch fx Node &#124; bool node node op == call_function node target torch amp autocast_mode _enter_autocast torch amp autocast_mode _exit_autocast _is_enter_autocast_node node torch fx Node - torch fx Node &#124; bool node node op == call_function node target torch amp autocast_mode _enter_autocast _is_exit_autocast_node node torch fx Node - torch fx Node &#124; bool node node op == call_function node target torch amp autocast_mode _exit_autocast _is_autocast_sub_mod node torch fx Node - bool Check first non-placeholder node ` torch amp autocast_mode _enter_autocast ` node op == call_module assert isinstance node target str subgm = getattr node graph owning_module node target first_non_ph = nodes_first subgm graph nodes lambda node node op = placeholder first_non_ph first_non_ph op == call_function first_non_ph target torch amp autocast_mode _enter_autocast TODO check current auto-cast type same args _enter_autocast If so False i e do create submodule True False _check_valid_autocast_block enter_autocast_node torch fx Node exit_autocast_node torch fx Node - None assert _is_enter_autocast_node enter_autocast_node assert _is_exit_autocast_node exit_autocast_node assert exit_autocast_node args == enter_autocast_node _replace_with_hop node torch fx Node - None assert node op == call_module graph torch fx Graph = node graph assert graph owning_module None gm torch fx GraphModule = graph owning_module assert isinstance node target str sub_gm = getattr gm node target sub_graph = sub_gm graph autocast_nodes = nodes_filter sub_graph nodes _is_autocast_node len autocast_nodes assert len autocast_nodes need least enter node exist node enter_autocast_node = autocast_nodes exit_autocast_node = autocast_nodes - _check_valid_autocast_block enter_autocast_node exit_autocast_node _replace_with_hop_helper node enter_autocast_node wrap_with_autocast sub_graph erase_node exit_autocast_node sub_graph erase_node enter_autocast_node _split_autocast gm torch fx GraphModule - torch fx GraphModule split_autocast creates new graph module splits input graph module into multiple submodules based ` _enter_autocast ` ` _exit_autocast ` nodes It doesn t mutate input graph module Nodes between outer-most ` _enter_autocast ` ` _exit_autocast _enter_autocast ` split into submodule Nested autocast regions split ` _enter_autocast ` ` _exit_autocast _enter_autocast ` nodes submodule well Below example splitting A B C D E blocks non-autocast nodes original graph module Nodes marked same number grouped into same submodule A enter_autocast B exit_autocast C enter_autocast D exit_autocast E enter_autocast_node_stack list torch fx Node = first_node_after_outer_most_exit bool = False node_call_back node torch fx Node - bool nonlocal enter_autocast_node_stack first_node_after_outer_most_exit increment_id = False first_node_after_outer_most_exit len enter_autocast_node_stack == _is_enter_autocast_node node assert len enter_autocast_node_stack == first_node_after_outer_most_exit = False increment_id = True _is_enter_autocast_node node enter_autocast_node_stack append node _is_exit_autocast_node node assert len enter_autocast_node_stack last_enter_autocast_node = enter_autocast_node_stack pop assert node args == last_enter_autocast_node len enter_autocast_node_stack == next node should next submodule since autocast block ends first_node_after_outer_most_exit = True increment_id sequential_split gm node_call_back _sequential_split_and_maybe_inline_subgraphs gm torch fx GraphModule graph_signature ExportGraphSignature &#124; None - tuple torch fx GraphModule ExportGraphSignature &#124; None Helper function replace_autocast_with_hop_pass Split graph module into multiple subgraphs based autocast nodes For each subgraph decides whether construct HOO subgraph inline calls back into parent graph module Nodes between ` _enter_autocast ` ` _exit_autocast _enter_autocast ` considered subgraph need_replacing = any _is_autocast_node node node gm graph nodes need_replacing gm graph_signature split_autocast returns new graph module could have different output args names We need fix graph signature ` _sequential_split_and_maybe_inline_subgraphs_helper ` new_gm = _split_autocast gm _maybe_inline_or_replace_with_hop node torch fx Node - None _is_autocast_sub_mod node _replace_with_hop node assert node op == call_module assert isinstance node target str node_inline_ node _sequential_split_and_maybe_inline_subgraphs_helper new_gm graph_signature _maybe_inline_or_replace_with_hop replace_autocast_with_hop_pass gm torch fx GraphModule graph_signature ExportGraphSignature &#124; None - tuple torch fx GraphModule ExportGraphSignature &#124; None Split gm into sub-graph-modules using ` sequential_split_and_maybe_inline_subgraphs ` then recursively call itself each submodules _replace_with_hop_pass_helper gm graph_signature _sequential_split_and_maybe_inline_subgraphs
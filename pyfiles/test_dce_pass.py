Owner s module fx copy unittest typing Optional torch torch fx torch testing _internal common_utils IS_MACOS raise_on_run_directly TestCase TestDCE TestCase _custom_is_impure_node node torch fx Node - bool node is_impure True custom function defines add operators impure node target == torch ops aten add True False _has_nodes_without_users m torch fx GraphModule custom bool = False node m graph nodes custom node is_impure custom _custom_is_impure_node node continue len node users == True False _get_num_placeholders m torch fx GraphModule - int count = node m graph nodes node op == placeholder count += count _run_dce_and_test m torch nn Module expect_dce_changes bool modules_to_be_leafs Optional set type = None custom bool = False TestTracer torch fx Tracer is_leaf_module m qualname modules_to_be_leafs type m modules_to_be_leafs True super trace m qualname traced torch fx GraphModule = torch fx GraphModule m TestTracer trace m print str traced graph Verify there nodes without users expected has_nodes_without_users = _has_nodes_without_users traced custom=custom expect_dce_changes assertTrue has_nodes_without_users assertFalse has_nodes_without_users Get original number placeholders verify doesn t change during DCE orig_num_phs = _get_num_placeholders traced custom changed = traced graph eliminate_dead_code is_impure_node=self _custom_is_impure_node changed = traced graph eliminate_dead_code assertTrue changed expect_dce_changes changed Verify there no nodes without users after DCE run assertFalse _has_nodes_without_users traced custom=custom new_num_phs = _get_num_placeholders traced assertEqual orig_num_phs new_num_phs traced recompile Make sure we run get same results before after DCE inputs = torch tensor new_num_phs inputs_copy = copy deepcopy inputs assertTrue torch equal m inputs traced inputs_copy test_simple Tests single node graph DCE d correctly TestModule torch nn Module __init__ - None super __init__ attr_ = torch nn Parameter torch tensor - forward x = x + noqa F x + attr_ _run_dce_and_test TestModule expect_dce_changes=True test_dead_chain Tests chain two nodes graph DCE d correctly TestModule torch nn Module __init__ - None super __init__ attr_ = torch nn Parameter torch tensor - forward x = x + b = noqa F x + attr_ _run_dce_and_test TestModule expect_dce_changes=True test_dead_getattr Tests getatrr graph DCE d correctly TestModule torch nn Module __init__ - None super __init__ attr_ = torch nn Parameter torch tensor - forward x = x + b = attr_ noqa F x + _run_dce_and_test TestModule expect_dce_changes=True test_dead_placeholder Tests placeholder graph DCE d would change function signature TestModule torch nn Module forward x y x + _run_dce_and_test TestModule expect_dce_changes=False test_dead_placeholder_with_user Tests placeholder graph DCE d would change function signature Also verifies dead node uses placeholder DCE d TestModule torch nn Module forward x y = y + noqa F x + _run_dce_and_test TestModule expect_dce_changes=True test_keep_module_with_side_effects Test DCE doesn t remove module s specified having side effects ReLUImpure torch nn ReLU _is_impure = True TestModule torch nn Module __init__ - None super __init__ relu = ReLUImpure forward torch Tensor - torch Tensor r = relu noqa F _run_dce_and_test TestModule expect_dce_changes=False modules_to_be_leafs= ReLUImpure test_keep_torch_assert Test DCE doesn t remove torch _assert since has side effects TestModule torch nn Module forward torch Tensor - torch Tensor torch _assert torch equal must equal Note Don t need specify torch _assert having side effects because s known _run_dce_and_test TestModule expect_dce_changes=False test_keep_setitem Fix issue https github com pytorch pytorch issues Test DCE doesn t remove operator setitem since has side effects TestModule torch nn Module forward torch Tensor - torch Tensor = dce_backend gm inputs kwargs torch _inductor constant_folding torch _inductor constant_folding constant_fold gm gm x = torch randn dce_x = x detach clone model = TestModule eval dce_mod = torch compile copy deepcopy model backend=dce_backend torch inference_mode eager_out = model x out = dce_mod dce_x assertEqual eager_out out atol= e- rtol= e- test_impure_nodes_args Test DCE doesn t remove call_function nodes side effects TestModule torch nn Module forward torch Tensor - torch Tensor torch _ops ops aten add_ Tensor add_ node should removed because has side effects _run_dce_and_test TestModule expect_dce_changes=False test_impure_random Test DCE doesn t remove call_function torch rand other random functions Tests both FX tracing AOT compilation issue TestModule torch nn Module forward torch Tensor - torch Tensor x = torch rand noqa F Test FX tracing + DCE _run_dce_and_test TestModule expect_dce_changes=False Test comprehensive random functions AOT compilation ComprehensiveRandomModule torch nn Module forward x torch Tensor - torch Tensor Test various random functions should preserved = torch rand noqa F b = torch randn noqa F c = torch randint noqa F d = torch randperm noqa F e = torch normal noqa F f = torch poisson torch tensor noqa F g = torch rand Used Test random operations explicit generators also preserved gen = torch Generator manual_seed h = torch rand generator=gen noqa F i = torch randn generator=gen noqa F j = torch rand generator=gen Used x + g + j aot_backend gm example_inputs count_random_ops len n n gm graph nodes n op == call_function any fn str n target fn rand randn randint randperm normal poisson rand_count = count_random_ops gm graph eliminate_dead_code assertEqual count_random_ops rand_count Random ops should preserved gm forward model = ComprehensiveRandomModule torch manual_seed eager_result = model torch tensor torch manual_seed compiled_result = torch compile model backend=aot_backend torch tensor assertEqual eager_result compiled_result test_impure_kwargs Test DCE doesn t remove call_function nodes side effects kwargs TestModule torch nn Module forward torch Tensor - torch Tensor b = + torch _ops ops aten add out b b out=a alpha= add_out node should removed because has side effects _run_dce_and_test TestModule expect_dce_changes=False test_impure_custom Test DCE doesn t remove nodes marked impure custom function TestModule torch nn Module forward torch Tensor - torch Tensor b = + c = torch _ops ops aten add b b noqa F add_out node should removed because has side effects _run_dce_and_test TestModule expect_dce_changes=False custom=True unittest skipIf IS_MACOS Not working macos test_keep_collectives Test DCE doesn t remote collective ops even results used TestModule torch nn Module forward torch Tensor b torch Tensor c torch Tensor - torch Tensor d = torch ops aten mul Tensor b e = torch ops aten mul Tensor c future = torch ops _c d_functional all_reduce default e sum torch ops _c d_functional wait_tensor default future d torch distributed init_process_group backend= fake world_size= rank= collective nodes should removed because they have side effects _run_dce_and_test TestModule expect_dce_changes=False custom=False torch distributed destroy_process_group unittest skipIf IS_MACOS Not working macos test_keep_collectives_no_overload Test DCE doesn t remote collective ops no overload version even results used TestModule torch nn Module forward torch Tensor b torch Tensor c torch Tensor - torch Tensor d = torch ops aten mul b e = torch ops aten mul c future = torch ops _c d_functional all_reduce e sum torch ops _c d_functional wait_tensor future d torch distributed init_process_group backend= fake world_size= rank= collective nodes should removed because they have side effects _run_dce_and_test TestModule expect_dce_changes=False custom=False torch distributed destroy_process_group __name__ == __main__ raise_on_run_directly test test_fx py
__future__ annotations argparse json logging os re subprocess sys time enum Enum typing NamedTuple IS_WINDOWS bool = os name == nt LintSeverity str Enum ERROR = error WARNING = warning ADVICE = advice DISABLED = disabled LintMessage NamedTuple path str &#124; None line int &#124; None char int &#124; None code str severity LintSeverity name str original str &#124; None replacement str &#124; None description str &#124; None as_posix name str - str name replace \\ IS_WINDOWS name fmt off https www flake rules com DOCUMENTED_IN_FLAKE RULES set str = E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E E W W W W W W W W W W W W F F F F F F F F F F F F F C https pypi org project flake -comprehensions #rules DOCUMENTED_IN_FLAKE COMPREHENSIONS set str = C C C C C C C C C C C C C C C C C https github com PyCQA flake -bugbear#list-of-warnings DOCUMENTED_IN_BUGBEAR set str = B B B B B B B B B B B B B B B B B B B B B B B B B fmt stdin W undefined name foo stdin T Name foo defined stdin - W invalid escape sequence \ stdin E expected blank lines found RESULTS_RE re Pattern str = re compile r mx ^ P file P line \d+ P column - \d+ \s P code \S+ \s P message $ _test_results_re - None t s RESULTS_RE search s groupdict t r file py E expected blank lines found doctest +NORMALIZE_WHITESPACE file file py line column code E message expected blank lines found t r file py P Resource ` stdout ` acquired always released doctest +NORMALIZE_WHITESPACE file file py line column code P message Resource ` stdout ` acquired always released t r file py - W invalid escape sequence doctest +NORMALIZE_WHITESPACE file file py line column - code W message invalid escape sequence _run_command args list str extra_env dict str str &#124; None - subprocess CompletedProcess str logging debug $ s join f k = v k v extra_env items extra_env + args start_time = time monotonic try subprocess run args capture_output=True check=True encoding= utf- finally end_time = time monotonic logging debug took dms end_time - start_time run_command args list str extra_env dict str str &#124; None retries int - subprocess CompletedProcess str remaining_retries = retries while True try _run_command args extra_env=extra_env except subprocess CalledProcessError err remaining_retries == re match r ^ERROR X linting + timed out after \d+ seconds err stdout raise err remaining_retries -= logging warning noqa G s s Retrying because command failed r retries - remaining_retries retries err time sleep get_issue_severity code str - LintSeverity B ` x ` inside generator B Invalid first argument method B __slots__ efficiency B Line too long C Flake Comprehensions C Cyclomatic complexity E PEP horizontal whitespace errors E PEP blank line errors E PEP line length errors F Name imported unused F Star imports used F Name possibly star imports T type checking Notes T internal type checker errors unmatched messages any code startswith x x B C C E E E F F F T T LintSeverity ADVICE F Undefined name E syntax error any code startswith x x F E LintSeverity ERROR F PyFlakes Error B flake -bugbear Error E PEP Error W PEP Warning possibly other plugins LintSeverity WARNING get_issue_documentation_url code str - str code DOCUMENTED_IN_FLAKE RULES f https www flake rules com rules code html code DOCUMENTED_IN_FLAKE COMPREHENSIONS https pypi org project flake -comprehensions #rules code DOCUMENTED_IN_BUGBEAR https github com PyCQA flake -bugbear#list-of-warnings check_files filenames list str flake _plugins_path str &#124; None severities dict str LintSeverity retries int - list LintMessage try proc = run_command sys executable -mflake -- exit-zero + filenames extra_env= FLAKE _PLUGINS_PATH flake _plugins_path flake _plugins_path None retries=retries except OSError subprocess CalledProcessError err LintMessage path=None line=None char=None code= FLAKE severity=LintSeverity ERROR name= command-failed original=None replacement=None description= f Failed due err __class__ __name__ \n err isinstance err subprocess CalledProcessError COMMAND exit code returncode \n command \n\n STDERR\n stderr \n\n STDOUT\n stdout format returncode=err returncode command= join as_posix x x err cmd stderr=err stderr strip empty stdout=err stdout strip empty LintMessage path=match file name=match code description=f match message \nSee get_issue_documentation_url match code line=int match line char=int match column match column None match column startswith - None code= FLAKE severity=severities get match code get_issue_severity match code original=None replacement=None match RESULTS_RE finditer proc stdout main - None parser = argparse ArgumentParser description= Flake wrapper linter fromfile_prefix_chars= parser add_argument -- flake -plugins-path help= FLAKE _PLUGINS_PATH env value parser add_argument -- severity action= append help= map code severity e g ` B advice ` parser add_argument -- retries default= type=int help= times retry timed out flake parser add_argument -- verbose action= store_true help= verbose logging parser add_argument filenames nargs= + help= paths lint args = parser parse_args logging basicConfig format= threadName s levelname s message s level=logging NOTSET args verbose logging DEBUG len args filenames logging INFO stream=sys stderr flake _plugins_path = None args flake _plugins_path None os path realpath args flake _plugins_path severities dict str LintSeverity = args severity severity args severity parts = severity split assert len parts == f invalid severity ` severity ` severities parts = LintSeverity parts lint_messages = check_files args filenames flake _plugins_path severities args retries lint_message lint_messages print json dumps lint_message _asdict flush=True __name__ == __main__ main
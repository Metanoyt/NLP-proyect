mypy allow-untyped-defs typing Optional torch torch inf Tensor torch distributions Categorical constraints torch distributions binomial Binomial torch distributions distribution Distribution torch distributions utils broadcast_all __all__ = Multinomial Multinomial Distribution r Creates Multinomial distribution parameterized attr ` total_count ` either attr ` probs ` attr ` logits ` both The innermost dimension attr ` probs ` indexes over categories All other dimensions index over batches Note attr ` total_count ` need specified only meth ` log_prob ` called see example below note The ` probs ` argument must non-negative finite have non-zero sum will normalized sum along last dimension attr ` probs ` will normalized value The ` logits ` argument will interpreted unnormalized log probabilities can therefore any real number It will likewise normalized so resulting probabilities sum along last dimension attr ` logits ` will normalized value - meth ` sample ` requires single shared ` total_count ` all parameters samples - meth ` log_prob ` allows different ` total_count ` each parameter sample Example xdoctest +SKIP FIXME found invalid values m = Multinomial torch tensor x = m sample equal probability tensor Multinomial probs=torch tensor log_prob x tensor - Args total_count int number trials probs Tensor event probabilities logits Tensor event log probabilities unnormalized pyrefly ignore bad-override arg_constraints = probs constraints simplex logits constraints real_vector total_count int property mean - Tensor probs total_count property variance - Tensor total_count probs - probs __init__ total_count int = probs Optional Tensor = None logits Optional Tensor = None validate_args Optional bool = None - None isinstance total_count int raise NotImplementedError inhomogeneous total_count supported total_count = total_count _categorical = Categorical probs=probs logits=logits _binomial = Binomial total_count=total_count probs=self probs batch_shape = _categorical batch_shape event_shape = _categorical param_shape - super __init__ batch_shape event_shape validate_args=validate_args expand batch_shape _instance=None new = _get_checked_instance Multinomial _instance batch_shape = torch Size batch_shape new total_count = total_count new _categorical = _categorical expand batch_shape super Multinomial new __init__ batch_shape event_shape validate_args=False new _validate_args = _validate_args new _new args kwargs _categorical _new args kwargs constraints dependent_property is_discrete=True event_dim= pyrefly ignore bad-override support constraints multinomial total_count property logits - Tensor _categorical logits property probs - Tensor _categorical probs property param_shape - torch Size _categorical param_shape sample sample_shape=torch Size sample_shape = torch Size sample_shape samples = _categorical sample torch Size total_count + sample_shape samples shape total_count sample_shape batch_shape need change sample_shape batch_shape total_count shifted_idx = list range samples dim shifted_idx append shifted_idx pop samples = samples permute shifted_idx counts = samples new _extended_shape sample_shape zero_ counts scatter_add_ - samples torch ones_like samples counts type_as probs entropy n = torch tensor total_count cat_entropy = _categorical entropy term = n cat_entropy - torch lgamma n + support = _binomial enumerate_support expand=False binomial_probs = torch exp _binomial log_prob support weights = torch lgamma support + term = binomial_probs weights sum - term + term log_prob value _validate_args _validate_sample value logits value = broadcast_all logits value logits = logits clone memory_format=torch contiguous_format log_factorial_n = torch lgamma value sum - + log_factorial_xs = torch lgamma value + sum - logits value == logits == -inf = log_powers = logits value sum - log_factorial_n - log_factorial_xs + log_powers
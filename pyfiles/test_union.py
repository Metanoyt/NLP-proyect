Owner s oncall jit ruff noqa F io os sys enum Enum textwrap dedent typing Dict List Optional Tuple Union torch torch testing FileCheck Make helper files test importable pytorch_test_dir = os path dirname os path dirname os path realpath __file__ sys path append pytorch_test_dir torch testing _internal common_utils raise_on_run_directly torch testing _internal jit_utils JitTestCase make_global TestUnion JitTestCase This tests functionality ` Union ` Note It s important able refine type ` Union ` one its internal types Currently there differences way Python expects ` isinstance ` checks way TorchScript expects ` isinstance ` checks This means we can t use ` checkScript ` our test cases because either eager mode script mode wouldn t run So some test cases have separate equivalent functions emulate ` checkScript ` test_check_union_annotation test_func Union int float b Optional int scripted_func = torch jit script test_func graph_rep = str scripted_func graph code_rep = str scripted_func code TS graph IR Union should annotated Union FileCheck check Union check int run graph_rep Serialized code Union should annotated Union FileCheck check Union check Optional int run code_rep checkScript test_func shouldn t error out torch _C parse_ir str scripted_func graph test_union_with_scalar_values fn x Union int float - str foo checkScript fn checkScript fn scripted = torch jit script fn assertRaisesRegex RuntimeError Expected member r Union\ float int\ instead found type str scripted test_union_with_collections fn x Union Dict str int List int - str foo checkScript fn foo bar baz checkScript fn scripted = torch jit script fn assertRaisesRegex RuntimeError Expected member r Union\ List\ int\ Dict\ str r int\ \ instead found type r Dict\ str str\ scripted foo bar baz qux assertRaisesRegex RuntimeError Expected member r Union\ List\ int\ Dict\ str r int\ \ instead found type r List\ str\ scripted foo bar baz assertRaisesRegex RuntimeError Expected member r Union\ List\ int\ Dict\ str r int\ \ instead found type str scripted test_union_with_enum Color Enum RED = GREEN = make_global Color fn x Union str Color - str foo checkScript fn Color RED checkScript fn red scripted = torch jit script fn assertRaisesRegex RuntimeError Expected member r Union\ __torch__ jit test_union r Color str\ instead found type int scripted test_union_in_class_constructor torch jit script noqa B A noqa B __init__ x Union int str - None x = x fn x Union str int - A A x assertEqual fn foo x foo assertEqual fn x scripted = torch jit script fn assertRaisesRegex RuntimeError Expected member r Union\ int str\ instead r found type List\ str\ scripted foo bar baz test_union_return_type fn x int - Union int str foo checkScript fn test_union_as_annotation fn - Union int str x Union int str = foo x checkScript fn test_union_as_annotation_in_typed_container fn - None l List Union int str = u Union int str = foo u Union int str = l append u l append u checkScript fn test_union_as_annotation_py fn type - Union int str x Union int str = foo x checkScript fn test_union_as_internal_tuple_type fn t Tuple Union int str Union int str = foo t checkScript fn test_union_variable_can_be_reassigned torch jit script aux i int int i torch jit script aux s str s + s fn - Union int str x Union int str = foo i int = x = i y int = aux x z str = aux str y x = z x checkScript fn test_union_does_not_replace_existing_annotated_type fn x List int = x append foo x assertRaisesRegex RuntimeError Could match type str scripted = torch jit script fn scripted test_union_does_not_replace_existing_annotated_type_union fn x List Union int str = foo x append x assertRaisesRegex RuntimeError Could match type float scripted = torch jit script fn scripted test_union_does_not_replace_existing_annotated_type_empty_container fn x List int = x append foo x assertRaisesRegex RuntimeError Could match type str scripted = torch jit script fn scripted test_unions_of_unions_are_flattened torch jit script fn x Union Union int str float - str foo s = fn graph FileCheck check x Union float int str run s test_unions_of_a_single_argument_vanish torch jit script fn x Union int - str foo s = fn graph FileCheck check x int run s test_union_redundant_arguments_are_skipped torch jit script fn x Union int str int - str foo s = fn graph FileCheck check x Union int str run s test_union_redundant_arguments_are_skipped_optional torch jit script fn x Union int Optional float Optional int - str foo s = fn graph FileCheck check x Union float int NoneType run s test_union_redundant_arguments_are_skipped_subtyping torch jit script fn x Union str Tuple Optional int int Tuple int int - str foo s = fn graph FileCheck check x Union int int str run s test_union_redundant_arguments_are_skipped_container torch jit script fn x Union List str List float List str - str foo s = fn graph FileCheck check x Union float str run s test_union_argument_order_is_ignored torch jit script fn x Union int str - str foo torch jit script fn x Union str int - str foo s fn graph fn graph FileCheck check x Union int str run s test_union_argument_order_is_ignored_container torch jit script fn x Union List str List int - str foo torch jit script fn x Union List int List str - str foo s fn graph fn graph FileCheck check x Union int str run s test_union_T_None_is_equivalent_to_optional_T torch jit script inner x Union int None - int x None x torch jit script fn - int Optional int = b Optional int = None a_ = inner b_ = inner b a_ + b_ assertEqual fn torch jit script inner x Optional int - int x None x torch jit script fn - int Union int None = b Union int None = None a_ = inner b_ = inner b a_ + b_ assertEqual fn test_union_optional_of_union_is_flattened torch jit script fn flag int - Union str int None y Union int str None = foo flag == x Optional Union int str = y flag == x Optional Union int str = x Optional Union int str = None x Can t use ` checkScript ` because will flag fact original code has ` Optional Union int str ` saved loaded code has ` Union int NoneType str ` even though exactly what we want assertEqual fn foo assertEqual fn assertEqual fn None buffer = io BytesIO torch jit save fn buffer buffer = io BytesIO buffer getvalue l = torch jit load buffer s = l code FileCheck check Union int NoneType str check Union int NoneType str run s test_union_subclasses_larger_union fn - Union int str torch Tensor x Union int str = foo x checkScript fn TODO We would like eventually support The issue being tracked https github com pytorch pytorch issues test_union_as_dict_key fn x Dict Union int str str = x foo = bar x = x assertRaisesRegex RuntimeError only int float complex Tensor device string keys supported torch jit script fn test_union_as_dict_value fn x Dict str Union int str = x foo = bar x baz = x baz checkScript fn test_union_module_with_union_instance_variable M torch nn Module x Union int str __init__ x Union int str super __init__ x Union int str = x forward y Union int str x = y x checkModule M checkModule M bar foo test_union_module_with_union_class_variable M torch nn Module x Union int str = foo __init__ y int super __init__ x = y forward z str x = z x checkModule M foo test_union_type_refinement fn x Union int str - str isinstance x str z = x + bar x baz checkScript fn foo checkScript fn test_union_type_refinement_union_rhs fn x int - str torch jit isinstance x Union int str bar baz checkScript fn test_union_type_refinement_tuple_rhs fn x Union int float List str - str isinstance x int float isinstance x int str x foo len x x bar checkScript fn checkScript fn checkScript fn b c test_union_type_refinement_tuple_rhs_noncontained_type fn x Union int List str - str isinstance x int float y = x + x str y len x x bar checkScript fn checkScript fn b c test_union_type_refinement_tuple_rhs_union torch jit script fn x int - str torch jit isinstance x Union int str float y = x + x str y foo TODO There s currently unrelated bug ` torch jit isinstance ` makes fail tuple literals Posted here https github com pytorch pytorch issues Change ` assertEqual ` ` checkScript ` when bug fixed assertEqual fn test_union_type_refinement_statically_false torch jit script fn x int - str torch jit isinstance x Union str float List str str z = x + foo z bar s = fn graph Check we don t have any branching statements FileCheck check_not block check_not block run s test_union_type_refinement_statically_true torch jit script fn x Union List int int - Union List int int torch jit isinstance x int List int x l = y Union List int int = l y s = fn graph Check we don t have any branching statements FileCheck check_not block check_not block run s test_union_type_refinement_partial_static_refinement_tuple_rhs fn x Union List int int - int torch jit isinstance x int float str We should know ` x ` ` int ` here z = x + z checkScript fn checkScript fn test_union_type_refinement_partial_static_refinement_union_rhs fn x Union List int int - int torch jit isinstance x Union int float str We should know ` x ` ` int ` here z = x + z checkScript fn checkScript fn test_union_type_refinement_internal_declaration fn flag bool - str x Union int str None = None flag y = foo y = isinstance x str x bar checkScript fn True checkScript fn False test_union_branching_with_union_return_and_homogenous_types fn x int - Union int str x foo bar checkScript fn checkScript fn test_union_branching_does_not_autoinfer_undeclared_union fn x int - str x y = foo y = x isinstance y str y bar assertRaisesRegex RuntimeError y set type str true branch type int false branch torch jit script fn test_union_branching_does_not_widen_existing_inferred_type fn x int - str y = foo x y = bar y = x isinstance y str y baz assertRaisesRegex RuntimeError previously had type str now being assigned value type int torch jit script fn test_union_schema_matching_on_internal_type fn x Union List int Dict str int - int torch jit isinstance x List int x list x values checkScript fn checkScript fn foo bar baz test_union_subtractive_refinement fn x Union List int int - int isinstance x int x append x x checkScript fn checkScript fn test_union_subtractive_refinement_with_container fn x Union List int int - int torch jit isinstance x List int x x append x checkScript fn checkScript fn test_union_memory_aliasing fn x List torch Tensor = z List Optional List torch Tensor = z append x x_alias = z torch jit isinstance x_alias List torch Tensor x_alias append torch tensor x checkScript fn test_union_serialization_preserves_type_annotations This function will fail after being torch jit save d torch jit load d type annotations aren t preserved Union during serialization We need ` Union str int ` annotation make sure ` y ` typed Union instead str one branch int other fn x int - str x y Union str int = bar y Union str int = x isinstance y str y baz checkScript fn checkScript fn _assert_passes template str ann str lhs str code = template format ann=ann lhs=lhs checkScript code name= fn _assert_raises template str ann str lhs str msg str code = template format ann=ann lhs=lhs assertRaisesRegex RuntimeError msg cu = torch jit CompilationUnit code _frames_up= string_frontend = getattr cu fn noqa B test_union_with_list_assignment template = dedent fn x ann = lhs torch jit isinstance x List torch Tensor x append torch tensor x lhs = list_literal_empty list_literal_of_tensor torch arange torch arange list_literal_of_str foo bar baz list_literal_of_mixed torch arange list_comprehension_of_tensor torch add x x torch arange torch arange list_comprehension_of_str x + x foo bar baz list_comprehension_of_mixed torch add x x torch arange Union List str List torch Tensor _assert_raises template Union List str List torch Tensor lhs list_literal_empty there multiple possible List type candidates Union annotation _assert_passes template Union List str List torch Tensor lhs list_literal_of_tensor _assert_passes template Union List str List torch Tensor lhs list_literal_of_str _assert_raises template Union List str List torch Tensor lhs list_literal_of_mixed none those types match types given list elements _assert_passes template Union List str List torch Tensor lhs list_comprehension_of_tensor _assert_passes template Union List str List torch Tensor lhs list_comprehension_of_str TODO Support mixed list comprehensions _assert_raises template Union List str List torch Tensor lhs list_comprehension_of_mixed Arguments call valid Union int torch Tensor _assert_raises template Union int torch Tensor lhs list_literal_empty Expected Union type annotation inner List type _assert_raises template Union int torch Tensor lhs list_literal_of_tensor Expected Union type annotation inner List type _assert_raises template Union int torch Tensor lhs list_comprehension_of_tensor Expected Union type annotation inner List type Union List torch Tensor int _assert_passes template Union List torch Tensor int lhs list_literal_empty _assert_passes template Union List torch Tensor int lhs list_literal_of_tensor _assert_raises template Union List torch Tensor int lhs list_literal_of_str r List type annotation ` List\ Tensor\ ` did match types given list elements _assert_raises template Union List torch Tensor int lhs list_literal_of_mixed r List type annotation ` List\ Tensor\ ` did match types given list elements _assert_passes template Union List torch Tensor int lhs list_comprehension_of_tensor _assert_raises template Union List torch Tensor int lhs list_comprehension_of_str r List type annotation ` List\ Tensor\ ` did match types given list elements TODO ansley Support mixed list comprehensions _assert_raises template Union List torch Tensor int lhs list_comprehension_of_mixed Arguments call valid test_union_with_dict_assignment template = dedent fn x ann = lhs torch jit isinstance x Dict str torch Tensor x foo = torch tensor x lhs = dict_literal_empty dict_literal_of_str_tensor foo torch arange bar torch arange dict_literal_of_str_int foo bar dict_literal_of_mixed foo torch arange bar dict_comprehension_of_str_tensor x torch add y x y \ zip foo bar torch arange torch arange dict_comprehension_of_str_int x torch add y x y \ zip foo bar dict_comprehension_of_mixed x torch add y x y \ zip foo bar torch arange dict_keyword dict foo=torch arange baz=torch arange dict_keyword_with_iterable dict foo torch arange bar torch arange dict_keyword_with_empty_iterable dict dict_keyword_with_internal_aggregate_function dict zip foo bar torch arange torch arange dict_keyword_with_mapping dict foo torch arange bar torch arange dict_keyword_with_mapping_and_kwargs dict foo torch arange bar torch arange baz=torch arange Union Dict str torch Tensor Dict str int _assert_raises template Union List str List torch Tensor lhs dict_literal_empty Expected Union type annotation inner Dict type _assert_passes template Union Dict str torch Tensor Dict str int lhs dict_literal_of_str_tensor _assert_passes template Union Dict str torch Tensor Dict str int lhs dict_literal_of_str_int _assert_raises template Union Dict str torch Tensor Dict str int lhs dict_literal_of_mixed none those dict types can hold types given keys values TODO String frontend does support tuple unpacking https github com pytorch pytorch issues _assert_passes template Union Dict str torch Tensor Dict str int lhs dict_comprehension_of_str_tensor _assert_passes template Union Dict str torch Tensor Dict str int lhs dict_comprehension_of_str_int _assert_raises template Union Dict str torch Tensor Dict str int lhs dict_comprehension_of_mixed foobar _assert_passes template Union Dict str torch Tensor Dict str int lhs dict_keyword_with_internal_aggregate_function TODO ansley Follow-up project needed full type inference dict keyword supported dict comprehension dict literal already should blocker anyone _assert_raises template Union Dict str torch Tensor Dict str int lhs dict_keyword full type inference yet supported _assert_raises template Union Dict str torch Tensor Dict str int lhs dict_keyword_with_iterable full type inference yet supported _assert_raises template Union Dict str torch Tensor Dict str int lhs dict_keyword_with_empty_iterable full type inference yet supported _assert_raises template Union Dict str torch Tensor Dict str int lhs dict_keyword_with_mapping full type inference yet supported _assert_raises template Union Dict str torch Tensor Dict str int lhs dict_keyword_with_mapping_and_kwargs full type inference yet supported Union int torch Tensor _assert_raises template Union int torch Tensor lhs dict_literal_empty Expected Union type annotation inner Dict type _assert_raises template Union int torch Tensor lhs dict_literal_of_str_tensor Expected Union type annotation inner Dict type See above -- string frontend does support tuple unpacking _assert_raises template Union int torch Tensor lhs dict_comprehension_of_tensor foobar Union Dict str torch Tensor int _assert_passes template Union Dict str torch Tensor int lhs dict_literal_empty _assert_passes template Union Dict str torch Tensor int lhs dict_literal_of_str_tensor _assert_raises template Union Dict str torch Tensor int lhs dict_literal_of_str_int Type annotation inferred r ` Dict\ str Tensor\ ` type values given dict literal _assert_raises template Union Dict str torch Tensor int lhs dict_literal_of_mixed Type annotation inferred r ` Dict\ str Tensor\ ` type values given dict literal _assert_passes template Union Dict str torch Tensor int lhs dict_keyword _assert_passes template Union Dict str torch Tensor int lhs dict_keyword_with_iterable _assert_passes template Union Dict str torch Tensor int lhs dict_keyword_with_empty_iterable _assert_passes template Union Dict str torch Tensor int lhs dict_keyword_with_mapping _assert_passes template Union Dict str torch Tensor int lhs dict_keyword_with_mapping_and_kwargs See above -- string frontend does support tuple unpacking _assert_passes template Union Dict str torch Tensor int lhs dict_keyword_with_internal_aggregate_function _assert_passes template Union Dict str torch Tensor int lhs dict_comprehension_of_str_tensor _assert_raises template Union Dict str torch Tensor int lhs dict_comprehension_of_str_int foobar _assert_raises template Union Dict str torch Tensor int lhs dict_comprehension_of_mixed foobar __name__ == __main__ raise_on_run_directly test test_jit py
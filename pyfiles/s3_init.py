argparse hashlib json logging os platform stat subprocess sys urllib error urllib request pathlib Path String representing host platform e g Linux Darwin HOST_PLATFORM = platform system HOST_PLATFORM_ARCH = platform system + - + platform processor PyTorch directory root try result = subprocess run git rev-parse -- show-toplevel stdout=subprocess PIPE check=True PYTORCH_ROOT = result stdout decode utf- strip except subprocess CalledProcessError If git installed compute repo root folders up file PYTORCH_ROOT = str Path __file__ absolute parents DRY_RUN = False compute_file_sha path str - str Compute SHA hash file hex string If file doesn t exist empty string os path exists path hash = hashlib sha Open file binary mode hash open path rb f b f hash update b Return hash hexadecimal string hash hexdigest report_download_progress chunk_number int chunk_size int file_size int - None Pretty printer file download progress file_size = - pyrefly ignore no-matching-overload percent = min chunk_number chunk_size file_size bar = int percent sys stdout write f \r &#124; bar &#124; int percent check binary_path Path reference_hash str - bool Check whether binary exists right one If there hash difference delete actual binary binary_path exists logging info s does exist binary_path False existing_binary_hash = compute_file_sha str binary_path existing_binary_hash == reference_hash True logging warning \ Found binary hash does match reference Found hash s Reference hash s Deleting s just safe existing_binary_hash reference_hash binary_path DRY_RUN logging critical In dry run mode so actually deleting binary But consider deleting ASAP False try binary_path unlink except OSError logging critical Failed delete binary exc_info=True logging critical Delete binary soon possible do execute False download name str output_dir str url str reference_bin_hash str - bool Download platform-appropriate binary one doesn t already exist expected location verifies right binary checking its SHA hash against expected hash First check we need do anything binary_path = Path output_dir name check binary_path reference_bin_hash logging info Correct binary already exists s Exiting binary_path True Create output folder binary_path parent mkdir parents=True exist_ok=True Download binary logging info Downloading s s url binary_path DRY_RUN logging info Exiting there nothing left do dry run mode True urllib request urlretrieve url binary_path reporthook=report_download_progress sys stdout isatty None logging info Downloaded s successfully name Check downloaded binary check binary_path reference_bin_hash logging critical Downloaded binary s failed its hash check name False Ensure executable bits set mode = os stat binary_path st_mode mode &#124; = stat S_IXUSR os chmod binary_path mode logging info Using s located s name binary_path True __name__ == __main__ parser = argparse ArgumentParser description= downloads checks binaries s parser add_argument -- config-json required=True help= Path config json describes where find binaries hashes parser add_argument -- linter required=True help= Which linter initialize config json parser add_argument -- output-dir required=True help= place put binary parser add_argument -- output-name required=True help= name binary parser add_argument -- dry-run default=False help= do download just print what would done args = parser parse_args args dry_run == DRY_RUN = False DRY_RUN = True logging basicConfig format= DRY_RUN levelname s message s DRY_RUN levelname s message s level=logging INFO stream=sys stderr config = json load open args config_json config = config args linter Allow processor specific binaries platform namely Intel M binaries MacOS host_platform = HOST_PLATFORM HOST_PLATFORM config HOST_PLATFORM_ARCH If host platform platform_to_hash unsupported host_platform config logging error Unsupported platform s s HOST_PLATFORM HOST_PLATFORM_ARCH sys exit url = config host_platform download_url hash = config host_platform hash ok = download args output_name args output_dir url hash ok logging critical Unable initialize s args linter sys exit
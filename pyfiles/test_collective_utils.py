Owner s oncall distributed unittest mock torch torch distributed c d torch distributed collective_utils _check_rng_sync _check_rng_sync_internal _summarize_ranks all_gather broadcast torch distributed device_mesh init_device_mesh torch testing FileCheck torch testing _internal common_distributed MultiProcessTestCase torch testing _internal common_utils instantiate_parametrized_tests parametrize run_tests TestCase torch testing _internal distributed fake_pg FakeStore TestCollectiveUtils MultiProcessTestCase setUp super setUp _spawn_processes tearDown - None super tearDown opts threads= opts = c d ProcessGroupGloo _Options opts _timeout = opts _threads = threads opts test_broadcast_result - None Basic unit test broadcast using process group default world size store = c d FileStore file_name world_size c d init_process_group backend= gloo store=store rank=self rank world_size=self world_size pg = c d new_group pg_options=self opts func = mock MagicMock func return_value = pg rank res = broadcast data_or_fn=func rank= pg=pg assert res == f Expect res got res pg rank == func assert_called_once func assert_not_called func reset_mock res = broadcast data_or_fn=func rank= pg=pg assert res == f Expect res got res pg rank == func assert_called_once func assert_not_called test_broadcast_result_no_pg - None Ensure broadcast has no dependency torch distributed when run single process func = mock MagicMock broadcast data_or_fn=func rank= func assert_called_once test_broadcast_result_raises_exceptions_from_func - None Ensure broadcast exception propagated properly no process group func = mock MagicMock exc = Exception test exception func side_effect = exc expected_exception = test exception assertRaisesRegex Exception expected_exception broadcast data_or_fn=func rank= test_all_gather_result - None Basic unit test all_gather using process group default world size store = c d FileStore file_name world_size c d init_process_group backend= gloo store=store rank=self rank world_size=self world_size pg = c d new_group pg_options=self opts func = mock MagicMock func return_value = pg rank res = all_gather data_or_fn=func pg=pg func assert_called_once assert res == list range world_size f Expect res list through world_size got res test_all_gather_result_no_pg - None Ensure all_gather has no dependency torch distributed when run single process func = mock MagicMock all_gather data_or_fn=func func assert_called_once test_all_gather_result_raises_exceptions_from_func - None Ensure all_gather exception propagated properly no process group func = mock MagicMock exc = Exception test exception func side_effect = exc expected_exception = test exception assertRaisesRegex Exception expected_exception all_gather data_or_fn=func parametrize device cpu cuda test_check_rng_sync device - None device == cuda torch cuda is_available skipTest Cuda available store = c d FileStore file_name world_size c d init_process_group backend= gloo store=store rank=self rank world_size=self world_size group = torch distributed distributed_c d _get_default_group generator = torch Generator device=device generator manual_seed value_ranks _ = _check_rng_sync_internal generator group assertEqual len value_ranks value_ranks actual expected zip value_ranks values assertEqual actual expected actual torch distributed get_rank == torch randn device=device generator=generator value_ranks _ = _check_rng_sync_internal generator group assertEqual len value_ranks value_ranks actual expected zip value_ranks values assertEqual actual expected actual torch distributed get_rank == generator manual_seed value_ranks _ = _check_rng_sync_internal generator group assertEqual len value_ranks value_ranks actual expected zip value_ranks values assertEqual actual expected actual log_str = _check_rng_sync generator group FileCheck check Generator desync detected check Ranks check check check run log_str TestUtils TestCase setUp super setUp c d is_initialized rank = world_size = store = FakeStore c d init_process_group backend= fake world_size=self world_size rank=self rank store=store tearDown c d destroy_process_group test_summarize_ranks mesh_dim_names = pp dp tp mesh = init_device_mesh cpu mesh_dim_names=mesh_dim_names ranks_lists = name mesh name mesh tolist name mesh_dim_names summaries = name _summarize_ranks ranks_lists name name mesh_dim_names assertEqual summaries pp assertEqual summaries dp assertEqual summaries tp assertEqual _summarize_ranks assertEqual _summarize_ranks instantiate_parametrized_tests TestCollectiveUtils __name__ == __main__ run_tests
usr bin env python Owner s oncall r p filecmp json os shutil tempfile unittest unittest mock patch torch distributed elastic multiprocessing errors error_handler ErrorHandler torch distributed elastic multiprocessing errors handlers get_error_handler raise_exception_fn raise RuntimeError foobar GetErrorHandlerTest unittest TestCase test_get_error_handler assertTrue isinstance get_error_handler ErrorHandler ErrorHandlerTest unittest TestCase setUp test_dir = tempfile mkdtemp prefix=self __class__ __name__ test_error_file = os path join test_dir error json tearDown shutil rmtree test_dir patch faulthandler enable test_initialize fh_enable_mock ErrorHandler initialize fh_enable_mock assert_called_once patch faulthandler enable side_effect=RuntimeError test_initialize_error fh_enable_mock makes sure initialize handles errors gracefully ErrorHandler initialize fh_enable_mock assert_called_once test_record_exception patch dict os environ TORCHELASTIC_ERROR_FILE test_error_file eh = ErrorHandler eh initialize try raise_exception_fn except Exception e eh record_exception e open test_error_file fp err = json load fp error file content example message message RuntimeError foobar extraInfo py_callstack Traceback most recent call last \n OMITTED timestamp assertIsNotNone err message message assertIsNotNone err message extraInfo py_callstack assertIsNotNone err message extraInfo timestamp test_record_exception_no_error_file make sure record does fail when no error file specified env vars patch dict os environ eh = ErrorHandler eh initialize try raise_exception_fn except Exception e eh record_exception e test_dump_error_file src_error_file = os path join test_dir src_error json eh = ErrorHandler patch dict os environ TORCHELASTIC_ERROR_FILE src_error_file eh record_exception RuntimeError foobar patch dict os environ TORCHELASTIC_ERROR_FILE test_error_file eh dump_error_file src_error_file assertTrue filecmp cmp src_error_file test_error_file patch dict os environ eh dump_error_file src_error_file just validate dump_error_file works when my error file set should just log error src_error_file pretty printed test_dump_error_file_overwrite_existing dst_error_file = os path join test_dir dst_error json src_error_file = os path join test_dir src_error json eh = ErrorHandler patch dict os environ TORCHELASTIC_ERROR_FILE dst_error_file eh record_exception RuntimeError foo patch dict os environ TORCHELASTIC_ERROR_FILE src_error_file eh record_exception RuntimeError bar patch dict os environ TORCHELASTIC_ERROR_FILE dst_error_file eh dump_error_file src_error_file assertTrue filecmp cmp src_error_file dst_error_file
mypy allow-untyped-defs __future__ annotations collections OrderedDict typing Any TYPE_CHECKING Union torch fake_quantize default_weight_fake_quant FixedQParamsFakeQuantize observer _PartialWrapper default_fixed_qparams_range_ _observer default_fixed_qparams_range_neg _observer default_placeholder_observer default_weight_observer qconfig default_quint _weight_qconfig default_reuse_input_qconfig default_symmetric_qnnpack_qat_qconfig default_symmetric_qnnpack_qconfig get_default_qat_qconfig get_default_qconfig QConfig QConfigAny TYPE_CHECKING collections abc Callable __all__ = get_default_qconfig_mapping get_default_qat_qconfig_mapping QConfigMapping TODO replace all usages these constants _GLOBAL_DICT_KEY = _OBJECT_TYPE_DICT_KEY = object_type _MODULE_NAME_REGEX_DICT_KEY = module_name_regex _MODULE_NAME_DICT_KEY = module_name _MODULE_NAME_OBJECT_TYPE_ORDER_DICT_KEY = module_name_object_type_order TODO derive map BackendConfig _FIXED_QPARAMS_OP_TO_OBSERVER dict Union Callable str _PartialWrapper = torch nn Hardsigmoid default_fixed_qparams_range_ _observer torch nn functional hardsigmoid default_fixed_qparams_range_ _observer hardsigmoid default_fixed_qparams_range_ _observer hardsigmoid_ default_fixed_qparams_range_ _observer torch nn Sigmoid default_fixed_qparams_range_ _observer torch sigmoid default_fixed_qparams_range_ _observer sigmoid default_fixed_qparams_range_ _observer sigmoid_ default_fixed_qparams_range_ _observer torch nn Softmax default_fixed_qparams_range_ _observer torch nn Tanh default_fixed_qparams_range_neg _observer torch tanh default_fixed_qparams_range_neg _observer tanh default_fixed_qparams_range_neg _observer tanh_ default_fixed_qparams_range_neg _observer _get_default_qconfig_mapping is_qat bool backend str version int - QConfigMapping Return default QConfigMapping given quantization type backend is_qat qconfig = get_default_qat_qconfig backend version qconfig = get_default_qconfig backend version default_weight = default_weight_fake_quant is_qat default_weight_observer default_per_channel_weight_observer currently compatible fbgemm backend so we have modify weight observer default_weight_observer another per tensor supported observer see https github com pytorch pytorch issues backend fbgemm x qconfig_transpose = QConfig activation=qconfig activation weight=default_weight qconfig_transpose = qconfig currently layernorm only supports float weights we have add because otherwise there will extra quantize-dequantize pair qconfig_layernorm = QConfig activation=qconfig activation weight=default_placeholder_observer qconfig_mapping = QConfigMapping set_global qconfig set_object_type reshape default_reuse_input_qconfig set_object_type torch nn ConvTranspose d qconfig_transpose set_object_type torch nn ConvTranspose d qconfig_transpose set_object_type torch nn ConvTranspose d qconfig_transpose set_object_type torch nn functional conv_transpose d qconfig_transpose set_object_type torch nn functional conv_transpose d qconfig_transpose set_object_type torch nn functional conv_transpose d qconfig_transpose set_object_type torch nn functional layer_norm qconfig_layernorm set_object_type torch nn LayerNorm qconfig_layernorm set_object_type torch nn PReLU default_quint _weight_qconfig Use special observers ops fixed qparams fixed_qparams_observer_to_qconfig dict Any QConfigAny = fixed_qparams_op observer _FIXED_QPARAMS_OP_TO_OBSERVER items observer fixed_qparams_observer_to_qconfig fixed_qparams_qconfig = fixed_qparams_observer_to_qconfig observer is_qat activation = FixedQParamsFakeQuantize with_args observer=observer activation = observer fixed_qparams_qconfig = QConfig activation=activation weight=default_weight fixed_qparams_observer_to_qconfig observer = fixed_qparams_qconfig qconfig_mapping set_object_type fixed_qparams_op fixed_qparams_qconfig TODO Currently s required separate ops fused op module have same qconfig Need able support fusion ops different qconfigs qconfig_mapping get_default_qconfig_mapping backend= x version= - QConfigMapping Return default QConfigMapping post training quantization Args ` ` backend ` ` str quantization backend default qconfig mapping should one x default fbgemm qnnpack onednn ` ` version ` ` int version default qconfig mapping TODO add assert backend choices _get_default_qconfig_mapping False backend version get_default_qat_qconfig_mapping backend= x version= - QConfigMapping Return default QConfigMapping quantization aware training Args ` ` backend ` ` str quantization backend default qconfig mapping should one x default fbgemm qnnpack onednn ` ` version ` ` int version default qconfig mapping _get_default_qconfig_mapping True backend version _get_symmetric_qnnpack_qconfig_mapping - QConfigMapping Return QConfigMapping uses ` torch ao quantization default_symmetric_qnnpack_qconfig ` default QConfig default_qconfig = default_symmetric_qnnpack_qconfig _get_default_qconfig_mapping_with_default_qconfig False qnnpack default_qconfig _get_symmetric_qnnpack_qat_qconfig_mapping - QConfigMapping Return QConfigMapping uses ` torch ao quantization default_symmetric_qnnpack_qat_qconfig ` default QConfig default_qconfig = default_symmetric_qnnpack_qat_qconfig _get_default_qconfig_mapping_with_default_qconfig True qnnpack default_qconfig _get_default_qconfig_mapping_with_default_qconfig is_qat bool backend str default_qconfig QConfig - QConfigMapping Return QConfigMapping uses provided qconfig default QConfig is_qat qconfig_mapping = get_default_qat_qconfig_mapping backend qconfig_mapping = get_default_qconfig_mapping backend qconfig_mapping set_global default_qconfig pattern qconfig_mapping object_type_qconfigs keys pattern _FIXED_QPARAMS_OP_TO_OBSERVER qconfig_mapping set_object_type pattern default_qconfig qconfig_mapping _QCONFIG_STYLE_ORDER list str = global_qconfig object_type_qconfigs module_name_regex_qconfigs module_name_qconfigs module_name_object_type_order_qconfigs QConfigMapping Mapping model ops ` torch ao quantization QConfig ` s The user can specify QConfigs using following methods increasing match priority ` ` set_global ` ` sets global default QConfig ` ` set_object_type ` ` sets QConfig given module type function method name ` ` set_module_name_regex ` ` sets QConfig modules matching given regex string ` ` set_module_name ` ` sets QConfig modules matching given module name ` ` set_module_name_object_type_order ` ` sets QConfig modules matching combination given module name object type index which module appears Example usage qconfig_mapping = QConfigMapping set_global global_qconfig set_object_type torch nn Linear qconfig set_object_type torch nn ReLU qconfig set_module_name_regex foo bar conv - + qconfig set_module_name_regex foo qconfig set_module_name module qconfig set_module_name module qconfig set_module_name_object_type_order foo bar torch nn functional linear qconfig __init__ - None In increasing match priority global_qconfig QConfigAny = None object_type_qconfigs OrderedDict Union Callable str QConfigAny = OrderedDict module_name_regex_qconfigs OrderedDict str QConfigAny = OrderedDict module_name_qconfigs OrderedDict str QConfigAny = OrderedDict module_name_object_type_order_qconfigs OrderedDict tuple str Callable int QConfigAny = OrderedDict set_global global_qconfig QConfigAny - QConfigMapping Set global default QConfig global_qconfig = global_qconfig set_object_type object_type Union Callable str qconfig QConfigAny - QConfigMapping Set QConfig given module type function method name If QConfig existing object type already set new QConfig will override old one object_type_qconfigs object_type = qconfig set_module_name_regex module_name_regex str qconfig QConfigAny - QConfigMapping Set QConfig modules matching given regex string Regexes will matched order which they registered through method Thus caller should register more specific patterns first e g qconfig_mapping = QConfigMapping set_module_name_regex foo bar conv - + qconfig set_module_name_regex foo bar qconfig set_module_name_regex foo qconfig In example foo bar conv would match qconfig foo bar linear would match qconfig foo baz relu would match qconfig If QConfig existing module name regex already set new QConfig will override old one while preserving order which regexes originally registered module_name_regex_qconfigs module_name_regex = qconfig set_module_name module_name str qconfig QConfigAny - QConfigMapping Set QConfig modules matching given module name If QConfig existing module name already set new QConfig will override old one module_name_qconfigs module_name = qconfig set_module_name_object_type_order module_name str object_type Callable index int qconfig QConfigAny - QConfigMapping Set QConfig modules matching combination given module name object type index which module appears If QConfig existing module name object type index already set new QConfig will override old one module_name_object_type_order_qconfigs module_name object_type index = qconfig __repr__ - str output = __class__ __name__ + style_name _QCONFIG_STYLE_ORDER output += f \n style_name qconfigs = getattr style_name isinstance qconfigs OrderedDict len qconfigs key qconfig qconfigs items output += f \n key qconfig output += f \n qconfigs output + \n TODO remove to_dict - dict str Any Convert ` ` QConfigMapping ` ` dictionary following keys global QConfig object_type module_name_regex module_name module_name_object_type_order The values dictionary lists tuples _GLOBAL_DICT_KEY global_qconfig _OBJECT_TYPE_DICT_KEY list object_type_qconfigs items _MODULE_NAME_REGEX_DICT_KEY list module_name_regex_qconfigs items _MODULE_NAME_DICT_KEY list module_name_qconfigs items _MODULE_NAME_OBJECT_TYPE_ORDER_DICT_KEY k v k v module_name_object_type_order_qconfigs items TODO remove classmethod from_dict cls qconfig_dict dict str Any - QConfigMapping Create ` ` QConfigMapping ` ` dictionary following keys all optional global QConfig object_type module_name_regex module_name module_name_object_type_order The values dictionary expected lists tuples conf = cls _GLOBAL_DICT_KEY qconfig_dict conf set_global qconfig_dict _GLOBAL_DICT_KEY object_type qconfig qconfig_dict get _OBJECT_TYPE_DICT_KEY conf set_object_type object_type qconfig module_name_regex qconfig qconfig_dict get _MODULE_NAME_REGEX_DICT_KEY conf set_module_name_regex module_name_regex qconfig module_name qconfig qconfig_dict get _MODULE_NAME_DICT_KEY conf set_module_name module_name qconfig module_name object_type index qconfig qconfig_dict get _MODULE_NAME_OBJECT_TYPE_ORDER_DICT_KEY conf set_module_name_object_type_order module_name object_type index qconfig conf
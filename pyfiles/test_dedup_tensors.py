Owner s oncall distributed dataclasses torch torch distributed checkpoint _dedup_tensors dedup_tensors torch distributed checkpoint planner SavePlan WriteItemType torch distributed checkpoint planner_helpers _create_write_item_for_tensor torch testing _internal common_utils run_tests TestCase create_plan second_fqn str - SavePlan Creates SavePlan two write items A write item representing shard tensor named tensor_ A write item representing another tensor identified provided second_fqn Args second_fqn str The fully qualified name second tensor Returns SavePlan A plan includes two write items first write item duplicated shard covers whole tensor write_item_ = _create_write_item_for_tensor tensor_ torch rand write_item_ = dataclasses replace write_item_ type=WriteItemType SHARD second write item has different keys write_item_ = _create_write_item_for_tensor second_fqn torch rand SavePlan write_item_ write_item_ TestDedupTensor TestCase Test deduplication tensor write items across different ranks test_dedup_shards rank = create_plan r rank = create_plan r dedup_plans = dedup_tensors rank rank assertEqual len dedup_plans items assertEqual len dedup_plans items assertIn tensor_ item index fqn item dedup_plans items assertIn r item index fqn item dedup_plans items assertIn r item index fqn item dedup_plans items __name__ == __main__ run_tests
mypy allow-untyped-defs contextlib inspect os path tempfile traceback types TracebackType typing Optional This file contains utilities ensuring dynamically compile d code fragments display their line numbers backtraces The constraints - We don t have control over user exception printer particular we cannot assume linecache trick will work c f https stackoverflow com q - We don t want create temporary files every time we compile some code file creation should happen lazily only exception time Arguably you should willing write out your generated Python code file system some situations esp library code would violate user expectation write file system so we try avoid In particular we d like keep files around so users can open up files mentioned trace file invisible we want avoid clogging up filesystem If constraint you there substantially simpler way implement functionality PR instead using eval exec directly just always write Python file filesystem compile - You have control over context where compiled code will get executed so we can interpose while stack unwinding otherwise we have no way interpose exception printing process There two things you have do make use utilities here - When you compile your source code you must save its string source its f_globals under magic name __compile_source__ - Before running compiled code enter report_compile_source_on_error context manager contextlib contextmanager report_compile_source_on_error try yield except Exception exc tb = exc __traceback__ Walk traceback looking frames have source attached stack = while tb None filename = tb tb_frame f_code co_filename source = tb tb_frame f_globals get __compile_source__ filename == string source None What black magic we doing here Intuitively what we would like do overwrite co_filename any frames generated exec eval so they point temporary file has actual line information so Python s default error printer can print useful line information Writing out temporary file easy But overwriting co_filename You can t modify code object associated frame You can however reconstruct traceback entirely new frames scratch so s what we do But there s another problem which how make frame The black magic we make frankenstein frame code object which resembles original frame code enough so will print properly under traceback default error printer IT IS NOT THE ORIGINAL FRAME you couldn t e g execute its code different variables expect work Don t delete temporary file so user can inspect TODO This creates temporary file every frame we technically only need one per distinct __compile_source__ tempfile NamedTemporaryFile mode= w delete=False suffix= py f f write source Create frame Python doesn t let you construct FrameType directly so just make one compile frame = tb tb_frame code = compile __inspect_currentframe f name eval code = code replace co_name=frame f_code co_name Python only hasattr frame f_code co_linetable We can t copy ALL metadata over because you can cause Python segfault way What exactly do we need We need enough information traceback able print exception correctly Code reading Lib traceback py reveals traceback calls code co_positions order get augmented line col numbers Objects codeobject c specifically _PyCode_InitAddressRange reveals iterator initialized co_linetable co_firstfileno So copy these we must code = code replace type ignore call-arg co_linetable=frame f_code co_linetable type ignore attr-defined co_firstlineno=frame f_code co_firstlineno type ignore attr-defined fake_frame = eval code frame f_globals frame f_locals __inspect_currentframe inspect currentframe fake_tb = TracebackType None fake_frame tb tb_lasti tb tb_lineno stack append fake_tb stack append tb tb = tb tb_next Reconstruct linked list tb_next = None tb reversed stack tb tb_next = tb_next tb_next = tb raise exc with_traceback tb_next noqa B shorten_filename fn base=None Shorten source filepath assumption torch subdirectories don t need shown user base None base = os path dirname os path dirname __file__ Truncate torch foo py foo py try prefix = os path commonpath fn base except ValueError fn fn len prefix + format_frame frame base=None line=False Format FrameSummary short way without printing full absolute path code The idea result fits single line extra_line = line extra_line = f frame line f extra_line shorten_filename frame filename base=base frame lineno frame name format_traceback_short tb Format TracebackType short way printing only inner-most frame format_frame traceback extract_tb tb - CapturedTraceback __slots__ = tb skip __init__ tb skip= tb = tb skip = skip cleanup tb = None summary torch _C _profiler tb None TODO Maybe indicate traceback elided traceback StackSummary _extract_symbolized_tb torch _C _profiler symbolize_tracebacks tb skip __getstate__ None tb None TB pickleable skip skip staticmethod extract script=False cpp=False skip= Like traceback extract_stack faster approximately x faster fast enough you can unconditionally log stacks way part normal execution It returns torch _C _profiler CapturedTraceback object must formatted specially format_captured_tb By default only reports Python backtraces like extract_stack You can set script cpp kwargs also turn TorchScript C++ trace reporting torch _C _profiler script cpp skip = raise AssertionError skip script cpp NYI CapturedTraceback torch _C _profiler gather_traceback python=True script=script cpp=cpp Elide extract frame we don t have script cpp frames If we do have those frames doesn t work so force zero script cpp skip + format Formats single torch _C _profiler CapturedTraceback into list strings equivalent output traceback format_list Note pass CapturedTraceback C++ traces better use function use batch formatting API format_captured_tbs amortize cost symbolization traceback format_list summary staticmethod format_all tbs Bulk version CapturedTraceback format Returns list list strings torch _C _profiler Directly populate tracebacks already have cached summaries rs list Optional list str = delayed_idxs = i tb enumerate tbs tb tb None rs append rs append None delayed_idxs append i torch _C _profiler symbolize_tracebacks tbs i tb i delayed_idxs i delayed_idxs rs i = traceback format_list tbs i summary rs _extract_symbolized_tb tb skip Given symbolized traceback symbolize_tracebacks StackSummary object pre-processed stack trace entries stack = traceback StackSummary f reversed tb skip stack append traceback FrameSummary f filename f line f name stack
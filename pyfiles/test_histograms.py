Owner s module dynamo functools unittest expectedFailure xfail skipIf pytest raises assert_raises skip = functools partial skipIf True torch testing _internal common_utils instantiate_parametrized_tests parametrize run_tests slowTest slow TEST_WITH_TORCHDYNAMO TestCase xpassIfTorchDynamo_np TEST_WITH_TORCHDYNAMO numpy np numpy histogram histogram_bin_edges histogramdd numpy testing assert_ assert_allclose assert_almost_equal assert_array_almost_equal assert_array_equal assert_equal torch _numpy np torch _numpy histogram histogramdd torch _numpy testing assert_ assert_allclose assert_almost_equal assert_array_almost_equal assert_array_equal assert_equal TestHistogram TestCase test_simple n = v = np random rand n b = histogram v check sum bins equals number samples assert_equal np sum axis= n check bin counts evenly spaced when data linear function b = histogram np linspace assert_array_equal test_one_bin Ticket hist edges = histogram assert_array_equal hist assert_array_equal edges assert_raises RuntimeError ValueError histogram bins= h e = histogram bins= assert_equal h np array assert_allclose e np array test_density Check integral density equals n = v = np random rand n b = histogram v density=True area = np sum np diff b assert_almost_equal area Check non-constant bin widths v = np arange bins = b = histogram v bins density=True assert_almost_equal assert_equal np sum np diff b Test passing False works too b = histogram v bins density=False assert_array_equal Variable bin widths especially useful deal infinities v = np arange bins = np inf b = histogram v bins density=True assert_almost_equal Taken bug report N Becker numpy-discussion mailing list Aug counts dmy = np histogram np inf density=True assert_equal counts test_outliers Check outliers tallied = np arange + Lower outliers h b = histogram range= assert_equal h sum Upper outliers h b = histogram range= assert_equal h sum Normalization h b = histogram range= density=True assert_almost_equal h np diff b sum decimal= Weights w = np arange + h b = histogram range= weights=w density=True assert_equal h np diff b sum h b = histogram bins= range= weights=w assert_equal h w - test_arr_weights_mismatch = np arange + w = np arange + assert_raises RuntimeError ValueError same shape h b = histogram range= weights=w density=True test_type Check type returned histogram = np arange + h b = histogram assert_ np issubdtype h dtype np integer h b = histogram density=True assert_ np issubdtype h dtype np floating h b = histogram weights=np ones int assert_ np issubdtype h dtype np integer h b = histogram weights=np ones float assert_ np issubdtype h dtype np floating test_f _rounding gh- check rounding edges works float x = np array - dtype=np float y = np array dtype=np float counts_hist xedges yedges = np histogram d x y bins= assert_equal counts_hist sum test_bool_conversion gh- Reference integer histogram = np array dtype=np uint int_hist int_edges = np histogram Should raise warning booleans Ensure histograms equivalent need suppress warnings get actual outputs suppress_warnings sup rec = sup record RuntimeWarning Converting input hist edges = np histogram True True False A warning should issued assert_equal len rec assert_array_equal hist int_hist assert_array_equal edges int_edges test_weights v = np random rand w = np ones b = histogram v na nb = histogram v density=True wa wb = histogram v weights=w nwa nwb = histogram v weights=w density=True assert_array_almost_equal wa assert_array_almost_equal na nwa Check weights properly applied v = np linspace w = np concatenate np zeros np ones wa wb = histogram v bins=np arange weights=w assert_array_almost_equal wa w Check integer weights wa wb = histogram bins= weights= assert_array_equal wa wa wb = histogram bins= weights= density=True assert_array_almost_equal wa np array Check weights non-uniform bin widths b = histogram np arange weights= density=True assert_almost_equal xpassIfTorchDynamo_np reason= histogram complex weights test_exotic_weights Test use weights integer floats e g complex numbers object types Complex weights values = np array weights = np array - + j np array Check custom bins wa wb = histogram values bins= weights=weights assert_array_almost_equal wa np array + j np array Check even bins wa wb = histogram values bins= range= weights=weights assert_array_almost_equal wa np array + j np array Decimal weights decimal Decimal values = np array weights = np array Decimal Decimal Decimal Check custom bins wa wb = histogram values bins= weights=weights assert_array_almost_equal wa Decimal Decimal Check even bins wa wb = histogram values bins= range= weights=weights assert_array_almost_equal wa Decimal Decimal test_no_side_effects This regression test ensures values passed ` ` histogram ` ` unchanged values = np array np histogram values range= - bins= assert_array_almost_equal values test_empty b = histogram bins= assert_array_equal np array assert_array_equal b np array test_error_binnum_type Tests right Error raised bins argument float vals = np linspace num= histogram vals assert_raises TypeError histogram vals test_finite_range Normal ranges should fine vals = np linspace num= histogram vals range= assert_raises RuntimeError ValueError histogram vals range= np nan assert_raises RuntimeError ValueError histogram vals range= np inf test_invalid_range start range must end range vals = np linspace num= assert_raises RuntimeError ValueError np histogram vals range= xfail reason= edge cases test_bin_edge_cases Ensure floating-point computations correctly place edge cases arr = np array hist edges = np histogram arr bins= range= mask = hist left_edges = edges - mask right_edges = edges mask x left right zip arr left_edges right_edges assert_ x = left assert_ x right msg=f x right test_last_bin_inclusive_range arr = np array hist edges = np histogram arr bins= range= - assert_equal hist - test_bin_array_dims gracefully handle bins object dimension vals = np linspace num= bins = np array assert_raises RuntimeError ValueError np histogram vals bins=bins xpassIfTorchDynamo_np reason= no uint test_unsigned_monotonicity_check Ensures ValueError raised bins increasing monotonically when bins contain unsigned values see arr = np array bins = np array dtype= uint assert_raises RuntimeError ValueError hist edges = np histogram arr bins=bins test_object_array_of_ d gh- assert_raises RuntimeError ValueError histogram np array i range + -np inf assert_raises RuntimeError ValueError histogram np array i range + np inf these should crash np histogram np array i range + np histogram np array i range + xpassIfTorchDynamo_np reason= bins= auto test_some_nan_values gh- one_nan = np array np nan all_nan = np array np nan np nan internal comparisons NaN give warnings sup = suppress_warnings sup filter RuntimeWarning sup can t infer range nan assert_raises ValueError histogram one_nan bins= auto assert_raises ValueError histogram all_nan bins= auto explicit range solves problem h b = histogram one_nan bins= auto range= assert_equal h sum nan counted h b = histogram all_nan bins= auto range= assert_equal h sum nan counted does explicit set bins h b = histogram one_nan bins= assert_equal h sum nan counted h b = histogram all_nan bins= assert_equal h sum nan counted do_signed_overflow_bounds dtype exponent = np dtype dtype itemsize - arr = np array - exponent + exponent - dtype=dtype hist e = histogram arr bins= assert_equal e - exponent + exponent - assert_equal hist test_signed_overflow_bounds do_signed_overflow_bounds np byte do_signed_overflow_bounds np short do_signed_overflow_bounds np intc xfail reason= int- float conversin loses precision test_signed_overflow_bounds_ do_signed_overflow_bounds np int_ do_signed_overflow_bounds np longlong do_precision_lower_bound float_small float_large eps = np finfo float_large eps arr = np array float_small range = np array + eps float_large test looking behavior when bounds change between dtypes range astype float_small = previously crashed count x_loc = np histogram arr bins= range=range assert_equal count gh- means type comes arr - may change assert_equal x_loc dtype float_small do_precision_upper_bound float_small float_large eps = np finfo float_large eps arr = np array float_small range = np array - eps float_large test looking behavior when bounds change between dtypes range astype float_small - = previously crashed count x_loc = np histogram arr bins= range=range assert_equal count gh- means type comes arr - may change assert_equal x_loc dtype float_small do_precision float_small float_large do_precision_lower_bound float_small float_large do_precision_upper_bound float_small float_large xpassIfTorchDynamo_np reason= mixed dtypes test_precision looping results useful stack trace upon failure do_precision np half np single do_precision np half np double do_precision np single np double xpassIfTorchDynamo_np reason= histogram_bin_edges test_histogram_bin_edges hist e = histogram edges = histogram_bin_edges assert_allclose edges e atol= e- arr = np array hist e = histogram arr bins= range= - edges = histogram_bin_edges arr bins= range= - assert_allclose edges e atol= e- hist e = histogram arr bins= auto range= edges = histogram_bin_edges arr bins= auto range= assert_allclose edges e atol= e- requires_memory free_bytes= e xpassIfTorchDynamo_np reason= pytorch does support bins = int int array slow test_big_arrays sample = np zeros xbins = ybins = zbins = np arange hist = np histogramdd sample=sample bins= xbins ybins zbins assert_equal type hist type xpassIfTorchDynamo_np reason= TODO instantiate_parametrized_tests TestHistogramOptimBinNums TestCase Provide test coverage when using provided estimators optimal number bins test_empty estimator_list = fd scott rice sturges doane sqrt auto stone check can deal empty data estimator estimator_list b = histogram bins=estimator assert_array_equal np array assert_array_equal b np array test_simple Straightforward testing mixture linspace data consistency All test values have been precomputed values shouldn t change Some basic sanity checking some fixed data Checking correct number bins basic_test = fd scott rice sturges doane sqrt auto stone fd scott rice sturges doane sqrt auto stone fd scott rice sturges doane sqrt auto stone testlen expectedResults basic_test items Create some sort non uniform data test peak uniform mixture x = np linspace - - testlen x = np linspace testlen x = np concatenate x x estimator numbins expectedResults items b = np histogram x estimator assert_equal len numbins err_msg=f For estimator estimator datasize testlen test_small Smaller datasets have potential cause issues data adaptive methods especially FD method All bin numbers have been precalculated small_dat = fd scott rice sturges doane sqrt stone fd scott rice sturges doane sqrt stone fd scott rice sturges doane sqrt stone testlen expectedResults small_dat items testdat = np arange testlen estimator expbins expectedResults items b = np histogram testdat estimator assert_equal len expbins err_msg=f For estimator estimator datasize testlen test_incorrect_methods Check Value Error thrown when unknown string passed check_list = mad freeman histograms IQR estimator check_list assert_raises ValueError histogram estimator test_novariance Check methods handle no variance data Primarily Scott FD SD IQR both case novar_dataset = np ones novar_resultdict = fd scott rice sturges doane sqrt auto stone estimator numbins novar_resultdict items b = np histogram novar_dataset estimator assert_equal len numbins err_msg=f estimator estimator No Variance test test_limited_variance Check when IQR variance exists we sturges value fd value lim_var_data = np ones lim_var_data = lim_var_data - = edges_auto = histogram_bin_edges lim_var_data auto assert_equal edges_auto np linspace assert_allclose edges_auto np linspace rtol= e- edges_fd = histogram_bin_edges lim_var_data fd assert_equal edges_fd np array assert_allclose edges_fd np array rtol= e- edges_sturges = histogram_bin_edges lim_var_data sturges assert_equal edges_sturges np linspace assert_allclose edges_sturges np linspace rtol= e- test_outlier Check FD Scott Doane outliers The FD estimates smaller binwidth since s less affected outliers Since range so artificially large means more bins most which will empty data interest usually unaffected The Scott estimator more affected returns fewer bins despite most variance being one area data The Doane estimator lies somewhere between other two xcenter = np linspace - outlier_dataset = np hstack np linspace - - xcenter outlier_resultdict = fd scott doane stone estimator numbins outlier_resultdict items b = np histogram outlier_dataset estimator assert_equal len numbins test_scott_vs_stone Verify Scott s rule Stone s rule converges normally distributed data nbins_ratio seed size rng = np random RandomState seed x = rng normal loc= scale= size=size b = len np histogram x stone len np histogram x scott + b ll = nbins_ratio seed size size np geomspace start= stop= num= round astype int seed range average difference between two methods decreases dataset size increases avg = abs np mean ll axis= - assert_almost_equal avg decimal= test_simple_range Straightforward testing mixture linspace data consistency Adding rd mixture will then completely ignored All test values have been precomputed shouldn t change some basic sanity checking some fixed data Checking correct number bins basic_test = fd scott rice sturges auto stone fd scott rice sturges auto stone fd scott rice sturges auto stone testlen expectedResults basic_test items create some sort non uniform data test peak uniform mixture x = np linspace - - testlen x = np linspace testlen x = np linspace - - testlen x = np hstack x x x estimator numbins expectedResults items b = np histogram x estimator range= - msg = f For estimator estimator msg += f datasize testlen assert_equal len numbins err_msg=msg parametrize bins auto fd doane scott stone rice sturges test_signed_integer_data bins Regression test gh- = np array - dtype=np int hist edges = np histogram bins=bins hist edges = np histogram astype np int bins=bins assert_array_equal hist hist assert_array_equal edges edges test_simple_weighted Check weighted data raises TypeError estimator_list = fd scott rice sturges auto estimator estimator_list assert_raises TypeError histogram estimator weights= TestHistogramdd TestCase test_simple x = np array - - - H edges = histogramdd x range= - answer = np array assert_array_equal H answer Check normalization ed = - H edges = histogramdd x bins=ed density=True assert_ np all H == answer Check H has correct shape H edges = histogramdd x range= - density=True answer = np array assert_array_almost_equal H answer Check sequence arrays accepted H has correct shape z = np squeeze y y np split x axis= H edges = histogramdd z bins= range= - answer = np array assert_array_equal H answer Z = np zeros Z list range list range list range = H edges = histogramdd np arange np arange np arange assert_array_equal H Z test_shape_ d All possible permutations bins different lengths D bins = r = np random rand b bins H edges = histogramdd r b assert_ H shape == b test_shape_ d All possible permutations bins different lengths D bins = r = np random rand b bins H edges = histogramdd r b assert_ H shape == b h e = histogramdd r b weights=np ones assert_equal H h edge e zip edges e assert edge == e all test_weights v = np random rand hist edges = histogramdd v n_hist edges = histogramdd v density=True w_hist edges = histogramdd v weights=np ones assert_array_equal w_hist hist w_hist edges = histogramdd v weights=np ones density=True assert_array_equal w_hist n_hist w_hist edges = histogramdd v weights=np ones int assert_array_equal w_hist hist test_identical_samples x = np zeros int hist edges = histogramdd x bins= assert_array_equal edges np array - test_empty b = histogramdd bins= assert_array_max_ulp np array assert_allclose np array atol= e- b = np histogramdd bins= assert_array_max_ulp np zeros assert_allclose np zeros atol= e- test_bins_errors There two ways specify bins Check right errors when mixing those x = np arange reshape assert_raises RuntimeError ValueError np histogramdd x bins= - assert_raises RuntimeError ValueError np histogramdd x bins= assert_raises RuntimeError ValueError np histogramdd x bins= - xpassIfTorchDynamo_np reason= pytorch does support bins = int int array test_bins_error_ mixing scalar bins explicit bin arrays ugh x = np arange reshape assert_ np histogramdd x bins= xpassIfTorchDynamo_np reason= pytorch does support bins = int int array test_inf_edges Test using + -inf bin edges works See x = np arange reshape expected = np array h e = np histogramdd x bins= -np inf assert_allclose h expected h e = np histogramdd x bins= np array - np inf assert_allclose h expected h e = np histogramdd x bins= -np inf np inf assert_allclose h expected test_rightmost_binedge Test event very close rightmost binedge See Github issue x = bins = hist _ = histogramdd x bins=bins assert_ hist == assert_ hist == x = bins = hist _ = histogramdd x bins=bins assert_ hist == assert_ hist == x = bins = hist _ = histogramdd x bins=bins assert_ hist == assert_ hist == x = bins = hist _ = histogramdd x bins=bins assert_ hist == assert_ hist == test_finite_range vals = np random random histogramdd vals range= assert_raises RuntimeError ValueError histogramdd vals range= np inf assert_raises RuntimeError ValueError histogramdd vals range= np nan xpassIfTorchDynamo_np reason= pytorch does allow equal entries test_equal_edges Test adjacent entries edge array can equal x = np array y = np array x_edges = np array y_edges = hist edges = histogramdd x y bins= x_edges y_edges hist_expected = np array x == falls final bin assert_equal hist hist_expected test_edge_dtype Test edge array input its type preserved x = np array y = x x_edges = np array y_edges = x_edges hist edges = histogramdd x y bins= x_edges y_edges assert_equal edges dtype x_edges dtype assert_equal edges dtype y_edges dtype test_large_integers big = Too large represent full precision float x = np asarray dtype=np int x_edges = np array - + np int y = big + x y_edges = big + x_edges hist edges = histogramdd x y bins= x_edges y_edges assert_equal hist test_density_non_uniform_ d Defines following grid +-+ ----- + + &#124; + + &#124; + +-+ ----- + +-+ ----- + x_edges = np array y_edges = np array relative_areas = np array ensure number points each region proportional its area x = np array + + + y = np array + + + sanity check above worked intended hist edges = histogramdd y x bins= y_edges x_edges assert_equal hist relative_areas resulting histogram should uniform since counts areas proportional hist edges = histogramdd y x bins= y_edges x_edges density=True assert_equal hist test_density_non_uniform_ d compare histogram show results same v = np arange bins = np array hist edges = histogram v bins density=True hist_dd edges_dd = histogramdd v bins density=True assert_equal hist hist_dd assert_equal edges edges_dd test_bins_array x = np array - - - H edges = histogramdd x assert all type e np ndarray e edges __name__ == __main__ run_tests
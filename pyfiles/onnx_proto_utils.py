mypy allow-untyped-defs Utilities manipulating onnx onnx-script dependencies ONNX proto __future__ annotations glob os shutil typing Any TYPE_CHECKING torch torch serialization torch onnx errors torch onnx _internal torchscript_exporter jit_utils registration TYPE_CHECKING io collections abc Mapping export_as_test_case model_bytes bytes inputs_data outputs_data name str dir str - str Export ONNX model contained ONNX test case The test case contains model inputs outputs data The directory structure follows dir \u c\u \u test_ name \u \u c\u \u model onnx \u \u \u \u test_data_set_ \u \u c\u \u input_ pb \u \u c\u \u input_ pb \u \u c\u \u output_ pb \u \u \u \u output_ pb Args model_bytes The ONNX model bytes inputs_data The inputs data nested data structure numpy ndarray outputs_data The outputs data nested data structure numpy ndarray Returns The path test case directory try onnx except ImportError exc raise ImportError Export test case ONNX format failed Please install ONNX exc test_case_dir = os path join dir test_ + name os makedirs test_case_dir exist_ok=True _export_file model_bytes os path join test_case_dir model onnx data_set_dir = os path join test_case_dir test_data_set_ os path exists data_set_dir shutil rmtree data_set_dir os makedirs data_set_dir proto = onnx load_model_from_string model_bytes type ignore attr-defined i input_proto input enumerate zip proto graph input inputs_data export_data input input_proto os path join data_set_dir f input_ i pb i output_proto output enumerate zip proto graph output outputs_data export_data output output_proto os path join data_set_dir f output_ i pb test_case_dir load_test_case dir str - tuple bytes Any Any Load contained ONNX test case directory The test case must contain model inputs outputs data The directory structure should follows dir \u c\u \u test_ name \u \u c\u \u model onnx \u \u \u \u test_data_set_ \u \u c\u \u input_ pb \u \u c\u \u input_ pb \u \u c\u \u output_ pb \u \u \u \u output_ pb Args dir The directory containing test case Returns model_bytes The ONNX model bytes inputs inputs data mapping input name numpy ndarray outputs outputs data mapping output name numpy ndarray try onnx onnx numpy_helper type ignore attr-defined except ImportError exc raise ImportError Load test case ONNX format failed Please install ONNX exc open os path join dir model onnx rb f model_bytes = f read test_data_dir = os path join dir test_data_set_ inputs = input_files = glob glob os path join test_data_dir input_ pb input_file input_files tensor = onnx load_tensor input_file type ignore attr-defined inputs tensor name = numpy_helper to_array tensor outputs = output_files = glob glob os path join test_data_dir output_ pb output_file output_files tensor = onnx load_tensor output_file type ignore attr-defined outputs tensor name = numpy_helper to_array tensor model_bytes inputs outputs export_data data value_info_proto f str - None Export data ONNX protobuf format Args data The data export nested data structure numpy ndarray value_info_proto The ValueInfoProto data The type ValueInfoProto determines how data stored f The file write data try onnx numpy_helper type ignore attr-defined except ImportError exc raise ImportError Export data ONNX format failed Please install ONNX exc open f wb opened_file value_info_proto type HasField map_type opened_file write numpy_helper from_dict data value_info_proto name SerializeToString value_info_proto type HasField sequence_type opened_file write numpy_helper from_list data value_info_proto name SerializeToString value_info_proto type HasField optional_type opened_file write numpy_helper from_optional data value_info_proto name SerializeToString assert value_info_proto type HasField tensor_type opened_file write numpy_helper from_array data value_info_proto name SerializeToString _export_file model_bytes bytes f io BytesIO &#124; str export_map Mapping str bytes - None export write model bytes into directory protobuf zip assert len export_map == torch serialization _open_file_like f wb opened_file opened_file write model_bytes _add_onnxscript_fn model_bytes bytes custom_opsets Mapping str int - bytes Insert model-included custom onnx-script function into ModelProto try onnx except ImportError e raise errors OnnxExporterError Module onnx installed e For GB model onnx load_fromstring would fail However because _export_onnx tensors should saved separately proto size GB some reason did model would fail serialization anyway terms protobuf limitation So we don t need worry about GB model getting here model_proto = onnx load_model_from_string model_bytes type ignore attr-defined Iterate graph nodes insert only included custom function_proto into model_proto onnx_function_list = type ignore var-annotated included_node_func set str = set onnx_function_list included_node_func expanded in-place _find_onnxscript_op model_proto graph included_node_func custom_opsets onnx_function_list onnx_function_list model_proto functions extend onnx_function_list model_bytes = model_proto SerializeToString model_bytes _find_onnxscript_op graph_proto included_node_func set str custom_opsets Mapping str int onnx_function_list list Recursively iterate ModelProto find ONNXFunction op may contain control flow Op node graph_proto node node_kind = node domain + + node op_type Recursive needed control flow nodes IF Loop which has inner graph_proto attr node attribute attr g None _find_onnxscript_op attr g included_node_func custom_opsets onnx_function_list Only custom Op ONNX function aten symbolic_fn should found registry onnx_function_group = registration registry get_function_group node_kind Ruled out corner cases onnx prim registry node domain jit_utils is_aten node domain jit_utils is_prim node domain jit_utils is_onnx node domain onnx_function_group None node_kind included_node_func specified_version = custom_opsets get node domain onnx_fn = onnx_function_group get specified_version onnx_fn None hasattr onnx_fn to_function_proto onnx_function_proto = onnx_fn to_function_proto type ignore attr-defined onnx_function_list append onnx_function_proto included_node_func add node_kind continue raise errors UnsupportedOperatorError node_kind specified_version onnx_function_group get_min_supported onnx_function_group None onnx_function_list included_node_func
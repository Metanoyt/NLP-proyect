Owner s oncall jit os random sys tempfile textwrap dedent torch torch testing _internal common_utils raise_on_run_directly torch testing _internal jit_utils execWrapper JitTestCase Make helper files test importable pytorch_test_dir = os path dirname os path dirname os path realpath __file__ sys path append pytorch_test_dir get_fn file_name script_path importlib util spec = importlib util spec_from_file_location file_name script_path module = importlib util module_from_spec spec spec loader exec_module module fn = module fn fn TestPythonBuiltinOP JitTestCase test_add func b c = + b c += c = torch rand requires_grad=True b = torch rand requires_grad=True checkScript func b optimize=True test_mul func b b = torch rand requires_grad=True b = torch rand requires_grad=True checkScript func b optimize=True test_matmul_py code = dedent fn b b tempfile TemporaryDirectory tmp_dir script_path = os path join tmp_dir script py open script_path w f f write code fn = get_fn test_matmul_py script_path = torch rand requires_grad=True b = torch rand requires_grad=True checkScript fn b optimize=True test_pow func b b func b c d c + b d func b type int float - float b func type - float - func x y x item y item = torch rand requires_grad=True b = torch rand requires_grad=True c = torch rand requires_grad=True d = torch rand requires_grad=True checkScript func b optimize=True checkScript func b c d optimize=True checkScript func - optimize=True checkScript func inputs = torch tensor torch tensor - torch tensor torch tensor x inputs y inputs x continue checkScript func x y test_triple func x x x = torch rand dtype=torch float requires_grad=True checkScript func x optimize=True test_slice func x x x = torch rand dtype=torch float requires_grad=True checkScript func x optimize=True func x x checkScript func x optimize=True func x x checkScript func x optimize=True func x x checkScript func x optimize=True test_gather func x x x = torch rand dtype=torch float requires_grad=True checkScript func x optimize=True test_random torch jit script f mean std torch normal mean std mean std = torch zeros torch ones torch random fork_rng devices= output = torch normal mean std torch random fork_rng devices= script_output = f mean std assertEqual output script_output _check_code code_str fn_name inputs scope = exec code_str globals scope cu = torch jit CompilationUnit code_str assertEqual cu func inputs scope fn_name inputs test_stepped_tuple_slicing check_slicing_tuple slicing tuple_type tuple template = dedent func x type - Any x _check_code template format tuple_type slicing func tuple check_slicing_tuple - Tuple int int int check_slicing_tuple Tuple int int int int int check_slicing_tuple Tuple int int int int int check_slicing_tuple - Tuple int int int int int int int check_slicing_tuple Tuple int int int int int int int check_slicing_tuple - Tuple int int int int int int int check_slicing_tuple - Tuple int int int int int check_slicing_tuple - Tuple int int int int int int check_slicing_tuple - Tuple int int int int int test_index consec size start= numel = torch tensor size prod item torch arange numel view size check_indexing indexing tensor template = dedent func x x _check_code template format indexing func tensor check_dynamic_indexing indexing tensor value value value = torch tensor value value = torch tensor value template = dedent func x value value i = int value j = int value x _check_code template format indexing func tensor value value basic slices check_indexing consec check_indexing consec check_indexing consec check_indexing consec check_indexing - consec check_indexing consec check_indexing - consec check_indexing - - consec check_indexing consec check_indexing consec check_indexing consec multi-dim indexes check_indexing consec check_indexing consec check_indexing consec check_indexing - consec multi-dim mixed slicing indexing check_indexing consec check_indexing consec check_indexing consec check_indexing - consec check_indexing - consec check_indexing - consec check_indexing - consec check_indexing - consec zero-sized slices check_indexing consec check_indexing consec trivial expression usage check_indexing + consec check_indexing + consec None new dimensions check_indexing None consec check_indexing None consec check_indexing None None consec check_indexing None None consec check_indexing None consec check_indexing None - consec check_indexing None - - None consec check_indexing - None None consec check_indexing None - None None None consec dynamic expression usage check_dynamic_indexing i + j consec check_dynamic_indexing i j i consec test_advancedindex consec size start= numel = torch tensor size prod item torch arange numel view size check_indexing indexing tensor kwargs indices_dict = kwargs template = dedent func x formals x expr formals = values = formal value indices_dict items formals append formal values append value formals = join map format formals inputs = tensor + values _check_code template format formals=formals expr=indexing func inputs Indexing tensor basic check_indexing i consec i=torch tensor check_indexing i consec i=torch tensor check_indexing i consec i=torch tensor - check_indexing i consec i=torch tensor check_indexing i consec i=torch tensor - NB indexing tensors indexing sequences can implemented very similar way sequences converted tensors so only one case needs tested extensively XXX When we can index sequences replace these cases sequence indexing expressions those much easier read Misc sequence advanced indexing inp = consec to_check = i i i j i j i j i j i j k i j k i j k i j k i i i i i i i j i j i j i j i j i j i j i j i j i j i j i j i j i j i j i j i j i j i j i j i j i j i j i j i j i j i j i j expr argdict to_check tensordict = k torch tensor v k v argdict items check_indexing expr inp tensordict test_adv_indexing_list indexing list equivalent indexing tensor func x x func x x func x x func x ls = ls append ls append x ls func x ls = x ls input = torch rand checkScript func input checkScript func input checkScript func input checkScript func input checkScript func input test_index_ellipses vals = None _ range indices = random choice vals _ range indices random randint len indices - = test_str = dedent f x = torch ones x indices shape format indices=indices test_str = test_str replace r r scope = execWrapper test_str globals scope cu = torch jit CompilationUnit test_str res = cu f res = scope f assertEqual res res test_inf torch jit script foo float inf s = torch rand assertTrue foo s torch jit script bar float -inf s = torch rand assertTrue foo s test re-assignment imported source str = foo x type bool = float -inf x = float torch tensor cu = torch jit CompilationUnit str assertTrue cu foo True assertFalse cu foo False test_str_to_float torch jit script foo == float hello s = torch rand assertRaisesRegex RuntimeError could convert string float assertTrue foo s torch jit script foo == float s = torch rand assertTrue foo s torch jit script foo == float s = torch rand assertTrue foo s __name__ == __main__ raise_on_run_directly test test_jit py
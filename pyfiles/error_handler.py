usr bin env python mypy allow-untyped-defs Copyright c Facebook Inc its affiliates All rights reserved This source code licensed under BSD-style license found LICENSE file root directory source tree faulthandler json logging os time traceback warnings typing Any Optional __all__ = ErrorHandler logger = logging getLogger __name__ ErrorHandler Write provided exception object along some other metadata about error structured way JSON format error file specified environment variable ` ` TORCHELASTIC_ERROR_FILE ` ` If environment variable set then simply logs contents what would have been written error file This handler may subclassed customize handling error Subclasses should override ` ` initialize ` ` ` ` record_exception ` ` _get_error_file_path - Optional str Return error file path May ` ` None ` ` have structured error logged only os environ get TORCHELASTIC_ERROR_FILE None initialize - None Call prior running code we wish capture errors exceptions Typically registers signal fault handlers Users can override function add custom initialization registrations aid propagation information errors signals exceptions faults try faulthandler enable all_threads=True except Exception e warnings warn f Unable enable fault handler type e __name__ e stacklevel= _write_error_file file_path str error_msg str - None Write error message file try open file_path w fp fp write error_msg except Exception e warnings warn f Unable write error file type e __name__ e stacklevel= record_exception e BaseException - None Write structured information about exception into error file JSON format If error file cannot determined then logs content would have been written error file file = _get_error_file_path file data = message message f type e __name__ e extraInfo py_callstack traceback format_exc timestamp str int time time open file w fp json dump data fp override_error_code_in_rootcause_data rootcause_error_file str rootcause_error dict str Any error_code int = Modify rootcause_error read file correctly set exit code message rootcause_error logger warning child error file s does have field ` message ` \n cannot override error code s rootcause_error_file error_code isinstance rootcause_error message str logger warning child error file s has new message format \n skipping error code override rootcause_error_file rootcause_error message errorCode = error_code dump_error_file rootcause_error_file str error_code int = Dump parent error file child process s root cause error error code open rootcause_error_file fp rootcause_error = json load fp Override error code since child process cannot capture error code terminated signals like SIGSEGV error_code override_error_code_in_rootcause_data rootcause_error_file rootcause_error error_code logger debug child error file s contents \n s rootcause_error_file json dumps rootcause_error indent= my_error_file = _get_error_file_path my_error_file Guard against existing error files This can happen when child created using multiprocessing same env var TORCHELASTIC_ERROR_FILE used parent child specify error files respectively because env vars child set wrapper function default child inherits parent s env vars child process receives signal before wrapper function kicks signal handler writes error file then child will write parent s error file In case just log original error file contents overwrite error file _rm my_error_file _write_error_file my_error_file json dumps rootcause_error logger info dumped error file parent s s my_error_file logger error no error file defined parent copy child error file s rootcause_error_file _rm my_error_file os path isfile my_error_file Log contents original file open my_error_file fp try original = json dumps json load fp indent= logger warning s already exists will overwritten Original contents \n s my_error_file original except json decoder JSONDecodeError logger warning s already exists will overwritten Unable load original contents \n my_error_file os remove my_error_file
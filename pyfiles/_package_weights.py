collections warnings torch torch _subclasses fake_tensor FakeTensor torch utils _ordered_set OrderedSet _end_ptr tensor torch Tensor - int tensor nelement stop = tensor view - - data_ptr + tensor element_size stop = tensor data_ptr stop TensorProperties __init__ tensor torch Tensor is_fake = isinstance tensor FakeTensor is_contiguous = tensor is_contiguous storage_ptr = None storage_size = None start = None end = None is_fake only get storage pointer real tensors pyrefly ignore bad-assignment storage_ptr = tensor untyped_storage data_ptr is_contiguous only get storage size start end pointers contiguous tensors pyrefly ignore bad-assignment storage_size = tensor untyped_storage nbytes pyrefly ignore bad-assignment start = tensor data_ptr pyrefly ignore bad-assignment end = _end_ptr tensor info recover tensor shape = tensor shape stride = tensor stride offset = tensor storage_offset is_complete - bool Whether tensor completely overlaps its underlying storage is_fake Theoretically fake tensors should appear weights But we handle corner case make always complete True is_contiguous False assert storage_ptr None assert storage_size None assert start None assert end None start == storage_ptr end == storage_ptr + storage_size Weights dict A dictionary mapping weight name tuple tensor TensorProperties tensor represents actual initial value weight TensorProperties represents properties weight needed recover weight We use two separate entries because ` tensor ` could clone original weight tensor so doesn t have same property original weight such underlying storage pointer __init__ weight_dict dict str tuple torch Tensor TensorProperties super __init__ weight_dict get_weight name str - tuple torch Tensor TensorProperties name get_weight_properties name str - TensorProperties name get_complete group OrderedSet tuple str str models_weights dict str Weights - tuple str str ` group ` model_name weight_name tuple ` model_weights ` dictionary mapping model name its Weights One tensor ` group ` must complete they must share same underlying storage Returns name complete tensor ` group ` If multiple tensors complete returns arbitrary one get_tensor_properties name_tuple tuple str str - TensorProperties returns tensor properties model_name weight_name = name_tuple models_weights model_name get_weight_properties weight_name name_tuple group tensor_property = get_tensor_properties name_tuple tensor_property is_complete name_tuple warnings warn No complete tensor found group Returning first one This may cause issues when your weights CPU stacklevel= assert len group next iter group group_weights all_weights dict str Weights - list OrderedSet tuple str str Group weights share same underlying storage Returns list sets each set contains tuple model_name weight_name weights_dict dict tuple int torch dtype OrderedSet tuple str str = collections defaultdict OrderedSet storage_key dtype - set weight model_name weights all_weights items weight_name tensor properties weights items weights_dict properties storage_ptr tensor dtype add model_name weight_name list weights_dict values
Owner s module mtia os tempfile unittest torch torch testing _internal common_utils common torch utils cpp_extension torch testing _internal common_utils IS_ARM IS_LINUX skipIfTorchDynamo TEST_CUDA TEST_MPS TEST_PRIVATEUSE TEST_XPU torch utils cpp_extension CUDA_HOME ROCM_HOME define TEST_ROCM before changing TEST_CUDA TEST_ROCM = TEST_CUDA torch version hip None ROCM_HOME None TEST_CUDA = TEST_CUDA CUDA_HOME None Since we use fake MTIA device backend test generic Stream Event device backends mutual exclusive each other The test will skipped any following conditions met unittest skipIf IS_ARM IS_LINUX TEST_CUDA TEST_XPU TEST_MPS TEST_PRIVATEUSE TEST_ROCM Only linux platform mutual exclusive other backends torch testing _internal common_utils markDynamoStrictTest TestCppExtensionStreamAndEvent common TestCase Tests Stream Event C++ extensions module = None setUp super setUp cpp extensions use relative paths Those paths relative file so we ll change working directory temporarily old_working_dir = os getcwd os chdir os path dirname os path abspath __file__ tearDown super tearDown working directory see setUp os chdir old_working_dir classmethod tearDownClass cls torch testing _internal common_utils remove_cpp_extensions_build_root classmethod setUpClass cls torch testing _internal common_utils remove_cpp_extensions_build_root build_dir = tempfile mkdtemp Load fake device guard impl src = f os path abspath os path dirname __file__ cpp_extensions mtia_extension cpp cls module = torch utils cpp_extension load name= mtia_extension sources= src build_directory=build_dir extra_include_paths= cpp_extensions path spaces path quote is_python_module=False verbose=True skipIfTorchDynamo Not TorchDynamo suitable test test_stream_event s = torch Stream assertTrue s device_type int torch _C _autograd DeviceType MTIA e = torch Event enable_timing=True e = torch Event enable_timing=True e record assertTrue e device type mtia Should nullptr default assertTrue e event_id == s record_event event=e print f recorded event e assertTrue e event_id = The enable_timing event created record_event false e = s record_event print f recorded event e assertTrue e event_id = assertTrue e event_id = e event_id e synchronize e synchronize e synchronize time_elapsed = e elapsed_time e print f time elapsed between e e time_elapsed assertRaisesRegex ValueError Both events must created argument enable_timing=True time_elapsed = e elapsed_time e old_event_id = e event_id e record stream=s print f recorded event e assertTrue e event_id == old_event_id __name__ == __main__ common run_tests
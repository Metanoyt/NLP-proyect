unittest unittest mock unittest mock MagicMock docker errors derr cli lib common docker_helper _get_client local_image_exists TestDockerImageHelpers unittest TestCase setUp Reset singleton target module patcher = mock patch cli lib common docker_helper _docker_client None addCleanup patcher stop patcher start test_local_image_exists_true Mock docker client whose images get returns object no exception mock_client = MagicMock mock_client images get return_value = object ok = local_image_exists repo tag client=mock_client assertTrue ok test_local_image_exists_not_found_false mock_client = MagicMock Raise docker errors NotFound mock_client images get side_effect = derr NotFound nope ok = local_image_exists missing latest client=mock_client assertFalse ok test_local_image_exists_api_error_false mock_client = MagicMock mock_client images get side_effect = derr APIError boom None ok = local_image_exists broken tag client=mock_client assertFalse ok test_local_image_exists_uses_lazy_singleton Patch docker from_env used _get_client mock patch cli lib common docker_helper docker from_env mock_from_env mock_docker_client = MagicMock mock_from_env return_value = mock_docker_client First call should create cache client c = _get_client assertIs c mock_docker_client mock_from_env assert_called_once Second call should reuse cached client no extra from_env calls c = _get_client assertIs c mock_docker_client mock_from_env assert_called_once still once test_local_image_exists_without_client_param_calls_get_client_once Ensure _get_client called cached local_image_exists should reuse mock patch cli lib common docker_helper _get_client mock_get_client mock_client = MagicMock mock_get_client return_value = mock_client st call local_image_exists repo tag nd call local_image_exists repo tag local_image_exists should call _get_client each time your _get_client itself caches docker from_env assertEqual mock_get_client call_count assertEqual mock_client images get call_count mock_client images get assert_any_call repo tag mock_client images get assert_any_call repo tag __name__ == __main__ unittest main
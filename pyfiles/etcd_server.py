usr bin env python mypy allow-untyped-defs Copyright c Facebook Inc its affiliates All rights reserved This source code licensed under BSD-style license found LICENSE file root directory source tree atexit logging os shlex shutil socket subprocess tempfile time typing Optional TextIO Union try etcd type ignore except ModuleNotFoundError pass logger = logging getLogger __name__ find_free_port Find free port binds temporary socket so port can reserved until used note returned socket must closed before using port otherwise ` ` address already use ` ` error will happen The socket should held closed close consumer port possible since otherwise there greater chance race-condition where different process may see port being free take Returns socket binded reserved free port Usage sock = find_free_port port = sock getsockname sock close use_port port addrs = socket getaddrinfo host= localhost port=None family=socket AF_UNSPEC type=socket SOCK_STREAM addr addrs family type proto _ _ = addr try s = socket socket family type proto s bind localhost s listen s except OSError e s close type ignore possibly-undefined print f Socket creation attempt failed e raise RuntimeError Failed create socket stop_etcd subprocess data_dir Optional str = None subprocess subprocess poll None logger info stopping etcd server subprocess terminate subprocess wait data_dir logger info deleting etcd data dir s data_dir shutil rmtree data_dir ignore_errors=True EtcdServer note tested etcd server v Starts stops local standalone etcd server random free port Useful single node multi-worker launches testing where sidecar etcd server more convenient than having separately setup etcd server This registers termination handler shutdown etcd subprocess exit This termination handler NOT substitute calling ` ` stop ` ` method The following fallback mechanism used find etcd binary Uses env var TORCHELASTIC_ETCD_BINARY_PATH Uses ` ` file root bin etcd ` ` one exists Uses ` ` etcd ` ` ` ` PATH ` ` Usage server = EtcdServer usr bin etcd tmp default etcd server start client = server get_client use client server stop Args etcd_binary_path path etcd server binary see above fallback path __init__ data_dir Optional str = None _port = - _host = localhost root = os path dirname __file__ default_etcd_bin = os path join root bin etcd _etcd_binary_path = os environ get TORCHELASTIC_ETCD_BINARY_PATH default_etcd_bin os path isfile _etcd_binary_path _etcd_binary_path = etcd _base_data_dir = data_dir data_dir tempfile mkdtemp prefix= torchelastic_etcd_data _etcd_cmd = None _etcd_proc Optional subprocess Popen = None _get_etcd_server_process - subprocess Popen _etcd_proc raise RuntimeError No etcd server process started Call etcd_server start first _etcd_proc get_port - int Return port server running _port get_host - str Return host server running _host get_endpoint - str Return etcd server endpoint host port f _host _port start timeout int = num_retries int = stderr Union int TextIO None = None - None Start server waits ready When function returns sever ready take requests Args timeout time seconds wait server ready before giving up num_retries number retries start server Each retry will wait max ` ` timeout ` ` before considering failed stderr standard error file handle Valid values ` subprocess PIPE ` ` subprocess DEVNULL ` existing file descriptor positive integer existing file object ` None ` Raises TimeoutError server ready within specified timeout curr_retries = while True try data_dir = os path join _base_data_dir str curr_retries os makedirs data_dir exist_ok=True _start data_dir timeout stderr except Exception e curr_retries += stop_etcd _etcd_proc logger warning noqa G Failed start etcd server got error s retrying str e curr_retries = num_retries shutil rmtree _base_data_dir ignore_errors=True raise atexit register stop_etcd _etcd_proc _base_data_dir _start data_dir str timeout int = stderr Union int TextIO None = None - None sock = find_free_port sock_peer = find_free_port _port = sock getsockname peer_port = sock_peer getsockname etcd_cmd = shlex split join _etcd_binary_path -- enable-v -- data-dir data_dir -- listen-client-urls f http _host _port -- advertise-client-urls f http _host _port -- listen-peer-urls f http _host peer_port logger info Starting etcd server s etcd_cmd sock close sock_peer close _etcd_proc = subprocess Popen etcd_cmd close_fds=True stderr=stderr _wait_for_ready timeout get_client Return etcd client object can used make requests server etcd Client host=self _host port=self _port version_prefix= v read_timeout= _wait_for_ready timeout int = - None client = etcd Client host=f _host port=self _port version_prefix= v read_timeout= max_time = time time + timeout while time time max_time _get_etcd_server_process poll None etcd server process finished exitcode = _get_etcd_server_process returncode raise RuntimeError f Etcd server process exited code exitcode try logger info etcd server ready version s client version except Exception time sleep raise TimeoutError Timed out waiting etcd server ready stop - None Stop server cleans up auto generated resources e g data dir logger info EtcdServer stop method called stop_etcd _etcd_proc _base_data_dir
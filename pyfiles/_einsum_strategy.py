itertools dataclasses dataclass torch distributed device_mesh DeviceMesh torch distributed tensor _dtensor_spec DTensorSpec torch distributed tensor _op_schema OpSpec OpStrategy torch distributed tensor placement_types Partial Placement Replicate Shard dataclass EinsumDims contracting_dims list str batch_dims list str lhs_out_only_dims list str rhs_out_only_dims list str classmethod parse_equation cls equation str - tuple list str str parse einop equation extract arg specs Parse einsum equation str input dim chars output dim char inputs outputs = equation split - input_dims output_dims = inputs split outputs split NOTE only support most two inputs single output extend support more inputs needed future assert len input_dims = Only support most two inputs assert len output_dims == Only support single output output_dim = output_dims input_dims output_dim classmethod parse_dims cls input_dims list str output_dim str - EinsumDims Parse dims extract contracting batch free dimensions left right hand sides dim_char_set set str = set input_dim input_dims dim_char_set update input_dim get deterministic order all dim chars all_dim_chars = sorted dim_char_set parse input output dimensions lhs_out_only_dims rhs_out_only_dims = batch_dims contracting_dims = dim_char all_dim_chars dim_char output_dim contracting_dims append dim_char is_batch_dim = True input_dim input_dims is_batch_dim = is_batch_dim dim_char input_dim is_batch_dim batch_dims append dim_char assert len input_dims == free dimension only supported two inputs lhs rhs = input_dims dim_char lhs lhs_out_only_dims append dim_char dim_char rhs rhs_out_only_dims append dim_char raise RuntimeError Invalid dimension character cls contracting_dims=contracting_dims batch_dims=batch_dims lhs_out_only_dims=lhs_out_only_dims rhs_out_only_dims=rhs_out_only_dims gen_einsum_strategies equation str mesh DeviceMesh linearity bool = False - OpStrategy Generate strategy list ops follow einsum style notation In principle each mesh dim independent other device mesh dim when we generate strategies So we generate strategy over each device mesh dim do product combination all mesh dims We basically follow below rule each device mesh dim Shard contracting dim When both inputs shard contracting dim over same device dim The result will Partial over device dim Shard noncontracting dim Shard batch dim output both inputs all should shard batch dim Shard lhs only dim rhs only dim both output lhs rhs input should shard free dim Linearity Partial If enabled set Partial output inputs over same device mesh dim parse einop equation extract dims input_dims output_dim = EinsumDims parse_equation equation edims = EinsumDims parse_dims input_dims output_dim all_mesh_dim_strategies = generate strategies each mesh dim do cartesian product final strategy E g D mesh we can have P R R strategies_over_one_mesh_dim = placement list stores placements output input input first we always have replicate all inputs output placement_list list Placement = Replicate len input_dims + strategies_over_one_mesh_dim append placement_list split batch dim batch_dim edims batch_dims output_batch_dim = output_dim index batch_dim placement_list = Shard output_batch_dim input_dim input_dims input_batch_dim = input_dim index batch_dim placement_list append Shard input_batch_dim strategies_over_one_mesh_dim append placement_list split contracting dim contracting_dim edims contracting_dims Contracting dim can shard same device axis both inputs This results output being Partial device axis For example bmk_ x k_ x n - bmn Ux becomes partial over device axis x placement_list = Partial input_dim input_dims input_contracting_dim = input_dim index contracting_dim placement_list append Shard input_contracting_dim strategies_over_one_mesh_dim append placement_list split lhs free dim lhs_dim edims lhs_out_only_dims lhs_free_dim_output = output_dim index lhs_dim lhs_free_dim_input = input_dims index lhs_dim means split lhs input output i e S R - S lhs_placement_list list Placement = Shard lhs_free_dim_output Shard lhs_free_dim_input Replicate strategies_over_one_mesh_dim append lhs_placement_list split rhs free dim rhs_dim edims rhs_out_only_dims rhs_free_dim_output = output_dim index rhs_dim rhs_free_dim_input = input_dims index rhs_dim rhs_placement_list list Placement = Shard rhs_free_dim_output Replicate Shard rhs_free_dim_input strategies_over_one_mesh_dim append rhs_placement_list linearity strategy linearity linearity_placement_list list Placement = Partial _ input_dims linearity_placement_list append Partial strategies_over_one_mesh_dim append linearity_placement_list generate strategies entire mesh all_mesh_dim_strategies = strategies_over_one_mesh_dim mesh ndim strategy_combs = itertools product all_mesh_dim_strategies all_strategies = strategy_comb strategy_combs spec_list = DTensorSpec mesh tuple specs specs zip strategy_comb strat = OpSpec output_specs=spec_list input_specs=spec_list all_strategies append strat OpStrategy all_strategies
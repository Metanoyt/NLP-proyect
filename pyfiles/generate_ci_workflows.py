usr bin env python os sys collections abc Iterable dataclasses asdict dataclass field pathlib Path typing Literal typing_extensions TypedDict Python + generate_binary_build_matrix type ignore jinja Arch = Literal windows linux macos GITHUB_DIR = Path __file__ resolve parent parent LABEL_CIFLOW_TRUNK = ciflow trunk LABEL_CIFLOW_UNSTABLE = ciflow unstable LABEL_CIFLOW_BINARIES = ciflow binaries LABEL_CIFLOW_PERIODIC = ciflow periodic LABEL_CIFLOW_BINARIES_LIBTORCH = ciflow binaries_libtorch LABEL_CIFLOW_BINARIES_WHEEL = ciflow binaries_wheel LABEL_CIFLOW_ROCM = ciflow rocm dataclass CIFlowConfig For use enable workflows run pytorch pytorch-canary run_on_canary bool = False labels set str = field default_factory=set Certain jobs might want part ciflow all trunk workflow isolated_workflow bool = False unstable bool = False __post_init__ - None isolated_workflow LABEL_CIFLOW_PERIODIC labels labels add LABEL_CIFLOW_TRUNK unstable LABEL_CIFLOW_UNSTABLE Config TypedDict num_shards int runner str dataclass BinaryBuildWorkflow os str build_configs list dict str str package_type str Optional fields build_environment str = ciflow_config CIFlowConfig = field default_factory=CIFlowConfig is_scheduled str = branches str = nightly Mainly macos macos_runner str = macos- -xlarge Mainly used libtorch builds build_variant str = __post_init__ - None build_environment == build_environment = - join item item os binary package_type build_variant item = generate_workflow_file workflow_template jinja Template - None output_file_path = GITHUB_DIR f workflows generated- build_environment - branches yml open output_file_path w output_file GENERATED = generated Note please keep variable GENERATED otherwise phabricator will hide whole file output_file writelines f GENERATED DO NOT EDIT MANUALLY\n try content = workflow_template render asdict except Exception e print f Failed template workflow_template file=sys stderr raise e output_file write content content - = \n output_file write \n print output_file_path OperatingSystem LINUX = linux WINDOWS = windows WINDOWS_ARM = windows-arm MACOS = macos MACOS_ARM = macos-arm LINUX_AARCH = linux-aarch LINUX_S X = linux-s x LINUX_BINARY_BUILD_WORFKLOWS = BinaryBuildWorkflow os=OperatingSystem LINUX package_type= manywheel build_configs=generate_binary_build_matrix generate_wheels_matrix OperatingSystem LINUX ciflow_config=CIFlowConfig labels= LABEL_CIFLOW_BINARIES LABEL_CIFLOW_BINARIES_WHEEL isolated_workflow=True BinaryBuildWorkflow os=OperatingSystem LINUX package_type= libtorch build_configs=generate_binary_build_matrix generate_libtorch_matrix OperatingSystem LINUX generate_binary_build_matrix RELEASE libtorch_variants= shared-with-deps ciflow_config=CIFlowConfig labels= LABEL_CIFLOW_BINARIES LABEL_CIFLOW_BINARIES_LIBTORCH isolated_workflow=True WINDOWS_BINARY_BUILD_WORKFLOWS = BinaryBuildWorkflow os=OperatingSystem WINDOWS package_type= wheel build_configs=generate_binary_build_matrix generate_wheels_matrix OperatingSystem WINDOWS ciflow_config=CIFlowConfig labels= LABEL_CIFLOW_BINARIES LABEL_CIFLOW_BINARIES_WHEEL isolated_workflow=True BinaryBuildWorkflow os=OperatingSystem WINDOWS package_type= libtorch build_variant=generate_binary_build_matrix RELEASE build_configs=generate_binary_build_matrix generate_libtorch_matrix OperatingSystem WINDOWS generate_binary_build_matrix RELEASE libtorch_variants= shared-with-deps ciflow_config=CIFlowConfig labels= LABEL_CIFLOW_BINARIES LABEL_CIFLOW_BINARIES_LIBTORCH isolated_workflow=True BinaryBuildWorkflow os=OperatingSystem WINDOWS package_type= libtorch build_variant=generate_binary_build_matrix DEBUG build_configs=generate_binary_build_matrix generate_libtorch_matrix OperatingSystem WINDOWS generate_binary_build_matrix DEBUG libtorch_variants= shared-with-deps ciflow_config=CIFlowConfig labels= LABEL_CIFLOW_BINARIES LABEL_CIFLOW_BINARIES_LIBTORCH isolated_workflow=True BinaryBuildWorkflow os=OperatingSystem WINDOWS_ARM package_type= wheel build_configs=generate_binary_build_matrix generate_wheels_matrix OperatingSystem WINDOWS_ARM arches= cpu python_versions= ciflow_config=CIFlowConfig labels= LABEL_CIFLOW_BINARIES LABEL_CIFLOW_BINARIES_WHEEL isolated_workflow=True BinaryBuildWorkflow os=OperatingSystem WINDOWS_ARM package_type= libtorch build_variant=generate_binary_build_matrix RELEASE build_configs=generate_binary_build_matrix generate_libtorch_matrix OperatingSystem WINDOWS_ARM generate_binary_build_matrix RELEASE arches= cpu libtorch_variants= shared-with-deps ciflow_config=CIFlowConfig labels= LABEL_CIFLOW_BINARIES LABEL_CIFLOW_BINARIES_LIBTORCH isolated_workflow=True BinaryBuildWorkflow os=OperatingSystem WINDOWS_ARM package_type= libtorch build_variant=generate_binary_build_matrix DEBUG build_configs=generate_binary_build_matrix generate_libtorch_matrix OperatingSystem WINDOWS_ARM generate_binary_build_matrix DEBUG arches= cpu libtorch_variants= shared-with-deps ciflow_config=CIFlowConfig labels= LABEL_CIFLOW_BINARIES LABEL_CIFLOW_BINARIES_LIBTORCH isolated_workflow=True MACOS_BINARY_BUILD_WORKFLOWS = BinaryBuildWorkflow os=OperatingSystem MACOS_ARM package_type= libtorch build_variant=generate_binary_build_matrix RELEASE build_configs=generate_binary_build_matrix generate_libtorch_matrix OperatingSystem MACOS generate_binary_build_matrix RELEASE libtorch_variants= shared-with-deps macos_runner= macos- -xlarge ciflow_config=CIFlowConfig labels= LABEL_CIFLOW_BINARIES LABEL_CIFLOW_BINARIES_LIBTORCH isolated_workflow=True BinaryBuildWorkflow os=OperatingSystem MACOS_ARM package_type= wheel build_configs=generate_binary_build_matrix generate_wheels_matrix OperatingSystem MACOS_ARM macos_runner= macos- -xlarge ciflow_config=CIFlowConfig labels= LABEL_CIFLOW_BINARIES LABEL_CIFLOW_BINARIES_WHEEL isolated_workflow=True AARCH _BINARY_BUILD_WORKFLOWS = BinaryBuildWorkflow os=OperatingSystem LINUX_AARCH package_type= manywheel build_configs=generate_binary_build_matrix generate_wheels_matrix OperatingSystem LINUX_AARCH ciflow_config=CIFlowConfig labels= LABEL_CIFLOW_BINARIES LABEL_CIFLOW_BINARIES_WHEEL isolated_workflow=True S X_BINARY_BUILD_WORKFLOWS = BinaryBuildWorkflow os=OperatingSystem LINUX_S X package_type= manywheel build_configs=generate_binary_build_matrix generate_wheels_matrix OperatingSystem LINUX_S X ciflow_config=CIFlowConfig labels= LABEL_CIFLOW_BINARIES LABEL_CIFLOW_BINARIES_WHEEL isolated_workflow=True main - None jinja_env = jinja Environment variable_start_string= loader=jinja FileSystemLoader str GITHUB_DIR joinpath templates undefined=jinja StrictUndefined ported yet template_and_workflows = jinja_env get_template linux_binary_build_workflow yml j LINUX_BINARY_BUILD_WORFKLOWS jinja_env get_template linux_binary_build_workflow yml j AARCH _BINARY_BUILD_WORKFLOWS jinja_env get_template linux_binary_build_workflow yml j S X_BINARY_BUILD_WORKFLOWS jinja_env get_template windows_binary_build_workflow yml j WINDOWS_BINARY_BUILD_WORKFLOWS jinja_env get_template macos_binary_build_workflow yml j MACOS_BINARY_BUILD_WORKFLOWS Delete existing generated files first should align gitattributes file description existing_workflows = GITHUB_DIR glob workflows generated- w existing_workflows try os remove w except Exception e print f Error occurred when deleting file w e template workflows template_and_workflows added Iterable check appease mypy gods isinstance workflows Iterable raise Exception noqa TRY f How workflows iterable workflows noqa TRY workflow workflows workflow generate_workflow_file workflow_template=template __name__ == __main__ main
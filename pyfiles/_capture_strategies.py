Strategies capturing ExportedPrograms mypy allow-untyped-defs __future__ annotations abc contextlib dataclasses datetime logging pathlib typing Any TYPE_CHECKING torch torch onnx _flags TYPE_CHECKING os collections abc Callable logger = logging getLogger __name__ _verbose_printer verbose bool &#124; None - Callable None Prints messages based ` verbose ` verbose False lambda _ __ None pyrefly ignore not-iterable lambda args kwargs print torch onnx args kwargs _take_first_line text str - str Take first line text lines = text split \n maxsplit= first_line = lines len lines first_line += first_line contextlib contextmanager _patch_dynamo_unsupported_functions Patch PyTorch bypass some functions torch export export does support TODO Remove patches once dynamo supports these functions torch jit Replace torch jit isinstance isinstance jit_isinstance = torch jit isinstance pyrefly ignore bad-assignment torch jit isinstance = isinstance logger info Replaced torch jit isinstance isinstance allow dynamo tracing try yield finally torch jit isinstance = jit_isinstance dataclasses dataclass Result exported_program torch export ExportedProgram &#124; None strategy str exception Exception &#124; None = None property success - bool Whether capture successful An exception can still recorded even capture successful In case exception informational only For example draft_export can record exception there warnings during export The exceptions will go into onnx export report when report=True exported_program None CaptureStrategy abc ABC Strategy capturing module ExportedProgram To use strategy create instance call model args kwargs dynamic_shapes Example strategy = TorchExportNonStrictStrategy verbose=True result = strategy model args kwargs dynamic_shapes __init__ verbose bool = False dump bool = False artifacts_dir str &#124; os PathLike = timestamp str &#124; None = None Initialize strategy Args verbose Whether print verbose messages dump Whether dump intermediate artifacts file _verbose_print = _verbose_printer verbose _dump = dump _artifacts_dir = pathlib Path artifacts_dir _timestamp = timestamp datetime datetime now strftime Y- m- d_ H- M- S- f _exception Exception &#124; None = None __call__ model torch nn Module &#124; torch jit ScriptFunction args tuple Any kwargs dict str Any &#124; None dynamic_shapes - Result _enter model kwargs None kwargs = try exported_program = _capture model args kwargs dynamic_shapes except Exception e _failure model e Result exported_program=None strategy=self __class__ __name__ exception=e _success model Result exported_program strategy=self __class__ __name__ exception=self _exception abc abstractmethod _capture model args kwargs dynamic_shapes - torch export ExportedProgram raise NotImplementedError _enter model torch nn Module &#124; torch jit ScriptFunction - None _success model torch nn Module &#124; torch jit ScriptFunction - None _failure model torch nn Module &#124; torch jit ScriptFunction e Exception - None TorchExportStrictStrategy CaptureStrategy _capture model args kwargs dynamic_shapes - torch export ExportedProgram _patch_dynamo_unsupported_functions Support dynamism input dim torch fx experimental _config patch backed_size_oblivious=True type ignore attr-defined try torch export export model args kwargs=kwargs dynamic_shapes=dynamic_shapes strict=True prefer_deferred_runtime_asserts_over_guards=_flags PREFER_DEFERRED_RUNTIME_ASSERTS_OVER_GUARDS except torch _dynamo exc UserError exc Refine dynamic shapes based suggested fixes try new_shapes = torch export dynamic_shapes refine_dynamic_shapes_from_suggested_fixes exc msg dynamic_shapes except Exception If dynamic shapes cannot refined re-raise exception raise exc None torch export export model args kwargs=kwargs dynamic_shapes=new_shapes strict=True prefer_deferred_runtime_asserts_over_guards=_flags PREFER_DEFERRED_RUNTIME_ASSERTS_OVER_GUARDS _enter model - None model_repr = _take_first_line repr model _verbose_print f Obtain model graph ` model_repr ` ` torch export export strict=True ` _success model - None model_repr = _take_first_line repr model _verbose_print f Obtain model graph ` model_repr ` ` torch export export strict=True ` ✅ _failure model e - None del e Unused model_repr = _take_first_line repr model _verbose_print f Obtain model graph ` model_repr ` ` torch export export strict=True ` ❌ TorchExportNonStrictStrategy CaptureStrategy _capture model args kwargs dynamic_shapes - torch export ExportedProgram Support dynamism input dim torch fx experimental _config patch backed_size_oblivious=True type ignore attr-defined try torch export export model args kwargs=kwargs dynamic_shapes=dynamic_shapes strict=False prefer_deferred_runtime_asserts_over_guards=_flags PREFER_DEFERRED_RUNTIME_ASSERTS_OVER_GUARDS except torch _dynamo exc UserError exc Refine dynamic shapes based suggested fixes try new_shapes = torch export dynamic_shapes refine_dynamic_shapes_from_suggested_fixes exc msg dynamic_shapes except Exception If dynamic shapes cannot refined re-raise exception raise exc None torch export export model args kwargs=kwargs dynamic_shapes=new_shapes strict=False prefer_deferred_runtime_asserts_over_guards=_flags PREFER_DEFERRED_RUNTIME_ASSERTS_OVER_GUARDS _enter model - None model_repr = _take_first_line repr model _verbose_print f Obtain model graph ` model_repr ` ` torch export export strict=False ` _success model - None model_repr = _take_first_line repr model _verbose_print f Obtain model graph ` model_repr ` ` torch export export strict=False ` ✅ _failure model e - None del e Unused model_repr = _take_first_line repr model _verbose_print f Obtain model graph ` model_repr ` ` torch export export strict=False ` ❌ TorchExportDraftExportStrategy CaptureStrategy _capture model args kwargs dynamic_shapes - torch export ExportedProgram ep = torch export draft_export model args kwargs=kwargs dynamic_shapes=dynamic_shapes report = ep _report type ignore attr-defined report successful _exception = RuntimeError str report _verbose_print f Draft Export report \n report ep _enter model - None model_repr = _take_first_line repr model _verbose_print f Obtain model graph ` model_repr ` ` torch export draft_export ` _success model - None model_repr = _take_first_line repr model _verbose_print f Obtain model graph ` model_repr ` ` torch export draft_export ` ✅ _failure model e - None del e Unused model_repr = _take_first_line repr model _verbose_print f Obtain model graph ` model_repr ` ` torch export draft_export ` ❌ CAPTURE_STRATEGIES tuple type CaptureStrategy = TorchExportNonStrictStrategy strict=False preferred over strict=True because does have dynamo issues TorchExportStrictStrategy _flags ENABLE_DRAFT_EXPORT CAPTURE_STRATEGIES = CAPTURE_STRATEGIES TorchExportDraftExportStrategy
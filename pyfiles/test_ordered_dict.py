======= BEGIN Dynamo patch ======= Owner s module dynamo ruff noqa flake noqa Test copied https raw githubusercontent com python cpython refs tags v Lib test test_ordered_dict py sys torch torch _dynamo test_case unittest torch _dynamo test_case CPythonTestCase torch testing _internal common_utils run_tests xfailIfTorchDynamo __TestCase = CPythonTestCase redirect statements sys importlib abc redirect_imports = test mapping_tests test typinganndata test test_grammar test test_math test test_iter test typinganndata ann_module RedirectImportFinder importlib abc MetaPathFinder find_spec fullname path target=None Check problematic one fullname redirect_imports try Attempt standalone module name = fullname removeprefix test r = importlib import_module name Redirect module sys modules sys modules fullname = r Return module spec found module importlib util find_spec name except ImportError None None Add custom finder sys meta_path sys meta_path insert RedirectImportFinder ======= END DYNAMO PATCH ======= builtins contextlib copy gc operator pickle re random randrange shuffle struct sys unittest weakref collections abc MutableMapping test mapping_tests support test support import_helper suppress_immortalization py_coll = import_helper import_fresh_module collections blocked= _collections c_coll = import_helper import_fresh_module collections fresh= _collections contextlib contextmanager replaced_module name replacement original_module = sys modules name sys modules name = replacement try yield finally sys modules name = original_module OrderedDictTests test_init OrderedDict = OrderedDict assertRaises TypeError OrderedDict b None too many args pairs = b c d e assertEqual sorted OrderedDict dict pairs items pairs dict input assertEqual sorted OrderedDict dict pairs items pairs kwds input assertEqual list OrderedDict pairs items pairs pairs input assertEqual list OrderedDict b c d c= e= items pairs mixed input make sure no positional args conflict possible kwdargs assertEqual list OrderedDict self= items assertEqual list OrderedDict other= items other assertRaises TypeError OrderedDict assertRaises TypeError OrderedDict assertRaises TypeError OrderedDict __init__ Make sure direct calls __init__ do clear previous contents d = OrderedDict b c d e d __init__ e f g= d= assertEqual list d items b c d e f g test_ OrderedDict = OrderedDict items = b c d e f g shuffle items argdict = OrderedDict items d = OrderedDict argdict assertEqual list d items items test_update OrderedDict = OrderedDict assertRaises TypeError OrderedDict update b None too many args pairs = b c d e od = OrderedDict od update dict pairs assertEqual sorted od items pairs dict input od = OrderedDict od update dict pairs assertEqual sorted od items pairs kwds input od = OrderedDict od update pairs assertEqual list od items pairs pairs input od = OrderedDict od update b c d c= e= assertEqual list od items pairs mixed input Issue Named argument called other shouldn t treated specially od = OrderedDict od update self= assertEqual list od items od = OrderedDict od update other= assertEqual list od items other od = OrderedDict od update red= blue= other= self= assertEqual sorted list od items blue other red Make sure direct calls update do clear previous contents add updates items moved end d = OrderedDict b c d e d update e f g= d= assertEqual list d items b c d e f g assertRaises TypeError OrderedDict update assertRaises TypeError OrderedDict update assertRaises TypeError OrderedDict update assertRaises TypeError OrderedDict update assertRaises TypeError OrderedDict update assertRaises TypeError OrderedDict update test_init_calls calls = torch _dynamo error_on_graph_break False Spam keys calls append keys items calls append items OrderedDict Spam assertEqual calls keys test_overridden_init Sync-up pure Python OD C where consistent internal state created __new__ rather than __init__ OrderedDict = OrderedDict torch _dynamo error_on_graph_break False ODNI OrderedDict __init__ args kwargs pass od = ODNI od = This used fail because __init__ bypassed test_fromkeys OrderedDict = OrderedDict od = OrderedDict fromkeys abc assertEqual list od items c None c abc od = OrderedDict fromkeys abc value=None assertEqual list od items c None c abc od = OrderedDict fromkeys abc value= assertEqual list od items c c abc test_abc OrderedDict = OrderedDict assertIsInstance OrderedDict MutableMapping assertTrue issubclass OrderedDict MutableMapping test_clear OrderedDict = OrderedDict pairs = c b d e f shuffle pairs od = OrderedDict pairs assertEqual len od len pairs od clear assertEqual len od test_delitem OrderedDict = OrderedDict pairs = c b d e f od = OrderedDict pairs del od assertNotIn od assertRaises KeyError del od assertEqual list od items pairs + pairs test_setitem OrderedDict = OrderedDict od = OrderedDict d b c e od c = existing element od f = new element assertEqual list od items d b c e f test_iterators OrderedDict = OrderedDict pairs = c b d e f shuffle pairs od = OrderedDict pairs assertEqual list od t t pairs assertEqual list od keys t t pairs assertEqual list od values t t pairs assertEqual list od items pairs assertEqual list reversed od t t reversed pairs assertEqual list reversed od keys t t reversed pairs assertEqual list reversed od values t t reversed pairs assertEqual list reversed od items list reversed pairs test_detect_deletion_during_iteration OrderedDict = OrderedDict od = OrderedDict fromkeys abc = iter od key = next del od key assertRaises Exception Note exact exception raised guaranteed The only guarantee next will succeed next test_sorted_iterators OrderedDict = OrderedDict assertRaises TypeError OrderedDict b None pairs = b c d e od = OrderedDict pairs assertEqual sorted od t t pairs assertEqual sorted od keys t t pairs assertEqual sorted od values t t pairs assertEqual sorted od items pairs assertEqual sorted reversed od sorted t t reversed pairs test_iterators_empty OrderedDict = OrderedDict od = OrderedDict empty = assertEqual list od empty assertEqual list od keys empty assertEqual list od values empty assertEqual list od items empty assertEqual list reversed od empty assertEqual list reversed od keys empty assertEqual list reversed od values empty assertEqual list reversed od items empty test_popitem OrderedDict = OrderedDict pairs = c b d e f shuffle pairs od = OrderedDict pairs while pairs assertEqual od popitem pairs pop assertRaises KeyError od popitem assertEqual len od test_popitem_last OrderedDict = OrderedDict pairs = i i i range obj = OrderedDict pairs i range obj popitem True obj popitem True obj popitem last=True assertEqual len obj test_pop OrderedDict = OrderedDict pairs = c b d e f shuffle pairs od = OrderedDict pairs shuffle pairs while pairs k v = pairs pop assertEqual od pop k v assertRaises KeyError od pop xyz assertEqual len od assertEqual od pop k make sure pop still works when __missing__ defined torch _dynamo error_on_graph_break False Missing OrderedDict __missing__ key m = Missing a= assertEqual m pop b assertEqual m pop assertEqual m pop assertEqual m pop default= assertRaises KeyError m pop test_equality OrderedDict = OrderedDict pairs = c b d e f shuffle pairs od = OrderedDict pairs od = OrderedDict pairs assertEqual od od same order implies equality pairs = pairs + pairs od = OrderedDict pairs assertNotEqual od od different order implies inequality comparison regular dict order sensitive assertEqual od dict od assertEqual dict od od different length implied inequality assertNotEqual od OrderedDict pairs - test_copying OrderedDict = OrderedDict Check ordered dicts copyable deepcopyable picklable have repr eval round-trip pairs = c b d e f od = OrderedDict pairs od x = x od z = z check dup msg = \ncopy s\nod s dup od assertIsNot dup od msg assertEqual dup od assertEqual list dup items list od items assertEqual len dup len od assertEqual type dup type od check od copy dup = copy copy od check dup assertIs dup x od x assertIs dup z od z assertFalse hasattr dup y dup = copy deepcopy od check dup assertEqual dup x od x assertIsNot dup x od x assertEqual dup z od z assertIsNot dup z od z assertFalse hasattr dup y pickle directly pulls module so we have fake replaced_module collections module proto range pickle HIGHEST_PROTOCOL + subTest proto=proto dup = pickle loads pickle dumps od proto check dup assertEqual dup x od x assertEqual dup z od z assertFalse hasattr dup y check eval repr od update_test = OrderedDict update_test update od check update_test check OrderedDict od test_yaml_linkage OrderedDict = OrderedDict Verify __reduce__ setup way supports PyYAML s dump feature In yaml lists native tuples pairs = c b d e f od = OrderedDict pairs yaml dump od -- python object apply __main__ OrderedDict\n- - \n - b \n assertTrue all type pair ==list pair od __reduce__ test_reduce_not_too_fat OrderedDict = OrderedDict do save instance dictionary needed pairs = c b d e f od = OrderedDict pairs assertIsInstance od __dict__ dict assertIsNone od __reduce__ od x = assertEqual od __dict__ x assertEqual od __reduce__ x test_pickle_recursive OrderedDict = OrderedDict od = OrderedDict od = od pickle directly pulls module so we have fake replaced_module collections module proto range - pickle HIGHEST_PROTOCOL + dup = pickle loads pickle dumps od proto assertIsNot dup od assertEqual list dup keys assertIs dup dup test_repr OrderedDict = OrderedDict od = OrderedDict c b d e f assertEqual repr od OrderedDict c b d e f assertEqual eval repr od od assertEqual repr OrderedDict OrderedDict test_repr_recursive OrderedDict = OrderedDict See issue od = OrderedDict fromkeys abc od x = od assertEqual repr od OrderedDict None b None c None x test_repr_recursive_values OrderedDict = OrderedDict od = OrderedDict od = od values r = repr od Cannot perform stronger test contents repr implementation-dependent All we can say we want str result exception any sort assertIsInstance r str od = od items r = repr od Again assertIsInstance r str test_setdefault OrderedDict = OrderedDict pairs = c b d e f shuffle pairs od = OrderedDict pairs pair_order = list od items assertEqual od setdefault make sure order didn t change assertEqual list od items pair_order assertEqual od setdefault x make sure x added end assertEqual list od items - x assertEqual od setdefault g default= make sure setdefault still works when __missing__ defined torch _dynamo error_on_graph_break False Missing OrderedDict __missing__ key assertEqual Missing setdefault test_reinsert OrderedDict = OrderedDict Given insert insert b delete re-insert verify now later than b od = OrderedDict od = od b = del od assertEqual list od items b od = assertEqual list od items b test_move_to_end OrderedDict = OrderedDict od = OrderedDict fromkeys abcde assertEqual list od list abcde od move_to_end c assertEqual list od list abdec od move_to_end c False assertEqual list od list cabde od move_to_end c False assertEqual list od list cabde od move_to_end e assertEqual list od list cabde od move_to_end b last=False assertEqual list od list bcade assertRaises KeyError od move_to_end x assertRaises KeyError od move_to_end x False test_move_to_end_issue OrderedDict = OrderedDict od = OrderedDict fromkeys abc od move_to_end c last=False assertEqual list od list cab od move_to_end last=False assertEqual list od list acb od = OrderedDict fromkeys abc od move_to_end assertEqual list od list bca od move_to_end c assertEqual list od list bac test_sizeof OrderedDict = OrderedDict Wimpy test Just verify reported size larger than regular dict d = dict a= od = OrderedDict d assertGreater sys getsizeof od sys getsizeof d test_views OrderedDict = OrderedDict See http bugs python org issue s = quick brown fox jumped over lazy dog yesterday before dawn split od = OrderedDict fromkeys s assertEqual od keys dict od keys assertEqual od items dict od items test_override_update OrderedDict = OrderedDict Verify subclasses can override update without breaking __init__ torch _dynamo error_on_graph_break False MyOD OrderedDict update args kwds raise Exception items = c b assertEqual list MyOD items items items test_highly_nested Issues test trashcan mechanism works correctly OrderedDict deleting highly nested OrderDict should crash Python OrderedDict = OrderedDict obj = None _ range obj = OrderedDict None obj del obj support gc_collect test_highly_nested_subclass Issues test trashcan mechanism works correctly OrderedDict deleting highly nested OrderDict should crash Python OrderedDict = OrderedDict deleted = torch _dynamo error_on_graph_break False MyOD OrderedDict __del__ deleted append i obj = None i range obj = MyOD None obj obj i = i del obj support gc_collect assertEqual deleted list reversed range test_delitem_hash_collision OrderedDict = OrderedDict torch _dynamo error_on_graph_break False Key __init__ hash _hash = hash value = str id __hash__ _hash __eq__ other try value == other value except AttributeError False __repr__ value blocking_hash hash See collision-handling lookdict Objects dictobject c MINSIZE = i = hash MINSIZE- i + i + hash + COLLIDING = key = Key COLLIDING colliding = Key COLLIDING blocking = Key blocking_hash COLLIDING od = OrderedDict od key = od blocking = od colliding = od after = del od blocking del od colliding assertEqual list od items key after test_issue OrderedDict = OrderedDict torch _dynamo error_on_graph_break False Key __hash__ randrange od = OrderedDict i range key = Key od key = i These should crash assertRaises KeyError list od values assertRaises KeyError list od items assertRaises KeyError repr od assertRaises KeyError od copy test_issue OrderedDict = OrderedDict torch _dynamo error_on_graph_break False Key __hash__ od = OrderedDict od Key = This should crash od popitem test_issue dict resizes after certain number insertion operations whether there deletions freed up slots hash table During fast node lookup OrderedDict must correctly respond all resizes even current size same old one We verify here forcing dict resize sparse odict then perform operation should trigger odict resize e g popitem One key aspect here we will keep size odict same each popitem call This verifies we handled dict resize properly OrderedDict = OrderedDict od = OrderedDict c ABCDEF c ABCDEF len od == This should raise KeyError od popitem last=False key = c + c od key = key Direct use dict methods test_dict_setitem OrderedDict = OrderedDict od = OrderedDict dict __setitem__ od spam assertNotIn NULL repr od test_dict_delitem OrderedDict = OrderedDict od = OrderedDict od spam = od ham = dict __delitem__ od spam assertRaises KeyError repr od test_dict_clear OrderedDict = OrderedDict od = OrderedDict od spam = od ham = dict clear od assertNotIn NULL repr od test_dict_pop OrderedDict = OrderedDict od = OrderedDict od spam = od ham = dict pop od spam assertRaises KeyError repr od test_dict_popitem OrderedDict = OrderedDict od = OrderedDict od spam = od ham = dict popitem od assertRaises KeyError repr od test_dict_setdefault OrderedDict = OrderedDict od = OrderedDict dict setdefault od spam assertNotIn NULL repr od test_dict_update OrderedDict = OrderedDict od = OrderedDict dict update od spam assertNotIn NULL repr od suppress_immortalization test_reference_loop Issue OrderedDict = OrderedDict A od = OrderedDict A od A = None r = weakref ref A del A gc collect assertIsNone r test_free_after_iterating support check_free_after_iterating iter OrderedDict support check_free_after_iterating lambda d iter d keys OrderedDict support check_free_after_iterating lambda d iter d values OrderedDict support check_free_after_iterating lambda d iter d items OrderedDict test_merge_operator OrderedDict = OrderedDict = OrderedDict b = OrderedDict c = copy d = copy c &#124; = b d &#124; = list b items expected = OrderedDict assertEqual &#124; dict b expected assertEqual &#124; b expected assertEqual c expected assertEqual d expected c = b copy c &#124; = expected = OrderedDict assertEqual dict b &#124; expected assertEqual b &#124; expected assertEqual c expected assertIs type &#124; b OrderedDict assertIs type dict &#124; b OrderedDict assertIs type &#124; dict b OrderedDict expected = copy &#124; = &#124; = assertEqual expected assertRaises TypeError &#124; None assertRaises TypeError &#124; assertRaises TypeError &#124; BAD assertRaises TypeError &#124; assertRaises ValueError &#124; = BAD support cpython_only test_ordered_dict_items_result_gc bpo- OrderedDict items s tuple-reuse speed trick breaks GC s assumptions about what can untracked Make sure we re-track result tuples whenever we reuse them = iter OrderedDict None items gc collect That GC collection probably untracked recycled internal result tuple which initialized None None Make sure s re-tracked when s mutated returned __next__ assertTrue gc is_tracked next _TriggerSideEffectOnEqual count = number calls __eq__ trigger = count value when trigger side effect __eq__ other __class__ count == __class__ trigger side_effect __class__ count += True __hash__ all instances represent same key - side_effect raise NotImplementedError PurePythonOrderedDictTests OrderedDictTests __TestCase module = py_coll OrderedDict = py_coll OrderedDict test_issue _attribute_error torch _dynamo error_on_graph_break False Key _TriggerSideEffectOnEqual side_effect del dict TODEL TODEL = Key dict = OrderedDict dict fromkeys TODEL dict = OrderedDict dict fromkeys Key This causes AttributeError due linked list being changed msg = re escape NoneType object has no attribute key assertRaisesRegex AttributeError msg operator eq dict dict assertEqual Key count assertDictEqual dict dict fromkeys assertDictEqual dict dict fromkeys Key CPythonBuiltinDictTests __TestCase Builtin dict preserves insertion order Reuse some tests OrderedDict selectively module = builtins OrderedDict = dict method test_init test_update test_abc test_clear test_delitem + test_setitem test_detect_deletion_during_iteration + test_popitem test_reinsert test_override_update + test_highly_nested test_highly_nested_subclass + test_delitem_hash_collision split setattr CPythonBuiltinDictTests method getattr OrderedDictTests method del method CPythonOrderedDictSideEffects check_runtime_error_issue dict dict msg = re escape OrderedDict mutated during iteration assertRaisesRegex RuntimeError msg operator eq dict dict test_issue _change_size_by_clear torch _dynamo error_on_graph_break False Key _TriggerSideEffectOnEqual side_effect dict clear dict = OrderedDict dict fromkeys Key dict = OrderedDict dict fromkeys Key check_runtime_error_issue dict dict assertEqual Key count assertDictEqual dict assertDictEqual dict dict fromkeys Key test_issue _change_size_by_delete_key torch _dynamo error_on_graph_break False Key _TriggerSideEffectOnEqual side_effect del dict TODEL TODEL = Key dict = OrderedDict dict fromkeys TODEL dict = OrderedDict dict fromkeys Key check_runtime_error_issue dict dict assertEqual Key count assertDictEqual dict dict fromkeys assertDictEqual dict dict fromkeys Key test_issue _change_linked_list_by_clear torch _dynamo error_on_graph_break False Key _TriggerSideEffectOnEqual side_effect dict clear dict = dict b = c dict = OrderedDict dict fromkeys Key dict = OrderedDict dict fromkeys Key check_runtime_error_issue dict dict assertEqual Key count assertDictEqual dict dict fromkeys b c assertDictEqual dict dict fromkeys Key test_issue _change_linked_list_by_delete_key torch _dynamo error_on_graph_break False Key _TriggerSideEffectOnEqual side_effect del dict TODEL dict = c TODEL = Key dict = OrderedDict dict fromkeys TODEL dict = OrderedDict dict fromkeys Key check_runtime_error_issue dict dict assertEqual Key count assertDictEqual dict None c None assertDictEqual dict dict fromkeys Key test_issue _change_size_by_delete_key_in_dict_eq torch _dynamo error_on_graph_break False Key _TriggerSideEffectOnEqual trigger = side_effect del dict TODEL TODEL = Key dict = OrderedDict dict fromkeys TODEL dict = OrderedDict dict fromkeys Key assertEqual Key count side effect dict __eq__ modifies length assertNotEqual dict dict assertEqual Key count assertDictEqual dict dict fromkeys assertDictEqual dict dict fromkeys Key unittest skipUnless c_coll requires C version collections module CPythonOrderedDictTests OrderedDictTests CPythonOrderedDictSideEffects __TestCase module = c_coll OrderedDict = c_coll OrderedDict check_sizeof = support check_sizeof support cpython_only test_sizeof_exact OrderedDict = OrderedDict calcsize = struct calcsize size = support calcobjsize check = check_sizeof basicsize = size nQ P + PnPn P keysize = calcsize n BI n entrysize = calcsize n P p = calcsize P nodesize = calcsize Pn P od = OrderedDict check od basicsize byte indices + entry table od x = check od basicsize od update i i i range check od basicsize + keysize + p + + entrysize + nodesize od update i i i range check od basicsize + keysize + p + + entrysize + nodesize check od keys size P check od items size P check od values size P itersize = size iP n P check iter od itersize check iter od keys itersize check iter od items itersize check iter od values itersize test_key_change_during_iteration OrderedDict = OrderedDict od = OrderedDict fromkeys abcde assertEqual list od list abcde assertRaises RuntimeError i k enumerate od od move_to_end k assertLess i assertRaises RuntimeError k od od f = None assertRaises RuntimeError k od del od c assertEqual list od list bdeaf test_iterators_pickling OrderedDict = OrderedDict pairs = c b d e f od = OrderedDict pairs method_name keys values items meth = getattr od method_name expected = list meth i range pickle HIGHEST_PROTOCOL + subTest method_name=method_name protocol=i = iter meth next p = pickle dumps i unpickled = pickle loads p assertEqual list unpickled expected assertEqual list expected support cpython_only test_weakref_list_is_not_traversed Check weakref list traversed when collecting OrderedDict objects See bpo- more information gc collect x = OrderedDict x cycle = x cycle = cycle append cycle x_ref = weakref ref x cycle append x_ref del x cycle x_ref gc collect PurePythonOrderedDictSubclassTests PurePythonOrderedDictTests module = py_coll OrderedDict py_coll OrderedDict pass CPythonOrderedDictSubclassTests CPythonOrderedDictTests module = c_coll OrderedDict c_coll OrderedDict pass PurePythonOrderedDictWithSlotsCopyingTests __TestCase module = py_coll OrderedDict py_coll OrderedDict __slots__ = x y test_copying = OrderedDictTests test_copying unittest skipUnless c_coll requires C version collections module CPythonOrderedDictWithSlotsCopyingTests __TestCase module = c_coll OrderedDict c_coll OrderedDict __slots__ = x y test_copying = OrderedDictTests test_copying PurePythonGeneralMappingTests mapping_tests BasicTestMappingProtocol classmethod setUpClass cls cls type test = py_coll OrderedDict super setUpClass test_popitem d = _empty_mapping assertRaises KeyError d popitem unittest skipUnless c_coll requires C version collections module CPythonGeneralMappingTests mapping_tests BasicTestMappingProtocol classmethod setUpClass cls cls type test = c_coll OrderedDict super setUpClass test_popitem d = _empty_mapping assertRaises KeyError d popitem PurePythonSubclassMappingTests mapping_tests BasicTestMappingProtocol classmethod setUpClass cls MyOrderedDict py_coll OrderedDict pass cls type test = MyOrderedDict super setUpClass test_popitem d = _empty_mapping assertRaises KeyError d popitem unittest skipUnless c_coll requires C version collections module CPythonSubclassMappingTests mapping_tests BasicTestMappingProtocol classmethod setUpClass cls MyOrderedDict c_coll OrderedDict pass cls type test = MyOrderedDict super setUpClass test_popitem d = _empty_mapping assertRaises KeyError d popitem SimpleLRUCache __init__ size super __init__ size = size counts = dict fromkeys get set del __getitem__ item counts get += value = super __getitem__ item move_to_end item value __setitem__ key value counts set += while key len = size popitem last=False super __setitem__ key value move_to_end key __delitem__ key counts del += super __delitem__ key SimpleLRUCacheTests test_add_after_full c = type test c t = c t = c t = assertEqual c counts get set del assertEqual list c t t assertEqual c counts get set del test_popitem c = type test i range c i = i assertEqual c popitem last=False assertEqual c popitem last=True assertEqual c counts get set del test_pop c = type test i range c i = i assertEqual c counts get set del assertEqual c pop assertEqual c counts get set del assertEqual c pop assertEqual c counts get set del assertRaises KeyError c pop assertEqual c counts get set del test_change_order_on_get c = type test i range c i = i assertEqual list c list range assertEqual c counts get set del assertEqual c assertEqual c counts get set del assertEqual list c PySimpleLRUCacheTests SimpleLRUCacheTests __TestCase type test SimpleLRUCache py_coll OrderedDict pass unittest skipUnless c_coll requires C version collections module CSimpleLRUCacheTests SimpleLRUCacheTests __TestCase classmethod setUpClass cls type test SimpleLRUCache c_coll OrderedDict pass cls type test = type test super setUpClass __name__ == __main__ run_tests
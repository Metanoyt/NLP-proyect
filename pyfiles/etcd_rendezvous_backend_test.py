Owner s oncall r p Copyright c Facebook Inc its affiliates All rights reserved This source code licensed under BSD-style license found LICENSE file root directory source tree subprocess threading time base b encode typing cast ClassVar unittest TestCase etcd EtcdKeyNotFound type ignore rendezvous_backend_test RendezvousBackendTestMixin torch distributed elastic rendezvous RendezvousConnectionError RendezvousParameters torch distributed elastic rendezvous api RendezvousStoreInfo torch distributed elastic rendezvous etcd_rendezvous_backend create_backend EtcdRendezvousBackend torch distributed elastic rendezvous etcd_server EtcdServer torch distributed elastic rendezvous etcd_store EtcdStore EtcdRendezvousBackendTest TestCase RendezvousBackendTestMixin _server ClassVar EtcdServer classmethod setUpClass cls - None cls _server = EtcdServer cls _server start stderr=subprocess DEVNULL classmethod tearDownClass cls - None cls _server stop setUp - None _client = _server get_client Make sure we have clean slate try _client delete dummy_prefix recursive=True dir=True except EtcdKeyNotFound pass _backend = EtcdRendezvousBackend _client dummy_run_id dummy_prefix _corrupt_state - None _client write dummy_prefix dummy_run_id non_base CreateBackendTest TestCase _server ClassVar EtcdServer classmethod setUpClass cls - None cls _server = EtcdServer cls _server start stderr=subprocess DEVNULL classmethod tearDownClass cls - None cls _server stop setUp - None _params = RendezvousParameters backend= dummy_backend endpoint=self _server get_endpoint run_id= dummy_run_id min_nodes= max_nodes= protocol= hTTp read_timeout= _expected_read_timeout = test_create_backend_returns_backend - None backend store = create_backend _params assertEqual backend name etcd-v assertIsInstance store EtcdStore etcd_store = cast EtcdStore store assertEqual etcd_store client read_timeout _expected_read_timeout type ignore attr-defined client = _server get_client backend set_state b dummy_state result = client get torch elastic rendezvous + _params run_id assertEqual result value b encode b dummy_state decode assertLessEqual result ttl store set dummy_key dummy_value result = client get torch elastic store + b encode b dummy_key decode assertEqual result value b encode b dummy_value decode test_create_backend_returns_backend_if_protocol_is_not_specified - None del _params config protocol test_create_backend_returns_backend test_create_backend_returns_backend_if_read_timeout_is_not_specified - None del _params config read_timeout _expected_read_timeout = test_create_backend_returns_backend test_create_backend_raises_error_if_etcd_is_unreachable - None _params endpoint = dummy assertRaisesRegex RendezvousConnectionError r ^The connection etcd has failed See inner exception details $ create_backend _params test_create_backend_raises_error_if_protocol_is_invalid - None _params config protocol = dummy assertRaisesRegex ValueError r ^The protocol must HTTP HTTPS $ create_backend _params test_create_backend_raises_error_if_read_timeout_is_invalid - None read_timeout - subTest read_timeout=read_timeout _params config read_timeout = read_timeout assertRaisesRegex ValueError r ^The read timeout must positive integer $ create_backend _params test_get_waits_for_store_prefix_key - None store_get store result_dict start_time = time perf_counter result_dict get_result = store get RendezvousStoreInfo MASTER_ADDR_KEY decode encoding= UTF- end_time = time perf_counter result_dict time = end_time - start_time store_set store time sleep store set RendezvousStoreInfo MASTER_ADDR_KEY b foo backend store = create_backend _params backend set_state b dummy_state result_dict = get_thread = threading Thread target=store_get args= store result_dict set_thread = threading Thread target=store_set args= store get_thread start set_thread start get_thread join set_thread join assert result_dict get_result == foo assert result_dict time =
Owner s module cpp os shutil subprocess sys unittest pathlib Path torch testing _internal common_cuda TEST_CUDA torch testing _internal common_device_type instantiate_device_type_tests torch testing _internal common_utils IS_LINUX run_tests shell TEST_XPU TestCase TestPythonAgnostic TestCase classmethod setUpClass cls Wipe dist dir exists cls extension_root = Path __file__ parent parent cls dist_dir = os path join cls extension_root dist os path exists cls dist_dir shutil rmtree cls dist_dir Build wheel wheel_cmd = sys executable -m build -- wheel -- no-isolation return_code = shell wheel_cmd cwd=cls extension_root env=os environ return_code = raise RuntimeError python_agnostic bdist_wheel failed build unittest skipIf TEST_CUDA TEST_XPU test requires CUDA XPU unittest skipIf IS_LINUX test requires linux tools ldd nm test_extension_is_python_agnostic device For test run_test py will call ` python -m build -- wheel -- no-isolation ` cpp_extensions python_agnostic_extension folder where extension setup calls specify py_limited_api ` True ` To approximate extension indeed python agnostic we test The extension wheel name contains cp -abi meaning wheel should runnable any Python version after including b The produced shared library does have libtorch_python so dependency output ldd _C so c The so does need any python related symbols We approximate running nm -u _C so grepping nothing starts Py matches = list Path dist_dir glob whl assertEqual len matches msg=str matches whl_file = matches assertRegex str whl_file r python_agnostic- \ -cp -abi - \ whl build_dir = os path join extension_root build matches = list Path build_dir glob so assertEqual len matches msg=str matches so_file = matches lddtree = subprocess check_output ldd so_file decode utf- assertFalse torch_python lddtree missing_symbols = subprocess check_output nm -u so_file decode utf- assertFalse Py missing_symbols devices = cuda xpu instantiate_device_type_tests TestPythonAgnostic globals only_for=devices allow_xpu=True __name__ == __main__ run_tests
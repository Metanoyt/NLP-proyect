mypy allow-untyped-defs importlib util numpy np torch _prims_common ShapeType torch distributed tensor _utils _compute_local_shape_and_global_offset __all__ = visualize_sharding Color = tuple float float float _create_table shards list tuple tuple int int tuple int int int device_kind str = Creates tabulate table given row column ranges device name tabulate tabulate Extract unique row column ranges row_ranges = sorted block block shards col_ranges = sorted block block shards Create matrix initialized empty strings matrix = _ col_ranges _ row_ranges Fill matrix values block shards row_index = row_ranges index block col_index = col_ranges index block matrix row_index col_index == matrix row_index col_index = device_kind + + str block matrix row_index col_index += + str block Prepare headers row_headers = f Row r - r r row_ranges col_headers = f Col c - c c col_ranges tabulate matrix headers=col_headers showindex=row_headers make_color_iter color_map num_rows num_cols num_colors = num_rows num_cols idx range num_colors yield color_map idx _canonicalize_color color Color - str isinstance color str color r g b = int color f r X g X b X _get_text_color color str - str r g b = map lambda x int x color color color noqa C r + g + b #ffffff _create_rich_table shape ShapeType shards list tuple tuple int int tuple int int int device_kind str = scale float = min_width int = max_width int = matplotlib rich align rich box rich console rich padding rich style rich table dtensor_height = shape dtensor_width = shape len shape == row_ranges = sorted s s shards col_ranges = sorted s s shards num_rows num_cols = len row_ranges len col_ranges console = rich console Console width=max_width use_color = console color_system color_iter = make_color_iter matplotlib colormaps tab b num_rows num_cols base_height = int scale aspect_ratio = shape len shape == shape base_width = int base_height aspect_ratio height_to_width_ratio = table = rich table Table show_header=False show_lines=not use_color padding= highlight=not use_color pad_edge=False box=rich box SQUARE use_color None row range num_rows table_row = col range num_cols entry = device_kind + + join str device_id row_range col_range device_id shards row_range == row_ranges row col_range == col_ranges col width = col_ranges col - col_ranges col dtensor_width width = int width base_width height_to_width_ratio height = row_ranges row - row_ranges row dtensor_height height = int height base_height left_padding remainder = divmod width - len entry - right_padding = left_padding + remainder top_padding remainder = divmod height - bottom_padding = top_padding + remainder use_color color = _canonicalize_color next color_iter text_color = _get_text_color color top_padding += bottom_padding += left_padding += right_padding += color = None text_color = None padding = max top_padding max right_padding max bottom_padding max left_padding table_row append rich padding Padding rich align Align entry center vertical= middle padding style=rich style Style bgcolor=color color=text_color table add_row table_row console print table end= \n\n visualize_sharding dtensor header= use_rich bool = False Visualizes sharding terminal ` DTensor ` D D note This requires ` ` tabulate ` ` package ` ` rich ` ` ` ` matplotlib ` ` No sharding info will printed empty tensors dtensor numel == Do print empty dtensors len dtensor shape = raise RuntimeError visualize sharding supports only D D DTensor dtensor device_mesh get_coordinate None current rank mesh Only display visualization once each DTensor rank whose coordinate all dimensions For example mesh full mesh we will only print rank local_rank_zero_on_all_dim = all dtensor device_mesh get_local_rank mesh_dim=dim == dim range dtensor device_mesh ndim local_rank_zero_on_all_dim device_coords = int device_index item list coord coord device_index np ndenumerate np array dtensor device_mesh mesh tolist device_shard_shape_and_offsets = device_index _compute_local_shape_and_global_offset dtensor shape dtensor device_mesh shape device_coords device_index dtensor placements device_index device_coords Extend shards D tensor D device_shard_shape_and_offsets = device_index shape len shape == shape offset len offset == offset device_index shape offset device_shard_shape_and_offsets items shards = offset offset + shape - offset offset + shape - device_index device_index shape offset device_shard_shape_and_offsets items importlib util find_spec rich importlib util find_spec matplotlib use_rich _create_rich_table dtensor shape shards device_kind=dtensor device_mesh device_type importlib util find_spec tabulate print _create_table shards device_kind=dtensor device_mesh device_type raise ValueError ` visualize_sharding ` requires either ` rich ` ` tabulate `
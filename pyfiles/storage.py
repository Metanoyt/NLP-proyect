abc os dataclasses dataclass typing Any Optional Union torch distributed checkpoint metadata Metadata MetadataIndex StorageMeta torch distributed checkpoint planner LoadPlan LoadPlanner SavePlan SavePlanner torch futures Future __all__ = WriteResult StorageWriter StorageReader dataclass frozen=True WriteResult index MetadataIndex size_in_bytes int storage_data Any StorageWriter abc ABC Interface used ` ` save_state_dict ` ` write storage One StorageWriter instance acts both coordinator follower distributed checkpoint As part initialization each instance told its role A subclass should expect following sequence calls all ranks set checkpoint_id users pass valid checkpoint_id all ranks set_up_storage_writer all ranks prepare_local_plan coordinator prepare_global_plan all ranks write_data coordinator finish abc abstractmethod reset checkpoint_id Union str os PathLike None = None - None Calls indicates brand new checkpoint write going happen A checkpoint_id may present users set checkpoint_id checkpoint write The meaning checkpiont_id storage-dependent It can path folder file key key-value storage Args checkpoint_id Union str os PathLike None The ID checkpoint instance The meaning checkpoint_id depends storage It can path folder file It can also key storage key-value store Default ` ` None ` ` abc abstractmethod set_up_storage_writer is_coordinator bool args Any kwargs Any - None Initialize instance Args is_coordinator bool Whether instance responsible coordinating checkpoint abc abstractmethod prepare_local_plan plan SavePlan - SavePlan Perform storage-specific local planning While method can produce completely different plan recommended way store storage specific data SavePlan storage_data Args plan SavePlan The local plan ` ` SavePlanner ` ` use Returns A transformed ` ` SavePlan ` ` after storage local planning abc abstractmethod prepare_global_plan plans list SavePlan - list SavePlan Perform centralized planning storage This method only called coordinator instance While method can produce completely different plan preferred way store storage specific data SavePlan storage_data Args plans A list ` ` SavePlan ` ` instances one each rank Returns A list transformed ` ` SavePlan ` ` after storage global planning abc abstractmethod write_data plan SavePlan planner SavePlanner - Future list WriteResult Write all items ` ` plan ` ` using ` ` planner ` ` resolve data A subclass should call ` ` SavePlanner resolve_data ` ` each item plan get access underlying object write Subclasses should lazily call ` resolve_data ` can allocate memory In case tensors make following assumptions - They might any device including matching one ` ` WriteItem tensor_data ` ` - They might views contiguous Only projection needs saved Args plan SavePlan The save plan execute planner SavePlanner Planner object used resolve items data Returns A future completes list WriteResult abc abstractmethod finish metadata Metadata results list list WriteResult - None Write metadata marks current checkpoint successful The actual format schema used serializing ` metadata ` implementation detail The only requirement s recoverable same object graph Args metadata Metadata metadata new checkpoint results A list WriteResults all ranks Returns None classmethod abc abstractmethod validate_checkpoint_id cls checkpoint_id Union str os PathLike - bool Check given checkpoint_id supported storage This allow us enable automatic storage selection storage_meta - Optional StorageMeta Return storage-specific metadata This used store additional information checkpoint can useful providing request-level observability StorageMeta passed ` ` SavePlanner ` ` during save calls Returns None default TODO provide example None StorageReader abc ABC Interface used ` ` load_state_dict ` ` read storage One StorageReader instance acts both coordinator follower distributed checkpoint As part initialization each instance told its role A subclass should expected following sequence calls ` ` load_state_dict ` ` all ranks set checkpoint_id users pass valid checkpoint_id all ranks read_metadata all ranks set_up_storage_reader all ranks prepare_local_plan coordinator prepare_global_plan all ranks read_data abc abstractmethod reset checkpoint_id Union str os PathLike None = None - None Calls indicates brand new checkpoint read going happen A checkpoint_id may present users set checkpoint_id checkpoint read The meaning checkpiont_id storage-dependent It can path folder file key key-value storage Args checkpoint_id Union str os PathLike None The ID checkpoint instance The meaning checkpoint_id depends storage It can path folder file It can also key storage more like key-value store Default ` ` None ` ` abc abstractmethod read_metadata args Any kwargs Any - Metadata Read checkpoint metadata Returns The metadata object associated checkpoint being loaded abc abstractmethod set_up_storage_reader metadata Metadata is_coordinator bool args Any kwargs Any - None Initialize instance Args metadata Metadata The metadata schema use is_coordinator bool Whether instance responsible coordinating checkpoint abc abstractmethod prepare_local_plan plan LoadPlan - LoadPlan Perform storage-specific local planning While method can produce completely different plan recommended way store storage specific data LoadPlan storage_data Args plan LoadPlan The local plan ` ` LoadPlan ` ` use Returns A transformed ` ` LoadPlan ` ` after storage local planning abc abstractmethod prepare_global_plan plans list LoadPlan - list LoadPlan Perform centralized planning storage loading This method only called coordinator instance While method can produce completely different plan preferred way store storage specific data LoadPlan storage_data Args plans A list ` ` LoadPlan ` ` instances one each rank Returns A list transformed ` ` LoadPlan ` ` after storage global planning abc abstractmethod read_data plan LoadPlan planner LoadPlanner - Future None Read all items ` ` plan ` ` using ` ` planner ` ` resolve data A subclass should call ` ` LoadPlanner load_bytes ` ` deserialize BytesIO object into right place A subclass should call ` ` LoadPlanner resolve_tensor ` ` get access tensors should load data into It s StorageLayer responsibility properly schedule any cross device copies required Args plan LoadPlan The local plan execute planner LoadPlanner The planner object use resolve items Returns A future completes once all reads finished classmethod abc abstractmethod validate_checkpoint_id cls checkpoint_id Union str os PathLike - bool Check given checkpoint_id supported storage This allow us enable automatic storage selection
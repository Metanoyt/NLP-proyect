usr bin env python Owner s oncall r p Copyright c Facebook Inc its affiliates All rights reserved This source code licensed under BSD-style license found LICENSE file root directory source tree logging multiprocessing mp signal time torch distributed elastic timer timer torch multiprocessing torch_mp torch testing _internal common_utils IS_ARM IS_MACOS IS_WINDOWS run_tests skip_but_pass_in_sandcastle_if TEST_WITH_DEV_DBG_ASAN TestCase logging basicConfig level=logging INFO format= levelname s asctime s module s message s _happy_function rank mp_queue timer configure timer LocalTimerClient mp_queue timer expires after= time sleep _stuck_function rank mp_queue timer configure timer LocalTimerClient mp_queue timer expires after= time sleep timer supported these platforms IS_WINDOWS IS_MACOS IS_ARM LocalTimerExample TestCase Demonstrates how use LocalTimerServer LocalTimerClient enforce expiration code-blocks Since torch multiprocessing s ` ` start_process ` ` method currently does take multiprocessing context parameter argument there no way create mp Queue correct context BEFORE spawning child processes Once ` ` start_process ` ` API changed torch then re-enable ` ` test_torch_mp_example ` ` unittest As now will SIGSEGV skip_but_pass_in_sandcastle_if TEST_WITH_DEV_DBG_ASAN test asan incompatible test_torch_mp_example practice set max_interval larger value e g seconds mp_queue = mp get_context spawn Queue server = timer LocalTimerServer mp_queue max_interval= server start world_size = all processes should complete successfully since start_process does NOT take context parameter argument yet method WILL FAIL hence test disabled torch_mp spawn fn=_happy_function args= mp_queue nprocs=world_size join=True assertRaises Exception torch multiprocessing spawn kills all sub-procs one them gets killed torch_mp spawn fn=_stuck_function args= mp_queue nprocs=world_size join=True server stop skip_but_pass_in_sandcastle_if TEST_WITH_DEV_DBG_ASAN test asan incompatible test_example_start_method_spawn _run_example_with start_method= spawn skip_but_pass_in_sandcastle_if TEST_WITH_DEV_DBG_ASAN test asan incompatible test_example_start_method_forkserver _run_example_with start_method= forkserver _run_example_with start_method spawn_ctx = mp get_context start_method mp_queue = spawn_ctx Queue server = timer LocalTimerServer mp_queue max_interval= server start world_size = processes = i range world_size i == p = spawn_ctx Process target=_stuck_function args= i mp_queue p = spawn_ctx Process target=_happy_function args= i mp_queue p start processes append p i range world_size p = processes i p join i == assertEqual -signal SIGKILL p exitcode assertEqual p exitcode server stop __name__ == __main__ run_tests
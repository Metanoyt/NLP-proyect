abc logging concurrent futures Future typing Any Optional TypeVar checkpoint_process CheckpointProcess checkpoint_reader CheckpointReader checkpoint_writer CheckpointWriter staging CheckpointStager types STATE_DICT utils wrap_future logger = logging getLogger __name__ LOG_INTERVAL = T = TypeVar T Checkpointer abc ABC WARNING This experimental created validate certain ideas subjected change deprecation we strong discourage any usages time Abstract base defines API checkpointing This defines interface coordinating writing loading model state dictionaries storage It provides abstract methods save load model states support both synchronous asynchronous operations Concrete implementations must implement all abstract methods abc abstractmethod save path str state_dict STATE_DICT kwargs dict str Any - Optional tuple Future Future Save state dictionary storage Args path The path where checkpoint should saved state_dict The state dictionary save kwargs Additional keyword arguments pass writer Returns For synchronous implementations None For asynchronous implementations tuple stage_future write_future representing staging writing operations abc abstractmethod load path str state_dict Optional STATE_DICT = None default_map_location Any = None strict bool = False kwargs dict str Any - STATE_DICT Load state dictionary storage Args path The path which load checkpoint state_dict Optional state dictionary update loaded values If provided only keys dictionary will loaded default_map_location Device mapping function device name relocating tensors strict If True raises error when there missing keys checkpoint kwargs Additional keyword arguments pass reader Returns The loaded state dictionary abc abstractmethod close - None Close checkpointer release any resources This method should called when checkpointer no longer needed ensure proper cleanup resources SyncCheckpointer Checkpointer Synchronous implementation Checkpointer This coordinates writing loading model state dictionaries storage using only synchronous operations It provides simple efficient interface checkpoint operations without async overhead Attributes _writer CheckpointWriter writing state dictionaries storage _reader CheckpointReader reading state dictionaries storage Example checkpointer = SyncCheckpointer writer=writer reader=reader checkpointer save state_dict path loaded_state_dict = checkpointer load path __init__ writer CheckpointWriter reader CheckpointReader Initialize synchronous checkpointer Args writer CheckpointWriter writing checkpoints storage reader CheckpointReader reading checkpoints storage _writer = writer _reader = reader save path str state_dict STATE_DICT kwargs dict str Any - Optional tuple Future Future Save state dictionary storage synchronously Args path The path where checkpoint should saved state_dict The state dictionary save kwargs Additional keyword arguments pass writer Returns Always returns None operations synchronous Example checkpointer save path checkpoint state_dict logger debug Saving checkpoint synchronously s path _writer write path state_dict kwargs None load path str state_dict Optional STATE_DICT = None default_map_location Any = None strict bool = False kwargs dict str Any - STATE_DICT Load state dictionary storage Args path The path which load checkpoint state_dict Optional state dictionary update loaded values If provided only keys dictionary will loaded default_map_location Device mapping function device name relocating tensors strict If True raises error when there missing keys checkpoint kwargs Additional keyword arguments pass reader Returns The loaded state dictionary Raises RuntimeError If strict=True there missing keys checkpoint FileNotFoundError If checkpoint file found logger info Loading checkpoint s path loaded_state_dict missing_keys = _reader read path=path state_dict=state_dict map_location=default_map_location kwargs strict missing_keys None missing_keys = raise RuntimeError f Checkpoint path missing keys missing_keys loaded_state_dict close - None Close checkpointer release any resources This method should called when checkpointer no longer needed ensure proper cleanup resources _writer close logger info SyncCheckpointer closed AsyncCheckpointer Checkpointer Asynchronous implementation Checkpointer This coordinates writing loading model state dictionaries storage using asynchronous operations saving It provides efficient async checkpoint operations staging background writing capabilities Attributes _reader CheckpointReader reading state dictionaries storage _checkpoint_stager Stager async operations _checkpoint_process Process async operations _write_future Future representing ongoing async write operation Example checkpointer = AsyncCheckpointer reader=reader checkpoint_stager=stager checkpoint_process=process stage_future write_future = checkpointer save state_dict path do other work write_future result Wait completion __init__ checkpoint_stager CheckpointStager checkpoint_process CheckpointProcess reader CheckpointReader Initialize asynchronous checkpointer Args checkpoint_stager Stager async operations checkpoint_process Process async operations reader CheckpointReader reading checkpoints storage _reader = reader _checkpoint_stager = checkpoint_stager _checkpoint_process = checkpoint_process _write_future Optional Future Any = None save path str state_dict STATE_DICT kwargs Any - Optional tuple Future Future Save state dictionary storage asynchronously Args path The path where checkpoint should saved state_dict The state dictionary save kwargs Additional keyword arguments pass stager writer Returns A tuple stage_future write_future representing staging writing operations Example stage_future write_future = checkpointer save path checkpoint state_dict do other work write_future result Wait completion logger info Initiating checkpoint save s Will wait prev checkpoints complete path Wait previous checkpoint ops finish verify they successful _write_future None _write_future result logger debug Starting state dictionary staging staging_result = _checkpoint_stager stage state_dict=state_dict kwargs logger debug Starting checkpoint write s path _write_future = _checkpoint_process write staging_result path kwargs logger info Checkpoint save s initiated path Return futures staging writing operations _write_future None wrap_future staging_result _write_future This should happen since we just assigned _write_future above raise RuntimeError Write future unexpectedly None load path str state_dict Optional STATE_DICT = None default_map_location Any = None strict bool = False kwargs Any - STATE_DICT Load state dictionary storage Loading always performed synchronously even AsyncCheckpointer Args path The path which load checkpoint state_dict Optional state dictionary update loaded values If provided only keys dictionary will loaded default_map_location Device mapping function device name relocating tensors strict If True raises error when there missing keys checkpoint kwargs Additional keyword arguments pass reader Returns The loaded state dictionary Raises RuntimeError If strict=True there missing keys checkpoint FileNotFoundError If checkpoint file found logger info Loading checkpoint s path loaded_state_dict missing_keys = _reader read path=path state_dict=state_dict map_location=default_map_location kwargs strict missing_keys None missing_keys = raise RuntimeError f Checkpoint path missing keys missing_keys loaded_state_dict close - None Close checkpointer release any resources This method should called when checkpointer no longer needed ensure proper cleanup async resources _checkpoint_stager close _checkpoint_process close logger info AsyncCheckpointer closed
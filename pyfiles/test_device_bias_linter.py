usr bin env python This lint verifies every Python test file file matches test_ py _test py test folder has cuda hard code ` requires_gpu ` ` requires_triton ` decorated function ` HAS_GPU ` guarded main section ensure test fail other GPU devices __future__ annotations argparse ast json multiprocessing mp enum Enum typing NamedTuple LINTER_CODE = TEST_DEVICE_BIAS LintSeverity str Enum ERROR = error WARNING = warning ADVICE = advice DISABLED = disabled LintMessage NamedTuple path str &#124; None line int &#124; None char int &#124; None code str severity LintSeverity name str original str &#124; None replacement str &#124; None description str &#124; None DEVICE_BIAS = cuda xpu mps GPU_RELATED_DECORATORS = requires_gpu requires_triton is_main_has_gpu tree ast AST - bool _contains_has_gpu node ast AST - bool isinstance node ast Name node id HAS_GPU RUN_GPU True isinstance node ast BoolOp any _contains_has_gpu value value node values isinstance node ast UnaryOp _contains_has_gpu node operand isinstance node ast Compare _contains_has_gpu node left any _contains_has_gpu comp comp node comparators isinstance node ast IfExp ast Call False False node ast walk tree Detect __name__ == __main__ isinstance node ast If isinstance node test ast Compare isinstance node test left ast Name node test left id == __name__ any isinstance comp ast Constant comp value == __main__ comp node test comparators inner_node node body isinstance inner_node ast If _contains_has_gpu inner_node test True False DeviceBiasVisitor ast NodeVisitor __init__ filename str is_gpu_test_suite bool - None filename = filename lint_messages list LintMessage = is_gpu_test_suite = is_gpu_test_suite _has_proper_decorator node ast FunctionDef - bool d node decorator_list isinstance d ast Name d id GPU_RELATED_DECORATORS True isinstance d ast Call isinstance d func ast Name d func id GPU_RELATED_DECORATORS True False check device = cuda torch device cuda _check_keyword_device subnode ast keyword msg_prefix str - None subnode arg = device val = subnode value isinstance val ast Constant any bias val value bias DEVICE_BIAS record subnode f msg_prefix device= val value suggest use device=GPU_TYPE isinstance val ast Call isinstance val func ast Attribute val func attr == device len val args isinstance val args ast Constant any bias val args value bias DEVICE_BIAS record val f msg_prefix torch device val args value suggest use torch device GPU_TYPE check cuda cuda _check_device_methods subnode ast Call msg_prefix str - None func = subnode func isinstance func ast Attribute method_name = func attr method_name DEVICE_BIAS record subnode f msg_prefix method_name suggest use GPU_TYPE method_name == subnode args arg = subnode args isinstance arg ast Constant any bias arg value bias DEVICE_BIAS record subnode f msg_prefix arg value suggest use GPU_TYPE _check_with_statement node ast With msg_prefix str - None item node items ctx_expr = item context_expr isinstance ctx_expr ast Call func = ctx_expr func isinstance func ast Attribute func attr == device isinstance func value ast Name func value id == torch ctx_expr args isinstance ctx_expr args ast Constant any bias ctx_expr args value bias DEVICE_BIAS record ctx_expr f msg_prefix ` torch device ctx_expr args value ` suggest use torch device GPU_TYPE _check_node node ast AST msg_prefix str - None subnode ast walk node isinstance subnode ast keyword _check_keyword_device subnode msg_prefix isinstance subnode ast Call isinstance subnode func ast Attribute _check_device_methods subnode msg_prefix isinstance subnode ast With _check_with_statement subnode msg_prefix visit_FunctionDef node ast FunctionDef - None _has_proper_decorator node msg_prefix = ` requires_gpu ` ` requires_triton ` function should hardcode _check_node node msg_prefix is_gpu_test_suite If function guarded HAS_GPU main we still need check device bias msg_prefix = The test suites shared amount GPUS should hardcode _check_node node msg_prefix generic_visit node record node ast AST message str - None lint_messages append LintMessage path=self filename line=getattr node lineno None char=None code=LINTER_CODE severity=LintSeverity ERROR name= device-bias original=None replacement=None description=message check_file filename str - list LintMessage open filename f source = f read tree = ast parse source filename=filename is_gpu_test_suite = is_main_has_gpu tree checker = DeviceBiasVisitor filename is_gpu_test_suite checker visit tree checker lint_messages main - None parser = argparse ArgumentParser description= Detect Device bias functions decorated requires_gpu requires_triton guarded HAS_GPU block main may break other GPU devices fromfile_prefix_chars= parser add_argument filenames nargs= + help= paths lint args = parser parse_args mp Pool pool lint_messages = pool map check_file args filenames flat_lint_messages = sublist lint_messages flat_lint_messages extend sublist lint_message flat_lint_messages print json dumps lint_message _asdict flush=True __name__ == __main__ main
__future__ annotations os platform subprocess optional_submodules checkout_nccl setup_helpers cmake CMake USE_NINJA setup_helpers env check_env_flag check_negative_env_flag IS_ BIT IS_WINDOWS _get_vc_env vc_arch str - dict str str try setuptools distutils type ignore attr-defined distutils _msvccompiler _get_vc_env vc_arch type ignore no-any-return except AttributeError setuptools _distutils _msvccompiler type ignore attr-defined _msvccompiler _get_vc_env vc_arch type ignore no-any-return attr-defined _overlay_windows_vcvars env dict str str - dict str str vc_arch = x IS_ BIT x platform machine == ARM vc_arch = x _arm First Win Windows Arm build version supports x emulation win _ st_version = current_win_version = tuple int version_part version_part platform version split current_win_version win _ st_version vc_arch = x _arm print Warning -bit toolchain will used -bit linker recommended avoid out-of-memory linker error print Warning Please consider upgrading Win where x emulation enabled vc_env = _get_vc_env vc_arch Keys ` _get_vc_env ` always lowercase We turn them into uppercase before overlaying vcvars because OS environ keys always uppercase Windows https stackoverflow com vc_env = k upper v k v vc_env items k v env items uk = k upper uk vc_env vc_env uk = v vc_env _create_build_env - dict str str XXX - our cmake file sometimes looks system environment cmake flags you should NEVER add something list It bad practice have cmake read environment my_env = os environ copy IS_WINDOWS USE_NINJA When using Ninja under Windows gcc toolchain will chosen default But should set MSVC user s first choice my_env = _overlay_windows_vcvars my_env my_env setdefault CC cl my_env setdefault CXX cl my_env build_pytorch version str &#124; None cmake_python_library str &#124; None build_python bool rerun_cmake bool cmake_only bool cmake CMake - None my_env = _create_build_env check_negative_env_flag USE_DISTRIBUTED check_negative_env_flag USE_CUDA check_negative_env_flag USE_NCCL check_env_flag USE_SYSTEM_NCCL checkout_nccl build_test = check_negative_env_flag BUILD_TEST cmake generate version cmake_python_library build_python build_test my_env rerun_cmake cmake_only build_custom_step = os getenv BUILD_CUSTOM_STEP build_custom_step try output = subprocess check_output build_custom_step shell=True stderr=subprocess STDOUT text=True print Command output print output except subprocess CalledProcessError e print Command failed code e returncode print Output stdout stderr print e output raise cmake build my_env
Tensor pointwise operator implementation random torch torchfuzz operators base Operator torchfuzz tensor_fuzzer Spec TensorSpec torchfuzz type_promotion get_dtype_map get_dtype_name get_promotion_table_for_strings PointwiseOperator Operator Base element-wise pointwise operations __init__ name str symbol str super __init__ name symbol = symbol can_produce output_spec Spec - bool Tensor pointwise operations can produce tensors scalars isinstance output_spec TensorSpec output_spec dtype == torch bool False isinstance output_spec TensorSpec fuzz_inputs_specs output_spec Spec num_inputs int = - list Spec Decompose tensor into input tensors pointwise operation type promotion isinstance output_spec TensorSpec raise ValueError f __class__ __name__ can only produce TensorSpec outputs Use shared type promotion table promotion_table = get_promotion_table_for_strings If num_inputs promote left-to-right e g op b op c op d For simplicity we generate first two promotion rest match output dtype dtype_str = get_dtype_name output_spec dtype supported_types = promotion_table get dtype_str dtype_str dtype_str Pick random promotion pattern first two inputs num_inputs = dtypes = list random choice supported_types For inputs fill output dtype while len dtypes num_inputs dtypes append dtype_str dtypes = dtype_str num_inputs Convert dtype strings back torch dtypes dtype_map = get_dtype_map TensorSpec size=output_spec size stride=output_spec stride dtype=dtype_map get dt output_spec dtype dt dtypes codegen output_name str input_names list str output_spec Spec - str Generate code pointwise operation len input_names == f output_name = torch_op_name input_names input_names Chain operations using symbols readability expr = f symbol join input_names f output_name = expr AddOperator PointwiseOperator Operator element-wise addition __init__ weight float = super __init__ add + weight = float weight property torch_op_name - str torch add MulOperator PointwiseOperator Operator element-wise multiplication __init__ super __init__ mul property torch_op_name - str torch mul SubOperator PointwiseOperator Operator element-wise subtraction __init__ super __init__ sub - property torch_op_name - str torch sub DivOperator PointwiseOperator Operator element-wise division __init__ super __init__ div property torch_op_name - str torch div ClampOperator Operator Operator torch clamp element-wise clamping __init__ super __init__ clamp property torch_op_name - str torch clamp can_produce output_spec Spec - bool Clamp can produce tensors scalars isinstance output_spec TensorSpec output_spec dtype == torch bool False isinstance output_spec TensorSpec fuzz_inputs_specs output_spec Spec - list Spec Generate input specs clamp operation Clamp takes - input tensor same shape dtype output - optional min value scalar None - optional max value scalar None isinstance output_spec TensorSpec raise ValueError ClampOperator can only produce TensorSpec outputs TensorSpec size=output_spec size stride=output_spec stride dtype=output_spec dtype codegen output_name str input_names list str output_spec Spec - str Generate code clamp operation len input_names = raise ValueError Clamp requires exactly input tensor input_name = input_names Generate random min max values clamping We ll randomly decide whether use min max both use_min = random random use_max = random random use_min use_max use_min = True args = input_name use_min args append min=- args append min=None use_max args append max= args append max=None f output_name = torch clamp join args CumsumOperator Operator Operator torch cumsum cumulative sum along dimension __init__ super __init__ cumsum property torch_op_name - str torch cumsum can_produce output_spec Spec - bool Cumsum can produce tensors scalars isinstance output_spec TensorSpec output_spec dtype == torch bool False Cumsum needs least dimension isinstance output_spec TensorSpec len output_spec size == False isinstance output_spec TensorSpec fuzz_inputs_specs output_spec Spec - list Spec Generate input specs cumsum operation Cumsum takes input tensor same shape dtype output isinstance output_spec TensorSpec raise ValueError CumsumOperator can only produce TensorSpec outputs TensorSpec size=output_spec size stride=output_spec stride dtype=output_spec dtype codegen output_name str input_names list str output_spec Spec - str Generate code cumsum operation len input_names = raise ValueError Cumsum requires exactly input tensor isinstance output_spec TensorSpec raise ValueError Output spec must TensorSpec input_name = input_names Choose random valid dimension num_dims = len output_spec size num_dims == raise ValueError Cumsum requires tensor least dimension Pick random dimension index dim = random randint num_dims - f output_name = torch cumsum input_name dim= dim
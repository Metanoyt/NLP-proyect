Constant enum variable tracking Dynamo This module fundamental Dynamo s ability track propagate constant values during compilation ensuring proper handling Python literals maintaining type safety through compilation process enum operator typing Any Literal Optional TYPE_CHECKING Union torch torch _dynamo source AttrSource GetItemSource graph_break_hints variables exc raise_observed_exception unimplemented_v utils cmp_name_to_op_mapping common_constant_types istype np raise_args_mismatch base ValueMutationNew VariableTracker TYPE_CHECKING torch _dynamo symbolic_convert InstructionTranslator ConstantVariable VariableTracker Variable tracker Python literals basic immutable types automatic routing support collection types lists tuples sets etc The create method intelligently constructs appropriate variable types nested collections staticmethod create value Any kwargs Any - VariableTracker Create ` ConstantVariable ` based given value supports automatic routing collection types like ` tuple ` which case we d create ` ConstantVariable ` leaf items NOTE caller must install proper guards needed most often guard will ` CONSTANT_MATCH ` source = kwargs get source Routing supported collection literals isinstance value set items = ConstantVariable create x x value variables SetVariable items kwargs isinstance value frozenset items = ConstantVariable create x x value variables FrozensetVariable items kwargs isinstance value slice slice_args = value start value stop value step slice_args_vars = tuple ConstantVariable create arg arg slice_args variables SliceVariable slice_args_vars kwargs isinstance value list tuple items = i x enumerate value item_source = GetItemSource source i source None items append ConstantVariable create x source=item_source variables BaseListVariable cls_for type value items kwargs ConstantVariable value kwargs __init__ value Any kwargs Any - None super __init__ kwargs assert ConstantVariable is_base_literal value f Cannot construct ` ConstantVariable ` value type type value This failure likely due PyTorch-internal use ` ConstantVariable ` non-literal python values please try using ` VariableTracker build ` instead If you believe s necessary legitimate use case value immutable can t easily represented another ` VariableTracker ` please add its type ` common_constant_types ` np None isinstance value np number value = value item value = value as_proxy - Any value __repr__ - str f ConstantVariable type value __name__ repr value as_python_constant - Any value is_python_constant - Literal True True property items - list VariableTracker Need when adding BaseListVariable ConstantVariable together Happens detectron unpack_var_sequence tx=None getitem_const tx InstructionTranslator arg VariableTracker - VariableTracker ConstantVariable create value arg as_python_constant staticmethod is_base_literal obj object - bool type obj common_constant_types staticmethod is_literal obj object - bool type obj list tuple set frozenset torch Size all ConstantVariable is_literal x x obj type ignore attr-defined ConstantVariable is_base_literal obj unpack_var_sequence tx Optional InstructionTranslator - list VariableTracker try ConstantVariable create x x as_python_constant except TypeError e raise NotImplementedError e const_getattr tx InstructionTranslator name str - VariableTracker hasattr value name raise_observed_exception AttributeError tx args= name member = getattr value name callable member raise NotImplementedError member call_method tx InstructionTranslator name str args list VariableTracker kwargs dict str VariableTracker - VariableTracker tensor SymNodeVariable name == format istype value str variables BuiltinVariable str format call_function tx args kwargs name == join istype value str kwargs len args = raise_args_mismatch tx name args kwargs f len args args len kwargs kwargs arg_unpacked = args force_unpack_var_sequence tx try arg_const = x as_python_constant x arg_unpacked ConstantVariable create value join arg_const except NotImplementedError super call_method tx name args kwargs name == __iter__ istype value str could some generic iterator avoid circular ListIterator does what we want lists ListIteratorVariable ListIteratorVariable unpack_var_sequence tx mutation_type=ValueMutationNew any isinstance x SymNodeVariable x args Promote SymNodeVariable operations involving dynamic shapes variables SymNodeVariable as_proxy value call_method tx name args kwargs try const_args = as_python_constant args const_kwargs = k v as_python_constant k v kwargs items except NotImplementedError super call_method tx name args kwargs isinstance value str name str __dict__ keys method = getattr value name try ConstantVariable create method const_args const_kwargs except Exception e raise_observed_exception type e tx isinstance value float int args kwargs try ConstantVariable create getattr value name except OverflowError ValueError exc raise_observed_exception type exc tx args=list map ConstantVariable create exc args hasattr operator name len args == args is_python_constant add_target = const_args op = getattr operator name isinstance add_target torch SymBool torch SymFloat torch SymInt Addition between non sym sym makes sym proxy = tx output create_proxy call_function op value add_target SymNodeVariable create tx proxy add_target try ConstantVariable create op value add_target except Exception e raise_observed_exception type e tx args=list map ConstantVariable create e args isinstance value bytes name == decode method = getattr value name ConstantVariable create method const_args const_kwargs type value complex name complex __dict__ keys method = getattr value name try ConstantVariable create method const_args const_kwargs except Exception e raise_observed_exception type e tx name == __len__ args kwargs ConstantVariable create len value name == __round__ len args == args is_python_constant try ConstantVariable create round value args as_python_constant except Exception e raise_observed_exception type e tx args=list map ConstantVariable create e args name == __contains__ len args == args is_python_constant assert kwargs search = args as_python_constant try result = search value ConstantVariable create result except TypeError e raise_observed_exception type e tx args=list map ConstantVariable create e args super call_method tx name args kwargs call_obj_hasattr tx InstructionTranslator name str - VariableTracker result = hasattr value name variables ConstantVariable create result EnumVariable VariableTracker VariableTracker enum Enum enum IntEnum instances Provides specialized handling Python enum types supporting both standard Enum IntEnum proper value tracking comparison __init__ value Union enum Enum enum IntEnum kwargs Any - None super __init__ kwargs value = value classmethod create cls cls_type Any value_vt VariableTracker options Any - EnumVariable isinstance value_vt variables ConstantVariable member list cls_type member value == value_vt as_python_constant cls member options unimplemented_v gb_type= Failed construct Enum variable context=f value value_vt allowed enum values list cls_type explanation= Attempted construct Enum value non-constant e g int string acceptable value Enum f Acceptable values Enum ` cls_type ` list cls_type hints= graph_break_hints USER_ERROR graph_break_hints SUPPORTABLE as_proxy - Union enum Enum int isinstance value int int value convert IntEnum normal int value __repr__ - str f EnumVariable type value as_python_constant - Union enum Enum enum IntEnum value var_getattr tx InstructionTranslator name str - VariableTracker hasattr value name raise NotImplementedError name cmp_name_to_op_mapping variables GetAttrVariable name member = getattr value name source = source AttrSource source name VariableTracker build tx member source=source
re collections abc Callable typing Any Union torch torch utils _pytree tree_flatten_with_path tree_map KeyPath = tuple Any NonTensorShapeFn = Callable Union int float tuple Any __all__ = normalize_source_name module_to_nested_dict track_dynamism_across_examples clone_and_convert_to_meta normalize_source_name name str - str Match attribute access like x replace x re sub r \ a-zA-Z_ a-zA-Z - _ r \ name module_to_nested_dict module torch nn Module - dict str Any Recursively converts nn Module into nested dictionary explicit parameters modules keys self_dict dict str Any = self_dict _parameters = self_dict _modules = attr_name dir module try attr_name startswith _ callable getattr module attr_name attr_value = getattr module attr_name isinstance attr_value torch nn Module isinstance attr_value int float torch Tensor type attr_value bool self_dict attr_name = attr_value except NotImplementedError Skip attributes raise NotImplementedError since they won t contain any dynamism anyways continue name param module named_parameters recurse=False self_dict _parameters name = param name buffer module named_buffers recurse=False self_dict _parameters name = buffer name submodule module named_children self_dict _modules name = module_to_nested_dict submodule self_dict track_dynamism_across_examples example_inputs list Any - dict Any Any This function analyzes list example inputs determine dynamism their shapes It tracks whether dimensions tensors non-tensor values change across different examples The function returns dictionary where each key represents path value input examples corresponding value tuple indicating which dimensions dynamic i e change across examples This helps understanding how structure data varies across different instances tracking dict KeyPath tuple list set Any bool = ex example_inputs ex isinstance ex torch nn Module ex = module_to_nested_dict ex leaves_with_paths _ = tree_flatten_with_path ex key_path value leaves_with_paths isinstance value int float torch Tensor continue isinstance value torch Tensor shape tuple int &#124; float = tuple value shape is_tensor = True shape = value is_tensor = False key_path tracking tracking key_path = set _ range len shape is_tensor dim_sets flag = tracking key_path flag = is_tensor pass while len dim_sets len shape dim_sets append set i dim enumerate shape tracking key_path i add dim output dict Any Any = key_path dim_sets _is_tensor tracking items final_dyn = tuple len s s dim_sets key_str = L + join f str k k key_path key = key_path key type ignore attr-defined key output output key = output key key_str = final_dyn output clone_and_convert_to_meta example_input Any - Any This function takes list example inputs each tensor clones converts device=meta For non-tensor values keeps reference It uses pytree handle nested structures recursively transform_fn value Any - Any isinstance value torch Tensor value clone device= meta value tree_map transform_fn example_input
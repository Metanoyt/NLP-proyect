mypy allow-untyped-defs math typing Optional torch torch jit torch Tensor torch distributions constraints torch distributions distribution Distribution torch distributions utils broadcast_all lazy_property __all__ = VonMises _eval_poly y coef coef = list coef result = coef pop while coef result = coef pop + y result result _I _COEF_SMALL = e- e- _I _COEF_LARGE = e- e- - e- e- - e- e- - e- e- _I _COEF_SMALL = e- e- e- _I _COEF_LARGE = - e- - e- e- - e- e- - e- e- - e- _COEF_SMALL = _I _COEF_SMALL _I _COEF_SMALL _COEF_LARGE = _I _COEF_LARGE _I _COEF_LARGE _log_modified_bessel_fn x order= Returns ` ` log I_order x ` ` ` ` x ` ` where ` order ` either assert order == order == compute small solution y = x y = y y small = _eval_poly y _COEF_SMALL order order == small = x abs small small = small log compute large solution y = x large = x - x log + _eval_poly y _COEF_LARGE order log result = torch where x small large result torch jit script_if_tracing _rejection_sample loc concentration proposal_r x done = torch zeros x shape dtype=torch bool device=loc device pyrefly ignore bad-assignment while done all u = torch rand + x shape dtype=loc dtype device=loc device u u u = u unbind z = torch cos math pi u f = + proposal_r z proposal_r + z c = concentration proposal_r - f accept = c - c - u &#124; c u log + - c = accept any pyrefly ignore no-matching-overload x = torch where accept u - sign f acos x done = done &#124; accept x + math pi + loc math pi - math pi VonMises Distribution A circular von Mises distribution This implementation uses polar coordinates The ` ` loc ` ` ` ` value ` ` args can any real number facilitate unconstrained optimization interpreted angles modulo pi Example xdoctest +IGNORE_WANT non-deterministic m = VonMises torch tensor torch tensor m sample von Mises distributed loc= concentration= tensor param torch Tensor loc angle radians param torch Tensor concentration concentration parameter pyrefly ignore bad-override arg_constraints = loc constraints real concentration constraints positive support = constraints real has_rsample = False __init__ loc Tensor concentration Tensor validate_args Optional bool = None - None loc concentration = broadcast_all loc concentration batch_shape = loc shape event_shape = torch Size super __init__ batch_shape event_shape validate_args log_prob value _validate_args _validate_sample value log_prob = concentration torch cos value - loc log_prob = log_prob - math log math pi - _log_modified_bessel_fn concentration order= log_prob lazy_property _loc - Tensor loc torch double lazy_property _concentration - Tensor concentration torch double lazy_property _proposal_r - Tensor kappa = _concentration pyrefly ignore unsupported-operation tau = + + kappa sqrt rho = tau - tau sqrt kappa pyrefly ignore unsupported-operation _proposal_r = + rho rho second order Taylor expansion around small kappa _proposal_r_taylor = kappa + kappa torch where kappa e- _proposal_r_taylor _proposal_r torch no_grad sample sample_shape=torch Size The sampling algorithm von Mises distribution based following paper D J Best N I Fisher Efficient simulation von Mises distribution Applied Statistics - Sampling always done double precision internally avoid hang _rejection_sample small values concentration which starts happen single precision around e- see issue shape = _extended_shape sample_shape x = torch empty shape dtype=self _loc dtype device=self loc device _rejection_sample _loc _concentration _proposal_r x loc dtype expand batch_shape _instance=None try super expand batch_shape except NotImplementedError validate_args = __dict__ get _validate_args loc = loc expand batch_shape concentration = concentration expand batch_shape type loc concentration validate_args=validate_args property mean - Tensor The provided mean circular one loc property mode - Tensor loc lazy_property variance - Tensor type ignore override The provided variance circular one - _log_modified_bessel_fn concentration order= - _log_modified_bessel_fn concentration order= exp
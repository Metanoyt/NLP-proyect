__future__ annotations argparse json logging os re subprocess sys time enum Enum typing NamedTuple LintSeverity str Enum ERROR = error WARNING = warning ADVICE = advice DISABLED = disabled LintMessage NamedTuple path str &#124; None line int &#124; None char int &#124; None code str severity LintSeverity name str original str &#124; None replacement str &#124; None description str &#124; None Note This regex pattern kept reference used pyrefly JSON parsing RESULTS_RE re Pattern str = re compile r mx ^ P file P line \d+ P column - \d+ \s P severity \S+ \s P message \s P code \ \ $ torch _dynamo variables tensor py error INTERNAL ERROR INTERNAL_ERROR_RE re Pattern str = re compile r mx ^ P file P line \d+ \s P severity \S+ \s P message INTERNAL\sERROR $ run_command args list str extra_env dict str str &#124; None retries int - subprocess CompletedProcess bytes logging debug $ s join args start_time = time monotonic try subprocess run args capture_output=True finally end_time = time monotonic logging debug took dms end_time - start_time Severity mapping currently only used stderr internal errors Pyrefly JSON output doesn t include severity so all errors default ERROR severities = error LintSeverity ERROR note LintSeverity ADVICE check_pyrefly_installed code str - list LintMessage cmd = pyrefly -- version try subprocess run cmd check=True capture_output=True except subprocess CalledProcessError e msg = e stderr decode errors= replace LintMessage path=None line=None char=None code=code severity=LintSeverity ERROR name= command-failed original=None replacement=None description=f Could run join cmd msg check_nightly_run code str - list LintMessage Check make setup-env has been run successfully This checks presence pytorch-nightly pth file created when installing nightly binaries type stubs site pathlib Path try site_packages = Path site getsitepackages pth_file = site_packages pytorch-nightly pth pth_file exists LintMessage path=None line=None char=None code=code severity=LintSeverity WARNING name= nightly-wheel-not-run original=None replacement=None description= pytorch-nightly pth found You may need run make setup-env install nightly binaries type stubs except Exception e LintMessage path=None line=None char=None code=code severity=LintSeverity ERROR name= command-failed original=None replacement=None description= f Could check pytorch-nightly e __class__ __name__ \n e in_github_actions - bool bool os getenv GITHUB_ACTIONS check_files code str config str - list LintMessage try pyrefly_commands = pyrefly check -- config config -- output-format=json proc = run_command pyrefly_commands extra_env= retries= except OSError err LintMessage path=None line=None char=None code=code severity=LintSeverity ERROR name= command-failed original=None replacement=None description= f Failed due err __class__ __name__ \n err stdout = str proc stdout utf- strip stderr = str proc stderr utf- strip proc returncode LintMessage path=None line=None char=None code=code severity=LintSeverity ERROR name= command-failed original=None replacement=None description=stderr Parse JSON output pyrefly try stdout result = json loads stdout errors = result get errors errors = For now filter out deprecated warnings only report type errors warnings until we remove mypy errors = error error errors error name = deprecated rc = LintMessage path=error path name=error name description=error get description error get concise_description line=error line char=error column code=code severity=LintSeverity ADVICE uncomment replace when we switch pyrefly severity=LintSeverity ADVICE error name == deprecated LintSeverity ERROR original=None replacement=None error errors except json JSONDecodeError KeyError TypeError e LintMessage path=None line=None char=None code=code severity=LintSeverity ERROR name= json-parse-error original=None replacement=None description=f Failed parse pyrefly JSON output e Still check stderr internal errors rc += LintMessage path=match file name= INTERNAL ERROR description=match message line=int match line char=None code=code severity=severities get match severity LintSeverity ERROR original=None replacement=None match INTERNAL_ERROR_RE finditer stderr rc main - None parser = argparse ArgumentParser description= pyrefly wrapper linter fromfile_prefix_chars= parser add_argument -- code default= PYREFLY help= code lint should report parser add_argument -- verbose action= store_true help= verbose logging parser add_argument -- config required=True help= path mypy ini config file args = parser parse_args logging basicConfig format= threadName s levelname s message s level=logging INFO stream=sys stderr nightly_check = check_nightly_run args code len nightly_check = print json dumps nightly_check _asdict flush=True lint_messages = check_pyrefly_installed args code + check_files args code args config lint_message lint_messages print json dumps lint_message _asdict flush=True __name__ == __main__ main
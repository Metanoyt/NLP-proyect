usr bin env python ruff noqa LOG json logging os re subprocess sys warnings enum Enum functools cache logging info typing Any Callable Optional urllib request Request urlopen yaml REENABLE_TEST_REGEX = i Close d &#124; s &#124; Resolve d &#124; s &#124; Fix ed &#124; es &#124; https github com pytorch pytorch issues - + MAIN_BRANCH = main PREFIX = test-config logging basicConfig level=logging INFO is_cuda_or_rocm_job job_name Optional str - bool job_name False cuda job_name rocm job_name Supported modes when running periodically Only applying mode when its lambda condition returns true SUPPORTED_PERIODICAL_MODES dict str Callable Optional str bool = Memory leak check only needed CUDA ROCm jobs which utilize GPU memory mem_leak_check is_cuda_or_rocm_job rerun_disabled_tests lambda job_name True The link published list disabled jobs DISABLED_JOBS_URL = https ossci-metrics s amazonaws com disabled-jobs json unstable jobs UNSTABLE_JOBS_URL = https ossci-metrics s amazonaws com unstable-jobs json Some constants used handle disabled unstable jobs JOB_NAME_SEP = BUILD_JOB_NAME = build TEST_JOB_NAME = test BUILD_AND_TEST_JOB_NAME = build-and-test JOB_NAME_CFG_REGEX = re compile r P job \w- + \s+\ P cfg \w- + \ EXCLUDED_BRANCHES = nightly MEM_LEAK_LABEL = enable-mem-leak-check IssueType Enum DISABLED = disabled UNSTABLE = unstable parse_args - Any argparse ArgumentParser parser = ArgumentParser Filter all test configurations keep only requested ones parser add_argument -- test-matrix type=str required=True help= original test matrix parser add_argument -- selected-test-configs type=str default= help= comma-separated list test configurations test matrix keep parser add_argument -- workflow type=str help= name current workflow i e pull parser add_argument -- job-name type=str help= name current job i e linux-jammy-py -gcc build parser add_argument -- pr-number type=str help= pull request number parser add_argument -- tag type=str help= associated tag exists parser add_argument -- event-name type=str help= name event triggered job pull schedule etc parser add_argument -- schedule type=str help= cron schedule triggered job parser add_argument -- branch type=str default=MAIN_BRANCH help= branch name parser parse_args cache get_pr_info pr_number int - dict str Any Dynamically get PR information From https docs github com en actions learn-github-actions environment-variables pytorch_repo = os environ get GITHUB_REPOSITORY pytorch pytorch pytorch_github_api = f https api github com repos pytorch_repo github_token = os environ GITHUB_TOKEN headers = Accept application vnd github v +json Authorization f token github_token json_response dict str Any = download_json url=f pytorch_github_api issues pr_number headers=headers json_response warnings warn f Failed get labels pr_number json_response get_labels pr_number int - set str Dynamically get latest list labels pull request pr_info = get_pr_info pr_number label get name label pr_info get labels label get name filter_labels labels set str label_regex Any - set str Return list matching labels l l labels re match label_regex l filter test_matrix dict str list Any labels set str - dict str list Any Select list test config run test matrix The logic works follows If PR has one more test-config labels specified only these test configs will selected This also works ciflow labels example PR has both ciflow trunk test-config functorch only trunk functorch builds tests will run If PR has none test-config label all tests run usual filtered_test_matrix dict str list Any = include entry test_matrix get include config_name = entry get config config_name continue label = f PREFIX config_name strip label labels msg = f Select config_name because label label present pull request time test starts info msg filtered_test_matrix include append entry test_config_labels = filter_labels labels re compile f PREFIX + filtered_test_matrix include test_config_labels info Found no test-config label PR so all test configs included Found no test-config label filtered test matrix empty same test matrix before so all tests can run normally test_matrix msg = f Found test_config_labels PR so only these test configs run info msg When filter test matrix contain matches valid test config label found PR filtered test matrix filtered_test_matrix filter_selected_test_configs test_matrix dict str list Any selected_test_configs set str - dict str list Any Keep only selected configs list empty Otherwise keep all test configs This filter used when workflow dispatched manually selected_test_configs test_matrix filtered_test_matrix dict str list Any = include entry test_matrix get include config_name = entry get config config_name continue config_name selected_test_configs filtered_test_matrix include append entry filtered_test_matrix set_periodic_modes test_matrix dict str list Any job_name Optional str - dict str list Any Apply all periodic modes when running under schedule scheduled_test_matrix dict str list Any = include config test_matrix get include mode cond SUPPORTED_PERIODICAL_MODES items cond job_name continue cfg = config copy cfg mode = mode scheduled_test_matrix include append cfg scheduled_test_matrix mark_unstable_jobs workflow str job_name str test_matrix dict str list Any - dict str list Any Check list unstable jobs mark them accordingly Note job unstable all its dependents will also marked accordingly process_jobs workflow=workflow job_name=job_name test_matrix=test_matrix issue_type=IssueType UNSTABLE url=UNSTABLE_JOBS_URL remove_disabled_jobs workflow str job_name str test_matrix dict str list Any - dict str list Any Check list disabled jobs remove current job all its dependents exists list process_jobs workflow=workflow job_name=job_name test_matrix=test_matrix issue_type=IssueType DISABLED url=DISABLED_JOBS_URL _filter_jobs test_matrix dict str list Any issue_type IssueType target_cfg Optional str = None - dict str list Any An utility function used actually apply job filter The result will stored here filtered_test_matrix dict str list Any = include This issue disable CI job issue_type == IssueType DISABLED If there target config disable remove only target_cfg Remove target config test matrix filtered_test_matrix include = r r test_matrix include r get config = target_cfg filtered_test_matrix issue_type == IssueType UNSTABLE r test_matrix include cpy = r copy target_cfg r get config == target_cfg target_cfg If there target config only mark unstable otherwise mark everything unstable cpy IssueType UNSTABLE value = IssueType UNSTABLE value filtered_test_matrix include append cpy filtered_test_matrix No matching issue everything test_matrix process_jobs workflow str job_name str test_matrix dict str list Any issue_type IssueType url str - dict str list Any Both disabled unstable jobs following format WORKFLOW PLATFORM JOB CONFIG AUTHOR ISSUE_NUMBER ISSUE_URL WORKFLOW PLATFORM JOB CONFIG pull linux-bionic-py -clang test dynamo pytorchbot https github com pytorch pytorch issues pull linux-bionic-py -clang test dynamo try The job name github PLATFORM JOB CONFIG format so breaking into its two components first current_platform _ = n strip n job_name split JOB_NAME_SEP n except ValueError warnings warn f Invalid job name job_name returning test_matrix record download_json url=url headers= values author _ target_url target_workflow target_platform target_job_cfg = record target_workflow = workflow The current workflow doesn t match record continue cleanup_regex = rf - BUILD_JOB_NAME &#124; - TEST_JOB_NAME $ There exception here binary build workflows which platform names have build test suffix For example we have build job called manywheel-py -cuda _ -build build its subsequent test job called manywheel-py -cuda _ -test test So they linked their suffixes different target_platform_no_suffix = re sub cleanup_regex target_platform current_platform_no_suffix = re sub cleanup_regex current_platform target_platform = current_platform target_platform_no_suffix = current_platform_no_suffix The current platform doesn t match record continue The logic after fairly complicated - If target record doesn t have optional job config name i e pull linux-bionic-py -clang all build test jobs will skipped s disabled record marked unstable s unstable record - If target record has job name s build job i e pull linux-bionic-py -clang build all build test jobs will skipped s disabled record marked unstable s unstable record because latter requires former - If target record has job name s test job without config part i e pull linux-bionic-py -clang test all test jobs will skipped s disabled record marked unstable s unstable record - If target record has job config name only test config will skipped marked unstable target_job_cfg msg = f Issue target_url created author has issue_type value + f all CI jobs workflow job_name info msg _filter_jobs test_matrix=test_matrix issue_type=issue_type target_job_cfg == BUILD_JOB_NAME msg = f Issue target_url created author has issue_type value + f build job workflow job_name info msg _filter_jobs test_matrix=test_matrix issue_type=issue_type target_job_cfg TEST_JOB_NAME BUILD_AND_TEST_JOB_NAME msg = f Issue target_url created author has issue_type value + f all test jobs workflow job_name info msg _filter_jobs test_matrix=test_matrix issue_type=issue_type m = JOB_NAME_CFG_REGEX match target_job_cfg m target_job = m group job Make sure job name valid test job name first before checking config target_job TEST_JOB_NAME BUILD_AND_TEST_JOB_NAME target_cfg = m group cfg NB There can multiple unstable configurations i e inductor inductor_huggingface test_matrix = _filter_jobs test_matrix=test_matrix issue_type=issue_type target_cfg=target_cfg warnings warn f Found matching issue_type value issue target_url workflow job_name + f name target_job_cfg invalid Found no matching target same input test matrix test_matrix download_json url str headers dict str str num_retries int = - Any _ range num_retries try req = Request url=url headers=headers content = urlopen req timeout= read decode utf- json loads content except Exception e warnings warn f Could download url e warnings warn f All num_retries retries exhausted downloading url failed set_output name str val Any - None print f Setting output name = val os getenv GITHUB_OUTPUT open str os getenv GITHUB_OUTPUT env print f name = val file=env print f set-output name= name val parse_reenabled_issues s Optional str - list str NB When PR body empty GitHub API returns None value which passed into function s The regex meant match all case-insensitive keywords GitHub has delineated would link PRs issues more details here https docs github com en issues tracking-your-work-with-issues linking-a-pull-request-to-an-issue E g Close fixES RESOLVED would all match closes -- extra space fixing -- keyword nor fix -- no issue_numbers = x x re findall REENABLE_TEST_REGEX s issue_numbers get_reenabled_issues pr_body str = - list str default_branch = f origin os environ get GIT_DEFAULT_BRANCH main try commit_messages = subprocess check_output f git cherry -v default_branch split decode utf- except Exception e warnings warn f failed get commit messages e commit_messages = parse_reenabled_issues pr_body + parse_reenabled_issues commit_messages check_for_setting labels set str body str setting str - bool setting labels f setting body perform_misc_tasks labels set str test_matrix dict str list Any job_name str pr_body str branch Optional str = None tag Optional str = None - None In addition apply filter logic script also does following misc tasks set keep-going is-unstable variables set_output keep-going branch == MAIN_BRANCH bool tag re match r ^trunk a-f - $ tag Pattern tags created via manual run HUD bool tag re match r ^ciflow ^ + a-f - $ tag check_for_setting labels pr_body keep-going set_output ci-verbose-test-logs check_for_setting labels pr_body ci-verbose-test-logs set_output ci-test-showlocals check_for_setting labels pr_body ci-test-showlocals set_output ci-no-test-timeout check_for_setting labels pr_body ci-no-test-timeout set_output ci-no-td check_for_setting labels pr_body ci-no-td Only relevant one linux distributed cuda job delete when TD rolled out completely set_output ci-td-distributed check_for_setting labels pr_body ci-td-distributed Obviously job name includes unstable then unstable job is_unstable = job_name IssueType UNSTABLE value job_name is_unstable test_matrix test_matrix get include Even when job name doesn t mention unstable we will also mark unstable when test matrix only includes unstable jobs Basically logic allows build build-and-test jobs marked unstable too Basically when build job unstable all subsequent test jobs also unstable And when all test jobs unstable we will also treat build job unstable It s simpler way is_unstable = all IssueType UNSTABLE value r r test_matrix include set_output is-unstable is_unstable set_output reenabled-issues join get_reenabled_issues pr_body=pr_body MEM_LEAK_LABEL labels Enable mem leak check label added config test_matrix get include is_cuda_or_rocm_job job_name config mem_leak_check = mem_leak_check main - None args = parse_args Load original test matrix set workflow Its format however doesn t follow strict JSON format so we load using yaml here its more relaxed syntax test_matrix = yaml safe_load args test_matrix test_matrix None warnings warn f Invalid test matrix input args test_matrix exiting We handle invalid test matrix gracefully marking empty set_output is-test-matrix-empty True sys exit pr_number = args pr_number tag = args tag If tag matches we can get PR number ciflow workflow dispatcher tag_regex = re compile r ^ciflow \w\- + P pr_number \d+ $ labels = set pr_number If PR number set query all labels PR labels = get_labels int pr_number Then filter test matrix keep only selected ones filtered_test_matrix = filter test_matrix labels tag m = tag_regex match tag m pr_number = m group pr_number The PR number can also come tag ciflow tag event labels = get_labels int pr_number Filter test matrix keep only selected ones filtered_test_matrix = filter test_matrix labels There tag isn t ciflow so there nothing left do filtered_test_matrix = test_matrix No PR number no tag we can just test matrix filtered_test_matrix = test_matrix args selected_test_configs selected_test_configs = v strip lower v args selected_test_configs split v strip filtered_test_matrix = filter_selected_test_configs filtered_test_matrix selected_test_configs args event_name == schedule args schedule == we don t want run mem leak check disabled tests normal periodically scheduled jobs only ones time filtered_test_matrix = set_periodic_modes filtered_test_matrix args job_name args workflow args job_name args branch EXCLUDED_BRANCHES If both workflow job name available we will check current job disabled remove all its dependants test matrix filtered_test_matrix = remove_disabled_jobs args workflow args job_name filtered_test_matrix filtered_test_matrix = mark_unstable_jobs args workflow args job_name filtered_test_matrix pr_body = get_pr_info int pr_number get body pr_number perform_misc_tasks labels=labels test_matrix=filtered_test_matrix job_name=args job_name pr_body=pr_body pr_body branch=args branch tag=tag Set filtered test matrix output set_output test-matrix json dumps filtered_test_matrix filtered_test_matrix_len = len filtered_test_matrix get include also put flag test matrix empty so subsequent jobs can quickly check without need parse JSON string set_output is-test-matrix-empty filtered_test_matrix_len == __name__ == __main__ main
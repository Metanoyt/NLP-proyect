mypy allow-untyped-defs inspect collections abc Callable functools wraps typing Any get_type_hints Optional Union torch utils data datapipes _typing _DataPipeMeta torch utils data datapipes datapipe IterDataPipe MapDataPipe ###################################################### Functional API ###################################################### functional_datapipe name str __init__ name str enable_df_api_tracing=False - None Define functional datapipe Args enable_df_api_tracing - set any returned DataPipe would accept DataFrames API tracing mode name = name enable_df_api_tracing = enable_df_api_tracing __call__ cls issubclass cls IterDataPipe isinstance cls type type ignore arg-type isinstance cls _DataPipeMeta raise TypeError ` functional_datapipe ` can only decorate IterDataPipe non_deterministic decorator isinstance cls non_deterministic hasattr cls __self__ isinstance cls __self__ non_deterministic raise TypeError ` functional_datapipe ` can only decorate IterDataPipe IterDataPipe register_datapipe_as_function name cls enable_df_api_tracing=self enable_df_api_tracing issubclass cls MapDataPipe MapDataPipe register_datapipe_as_function name cls cls ###################################################### Determinism ###################################################### _determinism bool = False guaranteed_datapipes_determinism prev bool __init__ - None global _determinism prev = _determinism _determinism = True __enter__ - None pass __exit__ exc_type Any exc_value Any traceback Any - None global _determinism _determinism = prev non_deterministic cls Optional type IterDataPipe = None TODO Lambda picking deterministic_fn Callable bool __init__ arg Union type IterDataPipe Callable bool - None Decorator doesn t have any argument isinstance arg type type ignore arg-type issubclass arg IterDataPipe type ignore arg-type raise TypeError Only ` IterDataPipe ` can decorated ` non_deterministic ` f arg __name__ found cls = arg type ignore assignment Decorator has argument function This should behave differently given different inputs Use function verify determinism each instance When function returns True instance non-deterministic Otherwise instance deterministic DataPipe isinstance arg Callable type ignore arg-type deterministic_fn = arg raise TypeError f arg can decorated non_deterministic __call__ args kwargs global _determinism Decorate IterDataPipe cls None _determinism raise TypeError f cls __name__ non-deterministic you set guaranteed_datapipes_determinism You can turn off determinism DataPipe acceptable your application cls args kwargs type ignore call-arg Decorate functional argument isinstance args type issubclass args IterDataPipe type ignore arg-type raise TypeError f Only ` IterDataPipe ` can decorated args __name__ found cls = args deterministic_wrapper_fn deterministic_wrapper_fn args kwargs - IterDataPipe res = deterministic_fn args kwargs isinstance res bool raise TypeError deterministic_fn ` non_deterministic ` decorator required f boolean value type res found global _determinism _determinism res raise TypeError f cls __name__ non-deterministic inputs you set type ignore union-attr guaranteed_datapipes_determinism You can turn off determinism DataPipe acceptable your application cls args kwargs type ignore call-arg misc ###################################################### Type validation ###################################################### Validate each argument DataPipe hint subtype hint argument_validation f signature = inspect signature f hints = get_type_hints f wraps f wrapper args kwargs bound = signature bind args kwargs argument_name value bound arguments items argument_name hints isinstance hints argument_name _DataPipeMeta hint = hints argument_name isinstance value IterDataPipe raise TypeError f Expected argument argument_name IterDataPipe found type value value type issubtype hint type raise TypeError f Expected type argument argument_name subtype f hint hint type found value type f args kwargs wrapper Default value True _runtime_validation_enabled bool = True runtime_validation_disabled prev bool __init__ - None global _runtime_validation_enabled prev = _runtime_validation_enabled _runtime_validation_enabled = False __enter__ - None pass __exit__ exc_type Any exc_value Any traceback Any - None global _runtime_validation_enabled _runtime_validation_enabled = prev Runtime checking Validate output data subtype hint runtime_validation f TODO Can extended validate __getitem__ nonblocking f __name__ = __iter__ raise TypeError f Can decorate function f __name__ runtime_validation wraps f wrapper global _runtime_validation_enabled _runtime_validation_enabled yield f = f d type issubtype_of_instance d raise RuntimeError f Expected instance subtype type found d type d yield d wrapper
__future__ annotations json os re time collections defaultdict functools lru_cache pathlib Path tempfile TemporaryDirectory typing Any cast requests tools stats upload_stats_lib _get_request_headers download_s _artifacts get_job_id get_s _resource unzip upload_workflow_stats_to_s REGEX_JOB_INFO = r \ test \ ^ \ lru_cache maxsize= get_job_name job_id int - str try cast str requests get f https api github com repos pytorch pytorch actions jobs job_id headers=_get_request_headers json name except Exception e print f Failed get job name job id job_id e NoJobName lru_cache maxsize= get_build_name job_name str - str try re match REGEX_JOB_INFO job_name group type ignore union-attr except AttributeError print f Failed match job name job_name NoBuildEnv lru_cache maxsize= get_test_config job_name str - str try re match REGEX_JOB_INFO job_name group type ignore union-attr except AttributeError print f Failed match job name job_name NoTestConfig get_td_exclusions workflow_run_id int workflow_run_attempt int - dict str Any TemporaryDirectory temp_dir print Using temporary directory temp_dir os chdir temp_dir Download extract all reports both GHA S s _paths = download_s _artifacts test-jsons workflow_run_id workflow_run_attempt path s _paths unzip path grouped_tests dict str Any = defaultdict lambda defaultdict set td_exclusions Path glob td_exclusions json open td_exclusions f exclusions = json load f exclusion exclusions excluded job_id = get_job_id td_exclusions job_name = get_job_name job_id build_name = get_build_name job_name test_config = get_test_config job_name grouped_tests build_name test_config add exclusion test_file build_name build grouped_tests items test_config test_files build items grouped_tests build_name test_config = sorted test_files grouped_tests group_test_cases test_cases list dict str Any - list list dict str Any Returns list lists Each inner list contains test cases same build name test config file name name test name ex run multiple times start = time time test_case_with_job_info = defaultdict list test_case test_cases job_name = get_job_name test_case job_id build_name = get_build_name job_name bazel build_name continue test_config = get_test_config job_name test_case job_name = job_name test_case build_name = build_name test_case test_config = test_config key = build_name test_config test_case get file NoFile test_case get classname NoClass test_case get name NoName test_case_with_job_info key append test_case print f Time taken group tests time time - start list test_case_with_job_info values get_reruns grouped_tests list list dict str Any - dict str Any reruns dict str Any = defaultdict lambda defaultdict lambda defaultdict lambda defaultdict lambda defaultdict list tests grouped_tests len tests build_name = tests build_name test_config = tests test_config file = tests get file NoFile class_name = tests get classname NoClass test_name = tests get name NoName file distributed test_distributed_spawn py onnx test_fx_to_onnx_with_onnxruntime py distributed algorithms quantization test_quantization py continue reruns build_name test_config file class_name test_name = tests reruns get_invoking_file_summary grouped_tests list list dict str Any - dict str Any summary_flat = tests grouped_tests build_name = tests build_name test_config = tests test_config short_job_name = f build_name test test_config file = tests get file NoFile key = build_name test_config file key summary_flat summary_flat key = count time skipped failures errors successes short_job_name short_job_name file file summary_flat key count += status = successes test tests summary_flat key time += test time skipped test status = skipped failure test status = failures error test status = errors summary_flat key status += invoking_file_summary dict str Any = defaultdict lambda defaultdict lambda defaultdict lambda count time build_name test_config file data summary_flat items invoking_file_summary build_name test_config file = data invoking_file_summary get_all_run_attempts workflow_run_id int - list int Returns all run attempts given workflow run id have test artifacts bucket = get_s _resource Bucket gha-artifacts prefix = f pytorch pytorch workflow_run_id objs = bucket objects filter Prefix=prefix run_attempts = set obj objs no_prefix = obj key len prefix try run_attempt = int no_prefix split run_attempts add run_attempt except ValueError continue sorted run_attempts get_test_status test_cases list list dict str Any - list dict str Any Returns list dicts test status info flaky success failure skipped only_status_info = tests test_cases build_name = tests build_name test_config = tests test_config short_job_name = f build_name test test_config file = tests get file NoFile statuses = test tests skipped test statuses append skipped failure test error test statuses append failure statuses append success failure statuses success statuses status = flaky status = statuses only_status_info append short_job_name short_job_name file file name test name status status only_status_info upload_additional_info workflow_run_id int workflow_run_attempt int test_cases list dict str Any - None grouped_tests = group_test_cases test_cases reruns = get_reruns grouped_tests exclusions = get_td_exclusions workflow_run_id workflow_run_attempt invoking_file_summary = get_invoking_file_summary grouped_tests upload_workflow_stats_to_s workflow_run_id workflow_run_attempt additional_info reruns reruns upload_workflow_stats_to_s workflow_run_id workflow_run_attempt additional_info td_exclusions exclusions upload_workflow_stats_to_s workflow_run_id workflow_run_attempt additional_info invoking_file_summary invoking_file_summary upload_workflow_stats_to_s workflow_run_id workflow_run_attempt additional_info test_status get_test_status grouped_tests
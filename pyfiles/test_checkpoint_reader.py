Owner s oncall distributed checkpointing os shutil tempfile typing Any torch torch distributed checkpoint _experimental checkpoint_reader CheckpointReader torch distributed checkpoint _experimental types RankInfo torch testing _internal common_utils run_tests TestCase TestCheckpointReader TestCase setUp Create temporary directory test checkpoints temp_dir = tempfile mkdtemp Create test objects rank_info = RankInfo global_rank= global_world_size= Create checkpoint reader reader = CheckpointReader rank_info=self rank_info Create test state dictionary state_dict = model weight torch randn bias torch randn test_list torch randn torch randn optimizer param_groups lr test_list torch randn torch randn epoch step Create test checkpoint file checkpoint_path = os path join temp_dir checkpoint os makedirs checkpoint_path exist_ok=True checkpoint_file = os path join checkpoint_path f checkpoint_ rank_info global_rank pt torch save state_dict checkpoint_file move_tensors_to_device state_dict Any device str - Any Recursively move all tensors nested dictionary CUDA Args state_dict dict A dictionary potentially containing nested dictionaries tensors Returns dict A new dictionary all tensors moved CUDA isinstance state_dict dict key move_tensors_to_device value device key value state_dict items isinstance state_dict list move_tensors_to_device item device item state_dict isinstance state_dict torch Tensor state_dict cuda device == cpu state_dict cpu state_dict deep_compare obj Any obj Any - bool isinstance obj dict isinstance obj dict obj keys = obj keys False all deep_compare obj key obj key key obj isinstance obj list tuple isinstance obj list tuple len obj = len obj False all deep_compare item item item item zip obj obj isinstance obj torch Tensor isinstance obj torch Tensor torch equal obj obj obj == obj tearDown Clean up temporary directory shutil rmtree temp_dir test_read_checkpoint Test read correctly reads checkpoint file Call read read_state_dict missing_keys = reader read checkpoint_path assertEqual missing_keys Verify read state dictionary contains expected values assertIn model read_state_dict assertIn optimizer read_state_dict assertTrue deep_compare read_state_dict state_dict No hooks verify since we removed them test_read_with_map_location Test read correctly uses map_location parameter Call read map_location= cpu map_location = cuda torch cuda is_available cpu read_state_dict _ = reader read checkpoint_path map_location=map_location Verify read state dictionary contains expected values assertIn model read_state_dict assertIn optimizer read_state_dict assertEqual read_state_dict epoch assertEqual read_state_dict step assertEqual read_state_dict model weight device type map_location read_state_dict _ = reader read checkpoint_path map_location=map_location Verify read state dictionary contains expected values assertIn model read_state_dict assertIn optimizer read_state_dict assertEqual read_state_dict epoch assertEqual read_state_dict step assertEqual read_state_dict model weight device type map_location test_read_nonexistent_checkpoint Test read raises FileNotFoundError nonexistent checkpoint Set up path nonexistent checkpoint nonexistent_path = os path join temp_dir nonexistent_checkpoint Call read expect FileNotFoundError assertRaises FileNotFoundError reader read nonexistent_path test_read_with_kwargs Test read correctly passes kwargs Call read additional kwargs kwargs = extra value reader read checkpoint_path kwargs test_partial_read Test read state_dict correctly loads only requested keys Create partial state dictionary only some keys partial_state_dict = partial_state_dict optimizer = None partial_state_dict model = weight torch randn partial_state_dict epoch = None Call read state_dict updated_state_dict _ = reader read checkpoint_path partial_state_dict Verify updated state dictionary contains values both dictionaries assertIn model updated_state_dict assertIn epoch updated_state_dict assertTrue torch equal updated_state_dict model weight state_dict model weight assertTrue deep_compare updated_state_dict optimizer state_dict optimizer assertEqual updated_state_dict epoch From checkpoint assertNotIn bias updated_state_dict model assertNotIn step updated_state_dict test_partial_read_missing_keys Test partial_read correctly reports missing keys Create partial state dictionary keys don t exist checkpoint partial_state_dict = model None nonexistent_key None This key doesn t exist checkpoint another_missing_key nested None This key also doesn t exist Call read state_dict _ missing_keys = reader read checkpoint_path partial_state_dict Verify missing keys correctly reported assertIn nonexistent_key missing_keys assertIn another_missing_key missing_keys Verify keys exist checkpoint missing_keys assertNotIn model missing_keys test_partial_read_different_dtypes Test partial_read correctly handles different tensor dtypes Create state dictionary tensors different dtypes dtype_state_dict = float torch randn dtype=torch float float torch randn dtype=torch float int torch randint - dtype=torch int int torch randint - dtype=torch int bool torch randint dtype=torch bool Save state dictionary dtype_checkpoint_path = os path join temp_dir dtype_checkpoint os makedirs dtype_checkpoint_path exist_ok=True checkpoint_file = os path join dtype_checkpoint_path f checkpoint_ rank_info global_rank pt torch save dtype_state_dict checkpoint_file Create partial state dictionary requesting tensors each dtype partial_state_dict = float torch randn dtype=torch float float None int None int None bool None Load partial state dictionary updated_state_dict _ = reader read os path dirname checkpoint_file partial_state_dict Verify tensors each dtype loaded correctly key dtype_state_dict assertIn key updated_state_dict assertEqual updated_state_dict key dtype dtype_state_dict key dtype assertTrue torch allclose updated_state_dict key dtype_state_dict key __name__ == __main__ run_tests
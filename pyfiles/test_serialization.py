Owner s oncall distributed os pickle io BytesIO typing cast torch torch distributed dist torch distributed _serialization _streaming_load _streaming_save torch distributed tensor DeviceMesh distribute_tensor DTensor torch testing _internal common_utils requires_cuda run_tests TestCase DEBUG_ENV = TORCH_SERIALIZATION_DEBUG MyClass __init__ int - None = __eq__ other MyClass - bool == other TestSerialization TestCase setUp - None disable debug asserts _old_debug = os environ get DEBUG_ENV os environ DEBUG_ENV = tearDown _old_debug None os environ DEBUG_ENV = _old_debug test_scalar_tensor - None tensor = torch tensor dtype=torch int state_dict = scalar tensor file = BytesIO _streaming_save state_dict file file seek result = _streaming_load file torch testing assert_close result state_dict test_strided_tensor - None base_tensor = torch arange dtype=torch float reshape strided_tensor = base_tensor state_dict = strided strided_tensor file = BytesIO _streaming_save state_dict file file seek result = _streaming_load file torch testing assert_close result state_dict test_tensor_with_offset - None state_dict = offset torch arange dtype=torch float strided torch arange dtype=torch float file = BytesIO _streaming_save state_dict file file seek result = _streaming_load file torch testing assert_close result state_dict test_nested_tensors - None tensor = torch tensor dtype=torch int tensor = torch tensor dtype=torch float state_dict = nested tensor tensor tensor tensor file = BytesIO _streaming_save state_dict file file seek result = _streaming_load file torch testing assert_close result state_dict test_various_data_types - None tensor_float = torch tensor dtype=torch float tensor_int = torch tensor dtype=torch int tensor_bool = torch tensor True False True dtype=torch bool tensor_uint = torch tensor True False True dtype=torch uint state_dict = float tensor_float int tensor_int bool tensor_bool uint tensor_uint file = BytesIO _streaming_save state_dict file file seek result = _streaming_load file torch testing assert_close result state_dict test_empty_tensor - None state_dict = empty torch zeros file = BytesIO _streaming_save state_dict file file seek result = _streaming_load file weights_only=False assertEqual result state_dict test_dtensor - None dist init_process_group backend= gloo rank= world_size= store=dist HashStore device_mesh = DeviceMesh cpu tensor = torch randn dtensor = distribute_tensor tensor device_mesh state_dict = dtensor file = BytesIO _streaming_save state_dict file file seek result = cast DTensor _streaming_load file torch testing assert_close result to_local state_dict to_local assertEqual result _spec state_dict _spec test_python_object - None state_dict = obj MyClass file = BytesIO _streaming_save state_dict file file seek result = _streaming_load file weights_only=False assertEqual result state_dict test_str_utf - None state_dict = obj Ãœ file = BytesIO _streaming_save state_dict file file seek result = _streaming_load file assertEqual result state_dict test_weights_only - None state_dict = obj MyClass file = BytesIO _streaming_save state_dict file file seek assertRaisesRegex pickle UnpicklingError allowed global _streaming_load file assertRaisesRegex RuntimeError explicit pickle_module _streaming_load file weights_only=True pickle_module=pickle requires_cuda test_cuda - None device = torch device cuda tensor = torch tensor dtype=torch float device=device state_dict = scalar tensor file = BytesIO _streaming_save state_dict file file seek result = _streaming_load file torch testing assert_close result state_dict assertEqual result scalar device device __name__ == __main__ run_tests
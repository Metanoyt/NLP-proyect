collections defaultdict typing Optional torch torch fx fx torch utils _ordered_set OrderedSet AugmentedGraphHelper Graph helper augments original graph additional dependencies uses plus tracks node equivalences coalescing TODO becomes too large compile time consider binding graphcycles cc __init__ graph fx Graph node_ancestors Optional dict fx Node OrderedSet fx Node = None Each node starts its own singleton set graph = graph merge_sets = node OrderedSet node node graph nodes Extra dependencies node depends dep dep must come before node extra_deps dict fx Node OrderedSet fx Node = defaultdict OrderedSet Extra uses reverse extra_deps node used user extra_uses dict fx Node OrderedSet fx Node = defaultdict OrderedSet Note only reflect original ancestors maintained through additional deps merge sets node_ancestors = node_ancestors add_extra_dep n fx Node dep fx Node - None Add extra dependency node depends dep extra_deps n add dep extra_uses dep add n remove_extra_dep n fx Node dep fx Node - None dep extra_deps n extra_deps n discard dep extra_uses dep discard n merge_to_set existing_node fx Node new_node fx Node - None Merge new_node into existing_node s set The new node must singleton set existing_set = merge_sets existing_node new_set = merge_sets new_node assert len new_set == Add all nodes new_set existing_set existing_set update new_set Update all nodes new_set point existing_set node new_set merge_sets node = existing_set unmerge_node node fx Node - None Remove node its merge set making singleton old_set = merge_sets node If already singleton nothing do len old_set == Remove old set old_set remove node Make node singleton merge_sets node = OrderedSet node get_merged_deps node fx Node - OrderedSet fx Node Get all dependencies node considering merges extra deps Combines Direct deps all_input_nodes node its merge equivalents Extra deps node its merge equivalents deps OrderedSet fx Node = OrderedSet For each node merge set merged_node merge_sets node Add direct dependencies all_input_nodes deps update merged_node all_input_nodes Add extra dependencies deps update extra_deps merged_node deps has_cycle - bool merged_deps = n get_merged_deps n n graph nodes torch _dynamo graph_deduplication _has_cycle graph merged_deps has_path source fx Node target fx Node - bool Check there s path source target we should checking path node itself assert merge_sets source merge_sets target search backwards target source visited OrderedSet fx Node = OrderedSet queue = target visited add target while queue current = queue pop dep get_merged_deps current Check we reached source its equivalent dep merge_sets source True dep visited continue We searching target so node necessarily ancestor target If dep ancestor source any path through dep source would imply cycle node_ancestors source_set = merge_sets source is_ancestor_of_source = any dep node_ancestors s s source_set Add visited avoid recomputing check we see dep again is_ancestor_of_source visited add dep continue visited add dep queue append dep False transfer_erased_node_deps erased_to_new dict fx Node fx Node - None Transfer all extra dependencies erased nodes their replacements handling cross-dependencies between erased nodes correctly erased_merge_sets dict fx Node fx Node = replaced new erased_to_new items equiv merge_sets replaced erased_merge_sets equiv = new Transfer dependencies old_node new_node erased_merge_sets items Transfer dependencies FROM old_node what old_node depended extra_dep extra_deps old_node Redirect dep also being erased updated_dep = erased_merge_sets get extra_dep extra_dep extra_deps new_node add updated_dep extra_uses updated_dep discard old_node extra_uses updated_dep add new_node Transfer dependencies TO old_node what depended old_node extra_use extra_uses old_node Redirect user also being erased updated_use = erased_merge_sets get extra_use extra_use Update user s deps point new_node extra_deps updated_use discard old_node extra_deps updated_use add new_node extra_uses new_node add updated_use Clean up erased nodes old_node erased_merge_sets keys extra_deps old_node clear extra_uses old_node clear del merge_sets old_node get_all_extra_deps - dict fx Node OrderedSet fx Node Get all extra dependencies format suitable topological sort Returns copy avoid external modifications node OrderedSet deps node deps extra_deps items deps Only include nodes non-empty deps
__future__ annotations gzip inspect json sys unittest pathlib Path typing Any unittest mock REPO_ROOT = Path __file__ resolve parents sys path insert str REPO_ROOT tools stats upload_metrics add_global_metric emit_metric global_metrics tools stats upload_stats_lib get_s _resource remove_nan_inf sys path remove str REPO_ROOT default values REPO = some repo BUILD_ENV = cuda- TEST_CONFIG = test-config WORKFLOW = some-workflow JOB = some-job RUN_ID = RUN_NUMBER = RUN_ATTEMPT = PR_NUMBER = JOB_ID = JOB_NAME = some-job-name mock patch boto resource TestUploadStats unittest TestCase emitted_metric dict str Any = did_not_emit True mock_put_item kwargs Any - None Utility mocking putting items into s THis will save emitted metric so tests can check emitted_metric = json loads gzip decompress kwargs Body decode utf- Before each test set env vars their default values setUp - None get_s _resource cache_clear global_metrics clear mock patch dict os environ CI true BUILD_ENVIRONMENT BUILD_ENV TEST_CONFIG TEST_CONFIG GITHUB_REPOSITORY REPO GITHUB_WORKFLOW WORKFLOW GITHUB_JOB JOB GITHUB_RUN_ID str RUN_ID GITHUB_RUN_NUMBER str RUN_NUMBER GITHUB_RUN_ATTEMPT str RUN_ATTEMPT JOB_ID str JOB_ID JOB_NAME str JOB_NAME clear=True Don t read any preset env vars start test_emits_default_and_given_metrics mock_resource Any - None metric = some_number float_number Querying instead hard coding b c will change based whether we run test directly python pytest current_module = inspect getmodule inspect currentframe __name__ type ignore union-attr emit_should_include = metric_name metric_name calling_file test_upload_stats_lib py calling_module current_module calling_function test_emits_default_and_given_metrics repo REPO workflow WORKFLOW build_environment BUILD_ENV job JOB test_config TEST_CONFIG run_id RUN_ID run_number RUN_NUMBER run_attempt RUN_ATTEMPT job_id JOB_ID job_name JOB_NAME info metric mock_resource return_value Object return_value put = mock_put_item emit_metric metric_name metric assertEqual emitted_metric emitted_metric emit_should_include test_when_global_metric_specified_then_it_emits_it mock_resource Any - None metric = some_number global_metric_name = global_metric global_metric_value = global_value add_global_metric global_metric_name global_metric_value emit_should_include = metric global_metric_name global_metric_value mock_resource return_value Object return_value put = mock_put_item emit_metric metric_name metric assertEqual emitted_metric emitted_metric info emit_should_include test_when_local_and_global_metric_specified_then_global_is_overridden mock_resource Any - None global_metric_name = global_metric global_metric_value = global_value local_override = local_override add_global_metric global_metric_name global_metric_value metric = some_number global_metric_name local_override emit_should_include = metric global_metric_name local_override mock_resource return_value Object return_value put = mock_put_item emit_metric metric_name metric assertEqual emitted_metric emitted_metric info emit_should_include test_when_optional_envvar_set_to_actual_value_then_emit_vars_emits_it mock_resource Any - None metric = some_number emit_should_include = info metric pr_number PR_NUMBER mock patch dict os environ PR_NUMBER str PR_NUMBER start mock_resource return_value Object return_value put = mock_put_item emit_metric metric_name metric assertEqual emitted_metric emitted_metric emit_should_include test_when_optional_envvar_set_to_a_empty_str_then_emit_vars_ignores_it mock_resource Any - None metric = some_number emit_should_include dict str Any = metric copy Github Actions defaults some env vars empty string default_val = mock patch dict os environ PR_NUMBER default_val start mock_resource return_value Object return_value put = mock_put_item emit_metric metric_name metric assertEqual emitted_metric emitted_metric info emit_should_include f Metrics should emitted when option parameter set default_val assertFalse emitted_metric get pr_number f Metrics should include optional item pr_number when s envvar set default_val test_no_metrics_emitted_if_required_env_var_not_set mock_resource Any - None metric = some_number mock patch dict os environ CI true BUILD_ENVIRONMENT BUILD_ENV clear=True start mock_resource return_value Object return_value put = mock_put_item emit_metric metric_name metric assertTrue emitted_metric did_not_emit test_no_metrics_emitted_if_required_env_var_set_to_empty_string mock_resource Any - None metric = some_number mock patch dict os environ GITHUB_JOB start mock_resource return_value Object return_value put = mock_put_item emit_metric metric_name metric assertTrue emitted_metric did_not_emit test_remove_nan_inf _mocked_resource Any - None checks = float inf inf Infinity float nan nan NaN float inf inf Infinity float nan nan NaN float nan nan NaN input clean unclean checks clean_output = json dumps remove_nan_inf input unclean_output = json dumps input assertEqual clean_output clean f Expected clean when input unclean got clean_output assertEqual unclean_output unclean f Expected unclean when input unclean got unclean_output __name__ == __main__ unittest main
__future__ annotations functools random sys unittest collections defaultdict pathlib Path REPO_ROOT = Path __file__ resolve parents try using tools optimize test run sys path append str REPO_ROOT tools testing test_run ShardedTest TestRun tools testing test_selections calculate_shards THRESHOLD except ModuleNotFoundError print Can t required modules exiting sys exit gen_class_times test_times dict str float - dict str dict str float k v k v test_times items TestCalculateShards unittest TestCase tests list TestRun = TestRun super_long_test TestRun long_test TestRun long_test TestRun normal_test TestRun normal_test TestRun normal_test TestRun short_test TestRun short_test TestRun short_test TestRun short_test TestRun short_test test_times dict str float = super_long_test long_test long_test normal_test normal_test normal_test short_test short_test short_test short_test short_test test_class_times dict str dict str float = super_long_test long_test long_test normal_test normal_test normal_test short_test short_test short_test short_test short_test assert_shards_equal expected_shards list tuple float list ShardedTest actual_shards list tuple float list ShardedTest - None expected actual zip expected_shards actual_shards assertAlmostEqual expected actual assertListEqual expected actual test_no_times - None Check round robin sharding used when no times provided expected_shards = ShardedTest test= super_long_test shard= num_shards= time=None ShardedTest test= long_test shard= num_shards= time=None ShardedTest test= normal_test shard= num_shards= time=None ShardedTest test= short_test shard= num_shards= time=None ShardedTest test= short_test shard= num_shards= time=None ShardedTest test= short_test shard= num_shards= time=None ShardedTest test= long_test shard= num_shards= time=None ShardedTest test= normal_test shard= num_shards= time=None ShardedTest test= normal_test shard= num_shards= time=None ShardedTest test= short_test shard= num_shards= time=None ShardedTest test= short_test shard= num_shards= time=None assert_shards_equal expected_shards calculate_shards tests sort_by_time=False test_some_times_with_not_sort_by_time - None expected_shards = ShardedTest test= test_ shard= num_shards= time=None ShardedTest test= test_ shard= num_shards= time= ShardedTest test= test_ shard= num_shards= time=None ShardedTest test= test_ shard= num_shards= time= ShardedTest test= test_ shard= num_shards= time=None assert_shards_equal expected_shards calculate_shards TestRun test_ TestRun test_ TestRun test_ TestRun test_ TestRun test_ test_ test_ sort_by_time=False test_serial_parallel_interleaving - None expected_shards = ShardedTest test= test_ shard= num_shards= time=None ShardedTest test= test_ shard= num_shards= time= ShardedTest test= test_ shard= num_shards= time=None ShardedTest test= test_ shard= num_shards= time= ShardedTest test= test_ shard= num_shards= time=None assert_shards_equal expected_shards calculate_shards TestRun test_ TestRun test_ TestRun test_ TestRun test_ TestRun test_ test_ test_ must_serial=lambda x x test_ test_ sort_by_time=False test_calculate_ _shards_with_complete_test_times - None expected_shards = ShardedTest test= super_long_test shard= num_shards= time= ShardedTest test= normal_test shard= num_shards= time= ShardedTest test= long_test shard= num_shards= time= ShardedTest test= long_test shard= num_shards= time= ShardedTest test= normal_test shard= num_shards= time= ShardedTest test= normal_test shard= num_shards= time= ShardedTest test= short_test shard= num_shards= time= ShardedTest test= short_test shard= num_shards= time= ShardedTest test= short_test shard= num_shards= time= ShardedTest test= short_test shard= num_shards= time= ShardedTest test= short_test shard= num_shards= time= assert_shards_equal expected_shards calculate_shards tests test_times test_class_times test_calculate_ _shard_with_complete_test_times - None tests = tests copy class_test = TestRun long_test excluded= class_test = TestRun long_test included= tests append class_test tests append class_test expected_shards = ShardedTest test= super_long_test shard= num_shards= time= ShardedTest test= long_test shard= num_shards= time= ShardedTest class_test shard= num_shards= time= ShardedTest test= long_test shard= num_shards= time= ShardedTest test= normal_test shard= num_shards= time= ShardedTest test= normal_test shard= num_shards= time= ShardedTest test= normal_test shard= num_shards= time= ShardedTest test= short_test shard= num_shards= time= ShardedTest class_test shard= num_shards= time= ShardedTest test= short_test shard= num_shards= time= ShardedTest test= short_test shard= num_shards= time= ShardedTest test= short_test shard= num_shards= time= ShardedTest test= short_test shard= num_shards= time= assert_shards_equal expected_shards calculate_shards tests test_times test_class_times test_calculate_ _shards_with_complete_test_times - None expected_shards = ShardedTest test= super_long_test shard= num_shards= time= ShardedTest test= long_test shard= num_shards= time= ShardedTest test= long_test shard= num_shards= time= ShardedTest test= normal_test shard= num_shards= time= ShardedTest test= short_test shard= num_shards= time= ShardedTest test= short_test shard= num_shards= time= ShardedTest test= short_test shard= num_shards= time= ShardedTest test= short_test shard= num_shards= time= ShardedTest test= short_test shard= num_shards= time= ShardedTest test= normal_test shard= num_shards= time= ShardedTest test= normal_test shard= num_shards= time= assert_shards_equal expected_shards calculate_shards tests test_times test_class_times test_calculate_ _shards_with_incomplete_test_times - None incomplete_test_times = k v k v test_times items test k expected_shards = ShardedTest test= long_test shard= num_shards= time= ShardedTest test= super_long_test shard= num_shards= time=None ShardedTest test= normal_test shard= num_shards= time=None ShardedTest test= short_test shard= num_shards= time=None ShardedTest test= short_test shard= num_shards= time=None ShardedTest test= normal_test shard= num_shards= time= ShardedTest test= short_test shard= num_shards= time= ShardedTest test= long_test shard= num_shards= time=None ShardedTest test= normal_test shard= num_shards= time=None ShardedTest test= short_test shard= num_shards= time=None ShardedTest test= short_test shard= num_shards= time=None assert_shards_equal expected_shards calculate_shards tests incomplete_test_times gen_class_times incomplete_test_times test_calculate_ _shards_with_incomplete_test_times - None incomplete_test_times = k v k v test_times items test k expected_shards = ShardedTest test= long_test shard= num_shards= time= ShardedTest test= super_long_test shard= num_shards= time=None ShardedTest test= short_test shard= num_shards= time=None ShardedTest test= normal_test shard= num_shards= time= ShardedTest test= long_test shard= num_shards= time=None ShardedTest test= short_test shard= num_shards= time=None ShardedTest test= short_test shard= num_shards= time= ShardedTest test= normal_test shard= num_shards= time=None ShardedTest test= short_test shard= num_shards= time=None ShardedTest test= normal_test shard= num_shards= time=None ShardedTest test= short_test shard= num_shards= time=None assert_shards_equal expected_shards calculate_shards tests incomplete_test_times gen_class_times incomplete_test_times test_split_shards - None test_times dict str float = test THRESHOLD test THRESHOLD expected_shards = ShardedTest test= test shard= num_shards= time=THRESHOLD ShardedTest test= test shard= num_shards= time=THRESHOLD assert_shards_equal expected_shards calculate_shards TestRun t t test_times keys test_times gen_class_times test_times test_times = test THRESHOLD test THRESHOLD expected_shards = ShardedTest test= test shard= num_shards= time= ShardedTest test= test shard= num_shards= time= ShardedTest test= test shard= num_shards= time= ShardedTest test= test shard= num_shards= time= ShardedTest test= test shard= num_shards= time= ShardedTest test= test shard= num_shards= time= ShardedTest test= test shard= num_shards= time= assert_shards_equal expected_shards calculate_shards TestRun t t test_times keys test_times gen_class_times test_times test_times = test THRESHOLD test THRESHOLD expected_shards = ShardedTest test= test shard= num_shards= time=THRESHOLD ShardedTest test= test shard= num_shards= time=THRESHOLD assert_shards_equal expected_shards calculate_shards TestRun t t test_times keys test_times gen_class_times test_times test_zero_tests - None assertListEqual calculate_shards None test_split_shards_random - None random seed _ range num_shards = random randint num_tests = random randint test_names = str i i range num_tests tests = TestRun x x test_names serial = x x test_names random randint == has_times = x x test_names random randint == random_times dict str float = i random randint THRESHOLD i has_times sort_by_time = random randint == shards = calculate_shards num_shards tests random_times None must_serial=lambda x x serial sort_by_time=sort_by_time times = x x shards max_diff = max times - min times assertTrue max_diff = THRESHOLD + num_tests - len has_times all_sharded_tests dict str list ShardedTest = defaultdict list _ sharded_tests shards sharded_test sharded_tests all_sharded_tests sharded_test name append sharded_test Check all test files represented shards assertListEqual sorted test_names sorted all_sharded_tests keys Check each test file pytest shards times adds up original all shards present test sharded_tests all_sharded_tests items random_times get test None assertTrue len sharded_tests == assertTrue sharded_tests time None x time None because above check assertAlmostEqual random_times test sum x time x sharded_tests type ignore misc assertListEqual list range sharded_tests num_shards sorted x shard - x sharded_tests Check sort_by_time respected sort_by_time comparator ShardedTest b ShardedTest - int serial comes first name serial b name serial - name serial b name serial known test times come first time None b time None - time None b time None time == b time None due above checks - time b time type ignore operator comparator ShardedTest b ShardedTest - int serial comes first name serial b name serial - name serial b name serial test_names index name - test_names index b name _ sharded_tests shards assertListEqual sorted sharded_tests key=functools cmp_to_key comparator sharded_tests test_calculate_ _shards_against_optimal_shards - None random seed _ range random_times = k test_file random random k tests all test times except first two rest_of_tests = i k i random_times items k = super_long_test k = long_test sum_of_rest = sum rest_of_tests random_times super_long_test = max sum_of_rest rest_of_tests random_times long_test = sum_of_rest - random_times super_long_test An optimal sharding would look like below we don t need compute test optimal_shards = sum_of_rest super_long_test long_test sum_of_rest i i tests i = super_long_test i = long_test calculated_shards = calculate_shards tests random_times gen_class_times random_times max_shard_time = max calculated_shards calculated_shards sum_of_rest = The calculated shard should have ratio worse than num_shards = assertGreaterEqual max_shard_time sum_of_rest sorted_tests = sorted t test_file t tests sorted_shard_tests = sorted calculated_shards + calculated_shards All tests should represented some shard assertEqual sorted_tests x name x sorted_shard_tests __name__ == __main__ unittest main
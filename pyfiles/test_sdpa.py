Owner s module dynamo contextlib torch _dynamo test_case torch _dynamo testing torch _dynamo testing CompileCounter torch backends cuda SDPAParams torch nn attention _cur_sdpa_kernel_backends sdpa_kernel SDPBackend contextlib contextmanager allow_in_graph_sdpa_params global SDPAParams try old = SDPAParams SDPAParams = torch _dynamo allow_in_graph SDPAParams yield finally SDPAParams = old TestSDPA torch _dynamo test_case TestCase assert_ref_equals_params actual expected assertIs actual query expected query assertIs actual key expected key assertIs actual value expected value assertIs actual attn_mask expected attn_mask test_returns_SDPAParams allow_in_graph_sdpa_params counter = CompileCounter torch compile fullgraph=True backend=counter fn q k v m SDPAParams q k v m True False q = torch randn k = torch randn v = torch randn m = torch randn o = fn q k v m assertTrue isinstance o SDPAParams assert_ref_equals_params o SDPAParams q k v m True False assertEqual counter frame_count test_graph_break_SDPAParams allow_in_graph_sdpa_params counter = CompileCounter torch compile backend=counter fn q k v m z = SDPAParams q k v m True False torch _dynamo graph_break z q + q = torch randn k = torch randn v = torch randn m = torch randn o _ = fn q k v m assertTrue isinstance o SDPAParams assert_ref_equals_params o SDPAParams q k v m True False assertEqual counter frame_count test_input_SDPAParams allow_in_graph_sdpa_params counter = CompileCounter torch compile backend=counter fn sdpap q torch _dynamo graph_break sdpap sdpap query + q q = torch randn k = torch randn v = torch randn m = torch randn s = SDPAParams q k v m True False o _ = fn s q assertIs o s assertEqual counter frame_count test_intermediate_attr_access_SDPAParams allow_in_graph_sdpa_params counter = CompileCounter torch compile fullgraph=True backend=counter fn q k v m q += z = SDPAParams q k v m True False = z query + z q q = torch randn k = torch randn v = torch randn m = torch randn _ o _ = fn q k v m expected = SDPAParams q k v m True False assert_ref_equals_params o expected assertEqual counter frame_count test_sdpa_c_functions_no_graph_break counter = CompileCounter torch compile fullgraph=True backend=counter test_cur_sdpa_kernel_backends _cur_sdpa_kernel_backends result = test_cur_sdpa_kernel_backends assertIsInstance result list assertEqual counter frame_count test_sdpa_kernel_decorator_with_compile SDPA_BACKEND_PRIORITY = SDPBackend MATH SDPBackend EFFICIENT_ATTENTION SDPBackend FLASH_ATTENTION sdpa_kernel backends=SDPA_BACKEND_PRIORITY set_priority=True scaled_dot_product_attention q k v args kwargs torch nn functional scaled_dot_product_attention q k v args kwargs counter = CompileCounter torch compile fullgraph=True backend=counter f x scaled_dot_product_attention x x x x = torch rand dtype=torch float result = f x assertEqual result shape x shape assertEqual counter frame_count __name__ == __main__ torch _dynamo test_case run_tests run_tests
Owner s oncall package deploy io BytesIO torch torch fx Graph GraphModule symbolic_trace torch package ObjMismatchError PackageExporter PackageImporter sys_importer torch testing _internal common_utils run_tests try common PackageTestCase except ImportError Support case where we run file directly common PackageTestCase torch fx wrap len Do twice make sure doesn t affect anything torch fx wrap len TestPackageFX PackageTestCase Tests compatibility FX test_package_fx_simple SimpleTest torch nn Module forward x torch relu x + st = SimpleTest traced = symbolic_trace st f = BytesIO PackageExporter f pe pe save_pickle model model pkl traced f seek pi = PackageImporter f loaded_traced = pi load_pickle model model pkl input = torch rand assertEqual loaded_traced input traced input test_package_then_fx package_a test_module SimpleTest model = SimpleTest f = BytesIO PackageExporter f pe pe intern pe save_pickle model model pkl model f seek pi = PackageImporter f loaded = pi load_pickle model model pkl traced = symbolic_trace loaded input = torch rand assertEqual loaded input traced input test_package_fx_package package_a test_module SimpleTest model = SimpleTest f = BytesIO PackageExporter f pe pe intern pe save_pickle model model pkl model f seek pi = PackageImporter f loaded = pi load_pickle model model pkl traced = symbolic_trace loaded re-save package exporter f = BytesIO This should fail because we referencing some globals only package assertRaises ObjMismatchError PackageExporter f pe pe intern pe save_pickle model model pkl traced f seek PackageExporter f importer= pi sys_importer pe Make package available exporter s environment pe intern pe save_pickle model model pkl traced f seek pi = PackageImporter f loaded = pi load_pickle model model pkl input = torch rand assertEqual loaded input loaded input test_package_fx_with_imports package_a subpackage Manually construct graph invokes leaf function graph = Graph = graph placeholder x b = graph placeholder y c = graph call_function package_a subpackage leaf_function b d = graph call_function torch sin c graph output d gm = GraphModule torch nn Module graph f = BytesIO PackageExporter f pe pe intern pe save_pickle model model pkl gm f seek pi = PackageImporter f loaded_gm = pi load_pickle model model pkl input_x = torch rand input_y = torch rand assertTrue torch allclose loaded_gm input_x input_y gm input_x input_y Check packaged version leaf_function dependency same outer env packaged_dependency = pi import_module package_a subpackage assertTrue packaged_dependency package_a subpackage test_package_fx_custom_tracer package_a test_all_leaf_modules_tracer TestAllLeafModulesTracer package_a test_module ModWithTwoSubmodsAndTensor SimpleTest SpecialGraphModule torch fx GraphModule __init__ root graph info super __init__ root graph info = info sub_module = SimpleTest module = ModWithTwoSubmodsAndTensor torch ones sub_module sub_module tracer = TestAllLeafModulesTracer graph = tracer trace module assertEqual graph _tracer_cls TestAllLeafModulesTracer gm = SpecialGraphModule module graph secret assertEqual gm _tracer_cls TestAllLeafModulesTracer f = BytesIO PackageExporter f pe pe intern pe save_pickle model model pkl gm f seek pi = PackageImporter f loaded_gm = pi load_pickle model model pkl assertEqual type loaded_gm __class__ __name__ SpecialGraphModule __class__ __name__ assertEqual loaded_gm info secret input_x = torch randn assertEqual loaded_gm input_x gm input_x test_package_fx_wrap TestModule torch nn Module __init__ - None super __init__ forward len traced = torch fx symbolic_trace TestModule f = BytesIO torch package PackageExporter f pe pe save_pickle model model pkl traced f seek pi = PackageImporter f loaded_traced = pi load_pickle model model pkl input = torch rand assertEqual loaded_traced input traced input test_package_gm_preserve_stack_trace SimpleTest torch nn Module forward x torch relu x + st = SimpleTest traced = symbolic_trace st node traced graph nodes node meta stack_trace = f test_ node name f = BytesIO PackageExporter f pe pe save_pickle model model pkl traced f seek pi = PackageImporter f loaded_traced = pi load_pickle model model pkl node loaded_traced graph nodes assertEqual f test_ node name node meta stack_trace __name__ == __main__ run_tests
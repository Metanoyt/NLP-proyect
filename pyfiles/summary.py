mypy allow-untyped-defs json logging os struct typing Any Optional torch numpy np google protobuf struct_pb tensorboard compat proto summary_pb HistogramProto Summary SummaryMetadata tensorboard compat proto tensor_pb TensorProto tensorboard compat proto tensor_shape_pb TensorShapeProto tensorboard plugins custom_scalar layout_pb tensorboard plugins pr_curve plugin_data_pb PrCurvePluginData tensorboard plugins text plugin_data_pb TextPluginData _convert_np make_np _utils _prepare_video convert_to_HWC __all__ = half_to_int int_to_half hparams scalar histogram_raw histogram make_histogram image image_boxes draw_boxes make_image video make_video audio custom_scalars text tensor_proto pr_curve_raw pr_curve compute_curve mesh logger = logging getLogger __name__ half_to_int f float - int Casts half-precision float value into integer Converts half precision floating point value such ` torch half ` ` torch bfloat ` into integer value which can written into half_val field TensorProto storage To undo effects conversion use int_to_half buf = struct pack f f struct unpack i buf int_to_half i int - float Casts integer value half-precision float Converts integer value obtained half_to_int back into floating point value buf = struct pack i i struct unpack f buf _tensor_to_half_val t torch Tensor - list int half_to_int x x t flatten tolist _tensor_to_complex_val t torch Tensor - list float torch view_as_real t flatten tolist _tensor_to_list t torch Tensor - list Any t flatten tolist type maps torch Tensor type - protobuf type protobuf val field _TENSOR_TYPE_MAP = torch half DT_HALF half_val _tensor_to_half_val torch float DT_HALF half_val _tensor_to_half_val torch bfloat DT_BFLOAT half_val _tensor_to_half_val torch float DT_FLOAT float_val _tensor_to_list torch float DT_FLOAT float_val _tensor_to_list torch float DT_DOUBLE double_val _tensor_to_list torch double DT_DOUBLE double_val _tensor_to_list torch int DT_INT int_val _tensor_to_list torch uint DT_UINT int_val _tensor_to_list torch qint DT_UINT int_val _tensor_to_list torch int DT_INT int_val _tensor_to_list torch short DT_INT int_val _tensor_to_list torch int DT_INT int_val _tensor_to_list torch int DT_INT int_val _tensor_to_list torch qint DT_INT int_val _tensor_to_list torch int DT_INT int _val _tensor_to_list torch complex DT_COMPLEX scomplex_val _tensor_to_complex_val torch chalf DT_COMPLEX scomplex_val _tensor_to_complex_val torch complex DT_COMPLEX scomplex_val _tensor_to_complex_val torch cfloat DT_COMPLEX scomplex_val _tensor_to_complex_val torch bool DT_BOOL bool_val _tensor_to_list torch complex DT_COMPLEX dcomplex_val _tensor_to_complex_val torch cdouble DT_COMPLEX dcomplex_val _tensor_to_complex_val torch uint DT_UINT uint _val _tensor_to_list torch quint DT_UINT uint _val _tensor_to_list torch quint x DT_UINT uint _val _tensor_to_list _calc_scale_factor tensor converted = tensor numpy isinstance tensor np ndarray tensor converted dtype == np uint _draw_single_box image xmin ymin xmax ymax display_str color= black color_text= black thickness= PIL ImageDraw ImageFont font = ImageFont load_default draw = ImageDraw Draw image left right top bottom = xmin xmax ymin ymax draw line left top left bottom right bottom right top left top width=thickness fill=color display_str text_bottom = bottom Reverse list print bottom top _left _top _right _bottom = font getbbox display_str text_width text_height = _right - _left _bottom - _top margin = np ceil text_height draw rectangle left text_bottom - text_height - margin left + text_width text_bottom fill=color draw text left + margin text_bottom - text_height - margin display_str fill=color_text font=font image hparams hparam_dict=None metric_dict=None hparam_domain_discrete=None Output three ` Summary ` protocol buffers needed hparams plugin ` Experiment ` keeps metadata experiment such name hyperparameters name metrics ` SessionStartInfo ` keeps key-value pairs hyperparameters ` SessionEndInfo ` describes status experiment e g STATUS_SUCCESS Args hparam_dict A dictionary contains names hyperparameters their values metric_dict A dictionary contains names metrics their values hparam_domain_discrete Optional Dict str List Any A dictionary contains names hyperparameters all discrete values they can hold Returns The ` Summary ` protobufs Experiment SessionStartInfo SessionEndInfo torch tensorboard plugins hparams api_pb DataType Experiment HParamInfo MetricInfo MetricName Status tensorboard plugins hparams metadata EXPERIMENT_TAG PLUGIN_DATA_VERSION PLUGIN_NAME SESSION_END_INFO_TAG SESSION_START_INFO_TAG tensorboard plugins hparams plugin_data_pb HParamsPluginData SessionEndInfo SessionStartInfo TODO expose other parameters future hp = HParamInfo name= lr display_name= learning rate type=DataType DATA_TYPE_FLOAT domain_interval=Interval min_value= max_value= mt = MetricInfo name=MetricName tag= accuracy display_name= accuracy description= dataset_type=DatasetType DATASET_VALIDATION exp = Experiment name= description= time_created_secs= hparam_infos= hp metric_infos= mt user= tw isinstance hparam_dict dict logger warning parameter hparam_dict should dictionary nothing logged raise TypeError parameter hparam_dict should dictionary nothing logged isinstance metric_dict dict logger warning parameter metric_dict should dictionary nothing logged raise TypeError parameter metric_dict should dictionary nothing logged hparam_domain_discrete = hparam_domain_discrete isinstance hparam_domain_discrete dict raise TypeError parameter hparam_domain_discrete should dictionary nothing logged k v hparam_domain_discrete items k hparam_dict isinstance v list all isinstance d type hparam_dict k d v raise TypeError f parameter hparam_domain_discrete k should list same type hparam_dict k hps = ssi = SessionStartInfo k v hparam_dict items v None continue isinstance v int float ssi hparams k number_value = v k hparam_domain_discrete domain_discrete Optional struct_pb ListValue = struct_pb ListValue values= struct_pb Value number_value=d d hparam_domain_discrete k domain_discrete = None hps append HParamInfo name=k type=DataType Value DATA_TYPE_FLOAT domain_discrete=domain_discrete continue isinstance v str ssi hparams k string_value = v k hparam_domain_discrete domain_discrete = struct_pb ListValue values= struct_pb Value string_value=d d hparam_domain_discrete k domain_discrete = None hps append HParamInfo name=k type=DataType Value DATA_TYPE_STRING domain_discrete=domain_discrete continue isinstance v bool ssi hparams k bool_value = v k hparam_domain_discrete domain_discrete = struct_pb ListValue values= struct_pb Value bool_value=d d hparam_domain_discrete k domain_discrete = None hps append HParamInfo name=k type=DataType Value DATA_TYPE_BOOL domain_discrete=domain_discrete continue isinstance v torch Tensor v = make_np v ssi hparams k number_value = v hps append HParamInfo name=k type=DataType Value DATA_TYPE_FLOAT continue raise ValueError value should one int float str bool torch Tensor content = HParamsPluginData session_start_info=ssi version=PLUGIN_DATA_VERSION smd = SummaryMetadata plugin_data=SummaryMetadata PluginData plugin_name=PLUGIN_NAME content=content SerializeToString ssi = Summary value= Summary Value tag=SESSION_START_INFO_TAG metadata=smd mts = MetricInfo name=MetricName tag=k k metric_dict keys exp = Experiment hparam_infos=hps metric_infos=mts content = HParamsPluginData experiment=exp version=PLUGIN_DATA_VERSION smd = SummaryMetadata plugin_data=SummaryMetadata PluginData plugin_name=PLUGIN_NAME content=content SerializeToString exp = Summary value= Summary Value tag=EXPERIMENT_TAG metadata=smd sei = SessionEndInfo status=Status Value STATUS_SUCCESS content = HParamsPluginData session_end_info=sei version=PLUGIN_DATA_VERSION smd = SummaryMetadata plugin_data=SummaryMetadata PluginData plugin_name=PLUGIN_NAME content=content SerializeToString sei = Summary value= Summary Value tag=SESSION_END_INFO_TAG metadata=smd exp ssi sei scalar name tensor collections=None new_style=False double_precision=False Output ` Summary ` protocol buffer containing single scalar value The generated Summary has Tensor proto containing input Tensor Args name A name generated node Will also serve series name TensorBoard tensor A real numeric Tensor containing single value collections Optional list graph collections keys The new summary op added these collections Defaults ` GraphKeys SUMMARIES ` new_style Whether use new style tensor field old style simple_value field New style could lead faster data loading Returns A scalar ` Tensor ` type ` string ` Which contains ` Summary ` protobuf Raises ValueError If tensor has wrong shape type tensor = make_np tensor squeeze tensor ndim = raise AssertionError f Tensor should contain one element dimensions \ Was given size tensor size tensor ndim dimensions python float double precision numpy scalar = float tensor new_style tensor_proto = TensorProto float_val= scalar dtype= DT_FLOAT double_precision tensor_proto = TensorProto double_val= scalar dtype= DT_DOUBLE plugin_data = SummaryMetadata PluginData plugin_name= scalars smd = SummaryMetadata plugin_data=plugin_data Summary value= Summary Value tag=name tensor=tensor_proto metadata=smd Summary value= Summary Value tag=name simple_value=scalar tensor_proto tag tensor Outputs ` Summary ` protocol buffer containing full tensor The generated Summary has Tensor proto containing input Tensor Args tag A name generated node Will also serve series name TensorBoard tensor Tensor converted protobuf Returns A tensor protobuf ` Summary ` protobuf Raises ValueError If tensor too big converted protobuf tensor data type supported tensor numel tensor itemsize = raise ValueError tensor bigger than protocol buffer s hard limit GB size tensor dtype _TENSOR_TYPE_MAP dtype field_name conversion_fn = _TENSOR_TYPE_MAP tensor dtype tensor_proto = TensorProto dtype dtype tensor_shape TensorShapeProto dim= TensorShapeProto Dim size=x x tensor shape field_name conversion_fn tensor raise ValueError f tag has unsupported tensor dtype tensor dtype plugin_data = SummaryMetadata PluginData plugin_name= tensor smd = SummaryMetadata plugin_data=plugin_data Summary value= Summary Value tag=tag metadata=smd tensor=tensor_proto histogram_raw name min max num sum sum_squares bucket_limits bucket_counts pylint disable=line-too-long Output ` Summary ` protocol buffer histogram The generated ` Summary ` https www tensorflow org code tensorflow core framework summary proto has one summary value containing histogram ` values ` Args name A name generated node Will also serve series name TensorBoard min A float int min value max A float int max value num Int number values sum Float int sum all values sum_squares Float int sum squares all values bucket_limits A numeric ` Tensor ` upper value per bucket bucket_counts A numeric ` Tensor ` number values per bucket Returns A scalar ` Tensor ` type ` string ` The serialized ` Summary ` protocol buffer hist = HistogramProto min=min max=max num=num sum=sum sum_squares=sum_squares bucket_limit=bucket_limits bucket=bucket_counts Summary value= Summary Value tag=name histo=hist histogram name values bins max_bins=None pylint disable=line-too-long Output ` Summary ` protocol buffer histogram The generated ` Summary ` https www tensorflow org code tensorflow core framework summary proto has one summary value containing histogram ` values ` This op reports ` InvalidArgument ` error any value finite Args name A name generated node Will also serve series name TensorBoard values A real numeric ` Tensor ` Any shape Values use build histogram Returns A scalar ` Tensor ` type ` string ` The serialized ` Summary ` protocol buffer values = make_np values hist = make_histogram values astype float bins max_bins Summary value= Summary Value tag=name histo=hist make_histogram values bins max_bins=None Convert values into histogram proto using logic histogram cc values size == raise ValueError The input has no element values = values reshape - counts limits = np histogram values bins=bins num_bins = len counts max_bins None num_bins max_bins subsampling = num_bins max_bins subsampling_remainder = num_bins subsampling subsampling_remainder = pyrefly ignore no-matching-overload counts = np pad counts pad_width= subsampling - subsampling_remainder mode= constant constant_values= counts = counts reshape - subsampling sum axis=- new_limits = np empty counts size + limits dtype new_limits - = limits - subsampling new_limits - = limits - limits = new_limits Find first last bin defining support histogram cum_counts = np cumsum np greater counts start end = np searchsorted cum_counts cum_counts - - side= right start = int start end = int end + del cum_counts TensorBoard only includes right bin limits To still have leftmost limit included we include empty bin left If start == we need add empty one left otherwise we can just include bin left first nonzero-count bin counts = counts start - end start np concatenate counts end limits = limits start end + counts size == limits size == raise ValueError The histogram empty please file bug report sum_sq = values dot values HistogramProto min=values min max=values max num=len values sum=values sum sum_squares=sum_sq bucket_limit=limits tolist bucket=counts tolist image tag tensor rescale= dataformats= NCHW Output ` Summary ` protocol buffer images The summary has up ` max_images ` summary values containing images The images built ` tensor ` which must -D shape ` height width channels ` where ` channels ` can ` tensor ` interpreted Grayscale ` tensor ` interpreted RGB ` tensor ` interpreted RGBA The ` name ` outputted Summary Value protobufs generated based name suffix depending max_outputs setting If ` max_outputs ` summary value tag name image If ` max_outputs ` greater than summary value tags generated sequentially name image name image etc Args tag A name generated node Will also serve series name TensorBoard tensor A -D ` uint ` ` float ` ` Tensor ` shape ` height width channels ` where ` channels ` tensor can either have values float uint The image function will scale image values applying scale factor either uint float Out-of-range values will clipped Returns A scalar ` Tensor ` type ` string ` The serialized ` Summary ` protocol buffer tensor = make_np tensor tensor = convert_to_HWC tensor dataformats Do assume user passes values use data type detect scale_factor = _calc_scale_factor tensor tensor = tensor astype np float tensor = tensor scale_factor clip astype np uint image = make_image tensor rescale=rescale Summary value= Summary Value tag=tag image=image image_boxes tag tensor_image tensor_boxes rescale= dataformats= CHW labels=None Output ` Summary ` protocol buffer images tensor_image = make_np tensor_image tensor_image = convert_to_HWC tensor_image dataformats tensor_boxes = make_np tensor_boxes tensor_image = tensor_image astype np float _calc_scale_factor tensor_image image = make_image tensor_image clip astype np uint rescale=rescale rois=tensor_boxes labels=labels Summary value= Summary Value tag=tag image=image draw_boxes disp_image boxes labels=None xyxy format num_boxes = boxes shape list_gt = range num_boxes i list_gt disp_image = _draw_single_box disp_image boxes i boxes i boxes i boxes i display_str=None labels None labels i color= Red disp_image make_image tensor rescale= rois=None labels=None Convert numpy representation image Image protobuf PIL Image height width channel = tensor shape scaled_height = int height rescale scaled_width = int width rescale image = Image fromarray tensor rois None image = draw_boxes image rois labels=labels ANTIALIAS = Image Resampling LANCZOS image = image resize scaled_width scaled_height ANTIALIAS io output = io BytesIO image save output format= PNG image_string = output getvalue output close Summary Image height=height width=width colorspace=channel encoded_image_string=image_string video tag tensor fps= tensor = make_np tensor tensor = _prepare_video tensor If user passes uint then we don t need rescale scale_factor = _calc_scale_factor tensor tensor = tensor astype np float tensor = tensor scale_factor clip astype np uint video = make_video tensor fps Summary value= Summary Value tag=tag image=video make_video tensor fps try moviepy noqa F except ImportError print add_video needs package moviepy try moviepy editor mpy except ImportError print moviepy installed can t moviepy editor Some packages could missing imageio requests tempfile _t h w c = tensor shape encode sequence images into gif string clip = mpy ImageSequenceClip list tensor fps=fps filename = tempfile NamedTemporaryFile suffix= gif delete=False name try newer version moviepy use logger instead progress_bar argument clip write_gif filename verbose=False logger=None except TypeError try older version moviepy does support progress_bar argument clip write_gif filename verbose=False progress_bar=False except TypeError clip write_gif filename verbose=False open filename rb f tensor_string = f read try os remove filename except OSError logger warning The temporary file used moviepy cannot deleted Summary Image height=h width=w colorspace=c encoded_image_string=tensor_string audio tag tensor sample_rate= array = make_np tensor array = array squeeze abs array max print warning audio amplitude out range auto clipped array = array clip - array ndim = raise AssertionError input tensor should dimensional array = array np iinfo np int max astype i io wave fio = io BytesIO wave open fio wb wave_write wave_write setnchannels wave_write setsampwidth wave_write setframerate sample_rate wave_write writeframes array data audio_string = fio getvalue fio close audio = Summary Audio sample_rate=sample_rate num_channels= length_frames=array shape - encoded_audio_string=audio_string content_type= audio wav Summary value= Summary Value tag=tag audio=audio custom_scalars layout categories = k v layout items charts = chart_name chart_metadata v items tags = chart_metadata chart_metadata == Margin len tags = raise AssertionError len tags = mgcc = layout_pb MarginChartContent series= layout_pb MarginChartContent Series value=tags lower=tags upper=tags chart = layout_pb Chart title=chart_name margin=mgcc mlcc = layout_pb MultilineChartContent tag=tags chart = layout_pb Chart title=chart_name multiline=mlcc charts append chart categories append layout_pb Category title=k chart=charts layout = layout_pb Layout category=categories plugin_data = SummaryMetadata PluginData plugin_name= custom_scalars smd = SummaryMetadata plugin_data=plugin_data tensor = TensorProto dtype= DT_STRING string_val= layout SerializeToString tensor_shape=TensorShapeProto Summary value= Summary Value tag= custom_scalars__config__ tensor=tensor metadata=smd text tag text plugin_data = SummaryMetadata PluginData plugin_name= text content=TextPluginData version= SerializeToString smd = SummaryMetadata plugin_data=plugin_data tensor = TensorProto dtype= DT_STRING string_val= text encode encoding= utf_ tensor_shape=TensorShapeProto dim= TensorShapeProto Dim size= Summary value= Summary Value tag=tag + text_summary metadata=smd tensor=tensor pr_curve_raw tag tp fp tn fn precision recall num_thresholds= weights=None num_thresholds weird value breaks protobuf num_thresholds = data = np stack tp fp tn fn precision recall pr_curve_plugin_data = PrCurvePluginData version= num_thresholds=num_thresholds SerializeToString plugin_data = SummaryMetadata PluginData plugin_name= pr_curves content=pr_curve_plugin_data smd = SummaryMetadata plugin_data=plugin_data tensor = TensorProto dtype= DT_FLOAT float_val=data reshape - tolist tensor_shape=TensorShapeProto dim= TensorShapeProto Dim size=data shape TensorShapeProto Dim size=data shape Summary value= Summary Value tag=tag metadata=smd tensor=tensor pr_curve tag labels predictions num_thresholds= weights=None weird value breaks protobuf num_thresholds = min num_thresholds data = compute_curve labels predictions num_thresholds=num_thresholds weights=weights pr_curve_plugin_data = PrCurvePluginData version= num_thresholds=num_thresholds SerializeToString plugin_data = SummaryMetadata PluginData plugin_name= pr_curves content=pr_curve_plugin_data smd = SummaryMetadata plugin_data=plugin_data tensor = TensorProto dtype= DT_FLOAT float_val=data reshape - tolist tensor_shape=TensorShapeProto dim= TensorShapeProto Dim size=data shape TensorShapeProto Dim size=data shape Summary value= Summary Value tag=tag metadata=smd tensor=tensor https github com tensorflow tensorboard blob master tensorboard plugins pr_curve summary py compute_curve labels predictions num_thresholds=None weights=None _MINIMUM_COUNT = e- weights None weights = Compute bins true positives false positives pyrefly ignore unsupported-operation bucket_indices = np int np floor predictions num_thresholds - float_labels = labels astype np float pyrefly ignore unsupported-operation histogram_range = num_thresholds - tp_buckets _ = np histogram bucket_indices pyrefly ignore bad-argument-type bins=num_thresholds range=histogram_range weights=float_labels weights fp_buckets _ = np histogram bucket_indices pyrefly ignore bad-argument-type bins=num_thresholds range=histogram_range weights= - float_labels weights Obtain reverse cumulative sum tp = np cumsum tp_buckets - - fp = np cumsum fp_buckets - - tn = fp - fp fn = tp - tp precision = tp np maximum _MINIMUM_COUNT tp + fp recall = tp np maximum _MINIMUM_COUNT tp + fn np stack tp fp tn fn precision recall _get_tensor_summary name display_name description tensor content_type components json_config Create tensor summary summary metadata Args name Uniquely identifiable name summary op Could replaced combination name type make unique even outside summary display_name Will used display name TensorBoard Defaults ` name ` description A longform readable description summary data Markdown supported tensor Tensor display summary content_type Type content inside Tensor components Bitmask representing present parts vertices colors etc belong summary json_config A string JSON-serialized dictionary ThreeJS classes configuration Returns Tensor summary metadata torch tensorboard plugins mesh metadata tensor = torch as_tensor tensor tensor_metadata = metadata create_summary_metadata name display_name content_type components tensor shape description json_config=json_config tensor = TensorProto dtype= DT_FLOAT float_val=tensor reshape - tolist tensor_shape=TensorShapeProto dim= TensorShapeProto Dim size=tensor shape TensorShapeProto Dim size=tensor shape TensorShapeProto Dim size=tensor shape tensor_summary = Summary Value tag=metadata get_instance_name name content_type tensor=tensor metadata=tensor_metadata tensor_summary _get_json_config config_dict Parse returns JSON string python dictionary json_config = config_dict None json_config = json dumps config_dict sort_keys=True json_config https github com tensorflow tensorboard blob master tensorboard plugins mesh summary py mesh tag vertices colors faces config_dict display_name=None description=None Output merged ` Summary ` protocol buffer mesh point cloud Args tag A name summary operation vertices Tensor shape ` dim_ dim_n ` representing D coordinates vertices faces Tensor shape ` dim_ dim_n ` containing indices vertices within each triangle colors Tensor shape ` dim_ dim_n ` containing colors each vertex display_name If set will used display name TensorBoard Defaults ` name ` description A longform readable description summary data Markdown supported config_dict Dictionary ThreeJS classes names configuration Returns Merged summary mesh point cloud representation tensorboard plugins mesh metadata tensorboard plugins mesh plugin_data_pb MeshPluginData json_config = _get_json_config config_dict summaries = tensors = vertices MeshPluginData VERTEX faces MeshPluginData FACE colors MeshPluginData COLOR tensors = tensor tensor tensors tensor None components = metadata get_components_bitmask content_type tensor content_type tensors tensor content_type tensors summaries append _get_tensor_summary tag display_name description tensor content_type components json_config Summary value=summaries
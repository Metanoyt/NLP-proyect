Owner s module unknown copy copy torch torch nn torch testing _internal common_utils run_tests skipIfTorchDynamo TestCase xfailIfTorchDynamo torch utils checkpoint checkpoint torch utils module_tracker ModuleTracker TestModuleTracker TestCase https github com pytorch pytorch issues xfailIfTorchDynamo test_module_hierarchy seen_fw = seen_bw = Foo nn Module forward x x = x relu_ seen_fw append copy tracker parents tracker is_bw x register_hook lambda grad seen_bw append copy tracker parents tracker is_bw torch mm x x Mod nn Module __init__ - None super __init__ = Foo b = nn ModuleDict nest Foo c = nn ModuleList Foo forward x x = c x b nest x mod = Mod ModuleTracker tracker mod torch randn requires_grad=True clone sum backward mod torch randn requires_grad=True clone sum backward assertEqual seen_fw Global Mod Mod c False Global Mod Mod False Global Mod Mod b nest False Global Mod Mod c False Global Mod Mod False Global Mod Mod b nest False assertEqual seen_bw Global Mod Mod b nest True Global Mod Mod True Global Mod Mod c True Global Mod Mod b nest True Global Mod Mod True Global Mod Mod c True skipIfTorchDynamo unexplained + recursion error test_confused_hierarchy MyMod nn Module __init__ super __init__ inner = nn Linear ran = False forward inp ran ran = True inp ran = False inner inp mod = MyMod inp = torch rand requires_grad=True Should fail ModuleTracker res = mod inp res sum backward Should fail ModuleTracker res = checkpoint lambda inp mod inp inp res sum backward test_bw_detection mod = nn Linear ModuleTracker tracker mod torch rand requires_grad=True sum backward assertFalse tracker is_bw assertEqual tracker parents Global __name__ == __main__ run_tests
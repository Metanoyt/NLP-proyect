Owner s oncall distributed checkpointing os tempfile time concurrent futures Future typing Any torch torch distributed checkpoint _experimental checkpoint_process CheckpointProcess CheckpointProcessConfig RequestType WorkerRequest WorkerResponse torch distributed checkpoint _experimental checkpoint_writer CheckpointWriter CheckpointWriterConfig torch distributed checkpoint _experimental types RankInfo torch testing _internal common_utils run_tests TestCase subprocess_init_fn name str parent_pid int - None Initialize subprocess some basic checks This similar subprocess_init_routine checkpointing_test py assert name == test-checkpointer f Unexpected subprocess name name assert os getpid = parent_pid This supposed run different process assert os getppid == parent_pid This supposed run child main process failing_subprocess_init_fn name str parent_pid int - None Initialize function raises exception Acknowledge parameters avoid unused variable warnings _ = name _ = parent_pid raise RuntimeError Subprocess initialization failed timedout_subprocess_init_fn kwargs Any - None Acknowledge parameters avoid unused variable warnings _ = kwargs time sleep Simulate long initialization ckpt_writer_init_fn kwargs Any - CheckpointWriter Initialize CheckpointWriter subprocess This function called subprocess create CheckpointWriter instance It s important function defined module level so can pickled CheckpointWriter config=kwargs get config rank_info=kwargs get rank_info failing_ckpt_writer_init_fn kwargs Any - CheckpointWriter Initialize function raises exception Acknowledge parameters avoid unused variable warnings _ = kwargs raise RuntimeError CheckpointWriter initialization failed shared_tensor_verifier_init_fn kwargs Any - CheckpointWriter Initialize CheckpointWriter verifies shared memory tensors SharedTensorVerifier CheckpointWriter __init__ config=None rank_info=None init_kwargs Acknowledge unused kwargs avoid linting warnings _ = init_kwargs super __init__ config=config CheckpointWriterConfig rank_info=rank_info barrier=None commit_hook=None write state_dict path __ Acknowledge parameters avoid unused variable warnings _ = path Verify shared memory tensor behavior directly assertions shared_tensor state_dict shared_tensor = state_dict shared_tensor Critical assertion shared tensor should remain shared memory subprocess assert shared_tensor is_shared Shared tensor should shared memory subprocess shared_tensor = regular_tensor state_dict Note ForkingPickler moves regular tensors shared memory during IPC - acceptable assert state_dict regular_tensor is_shared Regular tensor should also shared memory subprocess None verifier = SharedTensorVerifier config=kwargs get config rank_info=kwargs get rank_info verifier TestRequestTypes TestCase Test request response data structures test_request_type_enum - None Test RequestType enum values assertEqual RequestType PING value ping assertEqual RequestType WRITE_CHECKPOINT value write_checkpoint assertEqual RequestType TERMINATE_PROCESS value exit test_worker_request - None Test WorkerRequest dataclass request = WorkerRequest request_type=RequestType PING payload= test data assertEqual request request_type RequestType PING assertEqual request payload test data test_worker_response - None Test WorkerResponse dataclass response = WorkerResponse request_type=RequestType PING success=True error_msg=None payload= result success assertEqual response request_type RequestType PING assertTrue response success assertIsNone response error_msg assertEqual response payload result success TestCheckpointProcessConfig TestCase Test CheckpointProcessConfig configuration test_default_options - None Test default CheckpointProcessConfig options = CheckpointProcessConfig Test default values assertEqual options subprocess_init_timeout_secs assertEqual options subprocess_shutdown_timeout_secs test_custom_options - None Test custom CheckpointProcessConfig options = CheckpointProcessConfig subprocess_init_timeout_secs= subprocess_shutdown_timeout_secs= assertEqual options subprocess_init_timeout_secs assertEqual options subprocess_shutdown_timeout_secs TestCheckpointProcess TestCase setUp - None Set up common test fixtures rank_info = RankInfo global_world_size= global_rank= writer_config = CheckpointWriterConfig test_state_dict = model torch nn Linear state_dict optimizer param_groups lr epoch step _create_checkpoint_process subprocess_init_fn_override=None subprocess_init_args_override=None writer_init_fn_override=None subprocess_init_timeout_secs= Helper create CheckpointProcess config = CheckpointProcessConfig subprocess_init_timeout_secs=subprocess_init_timeout_secs CheckpointProcess rank_info=self rank_info config=config subprocess_init_fn=subprocess_init_fn_override subprocess_init_fn subprocess_init_args=subprocess_init_args_override test-checkpointer os getpid checkpoint_writer_init_fn=writer_init_fn_override ckpt_writer_init_fn checkpoint_writer_init_args= config writer_config rank_info rank_info test_checkpoint_process_initialization - None Test CheckpointProcess initializes closes correctly checkpoint_process = _create_checkpoint_process Wait process creation future complete checkpoint_process process_creation_future result Verify process alive assertTrue checkpoint_process process processes is_alive checkpoint_process close Verify process terminated assertFalse checkpoint_process process processes is_alive test_checkpoint_write_sync_state_dict - None Test writing checkpoint synchronous state dict checkpoint_process = _create_checkpoint_process Wait initialization checkpoint_process process_creation_future result Create temporary directory checkpoint tempfile TemporaryDirectory temp_dir checkpoint_path = os path join temp_dir test_checkpoint Write checkpoint future = checkpoint_process write test_state_dict checkpoint_path Verify future returned assertIsInstance future Future Wait completion future result Verify checkpoint file created expected_file = os path join checkpoint_path f checkpoint_ rank_info global_rank pt assertTrue os path exists expected_file Verify checkpoint content loaded_state_dict = torch load expected_file assertIn model loaded_state_dict assertIn optimizer loaded_state_dict assertEqual loaded_state_dict epoch assertEqual loaded_state_dict step checkpoint_process close test_checkpoint_write_future_state_dict - None Test writing checkpoint Future state dict checkpoint_process = _create_checkpoint_process Wait initialization checkpoint_process process_creation_future result Create Future resolves state dict concurrent futures ThreadPoolExecutor executor = ThreadPoolExecutor max_workers= get_state_dict time sleep Simulate some processing time test_state_dict future_state_dict = executor submit get_state_dict Create temporary directory checkpoint tempfile TemporaryDirectory temp_dir checkpoint_path = os path join temp_dir test_checkpoint Write checkpoint Future state dict write_future = checkpoint_process write future_state_dict checkpoint_path Wait completion write_future result Verify checkpoint file created expected_file = os path join checkpoint_path f checkpoint_ rank_info global_rank pt assertTrue os path exists expected_file executor shutdown wait=True checkpoint_process close test_checkpoint_write_with_kwargs - None Test checkpoint writing additional kwargs checkpoint_process = _create_checkpoint_process Wait initialization checkpoint_process process_creation_future result tempfile TemporaryDirectory temp_dir checkpoint_path = os path join temp_dir test_checkpoint Write checkpoint kwargs future = checkpoint_process write test_state_dict checkpoint_path custom_arg= test_value another_arg= Wait completion future result Verify checkpoint created expected_file = os path join checkpoint_path f checkpoint_ rank_info global_rank pt assertTrue os path exists expected_file checkpoint_process close test_subprocess_initialization_timeout - None Test subprocess initialization timeout Create checkpoint process very short timeout mocking initialization checkpoint_process = _create_checkpoint_process subprocess_init_fn_override=timedout_subprocess_init_fn subprocess_init_timeout_secs= This should timeout assertRaises TimeoutError cm checkpoint_process process_creation_future result assertIn Timed out str cm exception test_subprocess_initialization_failure - None Test subprocess initialization failure checkpoint_process = _create_checkpoint_process subprocess_init_fn_override=failing_subprocess_init_fn The subprocess should fail initialize We expect raise exception when we try use assertRaises RuntimeError checkpoint_process process_creation_future result test_graceful_termination - None Test graceful termination subprocess checkpoint_process = _create_checkpoint_process checkpoint_process process_creation_future result assertTrue checkpoint_process process processes is_alive checkpoint_process close assertFalse checkpoint_process process processes is_alive test_forced_termination - None Test forced termination when graceful termination fails checkpoint_process = _create_checkpoint_process Wait initialization checkpoint_process process_creation_future result Mock join method simulate timeout mock_join timeout=None Acknowledge timeout parameter avoid unused variable warning _ = timeout False Simulate timeout checkpoint_process process join = mock_join This should trigger forced termination checkpoint_process close Process should still terminated killed Note This test might flaky depending timing test_communication_error_handling Test handling communication errors checkpoint_process = _create_checkpoint_process Wait initialization checkpoint_process process_creation_future result Close pipe simulate communication failure checkpoint_process _parent_end close Attempting write should raise error assertRaises RuntimeError cm future = checkpoint_process write test_state_dict tmp test future result assertIn Child process terminated unexpectedly str cm exception test_shared_memory_tensor_ipc Test shared memory tensors backed same memory across processes checkpoint_process = _create_checkpoint_process writer_init_fn_override=shared_tensor_verifier_init_fn checkpoint_process process_creation_future result Create tensors put them shared memory shared_tensor = torch randn shared_tensor share_memory_ shared_tensor_data_ptr = shared_tensor data_ptr regular_tensor = torch randn Don t put regular tensor shared memory comparison Verify initial shared memory status assertTrue shared_tensor is_shared Shared tensor should shared memory assertFalse regular_tensor is_shared Regular tensor should shared memory Create state dict mixed tensor types test_state_dict = shared_tensor shared_tensor regular_tensor regular_tensor Write subprocess - SharedTensorVerifier will Verify tensor still shared memory Check marker value confirm same memory Modify specific positions prove same memory access future = checkpoint_process write test_state_dict try result = future result This will raise exception subprocess assertions fail assertIsNone result SharedTensorVerifier returns None success except Exception e fail f Subprocess assertions failed e assert shared tensor still same shared memory assertEqual shared_tensor_data_ptr shared_tensor data_ptr Shared tensor should still same shared memory assertTrue shared_tensor is_shared Shared tensor should still shared memory CRITICAL TEST Verify modifications made subprocess visible main process This definitively proves both processes access same memory assertAlmostEqual shared_tensor places= msg=f Expected subprocess signature got shared_tensor f Shared memory working - subprocess modifications visible checkpoint_process close __name__ == __main__ run_tests
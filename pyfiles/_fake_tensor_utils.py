__future__ annotations dataclasses dataclass typing Optional TYPE_CHECKING Union torch torch SymInt torch fx experimental sym_node SymNode torch types py_sym_types PySymType TYPE_CHECKING sympy torch fx experimental symbolic_shapes ShapeEnv fake_tensor _DispatchCacheKey _MetadataIntLike dataclass frozen=True slots=True _DeconstructedSymNode Represents SymNode without associated ShapeEnv n b keep same protocol SymNode _expr sympy Expr pytype type _hint Optional Union int float bool constant Optional Union int float bool fx_node torch fx Node staticmethod from_node node SymNode - _DeconstructedSymNode _DeconstructedSymNode node _expr node pytype node _hint node constant pyrefly ignore bad-argument-type node fx_node extract shape_env ShapeEnv - SymNode SymNode _expr shape_env pytype _hint constant fx_node __str__ - str str _expr __repr__ - str f _DeconstructedSymNode _expr r pytype r _hint r constant r fx_node r __eq__ other object - bool raise NotImplementedError __hash__ - int raise NotImplementedError _value_eq match SymNode _value_eq other object - bool isinstance other SymNode _DeconstructedSymNode _expr == other _expr pytype == other pytype _hint == other _hint constant == other constant fx_node == other fx_node False _value_hash match SymNode _value_hash - int hash _expr pytype _hint constant fx_node dataclass frozen=True slots=True _DeconstructedSymType Represents SymInt SymFloat SymBool without associated ShapeEnv ty type PySymType node _DeconstructedSymNode staticmethod from_sym_type value PySymType - _DeconstructedSymType _DeconstructedSymType type value value node extract shape_env ShapeEnv - PySymType ty node extract shape_env __str__ - str f ty node __repr__ - str f _DeconstructedSymType ty node r __eq__ other object - bool NotImplemented __hash__ - int NotImplemented dataclass frozen=True slots=True _InputBackref value int dataclass slots=True _PySymInputStub Represents SymInt cached key Needed because SymInt doesn t support __eq__ __hash__ directly value can PySymType This normal SymInt value wrapped so we can use hash eq value hash eq normally SymInt does object hash eq _DeconstructedSymType This used when storing _PySymInputStub cache avoid cyclic ShapeEnv references _InputBackref This back-reference previous _PySymInputStub key value Union PySymType _DeconstructedSymType _InputBackref __init__ value Union PySymType _DeconstructedSymType _InputBackref - None For inputs values ` key ` we need keep PySymType intact - way we need reuse output we can properly copy original value value = value strip_shape_env - None isinstance value py_sym_types value = _DeconstructedSymType from_sym_type value extract shape_env ShapeEnv - PySymType isinstance value _DeconstructedSymType value extract shape_env We should never see _InputBackref here - anyone extracting value should pulling original entry one backref points assert isinstance value _InputBackref value __str__ - str str value __repr__ - str f _PySymInputStub value r __eq__ other object - bool isinstance other _PySymInputStub False isinstance value _InputBackref isinstance other value _InputBackref value == other value value node _value_eq other value node __hash__ - int isinstance value _InputBackref hash value value node _value_hash dataclass slots=True _SymIntOutputStub Represents SymInt cached output This either ` int ` which represents index key copy SymNode s deconstructed SymNode itself value Union int _DeconstructedSymNode __init__ value SymInt key_path Optional int - None key_path None value = _DeconstructedSymNode from_node value node value = key_path extract key _DispatchCacheKey shape_env ShapeEnv - SymInt isinstance value _DeconstructedSymNode SymInt value extract shape_env src = key key value assert isinstance src _PySymInputStub isinstance src value SymInt src value __repr__ - str f _SymIntOutputStub value r __eq__ other object - bool raise NotImplementedError __hash__ - int raise NotImplementedError dataclass slots=True _CacheKeyState State used while building our cache key We track SymNodes so when we get output we can see exactly matches one inputs so we can uncache properly sym_node_lookup dict int int id SymNode - index This list all seen input sympy Symbols We use when building cache entry see output value has any symbols we didn t see input See _has_unrepresented_symbols known_symbols set sympy Symbol There cases where we re asked perform op when we have no ShapeEnv FakeTensorMode - SymNodes we MUST have ShapeEnv So we scan we see SymNode ShapeEnv we record here shape_env Optional ShapeEnv __init__ shape_env Optional ShapeEnv = None - None sym_node_lookup = known_symbols = set shape_env = shape_env cache_on_shape_env - bool Returns true CacheKey needs cached ShapeEnv rather than global cache If our inputs contain SymNode then we can t cache operation global cache because cached output will implicitly depend guard values which might true some other ShapeEnv So unless we re also going cache guards we need cache operation ShapeEnv instead globally bool sym_node_lookup convert_sym_int result list object arg SymInt - None node_id = id arg node node_id sym_node_lookup result append _InputBackref sym_node_lookup node_id sym_node_lookup node_id = len result known_symbols update arg node expr free_symbols shape_env None shape_env = arg node shape_env result append _PySymInputStub arg convert_output arg _MetadataIntLike - _MetadataIntLike isinstance arg SymInt _SymIntOutputStub arg sym_node_lookup get id arg node None arg
This module provides callback management functionality TorchDynamo s compilation process It implements thread-safe system registering managing executing callbacks run start end TorchDynamo compilations Key features include - Registration deregistration compilation callbacks - Thread-safe callback handling proper locking mechanisms - Prevention duplicate callback execution when configured - Decorator utilities easy callback registration - Context manager controlled callback lifecycle The module centers around CompilationCallbackHandler which maintains separate lists start end callbacks manages their execution order ensures thread-safety Utility decorators on_compile_start on_compile_end provide convenient way register compilation hooks Example usage on_compile_start my_start_callback print Starting compilation on_compile_end my_end_callback print Compilation complete enum threading collections abc Callable Generator contextlib contextmanager dataclasses dataclass field noqa F typing Any CallbackTrigger enum Enum most common case dynamo attempts trace new frame DYNAMO = backward compilation can deferred runtime LAZY_BACKWARD = some backends autotune runtime TRITON_AUTOTUNING = Temporarily disabled due spam cudagraphs record runtime CUDAGRAPH_RECORDING = dataclass CallbackArgs callback_trigger CallbackTrigger compile_id str dataclass CompilationCallbackHandler start_callbacks list Callable CallbackArgs None = field default_factory=list end_callbacks list Callable CallbackArgs None = field default_factory=list __pending_callbacks_counter int = field default= init=False repr=False __pending_callbacks_counter_lock threading Lock = field default_factory=threading Lock init=False repr=False register_start_callback callback Callable CallbackArgs None - Callable CallbackArgs None Register callback function called when compilation starts Args - callback Callable The callback function register start_callbacks append callback callback register_end_callback callback Callable CallbackArgs None - Callable CallbackArgs None Register callback function called when compilation ends Args - callback Callable The callback function register end_callbacks append callback callback remove_start_callback callback Callable CallbackArgs None - None Remove registered start callback function Args - callback Callable The callback function remove start_callbacks remove callback remove_end_callback callback Callable CallbackArgs None - None Remove registered end callback function Args - callback Callable The callback function remove end_callbacks remove callback run_start_callbacks args CallbackArgs - None Execute all registered start callbacks callback start_callbacks callback args run_end_callbacks args CallbackArgs - None Execute all registered end callbacks callback end_callbacks callback args contextmanager install_callbacks trigger CallbackTrigger compile_id str - Generator None Any Any Context manager install callbacks run them when context exited args = CallbackArgs trigger compile_id try __pending_callbacks_counter_lock __pending_callbacks_counter += __pending_callbacks_counter == run_start_callbacks args yield finally __pending_callbacks_counter_lock assert __pending_callbacks_counter Pending callbacks counter cannot become negative __pending_callbacks_counter == run_end_callbacks args __pending_callbacks_counter -= clear - None Clear all registered callbacks start_callbacks clear end_callbacks clear assert __pending_callbacks_counter == callback_handler = CompilationCallbackHandler on_compile_start callback Callable CallbackArgs None - Callable CallbackArgs None Decorator register callback function start compilation callback_handler register_start_callback callback callback on_compile_end callback Callable CallbackArgs None - Callable CallbackArgs None Decorator register callback function end compilation callback_handler register_end_callback callback callback
mypy allow-untyped-defs logging warnings collections abc Iterable typing Any Optional torch torch export torch export _trace torch _utils_internal log_export_usage log = logging getLogger __name__ __all__ = report_exportability _generate_inputs_for_submodules model torch nn Module target_submodules Iterable str args tuple Any kwargs Optional dict str Any = None - dict str tuple Any Any Generate inputs targeting submdoules given model Note two submodules refer same obj function doesn t work Args model root model inputs inputs root model target_submodules submodules we want generate inputs Returns A dict maps submodule name its inputs kwargs = kwargs handles = results = submodule_to_names = mod name name mod model named_modules pre_forward module module_args module_kwargs results submodule_to_names module = module_args module_kwargs try name mod model named_modules name target_submodules handles append mod register_forward_pre_hook pre_forward with_kwargs=True model args kwargs except Exception e warnings warn f Failed generate submodule inputs because following error \n e stacklevel= finally h handles h remove results report_exportability mod torch nn Module args tuple Any kwargs Optional dict str Any = None strict bool = True pre_dispatch bool = False - dict str Optional Exception Report exportability issues module one-shot Args mod root module args args root module kwargs kwargs root module Returns A dict maps submodule name exception raised when trying export ` None ` means module exportable without issue Sample output UnsupportedOperatorException func= OpOverload op= testlib op_missing_meta overload= default submod_ UnsupportedOperatorException func= OpOverload op= testlib op_missing_meta overload= default submod_ None log_export_usage event= export report_exportability kwargs = kwargs all_submod_names = name name _ mod named_modules name = submod_inputs = _generate_inputs_for_submodules mod all_submod_names args kwargs tried_module_types = set report dict str Optional Exception = try_export module module_name args kwargs nonlocal submod_inputs report strict pre_dispatch tried_module_types type module tried_module_types tried_module_types add type module args None kwargs None try torch export _trace _export module args kwargs strict=strict pre_dispatch=pre_dispatch report module_name = None log info Successfully exported ` s ` module_name except Exception e short_msg = repr e split \n log warning Failed exporting ` s ` exception s module_name short_msg report module_name = e name submod module named_children sub_module_name = name module_name == f module_name name submod_args submod_kwargs = submod_inputs get sub_module_name None None try_export submod sub_module_name submod_args submod_kwargs try_export mod args kwargs unique_issues = set exception report values exception None key = repr exception split \\n unique_issues add key log warning Found d export issues len unique_issues issue unique_issues log warning issue report
usr bin env python os re tempfile collections defaultdict collections abc Iterator datetime datetime functools wraps typing Any Callable cast Optional TypeVar Union T = TypeVar T RE_GITHUB_URL_MATCH = re compile ^https github com + + $ get_git_remote_name - str os getenv GIT_REMOTE_NAME origin get_git_repo_dir - str pathlib Path os getenv GIT_REPO_DIR str Path __file__ resolve parents fuzzy_list_to_dict items list tuple str str - dict str list str Converts list dict preserving elements duplicate keys rc dict str list str = defaultdict list key val items rc key append val dict rc _check_output items list str encoding str = utf- - str subprocess CalledProcessError check_output STDOUT try check_output items stderr=STDOUT decode encoding except CalledProcessError e msg = f Command ` join e cmd ` returned non-zero exit code e returncode stdout = e stdout decode encoding e stdout None stderr = e stderr decode encoding e stderr None These get swallowed up so print them here debugging print f stdout \n stdout print f stderr \n stderr len stderr == msg += f \n ` ` ` \n stdout ` ` ` msg += f \nstdout \n ` ` ` \n stdout ` ` ` \nstderr \n ` ` ` \n stderr ` ` ` raise RuntimeError msg e GitCommit commit_hash str title str body str author str author_date datetime commit_date Optional datetime __init__ commit_hash str author str author_date datetime title str body str commit_date Optional datetime = None - None commit_hash = commit_hash author = author author_date = author_date commit_date = commit_date title = title body = body __repr__ - str f title commit_hash __contains__ item Any - bool item body item title parse_fuller_format lines Union str list str - GitCommit Expect commit message generated using ` -- format=fuller -- date=unix ` format i e commit sha Author author AuthorDate author date Commit committer CommitDate committer date title line full commit message isinstance lines str lines = lines split \n TODO Handle merge commits correctly len lines lines startswith Merge del lines assert len lines assert lines startswith commit assert lines startswith Author assert lines startswith AuthorDate assert lines startswith Commit assert lines startswith CommitDate assert len lines == GitCommit commit_hash=lines split strip author=lines split strip author_date=datetime fromtimestamp int lines split strip commit_date=datetime fromtimestamp int lines split strip title=lines strip body= \n join lines GitRepo __init__ path str remote str = origin debug bool = False - None repo_dir = path remote = remote debug = debug _run_git args Any - str debug print f + git -C repo_dir join args _check_output git -C repo_dir + list args revlist revision_range str - list str rc = _run_git rev-list revision_range -- strip rc split \n len rc branches_containing_ref ref str include_remote bool = True - list str rc = _run_git branch -- remote -- contains ref include_remote _run_git branch -- contains ref x strip x rc split \n x strip len rc current_branch - Optional str try _run_git symbolic-ref -- short HEAD strip except RuntimeError we detached HEAD state None checkout branch str - None _run_git checkout branch create_branch_and_checkout branch str - None _run_git checkout -b branch fetch ref Optional str = None branch Optional str = None - None branch None ref None _run_git fetch remote branch None _run_git fetch remote ref _run_git fetch remote f ref branch show_ref name str - str refs = _run_git show-ref -s name strip split \n all refs i == refs i range len refs raise RuntimeError f reference name ambiguous refs rev_parse name str - str _run_git rev-parse -- verify name strip get_merge_base from_ref str to_ref str - str _run_git merge-base from_ref to_ref strip patch_id ref Union str list str - list tuple str str is_list = isinstance ref list is_list len ref == ref = join ref rc = _check_output sh -c f git -C repo_dir show ref &#124; git patch-id -- stable strip cast tuple str str x split x rc split \n commits_resolving_gh_pr pr_num int - list str owner name = gh_owner_and_name msg = f Pull Request resolved https github com owner name pull pr_num rc = _run_git log -- format= H -- grep msg strip rc split \n len rc get_commit ref str - GitCommit parse_fuller_format _run_git show -- format=fuller -- date=unix -- shortstat ref cherry_pick ref str - None _run_git cherry-pick -x ref revert ref str - None _run_git revert -- no-edit ref compute_branch_diffs from_branch str to_branch str - tuple list str list str Returns list commits missing each other branch since their merge base Might slow merge base between two branches pretty far off from_ref = rev_parse from_branch to_ref = rev_parse to_branch merge_base = get_merge_base from_ref to_ref from_commits = revlist f merge_base from_ref to_commits = revlist f merge_base to_ref from_ids = fuzzy_list_to_dict patch_id from_commits to_ids = fuzzy_list_to_dict patch_id to_commits patch_id set from_ids intersection set to_ids from_values = from_ids patch_id to_values = to_ids patch_id len from_values = len to_values Eliminate duplicate commits+reverts list while len from_values len to_values frc = get_commit from_values pop toc = get_commit to_values pop FRC branch might have PR number added title frc title = toc title frc author_date = toc author_date HACK Same commit merged reverted landed again which creates tracking problem pytorch pytorch remote_url frc commit_hash b ba f cce ee ab c dbf d f d f df e d ccafd b dbe edf e f f da f b de bca c aea c f e f c b b db d c ca aa bedad ebcf abc raise RuntimeError f Unexpected differences between frc toc from_commits remove frc commit_hash to_commits remove toc commit_hash continue commit from_values from_commits remove commit commit to_values to_commits remove commit Another HACK Patch-id stable commits binary files big changes across commits I e cherry-picking those one branch into another will change patchid pytorch pytorch remote_url excluded_commit e e c dafcdbdb c d da e f e c c acb b f b e d c defd af c ba d e d ed ec b b c dd abbce d f ec cdc b b c d d f e excluded_commit from_commits from_commits remove excluded_commit from_commits to_commits cherry_pick_commits from_branch str to_branch str - None orig_branch = current_branch assert orig_branch None Must branch checkout to_branch from_commits to_commits = compute_branch_diffs from_branch to_branch len from_commits == print Nothing do checkout orig_branch commit reversed from_commits print f Cherry picking commit commit cherry_pick commit checkout orig_branch push branch str dry_run bool retry int = - None cnt range retry try dry_run _run_git push -- dry-run remote branch _run_git push remote branch except RuntimeError e print f cnt push attempt failed e fetch _run_git rebase f remote branch head_hash - str _run_git show-ref -- hash HEAD strip remote_url - str _run_git remote get-url remote gh_owner_and_name - tuple str str url = os getenv GIT_REMOTE_URL None url None url = remote_url rc = RE_GITHUB_URL_MATCH match url rc None raise RuntimeError f Unexpected url format url cast tuple str str rc groups commit_message ref str - str _run_git log - -- format= B ref amend_commit_message msg str - None _run_git commit -- amend -m msg diff from_ref str to_ref Optional str = None - str to_ref None _run_git diff f from_ref ^ _run_git diff f from_ref to_ref clone_repo username str password str org str project str - GitRepo path = tempfile mkdtemp _check_output git clone f https username password github com org project path strip GitRepo path=path PeekableIterator Iterator str __init__ val str - None _val = val _idx = - peek - Optional str _idx + = len _val None _val _idx + __iter__ - PeekableIterator __next__ - str rc = peek rc None raise StopIteration _idx += rc patterns_to_regex allowed_patterns list str - Any pattern glob-like i e only special sequences has - - matches single character - - matches any non-folder separator characters no character - - matches any characters no character Assuming patterns free braces backslashes only character needs escaped dot plus rc = idx pattern enumerate allowed_patterns idx rc += &#124; pattern_ = PeekableIterator pattern assert any c pattern c \\ c pattern_ c == rc += \\ c == + rc += \\+ c == pattern_ peek == next pattern_ rc += rc += ^ rc += c rc += re compile rc _shasum value str - str hashlib m = hashlib sha m update value encode utf- m hexdigest is_commit_hash ref str - bool True ref hexadecimal number false try int ref except ValueError False True are_ghstack_branches_in_sync repo GitRepo head_ref str base_ref Optional str = None - bool Checks diff between base head same diff between orig its parent orig_ref = re sub r head$ orig head_ref base_ref None base_ref = re sub r head$ base head_ref orig_diff_sha = _shasum repo diff f repo remote orig_ref head_diff_sha = _shasum repo diff base_ref is_commit_hash base_ref f repo remote base_ref f repo remote head_ref orig_diff_sha == head_diff_sha retries_decorator rc Any = None num_retries int = - Callable Callable T Callable T decorator f Callable T - Callable T wraps f wrapper args list Any kwargs dict str Any - T idx range num_retries try f args kwargs except Exception e print f Attempt idx num_retries call f __name__ failed e cast T rc wrapper decorator
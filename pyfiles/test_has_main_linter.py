usr bin env python This lint verifies every Python test file file matches test_ py _test py test folder has main block which raises exception calls run_tests ensure test will run OSS CI Takes ~ minuters run without multiprocessing probably overkill __future__ annotations argparse json multiprocessing mp enum Enum typing NamedTuple pyrefly ignore import-error libcst cst pyrefly ignore import-error libcst matchers m LINTER_CODE = TEST_HAS_MAIN HasMainVisiter cst CSTVisitor __init__ - None super __init__ found = False visit_Module node cst Module - bool name = m Name __name__ main = m SimpleString __main__ &#124; m SimpleString __main__ run_test_call = m Call func=m Name run_tests &#124; m Attribute attr=m Name run_tests Distributed tests i e MultiProcContinuousTest calls ` run_rank ` instead ` run_tests ` main run_rank_call = m Call func=m Name run_rank &#124; m Attribute attr=m Name run_rank raise_block = m Raise name == main main == name if_main = m Comparison name m ComparisonTarget m Equal main if_main = m Comparison main m ComparisonTarget m Equal name child node children m matches child m If test=if_main &#124; if_main m findall child raise_block &#124; run_test_call &#124; run_rank_call found = True break False LintSeverity str Enum ERROR = error WARNING = warning ADVICE = advice DISABLED = disabled LintMessage NamedTuple path str &#124; None line int &#124; None char int &#124; None code str severity LintSeverity name str original str &#124; None replacement str &#124; None description str &#124; None check_file filename str - list LintMessage lint_messages = open filename f file = f read v = HasMainVisiter cst parse_module file visit v v found message = Test files need have main block which either calls run_tests + ensure tests run during OSS CI raises exception + added blocklist test run_test py lint_messages append LintMessage path=filename line=None char=None code=LINTER_CODE severity=LintSeverity ERROR name= no-main original=None replacement=None description=message lint_messages main - None parser = argparse ArgumentParser description= test files should have main block linter fromfile_prefix_chars= parser add_argument filenames nargs= + help= paths lint args = parser parse_args pool = mp Pool lint_messages = pool map check_file args filenames pool close pool join flat_lint_messages = sublist lint_messages flat_lint_messages extend sublist lint_message flat_lint_messages print json dumps lint_message _asdict flush=True __name__ == __main__ main
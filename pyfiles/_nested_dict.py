Copyright c Meta Platforms Inc affiliates torch distributed checkpoint metadata STATE_DICT_TYPE _version _traverse OBJ_PATH set_element STATE_DICT_ITEM traverse_state_dict traverse_state_dict_v_ _ TODO Need add ability handle tuple OrderedDict NamedTuple Update mappings dict Change set_element recreate right type tuple OrderedDict NamedTuple FLATTEN_MAPPING = dict str OBJ_PATH TODO Update Docstring nested_dict py flatten_state_dict state_dict STATE_DICT_TYPE - tuple STATE_DICT_TYPE FLATTEN_MAPPING Flatten ` ` state_dict ` ` made nested dicts lists into top level dictionary Use ` ` unflatten_state_dict ` ` revert process Returns A tuple flatten state_dict mapping original new state_dict N B The new keys derived object paths joined dot For example ` ` b ` ` results key ` b ` flattened STATE_DICT_TYPE = mappings FLATTEN_MAPPING = flat_copy path OBJ_PATH value STATE_DICT_ITEM - None new_fqn = join map str path new_fqn flattened raise ValueError f duplicated flatten key new_fqn flattened new_fqn = value mappings new_fqn = path We started flatten dictionary since v But order break checkpoints saved before v we need keep old traversal so we can reconstruct those checkpoints use_v_ _ = _version _derived_version None _version _derived_version == _ use_v_ _ traverse_state_dict_v_ _ state_dict flat_copy traverse_state_dict state_dict flat_copy flattened mappings unflatten_state_dict state_dict STATE_DICT_TYPE mapping FLATTEN_MAPPING - STATE_DICT_TYPE Restore original nested state_dict according ` ` mapping ` ` flattened ` ` state_dict ` ` nested STATE_DICT_TYPE = key value state_dict items set_element nested mapping key value nested
mypy allow-untyped-defs functools collections abc Callable contextlib contextmanager dataclasses dataclass field typing Any NamedTuple Optional torch torch nn nn dataclass TracingConfig This represents symbolic tracing configuration Args tracer torch fx Tracer An instance ` torch fx Tracer ` use symbolic tracing The default value native ` torch fx Tracer ` constructed default arguments However user may want pass different value such ` ` HFTracer ` ` models HuggingFace Transformers_ library _Transformers https huggingface co docs transformers index concrete_args Optional Dict str Any Concrete arguments should treated ` ` torch fx Proxy ` ` when tracing module ` ` forward ` ` Passing ` ` concrete_args ` ` allows partially specializing forward e g remove control flow data structures This ` ` concrete_args ` ` here same argument used meth ` ~torch fx Tracer trace ` tracer torch fx Tracer = field default_factory=torch fx Tracer concrete_args Optional dict str Any = None _ParamUsageInfo NamedTuple This used ` ` _ExecutionInfo module_to_param_usage_infos ` ` record execution information The ` ` dict ` ` maps modules list these ` ` _ParamUsageInfo ` ` instances where each instance represents group parameters used together Specifically each module key ` ` dict ` ` each instance represents either module some sublist its ` ` named_parameters ` ` used together execution see ` ` _patched_create_proxy ` ` submodule all ` ` submodule named_parameters ` ` see ` ` _patched_call_module ` ` Type corresponds directly using parameters ops without calling ` ` forward ` ` type corresponds calling ` ` forward ` ` The mapped-to lists ` ` dict ` ` follow execution order module nn Module named_params list tuple str nn Parameter _ExecutionInfo This represents execution order information forward pass Attributes curr_module nn Module Current module being traced module_forward_order List nn Module The modules pre- forward order i e order which their ` ` forward ` ` methods called Each call module s ` ` forward ` ` corresponds one element list module_to_param_usage_infos Dict nn Module List _ParamUsageInfo Maps module list module execution infos See ` _ParamUsageInfo ` details param_forward_order List nn Parameter The parameters forward execution order where only parameter s first participation included visited_params Set nn Parameter The parameters visited so far during trace This only used during tracing fast membership check Invariant The parameters ` ` param_forward_order ` ` exactly those ` ` visited_params ` ` __init__ root_module nn Module - None curr_module nn Module = root_module module_forward_order list nn Module = root_module module_to_param_usage_infos dict nn Module list _ParamUsageInfo = root_module param_forward_order list nn Parameter = visited_params set nn Parameter = set _ExecOrderTracer __init__ - None exec_info Optional _ExecutionInfo = None contextmanager patch_tracer tracer torch fx Tracer root_module nn Module exec_info = _ExecutionInfo root_module orig_call_module = tracer call_module orig_create_proxy = tracer create_proxy tracer call_module = functools partial type ignore method-assign _patched_call_module orig_call_module exec_info fqn_to_param = dict root_module named_parameters tracer create_proxy = functools partial type ignore method-assign _patched_create_proxy orig_create_proxy exec_info fqn_to_param try yield finally tracer call_module = orig_call_module type ignore method-assign tracer create_proxy = orig_create_proxy type ignore method-assign _patched_call_module call_module Callable exec_info _ExecutionInfo Below expected arguments ` call_module ` module nn Module forward Callable args tuple Any kwargs dict str Any - Any Overrides ` ` call_module ` ` save execution information ` ` exec_info ` ` Note ` ` call_module ` ` called during symbolic tracing each non-root module Args call_module Callable Original ` ` call_module ` ` override exec_info _ExecutionInfo Used record execution information module nn Module Module corresponding ` ` call_module ` ` forward Callable ` ` forward ` ` method ` ` module ` ` called ` ` call_module ` ` args Tuple Any Positional arguments ` ` forward ` ` kwargs Dict str Any Keyword arguments ` ` forward ` ` Returns Same value ` ` call_module ` ` exec_info module_forward_order append module named_params = list module named_parameters curr_module = exec_info curr_module named_params curr_module exec_info module_to_param_usage_infos raise AssertionError The current module should have already been processed patched ` call_module ` exec_info module_to_param_usage_infos exec_info curr_module append _ParamUsageInfo module named_params prev_curr_module = curr_module exec_info curr_module = module exec_info module_to_param_usage_infos module = output = call_module module forward args kwargs exec_info curr_module = prev_curr_module output _patched_create_proxy create_proxy Callable exec_info _ExecutionInfo fqn_to_param dict str nn Parameter Below expected arguments ` create_proxy ` kind str target torch fx node Target args tuple Any kwargs dict str Any name Optional str = None type_expr Optional Any = None proxy_factory_fn Optional Callable torch fx Node torch fx Proxy = None - torch fx Proxy Overrides ` ` create_proxy ` ` save execution information ` ` exec_info ` ` Note ` ` create_proxy ` ` called during symbolic tracing each leaf function method module Args create_proxy Callable Original ` ` create_proxy ` ` override exec_info _ExecutionInfo Used record execution information fqn_to_param Dict str nn Parameter ` ` dict ` ` version root module s ` ` named_parameters ` ` FQN key parameter value kind str Kind target method call_function call_method get_attr call_module placeholder output See ` torch fx Graph ` details This passed ` ` create_proxy ` ` target torch fx node Target Contains string name function method module This passed ` ` create_proxy ` ` args Tuple Any Positional arguments function method module This passed ` ` create_proxy ` ` kwargs Dict str Any Keyword arguments function method module This passed ` ` create_proxy ` ` name Optional str An optional string name ` ` Node ` ` created ` ` create_proxy ` ` This passed ` ` create_proxy ` ` type_expr Optional Any An optional type annotation representing Python type output node has This passed ` ` create_proxy ` ` proxy_factory_fn Callable torch fx Node torch fx Proxy An alternative proxy constructor used ` ` create_proxy ` ` This passed ` ` create_proxy ` ` Returns torch fx Proxy Created ` ` Node ` ` wrapped ` ` Proxy ` ` object proxy = create_proxy kind target args kwargs name type_expr proxy_factory_fn curr_module = exec_info curr_module kind call_function call_method args None named_params list tuple str nn Parameter = arg args isinstance arg torch fx Proxy arg node target fqn_to_param param = fqn_to_param arg node target type ignore index named_params append arg node target param type ignore arg-type param exec_info visited_params exec_info visited_params add param exec_info param_forward_order append param named_params exec_info module_to_param_usage_infos curr_module append _ParamUsageInfo curr_module named_params kind == call_module named_params = list curr_module named_parameters named_params exec_info module_to_param_usage_infos curr_module append _ParamUsageInfo curr_module named_params _ param named_params param exec_info visited_params exec_info visited_params add param exec_info param_forward_order append param proxy
Owner s module mps Collection op level benchmarks MPS Useful reference tool when migrating ops MPS Metal itertools timeit warnings typing Optional torch torch utils benchmark Compare Measurement Timer bench_unary_op func x label - Measurement sync_cmd = torch mps synchronize mps str x device t = Timer stmt=f f x sync_cmd globals= f func x x language= python timer=timeit default_timer sub_label=f func __name__ str x dtype description=label env=torch __version__ t blocked_autorange bench_binary_op func x y label - Measurement sync_cmd = torch mps synchronize mps str x device t = Timer stmt=f f x y sync_cmd globals= f func x x y y language= python timer=timeit default_timer sub_label=f func __name__ str x dtype str y dtype description=label env=torch __version__ t blocked_autorange bench_unary unary_func device str = mps dtype torch dtype = torch float - list Measurement x = torch testing make_tensor device=device dtype=dtype x_s = torch testing make_tensor device=device dtype=dtype rc = rc append bench_unary_op unary_func x dense rc append bench_unary_op unary_func x t transposed rc append bench_unary_op unary_func x_s strided rc append bench_unary_op unary_func x_s t strided + transposed rc bench_binary binary_func device str = mps dt_a torch dtype = torch float dt_b Optional torch dtype = None - list Measurement dt_b = dt_b dt_b None dt_a x = torch testing make_tensor device=device dtype=dt_a y = torch testing make_tensor device=device dtype=dt_b s = torch testing make_tensor device=device dtype=dt_b rc = rc append bench_binary_op binary_func x y dense-dense rc append bench_binary_op binary_func x t y t transp-transp rc append bench_binary_op binary_func x y t dense-transp rc append bench_binary_op binary_func x t y transp-dense rc append bench_binary_op binary_func x s dense-scalar rc append bench_binary_op binary_func x y dense-bcast rc check_eager_vs_compile rc_c rc_e func dtype torch allclose rc_c rc_e mdiff = rc_c - rc_e abs max warnings warn f Eager compile reduction do match func __name__ dtype max_diff= mdiff stacklevel= bench_reduction reduction_func device str = mps dtype torch dtype = torch float - list Measurement rc = Bench D reduction over dim= f t reduction_func t dim= f __name__ = reduction_func __name__ f_c = torch compile f dynamic=False fullgraph=True size x = torch testing make_tensor size size device=device dtype=dtype rc_c rc_e = f x f_c x rc_c rc_e = rc_c rc_e isinstance rc_c tuple rc_c rc_e check_eager_vs_compile rc_c rc_e reduction_func dtype rc append bench_unary_op f x f eager- size x size rc append bench_unary_op f_c x f compile- size x size rc bench_scan scan_func device str = mps dtype torch dtype = torch float with_indices bool = False - list Measurement rc = Bench cumsum along different dimensions dim f t scan_func t dim=dim f_c = torch compile f dynamic=False fullgraph=True size f __name__ = f scan_func __name__ -dim dim - size x size f_c __name__ = f __name__ x = torch testing make_tensor size size device=device dtype=dtype rc_c rc_e = f x f_c x with_indices check_eager_vs_compile rc_c rc_e scan_func dtype check_eager_vs_compile rc_c rc_e scan_func dtype check_eager_vs_compile rc_c rc_e scan_func dtype rc append bench_unary_op f x eager rc append bench_unary_op f_c x compile Bench D cumsum different sizes f_ d t scan_func t dim= f_ d_c = torch compile f_ d dynamic=False fullgraph=True size f_ d __name__ = f scan_func __name__ - d- size f_ d_c __name__ = f_ d __name__ x = torch testing make_tensor size device=device dtype=dtype rc_c rc_e = f_ d x f_ d_c x with_indices check_eager_vs_compile rc_c rc_e scan_func dtype check_eager_vs_compile rc_c rc_e scan_func dtype check_eager_vs_compile rc_c rc_e scan_func dtype rc append bench_unary_op f_ d x eager rc append bench_unary_op f_ d_c x compile rc main - None dtypes = torch float torch float torch bfloat Profile index ops B = rc = dtype N itertools product torch int torch float torch float x = torch testing make_tensor B N N device= mps dtype=dtype y = torch randint B rc append bench_binary_op torch Tensor __getitem__ x y f B x N x N Compare rc print Profile unary ops rc = op dtype itertools product torch sqrt torch sin dtypes rc extend bench_unary op dtype=dtype Compare rc print Profile reduction ops rc = op torch sum torch max rc extend bench_reduction op Compare rc print Profile scan ops cumsum rc = dtype dtypes rc extend bench_scan torch cumsum dtype=dtype Compare rc print Profile scan indices ops cummin rc = dtype dtypes rc extend bench_scan torch cummin dtype=dtype with_indices=True Compare rc print Profile binary ops rc = ops = torch fmax torch add op dtype itertools product ops dtypes rc extend bench_binary op dt_a=dtype dtype == torch float rc extend bench_binary op dt_b=torch float Compare rc print __name__ == __main__ torch _dynamo config cache_size_limit = main
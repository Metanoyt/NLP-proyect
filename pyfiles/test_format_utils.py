Owner s oncall distributed torch torch distributed dist torch distributed checkpoint dcp torch nn nn torch nn functional F torch distributed checkpoint format_utils BroadcastingTorchSaveReader dcp_to_torch_save DynamicMetaLoadPlanner torch_save_to_dcp torch distributed device_mesh init_device_mesh torch distributed fsdp FullyShardedDataParallel FSDP torch testing _internal common_distributed skip_if_lt_x_gpu torch testing _internal common_utils run_tests torch testing _internal distributed _tensor common_dtensor DTensorTestBase with_comms torch testing _internal distributed checkpoint_utils with_temp_dir device_type = acc type acc = torch accelerator current_accelerator cpu SimpleModelUneven nn Module __init__ - None super __init__ torch manual_seed net = nn Linear relu = nn ReLU net = nn Linear net = nn Linear net = nn Linear forward x x = F relu net x x = F relu net x x = F relu net x x = net x x get_input torch rand device=device_type TestFormatUtils DTensorTestBase with_temp_dir test_dcp_to_torch_save - None model = SimpleModelUneven dcp save model model checkpoint_id=self temp_dir torch_path = temp_dir + model pt dcp_to_torch_save temp_dir torch_path loaded_sd = torch load torch_path assertEqual loaded_sd model model state_dict with_temp_dir test_torch_save_to_dcp - None model = SimpleModelUneven sd = model model state_dict torch_path = temp_dir + model pt torch save sd torch_path torch_save_to_dcp torch_path temp_dir model = SimpleModelUneven dcp load model model checkpoint_id=self temp_dir assertEqual model model state_dict sd with_comms with_temp_dir skip_if_lt_x_gpu test_online_torch_save_to_dcp - None Tests loading model saved torch save directly into sharded model using dcp load Save model torch save model = SimpleModelUneven sd = model model state_dict torch_fn = temp_dir + model pt dist get_rank == torch save sd torch_fn dist barrier Load into sharded model device_mesh = init_device_mesh device_type world_size model = SimpleModelUneven device_type model = FSDP model device_mesh=device_mesh use_orig_params=True dcp load model model planner=DynamicMetaLoadPlanner storage_reader=BroadcastingTorchSaveReader checkpoint_id=torch_fn assertEqual sd model model state_dict __name__ == __main__ run_tests
Compatibility functions torch onnx export API mypy allow-untyped-defs mypy disable-error-code=attr-defined __future__ annotations io logging warnings collections abc Callable Mapping Sequence typing Any TYPE_CHECKING torch torch onnx _constants onnx_constants torch onnx _internal _lazy_import onnx onnxscript_apis onnxscript_ir ir torch onnx _internal exporter _constants _core _dynamic_shapes _onnx_program _registration TYPE_CHECKING os logger = logging getLogger __name__ _get_torch_export_args args tuple Any kwargs dict str Any &#124; None - tuple tuple Any dict str Any &#124; None Obtain arguments torch onnx export model input arguments kwargs args isinstance args - dict kwargs = args - args = args - args kwargs export_compat model torch nn Module &#124; torch export ExportedProgram &#124; torch jit ScriptModule &#124; torch jit ScriptFunction args tuple Any f str &#124; os PathLike &#124; None = None kwargs dict str Any &#124; None = None export_params bool = True verbose bool &#124; None = None input_names Sequence str &#124; None = None output_names Sequence str &#124; None = None opset_version int &#124; None = onnx_constants ONNX_DEFAULT_OPSET custom_translation_table dict Callable Callable &#124; Sequence Callable &#124; None = None dynamic_axes Mapping str Mapping int str &#124; Mapping str Sequence int &#124; None = None dynamic_shapes dict str Any &#124; tuple Any &#124; list Any &#124; None = None keep_initializers_as_inputs bool = False external_data bool = True report bool = False optimize bool = True verify bool = False profile bool = False dump_exported_program bool = False artifacts_dir str &#124; os PathLike = fallback bool = False Legacy export parameters fallback legacy_export_kwargs dict str Any &#124; None = None - _onnx_program ONNXProgram opset_version None opset_version = onnx_constants ONNX_DEFAULT_OPSET isinstance model torch nn Module model training warnings warn Exporting model while training mode Please ensure intended may lead different behavior during inference Calling model eval before export recommended UserWarning stacklevel= isinstance model torch export ExportedProgram We know model already exported program so args kwargs dynamic_shapes used dynamic_shapes = dynamic_shapes args kwargs = _get_torch_export_args args kwargs dynamic_shapes None dynamic_axes None warnings warn dynamic_axes recommended when dynamo=True may lead torch _dynamo exc UserError Constraints violated Supply dynamic_shapes argument instead export unsuccessful UserWarning stacklevel= try dynamic_shapes args kwargs = _dynamic_shapes from_dynamic_axes_to_dynamic_shapes model args kwargs dynamic_axes=dynamic_axes input_names=input_names output_names=set output_names except Exception e raise RuntimeError Failed convert dynamic_axes dynamic_shapes Please provide dynamic_shapes directly Refer documentation torch export export more information dynamic shapes e dynamic_shapes_with_export_dim need_axis_mapping = _dynamic_shapes convert_str_to_export_dim dynamic_shapes opset_version _constants TORCHLIB_OPSET logger warning Setting ONNX exporter use operator set version s because requested opset_version s lower version than we have implementations Automatic version conversion will performed which may successful converting requested version If version conversion unsuccessful opset version exported model will kept s Please consider setting opset_version = s leverage latest ONNX features _constants TORCHLIB_OPSET opset_version _constants TORCHLIB_OPSET _constants TORCHLIB_OPSET registry_opset_version = _constants TORCHLIB_OPSET registry_opset_version = opset_version registry = _registration ONNXRegistry from_torchlib opset_version=registry_opset_version custom_translation_table None torch_op onnx_ops custom_translation_table items TODO justinchuby Support complex inputs annotations isinstance onnx_ops Sequence onnx_ops = onnx_ops op reversed onnx_ops register_op places op front all onnx variants so we reverse list maintain order custom ops provided registry register_op torch_op op is_complex=False try onnx_program = _core export model args kwargs registry=registry dynamic_shapes=dynamic_shapes_with_export_dim input_names=input_names output_names=output_names profile=profile report=report verify=verify dump_exported_program=dump_exported_program artifacts_dir=artifacts_dir verbose=verbose except Exception e fallback verbose False print torch onnx Falling back legacy torch onnx export due f following error e f None raise TypeError f must provided when fallback enabled e dynamic_shapes None dynamic_axes None input_names None raise ValueError Failed convert dynamic_shapes dynamic_axes Either input_names dynamic_axes must provided when dynamic requested fallback e dynamic_axes = _dynamic_shapes from_dynamic_shapes_to_dynamic_axes dynamic_shapes=dynamic_shapes input_names=input_names exception=e Use legacy export kwargs prepared __init__ py legacy_export_kwargs None legacy_export_kwargs = torch onnx utils export model type ignore arg-type args f type ignore arg-type kwargs=kwargs export_params=export_params input_names=input_names output_names=output_names opset_version=opset_version dynamic_axes=dynamic_axes keep_initializers_as_inputs=keep_initializers_as_inputs legacy_export_kwargs onnx_program = _onnx_program ONNXProgram ir load f None NOTE It s falling back legacy exporter we don t need optimize model so we here Users can still optimize model using optimize they want onnx_program raise need_axis_mapping dynamic_shapes None onnx_program _rename_dynamic_axes dynamic_shapes Converter opset version optimize onnx_program model = onnxscript_apis convert_version onnx_program model opset_version optimize onnx_program optimize f None isinstance f io BytesIO For legacy export compatibility we allow f BytesIO object This explicitly supported we may need maintain behavior indefinitely warnings warn Saving ONNX model BytesIO object deprecated Please use file path instead DeprecationWarning stacklevel= onnx save onnx_program model_proto f onnx_program save f include_initializers=export_params keep_initializers_as_inputs=keep_initializers_as_inputs external_data=external_data onnx_program
Owner s module onnx io itertools onnx pytorch_test_common torch torch onnx torch nn Module torch onnx producer_name producer_version torch onnx _internal torchscript_exporter _globals GLOBALS torch testing _internal common_utils check_onnx_opset_operator model ops opset_version=GLOBALS export_onnx_opset_version check_onnx_components assert model producer_name == producer_name model producer_version == producer_version model opset_import version == opset_version check schema onnx checker onnx checker check_model model check target type attributes graph = model graph ops should contain object each node graph node right order At least op_name should specified op s attributes can optionally specified well assert len ops == len graph node i range len ops assert graph node i op_type == ops i op_name attributes ops i attributes = ops i attributes assert len attributes == len graph node i attribute j range len attributes attribute_field attributes j keys assert attributes j attribute_field == getattr graph node i attribute j attribute_field check_onnx_opsets_operator module x ops opset_versions training=torch onnx TrainingMode EVAL input_names=None dynamic_axes=None opset_version opset_versions f = io BytesIO torch onnx export module x f opset_version=opset_version training=training input_names=input_names dynamic_axes=dynamic_axes dynamo=False model = onnx load io BytesIO f getvalue check_onnx_opset_operator model ops opset_version opset_version TestONNXOpset pytorch_test_common ExportTestCase test_opset_fallback MyModule Module forward x torch isnan x ops = op_name IsNaN ops = ops ops x = torch tensor float nan check_onnx_opsets_operator MyModule x ops opset_versions= test_topk MyModule Module forward x torch topk x ops_ = op_name TopK attributes name axis i - type name k i type ops_ = op_name Constant op_name TopK attributes name axis i - type ops = ops_ ops_ x = torch arange requires_grad=True check_onnx_opsets_operator MyModule x ops opset_versions= test dynamic k MyModuleDynamic torch jit ScriptModule torch jit script_method forward input k torch topk input k ops_ = op_name Constant attributes name value type op_name Reshape op_name TopK attributes name axis i - type ops = ops_ x = torch arange requires_grad=True k = torch tensor module = MyModuleDynamic check_onnx_opsets_operator module x k ops opset_versions= test_maxpool module = torch nn MaxPool d stride= ops_ = op_name MaxPool attributes name kernel_shape ints type name pads ints type name strides ints type ops_ = op_name MaxPool attributes name ceil_mode i type name dilations ints type name kernel_shape ints type name pads ints type name strides ints type ops = ops_ ops_ x = torch randn check_onnx_opsets_operator module x ops opset_versions= add test dilations module = torch nn MaxPool d stride= dilation= ops_ = op_name MaxPool attributes name ceil_mode i type name dilations ints type name kernel_shape ints type name pads ints type name strides ints type ops = ops_ x = torch randn check_onnx_opsets_operator module x ops opset_versions= test_upsample MyModule Module forward x size = v v x size size = int i i size torch nn functional interpolate x size=size mode= nearest module = MyModule ops = op_name Upsample attributes name mode s b nearest type name scales floats type ops = op_name Constant op_name Upsample attributes name mode s b nearest type ops = ops ops x = torch randn check_onnx_opsets_operator module x ops opset_versions= test_cast_constant MyModule Module forward x x - module = MyModule ops_ = op_name Constant op_name Cast attributes name i type op_name Sub ops_ = op_name Constant op_name Sub ops = ops_ ops_ x = torch ones dtype=torch long check_onnx_opsets_operator module x ops opset_versions= test_slice MyModule Module forward x x ops_ = op_name Slice attributes name axes ints type name ends ints type name starts ints type ops_ = op_name Constant op_name Constant op_name Constant op_name Constant op_name Slice attributes ops = ops_ ops_ x = torch randn check_onnx_opsets_operator MyModule x ops opset_versions= DynamicSliceModel torch jit ScriptModule torch jit script_method forward x x x size module = DynamicSliceModel x = torch rand ops_ = op_name Shape op_name Constant op_name Gather attributes name axis i type op_name Constant op_name Constant op_name Unsqueeze attributes name axes i type op_name Constant op_name Slice attributes ops = ops_ check_onnx_opsets_operator module x ops opset_versions= input_names= x dynamic_axes= x ops_ = op_name Constant op_name Constant op_name Constant op_name Constant op_name Slice attributes ops = ops_ check_onnx_opsets_operator module x ops opset_versions= test_flip MyModule Module forward x torch flip x dims= ops_ = op_name Constant op_name Constant op_name Constant op_name Constant op_name Slice attributes ops = ops_ numpy x = torch tensor numpy arange reshape check_onnx_opsets_operator MyModule x ops opset_versions= test_dropout MyModule Module __init__ - None super __init__ dropout = torch nn Dropout forward x dropout x x = torch randn we should only export onnx Dropout op training mode test both modes test training mode ops = op_name Dropout attributes name ratio f type ops = ops ops check_onnx_opsets_operator MyModule x ops opset_versions= training=torch onnx TrainingMode TRAINING test eval mode ops = op_name Identity ops = ops ops check_onnx_opsets_operator MyModule x ops opset_versions= training=torch onnx TrainingMode EVAL test_full MyModule Module forward x torch full x ops = op_name Constant op_name ConstantOfShape op_name Add ops = ops ops x = torch tensor check_onnx_opsets_operator MyModule x ops opset_versions= test_interpolate MyModel torch nn Module forward x size = v v x size torch nn functional interpolate x size=size mode= nearest ops_ = op_name Shape op_name Constant op_name Gather op_name Shape op_name Constant op_name Gather op_name Constant op_name Mul op_name Constant op_name Mul op_name Unsqueeze op_name Unsqueeze op_name Concat op_name Cast op_name Shape op_name Slice op_name Cast op_name Div op_name Constant op_name Concat op_name Upsample attributes name mode s b nearest type ops_ = op_name Shape op_name Constant op_name Gather op_name Shape op_name Constant op_name Gather op_name Constant op_name Mul op_name Constant op_name Mul op_name Unsqueeze op_name Unsqueeze op_name Concat op_name Cast op_name Shape op_name Constant op_name Constant op_name Constant op_name Slice op_name Cast op_name Div op_name Constant op_name Concat op_name Resize attributes name mode s b nearest type ops = ops_ ops_ x = torch randn requires_grad=True check_onnx_opsets_operator MyModel x ops opset_versions= input_names= x dynamic_axes= x ops_ = op_name Constant op_name Shape op_name Slice op_name Cast op_name Div op_name Constant op_name Concat op_name Upsample attributes name mode s b nearest type ops_ = op_name Constant op_name Shape op_name Constant op_name Constant op_name Constant op_name Slice op_name Cast op_name Div op_name Constant op_name Concat op_name Resize ops = ops_ ops_ x = torch randn requires_grad=True check_onnx_opsets_operator MyModel x ops opset_versions= MyDynamicModel torch nn Module forward x size = v v x size work around now turn dynamic sizes into constant size = int i i size torch nn functional interpolate x size=size mode= nearest ops_ = op_name Constant op_name Upsample attributes name mode s b nearest type ops_ = op_name Constant op_name Resize attributes name mode s b nearest type ops = ops_ ops_ x = torch randn check_onnx_opsets_operator MyDynamicModel x ops opset_versions= test_affine_grid MyModule Module __init__ align_corners super __init__ align_corners = align_corners forward theta size torch nn functional affine_grid theta size align_corners=self align_corners opset_version = ops_ d = opset_version op_name Constant op_name Unsqueeze op_name Constant op_name Unsqueeze op_name Constant op_name Unsqueeze op_name Constant op_name Unsqueeze op_name Concat op_name AffineGrid ops_ d = opset_version op_name Constant op_name Unsqueeze op_name Constant op_name Unsqueeze op_name Constant op_name Unsqueeze op_name Constant op_name Unsqueeze op_name Constant op_name Unsqueeze op_name Concat op_name AffineGrid D affine theta_ d = torch empty dtype=torch double size_ d = torch Size D affine theta_ d = torch empty dtype=torch double size_ d = torch Size inputs align_corners itertools product theta_ d size_ d ops_ d theta_ d size_ d ops_ d True False theta size ops = inputs args = theta size check_onnx_opsets_operator MyModule align_corners=align_corners args ops opset_versions= opset_version training=torch onnx TrainingMode TRAINING check_onnx_opsets_operator MyModule align_corners=align_corners args ops opset_versions= opset_version training=torch onnx TrainingMode EVAL test_grid_sample MyModule torch nn Module __init__ mode padding_mode align_corners super __init__ mode = mode padding_mode = padding_mode align_corners = align_corners forward x grid torch nn functional grid_sample x grid mode=self mode padding_mode=self padding_mode align_corners=self align_corners mode padding_mode align_corners opset_version itertools product bilinear nearest bicubic zeros border reflection True False test_eval_and_training ops opset_version mode padding_mode align_corners x_shape grid args = torch randn x_shape x torch randn grid grid check_onnx_opsets_operator MyModule mode=mode padding_mode=padding_mode align_corners=align_corners args ops opset_versions= opset_version training=torch onnx TrainingMode TRAINING check_onnx_opsets_operator MyModule mode=mode padding_mode=padding_mode align_corners=align_corners args ops opset_versions= opset_version training=torch onnx TrainingMode EVAL ops = opset_version op_name GridSample mode = convert_grid_sample_mode mode opset_version == mode n c d_in h_in w_in d_out h_out w_out = test_eval_and_training ops opset_version mode padding_mode align_corners n c h_in w_in n h_out w_out opset_version == mode = bicubic test_eval_and_training ops opset_version mode padding_mode align_corners n c d_in h_in w_in n d_out h_out w_out test_flatten MyModule Module forward x torch flatten x module = MyModule ops_ d = op_name Constant op_name Reshape ops_ d = op_name Identity shape x = torch randn shape opset_version ops = opset_version ops_ d len shape == ops_ d check_onnx_opsets_operator module x ops opset_versions= opset_version __name__ == __main__ common_utils run_tests
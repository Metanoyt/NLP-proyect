mypy allow-untyped-defs ast typing Optional _importlib _resolve_name _ExtractModuleReferences ast NodeVisitor Extract list global variables block code will read write classmethod run cls src str package str - list tuple str Optional str visitor = cls package tree = ast parse src visitor visit tree list visitor references keys __init__ package super __init__ package = package references = _absmodule module_name str level int - str level _resolve_name module_name package level module_name visit_Import node alias node names references alias name None = True visit_ImportFrom node name = _absmodule node module node level None node level alias node names my_package foo foo may module so we have add list potential references fails we will ignore alias name = references name alias name = True references name None = True _grab_node_int node node value _grab_node_str node node value visit_Call node __import__ calls aren t routed visit_Import From nodes hasattr node func id node func id == __import__ try name = _grab_node_str node args fromlist list str = level = len node args fromlist extend _grab_node_str v v node args elts hasattr node keywords keyword node keywords keyword arg == fromlist fromlist extend _grab_node_str v v keyword value elts len node args level = _grab_node_int node args hasattr node keywords keyword node keywords keyword arg == level level = _grab_node_int keyword value fromlist == top-level package name up till first dot returned when fromlist argument empty normal system we need include top level package match behavior last level package capture intended dependency user references name None = True top_name = name rsplit maxsplit= top_name = name top_name = _absmodule top_name level references top_name None = True name = _absmodule name level alias fromlist fromlist args may submodules so we have add fromlist args list potential references If arg fails we will ignore similar visit_ImportFrom alias = references name alias = True references name None = True except Exception find_files_source_depends_on = _ExtractModuleReferences run
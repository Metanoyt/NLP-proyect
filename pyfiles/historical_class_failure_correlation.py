__future__ annotations json os collections defaultdict typing Any cast warnings warn tools stats import_test_stats ADDITIONAL_CI_FILES_FOLDER TEST_CLASS_RATINGS_FILE tools testing target_determination heuristics interface HeuristicInterface TestPrioritizations tools testing target_determination heuristics utils normalize_ratings query_changed_files REPO_ROOT tools testing test_run TestRun HistoricalClassFailurCorrelation HeuristicInterface This heuristic prioritizes test classes have historically tended fail when files edited current PR modified __init__ kwargs Any - None super __init__ kwargs get_prediction_confidence tests list str - TestPrioritizations ratings = _get_ratings_for_tests set tests test_ratings = TestRun k v k v ratings items TestRun k test_file tests TestPrioritizations tests normalize_ratings test_ratings _get_historical_test_class_correlations - dict str dict str float path = REPO_ROOT ADDITIONAL_CI_FILES_FOLDER TEST_CLASS_RATINGS_FILE os path exists path print f could find path path open path f test_class_correlations = cast dict str dict str float json load f test_class_correlations _get_ratings_for_tests tests_to_run set str - dict str float Get files edited try changed_files = query_changed_files except Exception e warn f Can t query changed test files due e test_class_correlations = _get_historical_test_class_correlations test_class_correlations Find tests failures correlated edited files Filter list only include tests we want run ratings dict str float = defaultdict float file changed_files qualified_test_class score test_class_correlations get file items qualified_test_class looks like test_file test_class test_file test_class = qualified_test_class split test_file tests_to_run ratings qualified_test_class += score ratings _rank_correlated_tests tests_to_run list str - list str Find tests failures correlated edited files Filter list only include tests we want run pyrefly ignore bad-assignment tests_to_run = set tests_to_run pyrefly ignore bad-argument-type ratings = _get_ratings_for_tests tests_to_run prioritize = sorted ratings key=lambda x -ratings x prioritize
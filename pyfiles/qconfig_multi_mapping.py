mypy allow-untyped-defs __future__ annotations copy typing Any TYPE_CHECKING Union torch torch ao quantization QConfigMapping torch ao quantization qconfig_mapping _QCONFIG_STYLE_ORDER TYPE_CHECKING collections abc Callable torch ao quantization qconfig QConfigAny __all__ = QConfigMultiMapping _QCONFIG_STYLE_TO_METHOD dict str str = global_qconfig set_global object_type_qconfigs set_object_type module_name_regex_qconfigs set_module_name_regex module_name_qconfigs set_module_name module_name_object_type_order_qconfigs set_module_name_object_type_order _remove_duplicates_and_none qconfig_list list QConfigAny - None to_remove = index cur_qconfig enumerate qconfig_list cur_qconfig None to_remove append index break checked_qconfig qconfig_list index torch ao quantization qconfig_equals cur_qconfig checked_qconfig to_remove append index break index to_remove - qconfig_list pop index QConfigMultiMapping This used prepare_n_shadows_model API stores list ` torch ao quantization QConfigMapping ` s so multiple QConfigs can specified each QConfig matching style The user can specify QConfigs using following methods increasing match priority ` ` set_global ` ` sets global default QConfigs ` ` set_object_type ` ` sets QConfigs given module type function method name ` ` set_module_name_regex ` ` sets QConfigs modules matching given regex string ` ` set_module_name ` ` sets QConfigs modules matching given module name ` ` set_module_name_object_type_order ` ` sets QConfigs modules matching combination given module name object type index which module appears Note Usage set methods same QConfigMapping except passed list QConfigs rather than single QConfig Example usage qconfig_mapping = QConfigMultiMapping set_global qconfig qconfig set_object_type torch nn Linear qconfig qconfig set_object_type torch nn ReLU qconfig set_module_name_regex foo bar conv - + qconfig set_module_name_regex foo qconfig qconfig qconfig set_module_name module None set_module_name module qconfig set_module_name_object_type_order foo bar torch nn functional linear qconfig __init__ - None initialize QConfigMapping avoid corner cases qconfig_mappings_list list QConfigMapping = QConfigMapping _handle_list_size_mismatch qconfig_list list QConfigAny style str - None method handles cases where size qconfig_list does match size qconfig_mappings_list Issue Consider user inserting global_qconfig A B first then inserting qconfig C object_type_qconfig conv ops If we internally store QConfigMapping A C another just B then second QConfigMapping will match B conv ops which wanted since B global we avoid maintaining invariant any QConfigMapping has qconfig style+key qconfig all QConfigMappings must have either qconfig None same style+key In above example None qconfig would prevent unwanted match second QConfigMapping len qconfig_list len qconfig_mappings_list Case we have more qconfigs qconfig_list than QConfigMappings Add new QConfigMappings initialized so we maintain ` invariant ` new_qconfig_mapping = QConfigMapping searches other QConfigMappings qconfig style+keys need inserted ` None ` into new QConfigMapping qconfig_mapping qconfig_mappings_list global_qconfig has None default check_style _QCONFIG_STYLE_ORDER qconfigs_dict = getattr qconfig_mapping check_style target_qconfigs_dict = getattr new_qconfig_mapping check_style key qconfigs_dict target_qconfigs_dict key = None break insert copies new QConfigMapping until all entries qconfig_list can fit among QConfigMappings while len qconfig_list len qconfig_mappings_list qconfig_mappings_list append copy deepcopy new_qconfig_mapping Case we have fewer qconfigs qconfig_list than QConfigMappings pad qconfig_list ` None ` until length same while len qconfig_list len qconfig_mappings_list qconfig_list append None function applies insertion method across each QConfigMapping _insert_qconfig_list style str args list Union str int Callable qconfig_list list QConfigAny - None we remove duplicates None make ordering qconfigs deterministic upon insertion _remove_duplicates_and_none qconfig_list _handle_list_size_mismatch qconfig_list style method_name = _QCONFIG_STYLE_TO_METHOD style qconfig_mapping qconfig zip qconfig_mappings_list qconfig_list uses QConfigMapping set method insert qconfig set_method = getattr qconfig_mapping method_name set_method args qconfig set_global global_qconfig_list list QConfigAny - QConfigMultiMapping Set global QConfigs see func ` ~torch ao quantization QConfigMapping set_global ` more info _insert_qconfig_list global_qconfig global_qconfig_list set_object_type object_type Union Callable str qconfig_list list QConfigAny - QConfigMultiMapping Set object type QConfigs see func ` ~torch ao quantization QConfigMapping set_object_type ` more info _insert_qconfig_list object_type_qconfigs object_type qconfig_list set_module_name_regex module_name_regex str qconfig_list list QConfigAny - QConfigMultiMapping Set module_name_regex QConfigs see func ` ~torch ao quantization QConfigMapping set_module_name_regex ` more info _insert_qconfig_list module_name_regex_qconfigs module_name_regex qconfig_list set_module_name module_name str qconfig_list list QConfigAny - QConfigMultiMapping Set module_name QConfigs see func ` ~torch ao quantization QConfigMapping set_module_name ` more info _insert_qconfig_list module_name_qconfigs module_name qconfig_list set_module_name_object_type_order module_name str object_type Callable index int qconfig_list list QConfigAny - QConfigMultiMapping Set module_name QConfigs see func ` ~torch ao quantization QConfigMapping set_module_name_object_type_order ` more info _insert_qconfig_list module_name_object_type_order_qconfigs module_name object_type index qconfig_list __repr__ __class__ __name__ + + join f \n qconfig_mapping __repr__ qconfig_mapping qconfig_mappings_list + \n classmethod from_list_qconfig_mapping cls qconfig_mapping_list list QConfigMapping - QConfigMultiMapping Creates QConfigMultiMapping list QConfigMappings new_qconfig_multi_mapping = cls new_qconfig_multi_mapping qconfig_mappings_list = copy deepcopy qconfig_mapping_list we need avoid issue described _handle_list_size_mismatch so we reinsert all qconfigs using QConfigMultiMapping set methods go through all qconfig styles note global can ignored since None default style _QCONFIG_STYLE_ORDER gather all key+qconfigs current style into qconfig_dict_list qconfig_dict_list dict Any list QConfigAny = qconfig_mapping qconfig_mapping_list qconfig_dict = getattr qconfig_mapping style key qconfig qconfig_dict items key qconfig_dict_list qconfig_dict_list key = qconfig_dict_list key append qconfig reinsert all gathered key+qconfigs set_method_name = _QCONFIG_STYLE_TO_METHOD style set_method = getattr new_qconfig_multi_mapping set_method_name key qconfig_list qconfig_dict_list items isinstance key tuple set_method key qconfig_list set_method key qconfig_list new_qconfig_multi_mapping
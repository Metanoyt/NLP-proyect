logging operator torch torch ao quantization pt e utils _filter_sym_size_users _is_valid_annotation torch fx node map_arg torch fx passes infra pass_base PassBase PassResult logger = logging getLogger __name__ logger setLevel logging WARNING __all__ = DuplicateDQPass _QUANTIZE_OPS = torch ops quantized_decomposed quantize_per_tensor default torch ops quantized_decomposed quantize_per_tensor tensor torch ops quantized_decomposed quantize_per_channel default _DEQUANTIZE_OPS = torch ops quantized_decomposed dequantize_per_tensor default torch ops quantized_decomposed dequantize_per_tensor tensor torch ops quantized_decomposed dequantize_per_channel default _maybe_duplicate_dq gm torch fx GraphModule dq_node torch fx Node user torch fx Node - None annotation = user meta get quantization_annotation None _is_valid_annotation annotation type ignore arg-type gm graph inserting_after dq_node new_node = gm graph node_copy dq_node maybe_replace_node n torch fx Node - torch fx Node n == dq_node new_node n new_args = map_arg user args maybe_replace_node new_kwargs = map_arg user kwargs maybe_replace_node user args = new_args type ignore assignment user kwargs = new_kwargs type ignore assignment DuplicateDQPass PassBase call graph_module torch fx GraphModule - PassResult node graph_module graph nodes node op == call_function node target _DEQUANTIZE_OPS dq_users = _filter_sym_size_users node len dq_users = continue Do duplicate dq dynamic quantization Pattern choose_qparam - getitem - q - dq q_node = node args q_node op == call_function q_node target _QUANTIZE_OPS getitem_node = q_node args isinstance getitem_node torch fx node Node getitem_node op == call_function getitem_node target operator getitem choose_qparam_node = getitem_node args isinstance choose_qparam_node torch fx node Node choose_qparam_node op == call_function choose_qparam_node target == torch ops quantized_decomposed choose_qparams tensor continue user dq_users _maybe_duplicate_dq graph_module node user graph_module graph eliminate_dead_code graph_module recompile PassResult graph_module True
Python polyfills torch utils pytree __future__ annotations collections deque dataclasses dataclass field typing Any TYPE_CHECKING typing_extensions TypeIs torch utils _pytree python_pytree torch utils _pytree BUILTIN_TYPES STANDARD_DICT_TYPES decorators substitute_in_graph TYPE_CHECKING builtins collections abc Callable Iterable Mapping typing_extensions Self __all__ list str = python_pytree _cxx_pytree_dynamo_traceable optree optree _C torch utils _cxx_pytree cxx_pytree noqa F TYPE_CHECKING torch utils _cxx_pytree PyTree substitute_in_graph optree _C is_dict_insertion_ordered can_constant_fold_through=True _ args Any kwargs Any - bool In namespace torch dictionary always traversed insertion order This function returns True raise ValueError Should called directly because original function will called constant fold path __name = __name is_namedtuple is_namedtuple_class is_namedtuple_instance is_structseq is_structseq_class is_structseq_instance namedtuple_fields structseq_fields __func = getattr optree __name globals __name = substitute_in_graph __func can_constant_fold_through=True __func __python_implementation__ __all__ += __name noqa PLE del __func del __name substitute_in_graph optree tree_is_leaf can_constant_fold_through=True tree_is_leaf tree PyTree is_leaf Callable PyTree bool &#124; None = None none_is_leaf bool = False namespace str = - bool tree None none_is_leaf is_leaf None is_leaf tree True optree register_pytree_node get type tree namespace=namespace None type ignore attr-defined True False substitute_in_graph optree tree_iter can_constant_fold_through=False tree_iter tree PyTree is_leaf Callable PyTree bool &#124; None = None none_is_leaf bool = False namespace str = - Iterable Any stack = tree while stack node = stack pop tree_is_leaf node is_leaf=is_leaf none_is_leaf=none_is_leaf namespace=namespace yield node continue children _ = optree tree_flatten_one_level node is_leaf=is_leaf none_is_leaf=none_is_leaf namespace=namespace stack extend reversed children __all__ += tree_iter substitute_in_graph optree tree_leaves can_constant_fold_through=True tree_leaves tree PyTree is_leaf Callable PyTree bool &#124; None = None none_is_leaf bool = False namespace str = - list Any list tree_iter tree is_leaf=is_leaf none_is_leaf=none_is_leaf namespace=namespace __all__ += tree_leaves _Asterisk str __slots__ = __new__ cls - Self super __new__ cls __repr__ - str no quotes _asterisk = _Asterisk del _Asterisk dataclass frozen=True PyTreeSpec Analog ` optree PyTreeSpec ` Python _children tuple PyTreeSpec _type builtins type &#124; None _metadata Any _entries tuple Any _unflatten_func Callable Any &#124; None Iterable PyTree PyTree &#124; None none_is_leaf bool namespace str num_nodes int = field init=False num_leaves int = field init=False num_children int = field init=False __post_init__ - None _type None assert len _children == assert _metadata None assert _entries == assert _unflatten_func None num_nodes = num_leaves = num_children = assert callable _unflatten_func num_nodes = sum spec num_nodes spec _children start= num_leaves = sum spec num_leaves spec _children num_children = len _children object __setattr__ num_nodes num_nodes object __setattr__ num_leaves num_leaves object __setattr__ num_children num_children __repr__ - str helper treespec PyTreeSpec - str treespec is_leaf assert treespec type None _asterisk assert treespec type None assert callable treespec _unflatten_func children_representations = helper subspec subspec treespec _children treespec type BUILTIN_TYPES treespec type type None none_is_leaf optree is_namedtuple_class treespec type optree is_structseq_class treespec type pyrefly ignore bad-return treespec _unflatten_func treespec _metadata children_representations f CustomTreeNode treespec type __name__ treespec _metadata r f join children_representations inner = str helper NoneIsLeaf none_is_leaf f namespace= namespace r f PyTreeSpec join inner __len__ - int num_leaves property type - builtins type &#124; None _type is_leaf - bool num_nodes == num_leaves == children - list PyTreeSpec list _children child index int - PyTreeSpec _children index entries - list Any list _entries entry index int - Any _entries index flatten_up_to tree PyTree - list PyTree helper treespec PyTreeSpec node PyTree subtrees list PyTree - None treespec is_leaf subtrees append node node_type = type node treespec type BUILTIN_TYPES Always require custom node types match exactly node_type = treespec type raise ValueError f Type mismatch f expected treespec type r got node_type r children metadata _ = optree tree_flatten_one_level node none_is_leaf=self none_is_leaf namespace=self namespace len children = treespec num_children raise ValueError f Node arity mismatch f expected treespec num_children got len children metadata = treespec _metadata raise ValueError f Node context mismatch custom node type treespec type r For builtin dictionary types we allow some flexibility Otherwise we require exact matches both_standard_dict = treespec type STANDARD_DICT_TYPES node_type STANDARD_DICT_TYPES both_standard_dict node_type = treespec type raise ValueError f Node type mismatch f expected treespec type r got node_type r len node = treespec num_children raise ValueError f Node arity mismatch f expected treespec num_children got len node both_standard_dict dictionary types compatible each other expected_keys = treespec entries got_key_set = set node expected_key_set = set expected_keys got_key_set = expected_key_set missing_keys = expected_key_set difference got_key_set extra_keys = got_key_set difference expected_key_set message = missing_keys message += f missing key s missing_keys extra_keys message += f extra key s extra_keys raise ValueError f Node keys mismatch message children = node key key expected_keys node_type treespec type children metadata _ = optree tree_flatten_one_level node none_is_leaf=self none_is_leaf namespace=self namespace node_type deque ignore mismatch ` maxlen ` deque metadata = treespec _metadata raise ValueError f Node metadata mismatch node type treespec type r f expected treespec _metadata r got metadata r namedtuple type mismatch subtree subspec zip children treespec _children helper subspec subtree subtrees subtrees list PyTree = helper tree subtrees subtrees unflatten leaves Iterable Any - PyTree isinstance leaves list tuple leaves = list leaves len leaves = num_leaves raise ValueError f treespec unflatten leaves ` leaves ` has length len leaves f spec refers pytree holds num_leaves f items is_leaf leaves Recursively unflatten children start = end = subtrees = subspec _children end += subspec num_leaves subtrees append subspec unflatten leaves start end start = end assert callable _unflatten_func _unflatten_func _metadata subtrees _is_pytreespec_instance obj Any - TypeIs PyTreeSpec isinstance obj PyTreeSpec substitute_in_graph type ignore arg-type optree treespec_leaf We need disable constant folding here because we want function reference PyTreeSpec defined above one C++ module can_constant_fold_through=False treespec_leaf none_is_leaf bool = False namespace str = unused - PyTreeSpec PyTreeSpec None None None none_is_leaf=none_is_leaf namespace= substitute_in_graph type ignore arg-type optree treespec_tuple We need disable constant folding here because we want function reference PyTreeSpec defined above one C++ module can_constant_fold_through=False treespec_tuple iterable Iterable PyTreeSpec = none_is_leaf bool = False namespace str = - PyTreeSpec children = tuple iterable any _is_pytreespec_instance child child children raise ValueError f Expected tuple PyTreeSpecs got children r any child none_is_leaf = none_is_leaf child children raise ValueError All children PyTreeSpecs must have same ` none_is_leaf ` value f parent expected none_is_leaf got children r any child namespace namespace child children raise ValueError All children PyTreeSpecs must have same ` namespace ` value f parent expected namespace r got children r handler = optree register_pytree_node get tuple namespace=namespace type ignore attr-defined assert handler None PyTreeSpec tuple children tuple None tuple range len children handler unflatten_func none_is_leaf=none_is_leaf namespace=namespace substitute_in_graph type ignore arg-type optree treespec_dict We need disable constant folding here because we want function reference PyTreeSpec defined above one C++ module can_constant_fold_through=False treespec_dict mapping Mapping Any PyTreeSpec &#124; Iterable tuple Any PyTreeSpec = none_is_leaf bool = False namespace str = kwargs PyTreeSpec - PyTreeSpec dct = dict mapping kwargs any _is_pytreespec_instance child child dct values raise ValueError f Expected dictionary TreeSpecs got dct r any child none_is_leaf = none_is_leaf child dct values raise ValueError All children PyTreeSpecs must have same ` none_is_leaf ` value f parent expected none_is_leaf got dct r any child namespace namespace child dct values raise ValueError All children PyTreeSpecs must have same ` namespace ` value f parent expected namespace r got dct r children metadata entries unflatten_func = optree tree_flatten_one_level type ignore assignment var-annotated dct type ignore arg-type none_is_leaf=none_is_leaf namespace=namespace PyTreeSpec tuple children type ignore arg-type dict metadata entries unflatten_func none_is_leaf=none_is_leaf namespace=namespace substitute_in_graph type ignore arg-type optree tree_flatten We need disable constant folding here because we want function reference PyTreeSpec defined above one C++ module can_constant_fold_through=False tree_flatten tree PyTree is_leaf Callable PyTree bool &#124; None = None none_is_leaf bool = False namespace str = - tuple list Any PyTreeSpec helper node PyTree leaves list Any - PyTreeSpec tree_is_leaf node is_leaf=is_leaf none_is_leaf=none_is_leaf namespace=namespace leaves append node PyTreeSpec None None None none_is_leaf=none_is_leaf namespace=namespace children metadata entries unflatten_func = optree tree_flatten_one_level node is_leaf=is_leaf none_is_leaf=none_is_leaf namespace=namespace Recursively flatten children subspecs = tuple helper child leaves child children PyTreeSpec subspecs type node metadata entries unflatten_func none_is_leaf=none_is_leaf namespace=namespace type ignore arg-type leaves list Any = treespec = helper tree leaves leaves treespec __all__ += tree_flatten substitute_in_graph type ignore arg-type optree tree_structure We need disable constant folding here because we want function reference PyTreeSpec defined above one C++ module can_constant_fold_through=False tree_structure tree PyTree is_leaf Callable PyTree bool &#124; None = None none_is_leaf bool = False namespace str = - PyTreeSpec tree_flatten type ignore return-value tree is_leaf=is_leaf none_is_leaf=none_is_leaf namespace=namespace __all__ += tree_structure substitute_in_graph type ignore arg-type optree tree_unflatten We need disable constant folding here because we want function reference PyTreeSpec defined above one C++ module can_constant_fold_through=False tree_unflatten treespec PyTreeSpec leaves Iterable Any - PyTree _is_pytreespec_instance treespec raise TypeError f tree_unflatten leaves treespec Expected ` treespec ` instance f PyTreeSpec got item type type treespec treespec unflatten leaves __all__ += tree_unflatten substitute_in_graph optree tree_map can_constant_fold_through=True tree_map func Callable Any tree PyTree rests PyTree is_leaf Callable PyTree bool &#124; None = None none_is_leaf bool = False namespace str = - PyTree leaves treespec = tree_flatten tree is_leaf=is_leaf none_is_leaf=none_is_leaf namespace=namespace flat_args = leaves + treespec flatten_up_to r r rests treespec unflatten map func flat_args __all__ += tree_map substitute_in_graph optree tree_map_ can_constant_fold_through=True tree_map_ func Callable Any tree PyTree rests PyTree is_leaf Callable PyTree bool &#124; None = None none_is_leaf bool = False namespace str = - PyTree leaves treespec = tree_flatten tree is_leaf=is_leaf none_is_leaf=none_is_leaf namespace=namespace flat_args = leaves + treespec flatten_up_to r r rests deque map func flat_args maxlen= consume exhaust iterable tree __all__ += tree_map_ _none_unflatten = optree register_pytree_node get type None unflatten_func type ignore union-attr substitute_in_graph type ignore arg-type _none_unflatten can_constant_fold_through=True skip_signature_check=True none_unflatten _ None children Iterable Any - None len list children = raise ValueError Expected no children None
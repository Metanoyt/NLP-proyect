mypy allow-untyped-defs hashlib logging collections abc Sequence typing cast torch _inductor utils Placeholder torch utils _ordered_set OrderedSet config codecache code_hash get_path ir CuteDSLTemplateBuffer scheduler BaseSchedulerNode BaseScheduling FusedSchedulerNode SchedulerNode select_algorithm PartialRender utils get_fused_kernel_name get_kernel_metadata virtualized V common BackendFeature IndentedBuffer log = logging getLogger __name__ CuteDSLScheduling BaseScheduling Scheduling implementation CuteDSL CUTLASS Python DSL kernels This intended used combination other schedulers delegated CUDACombinedScheduling classmethod get_backend_features cls device - OrderedSet BackendFeature OrderedSet staticmethod is_cutedsl_template node BaseSchedulerNode - bool Check node CuteDSL template isinstance node SchedulerNode isinstance node node CuteDSLTemplateBuffer is_cutedsl_fused_template node BaseSchedulerNode - bool Check node fused CuteDSL template isinstance node FusedSchedulerNode is_cutedsl_template node can_fuse_vertical node BaseSchedulerNode node BaseSchedulerNode - bool TODO CuteDSL doesn t support vertical fusion yet This could extended future epilogue fusion False define_kernel src_code_str str node_schedule - str Produce kernel string Args src_code_str The finalized kernel code string node_schedule List nodes schedule Note This little weird since async_compile cutedsl has write string file order cute compile Feels bad have two wrapper = V graph wrapper_code Use string key caching src_code_str wrapper src_to_kernel kernel_name = wrapper src_to_kernel src_code_str fused_name = get_fused_kernel_name node_schedule config triton descriptive_names config triton descriptive_names kernel_hash = hashlib sha src_code_str encode utf- hexdigest fused_name == fused kernel_name = f cutedsl_ kernel_hash kernel_name = f cutedsl_ fused_name _ kernel_hash wrapper src_to_kernel src_code_str = kernel_name src_code_str = src_code_str replace str Placeholder KERNEL_NAME kernel_name _ _ kernel_path = get_path code_hash src_code_str py compile_wrapper = IndentedBuffer compile_wrapper writeline f async_compile cutedsl kernel_name r r compile_wrapper splice src_code_str strip=True compile_wrapper writeline metadata_comment = f kernel path kernel_path origins detailed_origins = get_kernel_metadata node_schedule wrapper metadata_comment += \n + origins + \n + detailed_origins wrapper define_kernel kernel_name compile_wrapper getvalue metadata_comment kernel_name codegen_template template_node BaseSchedulerNode epilogue_nodes Sequence BaseSchedulerNode prologue_nodes Sequence BaseSchedulerNode Codegen CuteDSL template Currently doesn t support fusion assert is_cutedsl_template template_node Template node passed CuteDSLScheduling codegen_template must SchedulerNode wraps CuteDSLTemplateBuffer TODO remove when supported assert epilogue_nodes CuteDSL doesn t support epilogue fusion yet assert prologue_nodes CuteDSL doesn t support prologue fusion yet template_node = cast SchedulerNode template_node ctb CuteDSLTemplateBuffer = cast CuteDSLTemplateBuffer template_node node kernel render = ctb make_kernel_render ctb type ignore misc template_node mark_run src_code = render Finalize PartialRender needed isinstance src_code PartialRender src_code_str = src_code finalize_all src_code_str = src_code V set_kernel_handler kernel node_schedule = template_node kernel_name = define_kernel src_code_str node_schedule codegen_comment node_schedule kernel_name kernel call_kernel kernel_name ctb V graph removed_buffers &#124; = kernel removed_buffers free_buffers_in_scheduler
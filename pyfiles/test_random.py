Owner s module dynamo Light smoke test switching between numpy pytorch random streams contextlib contextmanager functools partial numpy _np pytest torch _dynamo config config torch _numpy tnp torch _numpy testing assert_equal torch testing _internal common_utils instantiate_parametrized_tests parametrize run_tests subtest TestCase contextmanager control_stream use_numpy=False config patch use_numpy_random_stream=use_numpy yield instantiate_parametrized_tests TestScalarReturn TestCase parametrize use_numpy True False parametrize func tnp random normal tnp random rand partial tnp random randint tnp random randn subtest tnp random random name= random_random subtest tnp random random_sample name= random_sample tnp random sample tnp random uniform test_rndm_scalar func use_numpy default ` size ` means python scalar control_stream use_numpy r = func assert isinstance r int float parametrize use_numpy True False parametrize func tnp random normal tnp random rand partial tnp random randint tnp random randn subtest tnp random random name= random_random subtest tnp random random_sample name= random_sample tnp random sample tnp random uniform test_rndm_array func use_numpy control_stream use_numpy func tnp random rand tnp random randn r = func r = func size= assert isinstance r tnp ndarray instantiate_parametrized_tests TestShuffle TestCase parametrize use_numpy True False test_ d use_numpy ax = tnp asarray ox = ax copy tnp random seed tnp random shuffle ax assert isinstance ax tnp ndarray assert ax == ox all parametrize use_numpy True False test_ d use_numpy np shuffle only shuffles first axis ax = tnp asarray ox = ax copy tnp random seed tnp random shuffle ax assert isinstance ax tnp ndarray assert ax == ox all parametrize use_numpy True False test_shuffle_list use_numpy eager we refuse shuffle lists under dynamo we always fall back numpy NB means random stream different shuffling list array when USE_NUMPY_STREAM == False x = pytest raises NotImplementedError tnp random shuffle x instantiate_parametrized_tests TestChoice TestCase parametrize use_numpy True False test_choice use_numpy kwds = dict size= replace=False p= control_stream use_numpy tnp random seed x = tnp random choice kwds tnp random seed x_ = tnp random choice tnp arange kwds assert_equal x x_ TestNumpyGlobal TestCase test_numpy_global control_stream use_numpy=True tnp random seed x = tnp random uniform size= check stream identical numpy s _np random seed x_np = _np random uniform size= assert_equal x tnp asarray x_np switch pytorch stream variates differ control_stream use_numpy=False tnp random seed x_ = tnp random uniform size= assert x_ == x all __name__ == __main__ run_tests
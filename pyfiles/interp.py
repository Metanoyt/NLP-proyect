mypy allow-untyped-defs This simple interpreter Sympy expressions dispatches classes following torch _inductor virtualized calling convention For directness interpreter takes handler directly rather than consulting TLS It does use most methods full handler only those corresponding Sympy expressions To see example full handler see torch utils _sympy value_ranges ValueRangeAnalysis functools logging typing Any Union sympy sympy logic boolalg Boolean SympyBoolean BooleanAtom torch functions BitwiseFn_bitwise_and BitwiseFn_bitwise_or CeilToInt CleanDiv FloatPow FloatTrueDiv FloorDiv FloorToInt Identity IntTrueDiv IsNonOverlappingAndDenseIndicator Max Min Mod ModularIndexing OpaqueUnaryFn_log PowByNatural PythonMod RoundDecimal RoundToInt ToFloat TruncToFloat TruncToInt Where log = logging getLogger __name__ TODO Dedupe SYMPY_INTERP functools cache handlers TODO add CeilDiv doesn t appear index_expr TODO default some decompositions interpreter doesn t have them like decomposing ModularIndexing implementing Le b Ge b HANDLERS = sympy Or or_ sympy And and_ sympy Eq eq sympy Ne ne sympy Lt lt sympy Gt gt sympy Le le sympy Ge ge sympy Not not_ IntTrueDiv int_truediv FloatTrueDiv truediv FloorDiv floordiv CleanDiv floordiv TODO hmm TruncToFloat trunc Where where sympy Add add sympy Mul mul FloatPow pow PowByNatural pow_by_natural sympy simplifies x x into Pow x so we need handle Do NOT use builtin Pow floats TODO There hazard here we have float float will also get turned into Pow float we don t want because pow_by_natural assumed only integers Probably fix add FloatMul impede optimization sympy Pow pow_by_natural Mod mod PythonMod mod TODO wrong TODO Inductor can generate these s ill-specified which semantics intended here Needs cleaned up along FloorDiv bigger cleanup sympy Mod mod sympy Abs abs sympy log log sympy exp exp sympy Min minimum sympy Max maximum Min minimum Max maximum ModularIndexing modular_indexing sympy functions elementary piecewise ExprCondPair expr_cond_pair sympy Piecewise piecewise Identity identity IsNonOverlappingAndDenseIndicator is_non_overlapping_and_dense_indicator RoundDecimal round_decimal TODO do rest opaque unary functions OpaqueUnaryFn_log log BitwiseFn_bitwise_and bitwise_and BitwiseFn_bitwise_or bitwise_or TODO This kind pointless we shouldn t generating sympy sin these functions they should Opaque instead name cos sin tan sinh cosh tanh asin acos atan HANDLERS getattr sympy name = name HANDLERS ASSOCIATIVE_OPS = minimum maximum mul add and_ or_ _run_sympy_handler analysis args expr index_dtype=torch int Special cases isinstance expr sympy Pow isinstance expr args sympy core numbers Half analysis sqrt args isinstance expr ToFloat analysis to_dtype args torch float These handlers special because they take extra dtype argument specifying what they should convert we need appropriately set up when we convert Sympy A reasonable default when you translating conservatively do int then narrow these arguments later when you discover you can narrow index range But you already know -bit indexing OK you can directly do sympy translation index_dtype=torch int INDEX_DTYPE_HANDLERS = TruncToInt trunc_to_int sympy floor floor_to_int sympy ceiling ceil_to_int FloorToInt floor_to_int CeilToInt ceil_to_int RoundToInt round_to_int handler_name = INDEX_DTYPE_HANDLERS get expr func None getattr analysis handler_name args index_dtype Fastpath n-ary integral addition expr func sympy Add expr is_integer hasattr analysis sym_sum r = analysis sym_sum args log debug sym_sum s - s args r r hasattr expr func _torch_handler_name handler_name = expr func _torch_handler_name handler_name = handlers expr func handler = getattr analysis handler_name try handler_name ASSOCIATIVE_OPS len args = raise AssertionError associative op needs args acc = handler args args i range len args acc = handler acc args i log debug s s - s handler_name args acc acc r = handler args log debug s s - s handler_name args r r except NotImplementedError raise except Exception log warning failed while executing s s handler_name args raise _nil = object sympy_interp analysis env dict sympy Symbol Any expr Union sympy Expr SympyBoolean index_dtype=torch int missing_handler=None Handle base cases dtype = None isinstance expr BooleanAtom dtype = torch bool isinstance expr sympy Integer dtype = torch int isinstance expr sympy Number dtype = torch double dtype None analysis constant expr dtype isinstance expr sympy Symbol r = env get expr _nil _nil r missing_handler missing_handler expr raise KeyError expr Recursive case _run_sympy_handler analysis sympy_interp analysis env arg index_dtype=index_dtype missing_handler=missing_handler arg expr args expr index_dtype=index_dtype
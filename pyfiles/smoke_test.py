argparse importlib json os re subprocess sys pathlib Path tempfile NamedTemporaryFile typing Optional torch torch _dynamo torch nn nn torch nn functional F MATRIX_GPU_ARCH_VERSION os environ gpu_arch_ver = os getenv MATRIX_GPU_ARCH_VERSION gpu_arch_ver = os getenv GPU_ARCH_VERSION Use fallback available gpu_arch_type = os getenv MATRIX_GPU_ARCH_TYPE channel = os getenv MATRIX_CHANNEL package_type = os getenv MATRIX_PACKAGE_TYPE target_os = os getenv TARGET_OS sys platform BASE_DIR = Path __file__ parent parent parent is_cuda_system = gpu_arch_type == cuda NIGHTLY_ALLOWED_DELTA = MODULES = name torchvision repo https github com pytorch vision git smoke_test vision test smoke_test py extension extension repo_name vision name torchaudio repo https github com pytorch audio git smoke_test audio test smoke_test smoke_test py -- no-ffmpeg extension _extension repo_name audio Net nn Module __init__ super __init__ conv = nn Conv d conv = nn Conv d fc = nn Linear forward x x = conv x x = conv x x = F max_pool d x x = torch flatten x output = fc x output load_json_from_basedir filename str try open BASE_DIR filename fptr json load fptr except FileNotFoundError exc raise ImportError f File filename found error exc strerror exc except json JSONDecodeError exc raise ImportError f Invalid JSON filename exc read_release_matrix load_json_from_basedir release_matrix json test_numpy try numpy np x = np arange torch tensor x except ImportError print Numpy check skipped Numpy installed check_version package str - None release_version = os getenv RELEASE_VERSION release_version specified use validate packages release_version release_matrix = read_release_matrix stable_version = release_matrix torch stable_version = os getenv MATRIX_STABLE_VERSION only makes sense check nightly package where dates known channel == nightly check_nightly_binaries_date package stable_version None torch __version__ startswith stable_version raise RuntimeError f Torch version mismatch expected stable_version channel channel But its torch __version__ release_version package == all module MODULES imported_module = importlib import_module module name module_version = imported_module __version__ module_version startswith release_matrix module name raise RuntimeError f module name version mismatch expected \ release_matrix module name channel channel But its module_version print f module name version actual module_version expected \ release_matrix module name channel channel print f Skip version check channel channel stable version None check_nightly_binaries_date package str - None datetime datetime format_dt = Y m d date_t_str = re findall dev\\d+ torch __version__ date_t_delta = datetime now - datetime strptime date_t_str format_dt date_t_delta days = NIGHTLY_ALLOWED_DELTA raise RuntimeError f binaries date_t_str more than NIGHTLY_ALLOWED_DELTA days old package == all module MODULES imported_module = importlib import_module module name module_version = imported_module __version__ date_m_str = re findall dev\\d+ module_version date_m_delta = datetime now - datetime strptime date_m_str format_dt print f Nightly date check module name version module_version date_m_delta days NIGHTLY_ALLOWED_DELTA raise RuntimeError f Expected module name less then NIGHTLY_ALLOWED_DELTA days But its date_m_delta test_cuda_runtime_errors_captured - None cuda_exception_missed = True try print Testing test_cuda_runtime_errors_captured torch _assert_async torch tensor device= cuda torch _assert_async torch tensor + j device= cuda except RuntimeError e re search CUDA f e print f Caught CUDA exception success e cuda_exception_missed = False raise e cuda_exception_missed raise RuntimeError Expected CUDA RuntimeError have received test_cuda_gds_errors_captured - None major_version = int torch version cuda split minor_version = int torch version cuda split target_os == windows print f target_os supported GDS smoke test major_version major_version == minor_version print CUDA version supported GDS smoke test cuda_exception_missed = True try print Testing test_cuda_gds_errors_captured NamedTemporaryFile f torch cuda gds GdsFile f name os O_CREAT &#124; os O_RDWR except RuntimeError e expected_error = cuFileHandleRegister failed re search expected_error f e print f Caught CUDA exception success e cuda_exception_missed = False raise e cuda_exception_missed raise RuntimeError Expected cuFileHandleRegister failed RuntimeError have received find_pypi_package_version package str - Optional str importlib metadata dists = metadata distributions dist dists dist metadata Name startswith package dist version None cudnn_to_version_str cudnn_version int - str patch = int cudnn_version minor = int cudnn_version major = int cudnn_version f major minor patch compare_pypi_to_torch_versions package str pypi_version str torch_version str - None pypi_version None raise RuntimeError f Can t find package PyPI Torch torch_version pypi_version startswith torch_version print f Found matching package Torch torch_version PyPI pypi_version raise RuntimeError f Wrong package version Torch torch_version PyPI pypi_version smoke_test_cuda package str runtime_error_check str torch_compile_check str pypi_pkg_check str - None torch cuda is_available is_cuda_system raise RuntimeError f Expected CUDA gpu_arch_ver However CUDA loaded package == all is_cuda_system module MODULES imported_module = importlib import_module module name TBD vision move extension module private so will _extention version = N A module extension == extension version = imported_module extension _check_cuda_version version = imported_module _extension _check_cuda_version print f module name CUDA version torch compile available macos-arm Linux python - torch_compile_check == enabled sys version_info target_os linux linux-aarch macos-arm darwin smoke_test_compile cuda torch cuda is_available cpu torch cuda is_available torch version cuda = gpu_arch_ver raise RuntimeError f Wrong CUDA version Loaded torch version cuda Expected gpu_arch_ver print f torch cuda torch version cuda torch cuda init print CUDA initialized successfully print f Number CUDA devices torch cuda device_count i range torch cuda device_count print f Device i torch cuda get_device_name i print f cuDNN enabled torch backends cudnn enabled torch_cudnn_version = cudnn_to_version_str torch backends cudnn version print f Torch cuDNN version torch_cudnn_version sys platform linux linux torch_nccl_version = join str v v torch cuda nccl version print f Torch nccl version torch_nccl_version Pypi dependencies installed linux only nccl available only Linux pypi_pkg_check == enabled sys platform linux linux compare_pypi_to_torch_versions cudnn find_pypi_package_version nvidia-cudnn torch_cudnn_version compare_pypi_to_torch_versions nccl find_pypi_package_version nvidia-nccl torch_nccl_version runtime_error_check == enabled test_cuda_runtime_errors_captured smoke_test_conv d - None torch nn nn print Testing smoke_test_conv d With square kernels equal stride m = nn Conv d stride= non-square kernels unequal stride padding m = nn Conv d stride= padding= assert m None non-square kernels unequal stride padding dilation basic_conv = nn Conv d stride= padding= dilation= input = torch randn output = basic_conv input is_cuda_system print Testing smoke_test_conv d cuda conv = nn Conv d cuda x = torch randn device= cuda torch cuda amp autocast out = conv x assert out None supported_dtypes = torch float torch float torch float dtype supported_dtypes print f Testing smoke_test_conv d cuda dtype conv = basic_conv dtype cuda input = torch randn device= cuda type dtype output = conv input assert output None test_linalg device= cpu - None print f Testing smoke_test_linalg device A = torch randn device=device U S Vh = torch linalg svd A full_matrices=False assert U shape == A shape S shape == torch Size Vh shape == torch Size torch dist A U torch diag S Vh U S Vh = torch linalg svd A assert U shape == torch Size S shape == torch Size Vh shape == torch Size torch dist A U torch diag S Vh A = torch randn device=device U S Vh = torch linalg svd A full_matrices=False torch dist A U torch diag_embed S Vh device == cuda supported_dtypes = torch float torch float dtype supported_dtypes print f Testing smoke_test_linalg cuda dtype A = torch randn device=device dtype=dtype torch linalg svd A smoke_test_compile device str = cpu - None supported_dtypes = torch float torch float torch float foo x torch Tensor - torch Tensor torch sin x + torch cos x dtype supported_dtypes print f Testing smoke_test_compile device dtype x = torch rand device=device type dtype x_eager = foo x x_pt = torch compile foo x torch testing assert_close x_eager x_pt Check SIMD detected architecture device == cpu torch _inductor codecache pick_vec_isa isa = pick_vec_isa isa raise RuntimeError Can t detect vectorized ISA CPU print f Picked CPU ISA type isa __name__ bit width isa bit_width Reset torch dynamo since we changing mode torch _dynamo reset dtype = torch float torch set_float _matmul_precision high print f Testing smoke_test_compile mode max-autotune dtype x = torch rand device=device type torch float model = Net device=device x_pt = torch compile model mode= max-autotune x smoke_test_nvshmem - None torch cuda is_available target_os == windows print Windows platform CUDA available skipping NVSHMEM test Check NVSHMEM compiled current build try torch _C _distributed_c d _is_nvshmem_available except ImportError Not built NVSHMEM support torch compiled NVSHMEM prior torch torch_version TorchVersion TorchVersion torch __version__ After NVSHMEM expected compiled current build raise RuntimeError torch compiled NVSHMEM None print torch compiled NVSHMEM Check NVSHMEM available current system print f NVSHMEM available run time _is_nvshmem_available smoke_test_modules cwd = os getcwd module MODULES module repo os path exists f cwd module repo_name print f Path does exist cwd module repo_name try subprocess check_output f git clone -- depth module repo stderr=subprocess STDOUT shell=True except subprocess CalledProcessError exc raise RuntimeError f Cloning module repo FAIL exc returncode Output exc output exc try smoke_test_command = f python module smoke_test target_os == windows smoke_test_command = f python module smoke_test output = subprocess check_output smoke_test_command stderr=subprocess STDOUT shell=True universal_newlines=True except subprocess CalledProcessError exc raise RuntimeError f Module module name FAIL exc returncode Output exc output exc print f Output \n output \n parse_args parser = argparse ArgumentParser parser add_argument -- package help= Package include smoke testing type=str choices= all torchonly default= all parser add_argument -- runtime-error-check help= No Runtime Error check type=str choices= enabled disabled default= enabled parser add_argument -- torch-compile-check help= Check torch compile type=str choices= enabled disabled default= enabled parser add_argument -- pypi-pkg-check help= Check pypi package versions cudnn nccl type=str choices= enabled disabled default= enabled parser parse_args main - None options = parse_args print f torch torch __version__ print torch __config__ parallel_info All PyTorch binary builds should built OpenMP torch backends openmp is_available raise RuntimeError PyTorch must built OpenMP support check_version options package smoke_test_conv d test_linalg test_numpy is_cuda_system test_linalg cuda test_cuda_gds_errors_captured options package == all smoke_test_modules smoke_test_cuda options package options runtime_error_check options torch_compile_check options pypi_pkg_check smoke_test_nvshmem __name__ == __main__ main
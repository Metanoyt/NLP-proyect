Owner s module dynamo copy functools io json logging os re shutil subprocess tempfile unittest mock contextlib contextmanager torch torch _dynamo test_case torch _dynamo testing torch _logging structured torch distributed dist torch fx fx torch _inductor test_case TestCase torch _logging _internal TorchLogsFormatter torch nn parallel DistributedDataParallel DDP torch testing _internal common_utils find_free_port xfailIfS X torch testing _internal triton_utils requires_cuda_and_triton torch distributed is_available torch testing _internal distributed fake_pg FakeStore HAS_TLPARSE = shutil which tlparse None requires_tlparse = unittest skipUnless HAS_TLPARSE requires tlparse requires_distributed = functools partial unittest skipIf dist is_available requires distributed example_fn output = mul torch ones output = output add torch ones output example_training_fn output = mul torch ones requires_grad=True output = output add torch ones output sum backward output dynamo_error_fn output = mul torch ones output = output add torch ones output inductor_error_fn output = torch round output inductor_schedule_fn output = add torch ones device= cuda output ARGS = torch ones requires_grad=True replace_dynamic buffer key re sub r + key + r \s \d+\ \d+ r \ dynamic buffer StructuredTraceTestingFilter logging Filter __init__ match_name=None match_name = match_name filter record str record metadata False match_name None artifact record metadata match_name = record metadata artifact name False match_name record metadata False True ChromiumEventFilter logging Filter filter record chromium_event record metadata StructuredTracePayloadFormatter logging Formatter format record record payload strip StructuredTraceTestingFormatter logging Formatter format record metadata = copy deepcopy record metadata Stub out values stable across runs TODO Check these match schema has_payload metadata metadata has_payload = HASH dynamo_start metadata metadata dynamo_start stack = STACK inductor_output_code metadata metadata inductor_output_code filename = FILENAME file_path metadata inductor_output_code metadata inductor_output_code file_path = FILENAME stack metadata metadata stack = STACK compilation_metrics metadata metadata compilation_metrics = METRICS bwd_compilation_metrics metadata metadata bwd_compilation_metrics = METRICS compilation_metrics_runtime metadata metadata compilation_metrics_runtime = METRICS bwd_compilation_metrics_runtime metadata metadata bwd_compilation_metrics_runtime = METRICS describe_storage metadata metadata describe_storage describer_id = ID describe_tensor metadata metadata describe_tensor describer_id = ID view_func metadata describe_tensor metadata describe_tensor view_func = VIEW_FUNC describe_source metadata metadata describe_source describer_id = ID k = create_symbol metadata k = guard_added_fast metadata k = create_unbacked_symbol metadata metadata k user_stack = STACK metadata k stack = STACK dump_file metadata Don t include actually key number s sensitive other test runs metadata dump_file name = eval_with_key json dumps metadata + \n + \n join l rstrip l record payload splitlines json dumps metadata trace_log = logging getLogger torch __trace chrome_event_filter = ChromiumEventFilter show_chrome_events fn Don t hide chrome events test functools wraps fn wrapper args kwargs handler removeFilter chrome_event_filter fn args kwargs wrapper StructuredTraceTest TestCase setUp super setUp torch _dynamo reset torch _logging structured INTERN_TABLE clear buffer = io StringIO old_level = trace_log level trace_log setLevel logging DEBUG handler = logging StreamHandler buffer handler setFormatter StructuredTraceTestingFormatter handler addFilter StructuredTraceTestingFilter handler addFilter chrome_event_filter trace_log addHandler handler raw_file = tempfile NamedTemporaryFile mode= w delete=True set False keep temporary files raw_handler = logging StreamHandler raw_file raw_handler setFormatter TorchLogsFormatter trace=True trace_log addHandler raw_handler tearDown trace_log removeHandler handler trace_log removeHandler raw_handler raw_file close trace_log setLevel old_level assertParses out = tempfile mkdtemp try subprocess check_call tlparse -o out -- overwrite -- no-browser -- strict raw_file name finally shutil rmtree out ignore_errors=True test_compile_id_serialization_deserialization cid = torch _guards CompileId frame_id= frame_compile_id= assert cid == torch _guards CompileId from_string str cid cid = torch _guards CompileId compiled_autograd_id= frame_id= frame_compile_id= assert cid == torch _guards CompileId from_string str cid cid = torch _guards CompileId compiled_autograd_id= frame_id=None frame_compile_id=None assert cid == torch _guards CompileId from_string str cid bad_cid - - - - - - assertRaises ValueError torch _guards CompileId from_string bad_cid requires_cuda_and_triton test_schedule fn_opt = torch compile inductor_schedule_fn backend= inductor fn_opt torch ones device= cuda assertExpectedInline buffer getvalue \ dynamo_start stack STACK frame_id frame_compile_id attempt describe_storage id describer_id ID size frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cuda index= size dynamo_hint_overrides is_leaf true stride storage view_func VIEW_FUNC describer_id ID frame_id frame_compile_id attempt describe_source describer_id ID id source L frame_id frame_compile_id attempt dynamo_output_graph sizes l_a_ ones output frame_id frame_compile_id attempt has_payload HASH artifact name before_pre_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name after_pre_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name aotautograd_cache_miss encoding json frame_id frame_compile_id attempt has_payload HASH artifact name aot_forward_graph_fw_metadata encoding string frame_id frame_compile_id attempt has_payload HASH aot_inference_graph frame_id frame_compile_id attempt has_payload HASH artifact name torch _functorch config encoding string frame_id frame_compile_id attempt has_payload HASH artifact name before_joint_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name after_joint_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name fx_graph_runnable encoding string frame_id frame_compile_id attempt has_payload HASH artifact name before_post_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name inductor_post_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH inductor_output_code filename FILENAME file_path FILENAME frame_id frame_compile_id attempt has_payload HASH artifact name triton_kernel_info encoding json frame_id frame_compile_id attempt has_payload HASH artifact name fx_graph_cache_miss encoding json frame_id frame_compile_id attempt has_payload HASH dynamo_cpp_guards_str frame_id frame_compile_id attempt has_payload HASH compilation_metrics METRICS frame_id frame_compile_id attempt compilation_metrics_runtime METRICS frame_id frame_compile_id noqa B assertParses requires_cuda_and_triton test_cudagraphs fn_opt = torch compile mode= reduce-overhead inductor_schedule_fn fn_opt torch ones device= cuda assertExpectedInline buffer getvalue \ dynamo_start stack STACK frame_id frame_compile_id attempt describe_storage id describer_id ID size frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cuda index= size dynamo_hint_overrides is_leaf true stride storage view_func VIEW_FUNC describer_id ID frame_id frame_compile_id attempt describe_source describer_id ID id source L frame_id frame_compile_id attempt dynamo_output_graph sizes l_a_ ones output frame_id frame_compile_id attempt has_payload HASH artifact name before_pre_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name after_pre_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name aotautograd_cache_miss encoding json frame_id frame_compile_id attempt has_payload HASH artifact name aot_forward_graph_fw_metadata encoding string frame_id frame_compile_id attempt has_payload HASH aot_inference_graph frame_id frame_compile_id attempt has_payload HASH artifact name torch _functorch config encoding string frame_id frame_compile_id attempt has_payload HASH artifact name before_joint_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name after_joint_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name fx_graph_runnable encoding string frame_id frame_compile_id attempt has_payload HASH artifact name before_post_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name inductor_post_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH inductor_output_code filename FILENAME file_path FILENAME frame_id frame_compile_id attempt has_payload HASH artifact name triton_kernel_info encoding json frame_id frame_compile_id attempt has_payload HASH artifact name fx_graph_cache_miss encoding json frame_id frame_compile_id attempt has_payload HASH dynamo_cpp_guards_str frame_id frame_compile_id attempt has_payload HASH compilation_metrics METRICS frame_id frame_compile_id attempt compilation_metrics_runtime METRICS frame_id frame_compile_id noqa B assertParses requires_tlparse test_recompiles fn x y torch add x y fn_opt = torch compile fn backend= inductor fn_opt torch ones torch ones fn_opt torch ones assertExpectedInline buffer getvalue \ dynamo_start stack STACK frame_id frame_compile_id attempt describe_storage id describer_id ID size frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cpu size dynamo_hint_overrides is_leaf true stride storage view_func VIEW_FUNC describer_id ID frame_id frame_compile_id attempt describe_source describer_id ID id source L x frame_id frame_compile_id attempt describe_storage id describer_id ID size frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cpu size dynamo_hint_overrides is_leaf true stride storage view_func VIEW_FUNC describer_id ID frame_id frame_compile_id attempt describe_source describer_id ID id source L y frame_id frame_compile_id attempt dynamo_output_graph sizes l_x_ l_y_ add frame_id frame_compile_id attempt has_payload HASH artifact name before_pre_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name after_pre_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name aotautograd_cache_miss encoding json frame_id frame_compile_id attempt has_payload HASH artifact name aot_forward_graph_fw_metadata encoding string frame_id frame_compile_id attempt has_payload HASH aot_inference_graph frame_id frame_compile_id attempt has_payload HASH artifact name torch _functorch config encoding string frame_id frame_compile_id attempt has_payload HASH artifact name before_joint_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name after_joint_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name fx_graph_runnable encoding string frame_id frame_compile_id attempt has_payload HASH artifact name before_post_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name inductor_post_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH inductor_output_code filename FILENAME file_path FILENAME frame_id frame_compile_id attempt has_payload HASH artifact name fx_graph_cache_miss encoding json frame_id frame_compile_id attempt has_payload HASH dynamo_cpp_guards_str frame_id frame_compile_id attempt has_payload HASH compilation_metrics METRICS frame_id frame_compile_id attempt artifact name recompile_reasons encoding json frame_id frame_compile_id attempt has_payload HASH dynamo_start stack STACK frame_id frame_compile_id attempt describe_storage id describer_id ID size frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cpu size dynamo_hint_overrides is_leaf true stride storage view_func VIEW_FUNC describer_id ID frame_id frame_compile_id attempt describe_source describer_id ID id source L x frame_id frame_compile_id attempt create_symbol symbol s val vr -int_oo int_oo source L y user_stack STACK stack STACK frame_id frame_compile_id attempt dynamo_output_graph sizes l_x_ add frame_id frame_compile_id attempt has_payload HASH artifact name before_pre_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name after_pre_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name aotautograd_cache_miss encoding json frame_id frame_compile_id attempt has_payload HASH artifact name aot_forward_graph_fw_metadata encoding string frame_id frame_compile_id attempt has_payload HASH aot_inference_graph frame_id frame_compile_id attempt has_payload HASH artifact name torch _functorch config encoding string frame_id frame_compile_id attempt has_payload HASH artifact name before_joint_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name after_joint_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name fx_graph_runnable encoding string frame_id frame_compile_id attempt has_payload HASH artifact name before_post_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name inductor_post_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH inductor_output_code filename FILENAME file_path FILENAME frame_id frame_compile_id attempt has_payload HASH artifact name fx_graph_cache_miss encoding json frame_id frame_compile_id attempt has_payload HASH dynamo_cpp_guards_str frame_id frame_compile_id attempt has_payload HASH compilation_metrics METRICS frame_id frame_compile_id attempt noqa B assertParses requires_tlparse test_example_fn fn_opt = torch compile example_fn backend= inductor fn_opt torch ones assertExpectedInline buffer getvalue \ dynamo_start stack STACK frame_id frame_compile_id attempt describe_storage id describer_id ID size frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cpu size dynamo_hint_overrides is_leaf true stride storage view_func VIEW_FUNC describer_id ID frame_id frame_compile_id attempt describe_source describer_id ID id source L frame_id frame_compile_id attempt dynamo_output_graph sizes l_a_ ones output ones_ output_ frame_id frame_compile_id attempt has_payload HASH artifact name before_pre_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name after_pre_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name aotautograd_cache_miss encoding json frame_id frame_compile_id attempt has_payload HASH artifact name aot_forward_graph_fw_metadata encoding string frame_id frame_compile_id attempt has_payload HASH aot_inference_graph frame_id frame_compile_id attempt has_payload HASH artifact name torch _functorch config encoding string frame_id frame_compile_id attempt has_payload HASH artifact name before_joint_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name after_joint_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name fx_graph_runnable encoding string frame_id frame_compile_id attempt has_payload HASH artifact name before_post_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name inductor_post_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH inductor_output_code filename FILENAME file_path FILENAME frame_id frame_compile_id attempt has_payload HASH artifact name fx_graph_cache_miss encoding json frame_id frame_compile_id attempt has_payload HASH dynamo_cpp_guards_str frame_id frame_compile_id attempt has_payload HASH compilation_metrics METRICS frame_id frame_compile_id attempt noqa B assertParses requires_tlparse test_example_training_fn fn_opt = torch compile example_training_fn backend= inductor fn_opt torch ones requires_grad=True buffer = buffer getvalue buffer = replace_dynamic buffer inductor_compile_time_s buffer = replace_dynamic buffer code_gen_time_s buffer = replace_dynamic buffer structured_logging_overhead_s assertExpectedInline buffer \ dynamo_start stack STACK frame_id frame_compile_id attempt describe_storage id describer_id ID size frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cpu size dynamo_hint_overrides is_leaf true requires_grad true stride storage view_func VIEW_FUNC describer_id ID frame_id frame_compile_id attempt describe_source describer_id ID id source L frame_id frame_compile_id attempt artifact name dynamo_graph_break_reason encoding string frame_id frame_compile_id attempt has_payload HASH describe_storage id describer_id ID size frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cpu size dynamo_hint_overrides is_leaf true requires_grad true stride storage view_func VIEW_FUNC describer_id ID frame_id frame_compile_id attempt describe_source describer_id ID id source L frame_id frame_compile_id attempt dynamo_cpp_guards_str frame_id frame_compile_id attempt has_payload HASH compilation_metrics METRICS frame_id frame_compile_id attempt dynamo_start stack STACK frame_id frame_compile_id attempt artifact name dynamo_graph_break_reason encoding string frame_id frame_compile_id attempt has_payload HASH describe_storage id describer_id ID size frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cpu size dynamo_hint_overrides is_leaf true requires_grad true stride storage view_func VIEW_FUNC describer_id ID frame_id frame_compile_id attempt describe_source describer_id ID id source L ___stack frame_id frame_compile_id attempt dynamo_cpp_guards_str frame_id frame_compile_id attempt has_payload HASH compilation_metrics METRICS frame_id frame_compile_id attempt dynamo_start stack STACK frame_id frame_compile_id attempt describe_storage id describer_id ID size frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cpu size dynamo_hint_overrides requires_grad true stride storage view_func VIEW_FUNC describer_id ID frame_id frame_compile_id attempt describe_source describer_id ID id source L ___stack frame_id frame_compile_id attempt artifact name dynamo_graph_break_reason encoding string frame_id frame_compile_id attempt has_payload HASH describe_storage id describer_id ID size frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cpu size dynamo_hint_overrides requires_grad true stride storage view_func VIEW_FUNC describer_id ID frame_id frame_compile_id attempt describe_source describer_id ID id source L ___stack frame_id frame_compile_id attempt dynamo_output_graph sizes l_stack _ ones output sum_ frame_id frame_compile_id attempt has_payload HASH artifact name before_pre_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name after_pre_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name aotautograd_cache_miss encoding json frame_id frame_compile_id attempt has_payload HASH aot_joint_graph frame_id frame_compile_id attempt has_payload HASH artifact name torch _functorch config encoding string frame_id frame_compile_id attempt has_payload HASH artifact name aot_forward_graph_fw_metadata encoding string frame_id frame_compile_id attempt has_payload HASH aot_forward_graph frame_id frame_compile_id attempt has_payload HASH aot_backward_graph frame_id frame_compile_id attempt has_payload HASH artifact name fx_graph_runnable encoding string frame_id frame_compile_id attempt has_payload HASH artifact name before_post_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name inductor_post_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH inductor_output_code filename FILENAME file_path FILENAME frame_id frame_compile_id attempt has_payload HASH artifact name fx_graph_cache_miss encoding json frame_id frame_compile_id attempt has_payload HASH dynamo_cpp_guards_str frame_id frame_compile_id attempt has_payload HASH compilation_metrics METRICS frame_id frame_compile_id attempt dynamo_start stack STACK frame_id frame_compile_id attempt compilation_metrics METRICS frame_id frame_compile_id attempt artifact name fx_graph_runnable encoding string frame_id frame_compile_id attempt has_payload HASH artifact name before_post_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name inductor_post_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH inductor_output_code filename FILENAME file_path FILENAME frame_id frame_compile_id attempt has_payload HASH artifact name fx_graph_cache_miss encoding json frame_id frame_compile_id attempt has_payload HASH bwd_compilation_metrics METRICS frame_id frame_compile_id attempt dynamo_start stack STACK frame_id frame_compile_id attempt describe_storage id describer_id ID size frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cpu size dynamo_hint_overrides requires_grad true stride storage view_func VIEW_FUNC describer_id ID frame_id frame_compile_id attempt describe_source describer_id ID id source L output frame_id frame_compile_id attempt compilation_metrics METRICS frame_id frame_compile_id attempt noqa B assertParses requires_tlparse test_dynamo_error try fn_opt = torch compile dynamo_error_fn backend= inductor fn_opt ARGS except Exception pass assertExpectedInline buffer getvalue \ dynamo_start stack STACK frame_id frame_compile_id attempt describe_storage id describer_id ID size frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cpu size dynamo_hint_overrides is_leaf true requires_grad true stride storage view_func VIEW_FUNC describer_id ID frame_id frame_compile_id attempt describe_source describer_id ID id source L frame_id frame_compile_id attempt artifact name dynamo_error encoding string frame_id frame_compile_id attempt has_payload HASH compilation_metrics METRICS frame_id frame_compile_id attempt noqa B assertParses requires_tlparse test_inductor_error torch _inductor lowering throw x raise AssertionError inject error lowerings dict_entries = x list torch _inductor lowering lowerings keys round x __name__ dict_entries x = throw unittest mock patch dict torch _inductor lowering lowerings dict_entries try fn_opt = torch compile inductor_error_fn backend= inductor fn_opt ARGS except Exception pass assertExpectedInline buffer getvalue \ dynamo_start stack STACK frame_id frame_compile_id attempt describe_storage id describer_id ID size frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cpu size dynamo_hint_overrides is_leaf true requires_grad true stride storage view_func VIEW_FUNC describer_id ID frame_id frame_compile_id attempt describe_source describer_id ID id source L frame_id frame_compile_id attempt dynamo_output_graph sizes l_a_ output frame_id frame_compile_id attempt has_payload HASH artifact name before_pre_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name after_pre_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name aotautograd_cache_miss encoding json frame_id frame_compile_id attempt has_payload HASH aot_joint_graph frame_id frame_compile_id attempt has_payload HASH artifact name torch _functorch config encoding string frame_id frame_compile_id attempt has_payload HASH artifact name aot_forward_graph_fw_metadata encoding string frame_id frame_compile_id attempt has_payload HASH aot_forward_graph frame_id frame_compile_id attempt has_payload HASH aot_backward_graph frame_id frame_compile_id attempt has_payload HASH artifact name fx_graph_runnable encoding string frame_id frame_compile_id attempt has_payload HASH artifact name before_post_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name inductor_post_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name dynamo_error encoding string frame_id frame_compile_id attempt has_payload HASH compilation_metrics METRICS frame_id frame_compile_id attempt noqa B assertParses requires_distributed requires_cuda_and_triton test_ddp_graphs ToyModel torch nn Module __init__ - None super __init__ layers = torch nn Sequential torch nn Linear torch nn Linear forward x layers x TODO isn t safely bracketed will leak os environ MASTER_ADDR = localhost os environ MASTER_PORT = str find_free_port dist init_process_group gloo rank= world_size= model = DDP ToyModel cuda device_ids= bucket_cap_mb= ddp_model = torch compile model backend= inductor ddp_model torch randn device= cuda dist destroy_process_group torch _dynamo config inline_inbuilt_nn_modules assertExpectedInline buffer getvalue \ dynamo_start stack STACK rank frame_id frame_compile_id attempt artifact name dynamo_graph_break_reason encoding string rank frame_id frame_compile_id attempt has_payload HASH dynamo_cpp_guards_str rank frame_id frame_compile_id attempt has_payload HASH compilation_metrics METRICS rank frame_id frame_compile_id attempt dynamo_start stack STACK rank frame_id frame_compile_id attempt artifact name dynamo_graph_break_reason encoding string rank frame_id frame_compile_id attempt has_payload HASH dynamo_cpp_guards_str rank frame_id frame_compile_id attempt has_payload HASH compilation_metrics METRICS rank frame_id frame_compile_id attempt dynamo_start stack STACK rank frame_id frame_compile_id attempt artifact name dynamo_graph_break_reason encoding string rank frame_id frame_compile_id attempt has_payload HASH dynamo_cpp_guards_str rank frame_id frame_compile_id attempt has_payload HASH compilation_metrics METRICS rank frame_id frame_compile_id attempt dynamo_start stack STACK rank frame_id frame_compile_id attempt describe_storage id describer_id ID size rank frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cuda index= size is_leaf true stride storage view_func VIEW_FUNC describer_id ID rank frame_id frame_compile_id attempt describe_source describer_id ID id source L x rank frame_id frame_compile_id attempt dynamo_output_graph sizes l_x_ l__self___layers_ l__self___layers_ rank frame_id frame_compile_id attempt has_payload HASH optimize_ddp_split_graph rank frame_id frame_compile_id attempt has_payload HASH optimize_ddp_split_child name submod_ rank frame_id frame_compile_id attempt has_payload HASH optimize_ddp_split_child name submod_ rank frame_id frame_compile_id attempt has_payload HASH describe_storage id describer_id ID size rank frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cuda index= size is_leaf true stride storage view_func VIEW_FUNC describer_id ID rank frame_id frame_compile_id attempt describe_source describer_id ID id source L x rank frame_id frame_compile_id attempt artifact name before_pre_grad_graph encoding string rank frame_id frame_compile_id attempt has_payload HASH artifact name after_pre_grad_graph encoding string rank frame_id frame_compile_id attempt has_payload HASH aot_joint_graph rank frame_id frame_compile_id attempt has_payload HASH artifact name torch _functorch config encoding string rank frame_id frame_compile_id attempt has_payload HASH artifact name aot_forward_graph_fw_metadata encoding string rank frame_id frame_compile_id attempt has_payload HASH aot_forward_graph rank frame_id frame_compile_id attempt has_payload HASH aot_backward_graph rank frame_id frame_compile_id attempt has_payload HASH artifact name fx_graph_runnable encoding string rank frame_id frame_compile_id attempt has_payload HASH artifact name before_post_grad_graph encoding string rank frame_id frame_compile_id attempt has_payload HASH artifact name inductor_post_grad_graph encoding string rank frame_id frame_compile_id attempt has_payload HASH inductor_output_code filename FILENAME file_path FILENAME rank frame_id frame_compile_id attempt has_payload HASH artifact name fx_graph_cache_miss encoding json rank frame_id frame_compile_id attempt has_payload HASH artifact name aotautograd_cache_bypass encoding json rank frame_id frame_compile_id attempt has_payload HASH artifact name before_pre_grad_graph encoding string rank frame_id frame_compile_id attempt has_payload HASH artifact name after_pre_grad_graph encoding string rank frame_id frame_compile_id attempt has_payload HASH aot_joint_graph rank frame_id frame_compile_id attempt has_payload HASH artifact name torch _functorch config encoding string rank frame_id frame_compile_id attempt has_payload HASH artifact name aot_forward_graph_fw_metadata encoding string rank frame_id frame_compile_id attempt has_payload HASH aot_forward_graph rank frame_id frame_compile_id attempt has_payload HASH aot_backward_graph rank frame_id frame_compile_id attempt has_payload HASH artifact name fx_graph_runnable encoding string rank frame_id frame_compile_id attempt has_payload HASH artifact name before_post_grad_graph encoding string rank frame_id frame_compile_id attempt has_payload HASH artifact name inductor_post_grad_graph encoding string rank frame_id frame_compile_id attempt has_payload HASH inductor_output_code filename FILENAME file_path FILENAME rank frame_id frame_compile_id attempt has_payload HASH artifact name fx_graph_cache_miss encoding json rank frame_id frame_compile_id attempt has_payload HASH artifact name aotautograd_cache_bypass encoding json rank frame_id frame_compile_id attempt has_payload HASH dynamo_cpp_guards_str rank frame_id frame_compile_id attempt has_payload HASH compilation_metrics METRICS rank frame_id frame_compile_id attempt noqa B assertExpectedInline buffer getvalue \ dynamo_start stack STACK rank frame_id frame_compile_id attempt artifact name dynamo_graph_break_reason encoding string rank frame_id frame_compile_id attempt has_payload HASH describe_storage id describer_id ID size rank frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cuda index= size dynamo_hint_overrides is_leaf true stride storage view_func VIEW_FUNC describer_id ID rank frame_id frame_compile_id attempt describe_source describer_id ID id source L args rank frame_id frame_compile_id attempt dynamo_cpp_guards_str rank frame_id frame_compile_id attempt has_payload HASH compilation_metrics METRICS rank frame_id frame_compile_id attempt dynamo_start stack STACK rank frame_id frame_compile_id attempt artifact name dynamo_graph_break_reason encoding string rank frame_id frame_compile_id attempt has_payload HASH dynamo_cpp_guards_str rank frame_id frame_compile_id attempt has_payload HASH compilation_metrics METRICS rank frame_id frame_compile_id attempt dynamo_start stack STACK rank frame_id frame_compile_id attempt artifact name dynamo_graph_break_reason encoding string rank frame_id frame_compile_id attempt has_payload HASH dynamo_cpp_guards_str rank frame_id frame_compile_id attempt has_payload HASH compilation_metrics METRICS rank frame_id frame_compile_id attempt dynamo_start stack STACK rank frame_id frame_compile_id attempt compilation_metrics METRICS rank frame_id frame_compile_id attempt dynamo_start stack STACK rank frame_id frame_compile_id attempt describe_storage id describer_id ID size rank frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cuda index= size dynamo_hint_overrides is_leaf true requires_grad true is_parameter true stride storage view_func VIEW_FUNC describer_id ID rank frame_id frame_compile_id attempt describe_source describer_id ID id source L _modules layers _modules _parameters weight rank frame_id frame_compile_id attempt describe_storage id describer_id ID size rank frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cuda index= size dynamo_hint_overrides is_leaf true requires_grad true is_parameter true stride storage view_func VIEW_FUNC describer_id ID rank frame_id frame_compile_id attempt describe_source describer_id ID id source L _modules layers _modules _parameters bias rank frame_id frame_compile_id attempt describe_storage id describer_id ID size rank frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cuda index= size dynamo_hint_overrides is_leaf true stride storage view_func VIEW_FUNC describer_id ID rank frame_id frame_compile_id attempt describe_source describer_id ID id source L x rank frame_id frame_compile_id attempt describe_storage id describer_id ID size rank frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cuda index= size dynamo_hint_overrides is_leaf true requires_grad true is_parameter true stride storage view_func VIEW_FUNC describer_id ID rank frame_id frame_compile_id attempt describe_source describer_id ID id source L _modules layers _modules _parameters weight rank frame_id frame_compile_id attempt describe_storage id describer_id ID size rank frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cuda index= size dynamo_hint_overrides is_leaf true requires_grad true is_parameter true stride storage view_func VIEW_FUNC describer_id ID rank frame_id frame_compile_id attempt describe_source describer_id ID id source L _modules layers _modules _parameters bias rank frame_id frame_compile_id attempt dynamo_output_graph sizes l_self_modules_layers_modules_ _parameters_weight_ l_self_modules_layers_modules_ _parameters_bias_ l_x_ l_self_modules_layers_modules_ _parameters_weight_ l_self_modules_layers_modules_ _parameters_bias_ input_ input_ rank frame_id frame_compile_id attempt has_payload HASH optimize_ddp_split_graph rank frame_id frame_compile_id attempt has_payload HASH optimize_ddp_split_child name submod_ rank frame_id frame_compile_id attempt has_payload HASH optimize_ddp_split_child name submod_ rank frame_id frame_compile_id attempt has_payload HASH describe_storage id describer_id ID size rank frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cuda index= size dynamo_hint_overrides is_leaf true stride storage view_func VIEW_FUNC describer_id ID rank frame_id frame_compile_id attempt describe_source describer_id ID id source L x rank frame_id frame_compile_id attempt describe_storage id describer_id ID size rank frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cuda index= size dynamo_hint_overrides is_leaf true requires_grad true is_parameter true stride storage view_func VIEW_FUNC describer_id ID rank frame_id frame_compile_id attempt describe_source describer_id ID id source L _modules layers _modules _parameters weight rank frame_id frame_compile_id attempt describe_storage id describer_id ID size rank frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cuda index= size dynamo_hint_overrides is_leaf true requires_grad true is_parameter true stride storage view_func VIEW_FUNC describer_id ID rank frame_id frame_compile_id attempt describe_source describer_id ID id source L _modules layers _modules _parameters bias rank frame_id frame_compile_id attempt artifact name before_pre_grad_graph encoding string rank frame_id frame_compile_id attempt has_payload HASH artifact name after_pre_grad_graph encoding string rank frame_id frame_compile_id attempt has_payload HASH artifact name aotautograd_cache_bypass encoding json rank frame_id frame_compile_id attempt has_payload HASH aot_joint_graph rank frame_id frame_compile_id attempt has_payload HASH artifact name torch _functorch config encoding string rank frame_id frame_compile_id attempt has_payload HASH artifact name aot_forward_graph_fw_metadata encoding string rank frame_id frame_compile_id attempt has_payload HASH aot_forward_graph rank frame_id frame_compile_id attempt has_payload HASH aot_backward_graph rank frame_id frame_compile_id attempt has_payload HASH artifact name fx_graph_runnable encoding string rank frame_id frame_compile_id attempt has_payload HASH artifact name before_post_grad_graph encoding string rank frame_id frame_compile_id attempt has_payload HASH artifact name inductor_post_grad_graph encoding string rank frame_id frame_compile_id attempt has_payload HASH inductor_output_code filename FILENAME file_path FILENAME rank frame_id frame_compile_id attempt has_payload HASH artifact name fx_graph_cache_miss encoding json rank frame_id frame_compile_id attempt has_payload HASH describe_storage id describer_id ID size rank frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cuda index= size dynamo_hint_overrides is_leaf true requires_grad true is_parameter true stride storage view_func VIEW_FUNC describer_id ID rank frame_id frame_compile_id attempt describe_source describer_id ID id source L _modules layers _modules _parameters weight rank frame_id frame_compile_id attempt describe_storage id describer_id ID size rank frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cuda index= size dynamo_hint_overrides is_leaf true requires_grad true is_parameter true stride storage view_func VIEW_FUNC describer_id ID rank frame_id frame_compile_id attempt describe_source describer_id ID id source L _modules layers _modules _parameters bias rank frame_id frame_compile_id attempt artifact name before_pre_grad_graph encoding string rank frame_id frame_compile_id attempt has_payload HASH artifact name after_pre_grad_graph encoding string rank frame_id frame_compile_id attempt has_payload HASH artifact name aotautograd_cache_bypass encoding json rank frame_id frame_compile_id attempt has_payload HASH aot_joint_graph rank frame_id frame_compile_id attempt has_payload HASH artifact name torch _functorch config encoding string rank frame_id frame_compile_id attempt has_payload HASH artifact name aot_forward_graph_fw_metadata encoding string rank frame_id frame_compile_id attempt has_payload HASH aot_forward_graph rank frame_id frame_compile_id attempt has_payload HASH aot_backward_graph rank frame_id frame_compile_id attempt has_payload HASH artifact name fx_graph_runnable encoding string rank frame_id frame_compile_id attempt has_payload HASH artifact name before_post_grad_graph encoding string rank frame_id frame_compile_id attempt has_payload HASH artifact name inductor_post_grad_graph encoding string rank frame_id frame_compile_id attempt has_payload HASH inductor_output_code filename FILENAME file_path FILENAME rank frame_id frame_compile_id attempt has_payload HASH artifact name fx_graph_cache_miss encoding json rank frame_id frame_compile_id attempt has_payload HASH dynamo_cpp_guards_str rank frame_id frame_compile_id attempt has_payload HASH compilation_metrics METRICS rank frame_id frame_compile_id attempt noqa B assertParses requires_tlparse test_graph_breaks torch compile backend= inductor fn x torch _dynamo graph_break x + fn torch ones assertExpectedInline buffer getvalue \ dynamo_start stack STACK frame_id frame_compile_id attempt artifact name dynamo_graph_break_reason encoding string frame_id frame_compile_id attempt has_payload HASH dynamo_cpp_guards_str frame_id frame_compile_id attempt has_payload HASH compilation_metrics METRICS frame_id frame_compile_id attempt dynamo_start stack STACK frame_id frame_compile_id attempt describe_storage id describer_id ID size frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cpu size dynamo_hint_overrides is_leaf true stride storage view_func VIEW_FUNC describer_id ID frame_id frame_compile_id attempt describe_source describer_id ID id source L x frame_id frame_compile_id attempt dynamo_output_graph sizes l_x_ add frame_id frame_compile_id attempt has_payload HASH artifact name before_pre_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name after_pre_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name aotautograd_cache_miss encoding json frame_id frame_compile_id attempt has_payload HASH artifact name aot_forward_graph_fw_metadata encoding string frame_id frame_compile_id attempt has_payload HASH aot_inference_graph frame_id frame_compile_id attempt has_payload HASH artifact name torch _functorch config encoding string frame_id frame_compile_id attempt has_payload HASH artifact name before_joint_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name after_joint_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name fx_graph_runnable encoding string frame_id frame_compile_id attempt has_payload HASH artifact name before_post_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name inductor_post_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH inductor_output_code filename FILENAME file_path FILENAME frame_id frame_compile_id attempt has_payload HASH artifact name fx_graph_cache_miss encoding json frame_id frame_compile_id attempt has_payload HASH dynamo_cpp_guards_str frame_id frame_compile_id attempt has_payload HASH compilation_metrics METRICS frame_id frame_compile_id attempt noqa B assertParses TODO bring trace_source tests once we start emitting bytecode requires_tlparse test_graph_sizes_dynamic fn b b fn_opt = torch compile fn backend= eager dynamic=False fn_opt torch randn torch randn fn_opt = torch compile fn backend= eager dynamic=True fn_opt torch randn torch randn assertExpectedInline buffer getvalue \ dynamo_start stack STACK frame_id frame_compile_id attempt describe_storage id describer_id ID size frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cpu size dynamo_hint_overrides is_leaf true stride storage view_func VIEW_FUNC describer_id ID frame_id frame_compile_id attempt describe_source describer_id ID id source L frame_id frame_compile_id attempt describe_storage id describer_id ID size frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cpu size dynamo_hint_overrides is_leaf true stride storage view_func VIEW_FUNC describer_id ID frame_id frame_compile_id attempt describe_source describer_id ID id source L b frame_id frame_compile_id attempt dynamo_output_graph sizes l_a_ l_b_ matmul frame_id frame_compile_id attempt has_payload HASH dynamo_cpp_guards_str frame_id frame_compile_id attempt has_payload HASH compilation_metrics METRICS frame_id frame_compile_id attempt artifact name recompile_reasons encoding json frame_id frame_compile_id attempt has_payload HASH dynamo_start stack STACK frame_id frame_compile_id attempt describe_storage id describer_id ID size frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cpu size dynamo_hint_overrides is_leaf true stride storage view_func VIEW_FUNC describer_id ID frame_id frame_compile_id attempt describe_source describer_id ID id source L frame_id frame_compile_id attempt create_symbol symbol s val vr int_oo source L size user_stack STACK stack STACK frame_id frame_compile_id attempt create_symbol symbol s val vr int_oo source L size user_stack STACK stack STACK frame_id frame_compile_id attempt describe_storage id describer_id ID size frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cpu size dynamo_hint_overrides is_leaf true stride storage view_func VIEW_FUNC describer_id ID frame_id frame_compile_id attempt describe_source describer_id ID id source L b frame_id frame_compile_id attempt create_symbol symbol s val vr int_oo source L b size user_stack STACK stack STACK frame_id frame_compile_id attempt create_symbol symbol s val vr int_oo source L b size user_stack STACK stack STACK frame_id frame_compile_id attempt guard_added_fast expr Eq s s user_stack STACK stack STACK frame_id frame_compile_id attempt dynamo_output_graph sizes l_a_ s s l_b_ s s matmul s s frame_id frame_compile_id attempt has_payload HASH dynamo_cpp_guards_str frame_id frame_compile_id attempt has_payload HASH compilation_metrics METRICS frame_id frame_compile_id attempt noqa B assertParses requires_tlparse test_guards_recompiles fn x ys zs inner x ys zs inner x ys zs y z zip ys zs x += y z x ys = zs = x = torch tensor fn_opt = torch compile fn backend= eager fn_opt x ys zs fn_opt x ys zs assertExpectedInline buffer getvalue \ dynamo_start stack STACK frame_id frame_compile_id attempt describe_storage id describer_id ID size frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cpu size dynamo_hint_overrides is_leaf true stride storage view_func VIEW_FUNC describer_id ID frame_id frame_compile_id attempt describe_source describer_id ID id source L x frame_id frame_compile_id attempt dynamo_output_graph sizes l_x_ x frame_id frame_compile_id attempt has_payload HASH dynamo_cpp_guards_str frame_id frame_compile_id attempt has_payload HASH compilation_metrics METRICS frame_id frame_compile_id attempt artifact name recompile_reasons encoding json frame_id frame_compile_id attempt has_payload HASH dynamo_start stack STACK frame_id frame_compile_id attempt describe_storage id describer_id ID size frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cpu size dynamo_hint_overrides is_leaf true stride storage view_func VIEW_FUNC describer_id ID frame_id frame_compile_id attempt describe_source describer_id ID id source L x frame_id frame_compile_id attempt dynamo_output_graph sizes l_x_ x frame_id frame_compile_id attempt has_payload HASH dynamo_cpp_guards_str frame_id frame_compile_id attempt has_payload HASH compilation_metrics METRICS frame_id frame_compile_id attempt noqa B assertParses test_dump_file f x y x add y gm = fx symbolic_trace f torch compile gm backend= eager torch randn torch randn assertExpectedInline buffer getvalue \ dynamo_start stack STACK frame_id frame_compile_id attempt dump_file name eval_with_key frame_id frame_compile_id attempt has_payload HASH forward x y add = x add y x = y = None add describe_storage id describer_id ID size frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cpu size dynamo_hint_overrides is_leaf true stride storage view_func VIEW_FUNC describer_id ID frame_id frame_compile_id attempt describe_source describer_id ID id source L x frame_id frame_compile_id attempt describe_storage id describer_id ID size frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cpu size dynamo_hint_overrides is_leaf true stride storage view_func VIEW_FUNC describer_id ID frame_id frame_compile_id attempt describe_source describer_id ID id source L y frame_id frame_compile_id attempt dynamo_output_graph sizes l_x_ l_y_ add frame_id frame_compile_id attempt has_payload HASH dynamo_cpp_guards_str frame_id frame_compile_id attempt has_payload HASH compilation_metrics METRICS frame_id frame_compile_id attempt noqa B requires_tlparse torch _inductor config patch fx_graph_cache True test_codecache fn sin x = torch tensor fn_opt = torch compile fn backend= inductor fn_opt x torch _dynamo reset Trigger cache hit fn_opt x Should print twice including inductor_output_code assertExpectedInline buffer getvalue \ dynamo_start stack STACK frame_id frame_compile_id attempt describe_storage id describer_id ID size frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cpu size dynamo_hint_overrides is_leaf true stride storage view_func VIEW_FUNC describer_id ID frame_id frame_compile_id attempt describe_source describer_id ID id source L frame_id frame_compile_id attempt dynamo_output_graph sizes l_a_ sin frame_id frame_compile_id attempt has_payload HASH artifact name before_pre_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name after_pre_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name aotautograd_cache_miss encoding json frame_id frame_compile_id attempt has_payload HASH artifact name aot_forward_graph_fw_metadata encoding string frame_id frame_compile_id attempt has_payload HASH aot_inference_graph frame_id frame_compile_id attempt has_payload HASH artifact name torch _functorch config encoding string frame_id frame_compile_id attempt has_payload HASH artifact name before_joint_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name after_joint_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name fx_graph_runnable encoding string frame_id frame_compile_id attempt has_payload HASH artifact name before_post_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name inductor_post_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH inductor_output_code filename FILENAME file_path FILENAME frame_id frame_compile_id attempt has_payload HASH artifact name fx_graph_cache_miss encoding json frame_id frame_compile_id attempt has_payload HASH dynamo_cpp_guards_str frame_id frame_compile_id attempt has_payload HASH compilation_metrics METRICS frame_id frame_compile_id attempt dynamo_start stack STACK frame_id frame_compile_id attempt describe_storage id describer_id ID size frame_id frame_compile_id attempt describe_tensor id ndim dtype torch float device device type= cpu size dynamo_hint_overrides is_leaf true stride storage view_func VIEW_FUNC describer_id ID frame_id frame_compile_id attempt describe_source describer_id ID id source L frame_id frame_compile_id attempt dynamo_output_graph sizes l_a_ sin frame_id frame_compile_id attempt has_payload HASH artifact name before_pre_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name after_pre_grad_graph encoding string frame_id frame_compile_id attempt has_payload HASH artifact name aot_forward_graph_fw_metadata encoding string frame_id frame_compile_id attempt has_payload HASH aot_inference_graph frame_id frame_compile_id attempt has_payload HASH artifact name fx_graph_runnable encoding string frame_id frame_compile_id attempt has_payload HASH inductor_post_grad_graph frame_id frame_compile_id attempt has_payload HASH inductor_output_code filename FILENAME file_path FILENAME frame_id frame_compile_id attempt has_payload HASH artifact name inductor_provenance_tracking_node_mappings encoding json frame_id frame_compile_id attempt artifact name inductor_provenance_tracking_kernel_stack_traces encoding json frame_id frame_compile_id attempt artifact name fx_graph_cache_hit encoding json frame_id frame_compile_id attempt has_payload HASH artifact name aotautograd_cache_hit encoding json frame_id frame_compile_id attempt has_payload HASH dynamo_cpp_guards_str frame_id frame_compile_id attempt has_payload HASH compilation_metrics METRICS frame_id frame_compile_id attempt noqa B assertParses requires_tlparse test_make_fx_fail_partial torch fx experimental proxy_tensor make_fx payload_buffer = io StringIO payload_handler = logging StreamHandler payload_buffer payload_handler setFormatter StructuredTracePayloadFormatter payload_handler addFilter StructuredTraceTestingFilter make_fx_fail_partial trace_log addHandler payload_handler f x y = x + noqa F raise RuntimeError boo try make_fx f torch randn except RuntimeError pass assertExpectedInline buffer getvalue \ artifact name make_fx_fail_partial encoding string stack STACK has_payload HASH assertExpectedInline payload_buffer getvalue \ forward x_ f cpu No stacktrace found following nodes add f cpu = torch ops aten add Tensor x_ x_ = add = None requires_tlparse torch _inductor config patch fx_graph_cache True show_chrome_events test_chromium_event fn sin x = torch tensor fn_opt = torch compile fn backend= inductor fn_opt x torch _dynamo reset Trigger cache hit fn_opt x Should print twice including inductor_output_code assertParses chromium_event = chromium_event frame_id frame_compile_id attempt has_payload HASH assertTrue chromium_event buffer getvalue requires_tlparse torch _dynamo config patch compiled_autograd True torch _inductor config patch fx_graph_cache True show_chrome_events test_compiled_autograd_id fn sin sum backward x = torch tensor requires_grad=True fn_opt = torch _dynamo optimize inductor fn fn_opt x torch _dynamo reset Trigger cache hit fn_opt x Should print twice including inductor_output_code assertParses chromium_events = chromium_event frame_id frame_compile_id attempt has_payload HASH compiled_autograd_graph compiled_autograd_id attempt has_payload HASH chromium_event compiled_autograd_id frame_id frame_compile_id attempt has_payload HASH logs = buffer getvalue assertTrue all event logs event chromium_events xfailIfS X requires_tlparse torch _dynamo config patch compiled_autograd True test_compiled_autograd_attribution multiple dynamo recompiles should still attributed parent compiled autograd id fn MySin torch autograd Function staticmethod forward ctx x ctx save_for_backward x torch sin x staticmethod backward ctx gO print graph break x = ctx saved_tensors print graph break gO torch cos x grads = i x = torch arange i requires_grad=True out = MySin apply x loss = out sum loss backward grads append x grad grads fn_opt = torch compile fn fn_opt assertParses expected = dynamo_start stack STACK frame_id frame_compile_id attempt dynamo_start stack STACK frame_id frame_compile_id attempt dynamo_start stack STACK frame_id frame_compile_id attempt dynamo_start stack STACK compiled_autograd_id frame_id frame_compile_id attempt dynamo_start stack STACK compiled_autograd_id frame_id frame_compile_id attempt dynamo_start stack STACK compiled_autograd_id frame_id frame_compile_id attempt dynamo_start stack STACK compiled_autograd_id frame_id frame_compile_id attempt dynamo_start stack STACK compiled_autograd_id frame_id frame_compile_id attempt dynamo_start stack STACK compiled_autograd_id frame_id frame_compile_id attempt dynamo_start stack STACK compiled_autograd_id frame_id frame_compile_id attempt logs = buffer getvalue assertTrue all event logs event expected requires_tlparse show_chrome_events test_compiled_autograd_chromium torch _dynamo compiled_autograd _enable torch compile i x = torch arange i requires_grad=True loss = x sum loss backward assertParses expected = chromium_event compiled_autograd_id attempt has_payload HASH chromium_event compiled_autograd_id frame_id frame_compile_id attempt has_payload HASH chromium_event compiled_autograd_id frame_id frame_compile_id attempt has_payload HASH logs = buffer getvalue assertTrue all event logs event expected test_recompile_user_contexts test user_context called only once per recompile num_calls = f x x + f = torch compile f user_context - str nonlocal num_calls num_calls += user_context + str num_calls torch _dynamo register_hook_for_recompile_user_context user_context _ range f torch randn first compile assertEqual num_calls i range f torch randn i first compile + recompile once assertEqual num_calls test_recompile_user_contexts_iteration Step __init__ step = next_step step += step = Step f x x + f = torch compile f user_context - str user_context + str step step torch _dynamo register_hook_for_recompile_user_context user_context i range f torch randn i + step next_step contextmanager _setup_collective_schedule_capture Helper turn capture inductor_collective_schedule structured trace payload_buffer = io StringIO payload_handler = logging StreamHandler payload_buffer payload_handler setLevel logging DEBUG payload_handler setFormatter StructuredTracePayloadFormatter payload_handler addFilter StructuredTraceTestingFilter inductor_collective_schedule trace_log addHandler payload_handler try yield payload_buffer finally trace_log removeHandler payload_handler requires_tlparse test_collective_schedule_empty Verify logging when no collective kernels present empty schedule _setup_collective_schedule_capture payload_buffer torch _inductor debug log_collective_schedule log_collective_schedule With no collectives artifact should logged payload should empty assertNotIn inductor_collective_schedule buffer getvalue assertEqual payload_buffer getvalue strip requires_tlparse requires_distributed torch _inductor config patch fx_graph_cache False test_collective_schedule_real Test collective schedule _c d_functional ops work FakeStore torch distributed dist store = FakeStore dist init_process_group backend= fake rank= world_size= store=store CollectiveModule torch nn Module forward x Use _c d_functional ops actually trigger collective kernels y = torch ops _c d_functional all_reduce default x sum y = torch ops _c d_functional wait_tensor default y y try _setup_collective_schedule_capture payload_buffer torch _dynamo reset mod = CollectiveModule compiled = torch compile mod backend= inductor compiled torch randn Verify collective schedule artifact logged assertIn inductor_collective_schedule buffer getvalue payload_content = payload_buffer getvalue strip schedule = json loads payload_content assertIsInstance schedule list Verify expected collective operations present assertExpectedInline str schedule \ torch ops _c d_functional all_reduce_ default torch ops _c d_functional wait_tensor default \ assertParses finally dist destroy_process_group contextmanager _setup_runtime_estimates_capture Helper turn capture combined inductor_runtime_and_tensor_meta structured trace payload_buffer = io StringIO payload_handler = logging StreamHandler payload_buffer payload_handler setLevel logging DEBUG payload_handler setFormatter StructuredTracePayloadFormatter payload_handler addFilter StructuredTraceTestingFilter inductor_runtime_and_tensor_meta trace_log addHandler payload_handler try yield payload_buffer finally trace_log removeHandler payload_handler requires_tlparse requires_distributed requires_cuda_and_triton torch _inductor config patch fx_graph_cache False torch _inductor config patch log_tlparse True test_runtime_estimates_simple Test runtime estimates logging simple compute collective ops torch distributed dist store = FakeStore dist init_process_group backend= fake rank= world_size= store=store SimpleModule torch nn Module __init__ super __init__ linear = torch nn Linear forward x h = linear x h = torch relu h h = torch ops _c d_functional all_reduce default h sum h = torch ops _c d_functional wait_tensor default h h try _setup_runtime_estimates_capture payload_buffer torch _dynamo reset mod = SimpleModule cuda compiled = torch compile mod backend= inductor compiled torch randn device= cuda Verify runtime + tensor meta artifact logged assertIn inductor_runtime_and_tensor_meta buffer getvalue payload_content = payload_buffer getvalue strip payload_content data = json loads payload_content assertIn ops data ops = data ops Verify runtime estimates compute_ops = op op ops op type == compute collective_ops = op op ops op type == collective assertTrue len compute_ops len collective_ops Just check each op has estimated runtime value any value including op ops assertIn estimated_runtime_ns op assertIsNotNone op estimated_runtime_ns assertParses finally dist destroy_process_group requires_tlparse requires_distributed requires_cuda_and_triton torch _inductor config patch fx_graph_cache False torch _inductor config patch log_tlparse True test_runtime_estimates_mixed Test runtime estimates logging mixed compute collective sequence torch distributed dist store = FakeStore dist init_process_group backend= fake rank= world_size= store=store MixedModule torch nn Module __init__ super __init__ norm = torch nn LayerNorm forward x h = norm x h = torch nn functional gelu h h = torch ops _c d_functional all_reduce default h sum h = torch ops _c d_functional wait_tensor default h h = h gathered = torch ops _c d_functional all_gather_into_tensor default h gathered = torch ops _c d_functional wait_tensor default gathered gathered sum dim= try _setup_runtime_estimates_capture payload_buffer torch _dynamo reset mod = MixedModule cuda compiled = torch compile mod backend= inductor compiled torch randn device= cuda Verify artifact logged assertIn inductor_runtime_and_tensor_meta buffer getvalue payload_content = payload_buffer getvalue strip payload_content data = json loads payload_content assertIn ops data ops = data ops Should have both compute collective ops op_types = op type op ops assertIn compute op_types assertIn collective op_types Just check each op has estimated runtime value any value including op ops assertIn estimated_runtime_ns op assertIsNotNone op estimated_runtime_ns assertParses finally dist destroy_process_group requires_tlparse requires_distributed requires_cuda_and_triton torch _inductor config patch fx_graph_cache False torch _inductor config patch log_tlparse True test_tensor_metadata_logging_multiple_ops torch distributed dist store = FakeStore dist init_process_group backend= fake rank= world_size= store=store Mixed torch nn Module __init__ super __init__ linear = torch nn Linear forward x y = torch relu linear x y = torch ops _c d_functional all_reduce default y sum y = torch ops _c d_functional wait_tensor default y y + try _setup_runtime_estimates_capture payload_buffer torch _dynamo reset mod = Mixed cuda compiled = torch compile mod backend= inductor compiled torch randn device= cuda payload = payload_buffer getvalue strip payload data = json loads payload types = sorted op get type op data get ops assertExpectedInline str types collective compute assertParses finally dist destroy_process_group requires_tlparse torch _inductor config patch log_tlparse True test_tensor_metadata_logging Emit unified runtime+tensor-metadata artifact assert stable simplified JSON inline _setup_runtime_estimates_capture payload_buffer f x y = x transpose z = y mean dim= w = z torch float w compiled = torch compile f backend= inductor fullgraph=True compiled torch ones Verify artifact logged assertIn inductor_runtime_and_tensor_meta buffer getvalue payload = payload_buffer getvalue strip payload data = json loads payload ops = data get ops simplified_ops = op ops outs = shape out get shape stride out get stride dtype out get dtype None out op get outputs outs simplified_ops append type op get type outputs outs assertExpectedInline ops simplified_ops - simplified_ops ops ops type compute outputs shape stride dtype float assertParses requires_tlparse torch _inductor config patch log_tlparse True test_tensor_metadata_logging_dynamic_shapes Same test_tensor_metadata_logging dynamic shapes enabled cover to_size_hints _setup_runtime_estimates_capture payload_buffer f x y = x transpose z = y mean dim= w = z torch float w compiled = torch compile f backend= inductor dynamic=True compiled torch ones Verify artifact logged assertIn inductor_runtime_and_tensor_meta buffer getvalue payload = payload_buffer getvalue strip payload data = json loads payload ops = data get ops simplified_ops = op ops outs = shape out get shape stride out get stride dtype out get dtype None out op get outputs outs simplified_ops append type op get type outputs outs assertExpectedInline ops simplified_ops - simplified_ops ops ops type compute outputs shape stride dtype float shape stride dtype float assertParses contextmanager _setup_graph_execution_capture Helper capture graph_execution structured trace payload_buffer = io StringIO payload_handler = logging StreamHandler payload_buffer payload_handler setLevel logging DEBUG payload_handler setFormatter StructuredTracePayloadFormatter payload_handler addFilter StructuredTraceTestingFilter graph_execution trace_log addHandler payload_handler try yield payload_buffer finally trace_log removeHandler payload_handler requires_tlparse torch _inductor config patch force_disable_caches=True test_graph_execution_order Verify graph execution order aggregated into single artifact torch _dynamo reset _setup_graph_execution_capture payload_buffer fn x y = x + torch _dynamo graph_break y + compiled = torch compile fn backend= inductor torch _inductor debug record_and_log_graph_execution_order record_and_log_graph_execution_order compiled torch randn payload_content = payload_buffer getvalue strip payload = json loads payload_content executions = payload graph_execution_order assertTrue all isinstance e compile_id str e executions assertExpectedInline json dumps payload graph_execution_order compile_id compile_id assertParses __name__ == __main__ torch _dynamo test_case run_tests run_tests
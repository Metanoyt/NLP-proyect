Template heuristic registry system PyTorch Inductor This module provides centralized registration system template heuristics allowing automatic registration based device type conditional registration CUDA vs ROCm based torch version hip __future__ annotations contextlib logging typing Any Optional TYPE_CHECKING Union base TemplateConfigHeuristics TYPE_CHECKING collections abc Iterator Module-wide registry template heuristics _TEMPLATE_HEURISTIC_REGISTRY dict tuple Union str None type TemplateConfigHeuristics = Manual cache successful lookups only fallback instances cached _HEURISTIC_CACHE dict tuple str str str TemplateConfigHeuristics = log = logging getLogger __name__ register_template_heuristic template_name str device_type Union str None register bool = True op_name Optional str = None - Any Decorator register template heuristic classes Args template_name Name template e g mm bmm scaled_mm device_type Device type cuda cpu xpu Set None indicate heuristic applicable all device types register Whether register heuristic Caller should pass condition directly op_name Name operator e g mm bmm scaled_mm This optional only used when template uses different heuristics different ops Returns Decorator function registers conditions met Example register_template_heuristic mm cuda register=torch version hip None CUDAMMTemplateConfigHeuristic MMTemplateConfigMixin CUDAConfigHeuristic pass decorator cls type TemplateConfigHeuristics - type TemplateConfigHeuristics register key tuple Union str None = template_name device_type op_name _TEMPLATE_HEURISTIC_REGISTRY key = cls log info f Registered template heuristic cls __name__ template_name= device_type= op_name= noqa G cls decorator get_template_heuristic template_name str device_type str op_name str - TemplateConfigHeuristics Retrieve template heuristic instance given template device type Args template_name Name template e g mm bmm scaled_mm device_type Device type cuda cpu xpu op_name Name operator e g mm bmm scaled_mm Returns Template heuristic instance If no specific heuristic found returns fallback TemplateConfigHeuristics instance uncached Check cache first cache_key = template_name device_type op_name cache_key _HEURISTIC_CACHE _HEURISTIC_CACHE cache_key keys = everything specified template_name device_type op_name heuristic valid across all devices template_name None op_name heuristic valid across all ops device template_name device_type None heuristic always valid template template_name None None Look up registry heuristic_class = None key keys key _TEMPLATE_HEURISTIC_REGISTRY heuristic_class = _TEMPLATE_HEURISTIC_REGISTRY key break heuristic_class None Log error fallback instance uncached log error No template heuristic found - template_name= s device_type= s op_name= s Available combinations s Using fallback TemplateConfigHeuristics instance template_name device_type op_name list _TEMPLATE_HEURISTIC_REGISTRY keys TemplateConfigHeuristics Cache successful lookup instance = heuristic_class _HEURISTIC_CACHE cache_key = instance instance clear_registry - None Clear all registered template heuristics This primarily useful testing purposes ensure clean state _TEMPLATE_HEURISTIC_REGISTRY clear _HEURISTIC_CACHE clear contextlib contextmanager override_template_heuristics device_type str template_op_pairs list tuple str str - Iterator None Context manager temporarily override template heuristics empty heuristic This useful testing purposes where we want ensure specific template op pair used Args device_type Device type cuda cpu xpu template_op_pairs List template_name op_name pairs override Save original entries restore later original_entries = new_keys = _HEURISTIC_CACHE clear try template_name op_name template_op_pairs assert op_name None key = device_type template_name op_name key _TEMPLATE_HEURISTIC_REGISTRY original_entries key = _TEMPLATE_HEURISTIC_REGISTRY key TemplateConfigHeuristics base returns no entries so we use overriding _TEMPLATE_HEURISTIC_REGISTRY key = TemplateConfigHeuristics new_keys append key yield finally Restore original entries remove they didn t exist before key new_keys _TEMPLATE_HEURISTIC_REGISTRY pop key None key original_entries _TEMPLATE_HEURISTIC_REGISTRY key = original_entries key _HEURISTIC_CACHE clear
mypy allow-untyped-defs typing Optional Union torch torch nn functional F torch Tensor torch distributions constraints torch distributions distribution Distribution torch distributions gamma Gamma torch distributions utils broadcast_all lazy_property logits_to_probs probs_to_logits __all__ = NegativeBinomial NegativeBinomial Distribution r Creates Negative Binomial distribution i e distribution number successful independent identical Bernoulli trials before attr ` total_count ` failures achieved The probability success each Bernoulli trial attr ` probs ` Args total_count float Tensor non-negative number negative Bernoulli trials stop although distribution still valid real valued count probs Tensor Event probabilities success half open interval logits Tensor Event log-odds probabilities success pyrefly ignore bad-override arg_constraints = total_count constraints greater_than_eq probs constraints half_open_interval logits constraints real support = constraints nonnegative_integer __init__ total_count Union Tensor float probs Optional Tensor = None logits Optional Tensor = None validate_args Optional bool = None - None probs None == logits None raise ValueError Either ` probs ` ` logits ` must specified both probs None total_count pyrefly ignore read-only probs = broadcast_all total_count probs total_count = total_count type_as probs assert logits None helps mypy total_count pyrefly ignore read-only logits = broadcast_all total_count logits total_count = total_count type_as logits _param = probs probs None logits batch_shape = _param size super __init__ batch_shape validate_args=validate_args expand batch_shape _instance=None new = _get_checked_instance NegativeBinomial _instance batch_shape = torch Size batch_shape new total_count = total_count expand batch_shape probs __dict__ new probs = probs expand batch_shape new _param = new probs logits __dict__ new logits = logits expand batch_shape new _param = new logits super NegativeBinomial new __init__ batch_shape validate_args=False new _validate_args = _validate_args new _new args kwargs _param new args kwargs property mean - Tensor total_count torch exp logits property mode - Tensor total_count - logits exp floor clamp min= property variance - Tensor mean torch sigmoid -self logits lazy_property logits - Tensor probs_to_logits probs is_binary=True lazy_property probs - Tensor logits_to_probs logits is_binary=True property param_shape - torch Size _param size lazy_property _gamma - Gamma Note we avoid validating because total_count can zero Gamma concentration=self total_count rate=torch exp -self logits validate_args=False sample sample_shape=torch Size torch no_grad rate = _gamma sample sample_shape=sample_shape torch poisson rate log_prob value _validate_args _validate_sample value log_unnormalized_prob = total_count F logsigmoid -self logits + value F logsigmoid logits log_normalization = -torch lgamma total_count + value + torch lgamma + value + torch lgamma total_count The case total_count == value == has probability lgamma infinite Handle case separately using function does modify tensors place allow Jit compilation log_normalization = log_normalization masked_fill total_count + value == log_unnormalized_prob - log_normalization
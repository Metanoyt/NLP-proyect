Owner s oncall profiler ruff noqa F typing Any torch torch optim torch utils data torch utils data datapipes dp torch _dispatch python enable_python_dispatcher torch autograd _record_function_with_args_enter _record_function_with_args_exit torch autograd profiler profile _profile torch profiler kineto_available record_function torch testing _internal common_utils run_tests TestCase tqdm shutdown properly will leave monitor thread alive This causes issue multithreading test because we check all events test their tids The events correspond these lingering threads all have TID uint _t - which invalid The work around turning off monitoring thread when tqdm loaded Since these unit tests safe turn off monitor thread try tqdm tqdm tqdm monitor_interval = except ImportError pass Json = dict str Any TestRecordFunction TestCase _record_function_with_param u = torch randn requires_grad=True _profile with_stack=True use_kineto=kineto_available record_shapes=True prof record_function ## TEST ## rf_handle = _record_function_with_args_enter ## TEST ## False u u hello u _record_function_with_args_exit rf_handle record_function ## TEST ## rf_handle = _record_function_with_args_enter ## TEST ## _record_function_with_args_exit rf_handle prof test_record_function prof_result = _record_function_with_param found_test_ = False found_test_ = False found_test_ = False found_test_ = False e prof_result function_events ## TEST ## == e name found_test_ = True assertTrue e input_shapes == ## TEST ## == e name found_test_ = True assertTrue e input_shapes == ## TEST ## == e name found_test_ = True assertTrue e input_shapes == ## TEST ## == e name found_test_ = True assertTrue e input_shapes == assertTrue found_test_ assertTrue found_test_ assertTrue found_test_ assertTrue found_test_ test_datapipe_with_record_function _profile with_stack=True use_kineto=kineto_available record_shapes=True prof input_dp = dp iter IterableWrapper range input_dp = dp iter IterableWrapper range input_dp = dp iter IterableWrapper range output_dp = input_dp mux input_dp input_dp output = list output_dp has_iter = False has_mux = False e prof function_events has_iter has_mux break has_iter IterableWrapper e name has_iter = True has_mux Multiplexer e name has_mux = True assertTrue has_iter assertTrue has_mux test_datapipe_delegation_with_profiler IDPIterator torch utils data IterDataPipe __init__ - None data = list range _idx = __iter__ __next__ _idx = _idx = raise StopIteration _idx += data _idx - get_value idx data idx dp = IDPIterator The object itself iterator assertEqual dp get_value it_dp = iter dp This creates st iterator assertEqual it_dp get_value type ignore attr-defined assertEqual list range list it_dp IDPDelegator torch utils data IterDataPipe __init__ datapipe datapipe = datapipe __iter__ iter datapipe dp = IDPDelegator dp it_dp = iter dp assertEqual it_dp get_value assertEqual list range list it_dp test_datapipe_with_record_function_fork _profile with_stack=True use_kineto=kineto_available record_shapes=True prof input_dp = dp iter IterableWrapper range dp dp dp = input_dp fork num_instances= output = list dp has_iter = False has_child = False e prof function_events has_iter has_child break has_iter IterableWrapper e name has_iter = True has_child _ChildDataPipe e name has_child = True assertTrue has_iter assertTrue has_child test_python_dispatch_mode_record_function torch utils _python_dispatch TorchDispatchMode TestDispatchMode TorchDispatchMode __torch_dispatch__ func types args= kwargs=None kwargs None kwargs = func args kwargs _profile prof enable_python_dispatcher TestDispatchMode x = torch randn y = torch sin x found_python_dispatch_mode = False e prof function_events e name == PythonDispatchMode found_python_dispatch_mode = True break assertTrue found_python_dispatch_mode PythonDispatchMode record function found profiler events test_python_subclass_record_function TestTensorSubclass torch Tensor staticmethod __new__ cls elem r = torch Tensor _make_wrapper_subclass cls elem size dtype=elem dtype device=elem device requires_grad=elem requires_grad r elem = elem r classmethod __torch_dispatch__ cls func types args= kwargs=None kwargs None kwargs = unwrap x x elem isinstance x TestTensorSubclass x wrap x TestTensorSubclass x isinstance x torch Tensor x unwrapped_args = tuple unwrap arg arg args unwrapped_kwargs = k unwrap v k v kwargs items result = func unwrapped_args unwrapped_kwargs isinstance result torch Tensor TestTensorSubclass result result _profile prof enable_python_dispatcher x = TestTensorSubclass torch randn y = torch sin x found_python_subclass = False e prof function_events e name == PythonSubclass found_python_subclass = True break assertTrue found_python_subclass PythonSubclass record function found profiler events __name__ == __main__ run_tests
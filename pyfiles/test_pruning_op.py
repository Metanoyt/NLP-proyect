Owner s module unknown hypothesis strategies st hypothesis given numpy np torch torch testing _internal common_utils TestCase run_tests skipIfTorchDynamo torch testing _internal hypothesis_utils hu hu assert_deadline_disabled PruningOpTest TestCase Generate rowwise mask vector based indicator threshold value indicator vector contains one value per weight row represents importance row We mask row its indicator value less than threshold _generate_rowwise_mask embedding_rows indicator = torch from_numpy np random random_sample embedding_rows astype np float threshold = float np random random_sample mask = torch BoolTensor val = threshold val indicator mask _test_rowwise_prune_op embedding_rows embedding_dims indices_type weights_dtype embedding_weights = None weights_dtype torch int torch int torch int torch int embedding_weights = torch randint embedding_rows embedding_dims dtype=weights_dtype embedding_weights = torch rand embedding_rows embedding_dims dtype=weights_dtype mask = _generate_rowwise_mask embedding_rows get_pt_result embedding_weights mask indices_type torch _rowwise_prune embedding_weights mask indices_type Reference implementation get_reference_result embedding_weights mask indices_type num_embeddings = mask size compressed_idx_out = torch zeros num_embeddings dtype=indices_type pruned_weights_out = embedding_weights mask idx = i range mask size mask i compressed_idx_out i = idx idx = idx + compressed_idx_out i = - pruned_weights_out compressed_idx_out pt_pruned_weights pt_compressed_indices_map = get_pt_result embedding_weights mask indices_type ref_pruned_weights ref_compressed_indices_map = get_reference_result embedding_weights mask indices_type torch testing assert_close pt_pruned_weights ref_pruned_weights assertEqual pt_compressed_indices_map ref_compressed_indices_map assertEqual pt_compressed_indices_map dtype indices_type skipIfTorchDynamo given embedding_rows=st integers embedding_dims=st integers weights_dtype=st sampled_from torch float torch float torch float torch int torch int torch int torch int test_rowwise_prune_op_ bit_indices embedding_rows embedding_dims weights_dtype _test_rowwise_prune_op embedding_rows embedding_dims torch int weights_dtype skipIfTorchDynamo given embedding_rows=st integers embedding_dims=st integers weights_dtype=st sampled_from torch float torch float torch float torch int torch int torch int torch int test_rowwise_prune_op_ bit_indices embedding_rows embedding_dims weights_dtype _test_rowwise_prune_op embedding_rows embedding_dims torch int weights_dtype __name__ == __main__ run_tests
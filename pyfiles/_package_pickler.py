mypy allow-untyped-defs pyrefly ignore missing-module-attribute pickle type ignore attr-defined _compat_pickle _extension_registry _getattribute _Pickler EXT EXT EXT GLOBAL PicklingError STACK_GLOBAL struct pack types FunctionType importer Importer ObjMismatchError ObjNotFoundError sys_importer _PyTorchLegacyPickler _Pickler __init__ args kwargs super __init__ args kwargs _persistent_id = None persistent_id obj _persistent_id None super persistent_id obj _persistent_id obj PackagePickler _PyTorchLegacyPickler Package-aware pickler This behaves same normal pickler except uses ` Importer ` find objects modules save __init__ importer Importer args kwargs importer = importer super __init__ args kwargs Make sure dispatch table copied _Pickler up-to-date Previous issues have been encountered where library e g dill mutate _Pickler dispatch PackagePickler makes copy when lib imported then offending library removes its dispatch entries leaving PackagePickler stale dispatch table may cause unwanted behavior dispatch = _Pickler dispatch copy type ignore misc dispatch FunctionType = PackagePickler save_global type ignore assignment save_global obj name=None ruff noqa F unfortunately pickler code factored way forces us copy paste function The only change marked CHANGED below write = write type ignore attr-defined memo = memo type ignore attr-defined CHANGED module module environment instead __import__ try module_name name = importer get_name obj name except ObjNotFoundError ObjMismatchError err raise PicklingError f Can t pickle obj str err err module = importer import_module module_name _ parent = _getattribute module name END CHANGED proto = type ignore attr-defined code = _extension_registry get module_name name code assert code code = xFF write EXT + pack B code code = xFFFF write EXT + pack H code write EXT + pack i code lastname = name rpartition parent module name = lastname Non-ASCII identifiers supported only protocols = proto = type ignore attr-defined save module_name type ignore attr-defined save name type ignore attr-defined write STACK_GLOBAL parent module save_reduce getattr parent lastname type ignore attr-defined proto = type ignore attr-defined write GLOBAL + bytes module_name utf- + b \n + bytes name utf- + b \n fix_imports type ignore attr-defined r_name_mapping = _compat_pickle REVERSE_NAME_MAPPING r_import_mapping = _compat_pickle REVERSE_IMPORT_MAPPING module_name name r_name_mapping module_name name = r_name_mapping module_name name module_name r_import_mapping module_name = r_import_mapping module_name try write GLOBAL + bytes module_name ascii + b \n + bytes name ascii + b \n except UnicodeEncodeError exc raise PicklingError f can t pickle global identifier module name using f pickle protocol proto d type ignore attr-defined exc memoize obj type ignore attr-defined create_pickler data_buf importer protocol= importer sys_importer we using normal library system then we can use C implementation pickle which faster _PyTorchLegacyPickler data_buf protocol=protocol PackagePickler importer data_buf protocol=protocol
usr bin python mypy allow-untyped-defs get_remote_module_template enable_moving_cpu_tensors_to_cuda bool _TEMPLATE_PREFIX + _REMOTE_FORWARD_TEMPLATE_ENABLE_MOVING_CPU_TENSORS_TO_CUDA enable_moving_cpu_tensors_to_cuda _REMOTE_FORWARD_TEMPLATE _TEMPLATE_PREFIX = typing torch torch distributed rpc rpc torch Tensor torch _jit_internal Future torch distributed rpc RRef typing Tuple pyre-ignore unused assign_module_interface_cls forward_async arg_types arrow_and_future_return_type args = module_rref device is_device_map_set args kwargs = kwargs rpc rpc_async module_rref owner _remote_forward args kwargs forward arg_types arrow_and_return_type args = module_rref device is_device_map_set args kwargs = kwargs ret_fut = rpc rpc_async module_rref owner _remote_forward args kwargs ret_fut wait _generated_methods = forward_async forward jit_script_decorator This template may cause typing error mismatch between ` ` Tuple ` ` ` ` Tuple Any ` ` even code only used instantiation execution Therefore only include handling moving CPU tensors cuda device necessary TODO Merge these two templates together future once TorchScript syntax improved _REMOTE_FORWARD_TEMPLATE_ENABLE_MOVING_CPU_TENSORS_TO_CUDA = _remote_forward module_rref RRef module_interface_cls device str is_device_map_set bool arg_types arrow_and_return_type module = module_rref local_value device = torch device device device type = cuda module forward args kwargs If module cuda device move any CPU tensor args kwargs same cuda device Since torch script does support generator expression have use concatenation instead ` ` tuple i device isinstance i Tensor i i args ` ` args = args out_args Tuple = arg args arg = arg device isinstance arg Tensor arg out_args = out_args + arg kwargs = kwargs k v kwargs items isinstance v Tensor kwargs k = kwargs k device is_device_map_set module forward out_args kwargs If device map empty then only CPU tensors allowed send over wire so have move any GPU tensor CPU output Since torch script does support generator expression have use concatenation instead ` ` tuple i cpu isinstance i Tensor i i module forward out_args kwargs ` ` ret Tuple = i module forward out_args kwargs i = i cpu isinstance i Tensor i ret = ret + i ret _REMOTE_FORWARD_TEMPLATE = _remote_forward module_rref RRef module_interface_cls device str is_device_map_set bool arg_types arrow_and_return_type module = module_rref local_value module forward args kwargs
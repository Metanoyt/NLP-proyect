Owner s module unknown io os shutil sys tempfile unittest pathlib Path expecttest numpy np TEST_TENSORBOARD = True try tensorboard summary writer event_file_writer noqa F tensorboard compat proto summary_pb Summary except ImportError TEST_TENSORBOARD = False HAS_TORCHVISION = True try torchvision except ImportError HAS_TORCHVISION = False skipIfNoTorchVision = unittest skipIf HAS_TORCHVISION no torchvision TEST_MATPLOTLIB = True try matplotlib os environ get DISPLAY == matplotlib use Agg matplotlib pyplot plt except ImportError TEST_MATPLOTLIB = False skipIfNoMatplotlib = unittest skipIf TEST_MATPLOTLIB no matplotlib torch torch testing _internal common_utils instantiate_parametrized_tests parametrize IS_MACOS IS_WINDOWS run_tests skipIfTorchDynamo TEST_WITH_CROSSREF TestCase xfailIfS X tensor_N shape dtype=float numel = np prod shape x = np arange numel dtype=dtype reshape shape x BaseTestCase TestCase Base used all TensorBoard tests setUp super setUp TEST_TENSORBOARD skipTest Skip test since TensorBoard installed TEST_WITH_CROSSREF skipTest Don t run TensorBoard tests crossref temp_dirs = createSummaryWriter Just get name directory writable place tearDown responsible clean-ups temp_dir = tempfile TemporaryDirectory prefix= test_tensorboard name temp_dirs append temp_dir SummaryWriter temp_dir tearDown super tearDown Remove directories created SummaryWriter temp_dir temp_dirs os path exists temp_dir shutil rmtree temp_dir assertProto actual_proto expecttest ACCEPT write_proto actual_proto True expected_str = read_expected_content expected_proto = Summary text_format Parse expected_str expected_proto assertEqual actual_proto expected_proto assertImageProto actual_proto expecttest ACCEPT expected_file = get_expected_file open expected_file w f f write text_format MessageToString actual_proto True expected_str = read_expected_content expected_proto = Summary text_format Parse expected_str expected_proto actual expected = actual_proto value expected_proto value actual_img = Image open io BytesIO actual image encoded_image_string expected_img = Image open io BytesIO expected image encoded_image_string assertEqual actual tag expected tag assertEqual actual image height expected image height assertEqual actual image width expected image width assertEqual actual image colorspace expected image colorspace assertEqual actual_img expected_img TEST_TENSORBOARD google protobuf text_format PIL Image tensorboard compat proto graph_pb GraphDef tensorboard compat proto types_pb DataType torch utils tensorboard summary SummaryWriter torch utils tensorboard _convert_np make_np torch utils tensorboard _pytorch_graph graph torch utils tensorboard _utils _prepare_video convert_to_HWC torch utils tensorboard summary int_to_half tensor_proto Dummy parametrization DataType DT_FLOAT DT_HALF DT_BFLOAT DT_INT = None TestTensorBoardPyTorchNumpy BaseTestCase test_pytorch_np tensors = torch rand torch rand torch rand tensor tensors regular tensor assertIsInstance make_np tensor np ndarray CUDA tensor torch cuda is_available assertIsInstance make_np tensor cuda np ndarray regular variable assertIsInstance make_np torch autograd Variable tensor np ndarray CUDA variable torch cuda is_available assertIsInstance make_np torch autograd Variable tensor cuda np ndarray python primitive type assertIsInstance make_np np ndarray assertIsInstance make_np np ndarray test_pytorch_autograd_np x = torch autograd Variable torch empty assertIsInstance make_np x np ndarray test_pytorch_write createSummaryWriter w w add_scalar scalar torch autograd Variable torch rand test_pytorch_histogram createSummaryWriter w w add_histogram float histogram torch rand w add_histogram int histogram torch randint w add_histogram bfloat histogram torch rand dtype=torch bfloat test_pytorch_histogram_raw createSummaryWriter w num = floats = make_np torch rand num bins = counts limits = np histogram floats bins sum_sq = floats dot floats item w add_histogram_raw float histogram raw min=floats min item max=floats max item num=num sum=floats sum item sum_squares=sum_sq bucket_limits=limits tolist bucket_counts=counts tolist ints = make_np torch randint num bins = counts limits = np histogram ints bins sum_sq = ints dot ints item w add_histogram_raw int histogram raw min=ints min item max=ints max item num=num sum=ints sum item sum_squares=sum_sq bucket_limits=limits tolist bucket_counts=counts tolist ints = torch tensor range float nbins = counts = torch histc ints bins=nbins min= max= limits = torch tensor range nbins sum_sq = ints dot ints item w add_histogram_raw int histogram raw min=ints min item max=ints max item num=num sum=ints sum item sum_squares=sum_sq bucket_limits=limits tolist bucket_counts=counts tolist TestTensorBoardUtils BaseTestCase test_to_HWC test_image = np random randint size= dtype=np uint converted = convert_to_HWC test_image chw assertEqual converted shape test_image = np random randint size= dtype=np uint converted = convert_to_HWC test_image nchw assertEqual converted shape test_image = np random randint size= dtype=np uint converted = convert_to_HWC test_image hw assertEqual converted shape test_convert_to_HWC_dtype_remains_same test ensure convert_to_HWC restores dtype input np array thus scale_factor calculated image test_image = torch tensor dtype=torch uint tensor = make_np test_image tensor = convert_to_HWC tensor NCHW scale_factor = summary _calc_scale_factor tensor assertEqual scale_factor msg= Values already scale factor should test_prepare_video At each timeframe sum over all other dimensions video should same shapes = s shapes V_input = np random random s V_after = _prepare_video np copy V_input total_frame = s V_input = np swapaxes V_input f range total_frame x = np reshape V_input f newshape= - y = np reshape V_after f newshape= - np testing assert_array_almost_equal np sum x np sum y test_numpy_vid_uint V_input = np random randint astype np uint V_after = _prepare_video np copy V_input total_frame = V_input shape V_input = np swapaxes V_input f range total_frame x = np reshape V_input f newshape= - y = np reshape V_after f newshape= - np testing assert_array_almost_equal np sum x np sum y freqs = true_positive_counts = false_positive_counts = true_negative_counts = false_negative_counts = precision = recall = TestTensorBoardWriter BaseTestCase unittest skipIf sys version_info = numpy failure likely caused old tensorboard version test_writer createSummaryWriter writer sample_rate = n_iter = writer add_hparams lr bsize hparam accuracy hparam loss writer add_scalar data scalar_systemtime n_iter writer add_scalar data scalar_customtime n_iter walltime=n_iter writer add_scalar data new_style n_iter new_style=True writer add_scalars data scalar_group xsinx n_iter np sin n_iter xcosx n_iter np cos n_iter arctanx np arctan n_iter n_iter x = np zeros output network writer add_images Image x n_iter Tensor writer add_image_with_boxes imagebox np zeros np array n_iter x = np zeros sample_rate writer add_audio myAudio x n_iter writer add_video myVideo np random rand astype np float n_iter writer add_text Text text logged step + str n_iter n_iter writer add_text markdown Text &#124; b\n- &#124; -\nc &#124; d n_iter writer add_histogram hist np random rand n_iter writer add_pr_curve xoxo np random randint size= np random rand n_iter needs tensorboard RC later writer add_pr_curve_raw prcurve raw data true_positive_counts false_positive_counts true_negative_counts false_negative_counts precision recall n_iter v = np array - - - - - - dtype=float c = np array dtype=int f = np array dtype=int writer add_mesh my_mesh vertices=v colors=c faces=f TestTensorBoardSummaryWriter BaseTestCase test_summary_writer_ctx after using SummaryWriter ctx should closed createSummaryWriter writer writer add_scalar test assertIs writer file_writer None test_summary_writer_close Opening closing SummaryWriter lot should run into OSError Errno Too many open files passed = True try writer = createSummaryWriter writer close except OSError passed = False assertTrue passed test_pathlib tempfile TemporaryDirectory prefix= test_tensorboard_pathlib d p = Path d SummaryWriter p writer writer add_scalar test TestTensorBoardEmbedding BaseTestCase test_embedding w = createSummaryWriter all_features = torch tensor all_labels = torch tensor all_images = torch zeros w add_embedding all_features metadata=all_labels label_img=all_images global_step= dataset_label = test + train all_labels = list zip all_labels dataset_label w add_embedding all_features metadata=all_labels label_img=all_images metadata_header= digit dataset global_step= assert test_embedding_ w = createSummaryWriter all_features = torch tensor all_labels = torch tensor all_images = torch zeros dtype=torch float w add_embedding all_features metadata=all_labels label_img=all_images global_step= dataset_label = test + train all_labels = list zip all_labels dataset_label w add_embedding all_features metadata=all_labels label_img=all_images metadata_header= digit dataset global_step= TestTensorBoardSummary BaseTestCase test_uint _image Tests uint image pixel values changed test_image = np random randint size= dtype=np uint scale_factor = summary _calc_scale_factor test_image assertEqual scale_factor msg= Values already scale factor should test_float _image Tests float image pixel values scaled correctly test_image = np random rand astype np float scale_factor = summary _calc_scale_factor test_image assertEqual scale_factor msg= Values scale factor should test_list_input assertRaises Exception summary histogram dummy tensorflow test_empty_input assertRaises Exception summary histogram dummy np ndarray tensorflow test_image_with_boxes assertImageProto summary image_boxes dummy tensor_N shape= np array test_image_with_one_channel assertImageProto summary image dummy tensor_N shape= dataformats= CHW test_image_with_one_channel_batched assertImageProto summary image dummy tensor_N shape= dataformats= NCHW test_image_with_ _channel_batched assertImageProto summary image dummy tensor_N shape= dataformats= NCHW test_image_without_channel assertImageProto summary image dummy tensor_N shape= dataformats= HW test_video try moviepy noqa F except ImportError assertProto summary video dummy tensor_N shape= summary video dummy np random rand summary video dummy np random rand xfailIfS X test_audio assertProto summary audio dummy tensor_N shape= test_text assertProto summary text dummy text test_histogram_auto assertProto summary histogram dummy tensor_N shape= bins= auto max_bins= test_histogram_fd assertProto summary histogram dummy tensor_N shape= bins= fd max_bins= test_histogram_doane assertProto summary histogram dummy tensor_N shape= bins= doane max_bins= test_custom_scalars layout = Taiwan twse Multiline twse twse USA dow Margin dow aaa dow bbb dow ccc nasdaq Margin nasdaq aaa nasdaq bbb nasdaq ccc summary custom_scalars layout only smoke test Because protobuf python serialize dictionary differently test_mesh v = np array - - - - - - dtype=float c = np array dtype=int f = np array dtype=int mesh = summary mesh my_mesh vertices=v colors=c faces=f config_dict=None assertProto mesh test_scalar_new_style scalar = summary scalar test_scalar new_style=True assertProto scalar assertRaises AssertionError summary scalar test_scalar torch Tensor new_style=True remove_whitespace string string replace replace \t replace \n get_expected_file function_ptr module_id = function_ptr __class__ __module__ test_file = sys modules module_id __file__ Look py file since __file__ could pyc test_file = join test_file split - + py Use realpath follow symlinks appropriately test_dir = os path dirname os path realpath test_file functionName = function_ptr id split - os path join test_dir expect TestTensorBoard + functionName + expect read_expected_content function_ptr expected_file = get_expected_file function_ptr assert os path exists expected_file expected_file open expected_file f f read write_proto str_to_compare function_ptr expected_file = get_expected_file function_ptr open expected_file w f f write str str_to_compare TestTensorBoardPytorchGraph BaseTestCase test_pytorch_graph dummy_input = torch zeros myLinear torch nn Module __init__ - None super __init__ l = torch nn Linear forward x l x createSummaryWriter w w add_graph myLinear dummy_input actual_proto _ = graph myLinear dummy_input expected_str = read_expected_content expected_proto = GraphDef text_format Parse expected_str expected_proto assertEqual len expected_proto node len actual_proto node i range len expected_proto node expected_node = expected_proto node i actual_node = actual_proto node i assertEqual expected_node name actual_node name assertEqual expected_node op actual_node op assertEqual expected_node input actual_node input assertEqual expected_node device actual_node device assertEqual sorted expected_node attr keys sorted actual_node attr keys test_nested_nn_squential dummy_input = torch randn InnerNNSquential torch nn Module __init__ dim dim super __init__ inner_nn_squential = torch nn Sequential torch nn Linear dim dim torch nn Linear dim dim forward x x = inner_nn_squential x x OuterNNSquential torch nn Module __init__ dim = dim = depth= super __init__ layers = _ range depth layers append InnerNNSquential dim dim outer_nn_squential = torch nn Sequential layers forward x x = outer_nn_squential x x createSummaryWriter w w add_graph OuterNNSquential dummy_input actual_proto _ = graph OuterNNSquential dummy_input expected_str = read_expected_content expected_proto = GraphDef text_format Parse expected_str expected_proto assertEqual len expected_proto node len actual_proto node i range len expected_proto node expected_node = expected_proto node i actual_node = actual_proto node i assertEqual expected_node name actual_node name assertEqual expected_node op actual_node op assertEqual expected_node input actual_node input assertEqual expected_node device actual_node device assertEqual sorted expected_node attr keys sorted actual_node attr keys test_pytorch_graph_dict_input Model torch nn Module __init__ - None super __init__ l = torch nn Linear forward x l x ModelDict torch nn Module __init__ - None super __init__ l = torch nn Linear forward x out l x dummy_input = torch zeros createSummaryWriter w w add_graph Model dummy_input createSummaryWriter w w add_graph Model dummy_input use_strict_trace=True expect error Encountering dict output tracer assertRaises RuntimeError createSummaryWriter w w add_graph ModelDict dummy_input use_strict_trace=True createSummaryWriter w w add_graph ModelDict dummy_input use_strict_trace=False test_mlp_graph dummy_input = torch zeros This MLP above input expected fail JIT optimizations seen https github com pytorch pytorch issues However should raise error during add_graph call still continue myMLP torch nn Module __init__ - None super __init__ input_len = fc = torch nn Linear input_len fc = torch nn Linear fc = torch nn Linear forward x update_batch_stats=True h = torch nn functional relu fc x view - input_len h = fc h h = torch nn functional relu h h = fc h h createSummaryWriter w w add_graph myMLP dummy_input test_wrong_input_size assertRaises RuntimeError dummy_input = torch rand model = torch nn Linear createSummaryWriter w w add_graph model dummy_input error skipIfNoTorchVision test_torchvision_smoke model_input_shapes = alexnet resnet resnet densenet vgg vgg vgg _bn vgg _bn mobilenet_v model_name input_shape model_input_shapes items createSummaryWriter w model = getattr torchvision models model_name w add_graph model torch zeros input_shape TestTensorBoardFigure BaseTestCase skipIfNoMatplotlib test_figure writer = createSummaryWriter figure axes = plt figure plt gca circle = plt Circle color= r circle = plt Circle color= g axes add_patch circle axes add_patch circle plt axis scaled plt tight_layout writer add_figure add_figure figure figure close=False assertTrue plt fignum_exists figure number writer add_figure add_figure figure figure matplotlib __version__ = assertFalse plt fignum_exists figure number print Skipping fignum_exists see https github com matplotlib matplotlib issues writer close skipIfNoMatplotlib test_figure_list writer = createSummaryWriter figures = i range figure = plt figure plt plot i i i label= Plot + str i plt xlabel X plt xlabel Y plt legend plt tight_layout figures append figure writer add_figure add_figure figure_list figures close=False assertTrue all plt fignum_exists figure number True figure figures noqa F writer add_figure add_figure figure_list figures matplotlib __version__ = assertTrue all plt fignum_exists figure number False figure figures noqa F print Skipping fignum_exists see https github com matplotlib matplotlib issues writer close TestTensorBoardNumpy BaseTestCase test_scalar res = make_np assertIsInstance res np ndarray assertEqual res shape res = make_np - uint _max assertIsInstance res np ndarray assertEqual res shape res = make_np np float assertIsInstance res np ndarray assertEqual res shape IS_MACOS IS_WINDOWS res = make_np np float + assertIsInstance res np ndarray assertEqual res shape res = make_np np int assertIsInstance res np ndarray assertEqual res shape test_pytorch_np_expect_fail assertRaises NotImplementedError make_np pytorch TestTensorProtoSummary BaseTestCase parametrize tensor_type proto_type torch float DataType DT_HALF torch bfloat DataType DT_BFLOAT skipIfTorchDynamo Unsuitable test Dynamo behavior changes version test_half_tensor_proto tensor_type proto_type float_values = actual_proto = tensor_proto dummy torch tensor float_values dtype=tensor_type value tensor assertSequenceEqual int_to_half x x actual_proto half_val float_values assertTrue actual_proto dtype == proto_type test_float_tensor_proto float_values = actual_proto = tensor_proto dummy torch tensor float_values value tensor assertEqual actual_proto float_val float_values assertTrue actual_proto dtype == DataType DT_FLOAT test_int_tensor_proto int_values = actual_proto = tensor_proto dummy torch tensor int_values dtype=torch int value tensor assertEqual actual_proto int_val int_values assertTrue actual_proto dtype == DataType DT_INT test_scalar_tensor_proto scalar_value = actual_proto = tensor_proto dummy torch tensor scalar_value value tensor assertAlmostEqual actual_proto float_val scalar_value test_complex_tensor_proto real = torch tensor imag = torch tensor actual_proto = tensor_proto dummy torch complex real imag value tensor assertEqual actual_proto scomplex_val test_empty_tensor_proto actual_proto = tensor_proto dummy torch empty value tensor assertEqual actual_proto float_val instantiate_parametrized_tests TestTensorProtoSummary __name__ == __main__ run_tests
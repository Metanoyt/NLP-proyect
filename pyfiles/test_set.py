======= BEGIN Dynamo patch ======= Owner s module dynamo ruff noqa flake noqa Test copied https raw githubusercontent com python cpython refs tags v Lib test test_set py sys torch torch _dynamo test_case unittest torch _dynamo test_case CPythonTestCase torch testing _internal common_utils run_tests __TestCase = CPythonTestCase redirect statements sys importlib abc redirect_imports = test mapping_tests test typinganndata test test_grammar test test_math test test_iter test typinganndata ann_module RedirectImportFinder importlib abc MetaPathFinder find_spec fullname path target=None Check problematic one fullname redirect_imports try Attempt standalone module name = fullname removeprefix test r = importlib import_module name Redirect module sys modules sys modules fullname = r Return module spec found module importlib util find_spec name except ImportError None None Add custom finder sys meta_path sys meta_path insert RedirectImportFinder ======= END DYNAMO PATCH ======= unittest test support test support warnings_helper gc weakref operator copy pickle random randrange shuffle warnings collections collections abc itertools PassThru Exception pass check_pass_thru raise PassThru yield BadCmp __hash__ __eq__ other raise RuntimeError ReprWrapper Used test self-referential repr calls __repr__ repr value HashCountingInt int int-like object counts number times __hash__ called __init__ args hash_count = __hash__ hash_count += int __hash__ _TestJointOps Tests common both set frozenset setUp word = word = simsalabim otherword = madagascar letters = abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ s = thetype word d = dict fromkeys word super setUp test_new_or_init assertRaises TypeError thetype assertRaises TypeError set __init__ a= test_uniquification actual = sorted s expected = sorted d assertEqual actual expected assertRaises PassThru thetype check_pass_thru assertRaises TypeError thetype test_len assertEqual len s len d test_contains c letters assertEqual c s c d assertRaises TypeError s __contains__ s = thetype frozenset letters assertIn thetype letters s test_union u = s union otherword c letters assertEqual c u c d c otherword assertEqual s thetype word assertEqual type u basetype assertRaises PassThru s union check_pass_thru assertRaises TypeError s union C set frozenset dict fromkeys str list tuple assertEqual thetype abcba union C cdc set abcd assertEqual thetype abcba union C efgfe set abcefg assertEqual thetype abcba union C ccb set abc assertEqual thetype abcba union C ef set abcef assertEqual thetype abcba union C ef C fg set abcefg Issue x = thetype assertEqual x union set x set thetype test_or i = s union otherword assertEqual s &#124; set otherword i assertEqual s &#124; frozenset otherword i try s &#124; otherword except TypeError pass fail s &#124; t did screen-out general iterables test_intersection i = s intersection otherword c letters assertEqual c i c d c otherword assertEqual s thetype word assertEqual type i basetype assertRaises PassThru s intersection check_pass_thru C set frozenset dict fromkeys str list tuple assertEqual thetype abcba intersection C cdc set cc assertEqual thetype abcba intersection C efgfe set assertEqual thetype abcba intersection C ccb set bc assertEqual thetype abcba intersection C ef set assertEqual thetype abcba intersection C cbcf C bag set b s = thetype abcba z = s intersection thetype == frozenset assertEqual id s id z assertNotEqual id s id z test_isdisjoint f s s Pure python equivalent isdisjoint set s intersection s larg ab abc ababac cdc cc efgfe ccb ef s = thetype larg rarg ab abc ababac cdc cc efgfe ccb ef C set frozenset dict fromkeys str list tuple s = C rarg actual = s isdisjoint s expected = f s s assertEqual actual expected assertTrue actual True actual False test_and i = s intersection otherword assertEqual s set otherword i assertEqual s frozenset otherword i try s otherword except TypeError pass fail s t did screen-out general iterables test_difference i = s difference otherword c letters assertEqual c i c d c otherword assertEqual s thetype word assertEqual type i basetype assertRaises PassThru s difference check_pass_thru assertRaises TypeError s difference C set frozenset dict fromkeys str list tuple assertEqual thetype abcba difference C cdc set ab assertEqual thetype abcba difference C efgfe set abc assertEqual thetype abcba difference C ccb set assertEqual thetype abcba difference C ef set abc assertEqual thetype abcba difference set abc assertEqual thetype abcba difference C C b set c test_sub i = s difference otherword assertEqual s - set otherword i assertEqual s - frozenset otherword i try s - otherword except TypeError pass fail s-t did screen-out general iterables test_symmetric_difference i = s symmetric_difference otherword c letters assertEqual c i c d ^ c otherword assertEqual s thetype word assertEqual type i basetype assertRaises PassThru s symmetric_difference check_pass_thru assertRaises TypeError s symmetric_difference C set frozenset dict fromkeys str list tuple assertEqual thetype abcba symmetric_difference C cdc set abd assertEqual thetype abcba symmetric_difference C efgfe set abcefg assertEqual thetype abcba symmetric_difference C ccb set assertEqual thetype abcba symmetric_difference C ef set abcef test_xor i = s symmetric_difference otherword assertEqual s ^ set otherword i assertEqual s ^ frozenset otherword i try s ^ otherword except TypeError pass fail s^t did screen-out general iterables test_equality assertEqual s set word assertEqual s frozenset word assertEqual s == word False assertNotEqual s set otherword assertNotEqual s frozenset otherword assertEqual s = word True test_setOfFrozensets t = map frozenset abcdef bcd bdcb fed fedccba s = thetype t assertEqual len s test_sub_and_super p q r = map thetype ab abcde assertTrue p q assertTrue p = q assertTrue q = q assertTrue q p assertTrue q = p assertFalse q r assertFalse q = r assertFalse q r assertFalse q = r assertTrue set issubset abc assertTrue set abc issuperset assertFalse set issubset cbs assertFalse set cbs issuperset test_pickling i range pickle HIGHEST_PROTOCOL + type s set frozenset s x = x s z = z p = pickle dumps s i dup = pickle loads p assertEqual s dup s = s s dup type s set frozenset assertEqual s x dup x assertEqual s z dup z assertFalse hasattr s y del s x s z test_iterator_pickling proto range pickle HIGHEST_PROTOCOL + itorg = iter s data = thetype s d = pickle dumps itorg proto = pickle loads d Set iterators unpickle list iterators due undefined order set items assertEqual type itorg type assertIsInstance collections abc Iterator assertEqual thetype data = pickle loads d try drop = next except StopIteration continue d = pickle dumps proto = pickle loads d assertEqual thetype data - thetype drop test_deepcopy torch _dynamo error_on_graph_break False Tracer __init__ value value = value __hash__ value __deepcopy__ memo=None Tracer value + t = Tracer s = thetype t dup = copy deepcopy s assertNotEqual id s id dup elem dup newt = elem assertNotEqual id t id newt assertEqual t value + newt value test_gc Create nest cycles exercise overall ref count check torch _dynamo error_on_graph_break False A pass s = set A i range elem s elem cycle = s elem sub = elem elem set = set elem test_subclass_with_custom_hash Bug torch _dynamo error_on_graph_break False H thetype __hash__ int id x fffffff s=H f=set f add s assertIn s f f remove s f add s f discard s test_badcmp s = thetype BadCmp Detect comparison errors during insertion lookup assertRaises RuntimeError thetype BadCmp BadCmp assertRaises RuntimeError s __contains__ BadCmp Detect errors during mutating operations hasattr s add assertRaises RuntimeError s add BadCmp assertRaises RuntimeError s discard BadCmp assertRaises RuntimeError s remove BadCmp test_cyclical_repr w = ReprWrapper s = thetype w w value = s thetype == set assertEqual repr s set name = repr s partition strip name assertEqual repr s s s name name test_do_not_rehash_dict_keys n = d = dict fromkeys map HashCountingInt range n assertEqual sum elem hash_count elem d n s = thetype d assertEqual sum elem hash_count elem d n s difference d assertEqual sum elem hash_count elem d n hasattr s symmetric_difference_update s symmetric_difference_update d assertEqual sum elem hash_count elem d n d = dict fromkeys set d assertEqual sum elem hash_count elem d n d = dict fromkeys frozenset d assertEqual sum elem hash_count elem d n d = dict fromkeys frozenset d assertEqual sum elem hash_count elem d n assertEqual d dict fromkeys d test_container_iterator Bug tp_traverse implemented set iterator object torch _dynamo error_on_graph_break False C object pass obj = C ref = weakref ref obj container = set obj obj x = iter container del obj container gc collect assertTrue ref None Cycle collected test_free_after_iterating support check_free_after_iterating iter thetype TestSet _TestJointOps __TestCase thetype = set basetype = set test_init s = thetype s __init__ word assertEqual s set word s __init__ otherword assertEqual s set otherword assertRaises TypeError s __init__ s assertRaises TypeError s __init__ test_constructor_identity s = thetype range t = thetype s assertNotEqual id s id t test_set_literal s = set t = assertEqual s t test_set_literal_insertion_order SF Issue -- Expect left right insertion s = True assertEqual len s stored_value = s pop assertEqual type stored_value int test_set_literal_evaluation_order Expect left right expression evaluation events = record obj events append obj s = record record record assertEqual events test_hash assertRaises TypeError hash s test_clear s clear assertEqual s set assertEqual len s test_copy dup = s copy assertEqual s dup assertNotEqual id s id dup assertEqual type dup basetype test_add s add Q assertIn Q s dup = s copy s add Q assertEqual s dup assertRaises TypeError s add test_remove s remove assertNotIn s assertRaises KeyError s remove Q assertRaises TypeError s remove s = thetype frozenset word assertIn thetype word s s remove thetype word assertNotIn thetype word s assertRaises KeyError s remove thetype word test_remove_keyerror_unpacking https bugs python org issue v Q try s remove v except KeyError e v = e args assertEqual v v fail test_remove_keyerror_set key = thetype try s remove key except KeyError e assertTrue e args key KeyError should format key e args fail test_discard s discard assertNotIn s s discard Q assertRaises TypeError s discard s = thetype frozenset word assertIn thetype word s s discard thetype word assertNotIn thetype word s s discard thetype word test_pop i range len s elem = s pop assertNotIn elem s assertRaises KeyError s pop test_update retval = s update otherword assertEqual retval None c word + otherword assertIn c s assertRaises PassThru s update check_pass_thru assertRaises TypeError s update p q cdc abcd efgfe abcefg ccb abc ef abcef C set frozenset dict fromkeys str list tuple s = thetype abcba assertEqual s update C p None assertEqual s set q p cdc efgfe ccb ef abcda q = ahi C set frozenset dict fromkeys str list tuple s = thetype abcba assertEqual s update C p C q None assertEqual s set s &#124; set p &#124; set q test_ior s &#124; = set otherword c word + otherword assertIn c s test_intersection_update retval = s intersection_update otherword assertEqual retval None c word + otherword c otherword c word assertIn c s assertNotIn c s assertRaises PassThru s intersection_update check_pass_thru assertRaises TypeError s intersection_update p q cdc c efgfe ccb bc ef C set frozenset dict fromkeys str list tuple s = thetype abcba assertEqual s intersection_update C p None assertEqual s set q ss = abcba s = thetype ss t = cbc assertEqual s intersection_update C p C t None assertEqual s set abcba set p set t test_iand s = set otherword c word + otherword c otherword c word assertIn c s assertNotIn c s test_difference_update retval = s difference_update otherword assertEqual retval None c word + otherword c word c otherword assertIn c s assertNotIn c s assertRaises PassThru s difference_update check_pass_thru assertRaises TypeError s difference_update assertRaises TypeError s symmetric_difference_update p q cdc ab efgfe abc ccb ef abc C set frozenset dict fromkeys str list tuple s = thetype abcba assertEqual s difference_update C p None assertEqual s set q s = thetype abcdefghih s difference_update assertEqual s thetype abcdefghih s = thetype abcdefghih s difference_update C aba assertEqual s thetype cdefghih s = thetype abcdefghih s difference_update C cdc C aba assertEqual s thetype efghih test_isub s -= set otherword c word + otherword c word c otherword assertIn c s assertNotIn c s test_symmetric_difference_update retval = s symmetric_difference_update otherword assertEqual retval None c word + otherword c word ^ c otherword assertIn c s assertNotIn c s assertRaises PassThru s symmetric_difference_update check_pass_thru assertRaises TypeError s symmetric_difference_update p q cdc abd efgfe abcefg ccb ef abcef C set frozenset dict fromkeys str list tuple s = thetype abcba assertEqual s symmetric_difference_update C p None assertEqual s set q test_ixor s ^= set otherword c word + otherword c word ^ c otherword assertIn c s assertNotIn c s test_inplace_on_self t = s copy t &#124; = t assertEqual t s t = t assertEqual t s t -= t assertEqual t thetype t = s copy t ^= t assertEqual t thetype test_weakref s = thetype gallahad p = weakref proxy s assertEqual str p str s s = None support gc_collect For PyPy other GCs assertRaises ReferenceError str p test_rich_compare torch _dynamo error_on_graph_break False TestRichSetCompare __gt__ some_set gt_called = True False __lt__ some_set lt_called = True False __ge__ some_set ge_called = True False __le__ some_set le_called = True False This first tries builtin rich set comparison which doesn t know how handle custom object Upon returning NotImplemented corresponding comparison right object invoked myset = myobj = TestRichSetCompare myset myobj assertTrue myobj gt_called myobj = TestRichSetCompare myset myobj assertTrue myobj lt_called myobj = TestRichSetCompare myset = myobj assertTrue myobj ge_called myobj = TestRichSetCompare myset = myobj assertTrue myobj le_called SetSubclass set pass TestSetSubclass TestSet thetype = SetSubclass basetype = set test_keywords_in_subclass torch _dynamo error_on_graph_break False subclass set pass u = subclass assertIs type u subclass assertEqual set u assertRaises TypeError subclass sequence= torch _dynamo error_on_graph_break False subclass_with_init set __init__ arg newarg=None super __init__ arg newarg = newarg u = subclass_with_init newarg= assertIs type u subclass_with_init assertEqual set u assertEqual u newarg torch _dynamo error_on_graph_break False subclass_with_new set __new__ cls arg newarg=None = super __new__ cls arg newarg = newarg u = subclass_with_new assertIs type u subclass_with_new assertEqual set u assertIsNone u newarg disallow kwargs __new__ only https bugs python org issue #msg assertRaises TypeError subclass_with_new newarg= TestFrozenSet _TestJointOps __TestCase thetype = frozenset basetype = frozenset test_init s = thetype word s __init__ otherword assertEqual s set word test_constructor_identity s = thetype range t = thetype s assertEqual id s id t test_hash assertEqual hash thetype abcdeb hash thetype ebecda make sure all permutations give same hash value n = seq = randrange n i range n results = set i range shuffle seq results add hash thetype seq assertEqual len results test_copy dup = s copy assertEqual id s id dup test_frozen_as_dictkey seq = list range + list abcdefg + apple key = thetype seq key = thetype reversed seq assertEqual key key assertNotEqual id key id key d = d key = assertEqual d key test_hash_caching f = thetype abcdcda assertEqual hash f hash f test_hash_effectiveness n = hashvalues = set addhashvalue = hashvalues add elemmasks = i+ i i range n i range n addhashvalue hash frozenset e e m elemmasks m i assertEqual len hashvalues n zf_range n https en wikipedia org wiki Set-theoretic_definition_of_natural_numbers nums = frozenset i range n- num = frozenset nums nums append num nums n powerset s i range len s + yield map frozenset itertools combinations s i n range t = n mask = t - nums range zf_range u = len h mask h map hash powerset nums n assertGreater u t FrozenSetSubclass frozenset pass TestFrozenSetSubclass TestFrozenSet thetype = FrozenSetSubclass basetype = frozenset test_keywords_in_subclass torch _dynamo error_on_graph_break False subclass frozenset pass u = subclass assertIs type u subclass assertEqual set u assertRaises TypeError subclass sequence= torch _dynamo error_on_graph_break False subclass_with_init frozenset __init__ arg newarg=None newarg = newarg u = subclass_with_init newarg= assertIs type u subclass_with_init assertEqual set u assertEqual u newarg torch _dynamo error_on_graph_break False subclass_with_new frozenset __new__ cls arg newarg=None = super __new__ cls arg newarg = newarg u = subclass_with_new newarg= assertIs type u subclass_with_new assertEqual set u assertEqual u newarg test_constructor_identity s = thetype range t = thetype s assertNotEqual id s id t test_copy dup = s copy assertNotEqual id s id dup test_nested_empty_constructor s = thetype t = thetype s assertEqual s t test_singleton_empty_frozenset Frozenset = thetype f = frozenset F = Frozenset efs = Frozenset Frozenset Frozenset Frozenset Frozenset Frozenset Frozenset Frozenset Frozenset range Frozenset Frozenset Frozenset frozenset f F Frozenset f Frozenset F All empty frozenset subclass instances should have different ids assertEqual len set map id efs len efs SetSubclassWithSlots set __slots__ = x y __dict__ TestSetSubclassWithSlots __TestCase thetype = SetSubclassWithSlots test_pickling = _TestJointOps test_pickling setUp word = word = simsalabim otherword = madagascar letters = abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ s = thetype word d = dict fromkeys word super setUp FrozenSetSubclassWithSlots frozenset __slots__ = x y __dict__ TestFrozenSetSubclassWithSlots TestSetSubclassWithSlots thetype = FrozenSetSubclassWithSlots Tests taken test_sets py ============================================= empty_set = set #============================================================================== _TestBasicOps test_repr repr None assertEqual repr set repr check_repr_against_values text = repr set assertTrue text startswith assertTrue text endswith result = text - split result sort sorted_repr_values = repr value value values sorted_repr_values sort assertEqual result sorted_repr_values test_length assertEqual len set length test_self_equality assertEqual set set test_equivalent_equality assertEqual set dup test_copy assertEqual set copy dup test_self_union result = set &#124; set assertEqual result dup test_empty_union result = set &#124; empty_set assertEqual result dup test_union_empty result = empty_set &#124; set assertEqual result dup test_self_intersection result = set set assertEqual result dup test_empty_intersection result = set empty_set assertEqual result empty_set test_intersection_empty result = empty_set set assertEqual result empty_set test_self_isdisjoint result = set isdisjoint set assertEqual result set test_empty_isdisjoint result = set isdisjoint empty_set assertEqual result True test_isdisjoint_empty result = empty_set isdisjoint set assertEqual result True test_self_symmetric_difference result = set ^ set assertEqual result empty_set test_empty_symmetric_difference result = set ^ empty_set assertEqual result set test_self_difference result = set - set assertEqual result empty_set test_empty_difference result = set - empty_set assertEqual result dup test_empty_difference_rev result = empty_set - set assertEqual result empty_set test_iteration v set assertIn v values setiter = iter set assertEqual setiter __length_hint__ len set test_pickling proto range pickle HIGHEST_PROTOCOL + p = pickle dumps set proto copy = pickle loads p assertEqual set copy s = s set copy test_issue_ assertRaises TypeError set difference assertRaises TypeError set difference_update ------------------------------------------------------------------------------ TestBasicOpsEmpty _TestBasicOps __TestCase setUp case = empty set values = set = set values dup = set values length = repr = set super setUp ------------------------------------------------------------------------------ TestBasicOpsSingleton _TestBasicOps __TestCase setUp case = unit set number values = set = set values dup = set values length = repr = super setUp test_in assertIn set test_not_in assertNotIn set ------------------------------------------------------------------------------ TestBasicOpsTuple _TestBasicOps __TestCase setUp case = unit set tuple values = zero set = set values dup = set values length = repr = zero super setUp test_in assertIn zero set test_not_in assertNotIn set ------------------------------------------------------------------------------ TestBasicOpsTriple _TestBasicOps __TestCase setUp case = triple set values = zero operator add set = set values dup = set values length = repr = None super setUp ------------------------------------------------------------------------------ TestBasicOpsString _TestBasicOps __TestCase setUp case = string set values = b c set = set values dup = set values length = super setUp test_repr check_repr_against_values ------------------------------------------------------------------------------ TestBasicOpsBytes _TestBasicOps __TestCase setUp case = bytes set values = b b b b c set = set values dup = set values length = super setUp test_repr check_repr_against_values ------------------------------------------------------------------------------ TestBasicOpsMixedStringBytes _TestBasicOps __TestCase setUp enterContext warnings_helper check_warnings warnings simplefilter ignore BytesWarning case = string bytes set values = b b b b set = set values dup = set values length = super setUp test_repr check_repr_against_values #============================================================================== baditer raise TypeError yield True gooditer yield True TestExceptionPropagation __TestCase SF Set constructor should trap iterator TypeErrors test_instanceWithException assertRaises TypeError set baditer test_instancesWithoutException All these iterables should load without exception set set set one two three set range set abc set gooditer test_changingSizeWhileIterating s = set try i s s update except RuntimeError pass fail no exception when changing size during iteration #============================================================================== TestSetOfSets __TestCase test_constructor inner = frozenset outer = set inner element = outer pop assertEqual type element frozenset outer add inner Rebuild set sets add method outer remove inner assertEqual outer set Verify remove worked outer discard inner Absence KeyError indicates working fine #============================================================================== TestBinaryOps __TestCase setUp set = set super setUp test_eq SF bug assertEqual set set test_union_subset result = set &#124; set assertEqual result set test_union_superset result = set &#124; set assertEqual result set test_union_overlap result = set &#124; set assertEqual result set test_union_non_overlap result = set &#124; set assertEqual result set test_intersection_subset result = set set assertEqual result set test_intersection_superset result = set set assertEqual result set test_intersection_overlap result = set set assertEqual result set test_intersection_non_overlap result = set set assertEqual result empty_set test_isdisjoint_subset result = set isdisjoint set assertEqual result False test_isdisjoint_superset result = set isdisjoint set assertEqual result False test_isdisjoint_overlap result = set isdisjoint set assertEqual result False test_isdisjoint_non_overlap result = set isdisjoint set assertEqual result True test_sym_difference_subset result = set ^ set assertEqual result set test_sym_difference_superset result = set ^ set assertEqual result set test_sym_difference_overlap result = set ^ set assertEqual result set test_sym_difference_non_overlap result = set ^ set assertEqual result set #============================================================================== TestUpdateOps __TestCase setUp set = set super setUp test_union_subset set &#124; = set assertEqual set set test_union_superset set &#124; = set assertEqual set set test_union_overlap set &#124; = set assertEqual set set test_union_non_overlap set &#124; = set assertEqual set set test_union_method_call set update set assertEqual set set test_intersection_subset set = set assertEqual set set test_intersection_superset set = set assertEqual set set test_intersection_overlap set = set assertEqual set set test_intersection_non_overlap set = set assertEqual set empty_set test_intersection_method_call set intersection_update set assertEqual set set test_sym_difference_subset set ^= set assertEqual set set test_sym_difference_superset set ^= set assertEqual set set test_sym_difference_overlap set ^= set assertEqual set set test_sym_difference_non_overlap set ^= set assertEqual set set test_sym_difference_method_call set symmetric_difference_update set assertEqual set set test_difference_subset set -= set assertEqual set set test_difference_superset set -= set assertEqual set set test_difference_overlap set -= set assertEqual set set test_difference_non_overlap set -= set assertEqual set set test_difference_method_call set difference_update set assertEqual set set #============================================================================== TestMutate __TestCase setUp values = b c set = set values super setUp test_add_present set add c assertEqual set set abc test_add_absent set add d assertEqual set set abcd test_add_until_full tmp = set expected_len = v values tmp add v expected_len += assertEqual len tmp expected_len assertEqual tmp set test_remove_present set remove b assertEqual set set ac test_remove_absent try set remove d fail Removing missing element should have raised LookupError except LookupError pass test_remove_until_empty expected_len = len set v values set remove v expected_len -= assertEqual len set expected_len test_discard_present set discard c assertEqual set set ab test_discard_absent set discard d assertEqual set set abc test_clear set clear assertEqual len set test_pop popped = while set popped set pop = None assertEqual len popped len values v values assertIn v popped test_update_empty_tuple set update assertEqual set set values test_update_unit_tuple_overlap set update assertEqual set set values test_update_unit_tuple_non_overlap set update z assertEqual set set values + z #============================================================================== _TestSubsets case method = = issubset = issuperset reverse = == == = = = = = = test_issubset x = left y = right case = == = = expected = case cases Test binary infix spelling result = eval x + case + y locals assertEqual result expected Test friendly method-name spelling one exists case _TestSubsets case method method = getattr x _TestSubsets case method case result = method y assertEqual result expected Now do same operands reversed rcase = _TestSubsets reverse case result = eval y + rcase + x locals assertEqual result expected rcase _TestSubsets case method method = getattr y _TestSubsets case method rcase result = method x assertEqual result expected ------------------------------------------------------------------------------ TestSubsetEqualEmpty _TestSubsets __TestCase left = set right = set name = both empty cases = == = = ------------------------------------------------------------------------------ TestSubsetEqualNonEmpty _TestSubsets __TestCase left = set right = set name = equal pair cases = == = = ------------------------------------------------------------------------------ TestSubsetEmptyNonEmpty _TestSubsets __TestCase left = set right = set name = one empty one non-empty cases = = = ------------------------------------------------------------------------------ TestSubsetPartial _TestSubsets __TestCase left = set right = set name = one non-empty proper subset other cases = = = ------------------------------------------------------------------------------ TestSubsetNonOverlap _TestSubsets __TestCase left = set right = set name = neither empty neither contains cases = = #============================================================================== _TestOnlySetsInBinaryOps test_eq_ne Unlike others testing == = allowed assertEqual other == set False assertEqual set == other False assertEqual other = set True assertEqual set = other True test_ge_gt_le_lt assertRaises TypeError lambda set other assertRaises TypeError lambda set = other assertRaises TypeError lambda set other assertRaises TypeError lambda set = other assertRaises TypeError lambda other set assertRaises TypeError lambda other = set assertRaises TypeError lambda other set assertRaises TypeError lambda other = set test_update_operator try set &#124; = other except TypeError pass fail expected TypeError test_update otherIsIterable set update other assertRaises TypeError set update other test_union assertRaises TypeError lambda set &#124; other assertRaises TypeError lambda other &#124; set otherIsIterable set union other assertRaises TypeError set union other test_intersection_update_operator try set = other except TypeError pass fail expected TypeError test_intersection_update otherIsIterable set intersection_update other assertRaises TypeError set intersection_update other test_intersection assertRaises TypeError lambda set other assertRaises TypeError lambda other set otherIsIterable set intersection other assertRaises TypeError set intersection other test_sym_difference_update_operator try set ^= other except TypeError pass fail expected TypeError test_sym_difference_update otherIsIterable set symmetric_difference_update other assertRaises TypeError set symmetric_difference_update other test_sym_difference assertRaises TypeError lambda set ^ other assertRaises TypeError lambda other ^ set otherIsIterable set symmetric_difference other assertRaises TypeError set symmetric_difference other test_difference_update_operator try set -= other except TypeError pass fail expected TypeError test_difference_update otherIsIterable set difference_update other assertRaises TypeError set difference_update other test_difference assertRaises TypeError lambda set - other assertRaises TypeError lambda other - set otherIsIterable set difference other assertRaises TypeError set difference other ------------------------------------------------------------------------------ TestOnlySetsNumeric _TestOnlySetsInBinaryOps __TestCase setUp set = set other = otherIsIterable = False super setUp ------------------------------------------------------------------------------ TestOnlySetsDict _TestOnlySetsInBinaryOps __TestCase setUp set = set other = otherIsIterable = True super setUp ------------------------------------------------------------------------------ TestOnlySetsOperator _TestOnlySetsInBinaryOps __TestCase setUp set = set other = operator add otherIsIterable = False super setUp ------------------------------------------------------------------------------ TestOnlySetsTuple _TestOnlySetsInBinaryOps __TestCase setUp set = set other = otherIsIterable = True super setUp ------------------------------------------------------------------------------ TestOnlySetsString _TestOnlySetsInBinaryOps __TestCase setUp set = set other = abc otherIsIterable = True super setUp ------------------------------------------------------------------------------ TestOnlySetsGenerator _TestOnlySetsInBinaryOps __TestCase setUp gen i range yield i set = set other = gen otherIsIterable = True super setUp #============================================================================== _TestCopying test_copy dup = set copy dup_list = sorted dup key=repr set_list = sorted set key=repr assertEqual len dup_list len set_list i range len dup_list assertTrue dup_list i set_list i test_deep_copy dup = copy deepcopy set ##print type dup repr dup dup_list = sorted dup key=repr set_list = sorted set key=repr assertEqual len dup_list len set_list i range len dup_list assertEqual dup_list i set_list i ------------------------------------------------------------------------------ TestCopyingEmpty _TestCopying __TestCase setUp set = set super setUp ------------------------------------------------------------------------------ TestCopyingSingleton _TestCopying __TestCase setUp set = set hello super setUp ------------------------------------------------------------------------------ TestCopyingTriple _TestCopying __TestCase setUp set = set zero None super setUp ------------------------------------------------------------------------------ TestCopyingTuple _TestCopying __TestCase setUp set = set super setUp ------------------------------------------------------------------------------ TestCopyingNested _TestCopying __TestCase setUp set = set super setUp #============================================================================== TestIdentities __TestCase setUp = set abracadabra b = set alacazam super setUp test_binopsVsSubsets b = b assertTrue - b assertTrue b - b assertTrue b assertTrue b b assertTrue &#124; b assertTrue &#124; b b assertTrue ^ b &#124; b test_commutativity b = b assertEqual b b assertEqual &#124; b b &#124; assertEqual a^b b^a = b assertNotEqual a-b b-a test_summations check sums parts equal whole b = b assertEqual a-b &#124; b &#124; b-a &#124; b assertEqual b &#124; a^b &#124; b assertEqual &#124; b-a &#124; b assertEqual a-b &#124; b &#124; b assertEqual a-b &#124; b assertEqual b-a &#124; b b assertEqual a-b &#124; b-a a^b test_exclusion check inverse operations show non-overlap b zero = b set assertEqual a-b b zero assertEqual b-a zero assertEqual b a^b zero Tests derived test_itertools py ======================================= R seqn Regular generator i seqn yield i G Sequence using __getitem__ __init__ seqn seqn = seqn __getitem__ i seqn i I Sequence using iterator protocol __init__ seqn seqn = seqn i = __iter__ __next__ i = len seqn raise StopIteration v = seqn i i += v Ig Sequence using iterator protocol defined generator __init__ seqn seqn = seqn i = __iter__ val seqn yield val X Missing __getitem__ __iter__ __init__ seqn seqn = seqn i = __next__ i = len seqn raise StopIteration v = seqn i i += v N Iterator missing __next__ __init__ seqn seqn = seqn i = __iter__ E Test propagation exceptions __init__ seqn seqn = seqn i = __iter__ __next__ S Test immediate stop __init__ seqn pass __iter__ __next__ raise StopIteration itertools chain L seqn Test multiple tiers iterators chain map lambda x x R Ig G seqn TestVariousIteratorArgs __TestCase test_constructor cons set frozenset s range do range g G I Ig S L R assertEqual sorted cons g s key=repr sorted g s key=repr assertRaises TypeError cons X s assertRaises TypeError cons N s assertRaises ZeroDivisionError cons E s test_inline_methods s = set november data range do range december meth s union s intersection s difference s symmetric_difference s isdisjoint g G I Ig L R expected = meth data actual = meth g data isinstance expected bool assertEqual actual expected assertEqual sorted actual key=repr sorted expected key=repr assertRaises TypeError meth X s assertRaises TypeError meth N s assertRaises ZeroDivisionError meth E s test_inplace_methods data range do range december methname update intersection_update difference_update symmetric_difference_update g G I Ig S L R s = set january t = s copy getattr s methname list g data getattr t methname g data assertEqual sorted s key=repr sorted t key=repr assertRaises TypeError getattr set january methname X data assertRaises TypeError getattr set january methname N data assertRaises ZeroDivisionError getattr set january methname E data bad_eq __eq__ other be_bad set clear raise ZeroDivisionError other __hash__ bad_dict_clear __eq__ other be_bad dict clear other __hash__ TestWeirdBugs __TestCase test_ _set_merge This used segfault global be_bad set dict be_bad = False set = bad_eq set = bad_eq i range be_bad = True assertRaises ZeroDivisionError set update set be_bad = False set = bad_dict_clear dict = bad_dict_clear None be_bad = True set symmetric_difference_update dict test_iter_and_mutate Issue s = set range s clear s update range si = iter s s clear = list range s update range list si test_merge_and_mutate torch _dynamo error_on_graph_break False X __hash__ hash __eq__ o other clear False other = set other = X i range s = s update other _TestOperationsMutating Regression test bpo- constructor = None constructor = None make_sets_of_bad_objects torch _dynamo error_on_graph_break False Bad __eq__ other enabled False randrange == set clear randrange == set clear bool randrange __hash__ randrange Don t behave poorly during construction enabled = False set = constructor Bad _ range randrange set = constructor Bad _ range randrange Now start behaving poorly enabled = True set set check_set_op_does_not_crash function _ range set set = make_sets_of_bad_objects try function set set except RuntimeError e Just make sure we don t crash here assertIn changed size during iteration str e _TestBinaryOpsMutating _TestOperationsMutating test_eq_with_mutation check_set_op_does_not_crash lambda b == b test_ne_with_mutation check_set_op_does_not_crash lambda b = b test_lt_with_mutation check_set_op_does_not_crash lambda b b test_le_with_mutation check_set_op_does_not_crash lambda b = b test_gt_with_mutation check_set_op_does_not_crash lambda b b test_ge_with_mutation check_set_op_does_not_crash lambda b = b test_and_with_mutation check_set_op_does_not_crash lambda b b test_or_with_mutation check_set_op_does_not_crash lambda b &#124; b test_sub_with_mutation check_set_op_does_not_crash lambda b - b test_xor_with_mutation check_set_op_does_not_crash lambda b ^ b test_iadd_with_mutation f b = b check_set_op_does_not_crash f test_ior_with_mutation f b &#124; = b check_set_op_does_not_crash f test_isub_with_mutation f b -= b check_set_op_does_not_crash f test_ixor_with_mutation f b ^= b check_set_op_does_not_crash f test_iteration_with_mutation f b x pass y b pass f b y b pass x pass f b x y zip b pass check_set_op_does_not_crash f check_set_op_does_not_crash f check_set_op_does_not_crash f TestBinaryOpsMutating_Set_Set _TestBinaryOpsMutating __TestCase constructor = set constructor = set TestBinaryOpsMutating_Subclass_Subclass _TestBinaryOpsMutating __TestCase constructor = SetSubclass constructor = SetSubclass TestBinaryOpsMutating_Set_Subclass _TestBinaryOpsMutating __TestCase constructor = set constructor = SetSubclass TestBinaryOpsMutating_Subclass_Set _TestBinaryOpsMutating __TestCase constructor = SetSubclass constructor = set _TestMethodsMutating _TestOperationsMutating test_issubset_with_mutation check_set_op_does_not_crash set issubset test_issuperset_with_mutation check_set_op_does_not_crash set issuperset test_intersection_with_mutation check_set_op_does_not_crash set intersection test_union_with_mutation check_set_op_does_not_crash set union test_difference_with_mutation check_set_op_does_not_crash set difference test_symmetric_difference_with_mutation check_set_op_does_not_crash set symmetric_difference test_isdisjoint_with_mutation check_set_op_does_not_crash set isdisjoint test_difference_update_with_mutation check_set_op_does_not_crash set difference_update test_intersection_update_with_mutation check_set_op_does_not_crash set intersection_update test_symmetric_difference_update_with_mutation check_set_op_does_not_crash set symmetric_difference_update test_update_with_mutation check_set_op_does_not_crash set update TestMethodsMutating_Set_Set _TestMethodsMutating __TestCase constructor = set constructor = set TestMethodsMutating_Subclass_Subclass _TestMethodsMutating __TestCase constructor = SetSubclass constructor = SetSubclass TestMethodsMutating_Set_Subclass _TestMethodsMutating __TestCase constructor = set constructor = SetSubclass TestMethodsMutating_Subclass_Set _TestMethodsMutating __TestCase constructor = SetSubclass constructor = set TestMethodsMutating_Set_Dict _TestMethodsMutating __TestCase constructor = set constructor = dict fromkeys TestMethodsMutating_Set_List _TestMethodsMutating __TestCase constructor = set constructor = list Application tests based David Eppstein s graph recipes ==================================== powerset U Generates all subsets set sequence U U = iter U try x = frozenset next U S powerset U yield S yield S &#124; x except StopIteration yield frozenset cube n Graph n-dimensional hypercube singletons = frozenset x x range n dict x frozenset x^s s singletons x powerset range n linegraph G Graph vertices which edges G two vertices being adjacent iff corresponding edges share vertex L = x G y G x nx = frozenset x z z G x z = y ny = frozenset y z z G y z = x L frozenset x y = frozenset nx+ny L faces G Return set faces G Where face set vertices face currently limited triangles squares pentagons f = set v edges G items v edges v G v v == v continue v G v f add frozenset v v v v G v v == v continue v G v f add frozenset v v v v v G v v == v v == v continue v G v f add frozenset v v v v v f TestGraphs __TestCase test_cube g = cube vert -- v v v vertices = set g assertEqual len vertices eight vertices edge g values assertEqual len edge each vertex connects three edges vertices = set v edges g values v edges assertEqual vertices vertices edge vertices original set cubefaces = faces g assertEqual len cubefaces six faces face cubefaces assertEqual len face each face square test_cuboctahedron http en wikipedia org wiki Cuboctahedron triangular faces square faces identical vertices each connecting triangle square g = cube cuboctahedron = linegraph g V -- V V V V assertEqual len cuboctahedron twelve vertices vertices = set cuboctahedron edges cuboctahedron values assertEqual len edges each vertex connects four other vertices othervertices = set edge edges cuboctahedron values edge edges assertEqual vertices othervertices edge vertices original set cubofaces = faces cuboctahedron facesizes = collections defaultdict int face cubofaces facesizes len face += assertEqual facesizes eight triangular faces assertEqual facesizes six square faces vertex cuboctahedron edge = vertex Cuboctahedron vertices edges Cube assertEqual len edge Two cube vertices define edge cubevert edge assertIn cubevert g #============================================================================== __name__ == __main__ run_tests
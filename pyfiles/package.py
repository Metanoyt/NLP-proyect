io json logging os tempfile typing IO torch torch _inductor config torch _inductor cpp_builder BuildOptionsBase CppBuilder torch export pt _archive _package AOTI_FILES AOTICompiledModel load_pt package_pt torch types FileLike log = logging getLogger __name__ compile_so aoti_dir str aoti_files list str so_path str - str get_aoti_file_with_suffix suffix str - str file aoti_files file endswith suffix file raise RuntimeError f Unable find file suffix suffix Compile all files into so cpp_file = os path join aoti_dir get_aoti_file_with_suffix cpp consts_o = os path join aoti_dir get_aoti_file_with_suffix o file_name = os path splitext cpp_file Parse compile flags build o file open file_name + _compile_flags json f compile_flags = json load f compile_options = BuildOptionsBase compile_flags use_relative_path=config is_fbcode object_builder = CppBuilder name=file_name sources=cpp_file BuildOption=compile_options output_o = object_builder get_target_file_path object_builder build Parse linker flags build so file open file_name + _linker_flags json f linker_flags = json load f linker_options = BuildOptionsBase linker_flags use_relative_path=config is_fbcode so_builder = CppBuilder name=os path split so_path - sources= output_o consts_o BuildOption=linker_options output_dir=so_path output_so = so_builder get_target_file_path so_builder build mmapped weights serialized_weights_filename = file_name + _serialized_weights bin serialized_weights_filename aoti_files open serialized_weights_filename rb f_weights serialized_weights = f_weights read open output_so a+b f_so so_size = f_so tell Page align weights f_so write b - so_size f_so write serialized_weights output_so package_aoti archive_file FileLike aoti_files AOTI_FILES - FileLike Saves AOTInductor generated files PT Archive format Args archive_file The file name save package aoti_files This can either singular path directory containing AOTInductor files dictionary mapping model name path its AOTInductor generated files package_pt archive_file aoti_files=aoti_files load_package path FileLike model_name str = model run_single_threaded bool = False num_runners int = device_index int = - - AOTICompiledModel try pt _contents = load_pt path run_single_threaded=run_single_threaded num_runners=num_runners device_index=device_index model_name pt _contents aoti_runners raise RuntimeError f Model model_name found package pt _contents aoti_runners model_name except RuntimeError log warning Loading outdated pt file Please regenerate your package isinstance path io IOBase IO tempfile NamedTemporaryFile suffix= pt f TODO angelayi We shouldn t need do -- miniz should handle reading buffer This just temporary workaround path seek f write path read log debug Writing buffer tmp file located s f name loader = torch _C _aoti AOTIModelPackageLoader f name model_name run_single_threaded num_runners device_index AOTICompiledModel loader path = os fspath path AOTIModelPackageLoader expects str str loader = torch _C _aoti AOTIModelPackageLoader path model_name run_single_threaded num_runners device_index AOTICompiledModel loader
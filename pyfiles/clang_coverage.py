__future__ annotations os subprocess time util setting JSON_FOLDER_BASE_DIR MERGED_FOLDER_BASE_DIR TestList TestPlatform TestType util utils check_platform_type convert_to_relative_path create_folder get_raw_profiles_folder get_test_name_from_whole_path print_log print_time related_to_test_list replace_extension utils get_tool_path_by_platform run_cpp_test create_corresponding_folder cur_path str prefix_cur_path str dir_list list str new_base_folder str - None dir_name dir_list relative_path = convert_to_relative_path cur_path prefix_cur_path get folder name like aten new_folder_path = os path join new_base_folder relative_path dir_name create_folder new_folder_path run_target binary_file str raw_file str test_type TestType platform_type TestPlatform - None print_log start run binary_file set environment variable -- raw profile output path binary run os environ LLVM_PROFILE_FILE = raw_file run binary test_type == TestType PY platform_type == TestPlatform OSS oss utils run_oss_python_test run_oss_python_test binary_file run_cpp_test binary_file merge_target raw_file str merged_file str platform_type TestPlatform - None print_log start merge target raw_file run command llvm_tool_path = get_tool_path_by_platform platform_type subprocess check_call f llvm_tool_path llvm-profdata merge -sparse raw_file -o merged_file export_target merged_file str json_file str binary_file str shared_library_list list str platform_type TestPlatform - None binary_file None raise Exception noqa TRY f merged_file doesn t have corresponding binary noqa TRY print_log start export merged_file run export cmd_shared_library = shared_library_list f -object -object join shared_library_list binary_file = then no need add python test cmd_binary = binary_file f -object binary_file llvm_tool_path = get_tool_path_by_platform platform_type cmd = f llvm_tool_path llvm-cov export cmd_binary cmd_shared_library -instr-profile= merged_file json_file os system cmd merge test_list TestList platform_type TestPlatform - None print start merge start_time = time time find all raw profile under raw_folder sub-folders raw_folder_path = get_raw_profiles_folder g = os walk raw_folder_path path dir_list file_list g there folder raw aten create corresponding merged folder profile merged aten exists yet create_corresponding_folder path raw_folder_path dir_list MERGED_FOLDER_BASE_DIR check we can find raw profile under path s folder file_name file_list file_name endswith profraw related_to_test_list file_name test_list continue print f start merge file_name raw_file = os path join path file_name merged_file_name = replace_extension file_name merged merged_file = os path join MERGED_FOLDER_BASE_DIR convert_to_relative_path path raw_folder_path merged_file_name merge_target raw_file merged_file platform_type print_time merge take time start_time summary_time=True export test_list TestList platform_type TestPlatform - None print start export start_time = time time find all merged profile under merged_folder sub-folders g = os walk MERGED_FOLDER_BASE_DIR path dir_list file_list g create corresponding merged folder json folder exists yet create_corresponding_folder path MERGED_FOLDER_BASE_DIR dir_list JSON_FOLDER_BASE_DIR check we can find merged profile under path s folder file_name file_list file_name endswith merged related_to_test_list file_name test_list continue print f start export file_name merged file merged_file = os path join path file_name json file json_file_name = replace_extension file_name json json_file = os path join JSON_FOLDER_BASE_DIR convert_to_relative_path path MERGED_FOLDER_BASE_DIR json_file_name check_platform_type platform_type binary file shared library binary_file = shared_library_list = platform_type == TestPlatform FBCODE caffe fb code_coverage tool package fbcode utils type ignore get_fbcode_binary_folder binary_file = os path join get_fbcode_binary_folder path get_test_name_from_whole_path merged_file platform_type == TestPlatform OSS oss utils get_oss_binary_file get_oss_shared_library test_name = get_test_name_from_whole_path merged_file python test no need provide binary shared library enough binary_file = test_name endswith py get_oss_binary_file test_name TestType CPP shared_library_list = get_oss_shared_library export_target merged_file json_file binary_file shared_library_list platform_type print_time export take time start_time summary_time=True
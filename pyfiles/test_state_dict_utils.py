Owner s oncall distributed copy io torch torch distributed dist torch distributed _functional_collectives funcol torch distributed _shard sharded_tensor init_from_local_shards Shard ShardedTensorShard ShardedTensor ShardMetadata torch distributed _state_dict_utils _check_state_dict_similarity _copy_state_dict _create_cpu_state_dict _distribute_tensors _gather_state_dict _offload_state_dict_to_cpu torch distributed device_mesh init_device_mesh torch distributed tensor distribute_tensor DTensor Shard torch testing _internal common_utils run_tests torch testing _internal distributed _tensor common_dtensor DTensorTestBase skip_if_lt_x_gpu with_comms TestStateDictUtils DTensorTestBase property world_size min torch cuda device_count with_comms skip_if_lt_x_gpu test_gather_state_dict_dtensor device_mesh = build_device_mesh shard_spec = Shard torch random manual_seed dist get_rank local_tensor = torch randn dist_tensor = DTensor from_local local_tensor device_mesh shard_spec state_dict = dtensor dist_tensor gathered_state_dict = _gather_state_dict state_dict expected_gathered_dtensor = funcol all_gather_tensor dist_tensor to_local gather_dim= group= device_mesh assertEqual expected_gathered_dtensor gathered_state_dict dtensor assertTrue gathered_state_dict dtensor is_cuda with_comms skip_if_lt_x_gpu test_gather_with_cpu_and_ranks_only device_mesh = build_device_mesh shard_spec = Shard torch random manual_seed dist get_rank local_tensor = torch randn dist_tensor = DTensor from_local local_tensor device_mesh shard_spec state_dict = dtensor dist_tensor gathered_state_dict = _gather_state_dict state_dict cpu_offload=True ranks_only= expected_gathered_dtensor = funcol all_gather_tensor dist_tensor to_local gather_dim= group= device_mesh dist get_rank assertEqual expected_gathered_dtensor gathered_state_dict dtensor assertFalse gathered_state_dict dtensor is_cuda assertEqual gathered_state_dict with_comms skip_if_lt_x_gpu test_cpu_and_ranks_only device = torch device cuda state_dict = tensor torch arange device=device tensor torch ones device=device cpu_state_dict = _offload_state_dict_to_cpu state_dict ranks_only= dist get_rank v cpu_state_dict values assertFalse v is_cuda assertEqual cpu_state_dict tensor torch arange assertEqual cpu_state_dict tensor torch ones assertEqual cpu_state_dict with_comms skip_if_lt_x_gpu test_complicated_dict create_dtensor device_mesh = build_device_mesh shard_spec = Shard torch random manual_seed dist get_rank local_tensor = torch randn dist_tensor = DTensor from_local local_tensor device_mesh shard_spec tensor = funcol all_gather_tensor dist_tensor to_local gather_dim= group= device_mesh tensor dist_tensor ltensor ldtensor = _ range tensor dtensor = create_dtensor ltensor append tensor ltensor append torch ones device=torch device cuda ldtensor append dtensor ldtensor append torch ones device=torch device cuda tensor dtensor = create_dtensor dist_state_dict = local dtensor list ldtensor arange torch arange device=torch device cuda state_dict = local tensor list ltensor arange torch arange device=torch device cuda assertEqual state_dict _gather_state_dict dist_state_dict with_comms skip_if_lt_x_gpu test_create_cpu_state_dict device = torch device cuda rank = dist get_rank Scale tensors based world size fit tensor shards accurately scale_factor = world_size buffer = io BytesIO torch save torch ones buffer buffer seek state_dict = tensor torch arange device=device tensor torch ones device=device sharded_tensor init_from_local_shards ShardedTensorShard tensor=torch arange rank + rank device=device reshape metadata=ShardMetadata shard_offsets= rank shard_sizes= placement=f rank rank cuda rank torch Size scale_factor dtensor distribute_tensor torch arange scale_factor device=device reshape scale_factor init_device_mesh cuda mesh_shape= world_size Shard non_tensor_bytes_io copy deepcopy buffer non_tensor_bytes buffer read step torch tensor dtype=torch float lr nested list _verify cpu_state_dict Verify correctness _check_state_dict_similarity assertTrue _check_state_dict_similarity state_dict cpu_state_dict tensor = cpu_state_dict tensor cpu_state_dict tensor = torch arange assertFalse _check_state_dict_similarity state_dict cpu_state_dict cpu_state_dict tensor = tensor _copy_state_dict state_dict cpu_state_dict Verify _copy_state_dict works v cpu_state_dict values isinstance v torch Tensor DTensor ShardedTensor assertTrue v device == torch device cpu assertEqual cpu_state_dict tensor torch arange assertEqual cpu_state_dict tensor torch ones assertEqual cpu_state_dict sharded_tensor local_tensor torch arange rank + rank reshape assertEqual cpu_state_dict dtensor to_local torch arange rank + rank reshape assertNotEqual cpu_state_dict tensor storage data_ptr state_dict tensor storage data_ptr assertNotEqual cpu_state_dict tensor storage data_ptr state_dict tensor storage data_ptr assertNotEqual cpu_state_dict sharded_tensor local_tensor storage data_ptr state_dict sharded_tensor local_tensor storage data_ptr assertNotEqual cpu_state_dict dtensor to_local storage data_ptr state_dict dtensor to_local storage data_ptr buffer seek cpu_state_dict non_tensor_bytes_io seek assertEqual cpu_state_dict non_tensor_bytes_io read buffer read buffer seek assertEqual cpu_state_dict non_tensor_bytes buffer read assertEqual cpu_state_dict lr assertEqual cpu_state_dict step assertEqual cpu_state_dict nested list _verify_weakref_finalize cpu_state_dict gc del cpu_state_dict tensor del cpu_state_dict gc collect cpu_state_dict = _create_cpu_state_dict state_dict _verify cpu_state_dict cpu_state_dict = _create_cpu_state_dict state_dict pin_memory=True _verify cpu_state_dict cpu_state_dict = _create_cpu_state_dict state_dict share_memory=True _verify cpu_state_dict cpu_state_dict = _create_cpu_state_dict state_dict share_memory=True pin_memory=True _verify cpu_state_dict _verify_weakref_finalize cpu_state_dict with_comms skip_if_lt_x_gpu test_state_dict_util_distribute_tensors even_tensor = torch randn world_size uneven_tensor = torch randn mesh = init_device_mesh cuda mesh_shape= world_size even_dtensor = distribute_tensor torch randn world_size mesh Shard uneven_dtensor = distribute_tensor torch randn mesh Shard dtensor tensor different before _distribute_tensors called local_state_dict = even even_dtensor even_tensor uneven uneven_dtensor uneven_tensor ref_local_state_dict = copy deepcopy local_state_dict keys = even uneven _distribute_tensors local_state_dict keys device_type local_v ref_v zip local_state_dict values ref_local_state_dict values assertEqual local_v size ref_v size assertEqual local_v stride ref_v stride assertNotEqual local_v_full_tensor = local_v full_tensor ref_v full_tensor assertEqual local_v_full_tensor ref_v with_comms skip_if_lt_x_gpu test_cpu_offload_for_dtensor device_mesh = init_device_mesh cuda mesh_shape= world_size sd = k DTensor from_local torch ones device= cuda device_mesh Shard cpu_sd = _create_cpu_state_dict sd assertTrue isinstance cpu_sd k DTensor assertTrue isinstance sd k DTensor assertTrue cpu_sd k is_cpu assertTrue cpu_sd k _local_tensor is_cpu assertFalse sd k is_cpu assertFalse sd k _local_tensor is_cpu assertFalse torch equal sd k cpu cpu_sd k _copy_state_dict sd cpu_sd non_blocking=True torch cuda synchronize assertTrue torch equal sd k cpu cpu_sd k sd k += assertFalse torch equal sd k cpu cpu_sd k _copy_state_dict sd cpu_sd non_blocking=True torch cuda synchronize assertTrue torch equal sd k cpu cpu_sd k __name__ == __main__ run_tests
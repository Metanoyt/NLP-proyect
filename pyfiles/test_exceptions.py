======= BEGIN Dynamo patch ======= Owner s module dynamo ruff noqa flake noqa Test copied https raw githubusercontent com python cpython refs tags v Lib test test_exceptions py sys torch torch _dynamo test_case unittest torch _dynamo test_case CPythonTestCase torch testing _internal common_utils run_tests xfailIfTorchDynamo __TestCase = CPythonTestCase redirect statements sys importlib abc redirect_imports = test mapping_tests test typinganndata test test_grammar test test_math test test_iter test typinganndata ann_module RedirectImportFinder importlib abc MetaPathFinder find_spec fullname path target=None Check problematic one fullname redirect_imports try Attempt standalone module name = fullname removeprefix test r = importlib import_module name Redirect module sys modules sys modules fullname = r Return module spec found module importlib util find_spec name except ImportError None None Add custom finder sys meta_path sys meta_path insert RedirectImportFinder ======= END DYNAMO PATCH ======= Python test set -- part built-in exceptions copy os sys unittest pickle weakref errno codecs BOM_UTF itertools product textwrap dedent test support captured_stderr check_impl_detail cpython_only gc_collect no_tracing script_helper SuppressCrashReport force_not_colorized test support import_helper import_module test support os_helper TESTFN unlink test support warnings_helper check_warnings test support try _testcapi _testcapi INT_MAX except ImportError _testcapi = None INT_MAX = - NaiveException Exception __init__ x x = x SlottedNaiveException Exception __slots__ = x __init__ x x = x BrokenStrException Exception __str__ raise Exception str broken XXX This really enough each operation should tested ExceptionTests __TestCase raise_catch exc excname subTest exc=exc excname=excname try raise exc spam except exc err buf = str err try raise exc spam except exc err buf = str err assertEqual buf buf assertEqual exc __name__ excname testRaising raise_catch AttributeError AttributeError assertRaises AttributeError getattr sys undefined_attribute raise_catch EOFError EOFError fp = open TESTFN w encoding= utf- fp close fp = open TESTFN r encoding= utf- savestdin = sys stdin try try marshal marshal loads b except EOFError pass finally sys stdin = savestdin fp close unlink TESTFN raise_catch OSError OSError assertRaises OSError open file does exist r raise_catch ImportError ImportError assertRaises ImportError __import__ undefined_module raise_catch IndexError IndexError x = assertRaises IndexError x __getitem__ raise_catch KeyError KeyError x = assertRaises KeyError x __getitem__ key raise_catch KeyboardInterrupt KeyboardInterrupt raise_catch MemoryError MemoryError raise_catch NameError NameError try x = undefined_variable except NameError pass raise_catch OverflowError OverflowError x = dummy range x += x simply shouldn t blow up raise_catch RuntimeError RuntimeError raise_catch RecursionError RecursionError raise_catch SyntaxError SyntaxError try exec \n except SyntaxError pass raise_catch IndentationError IndentationError raise_catch TabError TabError try compile try \n\t \n \t \nfinally \n pass\n string exec except TabError pass fail TabError raised raise_catch SystemError SystemError raise_catch SystemExit SystemExit assertRaises SystemExit sys exit raise_catch TypeError TypeError try + except TypeError pass raise_catch ValueError ValueError assertRaises ValueError chr raise_catch ZeroDivisionError ZeroDivisionError try x = except ZeroDivisionError pass raise_catch Exception Exception try x = except Exception e pass raise_catch StopAsyncIteration StopAsyncIteration testSyntaxErrorMessage make sure right exception message raised each these code fragments ckmsg src msg subTest src=src msg=msg try compile src fragment exec except SyntaxError e e msg = msg fail expected s got s msg e msg fail failed get expected SyntaxError s = try continue except pass ckmsg s continue properly loop ckmsg continue\n continue properly loop ckmsg f invalid syntax Perhaps you forgot comma testSyntaxErrorMissingParens ckmsg src msg exception=SyntaxError try compile src fragment exec except exception e e msg = msg fail expected s got s msg e msg fail failed get expected SyntaxError s = print old style ckmsg s Missing parentheses call print Did you mean print s = print old style ckmsg s Missing parentheses call print Did you mean print s = print f a+b c ckmsg s Missing parentheses call print Did you mean print s = exec old style ckmsg s Missing parentheses call exec Did you mean exec s = exec f a+b c ckmsg s Missing parentheses call exec Did you mean exec Check we don t incorrectly identify expression right print s = print a+b c $ ckmsg s invalid syntax s = exec a+b c $ ckmsg s invalid syntax should apply subclasses see issue s = True \nprint No indent ckmsg s expected indented block after statement line IndentationError s = True \n print \n\texec mixed tabs spaces ckmsg s inconsistent use tabs spaces indentation TabError check src lineno offset end_lineno=None end_offset=None encoding= utf- subTest source=src lineno=lineno offset=offset assertRaises SyntaxError cm compile src fragment exec assertEqual cm exception lineno lineno assertEqual cm exception offset offset end_lineno None assertEqual cm exception end_lineno end_lineno end_offset None assertEqual cm exception end_offset end_offset cm exception text None isinstance src str src = src decode encoding replace line = src split \n lineno- assertIn line cm exception text test_error_offset_continuation_characters check = check check \\\n c I \\\n\\ testSyntaxErrorOffset check = check check fact x \n\treturn x \n check +\n check spam \n print \n print check Python = Python + check Python = \u e \xfd\u \u \xf \xf + check b - - coding cp - -\nPython = \xcf\xb \xf \xee\xed + encoding= cp check b Python = \xcf\xb \xf \xee\xed + check x = check lambda x x = check f + b + c check file str file \n check = « hello » « world » check \nfile\nfor str file \nin\n \n check file for\n str file check ages = Alice = Bob = check match \n case rest key value \n check b c d e f check x yfff check f b c check f b c check f b b c check f b b c d Errors thrown compile c check foo check f \n continue check f \n break check try \n pass\nexcept \n pass\nexcept ValueError \n pass check try \n pass\nexcept \n pass check try \n pass\nexcept \n pass\nexcept ValueError \n pass Errors thrown tokenizer check x+ check x = xI check + check x = e-+ check x = o check \u b = xI check b \xce\xb = xI check b - - coding iso - - -\n\xe = xI encoding= iso - check b foo bar pass baz quux check pass\npass\npass\n + \npass\npass\npass check + check interesting\nfoo \n check b \xef\xbb\xbf#coding utf \nprint \xe \x \x \n - check f _a check f f\ \ \ _a \ \ \ check f = check b fooжжж encode Errors thrown symtable c check x = yield i i range check f \n _ check f x x \n pass check i i range j = j range check f x \n nonlocal x check f x \n x = \n global x check nonlocal x check f \n global x\n nonlocal x Errors thrown future c check __future__ doesnt_exist check __future__ braces check x= \nfrom __future__ division check foo = check f \n x y int check x x xs check foo x x range check pass check yield i = check f \n pass unittest skipIf INT_MAX = sys maxsize Downcasting int safe col_offset support requires_resource cpu support bigmemtest INT_MAX memuse= dry_run=False testMemoryErrorBigSource size src = b True \n s size b pass assertRaisesRegex OverflowError Parser column offset overflow compile src fragment exec cpython_only testSettingException test setting exception C level works even exception object can t constructed torch _dynamo error_on_graph_break False BadException Exception __init__ self_ raise RuntimeError can t instantiate BadException InvalidException pass unittest skipIf _testcapi None requires _testcapi test_capi try _testcapi raise_exception BadException except TypeError err co = err __traceback__ tb_frame f_code assertEqual co co_name test_capi assertTrue co co_filename endswith test_exceptions py fail Expected exception unittest skipIf _testcapi None requires _testcapi test_capi try _testcapi raise_exception BadException except RuntimeError err tb = err __traceback__ tb_next co = tb tb_frame f_code assertEqual co co_name __init__ assertTrue co co_filename endswith test_exceptions py co = tb tb_frame f_back f_code assertEqual co co_name test_capi fail Expected exception unittest skipIf _testcapi None requires _testcapi test_capi assertRaises SystemError _testcapi raise_exception InvalidException test_capi test_capi test_capi test_WindowsError try WindowsError except NameError pass assertIs WindowsError OSError assertEqual str OSError assertEqual str OSError message Errno message POSIX errno aka EBADF untranslated w = OSError foo bar assertEqual w errno assertEqual w winerror None assertEqual str w Errno foo bar ERROR_PATH_NOT_FOUND win error becomes ENOENT w = OSError foo bar assertEqual w errno assertEqual w winerror assertEqual w strerror foo assertEqual w filename bar assertEqual w filename None assertEqual str w WinError foo bar Unknown win error becomes EINVAL w = OSError foo None assertEqual w errno assertEqual w winerror assertEqual w strerror foo assertEqual w filename None assertEqual w filename None assertEqual str w WinError foo Non-numeric errno w = OSError bar foo assertEqual w errno bar assertEqual w winerror None assertEqual w strerror foo assertEqual w filename None assertEqual w filename None unittest skipUnless sys platform == win test specific Windows test_windows_message Should fill unknown error code Windows error message ctypes = import_module ctypes error code has no message Python formats hexadecimal code = assertRaisesRegex OSError Windows Error x x code ctypes pythonapi PyErr_SetFromWindowsErr code testAttributes test exception attributes happy exceptionList = BaseException args BaseException args BaseException foo args foo BaseException foo args foo SystemExit foo args foo code foo OSError foo args foo filename None filename None errno None strerror None OSError foo bar args foo bar filename None filename None errno foo strerror bar OSError foo bar baz args foo bar filename baz filename None errno foo strerror bar OSError foo bar baz None quux args foo bar filename baz filename quux OSError errnoStr strErrorStr filenameStr args errnoStr strErrorStr strerror strErrorStr errno errnoStr filename filenameStr OSError strErrorStr filenameStr args strErrorStr errno strerror strErrorStr filename filenameStr filename None SyntaxError msg None text None filename None lineno None offset None end_offset None print_file_and_line None SyntaxError msgStr args msgStr text None print_file_and_line None msg msgStr filename None lineno None offset None end_offset None SyntaxError msgStr filenameStr linenoStr offsetStr textStr endLinenoStr endOffsetStr offset offsetStr text textStr args msgStr filenameStr linenoStr offsetStr textStr endLinenoStr endOffsetStr print_file_and_line None msg msgStr filename filenameStr lineno linenoStr end_lineno endLinenoStr end_offset endOffsetStr SyntaxError msgStr filenameStr linenoStr offsetStr textStr endLinenoStr endOffsetStr print_file_and_lineStr text None args msgStr filenameStr linenoStr offsetStr textStr endLinenoStr endOffsetStr print_file_and_lineStr print_file_and_line None msg msgStr filename None lineno None offset None end_lineno None end_offset None UnicodeError args UnicodeEncodeError ascii ordinal range args ascii ordinal range encoding ascii object start reason ordinal range UnicodeDecodeError ascii bytearray b \xff ordinal range args ascii bytearray b \xff ordinal range encoding ascii object b \xff start reason ordinal range UnicodeDecodeError ascii b \xff ordinal range args ascii b \xff ordinal range encoding ascii object b \xff start reason ordinal range UnicodeTranslateError \u ouch args \u ouch object \u reason ouch start end NaiveException foo args foo x foo SlottedNaiveException foo args foo x foo AttributeError foo dict name= name obj= obj dict args= foo name= name obj= obj try More tests test_WindowsError exceptionList append WindowsError strErrorStr filenameStr args strErrorStr strerror strErrorStr winerror None errno filename filenameStr filename None except NameError pass exc args kwargs expected exceptionList try e = exc args kwargs except print f \nexc= exc r args= args r file=sys stderr raise Verify module name type e __name__ endswith NaiveException assertEqual type e __module__ builtins Verify no ref leaks Exc_str s = str e checkArgName expected value = getattr e checkArgName assertEqual repr value repr expected checkArgName r s == r expected r e checkArgName value expected checkArgName test pickling support p pickle protocol range p HIGHEST_PROTOCOL + s = p dumps e protocol new = p loads s checkArgName expected got = repr getattr new checkArgName exc == AttributeError checkArgName == obj See GH- we re pickling obj point So verify s None want = repr None want = repr expected checkArgName assertEqual got want pickled r attribute s e checkArgName test_setstate e = Exception e blah = assertEqual e args assertEqual e blah assertRaises AttributeError getattr e assertRaises AttributeError getattr e b e __setstate__ b assertEqual e args assertEqual e blah assertEqual e assertEqual e b e __setstate__ args blah assertEqual e args assertEqual e blah assertEqual e assertEqual e b test_invalid_setstate e = Exception assertRaisesRegex TypeError state dictionary e __setstate__ test_notes e BaseException Exception ValueError subTest e=e assertFalse hasattr e __notes__ e add_note My Note assertEqual e __notes__ My Note assertRaises TypeError e add_note assertEqual e __notes__ My Note e add_note Your Note assertEqual e __notes__ My Note Your Note del e __notes__ assertFalse hasattr e __notes__ e add_note Our Note assertEqual e __notes__ Our Note e __notes__ = assertEqual e __notes__ assertRaises TypeError e add_note will work assertEqual e __notes__ testWithTraceback try raise IndexError except Exception e tb = e __traceback__ e = BaseException with_traceback tb assertIsInstance e BaseException assertEqual e __traceback__ tb e = IndexError with_traceback tb assertIsInstance e IndexError assertEqual e __traceback__ tb torch _dynamo error_on_graph_break False MyException Exception pass e = MyException with_traceback tb assertIsInstance e MyException assertEqual e __traceback__ tb testInvalidTraceback try Exception __traceback__ = except TypeError e assertIn __traceback__ must traceback str e fail No exception raised test_invalid_setattr TE = TypeError exc = Exception msg = int object iterable assertRaisesRegex TE msg setattr exc args msg = __traceback__ must traceback None assertRaisesRegex TE msg setattr exc __traceback__ msg = exception cause must None derive BaseException assertRaisesRegex TE msg setattr exc __cause__ msg = exception context must None derive BaseException assertRaisesRegex TE msg setattr exc __context__ test_invalid_delattr TE = TypeError try raise IndexError except Exception e exc = e msg = may deleted assertRaisesRegex TE msg delattr exc args assertRaisesRegex TE msg delattr exc __traceback__ assertRaisesRegex TE msg delattr exc __cause__ assertRaisesRegex TE msg delattr exc __context__ testNoneClearsTracebackAttr try raise IndexError except Exception e tb = e __traceback__ e = Exception e __traceback__ = tb e __traceback__ = None assertEqual e __traceback__ None testChainingAttrs e = Exception assertIsNone e __context__ assertIsNone e __cause__ e = TypeError assertIsNone e __context__ assertIsNone e __cause__ torch _dynamo error_on_graph_break False MyException OSError pass e = MyException assertIsNone e __context__ assertIsNone e __cause__ testChainingDescriptors try raise Exception except Exception exc e = exc assertIsNone e __context__ assertIsNone e __cause__ assertFalse e __suppress_context__ e __context__ = NameError e __cause__ = None assertIsInstance e __context__ NameError assertIsNone e __cause__ assertTrue e __suppress_context__ e __suppress_context__ = False assertFalse e __suppress_context__ testKeywordArgs test builtin exception don t take keyword args user-defined subclasses can they want assertRaises TypeError BaseException a= torch _dynamo error_on_graph_break False DerivedException BaseException __init__ fancy_arg BaseException __init__ fancy_arg = fancy_arg x = DerivedException fancy_arg= assertEqual x fancy_arg no_tracing testInfiniteRecursion f f assertRaises RecursionError f g try g except ValueError - assertRaises RecursionError g test_str Make sure both instances classes have str representation assertTrue str Exception assertTrue str Exception assertTrue str Exception b test_exception_cleanup_names Make sure local variable bound exception instance except statement only visible inside except block try raise Exception except Exception e assertIsInstance e Exception assertNotIn e locals assertRaises UnboundLocalError e test_exception_cleanup_names Make sure cleanup doesn t break variable explicitly deleted try raise Exception except Exception e assertIsInstance e Exception del e assertNotIn e locals assertRaises UnboundLocalError e testExceptionCleanupState Make sure exception state cleaned up soon except block left See torch _dynamo error_on_graph_break False MyException Exception __init__ obj obj = obj MyObj pass inner_raising_func Create some references exception value traceback local_ref = obj raise MyException obj Qualified except obj = MyObj wr = weakref ref obj try inner_raising_func except MyException e pass obj = None gc_collect For PyPy other GCs obj = wr assertIsNone obj Qualified except without obj = MyObj wr = weakref ref obj try inner_raising_func except MyException pass obj = None gc_collect For PyPy other GCs obj = wr assertIsNone obj Bare except obj = MyObj wr = weakref ref obj try inner_raising_func except pass obj = None gc_collect For PyPy other GCs obj = wr assertIsNone obj except premature block leave obj = MyObj wr = weakref ref obj i try inner_raising_func except break obj = None gc_collect For PyPy other GCs obj = wr assertIsNone obj except block raising another exception obj = MyObj wr = weakref ref obj try try inner_raising_func except raise KeyError except KeyError e We want test except block above got rid exception raised inner_raising_func also ends up __context__ KeyError so we must clear latter manually our test succeed e __context__ = None obj = None gc_collect For PyPy other GCs obj = wr guarantee no ref cycles CPython don t gc_collect check_impl_detail cpython=False gc_collect assertIsNone obj Some complicated construct obj = MyObj wr = weakref ref obj try inner_raising_func except MyException try try raise finally raise except MyException pass obj = None check_impl_detail cpython=False gc_collect obj = wr assertIsNone obj Inside exception-silencing block torch _dynamo error_on_graph_break False Context __enter__ __exit__ exc_type exc_value exc_tb True obj = MyObj wr = weakref ref obj Context inner_raising_func obj = None check_impl_detail cpython=False gc_collect obj = wr assertIsNone obj test_exception_target_in_nested_scope issue This used raise SyntaxError can delete variable e referenced nested scope print_error e try something except Exception e print_error implicit del e here test_generator_leaking Test generator exception state doesn t leak into calling frame yield_raise try raise KeyError caught except KeyError yield sys exception yield sys exception yield sys exception g = yield_raise assertIsInstance next g KeyError assertIsNone sys exception assertIsInstance next g KeyError assertIsNone sys exception assertIsNone next g Same test inside exception handler try raise TypeError foo except TypeError g = yield_raise assertIsInstance next g KeyError assertIsInstance sys exception TypeError assertIsInstance next g KeyError assertIsInstance sys exception TypeError assertIsInstance next g TypeError del g assertIsInstance sys exception TypeError test_generator_leaking See issue g yield try raise RuntimeError except RuntimeError = g next try next except StopIteration pass assertIsNone sys exception test_generator_leaking See issue When gen throw called caller s exception state should save restored g try yield except ZeroDivisionError yield sys exception = g next try except ZeroDivisionError e assertIs sys exception e gen_exc = throw e assertIs sys exception e assertIs gen_exc e assertIsNone sys exception test_generator_leaking See issue When exception raised generator caller s exception state should still restored g try except ZeroDivisionError yield sys exception raise = g try raise TypeError except TypeError The caller s exception state TypeError temporarily saved generator tp = type next assertIs tp ZeroDivisionError try next We can t check immediately while next returns exception shouldn t have restored old exception state TypeError except ZeroDivisionError e assertIs sys exception e We used find TypeError here assertIsNone sys exception test_generator_doesnt_retain_old_exc g assertIsInstance sys exception RuntimeError yield assertIsNone sys exception = g try raise RuntimeError except RuntimeError next assertRaises StopIteration next test_generator_finalizing_and_sys_exception See simple_gen yield run_gen gen = simple_gen try raise RuntimeError except RuntimeError next gen run_gen gc_collect assertIsNone sys exception _check_generator_cleanup_exc_state testfunc Issue exception state cleaned up soon generator closed reference cycles broken torch _dynamo error_on_graph_break False MyException Exception __init__ obj obj = obj MyObj pass raising_gen try raise MyException obj except MyException yield obj = MyObj wr = weakref ref obj g = raising_gen next g testfunc g g = obj = None gc_collect For PyPy other GCs obj = wr assertIsNone obj test_generator_throw_cleanup_exc_state do_throw g try g throw RuntimeError except RuntimeError pass _check_generator_cleanup_exc_state do_throw test_generator_close_cleanup_exc_state do_close g g close _check_generator_cleanup_exc_state do_close test_generator_del_cleanup_exc_state do_del g g = None _check_generator_cleanup_exc_state do_del test_generator_next_cleanup_exc_state do_next g try next g except StopIteration pass fail should have raised StopIteration _check_generator_cleanup_exc_state do_next test_generator_send_cleanup_exc_state do_send g try g send None except StopIteration pass fail should have raised StopIteration _check_generator_cleanup_exc_state do_send test_ Bug its destructor MyObject retrieves pointer obsolete deallocated objects torch _dynamo error_on_graph_break False MyObject __del__ nonlocal e e = sys exception e = try raise Exception MyObject except pass gc_collect For PyPy other GCs assertIsNone e test_raise_does_not_create_context_chain_cycle torch _dynamo error_on_graph_break False A Exception pass B Exception pass C Exception pass Create context chain C - B - A Then raise A context C try try raise A except A a_ = a_ try raise B except B b_ b = b_ try raise C except C c_ c = c_ assertIsInstance A assertIsInstance b B assertIsInstance c C assertIsNone __context__ assertIs b __context__ assertIs c __context__ b raise except A e exc = e Expect A - C - B without cycle assertIs exc assertIs __context__ c assertIs c __context__ b assertIsNone b __context__ test_no_hang_on_context_chain_cycle See issue Cycle context chain cycle try raise ValueError except ValueError ex ex __context__ = ex raise TypeError try cycle except Exception e exc = e assertIsInstance exc TypeError assertIsInstance exc __context__ ValueError assertIs exc __context__ __context__ exc __context__ test_no_hang_on_context_chain_cycle See issue Cycle head context chain torch _dynamo error_on_graph_break False A Exception pass B Exception pass C Exception pass Context cycle + ----------- + V &#124; C -- B -- A assertRaises C cm try raise A except A _a = _a try raise B except B _b b = _b try raise C except C _c c = _c __context__ = c raise c assertIs cm exception c Verify expected context chain cycle assertIs c __context__ b assertIs b __context__ assertIs __context__ c test_no_hang_on_context_chain_cycle See issue Longer context chain cycle torch _dynamo error_on_graph_break False A Exception pass B Exception pass C Exception pass D Exception pass E Exception pass Context cycle + ----------- + V &#124; E -- D -- C -- B -- A assertRaises E cm try raise A except A _a = _a try raise B except B _b b = _b try raise C except C _c c = _c __context__ = c try raise D except D _d d = _d e = E raise e assertIs cm exception e Verify expected context chain cycle assertIs e __context__ d assertIs d __context__ c assertIs c __context__ b assertIs b __context__ assertIs __context__ c test_context_of_exception_in_try_and_finally try try te = TypeError raise te finally ve = ValueError raise ve except Exception e exc = e assertIs exc ve assertIs exc __context__ te test_context_of_exception_in_except_and_finally try try te = TypeError raise te except ve = ValueError raise ve finally oe = OSError raise oe except Exception e exc = e assertIs exc oe assertIs exc __context__ ve assertIs exc __context__ __context__ te test_context_of_exception_in_else_and_finally try try pass except pass ve = ValueError raise ve finally oe = OSError raise oe except Exception e exc = e assertIs exc oe assertIs exc __context__ ve test_unicode_change_attributes See issue This crasher u = UnicodeEncodeError baz xxxxx foo assertEqual str u baz codec can t encode characters position - foo u end = assertEqual str u baz codec can t encode character \\x position foo u end = u reason = x assertEqual str u baz codec can t encode characters position - u encoding = assertEqual str u codec can t encode characters position - u start = assertEqual str u codec can t encode characters position - u = UnicodeDecodeError baz b xxxxx foo assertEqual str u baz codec can t decode bytes position - foo u end = assertEqual str u baz codec can t decode byte x position foo u end = u reason = x assertEqual str u baz codec can t decode bytes position - u encoding = assertEqual str u codec can t decode bytes position - u start = assertEqual str u codec can t decode bytes position - u = UnicodeTranslateError xxxx foo assertEqual str u can t translate characters position - foo u end = assertEqual str u can t translate character \\x position foo u end = u reason = x assertEqual str u can t translate characters position - u start = assertEqual str u can t translate characters position - test_unicode_errors_no_object See issue klasses = UnicodeEncodeError UnicodeDecodeError UnicodeTranslateError klass klasses assertEqual str klass __new__ klass test_unicode_error_str_does_not_crash Test str UnicodeError does crash See https github com python cpython issues start end objlen product range - range - range obj = objlen subTest encode objlen=objlen start=start end=end exc = UnicodeEncodeError utf- obj start end assertIsInstance str exc str subTest translate objlen=objlen start=start end=end exc = UnicodeTranslateError obj start end assertIsInstance str exc str encoded = obj encode subTest decode objlen=objlen start=start end=end exc = UnicodeDecodeError utf- encoded start end assertIsInstance str exc str no_tracing test_badisinstance Bug issubclass e MyException raises exception should ignored torch _dynamo error_on_graph_break False Meta type __subclasscheck__ cls subclass raise ValueError MyException Exception metaclass=Meta pass captured_stderr stderr try raise KeyError except MyException e fail exception should MyException except KeyError pass except fail Should have raised KeyError fail Should have raised KeyError g try g except RecursionError e e exc = g assertIsInstance exc RecursionError type exc assertIn maximum recursion depth exceeded str exc cpython_only support requires_resource cpu test_trashcan_recursion See bpo- foo o = object x range _ _ Create big chain method objects will trigger deep chain calls when they need destructed o = o __dir__ foo support gc_collect cpython_only test_recursion_normalizing_exception import_module _testinternalcapi Issue Test RecursionError raised when tstate- recursion_depth equal recursion_limit PyErr_NormalizeException check ResourceWarning printed Prior recursivity PyErr_NormalizeException controlled tstate- recursion_depth PyExc_RecursionErrorInst singleton being used case held traceback data locals indefinitely would cause segfault _PyExc_Fini upon finalization these locals code = sys _testinternalcapi get_recursion_depth test support MyException Exception pass setrecursionlimit depth while try sys setrecursionlimit depth depth except RecursionError sys setrecursionlimit raises RecursionError new recursion limit too low issue depth += recurse cnt cnt -= cnt recurse cnt generator throw MyException gen f = open mode= rb buffering= yield generator = gen next generator recursionlimit = sys getrecursionlimit try recurse support exceeds_recursion_limit finally sys setrecursionlimit recursionlimit print Done __file__ rc out err = script_helper assert_python_failure -Wd -c code Check program does fail SIGABRT assertEqual rc assertIn b RecursionError err assertIn b ResourceWarning err assertIn b Done out cpython_only unittest skipIf _testcapi None requires _testcapi force_not_colorized test_recursion_normalizing_infinite_exception Issue Test RecursionError raised when maximum recursion depth has been exceeded when creating exception code = _testcapi try raise _testcapi RecursingInfinitelyError finally print Done rc out err = script_helper assert_python_failure -c code assertEqual rc expected = b RecursionError maximum recursion depth exceeded assertTrue expected err msg=f expected r found err _ r truncated assertIn b Done out test_recursion_in_except_handler set_relative_recursion_limit n depth = while True try sys setrecursionlimit depth except RecursionError depth += break sys setrecursionlimit depth+n recurse_in_except try except recurse_in_except recurse_after_except try except pass recurse_after_except recurse_in_body_and_except try recurse_in_body_and_except except recurse_in_body_and_except recursionlimit = sys getrecursionlimit try set_relative_recursion_limit func recurse_in_except recurse_after_except recurse_in_body_and_except subTest func=func try func except RecursionError pass fail Should have raised RecursionError finally sys setrecursionlimit recursionlimit cpython_only Python built Py_TRACE_REFS fail fatal error _PyRefchain_Trace memory allocation error unittest skipIf support Py_TRACE_REFS cannot test Py_TRACE_REFS build unittest skipIf _testcapi None requires _testcapi test_recursion_normalizing_with_no_memory Issue Test abort occurs when there no memory left size Python frames stack greater than size list preallocated MemoryError instances Fatal Python error message mentions MemoryError code = _testcapi C pass recurse cnt cnt -= cnt recurse cnt _testcapi set_nomemory C recurse SuppressCrashReport rc out err = script_helper assert_python_failure -c code assertIn b MemoryError err cpython_only unittest skipIf _testcapi None requires _testcapi test_MemoryError PyErr_NoMemory always raises same exception instance Check traceback doubled traceback _testcapi raise_memoryerror raiseMemError try raise_memoryerror except MemoryError e tb = e __traceback__ fail Should have raised MemoryError traceback format_tb tb tb = raiseMemError tb = raiseMemError assertEqual tb tb cpython_only unittest skipIf _testcapi None requires _testcapi test_exception_with_doc doc = This test docstring doc = This another test docstring assertRaises SystemError _testcapi make_exception_with_doc error test basic usage PyErr_NewException error = _testcapi make_exception_with_doc _testcapi error assertIs type error type assertTrue issubclass error Exception assertIsNone error __doc__ test given docstring error = _testcapi make_exception_with_doc _testcapi error doc assertEqual error __doc__ doc test explicit base without docstring error = _testcapi make_exception_with_doc _testcapi error base=error assertTrue issubclass error error test explicit base tuple torch _dynamo error_on_graph_break False C object pass error = _testcapi make_exception_with_doc _testcapi error doc error C assertTrue issubclass error error assertTrue issubclass error C assertEqual error __doc__ doc test explicit dictionary error = _testcapi make_exception_with_doc _testcapi error error assertTrue issubclass error error assertEqual error assertEqual error __doc__ cpython_only unittest skipIf _testcapi None requires _testcapi test_memory_error_cleanup Issue preallocated MemoryError instances should keep traceback objects alive _testcapi raise_memoryerror torch _dynamo error_on_graph_break False C pass wr = None inner nonlocal wr c = C wr = weakref ref c raise_memoryerror We cannot use assertRaises since manually deletes traceback try inner except MemoryError e assertNotEqual wr None fail MemoryError raised gc_collect For PyPy other GCs assertEqual wr None no_tracing test_recursion_error_cleanup Same test above recursion exceeded errors torch _dynamo error_on_graph_break False C pass wr = None inner nonlocal wr c = C wr = weakref ref c inner We cannot use assertRaises since manually deletes traceback try inner except RecursionError e assertNotEqual wr None fail RecursionError raised gc_collect For PyPy other GCs assertEqual wr None test_errno_ENOTDIR Issue directory errors ENOTDIR even Windows assertRaises OSError cm os listdir __file__ assertEqual cm exception errno errno ENOTDIR cm exception test_unraisable Issue PyErr_WriteUnraisable should give sensible reports torch _dynamo error_on_graph_break False BrokenDel __del__ exc = ValueError del broken The following line included traceback report raise exc obj = BrokenDel support catch_unraisable_exception cm del obj gc_collect For PyPy other GCs assertEqual cm unraisable object BrokenDel __del__ assertIsNotNone cm unraisable exc_traceback test_unhandled Check sensible reporting unhandled exceptions exc_type ValueError BrokenStrException subTest exc_type try exc = exc_type test message The following line included traceback report raise exc except exc_type captured_stderr stderr sys __excepthook__ sys exc_info report = stderr getvalue assertIn test_exceptions py report assertIn raise exc report assertIn exc_type __name__ report exc_type BrokenStrException assertIn exception str failed report assertIn test message report assertTrue report endswith \n cpython_only Python built Py_TRACE_REFS fail fatal error _PyRefchain_Trace memory allocation error unittest skipIf support Py_TRACE_REFS cannot test Py_TRACE_REFS build unittest skipIf _testcapi None requires _testcapi test_memory_error_in_PyErr_PrintEx code = _testcapi C pass _testcapi set_nomemory d C Issue Abort PyErr_PrintEx when no memory Span large range tests CPython code always evolves changes add remove memory allocations i range rc out err = script_helper assert_python_failure -c code i assertIn rc assertIn b MemoryError err test_yield_in_nested_try_excepts #Issue torch _dynamo error_on_graph_break False MainError Exception pass SubError Exception pass main try raise MainError except MainError try yield except SubError pass raise coro = main coro send None assertRaises MainError coro throw SubError test_generator_doesnt_retain_old_exc #Issue #msg g try raise ValueError except ValueError yield assertIsNone sys exception yield gen = g try raise IndexError except IndexError assertEqual next gen assertEqual next gen test_raise_in_generator #Issue #msg g yield raise yield assertRaises ZeroDivisionError i = g try except next i next i unittest skipUnless __debug__ Won t work __debug__ False test_assert_shadowing Shadowing AssertionError would cause assert statement misbehave global AssertionError AssertionError = TypeError try assert False hello except BaseException e del AssertionError assertIsInstance e AssertionError assertEqual str e hello del AssertionError fail Expected exception test_memory_error_subclasses bpo- MemoryError instances use freelist objects linked using dict attribute when they inactive dead Subclasses MemoryError should participate freelist schema This test creates MemoryError object keeps alive therefore advancing freelist then creates destroys subclass object Finally checks creating new MemoryError succeeds proving freelist corrupted torch _dynamo error_on_graph_break False TestException MemoryError pass try raise MemoryError except MemoryError exc inst = exc try raise TestException except Exception pass _ range try raise MemoryError except MemoryError exc pass gc_collect unittest skipIf _testcapi None requires _testcapi test_memory_error_in_subinterp gh- subinterpreters shouldn t count last resort memory error when MemoryError raised through PyErr_NoMemory call should preallocate memory errors does main interpreter interp static_objects last_resort_memory_error args should initialized empty tuple avoid crash attempt print code = f _testcapi _testcapi run_in_subinterp \ sys maxsize \ exit rc _ err = script_helper assert_python_ok -c code assertIn b MemoryError err NameErrorTests __TestCase test_name_error_has_name try bluch except NameError exc assertEqual bluch exc name test_issue regression test bpo- f assertRaisesRegex NameError aaa aab try f except failureException support captured_stderr err sys __excepthook__ sys exc_info fail assertRaisesRegex should have failed assertIn aab err getvalue test_issue _focused f try nonsense except BaseException E E with_traceback None raise ZeroDivisionError try f except ZeroDivisionError support captured_stderr err sys __excepthook__ sys exc_info assertIn nonsense err getvalue assertIn ZeroDivisionError err getvalue test_gh_ f torch _dynamo error_on_graph_break False TestClass TestClass assertRaises NameError f Note name suggestion tests live ` test_traceback ` AttributeErrorTests __TestCase test_attributes Setting attr should problem exc = AttributeError Ouch assertIsNone exc name assertIsNone exc obj sentinel = object exc = AttributeError Ouch name= carry obj=sentinel assertEqual exc name carry assertIs exc obj sentinel test_getattr_has_name_and_obj torch _dynamo error_on_graph_break False A blech = None obj = A try obj bluch except AttributeError exc assertEqual bluch exc name assertEqual obj exc obj try object __getattribute__ obj bluch except AttributeError exc assertEqual bluch exc name assertEqual obj exc obj test_getattr_has_name_and_obj_for_method torch _dynamo error_on_graph_break False A blech obj = A try obj bluch except AttributeError exc assertEqual bluch exc name assertEqual obj exc obj Note name suggestion tests live ` test_traceback ` ImportErrorTests __TestCase test_attributes Setting name path should problem exc = ImportError test assertIsNone exc name assertIsNone exc path exc = ImportError test name= somemodule assertEqual exc name somemodule assertIsNone exc path exc = ImportError test path= somepath assertEqual exc path somepath assertIsNone exc name exc = ImportError test path= somepath name= somename assertEqual exc name somename assertEqual exc path somepath msg = r ImportError\ \ got unexpected keyword argument invalid assertRaisesRegex TypeError msg ImportError test invalid= keyword assertRaisesRegex TypeError msg ImportError test name= name invalid= keyword assertRaisesRegex TypeError msg ImportError test path= path invalid= keyword assertRaisesRegex TypeError msg ImportError invalid= keyword assertRaisesRegex TypeError msg ImportError test invalid= keyword another=True test_reset_attributes exc = ImportError test name= name path= path assertEqual exc args test assertEqual exc msg test assertEqual exc name name assertEqual exc path path Reset specified attributes exc __init__ assertEqual exc args assertEqual exc msg None assertEqual exc name None assertEqual exc path None test_non_str_argument Issue check_warnings BytesWarning quiet=True arg = b abc exc = ImportError arg assertEqual str arg str exc test_copy_pickle kwargs dict dict name= somename dict path= somepath dict name= somename path= somepath orig = ImportError test kwargs proto range pickle HIGHEST_PROTOCOL + exc = pickle loads pickle dumps orig proto assertEqual exc args test assertEqual exc msg test assertEqual exc name orig name assertEqual exc path orig path c copy copy copy deepcopy exc = c orig assertEqual exc args test assertEqual exc msg test assertEqual exc name orig name assertEqual exc path orig path run_script source isinstance source str open TESTFN w encoding= utf- testfile testfile write dedent source open TESTFN wb testfile testfile write source _rc _out err = script_helper assert_python_failure -Wd -X utf TESTFN err decode utf- splitlines AssertionErrorTests __TestCase tearDown unlink TESTFN force_not_colorized test_assertion_error_location cases = assert None assert None ^^^^ AssertionError assert assert ^ AssertionError assert assert ^^^^^ AssertionError assert assert ^^^^^^^^^^^^^^^ AssertionError assert messäge assert messäge ^^^^^ AssertionError messäge assert messäge encode assert messäge ^^^^^ AssertionError messäge coding latin \nassert messäge encode latin assert messäge ^^^^^ AssertionError messäge BOM_UTF + assert messäge encode assert messäge ^^^^^ AssertionError messäge Multiline assert ^^^^^ AssertionError assert Message Message ^^^^^ AssertionError Message assert \\ Message \\ ^^^^^ AssertionError Message source expected cases subTest source=source result = run_script source assertEqual result - expected force_not_colorized test_multiline_not_highlighted cases = assert AssertionError assert AssertionError source expected cases subTest source=source result = run_script source assertEqual result -len expected expected support force_not_colorized_test_class SyntaxErrorTests __TestCase maxDiff = None force_not_colorized test_range_of_offsets cases = Basic range - bad py abcdefg dedent File bad py line abcdefg ^^^^^ SyntaxError bad bad end_offset = start_offset + bad py abcdefg dedent File bad py line abcdefg ^ SyntaxError bad bad Negative end offset bad py abcdefg - dedent File bad py line abcdefg ^ SyntaxError bad bad end offset before starting offset bad py abcdefg dedent File bad py line abcdefg ^ SyntaxError bad bad Both offsets negative bad py - abcdefg - dedent File bad py line abcdefg SyntaxError bad bad Both offsets negative end more negative bad py - abcdefg - dedent File bad py line abcdefg SyntaxError bad bad Both offsets bad py abcdefg dedent File bad py line abcdefg SyntaxError bad bad Start offset end offset bad py abcdefg dedent File bad py line abcdefg SyntaxError bad bad End offset pass source length bad py abcdefg dedent File bad py line abcdefg ^^^^^^ SyntaxError bad bad args expected cases subTest args=args try raise SyntaxError bad bad args except SyntaxError exc support captured_stderr err sys __excepthook__ sys exc_info assertIn expected err getvalue the_exception = exc test_subclass torch _dynamo error_on_graph_break False MySyntaxError SyntaxError pass try raise MySyntaxError bad bad bad py abcdefg except SyntaxError exc support captured_stderr err sys __excepthook__ sys exc_info assertIn File bad py line abcdefg ^^^^^ err getvalue test_encodings addCleanup unlink TESTFN source = - - coding cp - -\n ┬ó┬ó┬ó┬ó┬ó┬ó + f x x range \n err = run_script source encode cp assertEqual err - ┬ó┬ó┬ó┬ó┬ó┬ó + f x x range assertEqual err - ^^^^^^^^^^^^^^^^^^^ Check backwards tokenizer errors source = - - coding ascii - -\n\n \n err = run_script source assertEqual err - assertEqual err - ^ test_non_utf Check non utf- characters addCleanup unlink TESTFN err = run_script b \x assertIn SyntaxError Non-UTF- code starting \\x file err - test_string_source try_compile source assertRaises SyntaxError cm compile source string exec cm exception exc = try_compile ä assertEqual str exc outside function string line assertIsNone exc text assertEqual exc offset assertEqual exc end_offset exc = try_compile ä encode assertEqual str exc outside function string line assertIsNone exc text assertEqual exc offset assertEqual exc end_offset exc = try_compile BOM_UTF + ä encode assertEqual str exc outside function string line assertIsNone exc text assertEqual exc offset assertEqual exc end_offset exc = try_compile coding latin \nreturn ä encode latin assertEqual str exc outside function string line assertIsNone exc text assertEqual exc offset assertEqual exc end_offset exc = try_compile ä + ä assertEqual str exc outside function string line assertIsNone exc text assertEqual exc offset assertEqual exc end_offset exc = try_compile ä + ä assertEqual str exc outside function string line assertIsNone exc text assertEqual exc offset assertEqual exc end_offset test_file_source addCleanup unlink TESTFN err = run_script ä assertEqual err - ä ^^^^^^^^^^ SyntaxError outside function err = run_script ä encode assertEqual err - ä ^^^^^^^^^^ SyntaxError outside function err = run_script BOM_UTF + ä encode assertEqual err - ä ^^^^^^^^^^ SyntaxError outside function err = run_script coding latin \nreturn ä encode latin assertEqual err - ä ^^^^^^^^^^ SyntaxError outside function err = run_script ä + ä assertEqual err - ^^^^^^^^^^^ SyntaxError outside function assertEqual err - ä + ä err = run_script ä + ä assertEqual err - ^^^^^^^^^^^ SyntaxError outside function assertEqual err - ä + ä test_attributes_new_constructor args = bad py abcdefg the_exception = SyntaxError bad bad args filename lineno offset error end_lineno end_offset = args assertEqual filename the_exception filename assertEqual lineno the_exception lineno assertEqual end_lineno the_exception end_lineno assertEqual offset the_exception offset assertEqual end_offset the_exception end_offset assertEqual error the_exception text assertEqual bad bad the_exception msg test_attributes_old_constructor args = bad py abcdefg the_exception = SyntaxError bad bad args filename lineno offset error = args assertEqual filename the_exception filename assertEqual lineno the_exception lineno assertEqual None the_exception end_lineno assertEqual offset the_exception offset assertEqual None the_exception end_offset assertEqual error the_exception text assertEqual bad bad the_exception msg test_incorrect_constructor args = bad py assertRaises TypeError SyntaxError bad bad args args = bad py assertRaises TypeError SyntaxError bad bad args args = bad py abcdefg assertRaises TypeError SyntaxError bad bad args TestInvalidExceptionMatcher __TestCase test_except_star_invalid_exception_type assertRaises TypeError try raise ValueError except pass assertRaises TypeError try raise ValueError except ValueError pass PEP Tests __TestCase lineno_after_raise f expected try f except Exception ex t = ex __traceback__ fail No exception raised lines = t = t tb_next Skip function while t frame = t tb_frame lines append None frame f_lineno None frame f_lineno-frame f_code co_firstlineno t = t tb_next assertEqual tuple lines expected test_lineno_after_raise_simple simple pass lineno_after_raise simple test_lineno_after_raise_in_except in_except try except pass lineno_after_raise in_except test_lineno_after_other_except other_except try except TypeError ex pass lineno_after_raise other_except test_lineno_in_named_except in_named_except try except Exception ex pass lineno_after_raise in_named_except test_lineno_in_try in_try try finally pass lineno_after_raise in_try test_lineno_in_finally_normal in_finally_normal try pass finally pass lineno_after_raise in_finally_normal test_lineno_in_finally_except in_finally_except try finally pass lineno_after_raise in_finally_except test_lineno_after_with torch _dynamo error_on_graph_break False Noop __enter__ __exit__ args pass after_with Noop pass lineno_after_raise after_with test_missing_lineno_shows_as_none f lineno_after_raise f f __code__ = f __code__ replace co_linetable=b \xf \xf \xf \xf \xf \xf \xf lineno_after_raise f None test_lineno_after_raise_in_with_exit torch _dynamo error_on_graph_break False ExitFails __enter__ __exit__ args raise ValueError after_with ExitFails lineno_after_raise after_with __name__ == __main__ run_tests
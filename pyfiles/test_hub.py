Owner s module hub os tempfile unittest warnings unittest mock patch torch torch hub hub torch testing _internal common_utils IS_SANDCASTLE retry run_tests TestCase sum_of_state_dict state_dict s = v state_dict values s += v sum s SUM_OF_HUB_EXAMPLE = TORCHHUB_EXAMPLE_RELEASE_URL = https github com ailzhang torchhub_example releases download mnist_init_ones unittest skipIf IS_SANDCASTLE Sandcastle cannot ping external TestHub TestCase setUp super setUp previous_hub_dir = torch hub get_dir tmpdir = tempfile TemporaryDirectory hub_dir torch hub set_dir tmpdir name trusted_list_path = os path join torch hub get_dir trusted_list tearDown super tearDown torch hub set_dir previous_hub_dir probably needed can t hurt tmpdir cleanup _assert_trusted_list_is_empty open trusted_list_path f assert f readlines _assert_in_trusted_list line open trusted_list_path f assert line l strip l f retry Exception tries= test_load_from_github hub_model = hub load ailzhang torchhub_example mnist source= github pretrained=True verbose=False assertEqual sum_of_state_dict hub_model state_dict SUM_OF_HUB_EXAMPLE retry Exception tries= test_load_from_local_dir local_dir = hub _get_cache_or_reload ailzhang torchhub_example force_reload=False trust_repo=True calling_fn=None hub_model = hub load local_dir mnist source= local pretrained=True verbose=False assertEqual sum_of_state_dict hub_model state_dict SUM_OF_HUB_EXAMPLE retry Exception tries= test_load_from_branch hub_model = hub load ailzhang torchhub_example ci test_slash mnist pretrained=True verbose=False assertEqual sum_of_state_dict hub_model state_dict SUM_OF_HUB_EXAMPLE retry Exception tries= test_get_set_dir previous_hub_dir = torch hub get_dir tempfile TemporaryDirectory hub_dir tmpdir torch hub set_dir tmpdir assertEqual torch hub get_dir tmpdir assertNotEqual previous_hub_dir tmpdir hub_model = hub load ailzhang torchhub_example mnist pretrained=True verbose=False assertEqual sum_of_state_dict hub_model state_dict SUM_OF_HUB_EXAMPLE assert os path exists os path join tmpdir ailzhang_torchhub_example_master Test set_dir properly calls expanduser non-regression test https github com pytorch pytorch issues new_dir = os path join ~ hub torch hub set_dir new_dir assertEqual torch hub get_dir os path expanduser new_dir retry Exception tries= test_list_entrypoints entry_lists = hub list ailzhang torchhub_example trust_repo=True assertObjectIn mnist entry_lists retry Exception tries= test_download_url_to_file tempfile TemporaryDirectory tmpdir f = os path join tmpdir temp hub download_url_to_file TORCHHUB_EXAMPLE_RELEASE_URL f progress=False loaded_state = torch load f assertEqual sum_of_state_dict loaded_state SUM_OF_HUB_EXAMPLE Check downloaded file has default file permissions f_ref = os path join tmpdir reference open f_ref w close expected_permissions = oct os stat f_ref st_mode o actual_permissions = oct os stat f st_mode o assert actual_permissions == expected_permissions retry Exception tries= test_load_state_dict_from_url loaded_state = hub load_state_dict_from_url TORCHHUB_EXAMPLE_RELEASE_URL assertEqual sum_of_state_dict loaded_state SUM_OF_HUB_EXAMPLE name file_name = the_file_name loaded_state = hub load_state_dict_from_url TORCHHUB_EXAMPLE_RELEASE_URL file_name=file_name expected_file_path = os path join torch hub get_dir checkpoints file_name assertTrue os path exists expected_file_path assertEqual sum_of_state_dict loaded_state SUM_OF_HUB_EXAMPLE safe weight_only loaded_state = hub load_state_dict_from_url TORCHHUB_EXAMPLE_RELEASE_URL weights_only=True assertEqual sum_of_state_dict loaded_state SUM_OF_HUB_EXAMPLE retry Exception tries= test_load_legacy_zip_checkpoint warnings catch_warnings record=True ws warnings simplefilter always hub_model = hub load ailzhang torchhub_example mnist_zip pretrained=True verbose=False assertEqual sum_of_state_dict hub_model state_dict SUM_OF_HUB_EXAMPLE assert any will deprecated favor default zipfile str w w ws Test default zipfile serialization format produced = release retry Exception tries= test_load_zip_ _ _checkpoint hub_model = hub load ailzhang torchhub_example mnist_zip_ _ pretrained=True verbose=False trust_repo=True assertEqual sum_of_state_dict hub_model state_dict SUM_OF_HUB_EXAMPLE retry Exception tries= test_hub_parse_repo_info If branch specified we just parse input assertEqual torch hub _parse_repo_info b c b c For torchvision default branch main assertEqual torch hub _parse_repo_info pytorch vision pytorch vision main For torchhub_example repo default branch still master assertEqual torch hub _parse_repo_info ailzhang torchhub_example ailzhang torchhub_example master retry Exception tries= test_load_commit_from_forked_repo assertRaisesRegex ValueError If s commit forked repo torch hub load pytorch vision e c resnet retry Exception tries= patch builtins input return_value= test_trust_repo_false_emptystring patched_input assertRaisesRegex Exception Untrusted repository torch hub load ailzhang torchhub_example mnist_zip_ _ trust_repo=False _assert_trusted_list_is_empty patched_input assert_called_once patched_input reset_mock assertRaisesRegex Exception Untrusted repository torch hub load ailzhang torchhub_example mnist_zip_ _ trust_repo=False _assert_trusted_list_is_empty patched_input assert_called_once retry Exception tries= patch builtins input return_value= no test_trust_repo_false_no patched_input assertRaisesRegex Exception Untrusted repository torch hub load ailzhang torchhub_example mnist_zip_ _ trust_repo=False _assert_trusted_list_is_empty patched_input assert_called_once patched_input reset_mock assertRaisesRegex Exception Untrusted repository torch hub load ailzhang torchhub_example mnist_zip_ _ trust_repo=False _assert_trusted_list_is_empty patched_input assert_called_once retry Exception tries= patch builtins input return_value= y test_trusted_repo_false_yes patched_input torch hub load ailzhang torchhub_example mnist_zip_ _ trust_repo=False _assert_in_trusted_list ailzhang_torchhub_example patched_input assert_called_once Loading second time check we don t ask user input patched_input reset_mock torch hub load ailzhang torchhub_example mnist_zip_ _ trust_repo= check patched_input assert_not_called Loading again False we still ask user input patched_input reset_mock torch hub load ailzhang torchhub_example mnist_zip_ _ trust_repo=False patched_input assert_called_once retry Exception tries= patch builtins input return_value= no test_trust_repo_check_no patched_input assertRaisesRegex Exception Untrusted repository torch hub load ailzhang torchhub_example mnist_zip_ _ trust_repo= check _assert_trusted_list_is_empty patched_input assert_called_once patched_input reset_mock assertRaisesRegex Exception Untrusted repository torch hub load ailzhang torchhub_example mnist_zip_ _ trust_repo= check patched_input assert_called_once retry Exception tries= patch builtins input return_value= y test_trust_repo_check_yes patched_input torch hub load ailzhang torchhub_example mnist_zip_ _ trust_repo= check _assert_in_trusted_list ailzhang_torchhub_example patched_input assert_called_once Loading second time check we don t ask user input patched_input reset_mock torch hub load ailzhang torchhub_example mnist_zip_ _ trust_repo= check patched_input assert_not_called retry Exception tries= test_trust_repo_true torch hub load ailzhang torchhub_example mnist_zip_ _ trust_repo=True _assert_in_trusted_list ailzhang_torchhub_example retry Exception tries= test_trust_repo_builtin_trusted_owners torch hub load pytorch vision resnet trust_repo= check _assert_trusted_list_is_empty retry Exception tries= test_trust_repo_none warnings catch_warnings record=True w warnings simplefilter always torch hub load ailzhang torchhub_example mnist_zip_ _ trust_repo=None assert len w == assert issubclass w - category UserWarning assert You about download run code untrusted repository str w - message _assert_trusted_list_is_empty retry Exception tries= test_trust_repo_legacy We first download repo then delete allowlist file Then we check repo indeed trusted without prompt because already downloaded past torch hub load ailzhang torchhub_example mnist_zip_ _ trust_repo=True os remove trusted_list_path torch hub load ailzhang torchhub_example mnist_zip_ _ trust_repo= check _assert_trusted_list_is_empty __name__ == __main__ run_tests
Owner s oncall jit unittest typing Callable List torch torch nn torch testing FileCheck torch testing _internal common_utils raise_on_run_directly torch testing _internal jit_utils _inline_everything JitTestCase RUN_CUDA TestPeephole JitTestCase test_peephole_with_writes test_write x s = s += x s += x s checkScript test_write torch ones test_peephole_with_non_output_writes torch jit ignore nomnom x pass test_write x t = torch ones_like x z = x clone y = z + z add_ t makes sure z isn t blasted out existence because isn t returned used side-effectful way nomnom z y + y = torch ones checkScript test_write test_peephole_no_output_aliasing test_peephole x y = x + x y = torch ones j = checkScript test_peephole r r = j assertNotEqual r data_ptr r data_ptr test_peephole = torch tensor b = torch tensor c = torch tensor dtype=torch int f x y x type_as y tf = torch jit trace f b FileCheck check type_as run str tf graph run_pass peephole tf graph FileCheck check_not type_as run str tf graph tf = torch jit trace f c s = str tf graph run_pass peephole tf graph assertEqual s str s test_peephole_dynamic f x y x type_as y fn = torch jit script f s = str fn graph torch _C _jit_pass_peephole fn graph assertEqual s str fn graph test_peephole_list_ops torch jit script foo x y z len x y z run_pass peephole foo graph FileCheck check value= check_next run foo graph torch jit script foo x y z li = x y z _ range len x li append x len x y z run_pass peephole foo graph FileCheck check_not aten len run foo graph torch jit script foo x y z li = x y z li li - FileCheck check aten __getitem__ run foo graph run_pass peephole foo graph FileCheck check_not aten __getitem__ run foo graph torch jit script foo x y z li = x y z li - run_pass peephole foo graph FileCheck check aten __getitem__ run foo graph torch jit script foo x y z li = x y z _ range len x li append x li - run_pass peephole foo graph FileCheck check aten __getitem__ run foo graph unittest skipIf RUN_CUDA cpp tests require CUDA test_peephole_cuda = torch tensor device= cpu b = torch tensor device= cuda c = torch tensor device= cuda f x y x type_as y trace = torch jit trace f c s = str trace graph run_pass peephole trace graph assertEqual s str trace graph trace = torch jit trace f b c run_pass peephole trace graph run_pass dce trace graph FileCheck check_not type_as run str trace graph _inline_everything test_peephole_type_refinements refine x type Optional Tensor - Tensor x x None torch tensor torch jit script test refine torch tensor FileCheck check prim unchecked_cast run test graph run_pass peephole test graph FileCheck check_not prim unchecked_cast run test graph refinement optimized out is_int_tensor x scalar = x item isinstance scalar int scalar + checkScript is_int_tensor torch tensor checkScript is_int_tensor torch tensor graph = torch jit script is_int_tensor graph run_pass peephole graph FileCheck check prim unchecked_cast run graph test_short_circuit_optimization torch jit script const_expressions x type int - Tuple bool bool x == False x == True run_pass constant_propagation const_expressions graph FileCheck check_not prim If check_not aten eq run const_expressions graph assertEqual const_expressions False True torch jit script redundant_expressions x type int - Tuple bool bool x == True x == False run_pass peephole redundant_expressions graph assertEqual redundant_expressions True True assertEqual redundant_expressions False False True False removed graph FileCheck check aten eq check_not prim If run redundant_expressions graph test_conv_dim_folding modules = nn Conv d nn Conv d nn Conv d mod modules ConvDim torch nn Module __init__ - None super __init__ conv = mod kernel_size= stride= bias=False forward x x = conv x x dim conv_dim = torch jit script ConvDim run_pass inline conv_dim graph run_pass peephole conv_dim graph FileCheck check_not conv check_not dim run conv_dim graph ConvDimMutate torch nn Module __init__ - None super __init__ conv = mod kernel_size= stride= bias=False forward x x = conv x x resize_ x dim conv_dim = torch jit script ConvDimMutate run_pass inline conv_dim graph run_pass peephole conv_dim graph FileCheck check conv check dim run conv_dim graph test_normalized_rsub = torch tensor b = torch tensor convertible_rsub x y x - y torch rsub y x checkScript convertible_rsub b op_graph = torch jit script convertible_rsub graph FileCheck check_count aten sub exactly=True run op_graph FileCheck check_count aten rsub exactly=True run op_graph test_normalized_is_op convertible_is_op x bool y bool x True False x x y checkScript convertible_is_op True False op_graph = torch jit script convertible_is_op graph FileCheck check_count aten eq exactly=True run op_graph FileCheck check_count aten __is__ exactly=True run op_graph test_normalized_isnot_op convertible_isnot_op x bool y bool x True False x x y checkScript convertible_isnot_op True False op_graph = torch jit script convertible_isnot_op graph FileCheck check_count aten ne exactly=True run op_graph FileCheck check_count aten __isnot__ exactly=True run op_graph test_peephole_list_len run_peephole_and_check_const_value graph const_string torch _C _jit_pass_peephole_list_idioms graph refine_list_len=True run_pass constant_propagation graph FileCheck check const_string check_next run graph gen_li inp_len int i range inp_len torch jit script foo x List int y List int len x = len y = raise Exception noqa TRY len x + len y run_peephole_and_check_const_value foo graph value= assertEqual foo gen_li gen_li assertRaises Exception foo torch jit script foo x List int y List int len x == len y == pass raise Exception hi noqa TRY len x + len y run_peephole_and_check_const_value foo graph value= assertEqual foo gen_li gen_li assertRaises Exception foo torch jit script foo x List int y List int z List int len x = raise Exception noqa TRY len y = raise Exception noqa TRY len z == pass raise Exception noqa TRY len x + len y len z run_peephole_and_check_const_value foo graph value= assertEqual foo gen_li gen_li gen_li assertRaises Exception foo refinement should persist second len x call torch jit script foo x List int cond bool len x == cond len x run_peephole_and_check_const_value foo graph value= test_const_tuple_output graph const_inputs tup = graph findNode prim TupleConstruct i elem enumerate tup inputs i const_inputs assertIsNotNone elem toIValue assertIsNone elem toIValue testing combinations x True False x then branch x assert True False torch jit script foo x List int b List int len x == x = True x = len b = assert x == False noqa E TODO canonicalize x False aten eq len x len b torch _C _jit_pass_peephole_list_idioms foo graph refine_list_len=True torch _C _jit_pass_constant_propagation foo graph we can only infer len b == here test_const_tuple_output foo graph torch jit script foo x List int b List int len x == x = False x = len b = assert x == False noqa E TODO canonicalize x False aten eq len x len b torch _C _jit_pass_peephole_list_idioms foo graph refine_list_len=True torch _C _jit_pass_constant_propagation foo graph cant infer anything test_const_tuple_output foo graph torch jit script foo x List int b List int len x == x = True x = len b == assert x == False noqa E TODO canonicalize x False aten eq len x len b torch _C _jit_pass_peephole_list_idioms foo graph refine_list_len=True torch _C _jit_pass_constant_propagation foo graph we cant infer anything only len b = test_const_tuple_output foo graph torch jit script foo x List int b List int len x == x = True x = len b = assert x == False noqa E TODO canonicalize x False aten eq len x len b torch _C _jit_pass_peephole_list_idioms foo graph refine_list_len=True torch _C _jit_pass_constant_propagation foo graph can infer len b == test_const_tuple_output foo graph swap branches torch jit script foo x List int b List int len x = x = len b = x = True assert x == False noqa E TODO canonicalize x False aten eq len x len b torch _C _jit_pass_peephole_list_idioms foo graph refine_list_len=True torch _C _jit_pass_constant_propagation foo graph can infer len b == test_const_tuple_output foo graph use __not__ torch jit script foo x List int b List int len x = x = len b = x = True assert x len x len b torch _C _jit_pass_peephole_list_idioms foo graph refine_list_len=True torch _C _jit_pass_constant_propagation foo graph can infer len b == test_const_tuple_output foo graph Test unsuccessful optimizations torch jit script foo x List int assert len x == x append len x torch _C _jit_pass_peephole_list_idioms foo graph refine_list_len=True run_pass constant_propagation foo graph FileCheck check_count aten len run foo graph torch jit script foo x List int y List int assert len x == len y == len x + len y torch _C _jit_pass_peephole_list_idioms foo graph refine_list_len=True run_pass constant_propagation foo graph FileCheck check_count aten len run foo graph test_integer_refinement run_peephole_and_check_const_value graph const_string run_pass refine_integer_values graph run_pass constant_propagation graph run_pass dce graph FileCheck check const_string check_next run graph torch jit script foo x int y int x = y = raise Exception noqa TRY x + y graph = foo graph run_pass refine_integer_values graph run_pass constant_propagation graph run_pass dce graph run_peephole_and_check_const_value foo graph value= assertEqual foo assertRaises Exception foo torch jit script foo x int y int x == y == pass raise Exception hi noqa TRY x + y run_peephole_and_check_const_value foo graph value= assertEqual foo assertRaises Exception foo torch jit script foo x int y int z int x = raise Exception noqa TRY y = raise Exception noqa TRY z == pass raise Exception noqa TRY x + y z run_peephole_and_check_const_value foo graph value= assertEqual foo assertRaises Exception foo refinement should persist second len x call torch jit script foo x int cond bool x == cond x run_peephole_and_check_const_value foo graph value= torch jit script foo x int y int assert x == y == x + y torch _C _jit_pass_peephole_list_idioms foo graph refine_list_len=True run_pass constant_propagation foo graph FileCheck check aten add run foo graph test_optimize_out_comparison_same_value foo x int x == x x = x foo x List int x == x x = x func inp zip foo foo func_s = torch jit script func run_pass peephole func_s graph FileCheck check_not aten eq check_not aten neq run func_s graph assertEqual func inp func_s inp test_peephole_add_zero torch jit script foo x int x + + x run_pass peephole foo graph FileCheck check_not aten add assertEqual foo test_noop_peephole test unsuccessful foo x x + foo x = torch zeros x sub_ x + foo x = torch zeros x x + foo x = torch zeros x + funcs = foo foo foo foo inps = torch ones func inp zip funcs inps foo_s = torch jit script func run_pass peephole foo_s graph FileCheck check_count aten add exactly=True run foo_s graph assertEqual func inp foo_s inp successful func x x + - func_s = torch jit script func run_pass peephole func_s graph bail modified value first FileCheck check_not aten add check aten mul run func_s graph second run should succeed run_pass peephole func_s graph FileCheck check_not aten add check_not aten mul run func_s graph assertEqual func torch ones func_s torch ones func x x + - func_s = torch jit script func inp = next func_s graph inputs inp setType torch _C TensorType create_from_tensor torch rand torch _C _jit_pass_peephole func_s graph disable_shape_peepholes=True FileCheck check aten add run func_s graph torch _C _jit_pass_peephole func_s graph disable_shape_peepholes=False FileCheck check_not aten add run func_s graph test_refine_integer_values torch jit script foo x int y = x == y x run_pass refine_integer_values foo graph run_pass constant_propagation foo graph run_pass dce foo graph FileCheck check graph check_next run foo graph assertEqual foo assertEqual foo test_peephole_len_list torch jit script foo x len x size run_pass peephole foo graph FileCheck check aten len run foo graph inputs = list foo graph inputs inputs setType inputs type with_sizes None None run_pass peephole foo graph FileCheck check_not aten len run foo graph assertEqual foo torch rand torch jit script foo x li = x size li append len li inputs = list foo graph inputs inputs setType inputs type with_sizes None None run_pass peephole foo graph FileCheck check aten len run foo graph assertEqual foo torch rand test_peephole_optional_refine torch jit script foo z int z int cond bool cond z z out = next foo graph findNode prim If outputs out setType torch _C OptionalType torch _C IntType get run_pass peephole foo graph FileCheck check_not int run foo graph test_peephole_int torch jit script foo x type number int x FileCheck check aten Int run foo graph next foo graph inputs setType torch _C IntType get run_pass peephole foo graph FileCheck check_not aten Int run foo graph test_peephole_arith torch jit script foo input int input int input int input int _ = torch add input _ = torch add input _ = torch add torch sub _ _ = torch add torch sub _ _ int _ FileCheck check aten add check aten sub check aten mul check aten floordiv check aten div run foo graph run_pass peephole foo graph FileCheck check graph check check_next ListConstruct check_next run foo graph assertEqual foo test_peephole_dict_getitem_simple torch jit script foo int b int d = b x = d y = d x y run_pass peephole foo graph FileCheck check_not DictConstruct check_not __getitem__ run foo graph assertEqual foo torch jit script foo int b int d = b x = d y = d x y run_pass peephole foo graph FileCheck check_not DictConstruct check_not __getitem__ run foo graph assertEqual foo torch jit script foo int b int d = b x = d y = d x y run_pass peephole foo graph FileCheck check_not DictConstruct check_not __getitem__ run foo graph assertEqual foo test_peephole_dict_getitem_no_optimization_missing_key torch jit script foo d = d run_pass peephole foo graph FileCheck check DictConstruct check __getitem__ run foo graph test_peephole_dict_getitem_no_optimization_get_input_arg Here we don t know input arg dict so we can t make optimization torch jit script foo int d = d run_pass peephole foo graph FileCheck check DictConstruct check __getitem__ run foo graph assertEqual foo test_peephole_dict_getitem_no_optimization_dict_modified torch jit script foo d = d = d run_pass peephole foo graph FileCheck check DictConstruct check __getitem__ run foo graph assertEqual foo test_peephole_dict_getitem_no_optimization_overlapping_keys torch jit script foo d = noqa F d run_pass peephole foo graph FileCheck check DictConstruct check __getitem__ run foo graph test_peephole_dict_getitem_no_optimization_keys_might_overlap torch jit script foo x int d = x d x run_pass peephole foo graph FileCheck check DictConstruct check __getitem__ run foo graph test_peephole_dict_getitem_no_optimization_unsupported_type torch jit script foo = torch rand d = d run_pass peephole foo graph FileCheck check DictConstruct check __getitem__ run foo graph assertEqual foo test_peephole_dict_len torch jit script foo d = len d run_pass peephole foo graph FileCheck check_not DictConstruct check_not len run foo graph assertEqual foo test_peephole_dict_len_no_optimization_overlapping_keys torch jit script foo d = noqa F len d run_pass peephole foo graph FileCheck check DictConstruct check len run foo graph assertEqual foo test_peephole_dict_len_no_optimization_keys_might_overlap torch jit script foo x int d = x len d run_pass peephole foo graph FileCheck check DictConstruct check len run foo graph test_peephole_dict_len_no_optimization_unsupported_type torch jit script foo = torch rand d = len d run_pass peephole foo graph FileCheck check DictConstruct check len run foo graph assertEqual foo test_peephole_slice_all_three_args foo x int x - graph = torch jit script foo graph run_pass peephole graph FileCheck check_not aten slice run graph checkScript foo test_peephole_slice_one_empty_arg check_helper fn Callable int None - None graph = torch jit script fn graph run_pass peephole graph FileCheck check_not aten slice run graph checkScript fn foo x int x check_helper foo foo x int x check_helper foo foo x int x check_helper foo test_peephole_slice_two_empty_args check_helper fn Callable int None - None graph = torch jit script fn graph run_pass peephole graph FileCheck check_not aten slice run graph checkScript fn foo x int x check_helper foo foo x int x check_helper foo foo x int x check_helper foo test_peephole_slice_optimization_not_applied_list_modified torch jit script foo li = li = li run_pass peephole foo graph FileCheck check aten slice run foo graph test_peephole_slice_optimization_not_applied_non_const_args torch jit script foo x int y int li = li x y run_pass peephole foo graph FileCheck check aten slice run foo graph __name__ == __main__ raise_on_run_directly test test_jit py
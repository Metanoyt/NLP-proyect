Owner s module inductor copy importlib itertools os sys torch torch nn Make helper files test importable pytorch_test_dir = os path dirname os path dirname os path realpath __file__ sys path append pytorch_test_dir torch _dynamo utils counters torch _inductor config inductor_config torch _inductor test_case TestCase torch testing _internal common_cuda tf _on_and_off torch testing _internal inductor_utils GPU_TYPE HAS_CPU HAS_GPU importlib import_module functorch importlib import_module filelock inductor test_torchinductor manual=fbcode caffe test inductor test_inductor-library copy_tests ConvOp nn Module expected_optimization_count = __init__ conv_class bn_class use_bias in_channels out_channels device kwargs super __init__ conv = conv_class in_channels out_channels bias=use_bias kwargs device bn = bn_class out_channels device forward x x = conv x bn x MultiUserConvOp nn Module expected_optimization_count = __init__ conv_class bn_class use_bias in_channels out_channels device kwargs super __init__ conv = conv_class in_channels out_channels bias=use_bias kwargs device bn = bn_class out_channels device conv = conv_class out_channels out_channels bias=use_bias kwargs device bn = bn_class out_channels device conv = conv_class out_channels out_channels bias=use_bias kwargs device bn = bn_class out_channels device forward x conv-bn pair can use efficient_conv_bn_eval x = bn conv input=x conv-bn pair cannot use efficient_conv_bn_eval feature just second forward ` conv ` x = bn input=self conv conv x conv-bn pair can use efficient_conv_bn_eval feature just first forward ` bn ` test multiple users one computation node x = bn input=self conv input=x x = bn x + x x EfficientConvBNEvalTemplate TestCase tf _on_and_off inductor_config patch efficient_conv_bn_eval_fx_passes True test_basic test_conv_bn_eval test_class use_bias module sync_bn decompose_nn_module functorch make_fx torch _dispatch python enable_python_dispatcher kwargs = kernel_size stride module = nn Linear mod_eager = test_class module module use_bias device kwargs eval Copy module test backward mod_optimized = copy deepcopy mod_eager sync_bn mod_eager = nn SyncBatchNorm convert_sync_batchnorm mod_eager eval mod_optimized = nn SyncBatchNorm convert_sync_batchnorm mod_optimized eval torch _dynamo reset inps = Conv shape goes big small ConvTranspose shape goes small big spatial_d = issubclass module nn modules conv _ConvTransposeNd module nn Conv d module nn ConvTranspose d inps += spatial_d module nn Conv d module nn ConvTranspose d inps += spatial_d module nn Conv d module nn ConvTranspose d inps += spatial_d inp = torch rand inps device decompose_nn_module enable_python_dispatcher mod_optimized = make_fx mod_optimized pre_dispatch=True inp mod_optimized = torch compile mod_optimized original_value = counters inductor efficient_conv_bn_eval optim_eager = torch optim SGD mod_eager parameters lr= e- optim_optimized = torch optim SGD mod_optimized parameters lr= e- optim_eager zero_grad optim_optimized zero_grad test forward out_eager = mod_eager inp out_optimized = mod_optimized inp assertEqual out_optimized out_eager out_eager mean backward out_optimized mean backward optim_eager step optim_optimized step test forward testing forward again after one training iteration inp_bw = torch rand_like inp out_eager_bw = mod_eager inp_bw out_optimized_bw = mod_optimized inp_bw assertEqual out_eager_bw out_optimized_bw current_value = counters inductor efficient_conv_bn_eval assertEqual current_value - original_value test_class expected_optimization_count conv_bias = True False modules = nn Linear nn BatchNorm d nn Conv d nn BatchNorm d nn Conv d nn BatchNorm d nn Conv d nn BatchNorm d nn ConvTranspose d nn BatchNorm d nn ConvTranspose d nn BatchNorm d nn ConvTranspose d nn BatchNorm d test_classes = ConvOp MultiUserConvOp sync_bns = False True decompose_nn_modules = False True test_class use_bias module sync_bn decompose_nn_module itertools product test_classes conv_bias modules sync_bns decompose_nn_modules test_conv_bn_eval test_class use_bias module sync_bn decompose_nn_module HAS_CPU torch backends mps is_available EfficientConvBNEvalCpuTests TestCase device = cpu copy_tests EfficientConvBNEvalTemplate EfficientConvBNEvalCpuTests cpu HAS_GPU EfficientConvBNEvalGpuTests TestCase device = GPU_TYPE copy_tests EfficientConvBNEvalTemplate EfficientConvBNEvalGpuTests GPU_TYPE del EfficientConvBNEvalTemplate __name__ == __main__ torch _inductor test_case run_tests HAS_CPU HAS_GPU run_tests needs= filelock
Adapter https github com charliermarsh ruff __future__ annotations argparse concurrent futures dataclasses enum json logging os subprocess sys time typing Any BinaryIO LINTER_CODE = RUFF SYNTAX_ERROR = E IS_WINDOWS bool = os name == nt LintSeverity str enum Enum Severity lint message ERROR = error WARNING = warning ADVICE = advice DISABLED = disabled dataclasses dataclass frozen=True LintMessage A lint message defined https docs rs lintrunner latest lintrunner lint_message struct LintMessage html path str &#124; None line int &#124; None char int &#124; None code str severity LintSeverity name str original str &#124; None replacement str &#124; None description str &#124; None asdict - dict str Any dataclasses asdict display - None Print stdout lintrunner consume print json dumps asdict flush=True as_posix name str - str name replace \\ IS_WINDOWS name _run_command args list str timeout int &#124; None stdin BinaryIO &#124; None input bytes &#124; None check bool cwd os PathLike Any &#124; None - subprocess CompletedProcess bytes logging debug $ s join args start_time = time monotonic try input None subprocess run args capture_output=True shell=False input=input timeout=timeout check=check cwd=cwd subprocess run args stdin=stdin capture_output=True shell=False timeout=timeout check=check cwd=cwd finally end_time = time monotonic logging debug took dms end_time - start_time run_command args list str retries int = timeout int &#124; None = None stdin BinaryIO &#124; None = None input bytes &#124; None = None check bool = False cwd os PathLike Any &#124; None = None - subprocess CompletedProcess bytes remaining_retries = retries while True try _run_command args timeout=timeout stdin=stdin input=input check=check cwd=cwd except subprocess TimeoutExpired err remaining_retries == raise err remaining_retries -= logging warning noqa G s s Retrying because command failed r retries - remaining_retries retries err time sleep add_default_options parser argparse ArgumentParser - None Add default options parser This should called last chain add_argument calls parser add_argument -- retries type=int default= help= number times retry linter times out parser add_argument -- verbose action= store_true help= verbose logging parser add_argument filenames nargs= + help= paths lint explain_rule code str - str proc = run_command ruff rule -- output-format=json code check=True rule = json loads str proc stdout utf- strip f \n rule linter rule summary get_issue_severity code str - LintSeverity B ` x ` inside generator B Invalid first argument method B __slots__ efficiency B Line too long C Flake Comprehensions C Cyclomatic complexity E PEP horizontal whitespace errors E PEP blank line errors E PEP line length errors T type checking Notes T internal type checker errors unmatched messages any code startswith x x B C C E E E T T PLC PLR LintSeverity ADVICE F Undefined name E syntax error any code startswith x x F SYNTAX_ERROR PLE LintSeverity ERROR F PyFlakes Error B flake -bugbear Error E PEP Error W PEP Warning possibly other plugins LintSeverity WARNING format_lint_message message str code str rules dict str str show_disable bool - str rules message += f \n rules get code message += \nSee https beta ruff rs docs rules show_disable message += f \n\nTo disable use ` noqa code ` message check_files filenames list str severities dict str LintSeverity config str &#124; None retries int timeout int explain bool show_disable bool - list LintMessage try proc = run_command sys executable -m ruff check -- exit-zero -- quiet -- output-format=json f -- config= config config filenames retries=retries timeout=timeout check=True except OSError subprocess CalledProcessError err LintMessage path=None line=None char=None code=LINTER_CODE severity=LintSeverity ERROR name= command-failed original=None replacement=None description= f Failed due err __class__ __name__ \n err isinstance err subprocess CalledProcessError f COMMAND exit code err returncode \n f join as_posix x x err cmd \n\n f STDERR\n err stderr decode utf- strip empty \n\n f STDOUT\n err stdout decode utf- strip empty stdout = str proc stdout utf- strip vulnerabilities = json loads stdout explain all_codes = v code v vulnerabilities rules = code explain_rule code code all_codes rules = lint_message vuln dict str Any - LintMessage code = vuln code SYNTAX_ERROR LintMessage path=vuln filename name=code description= format_lint_message vuln message code rules show_disable bool vuln code line=int vuln location row char=int vuln location column code=LINTER_CODE severity=severities get code get_issue_severity code original=None replacement=None lint_message v v vulnerabilities check_file_for_fixes filename str config str &#124; None retries int timeout int - list LintMessage try open filename rb f original = f read open filename rb f proc_fix = run_command sys executable -m ruff check -- fix-only -- exit-zero f -- config= config config -- stdin-filename filename - stdin=f retries=retries timeout=timeout check=True except OSError subprocess CalledProcessError err LintMessage path=None line=None char=None code=LINTER_CODE severity=LintSeverity ERROR name= command-failed original=None replacement=None description= f Failed due err __class__ __name__ \n err isinstance err subprocess CalledProcessError f COMMAND exit code err returncode \n f join as_posix x x err cmd \n\n f STDERR\n err stderr decode utf- strip empty \n\n f STDOUT\n err stdout decode utf- strip empty replacement = proc_fix stdout original == replacement LintMessage path=filename name= format description= Run ` lintrunner -a ` apply patch line=None char=None code=LINTER_CODE severity=LintSeverity WARNING original=original decode utf- replacement=replacement decode utf- main - None parser = argparse ArgumentParser description=f Ruff linter Linter code LINTER_CODE Use RUFF-FIX auto-fix issues fromfile_prefix_chars= parser add_argument -- config default=None help= Path ` pyproject toml ` ` ruff toml ` file use configuration parser add_argument -- explain action= store_true help= Explain rule parser add_argument -- show-disable action= store_true help= Show how disable lint message parser add_argument -- timeout default= type=int help= Seconds wait ruff parser add_argument -- severity action= append help= map code severity e g ` F advice ` This option can used multiple times parser add_argument -- no-fix action= store_true help= Do suggest fixes add_default_options parser args = parser parse_args logging basicConfig format= threadName s levelname s message s level=logging NOTSET args verbose logging DEBUG len args filenames logging INFO stream=sys stderr severities dict str LintSeverity = args severity severity args severity parts = severity split assert len parts == f invalid severity ` severity ` severities parts = LintSeverity parts lint_messages = check_files args filenames severities=severities config=args config retries=args retries timeout=args timeout explain=args explain show_disable=args show_disable lint_message lint_messages lint_message display args no_fix lint_messages If we re fixing we can exit early files_with_lints = lint path lint lint_messages lint path None concurrent futures ThreadPoolExecutor max_workers=os cpu_count thread_name_prefix= Thread executor futures = executor submit check_file_for_fixes path config=args config retries=args retries timeout=args timeout path path files_with_lints future concurrent futures as_completed futures try lint_message future result lint_message display except Exception Catch all exceptions lintrunner logging critical Failed s futures future raise __name__ == __main__ main
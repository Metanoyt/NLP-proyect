Owner s module inductor __future__ annotations pickle concurrent futures ThreadPoolExecutor inspect isclass os environ pathlib Path random randint tempfile gettempdir typing Any TYPE_CHECKING typing_extensions Self unittest mock patch torch _inductor cache icache torch _inductor test_case run_tests TestCase torch testing _internal common_utils instantiate_parametrized_tests parametrize TYPE_CHECKING collections abc Callable Sequence TestMixin staticmethod abstract_cache_types - set type icache Cache icache Cache icache AsyncCache staticmethod cache_types - Sequence type icache Cache cache_types list type icache Cache = obj_name dir icache obj = getattr icache obj_name isclass obj issubclass obj icache Cache continue obj TestMixin abstract_cache_types continue cache_types append obj cache_types staticmethod async_cache_types - Sequence type icache AsyncCache cache_type cache_type TestMixin cache_types issubclass cache_type icache AsyncCache staticmethod on_disk_cache_types - Sequence type icache OnDiskCache cache_type cache_type TestMixin cache_types issubclass cache_type icache OnDiskCache staticmethod key_types - Sequence type icache Key icache Key __constraints__ staticmethod value_types - Sequence type icache Value icache Value __constraints__ staticmethod cache_type_supports_key_and_value_types cache_type type icache Cache key_type type icache Key value_type type icache Value - bool assert len cache_type __orig_bases__ == generic_base = cache_type __orig_bases__ _key_type _value_type = generic_base __args__ _key_type = icache Key _key_type = key_type _value_type = icache Value _value_type = value_type False True key_not_in Self cache icache Cache icache Key icache Value key_fn Callable icache Key - icache Key while cache get key = key_fn None continue key keys_not_in Self cache icache Cache icache Key icache Value key_fn Callable icache Key num int - list icache Key keys = while len keys num key = key_not_in cache key_fn keys keys append key keys key Self key_type type icache Key - icache Key key_type str f s randint key_type int randint key_type == tuple Any key str key int raise NotImplementedError values_unalike Self value_fn Callable icache Value num int - list icache Value values = while len values num value = value_fn values values append value values value Self value_type type icache Value - icache Value value_type str f s randint value_type int randint value_type == tuple Any value str value int value_type bytes value str encode value_type == dict Any Any zero value str value int value tuple Any b three value bytes value_type == list Any value str value int value dict Any Any raise NotImplementedError maybe_randomize_base_dir Self cache icache Cache - None multi disk caches might exist any time tests assume they isolated so we should randomize their base dir isinstance cache icache OnDiskCache cache base_dir = cache base_dir f hash cache instantiate_parametrized_tests CacheTest TestMixin TestCase parametrize cache_type TestMixin cache_types parametrize key_type TestMixin key_types parametrize value_type TestMixin value_types test_get Self cache_type type icache Cache key_type type icache Key value_type type icache Value - None Checks cache returns None missing keys after insertion returns correct value each key cache_type_supports_key_and_value_types cache_type key_type value_type cache icache Cache = cache_type maybe_randomize_base_dir cache key_ key_ = keys_not_in cache lambda key key_type value_ value_ = values_unalike lambda value value_type assertIsNone cache get key_ assertIsNone cache get key_ assertTrue cache insert key_ value_ assertTrue cache insert key_ value_ assertEqual cache get key_ value_ assertEqual cache get key_ value_ parametrize cache_type TestMixin cache_types parametrize key_type TestMixin key_types parametrize value_type TestMixin value_types test_insert Self cache_type type icache Cache key_type type icache Key value_type type icache Value - None Verifies inserting new key succeeds inserting same key again fails value key remains first inserted value cache_type_supports_key_and_value_types cache_type key_type value_type cache icache Cache = cache_type maybe_randomize_base_dir cache key = key_not_in cache lambda key key_type value_ value_ = values_unalike lambda value value_type assertIsNone cache get key assertTrue cache insert key value_ assertFalse cache insert key value_ assertEqual cache get key value_ parametrize cache_type TestMixin cache_types parametrize key_type TestMixin key_types parametrize value_type TestMixin value_types test_get_concurrent Self cache_type type icache Cache key_type type icache Key value_type type icache Value - None Ensures concurrent reads get cache correct values all inserted keys even under parallel access cache_type_supports_key_and_value_types cache_type key_type value_type executor iters = ThreadPoolExecutor cache icache Cache = cache_type maybe_randomize_base_dir cache keys = keys_not_in cache lambda key key_type iters values = values_unalike lambda value value_type iters key value zip keys values assertIsNone cache get key assertTrue cache insert key value gets = executor map cache get keys value get zip values gets assertEqual get value executor shutdown parametrize cache_type TestMixin cache_types parametrize key_type TestMixin key_types parametrize value_type TestMixin value_types test_insert_concurrent Self cache_type type icache Cache key_type type icache Key value_type type icache Value - None Ensures concurrent inserts work expected only first insert each key succeeds cache contains correct value each key after all inserts cache_type_supports_key_and_value_types cache_type key_type value_type executor iters = ThreadPoolExecutor cache icache Cache = cache_type maybe_randomize_base_dir cache keys = keys_not_in cache lambda key key_type iters values = values_unalike lambda value value_type iters key keys assertIsNone cache get key inserts = executor map cache insert keys values inserted = key value insert zip keys values inserts insert assertEqual cache get key value assertTrue key inserted inserted key = value assertTrue set keys == set inserted keys key value inserted items assertEqual cache get key value executor shutdown parametrize cache_type TestMixin cache_types parametrize key_type TestMixin key_types parametrize value_type TestMixin value_types parametrize get_first True False test_combo_concurrent Self cache_type type icache Cache key_type type icache Key value_type type icache Value get_first bool - None Tests mix concurrent get insert operations order operations varied get_first parameter ensure correctness under interleaved access cache_type_supports_key_and_value_types cache_type key_type value_type executor iters = ThreadPoolExecutor cache icache Cache = cache_type maybe_randomize_base_dir cache keys = keys_not_in cache lambda key key_type iters values = values_unalike lambda value value_type iters key keys assertIsNone cache get key get_futures insert_futures = key value zip keys values get_first get_futures append executor submit cache get key insert_futures append executor submit cache insert key value insert_futures append executor submit cache insert key value get_futures append executor submit cache get key inserted = key value get_future insert_future zip keys values get_futures insert_futures get = get_future result None insert_future result assertEqual get value assertTrue key inserted inserted key = value insert_future result assertTrue key inserted inserted key = value assertTrue set keys == set inserted keys key value inserted items assertEqual cache get key value executor shutdown instantiate_parametrized_tests AsyncCacheTest TestMixin TestCase parametrize async_cache_type TestMixin async_cache_types parametrize key_type TestMixin key_types parametrize value_type TestMixin value_types test_get_async Self async_cache_type type icache AsyncCache key_type type icache Key value_type type icache Value - None Verifies asynchronous get insert operations work expected get_async returns None missing keys insert_async inserts values get_async returns correct value after insertion cache_type_supports_key_and_value_types async_cache_type key_type value_type async_cache icache AsyncCache = async_cache_type maybe_randomize_base_dir async_cache key_ key_ = keys_not_in async_cache lambda key key_type value_ value_ = values_unalike lambda value value_type executor = ThreadPoolExecutor get_ = async_cache get_async key_ executor get_ = async_cache get_async key_ executor assertIsNone get_ result assertIsNone get_ result insert_ = async_cache insert_async key_ value_ executor insert_ = async_cache insert_async key_ value_ executor assertTrue insert_ result assertTrue insert_ result get_ = async_cache get_async key_ executor get_ = async_cache get_async key_ executor assertEqual get_ result value_ assertEqual get_ result value_ executor shutdown parametrize async_cache_type TestMixin async_cache_types parametrize key_type TestMixin key_types parametrize value_type TestMixin value_types test_insert_async Self async_cache_type type icache AsyncCache key_type type icache Key value_type type icache Value - None Ensures only one two concurrent insert_async calls same key succeeds cache contains value successful insert cache_type_supports_key_and_value_types async_cache_type key_type value_type async_cache icache AsyncCache = async_cache_type maybe_randomize_base_dir async_cache key = key_not_in async_cache lambda key key_type value_ value_ = values_unalike lambda value value_type executor = ThreadPoolExecutor get = async_cache get_async key executor assertIsNone get result insert_ = async_cache insert_async key value_ executor insert_ = async_cache insert_async key value_ executor assertTrue insert_ result ^ insert_ result get = async_cache get_async key executor insert_ result assertEqual get result value_ assertEqual get result value_ executor shutdown parametrize async_cache_type TestMixin async_cache_types parametrize key_type TestMixin key_types parametrize value_type TestMixin value_types test_get_async_concurrent Self async_cache_type type icache AsyncCache key_type type icache Key value_type type icache Value - None Ensures concurrent asynchronous get operations correct values all inserted keys cache_type_supports_key_and_value_types async_cache_type key_type value_type executor iters = ThreadPoolExecutor async_cache icache AsyncCache = async_cache_type maybe_randomize_base_dir async_cache keys = keys_not_in async_cache lambda key key_type iters values = values_unalike lambda value value_type iters key value zip keys values assertIsNone async_cache get key assertTrue async_cache insert key value gets = executor map lambda key async_cache get_async key executor keys value get zip values gets assertEqual get result value executor shutdown parametrize async_cache_type TestMixin async_cache_types parametrize key_type TestMixin key_types parametrize value_type TestMixin value_types test_insert_async_concurrent Self async_cache_type type icache AsyncCache key_type type icache Key value_type type icache Value - None Ensures concurrent asynchronous insert operations only allow first insert each key succeed cache contains correct value each key cache_type_supports_key_and_value_types async_cache_type key_type value_type executor iters = ThreadPoolExecutor async_cache icache AsyncCache = async_cache_type maybe_randomize_base_dir async_cache keys = keys_not_in async_cache lambda key key_type iters values = values_unalike lambda value value_type iters key keys assertIsNone async_cache get key inserts = executor map lambda key value async_cache insert_async key value executor keys values inserted = key value insert zip keys values inserts insert result assertEqual async_cache get key value assertTrue key inserted inserted key = value assertTrue set keys == set inserted keys key value inserted items assertTrue async_cache get key value executor shutdown parametrize async_cache_type TestMixin async_cache_types parametrize key_type TestMixin key_types parametrize value_type TestMixin value_types parametrize get_first True False test_combo_async_concurrent Self async_cache_type type icache AsyncCache key_type type icache Key value_type type icache Value get_first bool - None Tests mix concurrent asynchronous get insert operations order operations varied get_first parameter ensure correctness under interleaved async access cache_type_supports_key_and_value_types async_cache_type key_type value_type executor iters = ThreadPoolExecutor async_cache icache AsyncCache = async_cache_type maybe_randomize_base_dir async_cache keys = keys_not_in async_cache lambda key key_type iters values = values_unalike lambda value value_type iters key keys assertIsNone async_cache get key get_futures insert_futures = key value zip keys values get_first get_futures append async_cache get_async key executor insert_futures append async_cache insert_async key value executor insert_futures append async_cache insert_async key value executor get_futures append async_cache get_async key executor inserted = key value get_future insert_future zip keys values get_futures insert_futures get = get_future result None insert_future result assertEqual get value assertTrue key inserted inserted key = value insert_future result assertTrue key inserted inserted key = value assertTrue set keys == set inserted keys key value inserted items assertEqual async_cache get key value executor shutdown instantiate_parametrized_tests OtherTest TestMixin TestCase parametrize key_type TestMixin key_types parametrize value_type TestMixin value_types parametrize with_whitespace True False parametrize with_semicolon_suffix True False test_in_memory_cache_from_env_var Self key_type type icache Key value_type type icache Value with_whitespace bool with_semicolon_suffix bool - None Verifies InMemoryCache from_env_var correctly parses environment variables various whitespace semicolon suffixes loads all key-value pairs keys = keys_not_in icache InMemoryCache lambda key key_type values = values_unalike lambda value value_type ws = with_whitespace env_var = IN_MEMORY_CACHE_FROM_ENV_VAR_TEST env_val = join f ws pickle dumps key r ws ws pickle dumps value r ws key value zip keys values + with_semicolon_suffix environ env_var = env_val cache = icache InMemoryCache from_env_var env_var key value zip keys values assertEqual cache get key value parametrize key_type TestMixin key_types parametrize value_type TestMixin value_types test_in_memory_cache_from_env_var_missing_comma_separator Self key_type type icache Key value_type type icache Value - None Ensures InMemoryCache from_env_var raises CacheError environment variable missing required comma separator between key value keys = keys_not_in icache InMemoryCache lambda key key_type values = values_unalike lambda value value_type env_var = IN_MEMORY_CACHE_FROM_ENV_VAR_MISSING_COMMA_SEPARATOR_TEST env_val = join f pickle dumps key r pickle dumps value r key value zip keys values environ env_var = env_val assertRaises icache CacheError _ = icache InMemoryCache from_env_var env_var parametrize key_type TestMixin key_types parametrize value_type TestMixin value_types test_in_memory_cache_from_env_var_bad_encoding Self key_type type icache Key value_type type icache Value - None Ensures InMemoryCache from_env_var raises CacheError key value encoding environment variable invalid valid Python literal keys = keys_not_in icache InMemoryCache lambda key key_type values = values_unalike lambda value value_type env_var = IN_MEMORY_CACHE_FROM_ENV_VAR_BAD_ENCODING_TEST env_val = join f pickle dumps key r pickle dumps value r key value zip keys values environ env_var = env_val assertRaises icache CacheError _ = icache InMemoryCache from_env_var env_var parametrize key_type TestMixin key_types parametrize value_type TestMixin value_types test_in_memory_cache_from_env_var_not_un_pickle_able Self key_type type icache Key value_type type icache Value - None Ensures InMemoryCache from_env_var raises CacheError key value cannot unpickled e g due data corruption keys = keys_not_in icache InMemoryCache lambda key key_type values = values_unalike lambda value value_type env_var = IN_MEMORY_CACHE_FROM_ENV_VAR_NOT_UN_PICKLE_ABLE_TEST env_val = join f pickle dumps key - r pickle dumps value - r key value zip keys values environ env_var = env_val assertRaises icache CacheError _ = icache InMemoryCache from_env_var env_var parametrize key_type TestMixin key_types parametrize value_type TestMixin value_types test_in_memory_cache_from_env_var_duplicated_entries Self key_type type icache Key value_type type icache Value - None Verifies duplicate key-value pairs allowed value consistent raises CacheError same key appears different values keys = keys_not_in icache InMemoryCache lambda key key_type values = values_unalike lambda value value_type env_var = IN_MEMORY_CACHE_FROM_ENV_VAR_DUPLICATED_ENTRIES_TEST env_val = join f pickle dumps key r pickle dumps value r key value zip keys values environ env_var = env_val duplicate key = value entries okay long value consistent cache = icache InMemoryCache from_env_var env_var key value zip keys values assertEqual cache get key value keys = keys_not_in icache InMemoryCache lambda key key_type values = values_unalike lambda value value_type env_var = IN_MEMORY_CACHE_FROM_ENV_VAR_DUPLICATED_ENTRIES_TEST env_val = join f pickle dumps key r pickle dumps value r key value zip keys values environ env_var = env_val duplicate key = value entries inconsistent values okay assertRaises icache CacheError _ = icache InMemoryCache from_env_var env_var parametrize key_type TestMixin key_types parametrize value_type TestMixin value_types test_in_memory_cache_from_file_path Self key_type type icache Key value_type type icache Value - None Checks InMemoryCache from_file_path correctly loads cache file containing pickled dictionary key-value pairs keys = keys_not_in icache InMemoryCache lambda key key_type values = values_unalike lambda value value_type cache = icache InMemoryCache key value zip keys values assertTrue cache insert key value fpath = Path gettempdir IN_MEMORY_CACHE_FROM_FILE_PATH_TEST open fpath wb fp pickle dump cache _cache fp from_file_path_cache = icache InMemoryCache from_file_path fpath key value zip keys values assertEqual from_file_path_cache get key value parametrize key_type TestMixin key_types parametrize value_type TestMixin value_types test_in_memory_cache_from_file_path_not_un_pickle_able Self key_type type icache Key value_type type icache Value - None Ensures InMemoryCache from_file_path raises CacheError file contents cannot unpickled e g due corruption keys = keys_not_in icache InMemoryCache lambda key key_type values = values_unalike lambda value value_type cache = icache InMemoryCache key value zip keys values assertTrue cache insert key value fpath = Path gettempdir IN_MEMORY_CACHE_FROM_FILE_PATH_NOT_UN_PICKLE_ABLE_TEST open fpath wb fp pickled_cache = pickle dumps cache _cache pickled_cache = pickled_cache - fp write pickled_cache assertRaises icache CacheError _ = icache InMemoryCache from_file_path fpath test_in_memory_cache_from_file_path_not_dict Self - None This test verifies InMemoryCache from_file_path raises CacheError when file does contain pickled dictionary It writes pickled list temporary file then attempts load cache The cache expects dictionary structure loading non-dictionary should raise error fpath = Path gettempdir IN_MEMORY_CACHE_FROM_FILE_PATH_NOT_DICT_TEST open fpath wb fp pickled_cache = pickle dumps fp write pickled_cache assertRaises icache CacheError _ = icache InMemoryCache from_file_path fpath parametrize on_disk_cache_type TestMixin on_disk_cache_types test_on_disk_cache_fpath_from_key_un_pickle_able Self on_disk_cache_type type icache OnDiskCache - None This test checks _fpath_from_key raises CacheError when given key cannot pickled It passes lambda function which pickle-able key The cache uses pickling serialize keys file storage If key cannot pickled cache should fail gracefully raise clear error cache icache OnDiskCache = on_disk_cache_type un_pickle_able_key = lambda None noqa E assertRaises icache CacheError _ = cache _fpath_from_key un_pickle_able_key parametrize on_disk_cache_type TestMixin on_disk_cache_types test_on_disk_cache_version_bump Self on_disk_cache_type type icache OnDiskCache - None This test ensures cache entries invalidated when cache version changes new entries can inserted retrieved after version bump It inserts key-value pair then simulates version bump patching cache version After version change verifies old entry no longer retrievable invalidated new entry can inserted retrieved Versioning used invalidate stale cache entries when cache format logic changes cache icache OnDiskCache = on_disk_cache_type key = key_not_in cache lambda key str value = value str assertIsNone cache get key assertTrue cache insert key value assertEqual cache get key value old_version = icache OnDiskCache version bump_version = old_version + patch object icache OnDiskCache version bump_version assertIsNone cache get key assertTrue cache insert key value assertEqual cache get key value assertIsNone cache get key assertTrue cache insert key value assertEqual cache get key value __name__ == __main__ run_tests
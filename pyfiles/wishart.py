mypy allow-untyped-defs math warnings typing Optional Union torch torch nan Tensor torch distributions constraints torch distributions exp_family ExponentialFamily torch distributions multivariate_normal _precision_to_scale_tril torch distributions utils lazy_property torch types _Number _size Number __all__ = Wishart _log_ = math log _mvdigamma x Tensor p int - Tensor assert x gt p - all Wrong domain multivariate digamma function torch digamma x unsqueeze - - torch arange p dtype=x dtype device=x device div expand x shape + - sum - _clamp_above_eps x Tensor - Tensor We assume positive input function x clamp min=torch finfo x dtype eps Wishart ExponentialFamily r Creates Wishart distribution parameterized symmetric positive definite matrix math ` \Sigma ` its Cholesky decomposition math ` \mathbf \Sigma = \mathbf L \mathbf L ^\top ` Example xdoctest +SKIP FIXME scale_tril must least two-dimensional m = Wishart torch Tensor covariance_matrix=torch eye m sample Wishart distributed mean= ` df I ` variance x_ij = ` df ` i = j variance x_ij = ` df ` i == j Args df float Tensor real-valued parameter larger than dimension Square matrix - covariance_matrix Tensor positive-definite covariance matrix precision_matrix Tensor positive-definite precision matrix scale_tril Tensor lower-triangular factor covariance positive-valued diagonal Note Only one attr ` covariance_matrix ` attr ` precision_matrix ` attr ` scale_tril ` can specified Using attr ` scale_tril ` will more efficient all computations internally based attr ` scale_tril ` If attr ` covariance_matrix ` attr ` precision_matrix ` passed instead only used compute corresponding lower triangular matrices using Cholesky decomposition torch distributions LKJCholesky restricted Wishart distribution References Wang Z Wu Y Chu H ` On equivalence LKJ distribution restricted Wishart distribution ` Sawyer S ` Wishart Distributions Inverse-Wishart Sampling ` Anderson T W ` An Introduction Multivariate Statistical Analysis rd ed ` Odell P L Feiveson A H ` A Numerical Procedure Generate SampleCovariance Matrix ` JASA - Ku Y -C Bloomfield P ` Generating Random Wishart Matrices Fractional Degrees Freedom OX ` support = constraints positive_definite has_rsample = True _mean_carrier_measure = property arg_constraints covariance_matrix constraints positive_definite precision_matrix constraints positive_definite scale_tril constraints lower_cholesky df constraints greater_than event_shape - - __init__ df Union Tensor Number covariance_matrix Optional Tensor = None precision_matrix Optional Tensor = None scale_tril Optional Tensor = None validate_args Optional bool = None - None assert covariance_matrix None + scale_tril None + precision_matrix None == Exactly one covariance_matrix precision_matrix scale_tril may specified param = next p p covariance_matrix precision_matrix scale_tril p None param dim raise ValueError scale_tril must least two-dimensional optional leading batch dimensions isinstance df _Number batch_shape = torch Size param shape - df = torch tensor df dtype=param dtype device=param device batch_shape = torch broadcast_shapes param shape - df shape df = df expand batch_shape event_shape = param shape - df le event_shape - - any raise ValueError f Value df= df expected greater than ndim - = event_shape - - scale_tril None pyrefly ignore read-only scale_tril = param expand batch_shape + - - covariance_matrix None pyrefly ignore read-only covariance_matrix = param expand batch_shape + - - precision_matrix None pyrefly ignore read-only precision_matrix = param expand batch_shape + - - df lt event_shape - any warnings warn Low df values detected Singular samples highly likely occur ndim - df ndim stacklevel= super __init__ batch_shape event_shape validate_args=validate_args _batch_dims = - x + x range len _batch_shape scale_tril None _unbroadcasted_scale_tril = scale_tril covariance_matrix None _unbroadcasted_scale_tril = torch linalg cholesky covariance_matrix precision_matrix None _unbroadcasted_scale_tril = _precision_to_scale_tril precision_matrix Chi distribution needed Bartlett decomposition sampling _dist_chi = torch distributions chi Chi df= df unsqueeze - - torch arange _event_shape - dtype=self _unbroadcasted_scale_tril dtype device=self _unbroadcasted_scale_tril device expand batch_shape + - expand batch_shape _instance=None new = _get_checked_instance Wishart _instance batch_shape = torch Size batch_shape cov_shape = batch_shape + event_shape new _unbroadcasted_scale_tril = _unbroadcasted_scale_tril expand cov_shape new df = df expand batch_shape new _batch_dims = - x + x range len batch_shape covariance_matrix __dict__ new covariance_matrix = covariance_matrix expand cov_shape scale_tril __dict__ new scale_tril = scale_tril expand cov_shape precision_matrix __dict__ new precision_matrix = precision_matrix expand cov_shape Chi distribution needed Bartlett decomposition sampling new _dist_chi = torch distributions chi Chi df= new df unsqueeze - - torch arange event_shape - dtype=new _unbroadcasted_scale_tril dtype device=new _unbroadcasted_scale_tril device expand batch_shape + - super Wishart new __init__ batch_shape event_shape validate_args=False new _validate_args = _validate_args new lazy_property scale_tril - Tensor _unbroadcasted_scale_tril expand _batch_shape + _event_shape lazy_property covariance_matrix - Tensor _unbroadcasted_scale_tril _unbroadcasted_scale_tril transpose - - expand _batch_shape + _event_shape lazy_property precision_matrix - Tensor identity = torch eye _event_shape - device=self _unbroadcasted_scale_tril device dtype=self _unbroadcasted_scale_tril dtype torch cholesky_solve identity _unbroadcasted_scale_tril expand _batch_shape + _event_shape property mean - Tensor df view _batch_shape + covariance_matrix property mode - Tensor factor = df - covariance_matrix shape - - factor factor = = nan factor view _batch_shape + covariance_matrix property variance - Tensor V = covariance_matrix has shape batch_shape x event_shape diag_V = V diagonal dim =- dim =- df view _batch_shape + V pow + torch einsum i j- ij diag_V diag_V _bartlett_sampling sample_shape=torch Size p = _event_shape - has singleton shape Implemented Sampling using Bartlett decomposition noise = _clamp_above_eps _dist_chi rsample sample_shape sqrt diag_embed dim =- dim =- i j = torch tril_indices p p offset=- noise i j = torch randn torch Size sample_shape + _batch_shape + int p p - dtype=noise dtype device=noise device chol = _unbroadcasted_scale_tril noise chol chol transpose - - rsample sample_shape _size = torch Size max_try_correction=None - Tensor r warning In some cases sampling algorithm based Bartlett decomposition may singular matrix samples Several tries correct singular samples performed default may end up returning singular matrix samples Singular samples may ` -inf ` values ` log_prob ` In those cases user should validate samples either fix value ` df ` adjust ` max_try_correction ` value argument ` rsample ` accordingly max_try_correction None max_try_correction = torch _C _get_tracing_state sample_shape = torch Size sample_shape sample = _bartlett_sampling sample_shape Below part improve numerical stability temporally should removed future is_singular = support check sample _batch_shape is_singular = is_singular amax _batch_dims torch _C _get_tracing_state Less optimized version JIT _ range max_try_correction sample_new = _bartlett_sampling sample_shape sample = torch where is_singular sample_new sample is_singular = ~self support check sample _batch_shape is_singular = is_singular amax _batch_dims More optimized version data-dependent control flow is_singular any warnings warn Singular sample detected stacklevel= _ range max_try_correction sample_new = _bartlett_sampling is_singular is_singular shape sample is_singular = sample_new is_singular_new = ~self support check sample_new _batch_shape is_singular_new = is_singular_new amax _batch_dims is_singular is_singular clone = is_singular_new is_singular any break sample log_prob value _validate_args _validate_sample value nu = df has shape batch_shape p = _event_shape - has singleton shape -nu p _log_ + _unbroadcasted_scale_tril diagonal dim =- dim =- log sum - - torch mvlgamma nu p=p + nu - p - torch linalg slogdet value logabsdet - torch cholesky_solve value _unbroadcasted_scale_tril diagonal dim =- dim =- sum dim=- entropy nu = df has shape batch_shape p = _event_shape - has singleton shape p + p _log_ + _unbroadcasted_scale_tril diagonal dim =- dim =- log sum - + torch mvlgamma nu p=p - nu - p - _mvdigamma nu p=p + nu p property _natural_params - tuple Tensor Tensor nu = df has shape batch_shape p = _event_shape - has singleton shape -self precision_matrix nu - p - pyrefly ignore bad-override _log_normalizer x y p = _event_shape - y + p + -torch linalg slogdet - x logabsdet + _log_ p + torch mvlgamma y + p + p=p
Owner s oncall distributed unittest collections abc Callable dataclasses dataclass typing Any cast Union torch torch nn optim torch _subclasses fake_tensor FakeTensorMode torch distributed _tools runtime_estimator RuntimeEstimator torch testing _internal common_cuda TEST_CUDA torch testing _internal common_utils run_tests skipIfTorchDynamo TestCase torch testing _internal distributed _tensor common_dtensor ModelArgs Transformer dataclass ConvArgs image_size int num_classes int SimpleCNN nn Module __init__ conv_args ConvArgs super __init__ image_size = conv_args image_size num_classes = conv_args num_classes image_size = image_size conv = nn Conv d kernel_size= pool = nn MaxPool d conv = nn Conv d kernel_size= conv = nn Conv d kernel_size= conv = nn Conv d kernel_size= fc _size = _calculate_fc _size fc = nn Linear fc _size fc = nn Linear fc = nn Linear num_classes _calculate_fc _size size = image_size size = size - + conv pool size = size - + conv pool size = size - + conv size = size - + conv pool size size forward x x = pool nn functional relu conv x x = pool nn functional relu conv x x = nn functional relu conv x x = pool nn functional relu conv x x = x view - fc _size x = nn functional relu fc x x = nn functional relu fc x x = fc x x TestRuntimeEstimator TestCase _train_step model nn Module optimizer optim Optimizer inp torch Tensor out = model inp loss = out sum loss backward optimizer step optimizer zero_grad _measure_actual_cuda_time func Callable args tuple Any - float warmup_iters actual_iters = start_event = torch cuda Event enable_timing=True end_event = torch cuda Event enable_timing=True _ range warmup_iters func args start_event record _ range actual_iters func args end_event record torch cuda synchronize measured_time = start_event elapsed_time end_event actual_iters measured_time _runtime_estimate estimate_mode str func Callable args tuple Any - float Optimizer init step func args runtime_estimator = RuntimeEstimator runtime_estimator estimate_mode_type=estimate_mode func args runtime_estimator total_runtime _init_model_and_args model_type str model_args Union ConvArgs ModelArgs bsz int - tuple nn Module optim Optimizer torch Tensor dev = torch cuda current_device model_type == Transformer model_args = cast ModelArgs model_args torch device dev model = Transformer model_args optimizer = optim Adam model parameters lr= e- foreach=True inp = torch randint model_args vocab_size bsz model_args max_seq_len device=dev model_type == CNN model_args = cast ConvArgs model_args torch device dev model = SimpleCNN model_args optimizer = optim SGD model parameters lr= e- foreach=True inp = torch randn bsz model_args image_size model_args image_size device=dev raise NotImplementedError Only Transformer CNN supported model optimizer inp skipIfTorchDynamo https github com pytorch pytorch issues unittest skipIf TEST_CUDA CUDA available test_transformer_runtime Runs basic GPT- model vocab_size = bsz seq_len = model_args = ModelArgs n_layers= n_heads= vocab_size=vocab_size max_seq_len=seq_len dim= dropout_p= args = _init_model_and_args Transformer model_args bsz actual_runtime = _measure_actual_cuda_time _train_step args FakeTensorMode fake_args = _init_model_and_args Transformer model_args bsz benchmark_estimate = _runtime_estimate operator-level-benchmark _train_step fake_args roofline_estimate = _runtime_estimate operator-level-cost-model _train_step fake_args benchmark_accuracy = actual_runtime benchmark_estimate roofline_accuracy = actual_runtime roofline_estimate print f Actual actual_runtime Benchmark Estimate benchmark_estimate Accuracy benchmark_accuracy f \n Actual actual_runtime Roofline Estimatee roofline_estimate Accuracy roofline_accuracy No accuracy check benchmark CI highly variable assertAlmostEqual benchmark_accuracy delta= assertAlmostEqual roofline_accuracy delta= skipIfTorchDynamo https github com pytorch pytorch issues unittest skipIf TEST_CUDA CUDA available test_conv_model_runtime Runs simple CNN model num_classes = bsz img_sz = model_args = ConvArgs img_sz num_classes args = _init_model_and_args CNN model_args bsz actual_runtime = _measure_actual_cuda_time _train_step args FakeTensorMode fake_args = _init_model_and_args CNN model_args bsz benchmark_estimate = _runtime_estimate operator-level-benchmark _train_step fake_args roofline_estimate = _runtime_estimate operator-level-cost-model _train_step fake_args benchmark_accuracy = actual_runtime benchmark_estimate roofline_accuracy = actual_runtime roofline_estimate print f Actual actual_runtime Benchmark Estimate benchmark_estimate Accuracy benchmark_accuracy \n f Actual actual_runtime Roofline Estimatee roofline_estimate Accuracy roofline_accuracy No accuracy check benchmark CI highly variable assertAlmostEqual benchmark_accuracy delta= assertAlmostEqual roofline_accuracy delta= __name__ == __main__ run_tests
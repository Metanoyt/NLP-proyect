======= BEGIN Dynamo patch ======= Owner s module dynamo ruff noqa flake noqa Test copied https raw githubusercontent com python cpython refs tags v Lib test test_range py sys torch torch _dynamo test_case unittest torch _dynamo test_case CPythonTestCase torch testing _internal common_utils run_tests skipIfTorchDynamo __TestCase = CPythonTestCase ======= END DYNAMO PATCH ======= Python test set -- built-in functions unittest sys pickle itertools test support ALWAYS_EQ pure Python implementations args only comparison pyrange start stop step start - stop step replace stop next element sequence integers congruent start modulo step stop += start - stop step while start = stop yield start start += step pyrange_reversed start stop step stop += start - stop step pyrange stop - step start - step -step RangeTest __TestCase assert_iterators_equal xs ys test_id limit=None check iterator xs matches expected results ys up given limit limit None xs = itertools islice xs limit ys = itertools islice ys limit sentinel = object pairs = itertools zip_longest xs ys fillvalue=sentinel i x y enumerate pairs x == y continue x == sentinel fail iterator ended unexpectedly position expected format test_id i y y == sentinel fail unexpected excess element position format test_id x i fail wrong element position expected got format test_id i y x test_range assertEqual list range assertEqual list range assertEqual list range assertEqual list range - assertEqual list range assertEqual list range - - - - = b = c = assertEqual list range a+ a+ assertEqual list range a+ - a+ a+ assertEqual list range a+ - a+ a+ seq = list range b c assertIn seq assertNotIn b seq assertEqual len seq seq = list range b -c assertIn b seq assertNotIn seq assertEqual len seq seq = list range -a -b -c assertIn -a seq assertNotIn -b seq assertEqual len seq assertEqual len range sys maxsize sys maxsize- r = range -sys maxsize sys maxsize assertEqual len r sys maxsize test_range_constructor_error_messages assertRaisesRegex TypeError range expected least argument got range assertRaisesRegex TypeError range expected most arguments got range test_large_operands x = range + assertEqual len x assertEqual len list x x = range + assertEqual len x assertEqual len list x assertFalse x x = range + - assertEqual len x assertEqual len list x assertFalse x x = range + - assertEqual len x assertEqual len list x assertTrue x Now test range longs x range - range - range - assertEqual list x assertFalse x = int sys maxsize b = int sys maxsize c = int sys maxsize assertEqual list range a+ a+ assertEqual list range a+ - a+ a+ assertEqual list range a+ - a+ a+ seq = list range b c assertIn seq assertNotIn b seq assertEqual len seq assertEqual seq assertEqual seq - a+c seq = list range b -c assertIn b seq assertNotIn seq assertEqual len seq assertEqual seq b assertEqual seq - b-c seq = list range -a -b -c assertIn -a seq assertNotIn -b seq assertEqual len seq assertEqual seq -a assertEqual seq - -a-c test_large_range Check long ranges len sys maxsize len expected fail due limitations __len__ protocol _range_len x try length = len x except OverflowError step = x - x length = + x - - x step length = -sys maxsize b = sys maxsize expected_len = b - x = range b assertIn x assertNotIn b x assertRaises OverflowError len x assertTrue x assertEqual _range_len x expected_len assertEqual x idx = sys maxsize+ assertEqual x idx a+idx assertEqual x idx idx+ a+idx assertRaises IndexError x -expected_len- assertRaises IndexError x expected_len = b = sys maxsize expected_len = b - x = range b assertIn x assertNotIn b x assertRaises OverflowError len x assertTrue x assertEqual _range_len x expected_len assertEqual x idx = sys maxsize+ assertEqual x idx a+idx assertEqual x idx idx+ a+idx assertRaises IndexError x -expected_len- assertRaises IndexError x expected_len = b = sys maxsize c = sys maxsize expected_len = + b - c x = range b c assertIn x assertNotIn b x assertRaises OverflowError len x assertTrue x assertEqual _range_len x expected_len assertEqual x idx = sys maxsize+ assertEqual x idx a+ idx c assertEqual x idx idx+ a+ idx c assertRaises IndexError x -expected_len- assertRaises IndexError x expected_len = sys maxsize b = c = - sys maxsize expected_len = + b - c x = range b c assertIn x assertNotIn b x assertRaises OverflowError len x assertTrue x assertEqual _range_len x expected_len assertEqual x idx = sys maxsize+ assertEqual x idx a+ idx c assertEqual x idx idx+ a+ idx c assertRaises IndexError x -expected_len- assertRaises IndexError x expected_len test_invalid_invocation assertRaises TypeError range assertRaises TypeError range assertRaises ValueError range = int sys maxsize assertRaises ValueError range + int assertRaises TypeError range assertRaises TypeError range e e e assertRaises TypeError range spam assertRaises TypeError range spam Exercise various combinations bad arguments check refcounting logic assertRaises TypeError range assertRaises TypeError range assertRaises TypeError range assertRaises TypeError range assertRaises TypeError range assertRaises TypeError range assertRaises TypeError range assertRaises TypeError range assertRaises TypeError range assertRaises TypeError range assertRaises TypeError range test_index u = range assertEqual u index assertEqual u index assertRaises ValueError u index u = range - assertEqual u count assertEqual u index assertRaises TypeError u index BadExc Exception pass BadCmp __eq__ other other == raise BadExc False = range assertRaises BadExc index BadCmp = range - assertEqual index assertEqual range index assertEqual range - - index - assertEqual range index assertEqual range index - - assertRaises ValueError range index assertEqual range index + assertEqual range index ALWAYS_EQ test_user_index_method bignum = sys maxsize smallnum = User-defined __index__ method I __init__ n n = int n __index__ n assertEqual list range I bignum I bignum + bignum assertEqual list range I smallnum I smallnum + smallnum User-defined failing __index__ method IX __index__ raise RuntimeError assertRaises RuntimeError range IX User-defined invalid __index__ method IN __index__ number assertRaises TypeError range IN Test use user-defined classes slice indices assertEqual range I range assertRaises RuntimeError range IX assertRaises TypeError range IN test_count assertEqual range count - assertEqual range count assertEqual range count assertEqual range count assertEqual range count assertIs type range count - int assertIs type range count int assertEqual range count assertEqual range count assertEqual range index assertEqual range count assertEqual range count + assertEqual range count ALWAYS_EQ assertEqual len range sys maxsize sys maxsize+ test_repr assertEqual repr range range assertEqual repr range range assertEqual repr range range test_pickling testcases = - - - + proto range pickle HIGHEST_PROTOCOL + t testcases subTest proto=proto test=t r = range t assertEqual list pickle loads pickle dumps r proto list r test_iterator_pickling testcases = - - - M testcases += M- M- M M+ M- M- -M+ -M - M- - - -M M- M- - -M -M proto range pickle HIGHEST_PROTOCOL + t testcases subTest proto=proto t=t = itorg = iter range t data = list range t d = pickle dumps proto = pickle loads d assertEqual type itorg type assertEqual list data = pickle loads d try next except StopIteration continue d = pickle dumps proto = pickle loads d assertEqual list data skipIfTorchDynamo infinite loop test_iterator_pickling_overflowing_index proto range pickle HIGHEST_PROTOCOL + subTest proto=proto = iter range + __setstate__ + undocumented way advance iterator d = pickle dumps proto = pickle loads d assertEqual next + test_exhausted_iterator_pickling proto range pickle HIGHEST_PROTOCOL + r = range + i = iter r while True r = next i r == + break d = pickle dumps i proto i = pickle loads d assertEqual list i assertEqual list i test_large_exhausted_iterator_pickling proto range pickle HIGHEST_PROTOCOL + r = range i = iter r while True r = next i r == break d = pickle dumps i proto i = pickle loads d assertEqual list i assertEqual list i test_iterator_unpickle_compat testcases = b c__builtin__\niter\n c__builtin__\nxrange\n I \nI \nI \ntRtRI \nb b c__builtin__\niter\n c__builtin__\nxrange\n K\nK\x K\x tRtRK\x b b \x \x c__builtin__\niter\nc__builtin__\nxrange\nK\nK\x K\x \x R\x RK\x b b \x \x cbuiltins\niter\ncbuiltins\nrange\nK\nK\x K\x \x R\x RK\x b b \x \x \x \x \x \x \x \x \x \x \x c\x builtins\x c\x iter\x \x c\x builtins\x c\x range\x K\nK\x K\x \x R\x RK\x b b c__builtin__\niter\n c__builtin__\nxrange\n L- L\nI \nI \ntRtRL L\nb b c__builtin__\niter\n c__builtin__\nxrange\n L- L\nK\x K\x tRtRL L\nb b \x \x c__builtin__\niter\nc__builtin__\nxrange\n\x a\t\x \x \x \x \x \x \x \x \xfeK\x K\x \x R\x R\x a\t\x \x \x \x \x \x \x \x \x b b \x \x cbuiltins\niter\ncbuiltins\nrange\n\x a\t\x \x \x \x \x \x \x \x \xfeK\x K\x \x R\x R\x a\t\x \x \x \x \x \x \x \x \x b b \x \x \x C\x \x \x \x \x \x \x \x c\x builtins\x c\x iter\x \x c\x builtins\x c\x range\x \x a\t\x \x \x \x \x \x \x \x \xfeK\x K\x \x R\x R\x a\t\x \x \x \x \x \x \x \x \x b t testcases = pickle loads t assertEqual list test_iterator_setstate = iter range __setstate__ assertEqual list = reversed range __setstate__ assertEqual list = iter range - __setstate__ + assertEqual list = reversed range __setstate__ - assertEqual list test_odd_bug This used raise SystemError NULL result without error because range validation step eating exception before NULL returned assertRaises TypeError range - test_types Non-integer objects equal any range s items supposed contained range assertIn range assertIn True range assertIn + j range assertIn ALWAYS_EQ range Objects never coerced into other types comparison C __int__ __index__ assertNotIn C range except explicitly told so assertIn int C range Check range __contains__ optimization only used ints instances subclasses int C int __eq__ other True assertIn C range assertIn C list range test_strided_limits r = range assertIn r assertNotIn r assertIn r assertNotIn r assertIn r assertNotIn r r = range - - assertIn r assertIn - r assertIn - r assertNotIn - r r = range - - assertIn - r assertNotIn - r assertNotIn - r test_empty r = range assertNotIn r assertNotIn r r = range - assertNotIn r assertNotIn - r assertNotIn r test_range_iterators exercise fast iterators use rangeiterobject internally see issue limits = base + jiggle M base -M -M M M jiggle - - test_ranges = start end step start limits end limits step - - - - test_ranges += - - regression test gh- start end step test_ranges iter = range start end step iter = pyrange start end step test_id = range format start end step check first entries assert_iterators_equal iter iter test_id limit= iter = reversed range start end step iter = pyrange_reversed start end step test_id = reversed range format start end step assert_iterators_equal iter iter test_id limit= test_range_iterators_invocation verify range iterators instances cannot created calling their type rangeiter_type = type iter range assertRaises TypeError rangeiter_type long_rangeiter_type = type iter range assertRaises TypeError long_rangeiter_type test_slice check start stop step=None i = slice start stop step assertEqual list r i list r i assertEqual len r i len list r i r range range range range - range sys maxsize+ sys maxsize+ check check check check check - - check - check - check - - - test_contains r = range assertIn r assertIn r assertIn r assertNotIn r assertNotIn - r assertNotIn r assertNotIn r r = range - - assertIn r assertIn r assertIn r assertNotIn r assertNotIn - r assertNotIn r assertNotIn r r = range assertIn r assertNotIn r assertNotIn r assertNotIn r assertNotIn - r assertNotIn r assertNotIn r r = range - - assertNotIn r assertIn r assertIn r assertNotIn r assertNotIn - r assertNotIn r assertNotIn r test_reverse_iteration r range range range range - range sys maxsize+ sys maxsize+ assertEqual list reversed r list r - test_issue r = range slice indices values = None - - - - - - - - i values j values k values - r i j k test_comparison test_ranges = range range - range range range range range range range range range test_tuples = list map tuple test_ranges Check equality ranges matches equality corresponding tuples each pair test lists above ranges_eq = == b test_ranges b test_ranges tuples_eq = == b test_tuples b test_tuples assertEqual ranges_eq tuples_eq Check = correctly gives logical negation == ranges_ne = = b test_ranges b test_ranges assertEqual ranges_ne x x ranges_eq Ranges unequal other types even sequence types assertIs range == False assertIs == range False assertIs range == False Huge integers aren t problem assertEqual range - range assertNotEqual range range + assertEqual range - range assertNotEqual range range + Order comparisons implemented ranges assertRaises TypeError range range assertRaises TypeError range range assertRaises TypeError range = range assertRaises TypeError range = range test_attributes test start stop step attributes range objects assert_attrs range assert_attrs range assert_attrs range - - assert_attrs range assert_attrs range assert_attrs range - - assert_attrs range - - assert_attrs range True assert_attrs range False True assert_attrs range False True True assert_attrs rangeobj start stop step assertEqual rangeobj start start assertEqual rangeobj stop stop assertEqual rangeobj step step assertIs type rangeobj start int assertIs type rangeobj stop int assertIs type rangeobj step int __name__ == __main__ run_tests
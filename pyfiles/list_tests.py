======= BEGIN Dynamo patch ======= Owner s module dynamo ruff noqa flake noqa Test copied https raw githubusercontent com python cpython refs tags v Lib test list_tests py sys torch torch _dynamo test_case unittest torch _dynamo test_case CPythonTestCase torch testing _internal common_utils run_tests __TestCase = CPythonTestCase redirect statements sys importlib abc redirect_imports = test mapping_tests test typinganndata test test_grammar test test_math test test_iter test typinganndata ann_module RedirectImportFinder importlib abc MetaPathFinder find_spec fullname path target=None Check problematic one fullname redirect_imports try Attempt standalone module name = fullname removeprefix test r = importlib import_module name Redirect module sys modules sys modules fullname = r Return module spec found module importlib util find_spec name except ImportError None None Add custom finder sys meta_path sys meta_path insert RedirectImportFinder ======= END DYNAMO PATCH ======= Tests common list UserList UserList sys functools cmp_to_key seq_tests test support ALWAYS_EQ NEVER_EQ get_c_recursion_limit CommonTest seq_tests CommonTest test_init Iterable arg optional assertEqual type test type test Init clears previous values = type test __init__ assertEqual type test Init overwrites previous values = type test __init__ assertEqual type test Mutables always new object b = type test assertNotEqual id id b assertEqual b test_getitem_error = msg = list indices must integers slices assertRaisesRegex TypeError msg test_setitem_error = msg = list indices must integers slices assertRaisesRegex TypeError msg = python test_repr l = l = = type test l = type test l assertEqual str str l assertEqual repr repr l assertEqual repr repr l assertEqual str assertEqual repr append append assertEqual str assertEqual repr test_repr_deep = type test i range get_c_recursion_limit + = type test assertRaises RecursionError repr test_set_subscript = type test range assertRaises ValueError __setitem__ slice assertRaises TypeError __setitem__ slice assertRaises ValueError __setitem__ slice assertRaises TypeError __getitem__ x slice = assertEqual type test test_reversed = type test range r = reversed assertEqual list r type test range - - assertRaises StopIteration next r assertEqual list reversed type test type test Bug make sure list-reversed-iterator doesn t have __len__ assertRaises TypeError len reversed test_setitem = type test = = assertEqual type test - = assertEqual type test - = assertEqual type test assertRaises IndexError __setitem__ - assertRaises IndexError __setitem__ = type test assertRaises IndexError __setitem__ assertRaises IndexError __setitem__ - assertRaises TypeError __setitem__ = type test = = = assertEqual type test = = = assertEqual type test - = - = assertEqual type test - = - = assertEqual type test test_delitem = type test del assertEqual del assertEqual = type test del - assertEqual del - assertEqual = type test assertRaises IndexError __delitem__ - assertRaises IndexError __delitem__ = type test assertRaises IndexError __delitem__ assertRaises TypeError __delitem__ test_setslice l = = type test l i range - i = l i assertEqual l = i = i assertEqual i = l i assertEqual l = i = i assertEqual j range - i j = l i j assertEqual l = i j = i j assertEqual aa = aa = - - assertEqual aa - - aa = assertEqual aa = type test - = assertEqual type test = type test = assertEqual type test = type test - = assertEqual type test = type test = tuple range assertEqual type test range assertRaises TypeError __setitem__ slice assertRaises TypeError __setitem__ test_slice_assign_iterator x = type test range x = reversed range assertEqual x type test x = reversed range assertEqual x type test test_delslice = type test del del assertEqual type test = type test del del assertEqual type test = type test del - - assertEqual type test = type test del - - assertEqual type test = type test del del assertEqual type test = type test del del assertEqual type test = type test del - assertEqual type test = type test del - assertEqual type test = type test del assertEqual type test test_append = type test append append append assertEqual type test assertRaises TypeError append test_extend = type test = type test = extend assertEqual + extend type test assertEqual + extend assertEqual type test = type test spam extend eggs assertEqual list spameggs assertRaises TypeError extend None assertRaises TypeError extend overflow test issue torch _dynamo error_on_graph_break False CustomIter __iter__ __next__ raise StopIteration __length_hint__ sys maxsize = type test extend CustomIter assertEqual test_insert = type test insert - insert - insert assertEqual - - b = b insert - foo b insert - left b insert right assertEqual b type test left - - foo right assertRaises TypeError insert test_pop = type test - pop assertEqual - pop assertEqual assertRaises IndexError pop pop assertEqual assertRaises IndexError pop assertRaises TypeError pop = type test test_remove = type test remove assertEqual remove assertEqual remove assertEqual assertRaises ValueError remove assertRaises TypeError remove = type test assertRaises ValueError remove NEVER_EQ assertEqual remove ALWAYS_EQ assertEqual = type test ALWAYS_EQ remove assertEqual = type test ALWAYS_EQ remove NEVER_EQ assertEqual = type test NEVER_EQ assertRaises ValueError remove ALWAYS_EQ torch _dynamo error_on_graph_break False BadExc Exception pass BadCmp __eq__ other other == raise BadExc False = type test assertRaises BadExc remove BadCmp torch _dynamo error_on_graph_break False BadCmp __eq__ other raise BadExc d = type test abcdefghcij d remove c assertEqual d type test abdefghcij d remove c assertEqual d type test abdefghij assertRaises ValueError d remove c assertEqual d type test abdefghij Handle comparison errors d = type test b BadCmp c e = type test d assertRaises BadExc d remove c x y zip d e verify original order values retained assertIs x y test_index super test_index = type test - - remove assertRaises ValueError index assertEqual type test - - torch _dynamo error_on_graph_break False Test modifying list during index s iteration EvilCmp __init__ victim victim = victim __eq__ other del victim False = type test = EvilCmp _ range This used seg fault before patch assertRaises ValueError index None test_reverse u = type test - - u = u u reverse assertEqual u - - u reverse assertEqual u u assertRaises TypeError u reverse test_clear u = type test u clear assertEqual u u = type test u clear assertEqual u u = type test u append u clear u append assertEqual u assertRaises TypeError u clear None test_copy u = type test v = u copy assertEqual v u = type test v = u copy assertEqual v test s indeed copy reference u = type test b v = u copy v append i assertEqual u b assertEqual v u + i test s shallow deep copy u = type test v = u copy assertEqual u v assertIs v u assertRaises TypeError u copy None test_sort u = type test u sort assertEqual u u = type test - - u sort assertEqual u type test - - assertRaises TypeError u sort revcmp b == b b b - u sort key=cmp_to_key revcmp assertEqual u type test - - The following dumps core unpatched Python myComparison x y xmod ymod = x y xmod == ymod xmod ymod - xmod ymod z = type test range z sort key=cmp_to_key myComparison assertRaises TypeError z sort selfmodifyingComparison x y z append x == y x y - x y assertRaises ValueError z sort key=cmp_to_key selfmodifyingComparison assertRaises TypeError z sort test_slice u = type test spam u = h assertEqual u list ham test_iadd super test_iadd u = type test u = u u += assertIs u u u = type test spam u += eggs assertEqual u type test spameggs assertRaises TypeError u __iadd__ None test_imul super test_imul s = type test oldid = id s s = assertEqual id s oldid test_extendedslicing subscript = type test deletion del assertEqual type test = type test range del assertEqual type test = type test range del - assertEqual type test = type test range del assertEqual type test assignment = type test range = - assertEqual type test - - - - - = type test range - = assertEqual type test = type test range - = assertEqual type test = type test range b = c = = type test two elements b slice = type test two elements c = type test two elements assertEqual b assertEqual c = type test range = tuple range assertEqual type test test issue = type test range del test_constructor_exception_handling Bug F object __iter__ raise KeyboardInterrupt assertRaises KeyboardInterrupt list F test_exhausted_iterator = type test exhit = iter empit = iter x exhit exhaust iterator next empit exhausted append assertEqual list exhit assertEqual list empit assertEqual type test gh- Crash when iterating over exhausted iterator exhit = iter type test _ exhit next exhit